# Inventory SQL Tool Fuzzy Matching

The inventory SQL tool now supports an automatic fuzzy lookup when an exact, read-only `SELECT` query returns no rows. The retry
 logic keeps the existing read-only guarantees and table allowlists enforced by `InventorySQLTool`.

## When the fallback runs

The fuzzy retry triggers only when **all** of the following are true:

- The original command is a read-only `SELECT` generated by the agent or the caller.
- The query targets a table that is already in the SQL allowlist provided by the schema introspector.
- The `WHERE` clause contains equality predicates on one of the configured fuzzy text columns (default: `vendor_name`,
  `customer_name`, `part_name`).
- Each text value has a length of at least `AI_FUZZY_MINLEN` characters (default `3`).
- The original equality returns zero rows.

Numeric identifiers (IDs, order numbers, etc.) are never fuzzed, even if they appear in the allowlist.

## Matching strategies

The tool uses one retry at most:

1. **Trigram similarity** (Postgres `pg_trgm`): enabled when `AI_FUZZY_USE_TRGM=true` and the extension is installed.
   - The session executes `SELECT set_limit(:threshold)` and issues a similarity query that keeps existing safe filters.
   - Candidates are ordered by `similarity(field, value)` in descending order.
2. **ILIKE token matching**: used automatically when trigram support is disabled or unavailable.
   - Tokens are generated from the search string when `AI_FUZZY_TOKENIZE=true` and combined with `AND` clauses.
   - Results are ordered by `LENGTH(field)` to surface the tightest matches first.

The retry always respects `AI_FUZZY_LIMIT` (default `5`) and never issues more than one additional SQL statement.

## Return payloads

- **Single candidate**: the candidate row is returned as the tool result (`Found 1 results...`).
- **Multiple candidates (2..N)**: the tool returns a JSON payload with `type="disambiguation"`, the matched table/field, and a
  candidate list of primary keys plus the fuzzy display value. The orchestrator/LLM should prompt the end user to choose one of
  the options.
- **No fuzzy matches**: the tool reports `"No results found, even after a fuzzy lookup."`.

Analytics metadata includes the strategy used (`trgm` or `ilike`), the search value, candidate counts, hashes of the base and
fuzzy queries, and the configured limit/threshold.

## Configuration

Environment variables controlling the fallback:

| Variable | Default | Purpose |
| --- | --- | --- |
| `AI_FUZZY_ENABLED` | `true` | Master switch for the fuzzy retry. |
| `AI_FUZZY_FIELDS` | `vendor_name,customer_name,part_name` | Case-insensitive list of eligible text columns. |
| `AI_FUZZY_LIMIT` | `5` | Maximum number of fuzzy candidates to return. |
| `AI_FUZZY_MINLEN` | `3` | Minimum search string length for fuzzy matching. |
| `AI_FUZZY_USE_TRGM` | `true` | Prefer `pg_trgm` similarity when available. |
| `AI_FUZZY_TRGM_THRESHOLD` | `0.25` | Similarity threshold passed to `set_limit()` and enforced in the query. |
| `AI_FUZZY_TOKENIZE` | `true` | Split multi-word searches into ANDed tokens for the ILIKE fallback. |

Set `AI_FUZZY_USE_TRGM=false` or remove the extension to force the ILIKE path.

## Disambiguation handling

When the tool responds with a disambiguation payload, the orchestrator receives a JSON string similar to:

```json
{
  "type": "disambiguation",
  "table": "vendormaster",
  "field": "vendor_name",
  "limit": 5,
  "candidates": [
    {
      "display_value": "Parts for Truck Inc.",
      "primary_keys": {"vendor_id": 1},
      "row": {"vendor_id": 1, "vendor_name": "Parts for Truck Inc."}
    }
  ]
}
```

The caller should prompt the user to choose from the candidate list and then issue a follow-up query with the confirmed key.
