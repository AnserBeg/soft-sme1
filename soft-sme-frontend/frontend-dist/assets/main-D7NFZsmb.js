import{r as l,R as jh,j as e,c as wh,b as Sh,_ as Cu,F as Ch,B as Pl,C as ku,u as kh,a as vt,d as bt,S as Pe,P as Me,T as h,e as De,G as O,f as k,L as kr,g as Ar,h as Pu,i as hr,A as Rn,k as El,l as Dn,D as fr,m as Dl,n as Ph,o as Q,p as le,q as Ht,I as gt,s as Eh,t as Dt,v as Tn,w as ot,x as Ji,y as Xi,K as Dh,z as Th,E as Zi,H as Ql,J as Ps,M as Uo,N as $r,O as Eu,Q as el,U as Es,V as Xa,W as Du,X as Jn,Y as Tu,Z as Iu,$ as Ih,a0 as Ou,a1 as Tl,a2 as Fo,a3 as Wo,a4 as Il,a5 as Di,a6 as Oh,a7 as Ah,a8 as Au,a9 as Mh,aa as Rh,ab as nt,ac as Fe,ad as yn,ae as gn,af as Nh,ag as kt,ah as Ot,ai as Lh,aj as Kl,ak as mt,al as ft,am as xt,an as jt,ao as mr,ap as tn,aq as Ze,ar as Mu,as as ei,at as qh,au as Ke,av as Ru,aw as vn,ax as Mt,ay as qt,az as Ut,aA as bn,aB as zr,aC as Nn,aD as ti,aE as Uh,aF as Fh,aG as dr,aH as ir,aI as lr,aJ as ht,aK as ne,aL as cr,aM as Qa,aN as Ss,aO as Wh,aP as Nu,aQ as qs,aR as $h,aS as $o,aT as zh,aU as Bh,aV as Jl,aW as Lu,aX as Hh,aY as ri,aZ as ni,a_ as qu,a$ as tl,b0 as Ds,b1 as Ts,b2 as Yh,b3 as Vh,b4 as Gh,b5 as Qh,b6 as Uu,b7 as Kh,b8 as Jh,b9 as Fu,ba as Xh,bb as Ol,bc as Xl,bd as Ti,be as Zl,bf as Zh,bg as em,bh as tm,bi as ec,bj as rl,bk as Wu,bl as rm,bm as nm,bn as sm,bo as am,bp as om,bq as im}from"./mui-huVUTio-.js";import{a as lm,g as st,b as cm}from"./vendor-kq2j8kjo.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();var mo={},tc;function dm(){if(tc)return mo;tc=1;var t=lm();return mo.createRoot=t.createRoot,mo.hydrateRoot=t.hydrateRoot,mo}var um=dm();const pm=st(um);/**
 * @remix-run/router v1.23.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Za(){return Za=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(t[a]=n[a])}return t},Za.apply(this,arguments)}var In;(function(t){t.Pop="POP",t.Push="PUSH",t.Replace="REPLACE"})(In||(In={}));const rc="popstate";function hm(t){t===void 0&&(t={});function r(s,o){let{pathname:i="/",search:c="",hash:u=""}=as(s.location.hash.substr(1));return!i.startsWith("/")&&!i.startsWith(".")&&(i="/"+i),nl("",{pathname:i,search:c,hash:u},o.state&&o.state.usr||null,o.state&&o.state.key||"default")}function n(s,o){let i=s.document.querySelector("base"),c="";if(i&&i.getAttribute("href")){let u=s.location.href,d=u.indexOf("#");c=d===-1?u:u.slice(0,d)}return c+"#"+(typeof o=="string"?o:zo(o))}function a(s,o){Al(s.pathname.charAt(0)==="/","relative pathnames are not supported in hash history.push("+JSON.stringify(o)+")")}return fm(r,n,a,t)}function ar(t,r){if(t===!1||t===null||typeof t>"u")throw new Error(r)}function Al(t,r){if(!t){typeof console<"u"&&console.warn(r);try{throw new Error(r)}catch{}}}function mm(){return Math.random().toString(36).substr(2,8)}function nc(t,r){return{usr:t.state,key:t.key,idx:r}}function nl(t,r,n,a){return n===void 0&&(n=null),Za({pathname:typeof t=="string"?t:t.pathname,search:"",hash:""},typeof r=="string"?as(r):r,{state:n,key:r&&r.key||a||mm()})}function zo(t){let{pathname:r="/",search:n="",hash:a=""}=t;return n&&n!=="?"&&(r+=n.charAt(0)==="?"?n:"?"+n),a&&a!=="#"&&(r+=a.charAt(0)==="#"?a:"#"+a),r}function as(t){let r={};if(t){let n=t.indexOf("#");n>=0&&(r.hash=t.substr(n),t=t.substr(0,n));let a=t.indexOf("?");a>=0&&(r.search=t.substr(a),t=t.substr(0,a)),t&&(r.pathname=t)}return r}function fm(t,r,n,a){a===void 0&&(a={});let{window:s=document.defaultView,v5Compat:o=!1}=a,i=s.history,c=In.Pop,u=null,d=p();d==null&&(d=0,i.replaceState(Za({},i.state,{idx:d}),""));function p(){return(i.state||{idx:null}).idx}function m(){c=In.Pop;let b=p(),P=b==null?null:b-d;d=b,u&&u({action:c,location:w.location,delta:P})}function f(b,P){c=In.Push;let N=nl(w.location,b,P);n&&n(N,b),d=p()+1;let j=nc(N,d),E=w.createHref(N);try{i.pushState(j,"",E)}catch(A){if(A instanceof DOMException&&A.name==="DataCloneError")throw A;s.location.assign(E)}o&&u&&u({action:c,location:w.location,delta:1})}function _(b,P){c=In.Replace;let N=nl(w.location,b,P);n&&n(N,b),d=p();let j=nc(N,d),E=w.createHref(N);i.replaceState(j,"",E),o&&u&&u({action:c,location:w.location,delta:0})}function v(b){let P=s.location.origin!=="null"?s.location.origin:s.location.href,N=typeof b=="string"?b:zo(b);return N=N.replace(/ $/,"%20"),ar(P,"No window.location.(origin|href) available to create URL for href: "+N),new URL(N,P)}let w={get action(){return c},get location(){return t(s,i)},listen(b){if(u)throw new Error("A history only accepts one active listener");return s.addEventListener(rc,m),u=b,()=>{s.removeEventListener(rc,m),u=null}},createHref(b){return r(s,b)},createURL:v,encodeLocation(b){let P=v(b);return{pathname:P.pathname,search:P.search,hash:P.hash}},push:f,replace:_,go(b){return i.go(b)}};return w}var sc;(function(t){t.data="data",t.deferred="deferred",t.redirect="redirect",t.error="error"})(sc||(sc={}));function xm(t,r,n){return n===void 0&&(n="/"),gm(t,r,n)}function gm(t,r,n,a){let s=typeof r=="string"?as(r):r,o=Ml(s.pathname||"/",n);if(o==null)return null;let i=$u(t);ym(i);let c=null;for(let u=0;c==null&&u<i.length;++u){let d=Tm(o);c=Pm(i[u],d)}return c}function $u(t,r,n,a){r===void 0&&(r=[]),n===void 0&&(n=[]),a===void 0&&(a="");let s=(o,i,c)=>{let u={relativePath:c===void 0?o.path||"":c,caseSensitive:o.caseSensitive===!0,childrenIndex:i,route:o};u.relativePath.startsWith("/")&&(ar(u.relativePath.startsWith(a),'Absolute route path "'+u.relativePath+'" nested under path '+('"'+a+'" is not valid. An absolute child route path ')+"must start with the combined path of all its parent routes."),u.relativePath=u.relativePath.slice(a.length));let d=An([a,u.relativePath]),p=n.concat(u);o.children&&o.children.length>0&&(ar(o.index!==!0,"Index routes must not have child routes. Please remove "+('all child routes from route path "'+d+'".')),$u(o.children,r,p,d)),!(o.path==null&&!o.index)&&r.push({path:d,score:Cm(d,o.index),routesMeta:p})};return t.forEach((o,i)=>{var c;if(o.path===""||!((c=o.path)!=null&&c.includes("?")))s(o,i);else for(let u of zu(o.path))s(o,i,u)}),r}function zu(t){let r=t.split("/");if(r.length===0)return[];let[n,...a]=r,s=n.endsWith("?"),o=n.replace(/\?$/,"");if(a.length===0)return s?[o,""]:[o];let i=zu(a.join("/")),c=[];return c.push(...i.map(u=>u===""?o:[o,u].join("/"))),s&&c.push(...i),c.map(u=>t.startsWith("/")&&u===""?"/":u)}function ym(t){t.sort((r,n)=>r.score!==n.score?n.score-r.score:km(r.routesMeta.map(a=>a.childrenIndex),n.routesMeta.map(a=>a.childrenIndex)))}const vm=/^:[\w-]+$/,bm=3,_m=2,jm=1,wm=10,Sm=-2,ac=t=>t==="*";function Cm(t,r){let n=t.split("/"),a=n.length;return n.some(ac)&&(a+=Sm),r&&(a+=_m),n.filter(s=>!ac(s)).reduce((s,o)=>s+(vm.test(o)?bm:o===""?jm:wm),a)}function km(t,r){return t.length===r.length&&t.slice(0,-1).every((a,s)=>a===r[s])?t[t.length-1]-r[r.length-1]:0}function Pm(t,r,n){let{routesMeta:a}=t,s={},o="/",i=[];for(let c=0;c<a.length;++c){let u=a[c],d=c===a.length-1,p=o==="/"?r:r.slice(o.length)||"/",m=Em({path:u.relativePath,caseSensitive:u.caseSensitive,end:d},p),f=u.route;if(!m)return null;Object.assign(s,m.params),i.push({params:s,pathname:An([o,m.pathname]),pathnameBase:Mm(An([o,m.pathnameBase])),route:f}),m.pathnameBase!=="/"&&(o=An([o,m.pathnameBase]))}return i}function Em(t,r){typeof t=="string"&&(t={path:t,caseSensitive:!1,end:!0});let[n,a]=Dm(t.path,t.caseSensitive,t.end),s=r.match(n);if(!s)return null;let o=s[0],i=o.replace(/(.)\/+$/,"$1"),c=s.slice(1);return{params:a.reduce((d,p,m)=>{let{paramName:f,isOptional:_}=p;if(f==="*"){let w=c[m]||"";i=o.slice(0,o.length-w.length).replace(/(.)\/+$/,"$1")}const v=c[m];return _&&!v?d[f]=void 0:d[f]=(v||"").replace(/%2F/g,"/"),d},{}),pathname:o,pathnameBase:i,pattern:t}}function Dm(t,r,n){r===void 0&&(r=!1),n===void 0&&(n=!0),Al(t==="*"||!t.endsWith("*")||t.endsWith("/*"),'Route path "'+t+'" will be treated as if it were '+('"'+t.replace(/\*$/,"/*")+'" because the `*` character must ')+"always follow a `/` in the pattern. To get rid of this warning, "+('please change the route path to "'+t.replace(/\*$/,"/*")+'".'));let a=[],s="^"+t.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(i,c,u)=>(a.push({paramName:c,isOptional:u!=null}),u?"/?([^\\/]+)?":"/([^\\/]+)"));return t.endsWith("*")?(a.push({paramName:"*"}),s+=t==="*"||t==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):n?s+="\\/*$":t!==""&&t!=="/"&&(s+="(?:(?=\\/|$))"),[new RegExp(s,r?void 0:"i"),a]}function Tm(t){try{return t.split("/").map(r=>decodeURIComponent(r).replace(/\//g,"%2F")).join("/")}catch(r){return Al(!1,'The URL path "'+t+'" could not be decoded because it is is a malformed URL segment. This is probably due to a bad percent '+("encoding ("+r+").")),t}}function Ml(t,r){if(r==="/")return t;if(!t.toLowerCase().startsWith(r.toLowerCase()))return null;let n=r.endsWith("/")?r.length-1:r.length,a=t.charAt(n);return a&&a!=="/"?null:t.slice(n)||"/"}function Im(t,r){r===void 0&&(r="/");let{pathname:n,search:a="",hash:s=""}=typeof t=="string"?as(t):t;return{pathname:n?n.startsWith("/")?n:Om(n,r):r,search:Rm(a),hash:Nm(s)}}function Om(t,r){let n=r.replace(/\/+$/,"").split("/");return t.split("/").forEach(s=>{s===".."?n.length>1&&n.pop():s!=="."&&n.push(s)}),n.length>1?n.join("/"):"/"}function Ii(t,r,n,a){return"Cannot include a '"+t+"' character in a manually specified "+("`to."+r+"` field ["+JSON.stringify(a)+"].  Please separate it out to the ")+("`to."+n+"` field. Alternatively you may provide the full path as ")+'a string in <Link to="..."> and the router will parse it for you.'}function Am(t){return t.filter((r,n)=>n===0||r.route.path&&r.route.path.length>0)}function Rl(t,r){let n=Am(t);return r?n.map((a,s)=>s===n.length-1?a.pathname:a.pathnameBase):n.map(a=>a.pathnameBase)}function Nl(t,r,n,a){a===void 0&&(a=!1);let s;typeof t=="string"?s=as(t):(s=Za({},t),ar(!s.pathname||!s.pathname.includes("?"),Ii("?","pathname","search",s)),ar(!s.pathname||!s.pathname.includes("#"),Ii("#","pathname","hash",s)),ar(!s.search||!s.search.includes("#"),Ii("#","search","hash",s)));let o=t===""||s.pathname==="",i=o?"/":s.pathname,c;if(i==null)c=n;else{let m=r.length-1;if(!a&&i.startsWith("..")){let f=i.split("/");for(;f[0]==="..";)f.shift(),m-=1;s.pathname=f.join("/")}c=m>=0?r[m]:"/"}let u=Im(s,c),d=i&&i!=="/"&&i.endsWith("/"),p=(o||i===".")&&n.endsWith("/");return!u.pathname.endsWith("/")&&(d||p)&&(u.pathname+="/"),u}const An=t=>t.join("/").replace(/\/\/+/g,"/"),Mm=t=>t.replace(/\/+$/,"").replace(/^\/*/,"/"),Rm=t=>!t||t==="?"?"":t.startsWith("?")?t:"?"+t,Nm=t=>!t||t==="#"?"":t.startsWith("#")?t:"#"+t;function Lm(t){return t!=null&&typeof t.status=="number"&&typeof t.statusText=="string"&&typeof t.internal=="boolean"&&"data"in t}const Bu=["post","put","patch","delete"];new Set(Bu);const qm=["get",...Bu];new Set(qm);/**
 * React Router v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function eo(){return eo=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(t[a]=n[a])}return t},eo.apply(this,arguments)}const Ll=l.createContext(null),Um=l.createContext(null),qn=l.createContext(null),si=l.createContext(null),dn=l.createContext({outlet:null,matches:[],isDataRoute:!1}),Hu=l.createContext(null);function Fm(t,r){let{relative:n}=r===void 0?{}:r;Us()||ar(!1);let{basename:a,navigator:s}=l.useContext(qn),{hash:o,pathname:i,search:c}=Vu(t,{relative:n}),u=i;return a!=="/"&&(u=i==="/"?a:An([a,i])),s.createHref({pathname:u,search:c,hash:o})}function Us(){return l.useContext(si)!=null}function un(){return Us()||ar(!1),l.useContext(si).location}function Yu(t){l.useContext(qn).static||l.useLayoutEffect(t)}function Gt(){let{isDataRoute:t}=l.useContext(dn);return t?tf():Wm()}function Wm(){Us()||ar(!1);let t=l.useContext(Ll),{basename:r,future:n,navigator:a}=l.useContext(qn),{matches:s}=l.useContext(dn),{pathname:o}=un(),i=JSON.stringify(Rl(s,n.v7_relativeSplatPath)),c=l.useRef(!1);return Yu(()=>{c.current=!0}),l.useCallback(function(d,p){if(p===void 0&&(p={}),!c.current)return;if(typeof d=="number"){a.go(d);return}let m=Nl(d,JSON.parse(i),o,p.relative==="path");t==null&&r!=="/"&&(m.pathname=m.pathname==="/"?r:An([r,m.pathname])),(p.replace?a.replace:a.push)(m,p.state,p)},[r,a,i,o,t])}const $m=l.createContext(null);function zm(t){let r=l.useContext(dn).outlet;return r&&l.createElement($m.Provider,{value:t},r)}function jn(){let{matches:t}=l.useContext(dn),r=t[t.length-1];return r?r.params:{}}function Vu(t,r){let{relative:n}=r===void 0?{}:r,{future:a}=l.useContext(qn),{matches:s}=l.useContext(dn),{pathname:o}=un(),i=JSON.stringify(Rl(s,a.v7_relativeSplatPath));return l.useMemo(()=>Nl(t,JSON.parse(i),o,n==="path"),[t,i,o,n])}function Bm(t,r){return Hm(t,r)}function Hm(t,r,n,a){Us()||ar(!1);let{navigator:s}=l.useContext(qn),{matches:o}=l.useContext(dn),i=o[o.length-1],c=i?i.params:{};i&&i.pathname;let u=i?i.pathnameBase:"/";i&&i.route;let d=un(),p;if(r){var m;let b=typeof r=="string"?as(r):r;u==="/"||(m=b.pathname)!=null&&m.startsWith(u)||ar(!1),p=b}else p=d;let f=p.pathname||"/",_=f;if(u!=="/"){let b=u.replace(/^\//,"").split("/");_="/"+f.replace(/^\//,"").split("/").slice(b.length).join("/")}let v=xm(t,{pathname:_}),w=Km(v&&v.map(b=>Object.assign({},b,{params:Object.assign({},c,b.params),pathname:An([u,s.encodeLocation?s.encodeLocation(b.pathname).pathname:b.pathname]),pathnameBase:b.pathnameBase==="/"?u:An([u,s.encodeLocation?s.encodeLocation(b.pathnameBase).pathname:b.pathnameBase])})),o,n,a);return r&&w?l.createElement(si.Provider,{value:{location:eo({pathname:"/",search:"",hash:"",state:null,key:"default"},p),navigationType:In.Pop}},w):w}function Ym(){let t=ef(),r=Lm(t)?t.status+" "+t.statusText:t instanceof Error?t.message:JSON.stringify(t),n=t instanceof Error?t.stack:null,s={padding:"0.5rem",backgroundColor:"rgba(200,200,200, 0.5)"};return l.createElement(l.Fragment,null,l.createElement("h2",null,"Unexpected Application Error!"),l.createElement("h3",{style:{fontStyle:"italic"}},r),n?l.createElement("pre",{style:s},n):null,null)}const Vm=l.createElement(Ym,null);class Gm extends l.Component{constructor(r){super(r),this.state={location:r.location,revalidation:r.revalidation,error:r.error}}static getDerivedStateFromError(r){return{error:r}}static getDerivedStateFromProps(r,n){return n.location!==r.location||n.revalidation!=="idle"&&r.revalidation==="idle"?{error:r.error,location:r.location,revalidation:r.revalidation}:{error:r.error!==void 0?r.error:n.error,location:n.location,revalidation:r.revalidation||n.revalidation}}componentDidCatch(r,n){console.error("React Router caught the following error during render",r,n)}render(){return this.state.error!==void 0?l.createElement(dn.Provider,{value:this.props.routeContext},l.createElement(Hu.Provider,{value:this.state.error,children:this.props.component})):this.props.children}}function Qm(t){let{routeContext:r,match:n,children:a}=t,s=l.useContext(Ll);return s&&s.static&&s.staticContext&&(n.route.errorElement||n.route.ErrorBoundary)&&(s.staticContext._deepestRenderedBoundaryId=n.route.id),l.createElement(dn.Provider,{value:r},a)}function Km(t,r,n,a){var s;if(r===void 0&&(r=[]),n===void 0&&(n=null),a===void 0&&(a=null),t==null){var o;if(!n)return null;if(n.errors)t=n.matches;else if((o=a)!=null&&o.v7_partialHydration&&r.length===0&&!n.initialized&&n.matches.length>0)t=n.matches;else return null}let i=t,c=(s=n)==null?void 0:s.errors;if(c!=null){let p=i.findIndex(m=>m.route.id&&c?.[m.route.id]!==void 0);p>=0||ar(!1),i=i.slice(0,Math.min(i.length,p+1))}let u=!1,d=-1;if(n&&a&&a.v7_partialHydration)for(let p=0;p<i.length;p++){let m=i[p];if((m.route.HydrateFallback||m.route.hydrateFallbackElement)&&(d=p),m.route.id){let{loaderData:f,errors:_}=n,v=m.route.loader&&f[m.route.id]===void 0&&(!_||_[m.route.id]===void 0);if(m.route.lazy||v){u=!0,d>=0?i=i.slice(0,d+1):i=[i[0]];break}}}return i.reduceRight((p,m,f)=>{let _,v=!1,w=null,b=null;n&&(_=c&&m.route.id?c[m.route.id]:void 0,w=m.route.errorElement||Vm,u&&(d<0&&f===0?(rf("route-fallback"),v=!0,b=null):d===f&&(v=!0,b=m.route.hydrateFallbackElement||null)));let P=r.concat(i.slice(0,f+1)),N=()=>{let j;return _?j=w:v?j=b:m.route.Component?j=l.createElement(m.route.Component,null):m.route.element?j=m.route.element:j=p,l.createElement(Qm,{match:m,routeContext:{outlet:p,matches:P,isDataRoute:n!=null},children:j})};return n&&(m.route.ErrorBoundary||m.route.errorElement||f===0)?l.createElement(Gm,{location:n.location,revalidation:n.revalidation,component:w,error:_,children:N(),routeContext:{outlet:null,matches:P,isDataRoute:!0}}):N()},null)}var Gu=function(t){return t.UseBlocker="useBlocker",t.UseRevalidator="useRevalidator",t.UseNavigateStable="useNavigate",t}(Gu||{}),Qu=function(t){return t.UseBlocker="useBlocker",t.UseLoaderData="useLoaderData",t.UseActionData="useActionData",t.UseRouteError="useRouteError",t.UseNavigation="useNavigation",t.UseRouteLoaderData="useRouteLoaderData",t.UseMatches="useMatches",t.UseRevalidator="useRevalidator",t.UseNavigateStable="useNavigate",t.UseRouteId="useRouteId",t}(Qu||{});function Jm(t){let r=l.useContext(Ll);return r||ar(!1),r}function Xm(t){let r=l.useContext(Um);return r||ar(!1),r}function Zm(t){let r=l.useContext(dn);return r||ar(!1),r}function Ku(t){let r=Zm(),n=r.matches[r.matches.length-1];return n.route.id||ar(!1),n.route.id}function ef(){var t;let r=l.useContext(Hu),n=Xm(),a=Ku();return r!==void 0?r:(t=n.errors)==null?void 0:t[a]}function tf(){let{router:t}=Jm(Gu.UseNavigateStable),r=Ku(Qu.UseNavigateStable),n=l.useRef(!1);return Yu(()=>{n.current=!0}),l.useCallback(function(s,o){o===void 0&&(o={}),n.current&&(typeof s=="number"?t.navigate(s):t.navigate(s,eo({fromRouteId:r},o)))},[t,r])}const oc={};function rf(t,r,n){oc[t]||(oc[t]=!0)}function nf(t,r){t?.v7_startTransition,t?.v7_relativeSplatPath}function ws(t){let{to:r,replace:n,state:a,relative:s}=t;Us()||ar(!1);let{future:o,static:i}=l.useContext(qn),{matches:c}=l.useContext(dn),{pathname:u}=un(),d=Gt(),p=Nl(r,Rl(c,o.v7_relativeSplatPath),u,s==="path"),m=JSON.stringify(p);return l.useEffect(()=>d(JSON.parse(m),{replace:n,state:a,relative:s}),[d,m,s,n,a]),null}function sf(t){return zm(t.context)}function lt(t){ar(!1)}function af(t){let{basename:r="/",children:n=null,location:a,navigationType:s=In.Pop,navigator:o,static:i=!1,future:c}=t;Us()&&ar(!1);let u=r.replace(/^\/*/,"/"),d=l.useMemo(()=>({basename:u,navigator:o,static:i,future:eo({v7_relativeSplatPath:!1},c)}),[u,c,o,i]);typeof a=="string"&&(a=as(a));let{pathname:p="/",search:m="",hash:f="",state:_=null,key:v="default"}=a,w=l.useMemo(()=>{let b=Ml(p,u);return b==null?null:{location:{pathname:b,search:m,hash:f,state:_,key:v},navigationType:s}},[u,p,m,f,_,v,s]);return w==null?null:l.createElement(qn.Provider,{value:d},l.createElement(si.Provider,{children:n,value:w}))}function of(t){let{children:r,location:n}=t;return Bm(sl(r),n)}new Promise(()=>{});function sl(t,r){r===void 0&&(r=[]);let n=[];return l.Children.forEach(t,(a,s)=>{if(!l.isValidElement(a))return;let o=[...r,s];if(a.type===l.Fragment){n.push.apply(n,sl(a.props.children,o));return}a.type!==lt&&ar(!1),!a.props.index||!a.props.children||ar(!1);let i={id:a.props.id||o.join("-"),caseSensitive:a.props.caseSensitive,element:a.props.element,Component:a.props.Component,index:a.props.index,path:a.props.path,loader:a.props.loader,action:a.props.action,errorElement:a.props.errorElement,ErrorBoundary:a.props.ErrorBoundary,hasErrorBoundary:a.props.ErrorBoundary!=null||a.props.errorElement!=null,shouldRevalidate:a.props.shouldRevalidate,handle:a.props.handle,lazy:a.props.lazy};a.props.children&&(i.children=sl(a.props.children,o)),n.push(i)}),n}/**
 * React Router DOM v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function al(){return al=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(t[a]=n[a])}return t},al.apply(this,arguments)}function lf(t,r){if(t==null)return{};var n={},a=Object.keys(t),s,o;for(o=0;o<a.length;o++)s=a[o],!(r.indexOf(s)>=0)&&(n[s]=t[s]);return n}function cf(t){return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}function df(t,r){return t.button===0&&(!r||r==="_self")&&!cf(t)}const uf=["onClick","relative","reloadDocument","replace","state","target","to","preventScrollReset","viewTransition"],pf="6";try{window.__reactRouterVersion=pf}catch{}const hf="startTransition",ic=jh[hf];function mf(t){let{basename:r,children:n,future:a,window:s}=t,o=l.useRef();o.current==null&&(o.current=hm({window:s,v5Compat:!0}));let i=o.current,[c,u]=l.useState({action:i.action,location:i.location}),{v7_startTransition:d}=a||{},p=l.useCallback(m=>{d&&ic?ic(()=>u(m)):u(m)},[u,d]);return l.useLayoutEffect(()=>i.listen(p),[i,p]),l.useEffect(()=>nf(a),[a]),l.createElement(af,{basename:r,children:n,location:c.location,navigationType:c.action,navigator:i,future:a})}const ff=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u",xf=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,Ju=l.forwardRef(function(r,n){let{onClick:a,relative:s,reloadDocument:o,replace:i,state:c,target:u,to:d,preventScrollReset:p,viewTransition:m}=r,f=lf(r,uf),{basename:_}=l.useContext(qn),v,w=!1;if(typeof d=="string"&&xf.test(d)&&(v=d,ff))try{let j=new URL(window.location.href),E=d.startsWith("//")?new URL(j.protocol+d):new URL(d),A=Ml(E.pathname,_);E.origin===j.origin&&A!=null?d=A+E.search+E.hash:w=!0}catch{}let b=Fm(d,{relative:s}),P=gf(d,{replace:i,state:c,target:u,preventScrollReset:p,relative:s,viewTransition:m});function N(j){a&&a(j),j.defaultPrevented||P(j)}return l.createElement("a",al({},f,{href:v||b,onClick:w||o?a:N,ref:n,target:u}))});var lc;(function(t){t.UseScrollRestoration="useScrollRestoration",t.UseSubmit="useSubmit",t.UseSubmitFetcher="useSubmitFetcher",t.UseFetcher="useFetcher",t.useViewTransitionState="useViewTransitionState"})(lc||(lc={}));var cc;(function(t){t.UseFetcher="useFetcher",t.UseFetchers="useFetchers",t.UseScrollRestoration="useScrollRestoration"})(cc||(cc={}));function gf(t,r){let{target:n,replace:a,state:s,preventScrollReset:o,relative:i,viewTransition:c}=r===void 0?{}:r,u=Gt(),d=un(),p=Vu(t,{relative:i});return l.useCallback(m=>{if(df(m,n)){m.preventDefault();let f=a!==void 0?a:zo(d)===zo(p);u(t,{replace:f,state:s,preventScrollReset:o,relative:i,viewTransition:c})}},[d,u,p,a,s,n,t,o,i,c])}function Xu(t,r){return function(){return t.apply(r,arguments)}}const{toString:yf}=Object.prototype,{getPrototypeOf:ql}=Object,{iterator:ai,toStringTag:Zu}=Symbol,oi=(t=>r=>{const n=yf.call(r);return t[n]||(t[n]=n.slice(8,-1).toLowerCase())})(Object.create(null)),rn=t=>(t=t.toLowerCase(),r=>oi(r)===t),ii=t=>r=>typeof r===t,{isArray:Fs}=Array,to=ii("undefined");function vf(t){return t!==null&&!to(t)&&t.constructor!==null&&!to(t.constructor)&&Mr(t.constructor.isBuffer)&&t.constructor.isBuffer(t)}const ep=rn("ArrayBuffer");function bf(t){let r;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?r=ArrayBuffer.isView(t):r=t&&t.buffer&&ep(t.buffer),r}const _f=ii("string"),Mr=ii("function"),tp=ii("number"),li=t=>t!==null&&typeof t=="object",jf=t=>t===!0||t===!1,So=t=>{if(oi(t)!=="object")return!1;const r=ql(t);return(r===null||r===Object.prototype||Object.getPrototypeOf(r)===null)&&!(Zu in t)&&!(ai in t)},wf=rn("Date"),Sf=rn("File"),Cf=rn("Blob"),kf=rn("FileList"),Pf=t=>li(t)&&Mr(t.pipe),Ef=t=>{let r;return t&&(typeof FormData=="function"&&t instanceof FormData||Mr(t.append)&&((r=oi(t))==="formdata"||r==="object"&&Mr(t.toString)&&t.toString()==="[object FormData]"))},Df=rn("URLSearchParams"),[Tf,If,Of,Af]=["ReadableStream","Request","Response","Headers"].map(rn),Mf=t=>t.trim?t.trim():t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function oo(t,r,{allOwnKeys:n=!1}={}){if(t===null||typeof t>"u")return;let a,s;if(typeof t!="object"&&(t=[t]),Fs(t))for(a=0,s=t.length;a<s;a++)r.call(null,t[a],a,t);else{const o=n?Object.getOwnPropertyNames(t):Object.keys(t),i=o.length;let c;for(a=0;a<i;a++)c=o[a],r.call(null,t[c],c,t)}}function rp(t,r){r=r.toLowerCase();const n=Object.keys(t);let a=n.length,s;for(;a-- >0;)if(s=n[a],r===s.toLowerCase())return s;return null}const Xn=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,np=t=>!to(t)&&t!==Xn;function ol(){const{caseless:t}=np(this)&&this||{},r={},n=(a,s)=>{const o=t&&rp(r,s)||s;So(r[o])&&So(a)?r[o]=ol(r[o],a):So(a)?r[o]=ol({},a):Fs(a)?r[o]=a.slice():r[o]=a};for(let a=0,s=arguments.length;a<s;a++)arguments[a]&&oo(arguments[a],n);return r}const Rf=(t,r,n,{allOwnKeys:a}={})=>(oo(r,(s,o)=>{n&&Mr(s)?t[o]=Xu(s,n):t[o]=s},{allOwnKeys:a}),t),Nf=t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),Lf=(t,r,n,a)=>{t.prototype=Object.create(r.prototype,a),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:r.prototype}),n&&Object.assign(t.prototype,n)},qf=(t,r,n,a)=>{let s,o,i;const c={};if(r=r||{},t==null)return r;do{for(s=Object.getOwnPropertyNames(t),o=s.length;o-- >0;)i=s[o],(!a||a(i,t,r))&&!c[i]&&(r[i]=t[i],c[i]=!0);t=n!==!1&&ql(t)}while(t&&(!n||n(t,r))&&t!==Object.prototype);return r},Uf=(t,r,n)=>{t=String(t),(n===void 0||n>t.length)&&(n=t.length),n-=r.length;const a=t.indexOf(r,n);return a!==-1&&a===n},Ff=t=>{if(!t)return null;if(Fs(t))return t;let r=t.length;if(!tp(r))return null;const n=new Array(r);for(;r-- >0;)n[r]=t[r];return n},Wf=(t=>r=>t&&r instanceof t)(typeof Uint8Array<"u"&&ql(Uint8Array)),$f=(t,r)=>{const a=(t&&t[ai]).call(t);let s;for(;(s=a.next())&&!s.done;){const o=s.value;r.call(t,o[0],o[1])}},zf=(t,r)=>{let n;const a=[];for(;(n=t.exec(r))!==null;)a.push(n);return a},Bf=rn("HTMLFormElement"),Hf=t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(n,a,s){return a.toUpperCase()+s}),dc=(({hasOwnProperty:t})=>(r,n)=>t.call(r,n))(Object.prototype),Yf=rn("RegExp"),sp=(t,r)=>{const n=Object.getOwnPropertyDescriptors(t),a={};oo(n,(s,o)=>{let i;(i=r(s,o,t))!==!1&&(a[o]=i||s)}),Object.defineProperties(t,a)},Vf=t=>{sp(t,(r,n)=>{if(Mr(t)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const a=t[n];if(Mr(a)){if(r.enumerable=!1,"writable"in r){r.writable=!1;return}r.set||(r.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")})}})},Gf=(t,r)=>{const n={},a=s=>{s.forEach(o=>{n[o]=!0})};return Fs(t)?a(t):a(String(t).split(r)),n},Qf=()=>{},Kf=(t,r)=>t!=null&&Number.isFinite(t=+t)?t:r;function Jf(t){return!!(t&&Mr(t.append)&&t[Zu]==="FormData"&&t[ai])}const Xf=t=>{const r=new Array(10),n=(a,s)=>{if(li(a)){if(r.indexOf(a)>=0)return;if(!("toJSON"in a)){r[s]=a;const o=Fs(a)?[]:{};return oo(a,(i,c)=>{const u=n(i,s+1);!to(u)&&(o[c]=u)}),r[s]=void 0,o}}return a};return n(t,0)},Zf=rn("AsyncFunction"),ex=t=>t&&(li(t)||Mr(t))&&Mr(t.then)&&Mr(t.catch),ap=((t,r)=>t?setImmediate:r?((n,a)=>(Xn.addEventListener("message",({source:s,data:o})=>{s===Xn&&o===n&&a.length&&a.shift()()},!1),s=>{a.push(s),Xn.postMessage(n,"*")}))(`axios@${Math.random()}`,[]):n=>setTimeout(n))(typeof setImmediate=="function",Mr(Xn.postMessage)),tx=typeof queueMicrotask<"u"?queueMicrotask.bind(Xn):typeof process<"u"&&process.nextTick||ap,rx=t=>t!=null&&Mr(t[ai]),Se={isArray:Fs,isArrayBuffer:ep,isBuffer:vf,isFormData:Ef,isArrayBufferView:bf,isString:_f,isNumber:tp,isBoolean:jf,isObject:li,isPlainObject:So,isReadableStream:Tf,isRequest:If,isResponse:Of,isHeaders:Af,isUndefined:to,isDate:wf,isFile:Sf,isBlob:Cf,isRegExp:Yf,isFunction:Mr,isStream:Pf,isURLSearchParams:Df,isTypedArray:Wf,isFileList:kf,forEach:oo,merge:ol,extend:Rf,trim:Mf,stripBOM:Nf,inherits:Lf,toFlatObject:qf,kindOf:oi,kindOfTest:rn,endsWith:Uf,toArray:Ff,forEachEntry:$f,matchAll:zf,isHTMLForm:Bf,hasOwnProperty:dc,hasOwnProp:dc,reduceDescriptors:sp,freezeMethods:Vf,toObjectSet:Gf,toCamelCase:Hf,noop:Qf,toFiniteNumber:Kf,findKey:rp,global:Xn,isContextDefined:np,isSpecCompliantForm:Jf,toJSONObject:Xf,isAsyncFn:Zf,isThenable:ex,setImmediate:ap,asap:tx,isIterable:rx};function St(t,r,n,a,s){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",r&&(this.code=r),n&&(this.config=n),a&&(this.request=a),s&&(this.response=s,this.status=s.status?s.status:null)}Se.inherits(St,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:Se.toJSONObject(this.config),code:this.code,status:this.status}}});const op=St.prototype,ip={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{ip[t]={value:t}});Object.defineProperties(St,ip);Object.defineProperty(op,"isAxiosError",{value:!0});St.from=(t,r,n,a,s,o)=>{const i=Object.create(op);return Se.toFlatObject(t,i,function(u){return u!==Error.prototype},c=>c!=="isAxiosError"),St.call(i,t.message,r,n,a,s),i.cause=t,i.name=t.name,o&&Object.assign(i,o),i};const nx=null;function il(t){return Se.isPlainObject(t)||Se.isArray(t)}function lp(t){return Se.endsWith(t,"[]")?t.slice(0,-2):t}function uc(t,r,n){return t?t.concat(r).map(function(s,o){return s=lp(s),!n&&o?"["+s+"]":s}).join(n?".":""):r}function sx(t){return Se.isArray(t)&&!t.some(il)}const ax=Se.toFlatObject(Se,{},null,function(r){return/^is[A-Z]/.test(r)});function ci(t,r,n){if(!Se.isObject(t))throw new TypeError("target must be an object");r=r||new FormData,n=Se.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(w,b){return!Se.isUndefined(b[w])});const a=n.metaTokens,s=n.visitor||p,o=n.dots,i=n.indexes,u=(n.Blob||typeof Blob<"u"&&Blob)&&Se.isSpecCompliantForm(r);if(!Se.isFunction(s))throw new TypeError("visitor must be a function");function d(v){if(v===null)return"";if(Se.isDate(v))return v.toISOString();if(Se.isBoolean(v))return v.toString();if(!u&&Se.isBlob(v))throw new St("Blob is not supported. Use a Buffer instead.");return Se.isArrayBuffer(v)||Se.isTypedArray(v)?u&&typeof Blob=="function"?new Blob([v]):Buffer.from(v):v}function p(v,w,b){let P=v;if(v&&!b&&typeof v=="object"){if(Se.endsWith(w,"{}"))w=a?w:w.slice(0,-2),v=JSON.stringify(v);else if(Se.isArray(v)&&sx(v)||(Se.isFileList(v)||Se.endsWith(w,"[]"))&&(P=Se.toArray(v)))return w=lp(w),P.forEach(function(j,E){!(Se.isUndefined(j)||j===null)&&r.append(i===!0?uc([w],E,o):i===null?w:w+"[]",d(j))}),!1}return il(v)?!0:(r.append(uc(b,w,o),d(v)),!1)}const m=[],f=Object.assign(ax,{defaultVisitor:p,convertValue:d,isVisitable:il});function _(v,w){if(!Se.isUndefined(v)){if(m.indexOf(v)!==-1)throw Error("Circular reference detected in "+w.join("."));m.push(v),Se.forEach(v,function(P,N){(!(Se.isUndefined(P)||P===null)&&s.call(r,P,Se.isString(N)?N.trim():N,w,f))===!0&&_(P,w?w.concat(N):[N])}),m.pop()}}if(!Se.isObject(t))throw new TypeError("data must be an object");return _(t),r}function pc(t){const r={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(a){return r[a]})}function Ul(t,r){this._pairs=[],t&&ci(t,this,r)}const cp=Ul.prototype;cp.append=function(r,n){this._pairs.push([r,n])};cp.toString=function(r){const n=r?function(a){return r.call(this,a,pc)}:pc;return this._pairs.map(function(s){return n(s[0])+"="+n(s[1])},"").join("&")};function ox(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function dp(t,r,n){if(!r)return t;const a=n&&n.encode||ox;Se.isFunction(n)&&(n={serialize:n});const s=n&&n.serialize;let o;if(s?o=s(r,n):o=Se.isURLSearchParams(r)?r.toString():new Ul(r,n).toString(a),o){const i=t.indexOf("#");i!==-1&&(t=t.slice(0,i)),t+=(t.indexOf("?")===-1?"?":"&")+o}return t}class hc{constructor(){this.handlers=[]}use(r,n,a){return this.handlers.push({fulfilled:r,rejected:n,synchronous:a?a.synchronous:!1,runWhen:a?a.runWhen:null}),this.handlers.length-1}eject(r){this.handlers[r]&&(this.handlers[r]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(r){Se.forEach(this.handlers,function(a){a!==null&&r(a)})}}const up={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},ix=typeof URLSearchParams<"u"?URLSearchParams:Ul,lx=typeof FormData<"u"?FormData:null,cx=typeof Blob<"u"?Blob:null,dx={isBrowser:!0,classes:{URLSearchParams:ix,FormData:lx,Blob:cx},protocols:["http","https","file","blob","url","data"]},Fl=typeof window<"u"&&typeof document<"u",ll=typeof navigator=="object"&&navigator||void 0,ux=Fl&&(!ll||["ReactNative","NativeScript","NS"].indexOf(ll.product)<0),px=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",hx=Fl&&window.location.href||"http://localhost",mx=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:Fl,hasStandardBrowserEnv:ux,hasStandardBrowserWebWorkerEnv:px,navigator:ll,origin:hx},Symbol.toStringTag,{value:"Module"})),jr={...mx,...dx};function fx(t,r){return ci(t,new jr.classes.URLSearchParams,Object.assign({visitor:function(n,a,s,o){return jr.isNode&&Se.isBuffer(n)?(this.append(a,n.toString("base64")),!1):o.defaultVisitor.apply(this,arguments)}},r))}function xx(t){return Se.matchAll(/\w+|\[(\w*)]/g,t).map(r=>r[0]==="[]"?"":r[1]||r[0])}function gx(t){const r={},n=Object.keys(t);let a;const s=n.length;let o;for(a=0;a<s;a++)o=n[a],r[o]=t[o];return r}function pp(t){function r(n,a,s,o){let i=n[o++];if(i==="__proto__")return!0;const c=Number.isFinite(+i),u=o>=n.length;return i=!i&&Se.isArray(s)?s.length:i,u?(Se.hasOwnProp(s,i)?s[i]=[s[i],a]:s[i]=a,!c):((!s[i]||!Se.isObject(s[i]))&&(s[i]=[]),r(n,a,s[i],o)&&Se.isArray(s[i])&&(s[i]=gx(s[i])),!c)}if(Se.isFormData(t)&&Se.isFunction(t.entries)){const n={};return Se.forEachEntry(t,(a,s)=>{r(xx(a),s,n,0)}),n}return null}function yx(t,r,n){if(Se.isString(t))try{return(r||JSON.parse)(t),Se.trim(t)}catch(a){if(a.name!=="SyntaxError")throw a}return(n||JSON.stringify)(t)}const io={transitional:up,adapter:["xhr","http","fetch"],transformRequest:[function(r,n){const a=n.getContentType()||"",s=a.indexOf("application/json")>-1,o=Se.isObject(r);if(o&&Se.isHTMLForm(r)&&(r=new FormData(r)),Se.isFormData(r))return s?JSON.stringify(pp(r)):r;if(Se.isArrayBuffer(r)||Se.isBuffer(r)||Se.isStream(r)||Se.isFile(r)||Se.isBlob(r)||Se.isReadableStream(r))return r;if(Se.isArrayBufferView(r))return r.buffer;if(Se.isURLSearchParams(r))return n.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),r.toString();let c;if(o){if(a.indexOf("application/x-www-form-urlencoded")>-1)return fx(r,this.formSerializer).toString();if((c=Se.isFileList(r))||a.indexOf("multipart/form-data")>-1){const u=this.env&&this.env.FormData;return ci(c?{"files[]":r}:r,u&&new u,this.formSerializer)}}return o||s?(n.setContentType("application/json",!1),yx(r)):r}],transformResponse:[function(r){const n=this.transitional||io.transitional,a=n&&n.forcedJSONParsing,s=this.responseType==="json";if(Se.isResponse(r)||Se.isReadableStream(r))return r;if(r&&Se.isString(r)&&(a&&!this.responseType||s)){const i=!(n&&n.silentJSONParsing)&&s;try{return JSON.parse(r)}catch(c){if(i)throw c.name==="SyntaxError"?St.from(c,St.ERR_BAD_RESPONSE,this,null,this.response):c}}return r}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:jr.classes.FormData,Blob:jr.classes.Blob},validateStatus:function(r){return r>=200&&r<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};Se.forEach(["delete","get","head","post","put","patch"],t=>{io.headers[t]={}});const vx=Se.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),bx=t=>{const r={};let n,a,s;return t&&t.split(`
`).forEach(function(i){s=i.indexOf(":"),n=i.substring(0,s).trim().toLowerCase(),a=i.substring(s+1).trim(),!(!n||r[n]&&vx[n])&&(n==="set-cookie"?r[n]?r[n].push(a):r[n]=[a]:r[n]=r[n]?r[n]+", "+a:a)}),r},mc=Symbol("internals");function Gs(t){return t&&String(t).trim().toLowerCase()}function Co(t){return t===!1||t==null?t:Se.isArray(t)?t.map(Co):String(t)}function _x(t){const r=Object.create(null),n=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let a;for(;a=n.exec(t);)r[a[1]]=a[2];return r}const jx=t=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(t.trim());function Oi(t,r,n,a,s){if(Se.isFunction(a))return a.call(this,r,n);if(s&&(r=n),!!Se.isString(r)){if(Se.isString(a))return r.indexOf(a)!==-1;if(Se.isRegExp(a))return a.test(r)}}function wx(t){return t.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(r,n,a)=>n.toUpperCase()+a)}function Sx(t,r){const n=Se.toCamelCase(" "+r);["get","set","has"].forEach(a=>{Object.defineProperty(t,a+n,{value:function(s,o,i){return this[a].call(this,r,s,o,i)},configurable:!0})})}let Rr=class{constructor(r){r&&this.set(r)}set(r,n,a){const s=this;function o(c,u,d){const p=Gs(u);if(!p)throw new Error("header name must be a non-empty string");const m=Se.findKey(s,p);(!m||s[m]===void 0||d===!0||d===void 0&&s[m]!==!1)&&(s[m||u]=Co(c))}const i=(c,u)=>Se.forEach(c,(d,p)=>o(d,p,u));if(Se.isPlainObject(r)||r instanceof this.constructor)i(r,n);else if(Se.isString(r)&&(r=r.trim())&&!jx(r))i(bx(r),n);else if(Se.isObject(r)&&Se.isIterable(r)){let c={},u,d;for(const p of r){if(!Se.isArray(p))throw TypeError("Object iterator must return a key-value pair");c[d=p[0]]=(u=c[d])?Se.isArray(u)?[...u,p[1]]:[u,p[1]]:p[1]}i(c,n)}else r!=null&&o(n,r,a);return this}get(r,n){if(r=Gs(r),r){const a=Se.findKey(this,r);if(a){const s=this[a];if(!n)return s;if(n===!0)return _x(s);if(Se.isFunction(n))return n.call(this,s,a);if(Se.isRegExp(n))return n.exec(s);throw new TypeError("parser must be boolean|regexp|function")}}}has(r,n){if(r=Gs(r),r){const a=Se.findKey(this,r);return!!(a&&this[a]!==void 0&&(!n||Oi(this,this[a],a,n)))}return!1}delete(r,n){const a=this;let s=!1;function o(i){if(i=Gs(i),i){const c=Se.findKey(a,i);c&&(!n||Oi(a,a[c],c,n))&&(delete a[c],s=!0)}}return Se.isArray(r)?r.forEach(o):o(r),s}clear(r){const n=Object.keys(this);let a=n.length,s=!1;for(;a--;){const o=n[a];(!r||Oi(this,this[o],o,r,!0))&&(delete this[o],s=!0)}return s}normalize(r){const n=this,a={};return Se.forEach(this,(s,o)=>{const i=Se.findKey(a,o);if(i){n[i]=Co(s),delete n[o];return}const c=r?wx(o):String(o).trim();c!==o&&delete n[o],n[c]=Co(s),a[c]=!0}),this}concat(...r){return this.constructor.concat(this,...r)}toJSON(r){const n=Object.create(null);return Se.forEach(this,(a,s)=>{a!=null&&a!==!1&&(n[s]=r&&Se.isArray(a)?a.join(", "):a)}),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([r,n])=>r+": "+n).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(r){return r instanceof this?r:new this(r)}static concat(r,...n){const a=new this(r);return n.forEach(s=>a.set(s)),a}static accessor(r){const a=(this[mc]=this[mc]={accessors:{}}).accessors,s=this.prototype;function o(i){const c=Gs(i);a[c]||(Sx(s,i),a[c]=!0)}return Se.isArray(r)?r.forEach(o):o(r),this}};Rr.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);Se.reduceDescriptors(Rr.prototype,({value:t},r)=>{let n=r[0].toUpperCase()+r.slice(1);return{get:()=>t,set(a){this[n]=a}}});Se.freezeMethods(Rr);function Ai(t,r){const n=this||io,a=r||n,s=Rr.from(a.headers);let o=a.data;return Se.forEach(t,function(c){o=c.call(n,o,s.normalize(),r?r.status:void 0)}),s.normalize(),o}function hp(t){return!!(t&&t.__CANCEL__)}function Ws(t,r,n){St.call(this,t??"canceled",St.ERR_CANCELED,r,n),this.name="CanceledError"}Se.inherits(Ws,St,{__CANCEL__:!0});function mp(t,r,n){const a=n.config.validateStatus;!n.status||!a||a(n.status)?t(n):r(new St("Request failed with status code "+n.status,[St.ERR_BAD_REQUEST,St.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n))}function Cx(t){const r=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return r&&r[1]||""}function kx(t,r){t=t||10;const n=new Array(t),a=new Array(t);let s=0,o=0,i;return r=r!==void 0?r:1e3,function(u){const d=Date.now(),p=a[o];i||(i=d),n[s]=u,a[s]=d;let m=o,f=0;for(;m!==s;)f+=n[m++],m=m%t;if(s=(s+1)%t,s===o&&(o=(o+1)%t),d-i<r)return;const _=p&&d-p;return _?Math.round(f*1e3/_):void 0}}function Px(t,r){let n=0,a=1e3/r,s,o;const i=(d,p=Date.now())=>{n=p,s=null,o&&(clearTimeout(o),o=null),t.apply(null,d)};return[(...d)=>{const p=Date.now(),m=p-n;m>=a?i(d,p):(s=d,o||(o=setTimeout(()=>{o=null,i(s)},a-m)))},()=>s&&i(s)]}const Bo=(t,r,n=3)=>{let a=0;const s=kx(50,250);return Px(o=>{const i=o.loaded,c=o.lengthComputable?o.total:void 0,u=i-a,d=s(u),p=i<=c;a=i;const m={loaded:i,total:c,progress:c?i/c:void 0,bytes:u,rate:d||void 0,estimated:d&&c&&p?(c-i)/d:void 0,event:o,lengthComputable:c!=null,[r?"download":"upload"]:!0};t(m)},n)},fc=(t,r)=>{const n=t!=null;return[a=>r[0]({lengthComputable:n,total:t,loaded:a}),r[1]]},xc=t=>(...r)=>Se.asap(()=>t(...r)),Ex=jr.hasStandardBrowserEnv?((t,r)=>n=>(n=new URL(n,jr.origin),t.protocol===n.protocol&&t.host===n.host&&(r||t.port===n.port)))(new URL(jr.origin),jr.navigator&&/(msie|trident)/i.test(jr.navigator.userAgent)):()=>!0,Dx=jr.hasStandardBrowserEnv?{write(t,r,n,a,s,o){const i=[t+"="+encodeURIComponent(r)];Se.isNumber(n)&&i.push("expires="+new Date(n).toGMTString()),Se.isString(a)&&i.push("path="+a),Se.isString(s)&&i.push("domain="+s),o===!0&&i.push("secure"),document.cookie=i.join("; ")},read(t){const r=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return r?decodeURIComponent(r[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function Tx(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)}function Ix(t,r){return r?t.replace(/\/?\/$/,"")+"/"+r.replace(/^\/+/,""):t}function fp(t,r,n){let a=!Tx(r);return t&&(a||n==!1)?Ix(t,r):r}const gc=t=>t instanceof Rr?{...t}:t;function rs(t,r){r=r||{};const n={};function a(d,p,m,f){return Se.isPlainObject(d)&&Se.isPlainObject(p)?Se.merge.call({caseless:f},d,p):Se.isPlainObject(p)?Se.merge({},p):Se.isArray(p)?p.slice():p}function s(d,p,m,f){if(Se.isUndefined(p)){if(!Se.isUndefined(d))return a(void 0,d,m,f)}else return a(d,p,m,f)}function o(d,p){if(!Se.isUndefined(p))return a(void 0,p)}function i(d,p){if(Se.isUndefined(p)){if(!Se.isUndefined(d))return a(void 0,d)}else return a(void 0,p)}function c(d,p,m){if(m in r)return a(d,p);if(m in t)return a(void 0,d)}const u={url:o,method:o,data:o,baseURL:i,transformRequest:i,transformResponse:i,paramsSerializer:i,timeout:i,timeoutMessage:i,withCredentials:i,withXSRFToken:i,adapter:i,responseType:i,xsrfCookieName:i,xsrfHeaderName:i,onUploadProgress:i,onDownloadProgress:i,decompress:i,maxContentLength:i,maxBodyLength:i,beforeRedirect:i,transport:i,httpAgent:i,httpsAgent:i,cancelToken:i,socketPath:i,responseEncoding:i,validateStatus:c,headers:(d,p,m)=>s(gc(d),gc(p),m,!0)};return Se.forEach(Object.keys(Object.assign({},t,r)),function(p){const m=u[p]||s,f=m(t[p],r[p],p);Se.isUndefined(f)&&m!==c||(n[p]=f)}),n}const xp=t=>{const r=rs({},t);let{data:n,withXSRFToken:a,xsrfHeaderName:s,xsrfCookieName:o,headers:i,auth:c}=r;r.headers=i=Rr.from(i),r.url=dp(fp(r.baseURL,r.url,r.allowAbsoluteUrls),t.params,t.paramsSerializer),c&&i.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):"")));let u;if(Se.isFormData(n)){if(jr.hasStandardBrowserEnv||jr.hasStandardBrowserWebWorkerEnv)i.setContentType(void 0);else if((u=i.getContentType())!==!1){const[d,...p]=u?u.split(";").map(m=>m.trim()).filter(Boolean):[];i.setContentType([d||"multipart/form-data",...p].join("; "))}}if(jr.hasStandardBrowserEnv&&(a&&Se.isFunction(a)&&(a=a(r)),a||a!==!1&&Ex(r.url))){const d=s&&o&&Dx.read(o);d&&i.set(s,d)}return r},Ox=typeof XMLHttpRequest<"u",Ax=Ox&&function(t){return new Promise(function(n,a){const s=xp(t);let o=s.data;const i=Rr.from(s.headers).normalize();let{responseType:c,onUploadProgress:u,onDownloadProgress:d}=s,p,m,f,_,v;function w(){_&&_(),v&&v(),s.cancelToken&&s.cancelToken.unsubscribe(p),s.signal&&s.signal.removeEventListener("abort",p)}let b=new XMLHttpRequest;b.open(s.method.toUpperCase(),s.url,!0),b.timeout=s.timeout;function P(){if(!b)return;const j=Rr.from("getAllResponseHeaders"in b&&b.getAllResponseHeaders()),A={data:!c||c==="text"||c==="json"?b.responseText:b.response,status:b.status,statusText:b.statusText,headers:j,config:t,request:b};mp(function(L){n(L),w()},function(L){a(L),w()},A),b=null}"onloadend"in b?b.onloadend=P:b.onreadystatechange=function(){!b||b.readyState!==4||b.status===0&&!(b.responseURL&&b.responseURL.indexOf("file:")===0)||setTimeout(P)},b.onabort=function(){b&&(a(new St("Request aborted",St.ECONNABORTED,t,b)),b=null)},b.onerror=function(){a(new St("Network Error",St.ERR_NETWORK,t,b)),b=null},b.ontimeout=function(){let E=s.timeout?"timeout of "+s.timeout+"ms exceeded":"timeout exceeded";const A=s.transitional||up;s.timeoutErrorMessage&&(E=s.timeoutErrorMessage),a(new St(E,A.clarifyTimeoutError?St.ETIMEDOUT:St.ECONNABORTED,t,b)),b=null},o===void 0&&i.setContentType(null),"setRequestHeader"in b&&Se.forEach(i.toJSON(),function(E,A){b.setRequestHeader(A,E)}),Se.isUndefined(s.withCredentials)||(b.withCredentials=!!s.withCredentials),c&&c!=="json"&&(b.responseType=s.responseType),d&&([f,v]=Bo(d,!0),b.addEventListener("progress",f)),u&&b.upload&&([m,_]=Bo(u),b.upload.addEventListener("progress",m),b.upload.addEventListener("loadend",_)),(s.cancelToken||s.signal)&&(p=j=>{b&&(a(!j||j.type?new Ws(null,t,b):j),b.abort(),b=null)},s.cancelToken&&s.cancelToken.subscribe(p),s.signal&&(s.signal.aborted?p():s.signal.addEventListener("abort",p)));const N=Cx(s.url);if(N&&jr.protocols.indexOf(N)===-1){a(new St("Unsupported protocol "+N+":",St.ERR_BAD_REQUEST,t));return}b.send(o||null)})},Mx=(t,r)=>{const{length:n}=t=t?t.filter(Boolean):[];if(r||n){let a=new AbortController,s;const o=function(d){if(!s){s=!0,c();const p=d instanceof Error?d:this.reason;a.abort(p instanceof St?p:new Ws(p instanceof Error?p.message:p))}};let i=r&&setTimeout(()=>{i=null,o(new St(`timeout ${r} of ms exceeded`,St.ETIMEDOUT))},r);const c=()=>{t&&(i&&clearTimeout(i),i=null,t.forEach(d=>{d.unsubscribe?d.unsubscribe(o):d.removeEventListener("abort",o)}),t=null)};t.forEach(d=>d.addEventListener("abort",o));const{signal:u}=a;return u.unsubscribe=()=>Se.asap(c),u}},Rx=function*(t,r){let n=t.byteLength;if(n<r){yield t;return}let a=0,s;for(;a<n;)s=a+r,yield t.slice(a,s),a=s},Nx=async function*(t,r){for await(const n of Lx(t))yield*Rx(n,r)},Lx=async function*(t){if(t[Symbol.asyncIterator]){yield*t;return}const r=t.getReader();try{for(;;){const{done:n,value:a}=await r.read();if(n)break;yield a}}finally{await r.cancel()}},yc=(t,r,n,a)=>{const s=Nx(t,r);let o=0,i,c=u=>{i||(i=!0,a&&a(u))};return new ReadableStream({async pull(u){try{const{done:d,value:p}=await s.next();if(d){c(),u.close();return}let m=p.byteLength;if(n){let f=o+=m;n(f)}u.enqueue(new Uint8Array(p))}catch(d){throw c(d),d}},cancel(u){return c(u),s.return()}},{highWaterMark:2})},di=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",gp=di&&typeof ReadableStream=="function",qx=di&&(typeof TextEncoder=="function"?(t=>r=>t.encode(r))(new TextEncoder):async t=>new Uint8Array(await new Response(t).arrayBuffer())),yp=(t,...r)=>{try{return!!t(...r)}catch{return!1}},Ux=gp&&yp(()=>{let t=!1;const r=new Request(jr.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!r}),vc=64*1024,cl=gp&&yp(()=>Se.isReadableStream(new Response("").body)),Ho={stream:cl&&(t=>t.body)};di&&(t=>{["text","arrayBuffer","blob","formData","stream"].forEach(r=>{!Ho[r]&&(Ho[r]=Se.isFunction(t[r])?n=>n[r]():(n,a)=>{throw new St(`Response type '${r}' is not supported`,St.ERR_NOT_SUPPORT,a)})})})(new Response);const Fx=async t=>{if(t==null)return 0;if(Se.isBlob(t))return t.size;if(Se.isSpecCompliantForm(t))return(await new Request(jr.origin,{method:"POST",body:t}).arrayBuffer()).byteLength;if(Se.isArrayBufferView(t)||Se.isArrayBuffer(t))return t.byteLength;if(Se.isURLSearchParams(t)&&(t=t+""),Se.isString(t))return(await qx(t)).byteLength},Wx=async(t,r)=>{const n=Se.toFiniteNumber(t.getContentLength());return n??Fx(r)},$x=di&&(async t=>{let{url:r,method:n,data:a,signal:s,cancelToken:o,timeout:i,onDownloadProgress:c,onUploadProgress:u,responseType:d,headers:p,withCredentials:m="same-origin",fetchOptions:f}=xp(t);d=d?(d+"").toLowerCase():"text";let _=Mx([s,o&&o.toAbortSignal()],i),v;const w=_&&_.unsubscribe&&(()=>{_.unsubscribe()});let b;try{if(u&&Ux&&n!=="get"&&n!=="head"&&(b=await Wx(p,a))!==0){let A=new Request(r,{method:"POST",body:a,duplex:"half"}),C;if(Se.isFormData(a)&&(C=A.headers.get("content-type"))&&p.setContentType(C),A.body){const[L,y]=fc(b,Bo(xc(u)));a=yc(A.body,vc,L,y)}}Se.isString(m)||(m=m?"include":"omit");const P="credentials"in Request.prototype;v=new Request(r,{...f,signal:_,method:n.toUpperCase(),headers:p.normalize().toJSON(),body:a,duplex:"half",credentials:P?m:void 0});let N=await fetch(v,f);const j=cl&&(d==="stream"||d==="response");if(cl&&(c||j&&w)){const A={};["status","statusText","headers"].forEach(x=>{A[x]=N[x]});const C=Se.toFiniteNumber(N.headers.get("content-length")),[L,y]=c&&fc(C,Bo(xc(c),!0))||[];N=new Response(yc(N.body,vc,L,()=>{y&&y(),w&&w()}),A)}d=d||"text";let E=await Ho[Se.findKey(Ho,d)||"text"](N,t);return!j&&w&&w(),await new Promise((A,C)=>{mp(A,C,{data:E,headers:Rr.from(N.headers),status:N.status,statusText:N.statusText,config:t,request:v})})}catch(P){throw w&&w(),P&&P.name==="TypeError"&&/Load failed|fetch/i.test(P.message)?Object.assign(new St("Network Error",St.ERR_NETWORK,t,v),{cause:P.cause||P}):St.from(P,P&&P.code,t,v)}}),dl={http:nx,xhr:Ax,fetch:$x};Se.forEach(dl,(t,r)=>{if(t){try{Object.defineProperty(t,"name",{value:r})}catch{}Object.defineProperty(t,"adapterName",{value:r})}});const bc=t=>`- ${t}`,zx=t=>Se.isFunction(t)||t===null||t===!1,vp={getAdapter:t=>{t=Se.isArray(t)?t:[t];const{length:r}=t;let n,a;const s={};for(let o=0;o<r;o++){n=t[o];let i;if(a=n,!zx(n)&&(a=dl[(i=String(n)).toLowerCase()],a===void 0))throw new St(`Unknown adapter '${i}'`);if(a)break;s[i||"#"+o]=a}if(!a){const o=Object.entries(s).map(([c,u])=>`adapter ${c} `+(u===!1?"is not supported by the environment":"is not available in the build"));let i=r?o.length>1?`since :
`+o.map(bc).join(`
`):" "+bc(o[0]):"as no adapter specified";throw new St("There is no suitable adapter to dispatch the request "+i,"ERR_NOT_SUPPORT")}return a},adapters:dl};function Mi(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new Ws(null,t)}function _c(t){return Mi(t),t.headers=Rr.from(t.headers),t.data=Ai.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),vp.getAdapter(t.adapter||io.adapter)(t).then(function(a){return Mi(t),a.data=Ai.call(t,t.transformResponse,a),a.headers=Rr.from(a.headers),a},function(a){return hp(a)||(Mi(t),a&&a.response&&(a.response.data=Ai.call(t,t.transformResponse,a.response),a.response.headers=Rr.from(a.response.headers))),Promise.reject(a)})}const bp="1.10.0",ui={};["object","boolean","number","function","string","symbol"].forEach((t,r)=>{ui[t]=function(a){return typeof a===t||"a"+(r<1?"n ":" ")+t}});const jc={};ui.transitional=function(r,n,a){function s(o,i){return"[Axios v"+bp+"] Transitional option '"+o+"'"+i+(a?". "+a:"")}return(o,i,c)=>{if(r===!1)throw new St(s(i," has been removed"+(n?" in "+n:"")),St.ERR_DEPRECATED);return n&&!jc[i]&&(jc[i]=!0,console.warn(s(i," has been deprecated since v"+n+" and will be removed in the near future"))),r?r(o,i,c):!0}};ui.spelling=function(r){return(n,a)=>(console.warn(`${a} is likely a misspelling of ${r}`),!0)};function Bx(t,r,n){if(typeof t!="object")throw new St("options must be an object",St.ERR_BAD_OPTION_VALUE);const a=Object.keys(t);let s=a.length;for(;s-- >0;){const o=a[s],i=r[o];if(i){const c=t[o],u=c===void 0||i(c,o,t);if(u!==!0)throw new St("option "+o+" must be "+u,St.ERR_BAD_OPTION_VALUE);continue}if(n!==!0)throw new St("Unknown option "+o,St.ERR_BAD_OPTION)}}const ko={assertOptions:Bx,validators:ui},an=ko.validators;let Zn=class{constructor(r){this.defaults=r||{},this.interceptors={request:new hc,response:new hc}}async request(r,n){try{return await this._request(r,n)}catch(a){if(a instanceof Error){let s={};Error.captureStackTrace?Error.captureStackTrace(s):s=new Error;const o=s.stack?s.stack.replace(/^.+\n/,""):"";try{a.stack?o&&!String(a.stack).endsWith(o.replace(/^.+\n.+\n/,""))&&(a.stack+=`
`+o):a.stack=o}catch{}}throw a}}_request(r,n){typeof r=="string"?(n=n||{},n.url=r):n=r||{},n=rs(this.defaults,n);const{transitional:a,paramsSerializer:s,headers:o}=n;a!==void 0&&ko.assertOptions(a,{silentJSONParsing:an.transitional(an.boolean),forcedJSONParsing:an.transitional(an.boolean),clarifyTimeoutError:an.transitional(an.boolean)},!1),s!=null&&(Se.isFunction(s)?n.paramsSerializer={serialize:s}:ko.assertOptions(s,{encode:an.function,serialize:an.function},!0)),n.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?n.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:n.allowAbsoluteUrls=!0),ko.assertOptions(n,{baseUrl:an.spelling("baseURL"),withXsrfToken:an.spelling("withXSRFToken")},!0),n.method=(n.method||this.defaults.method||"get").toLowerCase();let i=o&&Se.merge(o.common,o[n.method]);o&&Se.forEach(["delete","get","head","post","put","patch","common"],v=>{delete o[v]}),n.headers=Rr.concat(i,o);const c=[];let u=!0;this.interceptors.request.forEach(function(w){typeof w.runWhen=="function"&&w.runWhen(n)===!1||(u=u&&w.synchronous,c.unshift(w.fulfilled,w.rejected))});const d=[];this.interceptors.response.forEach(function(w){d.push(w.fulfilled,w.rejected)});let p,m=0,f;if(!u){const v=[_c.bind(this),void 0];for(v.unshift.apply(v,c),v.push.apply(v,d),f=v.length,p=Promise.resolve(n);m<f;)p=p.then(v[m++],v[m++]);return p}f=c.length;let _=n;for(m=0;m<f;){const v=c[m++],w=c[m++];try{_=v(_)}catch(b){w.call(this,b);break}}try{p=_c.call(this,_)}catch(v){return Promise.reject(v)}for(m=0,f=d.length;m<f;)p=p.then(d[m++],d[m++]);return p}getUri(r){r=rs(this.defaults,r);const n=fp(r.baseURL,r.url,r.allowAbsoluteUrls);return dp(n,r.params,r.paramsSerializer)}};Se.forEach(["delete","get","head","options"],function(r){Zn.prototype[r]=function(n,a){return this.request(rs(a||{},{method:r,url:n,data:(a||{}).data}))}});Se.forEach(["post","put","patch"],function(r){function n(a){return function(o,i,c){return this.request(rs(c||{},{method:r,headers:a?{"Content-Type":"multipart/form-data"}:{},url:o,data:i}))}}Zn.prototype[r]=n(),Zn.prototype[r+"Form"]=n(!0)});let Hx=class _p{constructor(r){if(typeof r!="function")throw new TypeError("executor must be a function.");let n;this.promise=new Promise(function(o){n=o});const a=this;this.promise.then(s=>{if(!a._listeners)return;let o=a._listeners.length;for(;o-- >0;)a._listeners[o](s);a._listeners=null}),this.promise.then=s=>{let o;const i=new Promise(c=>{a.subscribe(c),o=c}).then(s);return i.cancel=function(){a.unsubscribe(o)},i},r(function(o,i,c){a.reason||(a.reason=new Ws(o,i,c),n(a.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(r){if(this.reason){r(this.reason);return}this._listeners?this._listeners.push(r):this._listeners=[r]}unsubscribe(r){if(!this._listeners)return;const n=this._listeners.indexOf(r);n!==-1&&this._listeners.splice(n,1)}toAbortSignal(){const r=new AbortController,n=a=>{r.abort(a)};return this.subscribe(n),r.signal.unsubscribe=()=>this.unsubscribe(n),r.signal}static source(){let r;return{token:new _p(function(s){r=s}),cancel:r}}};function Yx(t){return function(n){return t.apply(null,n)}}function Vx(t){return Se.isObject(t)&&t.isAxiosError===!0}const ul={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(ul).forEach(([t,r])=>{ul[r]=t});function jp(t){const r=new Zn(t),n=Xu(Zn.prototype.request,r);return Se.extend(n,Zn.prototype,r,{allOwnKeys:!0}),Se.extend(n,r,null,{allOwnKeys:!0}),n.create=function(s){return jp(rs(t,s))},n}const or=jp(io);or.Axios=Zn;or.CanceledError=Ws;or.CancelToken=Hx;or.isCancel=hp;or.VERSION=bp;or.toFormData=ci;or.AxiosError=St;or.Cancel=or.CanceledError;or.all=function(r){return Promise.all(r)};or.spread=Yx;or.isAxiosError=Vx;or.mergeConfig=rs;or.AxiosHeaders=Rr;or.formToJSON=t=>pp(Se.isHTMLForm(t)?new FormData(t):t);or.getAdapter=vp.getAdapter;or.HttpStatusCode=ul;or.default=or;const{Axios:C1,AxiosError:_r,CanceledError:k1,isCancel:P1,CancelToken:E1,VERSION:D1,all:T1,Cancel:I1,isAxiosError:O1,spread:A1,toFormData:M1,AxiosHeaders:R1,HttpStatusCode:N1,formToJSON:L1,getAdapter:q1,mergeConfig:U1}=or,pl=typeof window<"u"&&!!window.electronAPI;function Gx(t){return t&&t.includes("localhost")&&t.startsWith("https://")?t.replace("https://","http://"):t}console.log("API baseURL:",void 0);console.log("Is Electron:",pl);const Qx={cloudflare:{baseURL:"https://api.yourdomain.com"}};function Is(){return console.log("Environment variables:",{VITE_API_BASE_URL:void 0,VITE_CLOUDFLARE_URL:void 0,MODE:"production",NODE_ENV:"production",isElectron:pl}),pl&&console.log("Running in Electron - checking environment variables"),console.log("Using production config"),{baseURL:Gx(Qx.cloudflare.baseURL),timeout:12e4}}const wc=Is(),B=or.create({baseURL:wc.baseURL,timeout:wc.timeout,withCredentials:!0});B.interceptors.request.use(t=>{const r=localStorage.getItem("sessionToken");r&&(t.headers.Authorization=`Bearer ${r}`);const n=localStorage.getItem("deviceId");n&&(t.headers["x-device-id"]=n);try{const a=typeof Intl<"u"?Intl.DateTimeFormat().resolvedOptions().timeZone:void 0;a&&(t.headers["x-timezone"]=a)}catch{}return t},t=>Promise.reject(t));B.interceptors.response.use(t=>{try{window.__backendUnavailableSince=void 0;const r=window.__triggerSync;typeof r=="function"&&setTimeout(()=>{try{r()}catch{}},0)}catch{}return t},async t=>{try{const n=t?.response?.status,a=!t.response&&(t.code==="ECONNABORTED"||t.message?.includes("Network Error"));(typeof n=="number"&&n>=500||a)&&(window.__backendUnavailableSince=window.__backendUnavailableSince||Date.now())}catch{}const r=t.config;if(t.response?.status===401&&!r._retry){r._retry=!0;const n=localStorage.getItem("refreshToken");if(n)try{const a=await B.post("/api/auth/refresh",{refreshToken:n}),{sessionToken:s,refreshToken:o}=a.data;return localStorage.setItem("sessionToken",s),localStorage.setItem("refreshToken",o),B.defaults.headers.common.Authorization=`Bearer ${s}`,B(r)}catch(a){return localStorage.removeItem("sessionToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),window.location.href="/login",Promise.reject(a)}else localStorage.removeItem("sessionToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),window.location.href="/login"}return Promise.reject(t)});const wp=l.createContext(void 0),Kx=({children:t})=>{const[r,n]=l.useState(null),[a,s]=l.useState(!1),[o,i]=l.useState("");l.useEffect(()=>{let _=localStorage.getItem("deviceId");_||(_=crypto.randomUUID(),localStorage.setItem("deviceId",_)),i(_)},[]),l.useEffect(()=>{const _=localStorage.getItem("sessionToken"),v=localStorage.getItem("refreshToken"),w=localStorage.getItem("user");if(_&&v&&w)try{const b=JSON.parse(w);n(b),s(!0),B.defaults.headers.common.Authorization=`Bearer ${_}`,B.defaults.headers.common["x-device-id"]=o}catch(b){console.error("Error parsing user data:",b),u()}},[o]);const c=(_,v,w)=>{localStorage.setItem("sessionToken",_),localStorage.setItem("refreshToken",v),localStorage.setItem("user",JSON.stringify(w)),n(w),s(!0)},u=()=>{localStorage.removeItem("sessionToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),n(null),s(!1)},d=async()=>{try{await B.post("/api/auth/logout-all"),u()}catch(_){console.error("Error logging out from all devices:",_),u()}},p=async()=>{try{const _=localStorage.getItem("refreshToken");if(!_)return!1;const v=await B.post("/api/auth/refresh",{refreshToken:_}),{sessionToken:w,refreshToken:b}=v.data;return localStorage.setItem("sessionToken",w),localStorage.setItem("refreshToken",b),!0}catch(_){return console.error("Error refreshing session:",_),u(),!1}},m=async()=>{try{return(await B.get("/api/auth/sessions")).data}catch(_){return console.error("Error fetching user sessions:",_),[]}},f=async _=>{try{return await B.delete(`/api/auth/sessions/${_}`),!0}catch(v){return console.error("Error deactivating session:",v),!1}};return e.jsx(wp.Provider,{value:{user:r,isAuthenticated:a,login:c,logout:u,logoutFromAllDevices:d,refreshSession:p,getUserSessions:m,deactivateSession:f,currentDeviceId:o},children:t})},er=()=>{const t=l.useContext(wp);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t},Sc=t=>({id:Number(t.id),companyId:Number(t.companyId??t.company_id),conversationType:t.conversationType??t.conversation_type,title:t.title??null,createdBy:Number(t.createdBy??t.created_by),createdAt:t.createdAt??t.created_at,updatedAt:t.updatedAt??t.updated_at,lastMessageAt:t.lastMessageAt??t.last_message_at??null,participants:Array.isArray(t.participants)?t.participants.map(r=>({id:Number(r.id),username:r.username??null,email:r.email??null,isAdmin:!!(r.isAdmin??r.is_admin??!1)})):[],lastMessage:t.lastMessage?{id:Number(t.lastMessage.id),conversationId:Number(t.lastMessage.conversationId??t.lastMessage.conversation_id??t.id),senderId:t.lastMessage.senderId!==void 0&&t.lastMessage.senderId!==null?Number(t.lastMessage.senderId):null,senderName:t.lastMessage.senderName??null,content:t.lastMessage.isDeletedForUser||t.lastMessage.is_deleted_for_user?"Message deleted":t.lastMessage.content??"",isSystem:!!t.lastMessage.isSystem,createdAt:t.lastMessage.createdAt??"",updatedAt:t.lastMessage.updatedAt??t.lastMessage.createdAt??"",isDeletedForUser:!!(t.lastMessage.isDeletedForUser??t.lastMessage.is_deleted_for_user??!1),deletedAt:t.lastMessage.deletedAt??t.lastMessage.deleted_at??null}:null}),Ri=t=>({id:typeof t.id=="number"||typeof t.id=="string"?t.id:Number(t.id),conversationId:Number(t.conversationId??t.conversation_id),senderId:t.senderId!==void 0&&t.senderId!==null?Number(t.senderId):t.sender_id!==void 0&&t.sender_id!==null?Number(t.sender_id):null,senderName:t.senderName??t.sender_name??t.username??null,content:t.isDeletedForUser||t.is_deleted_for_user?"Message deleted":t.content??"",isSystem:!!(t.isSystem??t.is_system??!1),createdAt:t.createdAt??t.created_at??new Date().toISOString(),updatedAt:t.updatedAt??t.updated_at??t.createdAt??t.created_at??new Date().toISOString(),pending:t.pending,error:t.error,isDeletedForUser:!!(t.isDeletedForUser??t.is_deleted_for_user??!1),deletedAt:t.deletedAt??t.deleted_at??null}),Qs={async createConversation(t){const r=await B.post("/api/messaging/conversations",t),{conversation:n,created:a}=r.data;return{conversation:Sc(n),created:!!a}},async getConversations(){return((await B.get("/api/messaging/conversations")).data?.conversations??[]).map(n=>Sc(n))},async getMessages(t,r={}){return((await B.get(`/api/messaging/conversations/${t}/messages`,{params:r})).data?.messages??[]).map(s=>Ri(s))},async postMessage(t,r){const n=await B.post(`/api/messaging/conversations/${t}/messages`,{content:r});return Ri(n.data?.message??n.data)},async deleteMessage(t,r){const n=await B.delete(`/api/messaging/conversations/${t}/messages/${r}`);return Ri(n.data?.message??n.data)}},Sp=l.createContext(void 0),Jx=(t,r)=>{const n=t.participants??[],a=r?n.filter(i=>i.id!==r):n,s=n.map(i=>i.username||i.email||"Unknown user").join(", ");if(t.conversationType==="group"){const i=t.title?.trim(),c=`${n.length} participants`;return{displayName:i||c,otherParticipants:a,participantNames:s}}if(a.length===1){const i=a[0];return{displayName:i.username||i.email||"Direct message",otherParticipants:a,participantNames:s}}return{displayName:a.length>0?a.map(i=>i.username||i.email||"Direct message").join(", "):t.title||"Direct message",otherParticipants:a,participantNames:s}},Cc=t=>[...t].sort((r,n)=>{const a=r.lastMessageAt||r.updatedAt||r.createdAt,s=n.lastMessageAt||n.updatedAt||n.createdAt;return new Date(s).getTime()-new Date(a).getTime()}),Xx=({children:t})=>{const{isAuthenticated:r,user:n}=er(),a=n?Number(n.id):null,[s,o]=l.useState([]),[i,c]=l.useState(!1),[u,d]=l.useState({}),[p,m]=l.useState({}),[f,_]=l.useState(null),[v,w]=l.useState({}),[b,P]=l.useState([]),N=l.useRef({});l.useEffect(()=>{N.current=u},[u]);const j=l.useMemo(()=>a?`messaging:last-read:${a}`:null,[a]);l.useEffect(()=>{if(!j){w({});return}try{const H=localStorage.getItem(j);if(H){const U=JSON.parse(H);w(U)}else w({})}catch{w({})}},[j]),l.useEffect(()=>{if(j)try{localStorage.setItem(j,JSON.stringify(v))}catch{}},[v,j]);const E=l.useCallback((H,U)=>{j&&w(G=>{const te=U??new Date().toISOString(),re=G[H];return re&&new Date(re).getTime()>=new Date(te).getTime()?G:{...G,[H]:te}})},[j]),A=l.useCallback(H=>{const{displayName:U,otherParticipants:G,participantNames:te}=Jx(H,a);return{...H,displayName:U,otherParticipants:G,participantNames:te}},[a]),C=l.useCallback(async(H={})=>{if(r){H.silent||c(!0);try{const U=await Qs.getConversations(),G=Cc(U.map(A));o(G)}catch(U){console.error("Failed to load conversations",U)}finally{H.silent||c(!1)}}},[A,r]);l.useEffect(()=>{if(!r){o([]),d({}),c(!1),m({}),_(null),P([]);return}C()},[r,C]),l.useEffect(()=>{if(!r)return;const H=setInterval(()=>{C({silent:!0}).catch(()=>{})},1e4);return()=>clearInterval(H)},[r,C]),l.useEffect(()=>{!r||s.length===0||(!f||!s.some(H=>H.id===f))&&_(s[0].id)},[f,s,r]);const L=l.useCallback(async(H,U={})=>{if(r&&!(!U.force&&N.current[H])){U.silent||m(G=>({...G,[H]:!0}));try{const G=await Qs.getMessages(H);d(te=>({...te,[H]:G.map(re=>({...re,pending:!1,error:!1}))}))}catch(G){console.error("Failed to load messages",G)}finally{U.silent||m(G=>({...G,[H]:!1}))}}},[r]);l.useEffect(()=>{f&&L(f).catch(()=>{})},[f,L]),l.useEffect(()=>{if(!f||!r)return;const H=setInterval(()=>{L(f,{force:!0,silent:!0}).catch(()=>{})},1e4);return()=>clearInterval(H)},[f,r,L]);const y=l.useCallback(H=>{_(H),H&&L(H).catch(()=>{})},[L]),x=l.useCallback(async(H,U)=>{if(!r||!n)throw new Error("Not authenticated");const G=U.trim();if(!G)throw new Error("Message cannot be empty");const te=`temp-${Date.now()}`,re={id:te,conversationId:H,senderId:a,senderName:n.username||n.email||null,content:G,isSystem:!1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),pending:!0};d(S=>{const g=S[H]??[];return{...S,[H]:[...g,re]}});try{const S=await Qs.postMessage(H,G);return d(g=>{const T=g[H]??[];return{...g,[H]:T.map(q=>q.id===te?S:q)}}),await C(),E(H,new Date().toISOString()),S}catch(S){throw d(g=>{const T=g[H]??[];return{...g,[H]:T.map(q=>q.id===te?{...q,pending:!1,error:!0}:q)}}),S}},[a,r,C,n]),D=l.useCallback(async(H,U)=>{if(!r)throw new Error("Not authenticated");const G=await Qs.deleteMessage(H,U);return d(te=>{const re=te[H]??[];return{...te,[H]:re.map(S=>Number(S.id)===Number(U)?{...S,...G,id:S.id,content:"Message deleted",isDeletedForUser:!0,deletedAt:G.deletedAt??null,pending:!1,error:!1}:S)}}),C({silent:!0}).catch(()=>{}),G},[r,C]),M=l.useCallback(async H=>{if(!r)throw new Error("Not authenticated");const U=await Qs.createConversation(H),G=A(U.conversation);return o(te=>{const re=te.filter(S=>S.id!==G.id);return Cc([G,...re])}),_(G.id),U.created&&d(te=>({...te,[G.id]:[]})),E(G.id,new Date().toISOString()),{conversation:G,created:U.created}},[A,r,E]);l.useEffect(()=>{if(!r){P([]);return}const H=s.filter(U=>{const G=U.lastMessage;if(!G)return!1;const te=U.lastMessageAt||G.updatedAt||G.createdAt;if(!te)return!1;const re=new Date(te).getTime();if(!re||Number.isNaN(re))return!1;const S=v[U.id]?new Date(v[U.id]).getTime():0;if(S&&S>=re)return!1;const g=G.senderId!==null&&G.senderId!==void 0?Number(G.senderId):null;return!(g!==null&&a!==null&&g===a)}).map(U=>U.id);P(H)},[s,a,r,v]),l.useEffect(()=>{if(!f)return;const H=s.find(G=>G.id===f);if(!H)return;const U=H.lastMessageAt||H.updatedAt||H.createdAt;U&&E(f,U)},[f,s,E]);const X=l.useMemo(()=>({conversations:s,isLoadingConversations:i,activeConversationId:f,selectConversation:y,messagesByConversation:u,loadMessages:L,isLoadingMessages:p,sendMessage:x,createConversation:M,refreshConversations:C,deleteMessage:D,unreadConversationIds:b,unreadConversationCount:b.length,markConversationRead:E}),[s,i,f,y,u,L,p,x,M,C,D,b,E]);return e.jsx(Sp.Provider,{value:X,children:t})},Cp=()=>{const t=l.useContext(Sp);if(!t)throw new Error("useMessaging must be used within a MessagingProvider");return t},Zx=wh({palette:{primary:{main:"#7c3aed"},secondary:{main:"#ffd600"}},typography:{h4:{fontSize:"1.5rem",fontWeight:600},h6:{fontSize:"1.2rem",fontWeight:500}}});var Po={exports:{}},eg=Po.exports,kc;function tg(){return kc||(kc=1,function(t,r){(function(n,a){t.exports=a()})(eg,function(){var n=1e3,a=6e4,s=36e5,o="millisecond",i="second",c="minute",u="hour",d="day",p="week",m="month",f="quarter",_="year",v="date",w="Invalid Date",b=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,P=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,N={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(U){var G=["th","st","nd","rd"],te=U%100;return"["+U+(G[(te-20)%10]||G[te]||G[0])+"]"}},j=function(U,G,te){var re=String(U);return!re||re.length>=G?U:""+Array(G+1-re.length).join(te)+U},E={s:j,z:function(U){var G=-U.utcOffset(),te=Math.abs(G),re=Math.floor(te/60),S=te%60;return(G<=0?"+":"-")+j(re,2,"0")+":"+j(S,2,"0")},m:function U(G,te){if(G.date()<te.date())return-U(te,G);var re=12*(te.year()-G.year())+(te.month()-G.month()),S=G.clone().add(re,m),g=te-S<0,T=G.clone().add(re+(g?-1:1),m);return+(-(re+(te-S)/(g?S-T:T-S))||0)},a:function(U){return U<0?Math.ceil(U)||0:Math.floor(U)},p:function(U){return{M:m,y:_,w:p,d,D:v,h:u,m:c,s:i,ms:o,Q:f}[U]||String(U||"").toLowerCase().replace(/s$/,"")},u:function(U){return U===void 0}},A="en",C={};C[A]=N;var L="$isDayjsObject",y=function(U){return U instanceof X||!(!U||!U[L])},x=function U(G,te,re){var S;if(!G)return A;if(typeof G=="string"){var g=G.toLowerCase();C[g]&&(S=g),te&&(C[g]=te,S=g);var T=G.split("-");if(!S&&T.length>1)return U(T[0])}else{var q=G.name;C[q]=G,S=q}return!re&&S&&(A=S),S||!re&&A},D=function(U,G){if(y(U))return U.clone();var te=typeof G=="object"?G:{};return te.date=U,te.args=arguments,new X(te)},M=E;M.l=x,M.i=y,M.w=function(U,G){return D(U,{locale:G.$L,utc:G.$u,x:G.$x,$offset:G.$offset})};var X=function(){function U(te){this.$L=x(te.locale,null,!0),this.parse(te),this.$x=this.$x||te.x||{},this[L]=!0}var G=U.prototype;return G.parse=function(te){this.$d=function(re){var S=re.date,g=re.utc;if(S===null)return new Date(NaN);if(M.u(S))return new Date;if(S instanceof Date)return new Date(S);if(typeof S=="string"&&!/Z$/i.test(S)){var T=S.match(b);if(T){var q=T[2]-1||0,ee=(T[7]||"0").substring(0,3);return g?new Date(Date.UTC(T[1],q,T[3]||1,T[4]||0,T[5]||0,T[6]||0,ee)):new Date(T[1],q,T[3]||1,T[4]||0,T[5]||0,T[6]||0,ee)}}return new Date(S)}(te),this.init()},G.init=function(){var te=this.$d;this.$y=te.getFullYear(),this.$M=te.getMonth(),this.$D=te.getDate(),this.$W=te.getDay(),this.$H=te.getHours(),this.$m=te.getMinutes(),this.$s=te.getSeconds(),this.$ms=te.getMilliseconds()},G.$utils=function(){return M},G.isValid=function(){return this.$d.toString()!==w},G.isSame=function(te,re){var S=D(te);return this.startOf(re)<=S&&S<=this.endOf(re)},G.isAfter=function(te,re){return D(te)<this.startOf(re)},G.isBefore=function(te,re){return this.endOf(re)<D(te)},G.$g=function(te,re,S){return M.u(te)?this[re]:this.set(S,te)},G.unix=function(){return Math.floor(this.valueOf()/1e3)},G.valueOf=function(){return this.$d.getTime()},G.startOf=function(te,re){var S=this,g=!!M.u(re)||re,T=M.p(te),q=function(me,ge){var pe=M.w(S.$u?Date.UTC(S.$y,ge,me):new Date(S.$y,ge,me),S);return g?pe:pe.endOf(d)},ee=function(me,ge){return M.w(S.toDate()[me].apply(S.toDate("s"),(g?[0,0,0,0]:[23,59,59,999]).slice(ge)),S)},R=this.$W,K=this.$M,F=this.$D,xe="set"+(this.$u?"UTC":"");switch(T){case _:return g?q(1,0):q(31,11);case m:return g?q(1,K):q(0,K+1);case p:var ve=this.$locale().weekStart||0,de=(R<ve?R+7:R)-ve;return q(g?F-de:F+(6-de),K);case d:case v:return ee(xe+"Hours",0);case u:return ee(xe+"Minutes",1);case c:return ee(xe+"Seconds",2);case i:return ee(xe+"Milliseconds",3);default:return this.clone()}},G.endOf=function(te){return this.startOf(te,!1)},G.$set=function(te,re){var S,g=M.p(te),T="set"+(this.$u?"UTC":""),q=(S={},S[d]=T+"Date",S[v]=T+"Date",S[m]=T+"Month",S[_]=T+"FullYear",S[u]=T+"Hours",S[c]=T+"Minutes",S[i]=T+"Seconds",S[o]=T+"Milliseconds",S)[g],ee=g===d?this.$D+(re-this.$W):re;if(g===m||g===_){var R=this.clone().set(v,1);R.$d[q](ee),R.init(),this.$d=R.set(v,Math.min(this.$D,R.daysInMonth())).$d}else q&&this.$d[q](ee);return this.init(),this},G.set=function(te,re){return this.clone().$set(te,re)},G.get=function(te){return this[M.p(te)]()},G.add=function(te,re){var S,g=this;te=Number(te);var T=M.p(re),q=function(K){var F=D(g);return M.w(F.date(F.date()+Math.round(K*te)),g)};if(T===m)return this.set(m,this.$M+te);if(T===_)return this.set(_,this.$y+te);if(T===d)return q(1);if(T===p)return q(7);var ee=(S={},S[c]=a,S[u]=s,S[i]=n,S)[T]||1,R=this.$d.getTime()+te*ee;return M.w(R,this)},G.subtract=function(te,re){return this.add(-1*te,re)},G.format=function(te){var re=this,S=this.$locale();if(!this.isValid())return S.invalidDate||w;var g=te||"YYYY-MM-DDTHH:mm:ssZ",T=M.z(this),q=this.$H,ee=this.$m,R=this.$M,K=S.weekdays,F=S.months,xe=S.meridiem,ve=function(ge,pe,se,I){return ge&&(ge[pe]||ge(re,g))||se[pe].slice(0,I)},de=function(ge){return M.s(q%12||12,ge,"0")},me=xe||function(ge,pe,se){var I=ge<12?"AM":"PM";return se?I.toLowerCase():I};return g.replace(P,function(ge,pe){return pe||function(se){switch(se){case"YY":return String(re.$y).slice(-2);case"YYYY":return M.s(re.$y,4,"0");case"M":return R+1;case"MM":return M.s(R+1,2,"0");case"MMM":return ve(S.monthsShort,R,F,3);case"MMMM":return ve(F,R);case"D":return re.$D;case"DD":return M.s(re.$D,2,"0");case"d":return String(re.$W);case"dd":return ve(S.weekdaysMin,re.$W,K,2);case"ddd":return ve(S.weekdaysShort,re.$W,K,3);case"dddd":return K[re.$W];case"H":return String(q);case"HH":return M.s(q,2,"0");case"h":return de(1);case"hh":return de(2);case"a":return me(q,ee,!0);case"A":return me(q,ee,!1);case"m":return String(ee);case"mm":return M.s(ee,2,"0");case"s":return String(re.$s);case"ss":return M.s(re.$s,2,"0");case"SSS":return M.s(re.$ms,3,"0");case"Z":return T}return null}(ge)||T.replace(":","")})},G.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},G.diff=function(te,re,S){var g,T=this,q=M.p(re),ee=D(te),R=(ee.utcOffset()-this.utcOffset())*a,K=this-ee,F=function(){return M.m(T,ee)};switch(q){case _:g=F()/12;break;case m:g=F();break;case f:g=F()/3;break;case p:g=(K-R)/6048e5;break;case d:g=(K-R)/864e5;break;case u:g=K/s;break;case c:g=K/a;break;case i:g=K/n;break;default:g=K}return S?g:M.a(g)},G.daysInMonth=function(){return this.endOf(m).$D},G.$locale=function(){return C[this.$L]},G.locale=function(te,re){if(!te)return this.$L;var S=this.clone(),g=x(te,re,!0);return g&&(S.$L=g),S},G.clone=function(){return M.w(this.$d,this)},G.toDate=function(){return new Date(this.valueOf())},G.toJSON=function(){return this.isValid()?this.toISOString():null},G.toISOString=function(){return this.$d.toISOString()},G.toString=function(){return this.$d.toUTCString()},U}(),H=X.prototype;return D.prototype=H,[["$ms",o],["$s",i],["$m",c],["$H",u],["$W",d],["$M",m],["$y",_],["$D",v]].forEach(function(U){H[U[1]]=function(G){return this.$g(G,U[0],U[1])}}),D.extend=function(U,G){return U.$i||(U(G,X,D),U.$i=!0),D},D.locale=x,D.isDayjs=y,D.unix=function(U){return D(1e3*U)},D.en=C[A],D.Ls=C,D.p={},D})}(Po)),Po.exports}var rg=tg();const et=st(rg);var Eo={exports:{}},ng=Eo.exports,Pc;function sg(){return Pc||(Pc=1,function(t,r){(function(n,a){t.exports=a()})(ng,function(){var n="week",a="year";return function(s,o,i){var c=o.prototype;c.week=function(u){if(u===void 0&&(u=null),u!==null)return this.add(7*(u-this.week()),"day");var d=this.$locale().yearStart||1;if(this.month()===11&&this.date()>25){var p=i(this).startOf(a).add(1,a).date(d),m=i(this).endOf(n);if(p.isBefore(m))return 1}var f=i(this).startOf(a).date(d).startOf(n).subtract(1,"millisecond"),_=this.diff(f,n,!0);return _<0?i(this).startOf("week").week():Math.ceil(_)},c.weeks=function(u){return u===void 0&&(u=null),this.week(u)}}})}(Eo)),Eo.exports}var ag=sg();const og=st(ag);var Do={exports:{}},ig=Do.exports,Ec;function lg(){return Ec||(Ec=1,function(t,r){(function(n,a){t.exports=a()})(ig,function(){var n={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},a=/(\[[^[]*\])|([-_:/.,()\s]+)|(A|a|Q|YYYY|YY?|ww?|MM?M?M?|Do|DD?|hh?|HH?|mm?|ss?|S{1,3}|z|ZZ?)/g,s=/\d/,o=/\d\d/,i=/\d\d?/,c=/\d*[^-_:/,()\s\d]+/,u={},d=function(b){return(b=+b)+(b>68?1900:2e3)},p=function(b){return function(P){this[b]=+P}},m=[/[+-]\d\d:?(\d\d)?|Z/,function(b){(this.zone||(this.zone={})).offset=function(P){if(!P||P==="Z")return 0;var N=P.match(/([+-]|\d\d)/g),j=60*N[1]+(+N[2]||0);return j===0?0:N[0]==="+"?-j:j}(b)}],f=function(b){var P=u[b];return P&&(P.indexOf?P:P.s.concat(P.f))},_=function(b,P){var N,j=u.meridiem;if(j){for(var E=1;E<=24;E+=1)if(b.indexOf(j(E,0,P))>-1){N=E>12;break}}else N=b===(P?"pm":"PM");return N},v={A:[c,function(b){this.afternoon=_(b,!1)}],a:[c,function(b){this.afternoon=_(b,!0)}],Q:[s,function(b){this.month=3*(b-1)+1}],S:[s,function(b){this.milliseconds=100*+b}],SS:[o,function(b){this.milliseconds=10*+b}],SSS:[/\d{3}/,function(b){this.milliseconds=+b}],s:[i,p("seconds")],ss:[i,p("seconds")],m:[i,p("minutes")],mm:[i,p("minutes")],H:[i,p("hours")],h:[i,p("hours")],HH:[i,p("hours")],hh:[i,p("hours")],D:[i,p("day")],DD:[o,p("day")],Do:[c,function(b){var P=u.ordinal,N=b.match(/\d+/);if(this.day=N[0],P)for(var j=1;j<=31;j+=1)P(j).replace(/\[|\]/g,"")===b&&(this.day=j)}],w:[i,p("week")],ww:[o,p("week")],M:[i,p("month")],MM:[o,p("month")],MMM:[c,function(b){var P=f("months"),N=(f("monthsShort")||P.map(function(j){return j.slice(0,3)})).indexOf(b)+1;if(N<1)throw new Error;this.month=N%12||N}],MMMM:[c,function(b){var P=f("months").indexOf(b)+1;if(P<1)throw new Error;this.month=P%12||P}],Y:[/[+-]?\d+/,p("year")],YY:[o,function(b){this.year=d(b)}],YYYY:[/\d{4}/,p("year")],Z:m,ZZ:m};function w(b){var P,N;P=b,N=u&&u.formats;for(var j=(b=P.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(D,M,X){var H=X&&X.toUpperCase();return M||N[X]||n[X]||N[H].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(U,G,te){return G||te.slice(1)})})).match(a),E=j.length,A=0;A<E;A+=1){var C=j[A],L=v[C],y=L&&L[0],x=L&&L[1];j[A]=x?{regex:y,parser:x}:C.replace(/^\[|\]$/g,"")}return function(D){for(var M={},X=0,H=0;X<E;X+=1){var U=j[X];if(typeof U=="string")H+=U.length;else{var G=U.regex,te=U.parser,re=D.slice(H),S=G.exec(re)[0];te.call(M,S),D=D.replace(S,"")}}return function(g){var T=g.afternoon;if(T!==void 0){var q=g.hours;T?q<12&&(g.hours+=12):q===12&&(g.hours=0),delete g.afternoon}}(M),M}}return function(b,P,N){N.p.customParseFormat=!0,b&&b.parseTwoDigitYear&&(d=b.parseTwoDigitYear);var j=P.prototype,E=j.parse;j.parse=function(A){var C=A.date,L=A.utc,y=A.args;this.$u=L;var x=y[1];if(typeof x=="string"){var D=y[2]===!0,M=y[3]===!0,X=D||M,H=y[2];M&&(H=y[2]),u=this.$locale(),!D&&H&&(u=N.Ls[H]),this.$d=function(re,S,g,T){try{if(["x","X"].indexOf(S)>-1)return new Date((S==="X"?1e3:1)*re);var q=w(S)(re),ee=q.year,R=q.month,K=q.day,F=q.hours,xe=q.minutes,ve=q.seconds,de=q.milliseconds,me=q.zone,ge=q.week,pe=new Date,se=K||(ee||R?1:pe.getDate()),I=ee||pe.getFullYear(),W=0;ee&&!R||(W=R>0?R-1:pe.getMonth());var ce,Z=F||0,Ae=xe||0,Ce=ve||0,ze=de||0;return me?new Date(Date.UTC(I,W,se,Z,Ae,Ce,ze+60*me.offset*1e3)):g?new Date(Date.UTC(I,W,se,Z,Ae,Ce,ze)):(ce=new Date(I,W,se,Z,Ae,Ce,ze),ge&&(ce=T(ce).week(ge).toDate()),ce)}catch{return new Date("")}}(C,x,L,N),this.init(),H&&H!==!0&&(this.$L=this.locale(H).$L),X&&C!=this.format(x)&&(this.$d=new Date("")),u={}}else if(x instanceof Array)for(var U=x.length,G=1;G<=U;G+=1){y[1]=x[G-1];var te=N.apply(this,y);if(te.isValid()){this.$d=te.$d,this.$L=te.$L,this.init();break}G===U&&(this.$d=new Date(""))}else E.call(this,A)}}})}(Do)),Do.exports}var cg=lg();const dg=st(cg);var To={exports:{}},ug=To.exports,Dc;function pg(){return Dc||(Dc=1,function(t,r){(function(n,a){t.exports=a()})(ug,function(){var n={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"};return function(a,s,o){var i=s.prototype,c=i.format;o.en.formats=n,i.format=function(u){u===void 0&&(u="YYYY-MM-DDTHH:mm:ssZ");var d=this.$locale().formats,p=function(m,f){return m.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(_,v,w){var b=w&&w.toUpperCase();return v||f[w]||n[w]||f[b].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(P,N,j){return N||j.slice(1)})})}(u,d===void 0?{}:d);return c.call(this,p)}}})}(To)),To.exports}var hg=pg();const mg=st(hg);var Io={exports:{}},fg=Io.exports,Tc;function xg(){return Tc||(Tc=1,function(t,r){(function(n,a){t.exports=a()})(fg,function(){return function(n,a,s){a.prototype.isBetween=function(o,i,c,u){var d=s(o),p=s(i),m=(u=u||"()")[0]==="(",f=u[1]===")";return(m?this.isAfter(d,c):!this.isBefore(d,c))&&(f?this.isBefore(p,c):!this.isAfter(p,c))||(m?this.isBefore(d,c):!this.isAfter(d,c))&&(f?this.isAfter(p,c):!this.isBefore(p,c))}}})}(Io)),Io.exports}var gg=xg();const yg=st(gg);et.extend(dg);et.extend(mg);et.extend(yg);const vg=Sh(["Your locale has not been found.","Either the locale key is not a supported one. Locales supported by dayjs are available here: https://github.com/iamkun/dayjs/tree/dev/src/locale","Or you forget to import the locale from 'dayjs/locale/{localeUsed}'","fallback on English locale"]),bg={YY:"year",YYYY:{sectionType:"year",contentType:"digit",maxLength:4},M:{sectionType:"month",contentType:"digit",maxLength:2},MM:"month",MMM:{sectionType:"month",contentType:"letter"},MMMM:{sectionType:"month",contentType:"letter"},D:{sectionType:"day",contentType:"digit",maxLength:2},DD:"day",Do:{sectionType:"day",contentType:"digit-with-letter"},d:{sectionType:"weekDay",contentType:"digit",maxLength:2},dd:{sectionType:"weekDay",contentType:"letter"},ddd:{sectionType:"weekDay",contentType:"letter"},dddd:{sectionType:"weekDay",contentType:"letter"},A:"meridiem",a:"meridiem",H:{sectionType:"hours",contentType:"digit",maxLength:2},HH:"hours",h:{sectionType:"hours",contentType:"digit",maxLength:2},hh:"hours",m:{sectionType:"minutes",contentType:"digit",maxLength:2},mm:"minutes",s:{sectionType:"seconds",contentType:"digit",maxLength:2},ss:"seconds"},_g={year:"YYYY",month:"MMMM",monthShort:"MMM",dayOfMonth:"D",weekday:"dddd",weekdayShort:"dd",hours24h:"HH",hours12h:"hh",meridiem:"A",minutes:"mm",seconds:"ss",fullDate:"ll",fullDateWithWeekday:"dddd, LL",keyboardDate:"L",shortDate:"MMM D",normalDate:"D MMMM",normalDateWithWeekday:"ddd, MMM D",monthAndYear:"MMMM YYYY",monthAndDate:"MMMM D",fullTime:"LT",fullTime12h:"hh:mm A",fullTime24h:"HH:mm",fullDateTime:"lll",fullDateTime12h:"ll hh:mm A",fullDateTime24h:"ll HH:mm",keyboardDateTime:"L LT",keyboardDateTime12h:"L hh:mm A",keyboardDateTime24h:"L HH:mm"},Ni=["Missing UTC plugin","To be able to use UTC or timezones, you have to enable the `utc` plugin","Find more information on https://mui.com/x/react-date-pickers/timezone/#day-js-and-utc"].join(`
`),Ic=["Missing timezone plugin","To be able to use timezones, you have to enable both the `utc` and the `timezone` plugin","Find more information on https://mui.com/x/react-date-pickers/timezone/#day-js-and-timezone"].join(`
`),jg=(t,r)=>r?(...n)=>t(...n).locale(r):t;class os{constructor({locale:r,formats:n,instance:a}={}){var s;this.isMUIAdapter=!0,this.isTimezoneCompatible=!0,this.lib="dayjs",this.rawDayJsInstance=void 0,this.dayjs=void 0,this.locale=void 0,this.formats=void 0,this.escapedCharacters={start:"[",end:"]"},this.formatTokenMap=bg,this.setLocaleToValue=o=>{const i=this.getCurrentLocaleCode();return i===o.locale()?o:o.locale(i)},this.hasUTCPlugin=()=>typeof et.utc<"u",this.hasTimezonePlugin=()=>typeof et.tz<"u",this.isSame=(o,i,c)=>{const u=this.setTimezone(i,this.getTimezone(o));return o.format(c)===u.format(c)},this.cleanTimezone=o=>{switch(o){case"default":return;case"system":return et.tz.guess();default:return o}},this.createSystemDate=o=>{if(this.rawDayJsInstance)return this.rawDayJsInstance(o);if(this.hasUTCPlugin()&&this.hasTimezonePlugin()){const i=et.tz.guess();return i!=="UTC"?et.tz(o,i):et(o)}return et(o)},this.createUTCDate=o=>{if(!this.hasUTCPlugin())throw new Error(Ni);return et.utc(o)},this.createTZDate=(o,i)=>{if(!this.hasUTCPlugin())throw new Error(Ni);if(!this.hasTimezonePlugin())throw new Error(Ic);const c=o!==void 0&&!o.endsWith("Z");return et(o).tz(this.cleanTimezone(i),c)},this.getLocaleFormats=()=>{const o=et.Ls,i=this.locale||"en";let c=o[i];return c===void 0&&(vg(),c=o.en),c.formats},this.adjustOffset=o=>{if(!this.hasTimezonePlugin())return o;const i=this.getTimezone(o);if(i!=="UTC"){var c,u;const d=o.tz(this.cleanTimezone(i),!0);if(((c=d.$offset)!=null?c:0)===((u=o.$offset)!=null?u:0))return o;o.$offset=d.$offset}return o},this.date=o=>o===null?null:this.dayjs(o),this.dateWithTimezone=(o,i)=>{if(o===null)return null;let c;return i==="UTC"?c=this.createUTCDate(o):i==="system"||i==="default"&&!this.hasTimezonePlugin()?c=this.createSystemDate(o):c=this.createTZDate(o,i),this.locale===void 0?c:c.locale(this.locale)},this.getTimezone=o=>{if(this.hasTimezonePlugin()){var i;const c=(i=o.$x)==null?void 0:i.$timezone;if(c)return c}return this.hasUTCPlugin()&&o.isUTC()?"UTC":"system"},this.setTimezone=(o,i)=>{if(this.getTimezone(o)===i)return o;if(i==="UTC"){if(!this.hasUTCPlugin())throw new Error(Ni);return o.utc()}if(i==="system")return o.local();if(!this.hasTimezonePlugin()){if(i==="default")return o;throw new Error(Ic)}return et.tz(o,this.cleanTimezone(i))},this.toJsDate=o=>o.toDate(),this.parseISO=o=>this.dayjs(o),this.toISO=o=>o.toISOString(),this.parse=(o,i)=>o===""?null:this.dayjs(o,i,this.locale,!0),this.getCurrentLocaleCode=()=>this.locale||"en",this.is12HourCycleInCurrentLocale=()=>/A|a/.test(this.getLocaleFormats().LT||""),this.expandFormat=o=>{const i=this.getLocaleFormats(),c=u=>u.replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,(d,p,m)=>p||m.slice(1));return o.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,(u,d,p)=>{const m=p&&p.toUpperCase();return d||i[p]||c(i[m])})},this.getFormatHelperText=o=>this.expandFormat(o).replace(/a/gi,"(a|p)m").toLocaleLowerCase(),this.isNull=o=>o===null,this.isValid=o=>this.dayjs(o).isValid(),this.format=(o,i)=>this.formatByString(o,this.formats[i]),this.formatByString=(o,i)=>this.dayjs(o).format(i),this.formatNumber=o=>o,this.getDiff=(o,i,c)=>o.diff(i,c),this.isEqual=(o,i)=>o===null&&i===null?!0:this.dayjs(o).toDate().getTime()===this.dayjs(i).toDate().getTime(),this.isSameYear=(o,i)=>this.isSame(o,i,"YYYY"),this.isSameMonth=(o,i)=>this.isSame(o,i,"YYYY-MM"),this.isSameDay=(o,i)=>this.isSame(o,i,"YYYY-MM-DD"),this.isSameHour=(o,i)=>o.isSame(i,"hour"),this.isAfter=(o,i)=>o>i,this.isAfterYear=(o,i)=>this.hasUTCPlugin()?!this.isSameYear(o,i)&&o.utc()>i.utc():o.isAfter(i,"year"),this.isAfterDay=(o,i)=>this.hasUTCPlugin()?!this.isSameDay(o,i)&&o.utc()>i.utc():o.isAfter(i,"day"),this.isBefore=(o,i)=>o<i,this.isBeforeYear=(o,i)=>this.hasUTCPlugin()?!this.isSameYear(o,i)&&o.utc()<i.utc():o.isBefore(i,"year"),this.isBeforeDay=(o,i)=>this.hasUTCPlugin()?!this.isSameDay(o,i)&&o.utc()<i.utc():o.isBefore(i,"day"),this.isWithinRange=(o,[i,c])=>o>=i&&o<=c,this.startOfYear=o=>this.adjustOffset(o.startOf("year")),this.startOfMonth=o=>this.adjustOffset(o.startOf("month")),this.startOfWeek=o=>this.adjustOffset(o.startOf("week")),this.startOfDay=o=>this.adjustOffset(o.startOf("day")),this.endOfYear=o=>this.adjustOffset(o.endOf("year")),this.endOfMonth=o=>this.adjustOffset(o.endOf("month")),this.endOfWeek=o=>this.adjustOffset(o.endOf("week")),this.endOfDay=o=>this.adjustOffset(o.endOf("day")),this.addYears=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"year"):o.add(i,"year")),this.addMonths=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"month"):o.add(i,"month")),this.addWeeks=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"week"):o.add(i,"week")),this.addDays=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"day"):o.add(i,"day")),this.addHours=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"hour"):o.add(i,"hour")),this.addMinutes=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"minute"):o.add(i,"minute")),this.addSeconds=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"second"):o.add(i,"second")),this.getYear=o=>o.year(),this.getMonth=o=>o.month(),this.getDate=o=>o.date(),this.getHours=o=>o.hour(),this.getMinutes=o=>o.minute(),this.getSeconds=o=>o.second(),this.getMilliseconds=o=>o.millisecond(),this.setYear=(o,i)=>this.adjustOffset(o.set("year",i)),this.setMonth=(o,i)=>this.adjustOffset(o.set("month",i)),this.setDate=(o,i)=>this.adjustOffset(o.set("date",i)),this.setHours=(o,i)=>this.adjustOffset(o.set("hour",i)),this.setMinutes=(o,i)=>this.adjustOffset(o.set("minute",i)),this.setSeconds=(o,i)=>this.adjustOffset(o.set("second",i)),this.setMilliseconds=(o,i)=>this.adjustOffset(o.set("millisecond",i)),this.getDaysInMonth=o=>o.daysInMonth(),this.getNextMonth=o=>this.addMonths(o,1),this.getPreviousMonth=o=>this.addMonths(o,-1),this.getMonthArray=o=>{const c=[o.startOf("year")];for(;c.length<12;){const u=c[c.length-1];c.push(this.addMonths(u,1))}return c},this.mergeDateAndTime=(o,i)=>o.hour(i.hour()).minute(i.minute()).second(i.second()),this.getWeekdays=()=>{const o=this.dayjs().startOf("week");return[0,1,2,3,4,5,6].map(i=>this.formatByString(this.addDays(o,i),"dd"))},this.getWeekArray=o=>{const i=this.setLocaleToValue(o),c=i.startOf("month").startOf("week"),u=i.endOf("month").endOf("week");let d=0,p=c;const m=[];for(;p<u;){const f=Math.floor(d/7);m[f]=m[f]||[],m[f].push(p),p=this.addDays(p,1),d+=1}return m},this.getWeekNumber=o=>o.week(),this.getYearRange=(o,i)=>{const c=o.startOf("year"),u=i.endOf("year"),d=[];let p=c;for(;p<u;)d.push(p),p=this.addYears(p,1);return d},this.getMeridiemText=o=>o==="am"?"AM":"PM",this.rawDayJsInstance=a,this.dayjs=jg((s=this.rawDayJsInstance)!=null?s:et,r),this.locale=r,this.formats=Cu({},_g,n),et.extend(og)}}const wg=({onClick:t,isOpen:r,unreadCount:n=0})=>e.jsx(Ch,{"aria-label":"Workspace Copilot",onClick:t,sx:{position:"fixed",bottom:{xs:16,sm:24},right:{xs:16,sm:24},zIndex:1300,bgcolor:a=>a.palette.background.paper,color:a=>a.palette.primary.main,boxShadow:"0 18px 40px rgba(33, 150, 243, 0.25)",border:"1px solid",borderColor:a=>a.palette.divider,transition:"transform 0.2s ease, box-shadow 0.2s ease","&:hover":{transform:"translateY(-3px)",boxShadow:"0 22px 48px rgba(33, 150, 243, 0.32)",bgcolor:a=>a.palette.primary.main,color:"common.white"}},children:e.jsx(Pl,{color:"error",badgeContent:n,invisible:n===0,sx:{"& .MuiBadge-badge":{fontWeight:600}},children:e.jsx(ku,{})})});var Ks={},Li={};const Sg=cm(kh);var Oc;function _t(){return Oc||(Oc=1,function(t){"use client";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return r.createSvgIcon}});var r=Sg}(Li)),Li}var Ac;function Cg(){if(Ac)return Ks;Ac=1;var t=vt();Object.defineProperty(Ks,"__esModule",{value:!0}),Ks.default=void 0;var r=t(_t()),n=bt();return Ks.default=(0,r.default)((0,n.jsx)("path",{d:"M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2m0 4-8 5-8-5V6l8 5 8-5z"}),"Email"),Ks}var kg=Cg();const pi=st(kg);var Js={},Mc;function Pg(){if(Mc)return Js;Mc=1;var t=vt();Object.defineProperty(Js,"__esModule",{value:!0}),Js.default=void 0;var r=t(_t()),n=bt();return Js.default=(0,r.default)((0,n.jsx)("path",{d:"M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02z"}),"Phone"),Js}var Eg=Pg();const Dg=st(Eg);var Xs={},Rc;function Tg(){if(Rc)return Xs;Rc=1;var t=vt();Object.defineProperty(Xs,"__esModule",{value:!0}),Xs.default=void 0;var r=t(_t()),n=bt();return Xs.default=(0,r.default)([(0,n.jsx)("path",{d:"M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"},"0"),(0,n.jsx)("path",{d:"M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"},"1")],"Schedule"),Xs}var Ig=Tg();const kp=st(Ig);var Zs={},Nc;function Og(){if(Nc)return Zs;Nc=1;var t=vt();Object.defineProperty(Zs,"__esModule",{value:!0}),Zs.default=void 0;var r=t(_t()),n=bt();return Zs.default=(0,r.default)((0,n.jsx)("path",{d:"M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1m-2 14-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9z"}),"AssignmentTurnedIn"),Zs}var Ag=Og();const Pp=st(Ag);var ea={},Lc;function Mg(){if(Lc)return ea;Lc=1;var t=vt();Object.defineProperty(ea,"__esModule",{value:!0}),ea.default=void 0;var r=t(_t()),n=bt();return ea.default=(0,r.default)((0,n.jsx)("path",{d:"M9 18h12v-2H9zM3 6v2h18V6zm6 7h12v-2H9z"}),"Segment"),ea}var Rg=Mg();const Ng=st(Rg),Lg={initiated:"warning",ringing:"warning",connected:"success",completed:"success",hangup:"default",failed:"error"},qg=({artifacts:t})=>t.length?e.jsx(Pe,{spacing:2,children:t.map(r=>e.jsx(Me,{variant:"outlined",sx:{p:2.5,borderRadius:2,bgcolor:n=>n.palette.grey[50]},children:e.jsxs(Pe,{spacing:2,children:[e.jsxs(Pe,{direction:{xs:"column",sm:"row"},spacing:1.5,alignItems:{xs:"flex-start",sm:"center"},children:[e.jsxs(h,{variant:"subtitle1",sx:{fontWeight:700},children:["Vendor call #",r.sessionId]}),e.jsx(De,{size:"small",color:Lg[r.status?.toLowerCase()]??"default",label:r.status?.toUpperCase()||"UNKNOWN"}),r.purchaseNumber&&e.jsx(De,{size:"small",variant:"outlined",label:`PO ${r.purchaseNumber}`})]}),e.jsxs(O,{container:!0,spacing:2,children:[r.vendor?.name&&e.jsxs(O,{item:!0,xs:12,sm:6,md:4,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Vendor"}),e.jsx(h,{variant:"body1",fontWeight:600,children:r.vendor.name}),r.vendor.phone&&e.jsxs(Pe,{direction:"row",alignItems:"center",spacing:1,mt:.5,children:[e.jsx(Dg,{fontSize:"small",color:"action"}),e.jsx(h,{variant:"body2",children:r.vendor.phone})]})]}),r.capturedEmail&&e.jsxs(O,{item:!0,xs:12,sm:6,md:4,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Contact Email"}),e.jsxs(Pe,{direction:"row",alignItems:"center",spacing:1,mt:.5,children:[e.jsx(pi,{fontSize:"small",color:"action"}),e.jsx(h,{variant:"body2",children:r.capturedEmail})]})]}),r.pickupTime&&e.jsxs(O,{item:!0,xs:12,sm:6,md:4,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Pickup Window"}),e.jsxs(Pe,{direction:"row",alignItems:"center",spacing:1,mt:.5,children:[e.jsx(kp,{fontSize:"small",color:"action"}),e.jsx(h,{variant:"body2",children:r.pickupTime})]})]})]}),r.parts&&r.parts.length>0&&e.jsxs(k,{children:[e.jsx(h,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Confirmed Parts"}),e.jsx(kr,{dense:!0,children:r.parts.map((n,a)=>e.jsxs(Ar,{disablePadding:!0,children:[e.jsx(Pu,{sx:{minWidth:32},children:e.jsx(Ng,{fontSize:"small",color:"action"})}),e.jsx(hr,{primary:`${n.part_number}  ${n.quantity}`,secondary:n.notes||void 0})]},`${r.sessionId}-part-${a}`))})]}),r.summary&&e.jsxs(k,{children:[e.jsx(h,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Call Summary"}),e.jsx(h,{variant:"body2",sx:{whiteSpace:"pre-wrap"},children:r.summary})]}),r.nextSteps&&r.nextSteps.length>0&&e.jsxs(k,{children:[e.jsxs(Pe,{direction:"row",alignItems:"center",spacing:1,mb:1,children:[e.jsx(Pp,{fontSize:"small",color:"action"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Next Steps"})]}),e.jsx(kr,{dense:!0,children:r.nextSteps.map((n,a)=>e.jsx(Ar,{disablePadding:!0,children:e.jsx(hr,{primary:n})},`${r.sessionId}-step-${a}`))})]}),r.transcriptPreview&&e.jsxs(k,{children:[e.jsx(h,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Transcript Preview"}),e.jsx(h,{variant:"caption",sx:{whiteSpace:"pre-wrap",color:"text.secondary"},children:r.transcriptPreview})]})]})},r.sessionId))}):null,Ug=t=>{if(!t)return"";const r=et(t);return r.isValid()?r.format("MMM D, YYYY h:mm A"):""},Fg=({message:t})=>{const r=t.role==="user",n=Ug(t.timestamp||t.createdAt),a=i=>{if(!t.task)return null;const c=t.task.status.replace("_"," ").replace(/\b\w/g,u=>u.toUpperCase());return e.jsx(Me,{variant:"outlined",sx:{px:2.5,py:2,borderRadius:3,borderColor:"divider",backgroundColor:"background.paper"},children:e.jsxs(Pe,{spacing:1.5,children:[e.jsxs(Pe,{direction:"row",alignItems:"center",spacing:1.5,children:[e.jsx(Ph,{color:"primary",fontSize:"small"}),e.jsx(h,{variant:"subtitle1",sx:{fontWeight:600},children:i==="task_created"?"Task created":i==="task_updated"?"Task updated":"Task note"}),t.task.createdByAgent&&e.jsx(De,{label:"AI",color:"primary",size:"small"})]}),e.jsxs(k,{children:[e.jsx(h,{variant:"h6",children:t.task.title}),e.jsxs(Pe,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",useFlexGap:!0,children:[e.jsx(De,{label:c,size:"small"}),t.task.dueDate&&e.jsx(De,{label:`Due ${et(t.task.dueDate).format("MMM D")}`,size:"small",color:"warning",variant:"outlined"})]})]}),t.summary&&e.jsx(h,{variant:"body2",color:"text.secondary",children:t.summary}),t.link&&e.jsx(Q,{component:Ju,to:t.link,variant:"contained",size:"small",sx:{alignSelf:"flex-start",textTransform:"none",borderRadius:999},children:"View task"})]})})},s=()=>!t.chunks||t.chunks.length===0?null:e.jsxs(Me,{variant:"outlined",sx:{px:2,py:1.75,borderRadius:3,borderColor:"divider",backgroundColor:"background.paper"},children:[e.jsx(h,{variant:"subtitle2",sx:{fontWeight:600,mb:1},children:t.info||"Relevant documentation"}),e.jsx(Pe,{spacing:1.25,children:t.chunks.map((i,c)=>e.jsxs(k,{children:[e.jsx(h,{variant:"body2",sx:{fontWeight:600},children:i?.path||"Documentation"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:i?.chunk||""})]},c))})]}),o=()=>t.type==="task_created"||t.type==="task_updated"||t.type==="task_message"?a(t.type):t.type==="docs"?s():e.jsx(h,{variant:"body2",sx:{whiteSpace:"pre-wrap",lineHeight:1.7},children:t.content||t.summary});return e.jsxs(Pe,{direction:"row",justifyContent:r?"flex-end":"flex-start",sx:{width:"100%"},spacing:1.5,children:[!r&&e.jsx(Rn,{sx:{bgcolor:"primary.main",width:34,height:34,boxShadow:"0 10px 20px rgba(64, 132, 253, 0.25)"},children:e.jsx(El,{fontSize:"small"})}),e.jsxs(Me,{elevation:0,sx:{px:{xs:2.25,sm:2.75},py:{xs:1.5,sm:1.75},maxWidth:{xs:"82%",sm:"72%"},borderRadius:3,borderTopRightRadius:r?4:3,borderTopLeftRadius:r?3:4,background:i=>r?`linear-gradient(135deg, ${Dn(i.palette.primary.main,.95)} 0%, ${i.palette.primary.main} 100%)`:"rgba(255, 255, 255, 0.92)",color:r?"common.white":"text.primary",border:r?"none":"1px solid rgba(148, 163, 184, 0.25)",boxShadow:r?"0 18px 32px -24px rgba(64, 132, 253, 0.65)":"0 12px 28px -22px rgba(15, 23, 42, 0.35)",backdropFilter:r?void 0:"blur(18px)"},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1,gap:1.5},children:[e.jsx(h,{variant:"overline",sx:{fontWeight:700,letterSpacing:1,color:r?Dn("#ffffff",.8):"text.secondary"},children:r?"You":"Workspace Copilot"}),n&&e.jsx(h,{variant:"caption",sx:{color:r?Dn("#ffffff",.75):"text.disabled",whiteSpace:"nowrap"},children:n})]}),o(),!r&&t.callArtifacts?.length?e.jsxs(k,{sx:{mt:2},children:[e.jsx(fr,{sx:{mb:2,opacity:.4}}),e.jsx(qg,{artifacts:t.callArtifacts})]}):null]}),r&&e.jsx(Rn,{sx:{bgcolor:"secondary.main",width:34,height:34,boxShadow:"0 10px 20px rgba(244, 63, 94, 0.25)"},children:e.jsx(Dl,{fontSize:"small"})})]})},Ep=({onSendMessage:t,disabled:r=!1,placeholder:n="Type your message..."})=>{const[a,s]=l.useState(""),o=()=>{a.trim()&&!r&&(t(a.trim()),s(""))},i=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),o())};return e.jsx(Me,{elevation:0,sx:{px:{xs:2,sm:3},py:2.5,borderTop:"1px solid",borderColor:"divider",bgcolor:"transparent",backdropFilter:"blur(6px)"},children:e.jsxs(k,{sx:{display:"flex",alignItems:{xs:"stretch",sm:"center"},gap:1.5,bgcolor:"rgba(255, 255, 255, 0.92)",borderRadius:3,px:{xs:1.5,sm:2.5},py:{xs:1.25,sm:1.5},border:"1px solid rgba(148, 163, 184, 0.25)",boxShadow:"0 18px 36px -28px rgba(15, 23, 42, 0.4)"},children:[e.jsx(le,{fullWidth:!0,multiline:!0,maxRows:4,value:a,onChange:c=>s(c.target.value),onKeyDown:i,placeholder:n,disabled:r,variant:"standard",size:"medium",sx:{"& .MuiInputBase-root":{fontSize:15,lineHeight:1.7,"&::before, &::after":{display:"none"}},"& textarea":{padding:0}}}),e.jsx(Ht,{title:"Send message",children:e.jsx("span",{children:e.jsx(gt,{onClick:o,disabled:!a.trim()||r,sx:{bgcolor:"primary.main",color:"common.white",p:1.4,borderRadius:"18px",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:c=>`0 16px 32px -18px ${c.palette.primary.main}`,"&:hover":{bgcolor:"primary.dark",transform:"translateY(-1px)",boxShadow:c=>`0 20px 38px -20px ${c.palette.primary.dark}`},"&.Mui-disabled":{bgcolor:"grey.200",color:"grey.500",boxShadow:"none",transform:"none"}},children:e.jsx(Eh,{fontSize:"small"})})})})]})})},ro=t=>typeof t=="number"&&!isNaN(t),es=t=>typeof t=="string",Br=t=>typeof t=="function",Oo=t=>es(t)||Br(t)?t:null,hl=t=>l.isValidElement(t)||es(t)||Br(t)||ro(t);function Wg(t,r,n){n===void 0&&(n=300);const{scrollHeight:a,style:s}=t;requestAnimationFrame(()=>{s.minHeight="initial",s.height=a+"px",s.transition=`all ${n}ms`,requestAnimationFrame(()=>{s.height="0",s.padding="0",s.margin="0",setTimeout(r,n)})})}function hi(t){let{enter:r,exit:n,appendPosition:a=!1,collapse:s=!0,collapseDuration:o=300}=t;return function(i){let{children:c,position:u,preventExitTransition:d,done:p,nodeRef:m,isIn:f,playToast:_}=i;const v=a?`${r}--${u}`:r,w=a?`${n}--${u}`:n,b=l.useRef(0);return l.useLayoutEffect(()=>{const P=m.current,N=v.split(" "),j=E=>{E.target===m.current&&(_(),P.removeEventListener("animationend",j),P.removeEventListener("animationcancel",j),b.current===0&&E.type!=="animationcancel"&&P.classList.remove(...N))};P.classList.add(...N),P.addEventListener("animationend",j),P.addEventListener("animationcancel",j)},[]),l.useEffect(()=>{const P=m.current,N=()=>{P.removeEventListener("animationend",N),s?Wg(P,p,o):p()};f||(d?N():(b.current=1,P.className+=` ${w}`,P.addEventListener("animationend",N)))},[f]),Dt.createElement(Dt.Fragment,null,c)}}function qc(t,r){return t!=null?{content:t.content,containerId:t.props.containerId,id:t.props.toastId,theme:t.props.theme,type:t.props.type,data:t.props.data||{},isLoading:t.props.isLoading,icon:t.props.icon,status:r}:{}}const Pr=new Map;let no=[];const ml=new Set,$g=t=>ml.forEach(r=>r(t)),Dp=()=>Pr.size>0;function Tp(t,r){var n;if(r)return!((n=Pr.get(r))==null||!n.isToastActive(t));let a=!1;return Pr.forEach(s=>{s.isToastActive(t)&&(a=!0)}),a}function Ip(t,r){hl(t)&&(Dp()||no.push({content:t,options:r}),Pr.forEach(n=>{n.buildToast(t,r)}))}function Uc(t,r){Pr.forEach(n=>{r!=null&&r!=null&&r.containerId?r?.containerId===n.id&&n.toggle(t,r?.id):n.toggle(t,r?.id)})}function zg(t){const{subscribe:r,getSnapshot:n,setProps:a}=l.useRef(function(o){const i=o.containerId||1;return{subscribe(c){const u=function(p,m,f){let _=1,v=0,w=[],b=[],P=[],N=m;const j=new Map,E=new Set,A=()=>{P=Array.from(j.values()),E.forEach(y=>y())},C=y=>{b=y==null?[]:b.filter(x=>x!==y),A()},L=y=>{const{toastId:x,onOpen:D,updateId:M,children:X}=y.props,H=M==null;y.staleId&&j.delete(y.staleId),j.set(x,y),b=[...b,y.props.toastId].filter(U=>U!==y.staleId),A(),f(qc(y,H?"added":"updated")),H&&Br(D)&&D(l.isValidElement(X)&&X.props)};return{id:p,props:N,observe:y=>(E.add(y),()=>E.delete(y)),toggle:(y,x)=>{j.forEach(D=>{x!=null&&x!==D.props.toastId||Br(D.toggle)&&D.toggle(y)})},removeToast:C,toasts:j,clearQueue:()=>{v-=w.length,w=[]},buildToast:(y,x)=>{if((ee=>{let{containerId:R,toastId:K,updateId:F}=ee;const xe=R?R!==p:p!==1,ve=j.has(K)&&F==null;return xe||ve})(x))return;const{toastId:D,updateId:M,data:X,staleId:H,delay:U}=x,G=()=>{C(D)},te=M==null;te&&v++;const re={...N,style:N.toastStyle,key:_++,...Object.fromEntries(Object.entries(x).filter(ee=>{let[R,K]=ee;return K!=null})),toastId:D,updateId:M,data:X,closeToast:G,isIn:!1,className:Oo(x.className||N.toastClassName),bodyClassName:Oo(x.bodyClassName||N.bodyClassName),progressClassName:Oo(x.progressClassName||N.progressClassName),autoClose:!x.isLoading&&(S=x.autoClose,g=N.autoClose,S===!1||ro(S)&&S>0?S:g),deleteToast(){const ee=j.get(D),{onClose:R,children:K}=ee.props;Br(R)&&R(l.isValidElement(K)&&K.props),f(qc(ee,"removed")),j.delete(D),v--,v<0&&(v=0),w.length>0?L(w.shift()):A()}};var S,g;re.closeButton=N.closeButton,x.closeButton===!1||hl(x.closeButton)?re.closeButton=x.closeButton:x.closeButton===!0&&(re.closeButton=!hl(N.closeButton)||N.closeButton);let T=y;l.isValidElement(y)&&!es(y.type)?T=l.cloneElement(y,{closeToast:G,toastProps:re,data:X}):Br(y)&&(T=y({closeToast:G,toastProps:re,data:X}));const q={content:T,props:re,staleId:H};N.limit&&N.limit>0&&v>N.limit&&te?w.push(q):ro(U)?setTimeout(()=>{L(q)},U):L(q)},setProps(y){N=y},setToggle:(y,x)=>{j.get(y).toggle=x},isToastActive:y=>b.some(x=>x===y),getSnapshot:()=>P}}(i,o,$g);Pr.set(i,u);const d=u.observe(c);return no.forEach(p=>Ip(p.content,p.options)),no=[],()=>{d(),Pr.delete(i)}},setProps(c){var u;(u=Pr.get(i))==null||u.setProps(c)},getSnapshot(){var c;return(c=Pr.get(i))==null?void 0:c.getSnapshot()}}}(t)).current;a(t);const s=l.useSyncExternalStore(r,n,n);return{getToastToRender:function(o){if(!s)return[];const i=new Map;return t.newestOnTop&&s.reverse(),s.forEach(c=>{const{position:u}=c.props;i.has(u)||i.set(u,[]),i.get(u).push(c)}),Array.from(i,c=>o(c[0],c[1]))},isToastActive:Tp,count:s?.length}}function Bg(t){const[r,n]=l.useState(!1),[a,s]=l.useState(!1),o=l.useRef(null),i=l.useRef({start:0,delta:0,removalDistance:0,canCloseOnClick:!0,canDrag:!1,didMove:!1}).current,{autoClose:c,pauseOnHover:u,closeToast:d,onClick:p,closeOnClick:m}=t;var f,_;function v(){n(!0)}function w(){n(!1)}function b(j){const E=o.current;i.canDrag&&E&&(i.didMove=!0,r&&w(),i.delta=t.draggableDirection==="x"?j.clientX-i.start:j.clientY-i.start,i.start!==j.clientX&&(i.canCloseOnClick=!1),E.style.transform=`translate3d(${t.draggableDirection==="x"?`${i.delta}px, var(--y)`:`0, calc(${i.delta}px + var(--y))`},0)`,E.style.opacity=""+(1-Math.abs(i.delta/i.removalDistance)))}function P(){document.removeEventListener("pointermove",b),document.removeEventListener("pointerup",P);const j=o.current;if(i.canDrag&&i.didMove&&j){if(i.canDrag=!1,Math.abs(i.delta)>i.removalDistance)return s(!0),t.closeToast(),void t.collapseAll();j.style.transition="transform 0.2s, opacity 0.2s",j.style.removeProperty("transform"),j.style.removeProperty("opacity")}}(_=Pr.get((f={id:t.toastId,containerId:t.containerId,fn:n}).containerId||1))==null||_.setToggle(f.id,f.fn),l.useEffect(()=>{if(t.pauseOnFocusLoss)return document.hasFocus()||w(),window.addEventListener("focus",v),window.addEventListener("blur",w),()=>{window.removeEventListener("focus",v),window.removeEventListener("blur",w)}},[t.pauseOnFocusLoss]);const N={onPointerDown:function(j){if(t.draggable===!0||t.draggable===j.pointerType){i.didMove=!1,document.addEventListener("pointermove",b),document.addEventListener("pointerup",P);const E=o.current;i.canCloseOnClick=!0,i.canDrag=!0,E.style.transition="none",t.draggableDirection==="x"?(i.start=j.clientX,i.removalDistance=E.offsetWidth*(t.draggablePercent/100)):(i.start=j.clientY,i.removalDistance=E.offsetHeight*(t.draggablePercent===80?1.5*t.draggablePercent:t.draggablePercent)/100)}},onPointerUp:function(j){const{top:E,bottom:A,left:C,right:L}=o.current.getBoundingClientRect();j.nativeEvent.type!=="touchend"&&t.pauseOnHover&&j.clientX>=C&&j.clientX<=L&&j.clientY>=E&&j.clientY<=A?w():v()}};return c&&u&&(N.onMouseEnter=w,t.stacked||(N.onMouseLeave=v)),m&&(N.onClick=j=>{p&&p(j),i.canCloseOnClick&&d()}),{playToast:v,pauseToast:w,isRunning:r,preventExitTransition:a,toastRef:o,eventHandlers:N}}function Hg(t){let{delay:r,isRunning:n,closeToast:a,type:s="default",hide:o,className:i,style:c,controlledProgress:u,progress:d,rtl:p,isIn:m,theme:f}=t;const _=o||u&&d===0,v={...c,animationDuration:`${r}ms`,animationPlayState:n?"running":"paused"};u&&(v.transform=`scaleX(${d})`);const w=Tn("Toastify__progress-bar",u?"Toastify__progress-bar--controlled":"Toastify__progress-bar--animated",`Toastify__progress-bar-theme--${f}`,`Toastify__progress-bar--${s}`,{"Toastify__progress-bar--rtl":p}),b=Br(i)?i({rtl:p,type:s,defaultClassName:w}):Tn(w,i),P={[u&&d>=1?"onTransitionEnd":"onAnimationEnd"]:u&&d<1?null:()=>{m&&a()}};return Dt.createElement("div",{className:"Toastify__progress-bar--wrp","data-hidden":_},Dt.createElement("div",{className:`Toastify__progress-bar--bg Toastify__progress-bar-theme--${f} Toastify__progress-bar--${s}`}),Dt.createElement("div",{role:"progressbar","aria-hidden":_?"true":"false","aria-label":"notification timer",className:b,style:v,...P}))}let Yg=1;const Op=()=>""+Yg++;function Vg(t){return t&&(es(t.toastId)||ro(t.toastId))?t.toastId:Op()}function Ja(t,r){return Ip(t,r),r.toastId}function Yo(t,r){return{...r,type:r&&r.type||t,toastId:Vg(r)}}function fo(t){return(r,n)=>Ja(r,Yo(t,n))}function z(t,r){return Ja(t,Yo("default",r))}z.loading=(t,r)=>Ja(t,Yo("default",{isLoading:!0,autoClose:!1,closeOnClick:!1,closeButton:!1,draggable:!1,...r})),z.promise=function(t,r,n){let a,{pending:s,error:o,success:i}=r;s&&(a=es(s)?z.loading(s,n):z.loading(s.render,{...n,...s}));const c={isLoading:null,autoClose:null,closeOnClick:null,closeButton:null,draggable:null},u=(p,m,f)=>{if(m==null)return void z.dismiss(a);const _={type:p,...c,...n,data:f},v=es(m)?{render:m}:m;return a?z.update(a,{..._,...v}):z(v.render,{..._,...v}),f},d=Br(t)?t():t;return d.then(p=>u("success",i,p)).catch(p=>u("error",o,p)),d},z.success=fo("success"),z.info=fo("info"),z.error=fo("error"),z.warning=fo("warning"),z.warn=z.warning,z.dark=(t,r)=>Ja(t,Yo("default",{theme:"dark",...r})),z.dismiss=function(t){(function(r){var n;if(Dp()){if(r==null||es(n=r)||ro(n))Pr.forEach(a=>{a.removeToast(r)});else if(r&&("containerId"in r||"id"in r)){const a=Pr.get(r.containerId);a?a.removeToast(r.id):Pr.forEach(s=>{s.removeToast(r.id)})}}else no=no.filter(a=>r!=null&&a.options.toastId!==r)})(t)},z.clearWaitingQueue=function(t){t===void 0&&(t={}),Pr.forEach(r=>{!r.props.limit||t.containerId&&r.id!==t.containerId||r.clearQueue()})},z.isActive=Tp,z.update=function(t,r){r===void 0&&(r={});const n=((a,s)=>{var o;let{containerId:i}=s;return(o=Pr.get(i||1))==null?void 0:o.toasts.get(a)})(t,r);if(n){const{props:a,content:s}=n,o={delay:100,...a,...r,toastId:r.toastId||t,updateId:Op()};o.toastId!==t&&(o.staleId=t);const i=o.render||s;delete o.render,Ja(i,o)}},z.done=t=>{z.update(t,{progress:1})},z.onChange=function(t){return ml.add(t),()=>{ml.delete(t)}},z.play=t=>Uc(!0,t),z.pause=t=>Uc(!1,t);const Gg=typeof window<"u"?l.useLayoutEffect:l.useEffect,xo=t=>{let{theme:r,type:n,isLoading:a,...s}=t;return Dt.createElement("svg",{viewBox:"0 0 24 24",width:"100%",height:"100%",fill:r==="colored"?"currentColor":`var(--toastify-icon-color-${n})`,...s})},qi={info:function(t){return Dt.createElement(xo,{...t},Dt.createElement("path",{d:"M12 0a12 12 0 1012 12A12.013 12.013 0 0012 0zm.25 5a1.5 1.5 0 11-1.5 1.5 1.5 1.5 0 011.5-1.5zm2.25 13.5h-4a1 1 0 010-2h.75a.25.25 0 00.25-.25v-4.5a.25.25 0 00-.25-.25h-.75a1 1 0 010-2h1a2 2 0 012 2v4.75a.25.25 0 00.25.25h.75a1 1 0 110 2z"}))},warning:function(t){return Dt.createElement(xo,{...t},Dt.createElement("path",{d:"M23.32 17.191L15.438 2.184C14.728.833 13.416 0 11.996 0c-1.42 0-2.733.833-3.443 2.184L.533 17.448a4.744 4.744 0 000 4.368C1.243 23.167 2.555 24 3.975 24h16.05C22.22 24 24 22.044 24 19.632c0-.904-.251-1.746-.68-2.44zm-9.622 1.46c0 1.033-.724 1.823-1.698 1.823s-1.698-.79-1.698-1.822v-.043c0-1.028.724-1.822 1.698-1.822s1.698.79 1.698 1.822v.043zm.039-12.285l-.84 8.06c-.057.581-.408.943-.897.943-.49 0-.84-.367-.896-.942l-.84-8.065c-.057-.624.25-1.095.779-1.095h1.91c.528.005.84.476.784 1.1z"}))},success:function(t){return Dt.createElement(xo,{...t},Dt.createElement("path",{d:"M12 0a12 12 0 1012 12A12.014 12.014 0 0012 0zm6.927 8.2l-6.845 9.289a1.011 1.011 0 01-1.43.188l-4.888-3.908a1 1 0 111.25-1.562l4.076 3.261 6.227-8.451a1 1 0 111.61 1.183z"}))},error:function(t){return Dt.createElement(xo,{...t},Dt.createElement("path",{d:"M11.983 0a12.206 12.206 0 00-8.51 3.653A11.8 11.8 0 000 12.207 11.779 11.779 0 0011.8 24h.214A12.111 12.111 0 0024 11.791 11.766 11.766 0 0011.983 0zM10.5 16.542a1.476 1.476 0 011.449-1.53h.027a1.527 1.527 0 011.523 1.47 1.475 1.475 0 01-1.449 1.53h-.027a1.529 1.529 0 01-1.523-1.47zM11 12.5v-6a1 1 0 012 0v6a1 1 0 11-2 0z"}))},spinner:function(){return Dt.createElement("div",{className:"Toastify__spinner"})}},Qg=t=>{const{isRunning:r,preventExitTransition:n,toastRef:a,eventHandlers:s,playToast:o}=Bg(t),{closeButton:i,children:c,autoClose:u,onClick:d,type:p,hideProgressBar:m,closeToast:f,transition:_,position:v,className:w,style:b,bodyClassName:P,bodyStyle:N,progressClassName:j,progressStyle:E,updateId:A,role:C,progress:L,rtl:y,toastId:x,deleteToast:D,isIn:M,isLoading:X,closeOnClick:H,theme:U}=t,G=Tn("Toastify__toast",`Toastify__toast-theme--${U}`,`Toastify__toast--${p}`,{"Toastify__toast--rtl":y},{"Toastify__toast--close-on-click":H}),te=Br(w)?w({rtl:y,position:v,type:p,defaultClassName:G}):Tn(G,w),re=function(q){let{theme:ee,type:R,isLoading:K,icon:F}=q,xe=null;const ve={theme:ee,type:R};return F===!1||(Br(F)?xe=F({...ve,isLoading:K}):l.isValidElement(F)?xe=l.cloneElement(F,ve):K?xe=qi.spinner():(de=>de in qi)(R)&&(xe=qi[R](ve))),xe}(t),S=!!L||!u,g={closeToast:f,type:p,theme:U};let T=null;return i===!1||(T=Br(i)?i(g):l.isValidElement(i)?l.cloneElement(i,g):function(q){let{closeToast:ee,theme:R,ariaLabel:K="close"}=q;return Dt.createElement("button",{className:`Toastify__close-button Toastify__close-button--${R}`,type:"button",onClick:F=>{F.stopPropagation(),ee(F)},"aria-label":K},Dt.createElement("svg",{"aria-hidden":"true",viewBox:"0 0 14 16"},Dt.createElement("path",{fillRule:"evenodd",d:"M7.71 8.23l3.75 3.75-1.48 1.48-3.75-3.75-3.75 3.75L1 11.98l3.75-3.75L1 4.48 2.48 3l3.75 3.75L9.98 3l1.48 1.48-3.75 3.75z"})))}(g)),Dt.createElement(_,{isIn:M,done:D,position:v,preventExitTransition:n,nodeRef:a,playToast:o},Dt.createElement("div",{id:x,onClick:d,"data-in":M,className:te,...s,style:b,ref:a},Dt.createElement("div",{...M&&{role:C},className:Br(P)?P({type:p}):Tn("Toastify__toast-body",P),style:N},re!=null&&Dt.createElement("div",{className:Tn("Toastify__toast-icon",{"Toastify--animate-icon Toastify__zoom-enter":!X})},re),Dt.createElement("div",null,c)),T,Dt.createElement(Hg,{...A&&!S?{key:`pb-${A}`}:{},rtl:y,theme:U,delay:u,isRunning:r,isIn:M,closeToast:f,hide:m,type:p,style:E,className:j,controlledProgress:S,progress:L||0})))},mi=function(t,r){return r===void 0&&(r=!1),{enter:`Toastify--animate Toastify__${t}-enter`,exit:`Toastify--animate Toastify__${t}-exit`,appendPosition:r}},Kg=hi(mi("bounce",!0));hi(mi("slide",!0));hi(mi("zoom"));hi(mi("flip"));const Jg={position:"top-right",transition:Kg,autoClose:5e3,closeButton:!0,pauseOnHover:!0,pauseOnFocusLoss:!0,draggable:"touch",draggablePercent:80,draggableDirection:"x",role:"alert",theme:"light"};function Xg(t){let r={...Jg,...t};const n=t.stacked,[a,s]=l.useState(!0),o=l.useRef(null),{getToastToRender:i,isToastActive:c,count:u}=zg(r),{className:d,style:p,rtl:m,containerId:f}=r;function _(w){const b=Tn("Toastify__toast-container",`Toastify__toast-container--${w}`,{"Toastify__toast-container--rtl":m});return Br(d)?d({position:w,rtl:m,defaultClassName:b}):Tn(b,Oo(d))}function v(){n&&(s(!0),z.play())}return Gg(()=>{if(n){var w;const b=o.current.querySelectorAll('[data-in="true"]'),P=12,N=(w=r.position)==null?void 0:w.includes("top");let j=0,E=0;Array.from(b).reverse().forEach((A,C)=>{const L=A;L.classList.add("Toastify__toast--stacked"),C>0&&(L.dataset.collapsed=`${a}`),L.dataset.pos||(L.dataset.pos=N?"top":"bot");const y=j*(a?.2:1)+(a?0:P*C);L.style.setProperty("--y",`${N?y:-1*y}px`),L.style.setProperty("--g",`${P}`),L.style.setProperty("--s",""+(1-(a?E:0))),j+=L.offsetHeight,E+=.025})}},[a,u,n]),Dt.createElement("div",{ref:o,className:"Toastify",id:f,onMouseEnter:()=>{n&&(s(!1),z.pause())},onMouseLeave:v},i((w,b)=>{const P=b.length?{...p}:{...p,pointerEvents:"none"};return Dt.createElement("div",{className:_(w),style:P,key:`container-${w}`},b.map(N=>{let{content:j,props:E}=N;return Dt.createElement(Qg,{...E,stacked:n,collapseAll:v,isIn:c(E.toastId,E.containerId),style:E.style,key:`toast-${E.key}`},j)}))}))}const Fc=t=>{if(Array.isArray(t))return t.filter(r=>typeof r=="object"&&r!==null)},Zg=t=>{if(!Array.isArray(t))return;const r=t.map(n=>{if(!n||typeof n!="object")return null;const a=n.key??n.stage??n.subagent;return!a||typeof a!="string"?null:{key:a,resultKey:n.resultKey??n.result_key??null}}).filter(Boolean);return r.length>0?r:void 0},ey=(t,r)=>{if(!r||typeof r!="object")return null;const n=r.planStepId??r.plan_step_id??r.stepId;if(!n||typeof n!="string")return null;const a=r.sessionId??r.session_id??t,s=r.cursor??r.lastEventId??r.last_event_id??null,o=r.plannerContext&&typeof r.plannerContext=="object"?r.plannerContext:r.planner_context&&typeof r.planner_context=="object"?r.planner_context:void 0;return{sessionId:String(a??t),planStepId:n,cursor:s!=null?String(s):null,expectedSubagents:Zg(r.expectedSubagents??r.expected_subagents),plannerContext:o??null}},Ui={async createSession(){return(await B.post("/api/agent/v2/session")).data.sessionId},async fetchMessages(t){const r=await B.get(`/api/agent/v2/session/${t}/messages`);return(Array.isArray(r.data?.messages)?r.data.messages:[]).map(a=>({...a,callArtifacts:Fc(a.callArtifacts)}))},async sendMessage(t,r){const n=await B.post("/api/agent/v2/chat",{sessionId:t,message:r}),s=(Array.isArray(n.data?.events)?n.data.events:[]).map(i=>({...i,callArtifacts:Fc(i.callArtifacts)})),o=ey(t,n.data?.plan??n.data?.plannerStream);return{events:s,plan:o}}},Wc="agent_v2_session_id",ty=45e3,Ap=(t,r)=>{if(r&&r.length)return{content:t,artifacts:r};if(!t)return{content:t,artifacts:void 0};const n=t.match(/\{"type":"vendor_call_summary"[\s\S]*\}$/);if(!n)return{content:t,artifacts:void 0};try{const a=JSON.parse(n[0]);if(a&&a.type==="vendor_call_summary")return{content:t.replace(n[0],"").trim(),artifacts:[a]}}catch(a){console.warn("Failed to parse vendor call summary payload",a)}return{content:t,artifacts:void 0}},ry=t=>{const{content:r,artifacts:n}=Ap(t.type==="text"?t.content:void 0,t.callArtifacts);return{id:t.id,role:t.role,type:t.type||(t.role==="user"?"user_text":"text"),content:t.type==="text"?r??t.content:t.content,summary:t.summary,task:t.task,link:t.link,info:t.info,chunks:t.chunks,timestamp:t.timestamp,createdAt:t.createdAt,callArtifacts:n??t.callArtifacts}},Mp=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(!1),[s,o]=l.useState(!1),[i,c]=l.useState(0),[u,d]=l.useState(null),[p,m]=l.useState(()=>{const D=localStorage.getItem(Wc);if(!D)return null;const M=Number(D);return Number.isFinite(M)?M:null}),f=l.useRef(null),_=l.useRef(null),v=l.useRef(null),w=l.useCallback(async()=>{if(p)return p;const D=await Ui.createSession();return localStorage.setItem(Wc,String(D)),m(D),D},[p]),b=l.useCallback(D=>{const M=D.filter(U=>U.role==="assistant"),X=M.reduce((U,G)=>{const te=typeof G.id=="number"?G.id:Number(G.id);return Number.isFinite(te)&&(U==null||te>U)?te:U},null),H=f.current;if(X!=null){if(H!=null&&X>H&&!s){const U=M.filter(G=>{const te=typeof G.id=="number"?G.id:Number(G.id);return Number.isFinite(te)&&te>H});if(U.length>0){c(te=>te+U.length);const G=U.length===1?"Workspace Copilot posted an update":`Workspace Copilot posted ${U.length} updates`;z.info(G,{toastId:"chat-unread"})}}f.current=X}s&&c(0)},[s]),P=l.useCallback(async D=>{if(v.current)return v.current;const M=(async()=>{const X=await w();D?.showSpinner&&a(!0);try{const U=(await Ui.fetchMessages(X)).map(ry);r(U),b(U)}catch(H){console.error("Failed to load chat history",H),D?.showSpinner||z.error("Unable to load chat messages.")}finally{D?.showSpinner&&a(!1),v.current=null}})();return v.current=M,M},[b,w]);l.useEffect(()=>{w().catch(D=>{console.error("Failed to initialize agent session",D),z.error("Unable to start AI assistant session.")})},[w]),l.useEffect(()=>{p&&P({showSpinner:!0}).catch(D=>{console.error("Failed to load chat history",D)})},[P,p]),l.useEffect(()=>(_.current&&(clearInterval(_.current),_.current=null),(async()=>{try{await w()}catch(M){console.error("Failed to ensure chat session",M);return}_.current=setInterval(()=>{P().catch(M=>{console.error("Failed to poll chat messages",M)})},ty)})(),()=>{_.current&&(clearInterval(_.current),_.current=null)}),[w,P]);const N=l.useCallback(D=>{!D||D.length===0||r(M=>{const X=[...M,...D.map((H,U)=>{const G=H.type==="text"?H.content:void 0,{content:te,artifacts:re}=Ap(G,H.callArtifacts);return{id:`${Date.now()}-${U}`,role:"assistant",type:H.type,content:H.type==="text"?te??H.content:H.content,summary:H.summary,task:H.task,link:H.link,info:H.info,chunks:H.chunks,timestamp:H.timestamp??new Date().toISOString(),callArtifacts:re??H.callArtifacts}})];return b(X),X})},[b]),j=l.useCallback(async D=>{const M=D.trim();if(!M)return;const X=await w(),H={id:`${Date.now()}-user`,role:"user",type:"user_text",content:M,timestamp:new Date().toISOString()};r(U=>[...U,H]),a(!0);try{const{events:U,plan:G}=await Ui.sendMessage(X,M);N(U),d(G??null),await P()}catch(U){console.error("Error sending message:",U),z.error("Sorry, the Workspace Copilot encountered an error.")}finally{a(!1)}},[N,w,P]),E=l.useCallback(()=>{d(null)},[]),A=l.useCallback(()=>{r([]),c(0),E()},[E]),C=l.useCallback(()=>{o(D=>{const M=!D;return M&&(c(0),P().catch(()=>{})),M})},[P]),L=l.useCallback(()=>{o(!1)},[]),y=l.useCallback(async()=>{o(!0),c(0),await P()},[P]),x=l.useCallback(()=>{c(0)},[]);return{messages:t,isLoading:n,isOpen:s,unreadCount:i,sendMessage:j,clearMessages:A,toggleChat:C,closeChat:L,openChat:y,acknowledgeMessages:x,plannerStream:u,clearPlannerStream:E}};var ta={},$c;function ny(){if($c)return ta;$c=1;var t=vt();Object.defineProperty(ta,"__esModule",{value:!0}),ta.default=void 0;var r=t(_t()),n=bt();return ta.default=(0,r.default)((0,n.jsx)("path",{d:"M16.59 7.58 10 14.17l-3.59-3.58L5 12l5 5 8-8zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"}),"CheckCircleOutline"),ta}var sy=ny();const zc=st(sy);var ra={},Bc;function ay(){if(Bc)return ra;Bc=1;var t=vt();Object.defineProperty(ra,"__esModule",{value:!0}),ra.default=void 0;var r=t(_t()),n=bt();return ra.default=(0,r.default)((0,n.jsx)("path",{d:"M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"}),"ErrorOutline"),ra}var oy=ay();const Fi=st(oy);var na={},Hc;function iy(){if(Hc)return na;Hc=1;var t=vt();Object.defineProperty(na,"__esModule",{value:!0}),na.default=void 0;var r=t(_t()),n=bt();return na.default=(0,r.default)((0,n.jsx)("path",{d:"M6 2v6h.01L6 8.01 10 12l-4 4 .01.01H6V22h12v-5.99h-.01L18 16l-4-4 4-3.99-.01-.01H18V2zm10 14.5V20H8v-3.5l4-4zm-4-5-4-4V4h8v3.5z"}),"HourglassEmpty"),na}var ly=iy();const Wl=st(ly);var sa={},Yc;function cy(){if(Yc)return sa;Yc=1;var t=vt();Object.defineProperty(sa,"__esModule",{value:!0}),sa.default=void 0;var r=t(_t()),n=bt();return sa.default=(0,r.default)((0,n.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2M7 13.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5m5 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5m5 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5"}),"Pending"),sa}var dy=cy();const uy=st(dy);var aa={},Vc;function py(){if(Vc)return aa;Vc=1;var t=vt();Object.defineProperty(aa,"__esModule",{value:!0}),aa.default=void 0;var r=t(_t()),n=bt();return aa.default=(0,r.default)([(0,n.jsx)("path",{d:"M12 5.99 19.53 19H4.47zM12 2 1 21h22z"},"0"),(0,n.jsx)("path",{d:"M13 16h-2v2h2zm0-6h-2v5h2z"},"1")],"WarningAmber"),aa}var hy=py();const oa=st(hy);var ia={},Gc;function my(){if(Gc)return ia;Gc=1;var t=vt();Object.defineProperty(ia,"__esModule",{value:!0}),ia.default=void 0;var r=t(_t()),n=bt();return ia.default=(0,r.default)((0,n.jsx)("circle",{cx:"12",cy:"12",r:"8"}),"FiberManualRecord"),ia}var fy=my();const xy=st(fy);var la={},Qc;function gy(){if(Qc)return la;Qc=1;var t=vt();Object.defineProperty(la,"__esModule",{value:!0}),la.default=void 0;var r=t(_t()),n=bt();return la.default=(0,r.default)((0,n.jsx)("path",{d:"M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6m6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26"}),"Autorenew"),la}var yy=gy();const Wi=st(yy),Kc={pending:{icon:e.jsx(uy,{fontSize:"small"}),color:"default",label:"Pending"},in_progress:{icon:e.jsx(Wi,{fontSize:"small"}),color:"info",label:"In progress"},running:{icon:e.jsx(Wi,{fontSize:"small"}),color:"info",label:"In progress"},partial:{icon:e.jsx(oa,{fontSize:"small"}),color:"warning",label:"Partial"},partial_success:{icon:e.jsx(oa,{fontSize:"small"}),color:"warning",label:"Partial"},completed:{icon:e.jsx(zc,{fontSize:"small"}),color:"success",label:"Completed"},success:{icon:e.jsx(zc,{fontSize:"small"}),color:"success",label:"Completed"},timeout:{icon:e.jsx(Wl,{fontSize:"small"}),color:"warning",label:"Timed out"},error:{icon:e.jsx(Fi,{fontSize:"small"}),color:"error",label:"Error"},failed:{icon:e.jsx(Fi,{fontSize:"small"}),color:"error",label:"Error"},failure:{icon:e.jsx(Fi,{fontSize:"small"}),color:"error",label:"Error"},degraded:{icon:e.jsx(oa,{fontSize:"small"}),color:"warning",label:"Degraded"},cancelled:{icon:e.jsx(oa,{fontSize:"small"}),color:"warning",label:"Cancelled"},canceled:{icon:e.jsx(oa,{fontSize:"small"}),color:"warning",label:"Cancelled"},retry:{icon:e.jsx(Wi,{fontSize:"small"}),color:"warning",label:"Retrying"}},fl=t=>{const r=(t||"").trim().toLowerCase();return r&&Kc[r]?Kc[r]:{icon:e.jsx(xy,{fontSize:"small"}),color:"default",label:t||"Unknown"}},Rp=t=>t?t.replace(/[_-]+/g," ").replace(/\b\w/g,r=>r.toUpperCase()):"Subagent",vy=t=>{if(!t)return!1;const r=t.trim().toLowerCase();return["partial","partial_success","completed","success","error","failed","failure","degraded"].includes(r)},by={idle:{label:"Idle",color:"default"},connecting:{label:"Connecting",color:"info"},open:{label:"Live",color:"success"},reconnecting:{label:"Reconnecting",color:"warning"},closed:{label:"Closed",color:"default"},error:{label:"Error",color:"error"}},_y=t=>{if(!t)return null;const r=et(t);return r.isValid()?r.format("MMM D, YYYY h:mm:ss A"):null},go=(t,r)=>{if(r==="default")return{background:t.palette.grey[200],foreground:t.palette.grey[800]};const n=t.palette[r];return{background:n.light,foreground:n.main}},jy=({subagents:t,connectionState:r,stepStatus:n,plannerContext:a,completedPayload:s,replayComplete:o,lastHeartbeatAt:i,isTerminal:c})=>{const u=by[r],d=t.length>0,p=_y(i),m=n?fl(n):null;return e.jsx(Me,{variant:"outlined",sx:{borderRadius:3,borderColor:"divider",px:2.5,py:2,backgroundColor:"background.paper",mb:2},children:e.jsxs(Pe,{spacing:2,children:[e.jsxs(Pe,{direction:"row",alignItems:"center",justifyContent:"space-between",spacing:2,children:[e.jsxs(Pe,{spacing:.5,children:[e.jsx(h,{variant:"subtitle2",sx:{fontWeight:700},children:"Planner progress"}),a?.plan_summary&&e.jsx(h,{variant:"caption",color:"text.secondary",children:a.plan_summary})]}),e.jsxs(Pe,{direction:"row",spacing:1,alignItems:"center",children:[!o&&r!=="error"&&r!=="closed"?e.jsx(ot,{size:18,thickness:5}):null,e.jsx(De,{size:"small",variant:"outlined",color:u.color,label:u.label})]})]}),p&&e.jsxs(h,{variant:"caption",color:"text.secondary",children:["Last heartbeat: ",p]}),e.jsx(Pe,{spacing:1.25,children:d?t.map(f=>{const _=fl(f.status);return e.jsx(Me,{variant:"outlined",sx:{borderRadius:2,borderColor:"divider",px:1.5,py:1,backgroundColor:"background.default"},children:e.jsxs(Pe,{direction:"row",spacing:1.5,alignItems:"center",justifyContent:"space-between",children:[e.jsxs(Pe,{direction:"row",spacing:1.25,alignItems:"center",children:[e.jsx(k,{sx:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:28,height:28,borderRadius:"50%",backgroundColor:v=>go(v,_.color).background,color:v=>go(v,_.color).foreground},children:_.icon}),e.jsxs(k,{children:[e.jsx(h,{variant:"body2",sx:{fontWeight:600},children:Rp(f.key)}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:[_.label,f.resultKey?`  ${f.resultKey}`:""]})]})]}),f.payload&&Object.keys(f.payload).length>0?e.jsx(Ht,{title:e.jsx("pre",{style:{margin:0},children:JSON.stringify(f.payload,null,2)}),children:e.jsx(De,{size:"small",label:"Payload",variant:"outlined"})}):null]})},f.key)}):e.jsx(h,{variant:"body2",color:"text.secondary",children:"Waiting for planner updates"})}),m&&e.jsxs(Pe,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(k,{sx:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:28,height:28,borderRadius:"50%",backgroundColor:f=>go(f,m.color).background,color:f=>go(f,m.color).foreground},children:m.icon}),e.jsxs(h,{variant:"body2",sx:{fontWeight:600},children:["Step status: ",m.label]})]}),c&&s&&Object.keys(s).length>0&&e.jsxs(Me,{variant:"outlined",sx:{borderRadius:2,borderColor:"divider",backgroundColor:"background.default",px:1.5,py:1},children:[e.jsx(h,{variant:"caption",color:"text.secondary",sx:{fontWeight:600},children:"Final payload"}),e.jsx(h,{variant:"body2",sx:{mt:.5,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:s.summary??JSON.stringify(s,null,2)})]})]})})},Jc=(t,r)=>{if(r==="default")return{background:t.palette.grey[200],foreground:t.palette.grey[800]};const n=t.palette[r];return{background:n.light,foreground:n.main}},wy=({update:t,onAcknowledge:r,onDismiss:n,disabled:a=!1,actionState:s})=>{const o=fl(t.status),i=et(t.timestamp),c=i.isValid()?i.format("MMM D, YYYY h:mm A"):null,u=t.summary||t.message||t.payload?.summary,d=t.payload?.details||t.payload?.description||t.payload?.notes,p=!!s?.acknowledged,m=!!s?.dismissed,f=s?.pendingAction,_=s?.error,v=a||m||p||f==="dismiss"||f==="ack",w=a||m||p||f==="ack"||f==="dismiss",b=t.payload&&Object.keys(t.payload).length>0?e.jsx(Ht,{title:e.jsx("pre",{style:{margin:0,maxWidth:320,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:JSON.stringify(t.payload,null,2)}),placement:"top",arrow:!0,children:e.jsx(De,{size:"small",variant:"outlined",label:"Payload"})}):null;return e.jsx(Ji,{in:!0,timeout:300,children:e.jsx(Me,{variant:"outlined",sx:{borderRadius:3,borderColor:m?"error.light":"divider",backgroundColor:m?"error.lighter":"background.paper",px:2.5,py:2},children:e.jsxs(Pe,{spacing:1.5,children:[e.jsxs(Pe,{direction:"row",alignItems:"center",justifyContent:"space-between",spacing:1.5,children:[e.jsxs(Pe,{direction:"row",spacing:1.25,alignItems:"center",children:[e.jsx(k,{sx:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:32,height:32,borderRadius:"50%",backgroundColor:P=>Jc(P,o.color).background,color:P=>Jc(P,o.color).foreground},children:o.icon}),e.jsxs(Pe,{children:[e.jsx(h,{variant:"subtitle2",sx:{fontWeight:700},children:Rp(t.stageKey)}),e.jsxs(Pe,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(De,{size:"small",color:o.color,label:o.label,variant:"outlined"}),t.revision!=null&&e.jsx(De,{size:"small",label:`Revision ${t.revision}`,variant:"outlined"}),typeof t.retryCount=="number"&&t.retryCount>0&&e.jsx(De,{size:"small",color:"warning",label:`Retry ${t.retryCount}`,variant:"outlined"}),b]})]})]}),c&&e.jsx(h,{variant:"caption",color:"text.secondary",children:c})]}),u&&e.jsx(h,{variant:"body2",sx:{whiteSpace:"pre-wrap",lineHeight:1.6},children:u}),d&&e.jsx(h,{variant:"body2",color:"text.secondary",sx:{whiteSpace:"pre-wrap"},children:d}),e.jsxs(Pe,{direction:"row",spacing:1,children:[e.jsx(Q,{size:"small",variant:p?"contained":"outlined",color:"success",disabled:v,onClick:r,sx:{textTransform:"none",borderRadius:999,px:2},children:p?"Acknowledged":f==="ack"?"Acknowledging":"Acknowledge"}),e.jsx(Q,{size:"small",variant:m?"contained":"outlined",color:"error",disabled:w,onClick:n,sx:{textTransform:"none",borderRadius:999,px:2},children:m?"Dismissed":f==="dismiss"?"Dismissing":"Dismiss"})]}),_&&e.jsx(h,{variant:"caption",color:"error",children:_})]})})})},Sy=(t,r)=>{const n=t.content?.resultKey??t.content?.result_key??t.content?.result??t.content?.resultId??t.content?.result_id??r;return String(n??r)},Cy=t=>{const r=t.content?.revision??t.content?.rev;if(typeof r=="number"&&Number.isFinite(r))return r},ky=t=>{const r=t.content?.retry_count??t.content?.retryCount;if(typeof r=="number"&&r>=0)return r},Py=(t,r,n)=>`${t}::${r||"default"}::${n??"latest"}`,Ey=t=>{if(!Array.isArray(t)||t.length===0)return[];const r=new Map;for(const n of t){if(n.type!=="subagent_result"&&n.type!=="plan_step_completed")continue;const a=n.content?.stage??n.content?.subagent??n.content?.key??n.content?.agent,s=a?String(a):"planner",o=Sy(n,s),i=Cy(n),c=Py(n.planStepId,o,i),u=typeof n.content?.summary=="string"?n.content.summary:typeof n.content?.description=="string"?n.content.description:typeof n.content?.headline=="string"?n.content.headline:void 0,d=typeof n.content?.message=="string"?n.content.message:void 0,p=n.content?.payload&&typeof n.content.payload=="object"?n.content.payload:void 0,m=ky(n),f={id:c,planStepId:n.planStepId,stageKey:s,resultKey:o,revision:i,status:typeof n.content?.status=="string"?n.content.status:void 0,summary:u??(p?.summary&&typeof p.summary=="string"?p.summary:void 0),message:d,payload:p??null,telemetry:n.telemetry,timestamp:n.timestamp,sequence:n.sequence,retryCount:m},_=r.get(c);(!_||f.sequence>=_.sequence)&&r.set(c,f)}return Array.from(r.values()).sort((n,a)=>n.sequence-a.sequence)},Np=(t,r)=>{const n={};return t&&(typeof t.trace_id=="string"&&(n["x-trace-id"]=t.trace_id),typeof t.traceId=="string"&&(n["x-trace-id"]=t.traceId),typeof t.span_id=="string"&&(n["x-span-id"]=t.span_id),typeof t.spanId=="string"&&(n["x-span-id"]=t.spanId),typeof t.parent_span_id=="string"&&(n["x-parent-span-id"]=t.parent_span_id)),r!=null&&(n["x-sequence"]=String(r)),n},Lp=t=>({resultKey:t.resultKey,revision:t.revision??null}),Dy=async t=>{const{sessionId:r,planStepId:n}=t;await B.patch(`/api/planner/sessions/${encodeURIComponent(r)}/steps/${encodeURIComponent(n)}/ack`,Lp(t),{headers:Np(t.telemetry,t.sequence)})},Ty=async t=>{const{sessionId:r,planStepId:n}=t;await B.patch(`/api/planner/sessions/${encodeURIComponent(r)}/steps/${encodeURIComponent(n)}/dismiss`,Lp(t),{headers:Np(t.telemetry,t.sequence)})},Iy=async t=>{const{sessionId:r,planStepId:n,after:a,limit:s}=t,o={};return a!=null&&(o.after=String(a)),typeof s=="number"&&(o.limit=String(s)),(await B.get(`/api/planner/sessions/${encodeURIComponent(r)}/steps/${encodeURIComponent(n)}/events`,{params:o})).data},xl={acknowledge:Dy,dismiss:Ty,fetchReplay:Iy},Xc=({action:t,details:r={},level:n="info",error:a})=>{({...r,timestamp:new Date().toISOString()})},ca={action(t,r){Xc({action:t,details:r,level:"info"})},error(t,r,n){Xc({action:t,details:n,level:"error",error:r})}},Oy=({sessionId:t,planStepId:r,events:n})=>{const a=t!=null?String(t):void 0,s=r!=null?String(r):void 0,o=l.useMemo(()=>Ey(n),[n]),[i,c]=l.useState({});l.useEffect(()=>{c(d=>{const p={};for(const m of o)p[m.id]=d[m.id]??{pendingAction:null,acknowledged:!1,dismissed:!1,error:null};return p})},[o]);const u=l.useCallback(async(d,p)=>{if(c(f=>({...f,[d.id]:{...f[d.id],pendingAction:p,error:null}})),!a||!s){c(f=>({...f,[d.id]:{...f[d.id],pendingAction:null,error:"Planner session is unavailable. Please retry after the stream reconnects."}}));return}const m={sessionId:a,planStepId:s,resultKey:d.resultKey,revision:d.revision??null,sequence:d.sequence,status:d.status,stageKey:d.stageKey};try{p==="ack"?(ca.action("planner_ui.ack_start",m),await xl.acknowledge({sessionId:a,planStepId:s,resultKey:d.resultKey,revision:d.revision,telemetry:d.telemetry,sequence:d.sequence}),ca.action("planner_ui.ack_success",m)):(ca.action("planner_ui.dismiss_start",m),await xl.dismiss({sessionId:a,planStepId:s,resultKey:d.resultKey,revision:d.revision,telemetry:d.telemetry,sequence:d.sequence}),ca.action("planner_ui.dismiss_success",m)),c(f=>({...f,[d.id]:{...f[d.id],pendingAction:null,acknowledged:p==="ack"?!0:f[d.id]?.acknowledged,dismissed:p==="dismiss"?!0:f[d.id]?.dismissed,error:null}}))}catch(f){ca.error(p==="ack"?"planner_ui.ack_error":"planner_ui.dismiss_error",f,m),c(_=>({..._,[d.id]:{..._[d.id],pendingAction:null,error:p==="ack"?"Failed to acknowledge update. Please try again.":"Failed to dismiss update. Please try again."}}))}},[a,s]);return o.length===0?null:e.jsxs(Pe,{spacing:1.5,sx:{mb:2},children:[e.jsx(h,{variant:"subtitle2",sx:{fontWeight:700,color:"text.secondary",pl:.5},children:"Planner updates"}),o.map(d=>{const p=i[d.id],m=!a||!s,f=vy(d.status),_=m||!f;return e.jsx(wy,{update:d,disabled:_,onAcknowledge:()=>u(d,"ack"),onDismiss:()=>u(d,"dismiss"),actionState:p},d.id)})]})},Ay={events:[],subagentsByKey:{},subagentOrder:[],plannerContext:void 0,stepStatus:void 0,completedPayload:void 0,lastSequence:void 0},As=()=>new Date().toISOString(),My=t=>{if(!t||typeof t!="object")return null;const r=t.key??t.subagent??t.stage;return!r||typeof r!="string"?null:{key:r,resultKey:t.resultKey??t.result_key??null}},gl=t=>{if(t==null)return t===null?null:void 0;if(typeof t=="object")return t},yl=(t,r,n)=>{if(!r||r.length===0)return t;const a={},s=[],o=t.subagentsByKey;for(const i of r){if(!i?.key)continue;const c=String(i.key);s.push(c);const u=o[c];a[c]={key:c,status:u?.status??"pending",resultKey:i.resultKey??u?.resultKey??null,payload:u?.payload??null,revision:u?.revision,lastUpdated:u?.lastUpdated??n,telemetry:u?.telemetry}}for(const i of Object.keys(o))a[i]||(a[i]=o[i],s.push(i));return{...t,subagentsByKey:a,subagentOrder:s}},Ry=(t,r)=>{if(!r||r.length===0)return t;let n={...t},a=t.events.slice(),s=t.subagentOrder.slice(),o={...t.subagentsByKey},i=t.plannerContext,c=t.stepStatus,u=t.completedPayload,d=t.lastSequence;const p=m=>{s.includes(m)||s.push(m)};for(const m of r)if(Number.isFinite(m.sequence)&&!a.some(f=>f.sequence===m.sequence)){if(a.push(m),d=m.sequence,m.type==="step_started"){const f=m.content?.expected_subagents??m.content?.expectedSubagents??[],_=Array.isArray(f)?f.map(My).filter(Boolean):[],v=gl(m.content?.planner_context??m.content?.plannerContext);if(v!==void 0&&(i=v),c=typeof m.content?.status=="string"?m.content.status:c,_.length>0){const w=yl({...n,events:a,subagentOrder:s,subagentsByKey:o},_,m.timestamp||As());o=w.subagentsByKey,s=w.subagentOrder}continue}if(m.type==="subagent_result"){const f=m.content?.stage??m.content?.subagent??m.content?.key;if(f){const v=String(f);p(v);const w=o[v],b=m.content?.payload,P=m.content?.resultKey??m.content?.result_key??w?.resultKey??null;o={...o,[v]:{key:v,status:typeof m.content?.status=="string"?m.content.status:w?.status??"pending",resultKey:P,payload:b&&typeof b=="object"?b:w?.payload??null,revision:typeof m.content?.revision=="number"?m.content.revision:w?.revision,lastUpdated:m.timestamp||As(),telemetry:Object.keys(m.telemetry||{}).length?m.telemetry:w?.telemetry}}}const _=m.content?.overall_status??m.content?.status;typeof _=="string"&&(c=_);continue}if(m.type==="plan_step_completed"){typeof m.content?.status=="string"&&(c=m.content.status);const f=m.content?.payload;f&&typeof f=="object"&&(u=f);continue}typeof m.content?.status=="string"&&(c=m.content.status)}return a.sort((m,f)=>m.sequence-f.sequence),n={events:a,subagentsByKey:o,subagentOrder:s,plannerContext:i,stepStatus:c,completedPayload:u,lastSequence:d},n},Ny=(t,r)=>{switch(r.type){case"reset":{const n=gl(r.plannerContext),a={events:[],subagentsByKey:{},subagentOrder:[],plannerContext:n,stepStatus:void 0,completedPayload:void 0,lastSequence:void 0};return r.expected&&r.expected.length>0?yl(a,r.expected,As()):a}case"hydrateExpected":{const n=gl(r.plannerContext),a=yl(t,r.expected,As());return n!==void 0?{...a,plannerContext:n}:a}case"append":return Ry(t,r.events);default:return t}},Ly=(t,r)=>{const a=(B.defaults.baseURL??"").replace(/\/$/,""),s=`/api/planner/sessions/${encodeURIComponent(t)}/stream?planStepId=${encodeURIComponent(r)}`;return a?`${a}${s}`:s},Zc=t=>{if(!t)return null;const r=t.split(/\r?\n/),n={},a=[];for(const s of r)if(s.trim()){if(s.startsWith("id:")){n.id=s.slice(3).trim();continue}if(s.startsWith("event:")){n.event=s.slice(6).trim();continue}if(s.startsWith("data:")){a.push(s.slice(5).trimStart());continue}}if(a.length>0){const s=a.join(`
`);if(s)try{n.data=JSON.parse(s)}catch{n.data=s}}return!n.id&&!n.event&&a.length===0?null:n},ed=t=>{if(!t||typeof t!="object")return null;const r=Number(t.sequence??t.seq??t.id);if(!Number.isFinite(r))return null;const n=String(t.session_id??t.sessionId??""),a=String(t.plan_step_id??t.planStepId??"");if(!a)return null;const s=typeof t.timestamp=="string"?t.timestamp:As(),o=t.content&&typeof t.content=="object"?t.content:{},i=t.telemetry&&typeof t.telemetry=="object"?t.telemetry:{};return{sessionId:n,planStepId:a,sequence:r,type:String(t.type??""),timestamp:s,content:o,telemetry:i}},td=t=>{if(!t)return!1;const r=t.trim().toLowerCase();return["success","completed","complete","error","failed","failure","cancelled","timeout","partial_failure","degraded"].includes(r)},qy=t=>{const{sessionId:r,planStepId:n,enabled:a=!0,initialCursor:s,expectedSubagents:o,plannerContext:i,stopOnCompletion:c=!0,onStepCompleted:u}=t,d=r!=null?String(r):void 0,p=n!=null?String(n):void 0,[m,f]=l.useReducer(Ny,Ay),[_,v]=l.useState("idle"),[w,b]=l.useState(null),[P,N]=l.useState(!1),[j,E]=l.useState(null),A=l.useRef(s!=null?String(s):null),C=l.useRef(null),L=l.useRef(null),y=l.useRef(!1),x=l.useRef(0),D=l.useRef(!1),M=l.useRef(!1),X=l.useCallback(()=>{f({type:"reset",expected:o,plannerContext:i}),A.current=s!=null?String(s):null,N(!1),E(null),D.current=!1,M.current=!1},[o,i,s]);l.useEffect(()=>{X()},[X,d,p]),l.useEffect(()=>{(o||i!==void 0)&&f({type:"hydrateExpected",expected:o,plannerContext:i})},[o,i]),l.useEffect(()=>{M.current=P},[P]);const H=()=>{L.current&&(clearTimeout(L.current),L.current=null)},U=l.useCallback(()=>{y.current=!1,H(),C.current?.abort(),C.current=null,v(q=>q==="idle"?q:"closed")},[]);l.useEffect(()=>()=>{y.current=!1,H(),C.current?.abort()},[]);const G=l.useCallback(()=>{if(!y.current)return;const q=x.current,ee=Math.min(1e3*Math.pow(2,q),15e3);x.current=q+1,H(),L.current=setTimeout(()=>{L.current=null,S(!0)},ee)},[]),te=l.useCallback((q,ee)=>{if(!D.current&&(D.current=!0,c&&U(),u))try{u(q,ee??null)}catch{}},[u,U,c]),re=l.useCallback(q=>{if(!q)return;if(q.id&&(A.current=q.id),q.event==="heartbeat"){E(As()),P||N(!0);return}if(q.event==="error"){const R=typeof q.data=="string"?q.data:q.data?.message;b(R||"Planner stream reported an error"),v("error");return}if(q.event!=="planner_stream")return;const ee=q.data;if(!(!ee||typeof ee!="object")&&ee.type==="event_batch"){const R=Array.isArray(ee.events)?ee.events.map(ed).filter(Boolean):[];R.length>0&&(f({type:"append",events:R}),P||N(!0))}},[P]),S=l.useCallback(async(q=!1)=>{if(!d||!p||!a)return;C.current&&(C.current.abort(),C.current=null),H(),y.current=!0,x.current=q?x.current:0,v(q?"reconnecting":"connecting"),b(null);const ee=new AbortController;C.current=ee;const R=Ly(d,p),K={Accept:"text/event-stream"},F=localStorage.getItem("sessionToken");F&&(K.Authorization=`Bearer ${F}`);const xe=localStorage.getItem("deviceId");xe&&(K["x-device-id"]=xe);try{const ve=Intl.DateTimeFormat().resolvedOptions().timeZone;ve&&(K["x-timezone"]=ve)}catch{}A.current&&(K["Last-Event-ID"]=A.current);try{if(!M.current)try{const pe=await xl.fetchReplay({sessionId:d,planStepId:p,after:A.current,limit:200}),se=Array.isArray(pe?.events)?pe.events.map(ed).filter(Boolean):[];pe?.next_cursor&&(A.current=String(pe.next_cursor)),se.length>0&&f({type:"append",events:se}),N(!0),M.current=!0}catch{}const ve=await fetch(R,{method:"GET",headers:K,credentials:"include",signal:ee.signal});if(!ve.ok)throw new Error(`Planner stream failed with status ${ve.status}`);const de=ve.body?.getReader();if(!de)throw new Error("Planner stream response is missing a readable body");v("open"),x.current=0;const me=new TextDecoder("utf-8");let ge="";for(;y.current;){const{value:pe,done:se}=await de.read();if(se)break;ge+=me.decode(pe,{stream:!0});let I=ge.indexOf(`

`);for(;I!==-1;){const W=ge.slice(0,I);ge=ge.slice(I+2);const ce=Zc(W);ce&&re(ce),I=ge.indexOf(`

`)}}if(ge.trim()){const pe=Zc(ge.trim());pe&&re(pe)}v("closed")}catch(ve){if(ee.signal.aborted)return;const de=ve instanceof Error?ve.message:"Unknown planner stream error";b(de),v("error")}finally{C.current=null,y.current&&G()}},[d,p,a,re,G]);l.useEffect(()=>{if(!d||!p||!a){U();return}return S(!1),()=>{U()}},[d,p,a,S,U]),l.useEffect(()=>{td(m.stepStatus)&&te(m.stepStatus,m.completedPayload??null)},[m.stepStatus,m.completedPayload,te]);const g=l.useCallback(()=>{!d||!p||(U(),S(!1))},[S,U,d,p]),T=l.useMemo(()=>m.subagentOrder.map(q=>m.subagentsByKey[q]).filter(Boolean),[m.subagentOrder,m.subagentsByKey]);return{connectionState:_,error:w,events:m.events,subagents:T,subagentsByKey:m.subagentsByKey,stepStatus:m.stepStatus,plannerContext:m.plannerContext??null,completedPayload:m.completedPayload??null,replayComplete:P,lastHeartbeatAt:j,lastEventId:A.current,isTerminal:td(m.stepStatus),stop:U,restart:g}},Uy=t=>typeof t=="string"?t.trim().toLowerCase():typeof t=="boolean"?t?"true":"false":t==null?"":String(t).trim().toLowerCase(),Fy=new Set(["1","true","yes","on"]),Wy=()=>{const t=window?.__AI_ENABLE_AGGREGATOR_STREAMING,r=Uy(t);return Fy.has(r)},$y=({variant:t="drawer",onClose:r,sx:n})=>{const{messages:a,isLoading:s,sendMessage:o,clearMessages:i,acknowledgeMessages:c,plannerStream:u}=Mp(),d=l.useRef(null),p=t==="embedded",m=Wy(),f=qy({sessionId:u?.sessionId,planStepId:u?.planStepId,initialCursor:u?.cursor??null,expectedSubagents:u?.expectedSubagents,plannerContext:u?.plannerContext??null,enabled:m&&!!u?.planStepId}),_=m&&!!u?.planStepId;l.useEffect(()=>{d.current?.scrollIntoView({behavior:"smooth"})},[a]),l.useEffect(()=>{p&&c()},[c,p,a.length]);const v=()=>{window.confirm("Are you sure you want to clear all messages?")&&i()},w=()=>{d.current?.scrollIntoView({behavior:"smooth"})},b={width:"100%",display:"flex",flexDirection:"column",borderRadius:p?3:0,overflow:"hidden",bgcolor:"background.paper",boxShadow:p?"0 12px 32px rgba(15, 23, 42, 0.16)":"none",border:"1px solid",borderColor:p?"divider":"transparent",minHeight:p?{xs:320,md:380}:"auto",maxHeight:p?{xs:"60vh",md:520}:"none"},P={px:{xs:2.5,sm:3},py:2.25,display:"flex",alignItems:{xs:"flex-start",sm:"center"},flexDirection:{xs:"column",sm:"row"},gap:{xs:2,sm:3},justifyContent:"space-between",borderBottom:"1px solid",borderColor:"divider",backgroundColor:E=>p?E.palette.background.paper:E.palette.background.default},N={flex:1,overflow:"auto",px:{xs:2.25,sm:3},py:2.5,display:"flex",flexDirection:"column",gap:2,backgroundColor:E=>E.palette.background.default},j=p?Me:k;return e.jsxs(j,{sx:{...b,...n},children:[e.jsxs(k,{sx:P,children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2.5},children:[e.jsx(Rn,{sx:{bgcolor:"primary.main",color:"common.white",width:48,height:48,boxShadow:"0 10px 24px rgba(33, 150, 243, 0.28)"},children:e.jsx(El,{fontSize:"small"})}),e.jsxs(k,{children:[e.jsx(h,{variant:"h6",sx:{fontWeight:700},children:"Workspace Copilot"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Ask about anything in your workspace for instant help."})]})]}),e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1.25},children:[e.jsx(Ht,{title:"Jump to latest",children:e.jsx(gt,{onClick:w,size:"small",sx:{bgcolor:"background.paper",border:"1px solid",borderColor:"divider","&:hover":{bgcolor:"grey.50"}},children:e.jsx(Dh,{fontSize:"small"})})}),e.jsx(Ht,{title:"Clear conversation",children:e.jsx(Q,{variant:"outlined",size:"small",onClick:v,sx:{textTransform:"none",fontWeight:600,px:1.75,borderRadius:999,borderColor:"divider"},children:"Clear"})}),r&&e.jsx(Ht,{title:"Close",children:e.jsx(gt,{onClick:r,size:"small",sx:{bgcolor:"background.paper",border:"1px solid",borderColor:"divider","&:hover":{bgcolor:"grey.50"}},children:e.jsx(Th,{fontSize:"small"})})})]})]}),e.jsxs(k,{sx:N,children:[_&&e.jsx(jy,{subagents:f.subagents,connectionState:f.connectionState,stepStatus:f.stepStatus,plannerContext:f.plannerContext,completedPayload:f.completedPayload,replayComplete:f.replayComplete,lastHeartbeatAt:f.lastHeartbeatAt,isTerminal:f.isTerminal}),_&&e.jsx(Oy,{sessionId:u?.sessionId,planStepId:u?.planStepId,events:f.events}),a.length===0?e.jsxs(k,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",textAlign:"center",color:"text.secondary",gap:1.5,borderRadius:3,border:"1px dashed",borderColor:"divider",mx:"auto",p:4,maxWidth:320,bgcolor:"background.paper"},children:[e.jsx(h,{variant:"h6",sx:{fontWeight:600},children:"Start a fresh conversation"}),e.jsx(h,{variant:"body2",sx:{color:"text.secondary"},children:"Ask about inventory, customers, orders, or time tracking."})]}):e.jsxs(e.Fragment,{children:[a.map(E=>e.jsx(Fg,{message:E},E.id)),s&&e.jsx(k,{sx:{display:"flex",justifyContent:"flex-start",mb:1},children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1.5,px:2,py:1.25,bgcolor:"background.paper",borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsx(ot,{size:16,thickness:5}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Crafting a response"})]})}),e.jsx("div",{ref:d})]})]}),e.jsx(fr,{}),e.jsx(Ep,{onSendMessage:o,disabled:s,placeholder:"Ask me anything about your business..."})]})},zy=({isOpen:t,onClose:r})=>e.jsx(Xi,{anchor:"right",open:t,onClose:r,sx:{"& .MuiDrawer-paper":{width:{xs:"100%",sm:400,md:460},maxWidth:"100vw",height:"100%",display:"flex",flexDirection:"column",borderLeft:{sm:"1px solid",xs:"none"},borderColor:"divider",bgcolor:"background.default"}},children:e.jsx($y,{onClose:r})}),Ka=async()=>{try{const t=await window?.api?.timeEvents?.pendingCount?.();return t?.success?t.count:0}catch{return 0}},By=async(t=200)=>{const r=await window?.api?.timeEvents?.listPending?.(t);return r?.success?r.rows:[]},rd=async()=>{const t=await By(200);let r=0,n=0;const a=[];for(const s of t)try{const o=JSON.parse(s.payload_json||"{}");switch(s.type){case"attendance_clock_in":await B.post("/api/attendance/clock-in",{profile_id:o.profile_id});break;case"attendance_clock_out":await B.post("/api/attendance/clock-out",{shift_id:o.shift_id});break;case"attendance_update":await B.put(`/api/attendance/${o.shift_id}`,{clock_in:o.clock_in,clock_out:o.clock_out});break;case"time_clock_in":await B.post("/api/time-tracking/time-entries/clock-in",{profile_id:o.profile_id,so_id:o.so_id});break;case"time_clock_out":await B.post(`/api/time-tracking/time-entries/${o.id}/clock-out`);break;default:n++;continue}a.push(s.event_id),r++}catch{n++}return a.length&&await window?.api?.timeEvents?.markSynced?.(a),{synced:r,failed:n}},vs=240,Hy=()=>{const[t,r]=Dt.useState(!1),n=Gt(),a=un(),{logout:s,user:o}=er(),{isOpen:i,toggleChat:c,closeChat:u,unreadCount:d}=Mp(),{unreadConversationCount:p}=Cp(),[m,f]=l.useState(0);l.useEffect(()=>{let A=!0;const C=async()=>{try{const y=await Ka();A&&f(y)}catch{}},L=setInterval(C,15e3);return C(),()=>{A=!1,clearInterval(L)}},[]);const _=()=>{r(!t)},v=()=>{s(),n("/login")},w=A=>"type"in A&&A.type==="header",b=l.useMemo(()=>({text:"Messages",icon:e.jsx(ku,{}),path:"/messaging",showUnreadDot:p>0}),[p]),P=A=>A,N=l.useMemo(()=>[{type:"header",text:"Dashboard"},{text:"Dashboard",icon:e.jsx(Zi,{}),path:"/dashboard"},{text:"Tasks",icon:e.jsx(Ql,{}),path:"/tasks"},b,{type:"header",text:"Purchasing"},{text:"Purchase Orders",icon:e.jsx(Ps,{}),path:"/open-purchase-orders"},{text:"Return Orders",icon:e.jsx(Uo,{}),path:"/return-orders"},{text:"Parts to Order",icon:e.jsx($r,{}),path:"/parts-to-order"},{text:"Vendors",icon:e.jsx(Eu,{}),path:"/vendors"},{type:"header",text:"Sales"},{text:"Quotes",icon:e.jsx(el,{}),path:"/quotes"},{text:"Sales Orders",icon:e.jsx(Es,{}),path:"/open-sales-orders"},{text:"Customers",icon:e.jsx(Xa,{}),path:"/customers"},{type:"header",text:"Products & Inventory"},{text:"Products",icon:e.jsx(Du,{}),path:"/products"},{text:"Stock",icon:e.jsx($r,{}),path:"/inventory"},{text:"Supply",icon:e.jsx($r,{}),path:"/supply"},{type:"header",text:"Time Tracking"},{text:"Attendance",icon:e.jsx(Jn,{}),path:"/attendance"},{text:"Time Tracking",icon:e.jsx(Jn,{}),path:"/time-tracking"},{text:"Time Tracking Reports",icon:e.jsx(Tu,{}),path:"/time-tracking/reports"},{type:"header",text:"Human Resources"},{text:"Employees",icon:e.jsx(Iu,{}),path:"/employees"},{text:"Profile Documents",icon:e.jsx(Ih,{}),path:"/profile-documents"},{text:"Leave Management",icon:e.jsx(Ou,{}),path:"/leave-management"},{text:"Mobile User Access",icon:e.jsx(Xa,{}),path:"/mobile-user-access"},{type:"header",text:"Settings"},{text:"Business Profile",icon:e.jsx(Tl,{}),path:"/business-profile"},{text:"Accounting",icon:e.jsx(Fo,{}),path:"/qbo-account-mapping"},{text:"Global Variables",icon:e.jsx(Fo,{}),path:"/margin-schedule"},{text:"Email Settings",icon:e.jsx(Wo,{}),path:"/email-settings"},{text:"Backup Management",icon:e.jsx(Il,{}),path:"/backup-management"}],[b]),j=Dt.useMemo(()=>{if(o?.access_role==="Time Tracking")return[{type:"header",text:"Dashboard"},{text:"Attendance",icon:e.jsx(Jn,{}),path:"/attendance"},{text:"Time Tracking",icon:e.jsx(Jn,{}),path:"/time-tracking"},b,{type:"header",text:"Sales"},{text:"Sales Orders",icon:e.jsx(Es,{}),path:"/open-sales-orders"}];const A=[{type:"header",text:"Main"},{text:"Dashboard",icon:e.jsx(Zi,{}),path:"/"},{text:"Tasks",icon:e.jsx(Ql,{}),path:"/tasks"},b];return o?.access_role==="Sales and Purchase"?[...A,{type:"header",text:"Sales & Purchase"},{text:"Sales Orders",icon:e.jsx(Es,{}),path:"/open-sales-orders"},{text:"Purchase Orders",icon:e.jsx(Ps,{}),path:"/open-purchase-orders"},{text:"Return Orders",icon:e.jsx(Uo,{}),path:"/return-orders"},{text:"Parts to Order",icon:e.jsx($r,{}),path:"/parts-to-order"},{type:"header",text:"Inventory"},{text:"Stock",icon:e.jsx($r,{}),path:"/inventory"},{text:"Supply",icon:e.jsx($r,{}),path:"/supply"},{type:"header",text:"Settings"},{text:"Email Settings",icon:e.jsx(Wo,{}),path:"/email-settings"}]:N},[o,N,b]),E=e.jsxs("div",{children:[e.jsx(Di,{}),e.jsx(kr,{children:j.map((A,C)=>{if(w(A))return e.jsx(Oh,{sx:{bgcolor:"inherit",color:"text.secondary",fontWeight:"bold",fontSize:13,textAlign:"left",pl:2},children:A.text},`header-${A.text}-${C}`);const L=A;return e.jsxs(Ar,{onClick:()=>{const y=P(L.path);a.pathname!==y&&n(y),r(!1)},sx:{cursor:"pointer"},children:[e.jsx(Pu,{children:L.showUnreadDot?e.jsx(Pl,{color:"error",variant:"dot",overlap:"circular",children:L.icon}):L.icon}),e.jsx(hr,{primary:L.text,primaryTypographyProps:L.showUnreadDot?{fontWeight:600}:void 0})]},L.path||`${L.text}-${C}`)})})]});return e.jsxs(k,{sx:{display:"flex"},children:[e.jsx(Ah,{position:"fixed",sx:{width:{sm:`calc(100% - ${vs}px)`},ml:{sm:`${vs}px`}},children:e.jsxs(Di,{children:[e.jsx(Q,{color:"inherit",startIcon:e.jsx(Au,{}),onClick:()=>n(-1),sx:{mr:2,display:{xs:"none",sm:"inline-flex"}},children:"Back"}),e.jsx(gt,{color:"inherit","aria-label":"open drawer",edge:"start",onClick:_,sx:{mr:2,display:{sm:"none"}},children:e.jsx(Mh,{})}),e.jsxs(k,{sx:{marginLeft:"auto",display:"flex",alignItems:"center",gap:2},children:[!!window.__backendUnavailableSince&&e.jsx(Ht,{title:"Backend unavailable; pending events will sync automatically when online.",children:e.jsxs(k,{sx:{bgcolor:"orange",color:"black",px:1.5,py:.5,borderRadius:1,fontSize:12},children:["Offline",m?`  Pending: ${m}`:""]})}),e.jsx(Q,{color:"inherit",onClick:v,startIcon:e.jsx(Rh,{}),children:"Logout"})]})]})}),e.jsxs(k,{component:"nav",sx:{width:{sm:vs},flexShrink:{sm:0}},children:[e.jsx(Xi,{variant:"temporary",open:t,onClose:_,ModalProps:{keepMounted:!0},sx:{display:{xs:"block",sm:"none"},"& .MuiDrawer-paper":{boxSizing:"border-box",width:vs}},children:E}),e.jsx(Xi,{variant:"permanent",sx:{display:{xs:"none",sm:"block"},"& .MuiDrawer-paper":{boxSizing:"border-box",width:vs}},open:!0,children:E})]}),e.jsxs(k,{component:"main",sx:{flexGrow:1,p:3,width:{sm:`calc(100% - ${vs}px)`}},children:[e.jsx(Di,{}),e.jsx(sf,{})]}),e.jsx(wg,{onClick:c,isOpen:i,unreadCount:d}),e.jsx(zy,{isOpen:i,onClose:u})]})},Yy=()=>{const t=Gt(),{login:r}=er(),[n,a]=l.useState({email:"",password:""}),[s,o]=l.useState(null),[i,c]=l.useState(!1),[u,d]=l.useState(!1);l.useEffect(()=>{const f=localStorage.getItem("rememberedEmail"),_=localStorage.getItem("rememberedPassword");f&&_&&(a({email:f,password:_}),d(!0))},[]);const p=f=>{const{name:_,value:v}=f.target;a(w=>({...w,[_]:v}))},m=async f=>{f.preventDefault(),o(null),c(!0),u?(localStorage.setItem("rememberedEmail",n.email),localStorage.setItem("rememberedPassword",n.password)):(localStorage.removeItem("rememberedEmail"),localStorage.removeItem("rememberedPassword"));try{const _=await B.post("/api/auth/login",n),{sessionToken:v,refreshToken:w,user:b}=_.data;r(v,w,b),b.access_role==="Time Tracking"?t("/time-tracking"):b.access_role==="Quotes"?t("/quotes"):t("/")}catch(_){console.error("Login error:",_);try{const v=localStorage.getItem("user"),w=v?JSON.parse(v):null,b=localStorage.getItem("sessionToken"),P=localStorage.getItem("refreshToken");if(w&&w.access_role==="Time Tracking"&&b&&P){t("/time-tracking");return}}catch{}o(_.response?.data?.message||"Failed to login. Please try again.")}finally{c(!1)}};return e.jsx(nt,{component:"main",maxWidth:"xs",children:e.jsx(k,{sx:{marginTop:8,display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsxs(Me,{elevation:3,sx:{padding:4,display:"flex",flexDirection:"column",alignItems:"center",width:"100%"},children:[e.jsx(h,{component:"h1",variant:"h5",gutterBottom:!0,children:"Sign In"}),s&&e.jsx(Fe,{severity:"error",sx:{width:"100%",mb:2},children:s}),e.jsxs(k,{component:"form",onSubmit:m,sx:{mt:1,width:"100%"},children:[e.jsx(le,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",autoFocus:!0,value:n.email,onChange:p}),e.jsx(le,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Password",type:"password",id:"password",autoComplete:"current-password",value:n.password,onChange:p}),e.jsx(yn,{control:e.jsx(gn,{value:"remember",color:"primary",checked:u,onChange:f=>d(f.target.checked)}),label:"Remember me"}),e.jsx(Q,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2},disabled:i,children:i?"Signing in...":"Sign In"}),e.jsx(k,{sx:{textAlign:"center"},children:e.jsx(Nh,{component:Ju,to:"/register",variant:"body2",children:"Don't have an account? Register your company"})})]})]})})})},Vy=()=>{const t=Gt(),{login:r}=er(),[n,a]=l.useState({companyName:"",adminUsername:"",adminEmail:"",adminPassword:"",confirmPassword:""}),[s,o]=l.useState(null),[i,c]=l.useState(!1),u=p=>{const{name:m,value:f}=p.target;a(_=>({..._,[m]:f}))},d=async p=>{if(p.preventDefault(),o(null),n.adminPassword!==n.confirmPassword){o("Passwords do not match");return}c(!0);try{const m=await B.post("/api/auth/register-company",{company_name:n.companyName,admin_username:n.adminUsername,admin_email:n.adminEmail,admin_password:n.adminPassword}),{sessionToken:f,refreshToken:_,user:v}=m.data;r(f,_,v),t("/dashboard")}catch(m){console.error("Registration error:",m),o(m.response?.data?.message||"Failed to register company. Please try again.")}finally{c(!1)}};return e.jsx(nt,{component:"main",maxWidth:"sm",children:e.jsx(k,{sx:{marginTop:8,display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsxs(Me,{elevation:3,sx:{padding:4,display:"flex",flexDirection:"column",alignItems:"center",width:"100%"},children:[e.jsx(h,{component:"h1",variant:"h5",gutterBottom:!0,children:"Register Your Company"}),s&&e.jsx(Fe,{severity:"error",sx:{width:"100%",mb:2},children:s}),e.jsxs(k,{component:"form",onSubmit:d,sx:{mt:3,width:"100%"},children:[e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{required:!0,fullWidth:!0,label:"Company Name",name:"companyName",value:n.companyName,onChange:u})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{required:!0,fullWidth:!0,label:"Admin Username",name:"adminUsername",value:n.adminUsername,onChange:u})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{required:!0,fullWidth:!0,label:"Admin Email",name:"adminEmail",type:"email",value:n.adminEmail,onChange:u})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{required:!0,fullWidth:!0,label:"Admin Password",name:"adminPassword",type:"password",value:n.adminPassword,onChange:u})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{required:!0,fullWidth:!0,label:"Confirm Password",name:"confirmPassword",type:"password",value:n.confirmPassword,onChange:u})})]}),e.jsx(Q,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2},disabled:i,children:i?"Registering...":"Register Company"})]})]})})})};var da={},nd;function Gy(){if(nd)return da;nd=1;var t=vt();Object.defineProperty(da,"__esModule",{value:!0}),da.default=void 0;var r=t(_t()),n=bt();return da.default=(0,r.default)((0,n.jsx)("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4z"}),"Refresh"),da}var Qy=Gy();const _n=st(Qy);var ua={},sd;function Ky(){if(sd)return ua;sd=1;var t=vt();Object.defineProperty(ua,"__esModule",{value:!0}),ua.default=void 0;var r=t(_t()),n=bt();return ua.default=(0,r.default)((0,n.jsx)("path",{d:"M17 12c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5m1.65 7.35L16.5 17.2V14h1v2.79l1.85 1.85zM18 3h-3.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H6c-1.1 0-2 .9-2 2v15c0 1.1.9 2 2 2h6.11c-.59-.57-1.07-1.25-1.42-2H6V5h2v3h8V5h2v5.08c.71.1 1.38.31 2 .6V5c0-1.1-.9-2-2-2m-6 2c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1"}),"PendingActions"),ua}var Jy=Ky();const Xy=st(Jy);var pa={},ad;function Zy(){if(ad)return pa;ad=1;var t=vt();Object.defineProperty(pa,"__esModule",{value:!0}),pa.default=void 0;var r=t(_t()),n=bt();return pa.default=(0,r.default)((0,n.jsx)("path",{d:"m9.31 17 2.44-2.44L14.19 17l1.06-1.06-2.44-2.44 2.44-2.44L14.19 10l-2.44 2.44L9.31 10l-1.06 1.06 2.44 2.44-2.44 2.44zM19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 16H5V8h14z"}),"EventBusy"),pa}var ev=Zy();const tv=st(ev);var ha={},od;function rv(){if(od)return ha;od=1;var t=vt();Object.defineProperty(ha,"__esModule",{value:!0}),ha.default=void 0;var r=t(_t()),n=bt();return ha.default=(0,r.default)((0,n.jsx)("path",{d:"M16.53 11.06 15.47 10l-4.88 4.88-2.12-2.12-1.06 1.06L10.59 17zM19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 16H5V8h14z"}),"EventAvailable"),ha}var nv=rv();const sv=st(nv);var ma={},id;function av(){if(id)return ma;id=1;var t=vt();Object.defineProperty(ma,"__esModule",{value:!0}),ma.default=void 0;var r=t(_t()),n=bt();return ma.default=(0,r.default)((0,n.jsx)("path",{d:"M3 10h11v2H3zm0-4h11v2H3zm0 8h7v2H3zm17.59-2.07-4.25 4.24-2.12-2.12-1.41 1.41L16.34 19 22 13.34z"}),"PlaylistAddCheck"),ma}var ov=av();const iv=st(ov),lv=[{key:"open",label:"Open tasks",icon:e.jsx(Xy,{fontSize:"large"}),palette:"info"},{key:"completed",label:"Completed",icon:e.jsx(Pp,{fontSize:"large"}),palette:"success"},{key:"overdue",label:"Overdue",icon:e.jsx(tv,{fontSize:"large"}),palette:"error"},{key:"dueToday",label:"Due today",icon:e.jsx(sv,{fontSize:"large"}),palette:"warning"},{key:"dueSoon",label:"Due in 7 days",icon:e.jsx(iv,{fontSize:"large"}),palette:"secondary"}],qp=({summary:t,loading:r,onRefresh:n,onViewTasks:a})=>{const s=t?.total??0;return e.jsxs(kt,{sx:{borderRadius:3,overflow:"hidden",position:"relative",boxShadow:"0 24px 60px -32px rgba(15, 23, 42, 0.45)"},children:[e.jsx(k,{sx:{position:"absolute",inset:0,background:"linear-gradient(140deg, rgba(59, 130, 246, 0.12) 0%, rgba(99, 102, 241, 0.08) 45%, rgba(168, 85, 247, 0.05) 100%)",pointerEvents:"none"}}),e.jsxs(Ot,{sx:{position:"relative",p:{xs:3,md:4}},children:[e.jsxs(Pe,{direction:{xs:"column",md:"row"},justifyContent:"space-between",alignItems:{xs:"flex-start",md:"center"},spacing:3,children:[e.jsxs(k,{children:[e.jsx(h,{variant:"overline",color:"text.secondary",sx:{letterSpacing:1.2},children:"Team workload snapshot"}),e.jsx(h,{variant:"h4",sx:{fontWeight:600},children:"Task overview"}),e.jsxs(h,{variant:"body1",color:"text.secondary",sx:{mt:.5},children:["Tracking ",e.jsx("strong",{children:s})," task",s===1?"":"s"," across your workspace."]})]}),e.jsxs(Pe,{direction:{xs:"column",sm:"row"},spacing:1.5,width:{xs:"100%",sm:"auto"},children:[n&&e.jsx(Q,{variant:"outlined",startIcon:e.jsx(_n,{}),onClick:n,disabled:r,sx:{width:{xs:"100%",sm:"auto"}},children:"Refresh"}),a&&e.jsx(Q,{variant:"contained",onClick:a,sx:{width:{xs:"100%",sm:"auto"}},children:"View tasks"})]})]}),e.jsx(k,{sx:{mt:4},children:r?e.jsx(k,{display:"flex",justifyContent:"center",py:4,children:e.jsx(ot,{})}):t?e.jsx(k,{sx:{display:"grid",gap:2.5,gridTemplateColumns:{xs:"repeat(1, minmax(0, 1fr))",sm:"repeat(2, minmax(0, 1fr))",md:"repeat(3, minmax(0, 1fr))",lg:"repeat(5, minmax(0, 1fr))"}},children:lv.map(o=>e.jsxs(k,{sx:i=>({borderRadius:3,p:3,display:"flex",flexDirection:"column",gap:1,border:`1px solid ${Dn(i.palette[o.palette].main,.28)}`,background:`linear-gradient(135deg, ${Dn(i.palette[o.palette].main,.18)} 0%, ${Dn(i.palette[o.palette].main,.06)} 100%)`,boxShadow:`0 12px 30px -20px ${Dn(i.palette[o.palette].main,.6)}`,color:i.palette.text.primary}),children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1.25},children:[e.jsx(k,{sx:i=>({display:"inline-flex",alignItems:"center",justifyContent:"center",width:40,height:40,borderRadius:"50%",backgroundColor:Dn(i.palette[o.palette].main,.2),color:i.palette[o.palette].dark}),children:o.icon}),e.jsx(h,{variant:"subtitle2",color:"text.secondary",children:o.label})]}),e.jsx(h,{variant:"h4",sx:{fontWeight:600},children:t[o.key]??0})]},o.key))}):e.jsx(h,{variant:"body2",color:"text.secondary",children:"Task data is not available yet. Create your first task to populate this overview."})})]})]})},cv=t=>{if(!t)return{};const r={};return t.status&&t.status.length>0&&(r.status=t.status.join(",")),typeof t.assignedTo=="number"&&(r.assignedTo=String(t.assignedTo)),t.dueFrom&&(r.dueFrom=t.dueFrom),t.dueTo&&(r.dueTo=t.dueTo),t.search&&(r.search=t.search.trim()),typeof t.includeCompleted=="boolean"&&(r.includeCompleted=String(t.includeCompleted)),typeof t.includeArchived=="boolean"&&(r.includeArchived=String(t.includeArchived)),r},dv=async t=>(await B.get("/api/tasks",{params:cv(t)})).data.tasks,uv=async t=>(await B.get(`/api/tasks/${t}/overview`)).data,pv=async t=>(await B.post("/api/tasks",t)).data,hv=async(t,r)=>(await B.put(`/api/tasks/${t}`,r)).data,mv=async(t,r)=>(await B.patch(`/api/tasks/${t}/assignments`,{assigneeIds:r})).data,fv=async(t,r)=>(await B.patch(`/api/tasks/${t}/complete`,{completed:r})).data,xv=async(t,r)=>(await B.post(`/api/tasks/${t}/notes`,{note:r})).data,gv=async t=>{await B.delete(`/api/tasks/${t}`)},vl=async()=>(await B.get("/api/tasks/summary")).data,yv=async()=>(await B.get("/api/tasks/assignees")).data.assignees,vv={Purchasing:e.jsx(Ps,{sx:{color:"primary.main"}}),Sales:e.jsx(Es,{sx:{color:"primary.main"}}),"Products & Inventory":e.jsx($r,{sx:{color:"primary.main"}}),"Time Tracking":e.jsx(Jn,{sx:{color:"primary.main"}}),"Human Resources":e.jsx(Xa,{sx:{color:"primary.main"}}),Settings:e.jsx(Tl,{sx:{color:"primary.main"}})},ld=()=>{const t=Gt(),r=Lh(),{user:n}=er(),[a,s]=l.useState(null),[o,i]=l.useState(!1),c=l.useCallback(async()=>{i(!0);try{const p=await vl();s(p)}catch(p){console.error("Failed to load task summary",p)}finally{i(!1)}},[]);l.useEffect(()=>{c()},[c]),console.log("[LandingPage] user:",n);let d=[{title:"Purchasing",items:[{title:"Purchase Orders",description:"Manage purchase orders",icon:e.jsx(Ps,{sx:{fontSize:40,color:"primary.main"}}),path:"/open-purchase-orders"},{title:"Return Orders",description:"Track vendor returns tied to POs",icon:e.jsx(Uo,{sx:{fontSize:40,color:"primary.main"}}),path:"/return-orders"},{title:"Parts to Order",description:"Manage parts ordering",icon:e.jsx($r,{sx:{fontSize:40,color:"primary.main"}}),path:"/parts-to-order"},{title:"Vendors",description:"Manage your vendors",icon:e.jsx(Eu,{sx:{fontSize:40,color:"primary.main"}}),path:"/vendors"}]},{title:"Sales",items:[{title:"Quotes",description:"Manage and track quotes",icon:e.jsx(el,{sx:{fontSize:40,color:"primary.main"}}),path:"/quotes"},{title:"Sales Orders",description:"Manage sales orders",icon:e.jsx(Es,{sx:{fontSize:40,color:"primary.main"}}),path:"/open-sales-orders"},{title:"Customers",description:"Track and manage your customer relationships",icon:e.jsx(Xa,{sx:{fontSize:40,color:"primary.main"}}),path:"/customers"}]},{title:"Products & Inventory",items:[{title:"Products",description:"Manage your products",icon:e.jsx(Du,{sx:{fontSize:40,color:"primary.main"}}),path:"/products"},{title:"Stock",description:"Manage your product inventory and stock levels",icon:e.jsx($r,{sx:{fontSize:40,color:"primary.main"}}),path:"/inventory"},{title:"Supply",description:"Manage supply and materials",icon:e.jsx($r,{sx:{fontSize:40,color:"primary.main"}}),path:"/supply"}]},{title:"Time Tracking",items:[{title:"Attendance",description:"View and manage attendance records",icon:e.jsx(Jn,{sx:{fontSize:40,color:"primary.main"}}),path:"/attendance"},{title:"Time Tracking",description:"Track employee time and project hours",icon:e.jsx(Jn,{sx:{fontSize:40,color:"primary.main"}}),path:"/time-tracking"},{title:"Time Tracking Reports",description:"View and export time tracking reports",icon:e.jsx(Tu,{sx:{fontSize:40,color:"primary.main"}}),path:"/time-tracking/reports"}]},{title:"Human Resources",items:[{title:"Employees",description:"Manage employee accounts and roles",icon:e.jsx(Iu,{sx:{fontSize:40,color:"primary.main"}}),path:"/employees"},{title:"Profile Documents",description:"Manage and track employee document access and read status",icon:e.jsx(Ps,{sx:{fontSize:40,color:"primary.main"}}),path:"/profile-documents"},{title:"Leave Management",description:"Manage employee leave requests and approvals",icon:e.jsx(Ou,{sx:{fontSize:40,color:"primary.main"}}),path:"/leave-management"},{title:"Mobile User Access",description:"Manage mobile user access to profiles",icon:e.jsx(Xa,{sx:{fontSize:40,color:"primary.main"}}),path:"/mobile-user-access"}]},{title:"Settings",items:[{title:"Business Profile",description:"Manage your company information and settings",icon:e.jsx(Tl,{sx:{fontSize:40,color:"primary.main"}}),path:"/business-profile"},{title:"Accounting",description:"Configure QuickBooks account mappings",icon:e.jsx(Fo,{sx:{fontSize:40,color:"primary.main"}}),path:"/qbo-account-mapping"},{title:"Global Variables",description:"Set and manage margin, labour, and overhead rates",icon:e.jsx(Fo,{sx:{fontSize:40,color:"primary.main"}}),path:"/margin-schedule"},{title:"Email Settings",description:"Configure system email settings",icon:e.jsx(Wo,{sx:{fontSize:40,color:"primary.main"}}),path:"/email-settings"},{title:"Backup Management",description:"Manage system backups and restores",icon:e.jsx(Il,{sx:{fontSize:40,color:"primary.main"}}),path:"/backup-management"}]}];return n?.access_role==="Sales and Purchase"&&(d=[{title:"Sales & Purchase",items:[{title:"Sales Orders",description:"Manage sales orders",icon:e.jsx(Es,{sx:{fontSize:40,color:"primary.main"}}),path:"/open-sales-orders"},{title:"Purchase Orders",description:"Manage purchase orders",icon:e.jsx(Ps,{sx:{fontSize:40,color:"primary.main"}}),path:"/open-purchase-orders"},{title:"Return Orders",description:"Track vendor returns tied to POs",icon:e.jsx(Uo,{sx:{fontSize:40,color:"primary.main"}}),path:"/return-orders"},{title:"Parts to Order",description:"View parts that need to be ordered",icon:e.jsx($r,{sx:{fontSize:40,color:"primary.main"}}),path:"/parts-to-order"}]},{title:"Inventory",items:[{title:"Stock",description:"Manage your product inventory and stock levels",icon:e.jsx($r,{sx:{fontSize:40,color:"primary.main"}}),path:"/inventory"},{title:"Supply",description:"Manage supply and materials",icon:e.jsx($r,{sx:{fontSize:40,color:"primary.main"}}),path:"/supply"}]},{title:"Settings",items:[{title:"Email Settings",description:"Configure your email settings",icon:e.jsx(Wo,{sx:{fontSize:40,color:"primary.main"}}),path:"/email-settings"}]}]),n?.access_role==="Quotes"&&(d=[{title:"Quotes",items:[{title:"Quotes",description:"Manage and track quotes",icon:e.jsx(el,{sx:{fontSize:40,color:"primary.main"}}),path:"/quotes"}]}]),console.log("[LandingPage] filteredSections:",d),e.jsxs(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{background:`linear-gradient(90deg, ${r.palette.primary.main} 0%, ${r.palette.secondary.main} 100%)`,borderRadius:3,p:4,mb:6,color:r.palette.primary.contrastText,boxShadow:3,textAlign:"center"},children:[e.jsx(h,{variant:"h3",component:"h1",gutterBottom:!0,sx:{color:"inherit"},children:"Welcome to Aiven"}),e.jsx(h,{variant:"h5",component:"h2",gutterBottom:!0,sx:{color:"inherit",opacity:.85},children:"Your all-in-one business management solution"})]}),e.jsx(k,{sx:{mb:6},children:e.jsx(qp,{summary:a,loading:o,onRefresh:c,onViewTasks:()=>t("/")})}),e.jsx(Me,{elevation:0,sx:{mb:6,px:{xs:3,md:4},py:{xs:3,md:4},borderRadius:3,border:"1px solid",borderColor:"divider",backgroundColor:"background.paper"},children:e.jsxs(Pe,{direction:{xs:"column",sm:"row"},spacing:3,alignItems:"center",children:[e.jsx(Rn,{sx:{bgcolor:"primary.main",width:56,height:56},children:e.jsx(El,{fontSize:"medium"})}),e.jsxs(k,{sx:{textAlign:{xs:"center",sm:"left"}},children:[e.jsx(h,{variant:"h5",component:"h2",sx:{fontWeight:600},children:"Workspace Copilot"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Need a hand? Click the Copilot bubble in the lower-right corner to open the AI assistant without leaving your work."})]})]})}),d.map((p,m)=>e.jsx(Ji,{in:!0,timeout:700+m*200,children:e.jsxs(k,{sx:{mt:6,mb:4,p:3,borderRadius:3,background:r.palette.mode==="light"?r.palette.grey[50]:r.palette.grey[900],boxShadow:1},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(Rn,{sx:{bgcolor:"primary.main",mr:2},children:vv[p.title]||e.jsx(Zi,{sx:{color:"primary.main"}})}),e.jsx(h,{variant:"h4",component:"h2",sx:{color:"primary.main",fontWeight:600},children:p.title})]}),e.jsx(O,{container:!0,spacing:4,children:p.items.map((f,_)=>e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(Ji,{in:!0,timeout:900+_*150,children:e.jsx(kt,{sx:{height:"100%",display:"flex",flexDirection:"column",borderRadius:2,boxShadow:2,transition:"transform 0.2s, box-shadow 0.2s","&:hover":{transform:"translateY(-6px) scale(1.03)",boxShadow:6,cursor:"pointer"},bgcolor:"background.paper"},onClick:()=>t(f.path),tabIndex:0,role:"button","aria-label":f.title,children:e.jsxs(Ot,{sx:{flexGrow:1,textAlign:"center"},children:[f.icon,e.jsx(h,{gutterBottom:!0,variant:"h5",component:"h2",children:f.title}),e.jsx(h,{children:f.description})]})})})},_))}),m<d.length-1&&e.jsx(fr,{sx:{mt:4,mb:2}})]})},p.title))]})};var fa={},cd;function bv(){if(cd)return fa;cd=1;var t=vt();Object.defineProperty(fa,"__esModule",{value:!0}),fa.default=void 0;var r=t(_t()),n=bt();return fa.default=(0,r.default)((0,n.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"}),"Delete"),fa}var _v=bv();const xr=st(_v);var xa={},dd;function jv(){if(dd)return xa;dd=1;var t=vt();Object.defineProperty(xa,"__esModule",{value:!0}),xa.default=void 0;var r=t(_t()),n=bt();return xa.default=(0,r.default)((0,n.jsx)("path",{d:"M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96M14 13v4h-4v-4H7l5-5 5 5z"}),"CloudUpload"),xa}var wv=jv();const so=st(wv);var ga={},ud;function Sv(){if(ud)return ga;ud=1;var t=vt();Object.defineProperty(ga,"__esModule",{value:!0}),ga.default=void 0;var r=t(_t()),n=bt();return ga.default=(0,r.default)((0,n.jsx)("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"}),"Edit"),ga}var Cv=Sv();const ao=st(Cv),On="/assets/default-logo-BbiCiEKs.png",Or=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t),pd=t=>{if(console.log("getLogoUrl called with:",t),!t)return console.log("No logo URL provided, using default"),On;if(t.startsWith("http://")||t.startsWith("https://"))return console.log("Logo URL is already a full URL:",t),t;if(t.includes("\\")||t.includes(":/")||t.includes(":\\")){const a=t.split(/[\\\/]/).pop()||t;if(console.log("Extracted filename from Windows path:",a),!a||a===t)return console.warn("Could not extract valid filename from Windows path, using default"),On;const{baseURL:s}=Is(),o=`${s.replace(/\/$/,"")}/uploads/${a}`;return console.log("Built final URL from Windows path:",o),o}if(t.startsWith("/")){const a=t.split("/").pop()||t;if(console.log("Extracted filename from Unix path:",a),!a||a===t)return console.warn("Could not extract valid filename from Unix path, using default"),On;const{baseURL:s}=Is(),o=`${s.replace(/\/$/,"")}/uploads/${a}`;return console.log("Built final URL from Unix path:",o),o}if(t.includes("\\")||t.includes(":/")||t.includes(":\\"))return console.warn("Invalid filename format, using default"),On;const{baseURL:r}=Is(),n=`${r.replace(/\/$/,"")}/uploads/${t}`;return console.log("Built final URL from filename:",n),n};Is().baseURL;const kv=()=>{Gt();const[t,r]=l.useState({id:"",business_name:"",street_address:"",city:"",province:"",country:"",postal_code:"",telephone_number:"",email:"",business_number:"",website:"",logo_url:"",created_at:"",updated_at:""}),[n,a]=l.useState(!1),[s,o]=l.useState(null),[i,c]=l.useState(null),[u,d]=l.useState(!1),p=j=>({id:j.id||"",business_name:j.business_name||"",street_address:j.street_address||"",city:j.city||"",province:j.province||"",country:j.country||"",postal_code:j.postal_code||"",telephone_number:j.telephone_number||"",email:j.email||"",business_number:j.business_number||"",website:j.website||"",logo_url:j.logo_url||"",created_at:j.created_at||"",updated_at:j.updated_at||""});l.useEffect(()=>{m()},[]);const m=async()=>{try{const j=await B.get("/api/business-profile");console.log("Business Profile API Response:",j.data),console.log("Logo URL from API:",j.data.logo_url),r(p(j.data))}catch(j){if(j.response?.status===404){d(!0);return}console.error("Error fetching business profile:",j),z.error("Failed to load business profile")}},f=j=>{const{name:E,value:A}=j.target;r(C=>({...C,[E]:A}))},_=j=>{if(j.target.files&&j.target.files[0]){const E=j.target.files[0];o(E);const A=URL.createObjectURL(E);c(A)}},v=async()=>{if(t.logo_url)try{a(!0),await B.delete("/api/business-profile/logo"),r(j=>({...j,logo_url:""})),z.success("Logo deleted successfully")}catch(j){console.error("Error deleting logo:",j),z.error("Failed to delete logo")}finally{a(!1)}},w=async j=>{j.preventDefault(),a(!0);try{const E=new FormData;Object.entries(t).forEach(([A,C])=>{let L=A;switch(A){case"business_name":L="business_name";break;case"street_address":L="street_address";break;case"telephone_number":L="telephone_number";break;case"business_number":L="business_number";break;case"email":L="email";break;case"website":L="website";break;case"city":L="city";break;case"province":L="province";break;case"country":L="country";break;case"postal_code":L="postal_code";break;case"logo_url":return;case"id":case"created_at":case"updated_at":return}C!=null&&E.append(L,C)}),s&&E.append("logo",s),console.log("Form data being sent:");for(let[A,C]of E.entries())console.log(`${A}:`,C);await B.post("/api/business-profile",E,{headers:{"Content-Type":"multipart/form-data"}}),z.success("Business profile updated successfully"),d(!1),o(null),c(null),m()}catch(E){console.error("Error updating business profile:",E),console.error("Error response:",E.response),console.error("Error message:",E.message),E.response?.status===401?z.error("Authentication failed. Please log in again."):E.response?.status===403?z.error("Access denied. You do not have permission to update the business profile."):E.response?.status===404?z.error("Business profile endpoint not found. Please check your API configuration."):E.response?.status===500?z.error("Server error. Please try again later."):E.code==="NETWORK_ERROR"?z.error("Network error. Please check your connection and try again."):E.message?.includes("timeout")?z.error("Request timed out. Please try again."):z.error(`Failed to update business profile: ${E.response?.data?.error||E.message||"Unknown error"}`)}finally{a(!1)}},b=()=>{d(!1),o(null),c(null),t.id?m():r({id:"",business_name:"",street_address:"",city:"",province:"",country:"",postal_code:"",telephone_number:"",email:"",business_number:"",logo_url:"",created_at:"",updated_at:""})};if(n)return e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(ot,{})});const P=()=>{const j=!!t.id;return e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"flex-start",minHeight:"70vh",children:e.jsx(Me,{sx:{p:{xs:2,md:4},width:"100%",maxWidth:650,borderRadius:4,boxShadow:6,bgcolor:"background.paper"},elevation:6,children:e.jsxs(Pe,{spacing:4,children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsx(h,{variant:"h5",fontWeight:700,color:"primary.main",children:j?"Current Business Profile":"Business Profile"}),e.jsx(k,{children:e.jsx(Q,{variant:"contained",startIcon:e.jsx(ao,{}),onClick:()=>d(!0),sx:{borderRadius:2,fontWeight:600},children:j?"Edit Profile":"Create Profile"})})]}),e.jsx(fr,{sx:{bgcolor:"primary.light",height:3,borderRadius:2}}),j?e.jsxs(e.Fragment,{children:[t.logo_url&&e.jsxs(k,{display:"flex",flexDirection:"column",alignItems:"center",mb:2,children:[e.jsx(h,{variant:"subtitle1",fontWeight:600,color:"primary.dark",gutterBottom:!0,children:"Business Logo"}),e.jsx(kt,{sx:{maxWidth:180,borderRadius:3,boxShadow:3,border:"2px solid",borderColor:"primary.light",p:1,mb:1,bgcolor:"grey.50"},children:e.jsx(Kl,{component:"img",image:t.logo_url?pd(t.logo_url):On,onError:E=>E.currentTarget.src=On,alt:"Business Logo",sx:{height:120,objectFit:"contain",borderRadius:2,bgcolor:"white"}})})]}),e.jsxs(O,{container:!0,spacing:3,children:[e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx(h,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Business Name"}),e.jsx(h,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.business_name})]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx(h,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Business Number"}),e.jsx(h,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.business_number})]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx(h,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Address"}),e.jsxs(h,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:[t.street_address,e.jsx("br",{}),t.city,", ",t.province,t.postal_code?`, ${t.postal_code}`:"",e.jsx("br",{}),t.country]})]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx(h,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Email"}),e.jsx(h,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.email})]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx(h,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Telephone"}),e.jsx(h,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.telephone_number})]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx(h,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Website"}),e.jsx(h,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.website?e.jsx("a",{href:t.website.startsWith("http")?t.website:`https://${t.website}`,target:"_blank",rel:"noopener noreferrer",style:{color:"inherit",textDecoration:"underline"},children:t.website}):"Not provided"})]})]})]}):e.jsxs(k,{textAlign:"center",py:4,children:[e.jsx(h,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"No Business Profile Found"}),e.jsx(h,{variant:"body1",color:"text.secondary",sx:{mb:3},children:"Create your business profile to get started. This information will be used in your quotes, invoices, and other business documents."}),e.jsx(Q,{variant:"contained",size:"large",startIcon:e.jsx(ao,{}),onClick:()=>d(!0),sx:{borderRadius:2,fontWeight:600},children:"Create Business Profile"})]})]})})})},N=()=>e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"flex-start",minHeight:"70vh",children:e.jsx(Me,{sx:{p:{xs:2,md:4},width:"100%",maxWidth:650,borderRadius:4,boxShadow:6,bgcolor:"background.paper"},elevation:6,component:"form",onSubmit:w,children:e.jsxs(Pe,{spacing:4,children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsx(h,{variant:"h5",fontWeight:700,color:"primary.main",children:t.id?"Edit Business Profile":"Create Business Profile"}),e.jsxs(k,{children:[e.jsx(Q,{variant:"outlined",onClick:b,sx:{borderRadius:2,fontWeight:600,mr:2},children:"Cancel"}),e.jsx(Q,{variant:"contained",type:"submit",disabled:n,sx:{borderRadius:2,fontWeight:600},children:n?e.jsx(ot,{size:24}):t.id?"Save Changes":"Create Profile"})]})]}),e.jsx(fr,{sx:{bgcolor:"primary.light",height:3,borderRadius:2}}),e.jsxs(O,{container:!0,spacing:3,children:[e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Business Name",name:"business_name",value:t.business_name,onChange:f,fullWidth:!0,required:!0})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Business Number/GST-HST Registration Number",name:"business_number",value:t.business_number,onChange:f,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Street Address",name:"street_address",value:t.street_address,onChange:f,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"City",name:"city",value:t.city,onChange:f,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Province",name:"province",value:t.province,onChange:f,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Country",name:"country",value:t.country,onChange:f,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Postal Code",name:"postal_code",value:t.postal_code,onChange:f,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Telephone Number",name:"telephone_number",value:t.telephone_number,onChange:f,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Email",name:"email",value:t.email,onChange:f,fullWidth:!0,type:"email"})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Website",name:"website",value:t.website,onChange:f,fullWidth:!0})}),e.jsxs(O,{item:!0,xs:12,children:[e.jsx(h,{variant:"subtitle2",fontWeight:600,gutterBottom:!0,children:"Business Logo"}),t.logo_url&&e.jsxs(k,{display:"flex",flexDirection:"column",alignItems:"center",mb:2,children:[e.jsx(kt,{sx:{maxWidth:180,borderRadius:3,boxShadow:3,border:"2px solid",borderColor:"primary.light",p:1,mb:1,bgcolor:"grey.50"},children:e.jsx(Kl,{component:"img",image:t.logo_url?pd(t.logo_url):On,onError:j=>j.currentTarget.src=On,alt:"Business Logo",sx:{height:120,objectFit:"contain",borderRadius:2,bgcolor:"white"}})}),e.jsx(Q,{variant:"outlined",color:"error",startIcon:e.jsx(xr,{}),onClick:v,sx:{borderRadius:2,fontWeight:600},children:"Delete Current Logo"})]}),e.jsxs(Q,{variant:"contained",component:"label",startIcon:e.jsx(so,{}),sx:{borderRadius:2,fontWeight:600},children:[t.logo_url?"Change Logo":"Upload Logo",e.jsx("input",{type:"file",hidden:!0,onChange:_,accept:"image/*"})]}),i&&e.jsxs(k,{mt:2,display:"flex",flexDirection:"column",alignItems:"center",children:[e.jsx(h,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"New Logo Preview:"}),e.jsx("img",{src:i,alt:"Logo Preview",style:{maxWidth:"100px",maxHeight:"100px"}})]})]})]})]})})});return e.jsx(nt,{sx:{mt:4,mb:4},children:u?N():P()})};var ya={},hd;function Pv(){if(hd)return ya;hd=1;var t=vt();Object.defineProperty(ya,"__esModule",{value:!0}),ya.default=void 0;var r=t(_t()),n=bt();return ya.default=(0,r.default)((0,n.jsx)("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"}),"Search"),ya}var Ev=Pv();const Hr=st(Ev);var va={},md;function Dv(){if(md)return va;md=1;var t=vt();Object.defineProperty(va,"__esModule",{value:!0}),va.default=void 0;var r=t(_t()),n=bt();return va.default=(0,r.default)((0,n.jsx)("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add"),va}var Tv=Dv();const Nr=st(Tv);var ba={},fd;function Iv(){if(fd)return ba;fd=1;var t=vt();Object.defineProperty(ba,"__esModule",{value:!0}),ba.default=void 0;var r=t(_t()),n=bt();return ba.default=(0,r.default)((0,n.jsx)("path",{d:"M5 20h14v-2H5zM19 9h-4V3H9v6H5l7 7z"}),"Download"),ba}var Ov=Iv();const gr=st(Ov),xd=async t=>(await B.get(`/api/customers/${t}/contacts`)).data,Av=async(t,r)=>(await B.post(`/api/customers/${t}/contacts/people`,r)).data,Mv=async(t,r,n)=>(await B.put(`/api/customers/${t}/contacts/people/${r}`,n)).data,Rv=async(t,r)=>(await B.delete(`/api/customers/${t}/contacts/people/${r}`)).data,Nv=async(t,r)=>(await B.post(`/api/customers/${t}/contacts/emails`,r)).data,Lv=async(t,r,n)=>(await B.put(`/api/customers/${t}/contacts/emails/${r}`,n)).data,qv=async(t,r)=>(await B.delete(`/api/customers/${t}/contacts/emails/${r}`)).data,Uv=async(t,r)=>(await B.post(`/api/customers/${t}/contacts/phones`,r)).data,Fv=async(t,r,n)=>(await B.put(`/api/customers/${t}/contacts/phones/${r}`,n)).data,Wv=async(t,r)=>(await B.delete(`/api/customers/${t}/contacts/phones/${r}`)).data,$v=async()=>(await B.get("/api/customers")).data,zv=async t=>(await B.get(`/api/customers/${t}`)).data,Up=async t=>(await B.post("/api/customers",t)).data,Fp=async(t,r)=>(await B.put(`/api/customers/${t}`,r)).data,Bv=async t=>{await B.delete(`/api/customers/${t}`)};var Ao={exports:{}};/* @license
Papa Parse
v5.5.3
https://github.com/mholt/PapaParse
License: MIT
*/var Hv=Ao.exports,gd;function Yv(){return gd||(gd=1,function(t,r){((n,a)=>{t.exports=a()})(Hv,function n(){var a=typeof self<"u"?self:typeof window<"u"?window:a!==void 0?a:{},s,o=!a.document&&!!a.postMessage,i=a.IS_PAPA_WORKER||!1,c={},u=0,d={};function p(y){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},(function(x){var D=A(x);D.chunkSize=parseInt(D.chunkSize),x.step||x.chunk||(D.chunkSize=null),this._handle=new w(D),(this._handle.streamer=this)._config=D}).call(this,y),this.parseChunk=function(x,D){var M=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&0<M){let H=this._config.newline;H||(X=this._config.quoteChar||'"',H=this._handle.guessLineEndings(x,X)),x=[...x.split(H).slice(M)].join(H)}this.isFirstChunk&&L(this._config.beforeFirstChunk)&&(X=this._config.beforeFirstChunk(x))!==void 0&&(x=X),this.isFirstChunk=!1,this._halted=!1;var M=this._partialLine+x,X=(this._partialLine="",this._handle.parse(M,this._baseIndex,!this._finished));if(!this._handle.paused()&&!this._handle.aborted()){if(x=X.meta.cursor,M=(this._finished||(this._partialLine=M.substring(x-this._baseIndex),this._baseIndex=x),X&&X.data&&(this._rowCount+=X.data.length),this._finished||this._config.preview&&this._rowCount>=this._config.preview),i)a.postMessage({results:X,workerId:d.WORKER_ID,finished:M});else if(L(this._config.chunk)&&!D){if(this._config.chunk(X,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);this._completeResults=X=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(X.data),this._completeResults.errors=this._completeResults.errors.concat(X.errors),this._completeResults.meta=X.meta),this._completed||!M||!L(this._config.complete)||X&&X.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),M||X&&X.meta.paused||this._nextChunk(),X}this._halted=!0},this._sendError=function(x){L(this._config.error)?this._config.error(x):i&&this._config.error&&a.postMessage({workerId:d.WORKER_ID,error:x,finished:!1})}}function m(y){var x;(y=y||{}).chunkSize||(y.chunkSize=d.RemoteChunkSize),p.call(this,y),this._nextChunk=o?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(D){this._input=D,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(x=new XMLHttpRequest,this._config.withCredentials&&(x.withCredentials=this._config.withCredentials),o||(x.onload=C(this._chunkLoaded,this),x.onerror=C(this._chunkError,this)),x.open(this._config.downloadRequestBody?"POST":"GET",this._input,!o),this._config.downloadRequestHeaders){var D,M=this._config.downloadRequestHeaders;for(D in M)x.setRequestHeader(D,M[D])}var X;this._config.chunkSize&&(X=this._start+this._config.chunkSize-1,x.setRequestHeader("Range","bytes="+this._start+"-"+X));try{x.send(this._config.downloadRequestBody)}catch(H){this._chunkError(H.message)}o&&x.status===0&&this._chunkError()}},this._chunkLoaded=function(){x.readyState===4&&(x.status<200||400<=x.status?this._chunkError():(this._start+=this._config.chunkSize||x.responseText.length,this._finished=!this._config.chunkSize||this._start>=(D=>(D=D.getResponseHeader("Content-Range"))!==null?parseInt(D.substring(D.lastIndexOf("/")+1)):-1)(x),this.parseChunk(x.responseText)))},this._chunkError=function(D){D=x.statusText||D,this._sendError(new Error(D))}}function f(y){(y=y||{}).chunkSize||(y.chunkSize=d.LocalChunkSize),p.call(this,y);var x,D,M=typeof FileReader<"u";this.stream=function(X){this._input=X,D=X.slice||X.webkitSlice||X.mozSlice,M?((x=new FileReader).onload=C(this._chunkLoaded,this),x.onerror=C(this._chunkError,this)):x=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var X=this._input,H=(this._config.chunkSize&&(H=Math.min(this._start+this._config.chunkSize,this._input.size),X=D.call(X,this._start,H)),x.readAsText(X,this._config.encoding));M||this._chunkLoaded({target:{result:H}})},this._chunkLoaded=function(X){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(X.target.result)},this._chunkError=function(){this._sendError(x.error)}}function _(y){var x;p.call(this,y=y||{}),this.stream=function(D){return x=D,this._nextChunk()},this._nextChunk=function(){var D,M;if(!this._finished)return D=this._config.chunkSize,x=D?(M=x.substring(0,D),x.substring(D)):(M=x,""),this._finished=!x,this.parseChunk(M)}}function v(y){p.call(this,y=y||{});var x=[],D=!0,M=!1;this.pause=function(){p.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){p.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(X){this._input=X,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){M&&x.length===1&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),x.length?this.parseChunk(x.shift()):D=!0},this._streamData=C(function(X){try{x.push(typeof X=="string"?X:X.toString(this._config.encoding)),D&&(D=!1,this._checkIsFinished(),this.parseChunk(x.shift()))}catch(H){this._streamError(H)}},this),this._streamError=C(function(X){this._streamCleanUp(),this._sendError(X)},this),this._streamEnd=C(function(){this._streamCleanUp(),M=!0,this._streamData("")},this),this._streamCleanUp=C(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function w(y){var x,D,M,X,H=Math.pow(2,53),U=-H,G=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,te=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,re=this,S=0,g=0,T=!1,q=!1,ee=[],R={data:[],errors:[],meta:{}};function K(de){return y.skipEmptyLines==="greedy"?de.join("").trim()==="":de.length===1&&de[0].length===0}function F(){if(R&&M&&(ve("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+d.DefaultDelimiter+"'"),M=!1),y.skipEmptyLines&&(R.data=R.data.filter(function(pe){return!K(pe)})),xe()){let pe=function(se,I){L(y.transformHeader)&&(se=y.transformHeader(se,I)),ee.push(se)};if(R)if(Array.isArray(R.data[0])){for(var de=0;xe()&&de<R.data.length;de++)R.data[de].forEach(pe);R.data.splice(0,1)}else R.data.forEach(pe)}function me(pe,se){for(var I=y.header?{}:[],W=0;W<pe.length;W++){var ce=W,Z=pe[W],Z=((Ae,Ce)=>(ze=>(y.dynamicTypingFunction&&y.dynamicTyping[ze]===void 0&&(y.dynamicTyping[ze]=y.dynamicTypingFunction(ze)),(y.dynamicTyping[ze]||y.dynamicTyping)===!0))(Ae)?Ce==="true"||Ce==="TRUE"||Ce!=="false"&&Ce!=="FALSE"&&((ze=>{if(G.test(ze)&&(ze=parseFloat(ze),U<ze&&ze<H))return 1})(Ce)?parseFloat(Ce):te.test(Ce)?new Date(Ce):Ce===""?null:Ce):Ce)(ce=y.header?W>=ee.length?"__parsed_extra":ee[W]:ce,Z=y.transform?y.transform(Z,ce):Z);ce==="__parsed_extra"?(I[ce]=I[ce]||[],I[ce].push(Z)):I[ce]=Z}return y.header&&(W>ee.length?ve("FieldMismatch","TooManyFields","Too many fields: expected "+ee.length+" fields but parsed "+W,g+se):W<ee.length&&ve("FieldMismatch","TooFewFields","Too few fields: expected "+ee.length+" fields but parsed "+W,g+se)),I}var ge;R&&(y.header||y.dynamicTyping||y.transform)&&(ge=1,!R.data.length||Array.isArray(R.data[0])?(R.data=R.data.map(me),ge=R.data.length):R.data=me(R.data,0),y.header&&R.meta&&(R.meta.fields=ee),g+=ge)}function xe(){return y.header&&ee.length===0}function ve(de,me,ge,pe){de={type:de,code:me,message:ge},pe!==void 0&&(de.row=pe),R.errors.push(de)}L(y.step)&&(X=y.step,y.step=function(de){R=de,xe()?F():(F(),R.data.length!==0&&(S+=de.data.length,y.preview&&S>y.preview?D.abort():(R.data=R.data[0],X(R,re))))}),this.parse=function(de,me,ge){var pe=y.quoteChar||'"',pe=(y.newline||(y.newline=this.guessLineEndings(de,pe)),M=!1,y.delimiter?L(y.delimiter)&&(y.delimiter=y.delimiter(de),R.meta.delimiter=y.delimiter):((pe=((se,I,W,ce,Z)=>{var Ae,Ce,ze,Ve;Z=Z||[",","	","|",";",d.RECORD_SEP,d.UNIT_SEP];for(var ut=0;ut<Z.length;ut++){for(var it,pt=Z[ut],Ne=0,tt=0,Be=0,wt=(ze=void 0,new P({comments:ce,delimiter:pt,newline:I,preview:10}).parse(se)),zt=0;zt<wt.data.length;zt++)W&&K(wt.data[zt])?Be++:(it=wt.data[zt].length,tt+=it,ze===void 0?ze=it:0<it&&(Ne+=Math.abs(it-ze),ze=it));0<wt.data.length&&(tt/=wt.data.length-Be),(Ce===void 0||Ne<=Ce)&&(Ve===void 0||Ve<tt)&&1.99<tt&&(Ce=Ne,Ae=pt,Ve=tt)}return{successful:!!(y.delimiter=Ae),bestDelimiter:Ae}})(de,y.newline,y.skipEmptyLines,y.comments,y.delimitersToGuess)).successful?y.delimiter=pe.bestDelimiter:(M=!0,y.delimiter=d.DefaultDelimiter),R.meta.delimiter=y.delimiter),A(y));return y.preview&&y.header&&pe.preview++,x=de,D=new P(pe),R=D.parse(x,me,ge),F(),T?{meta:{paused:!0}}:R||{meta:{paused:!1}}},this.paused=function(){return T},this.pause=function(){T=!0,D.abort(),x=L(y.chunk)?"":x.substring(D.getCharIndex())},this.resume=function(){re.streamer._halted?(T=!1,re.streamer.parseChunk(x,!0)):setTimeout(re.resume,3)},this.aborted=function(){return q},this.abort=function(){q=!0,D.abort(),R.meta.aborted=!0,L(y.complete)&&y.complete(R),x=""},this.guessLineEndings=function(se,pe){se=se.substring(0,1048576);var pe=new RegExp(b(pe)+"([^]*?)"+b(pe),"gm"),ge=(se=se.replace(pe,"")).split("\r"),pe=se.split(`
`),se=1<pe.length&&pe[0].length<ge[0].length;if(ge.length===1||se)return`
`;for(var I=0,W=0;W<ge.length;W++)ge[W][0]===`
`&&I++;return I>=ge.length/2?`\r
`:"\r"}}function b(y){return y.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function P(y){var x=(y=y||{}).delimiter,D=y.newline,M=y.comments,X=y.step,H=y.preview,U=y.fastMode,G=null,te=!1,re=y.quoteChar==null?'"':y.quoteChar,S=re;if(y.escapeChar!==void 0&&(S=y.escapeChar),(typeof x!="string"||-1<d.BAD_DELIMITERS.indexOf(x))&&(x=","),M===x)throw new Error("Comment character same as delimiter");M===!0?M="#":(typeof M!="string"||-1<d.BAD_DELIMITERS.indexOf(M))&&(M=!1),D!==`
`&&D!=="\r"&&D!==`\r
`&&(D=`
`);var g=0,T=!1;this.parse=function(q,ee,R){if(typeof q!="string")throw new Error("Input must be a string");var K=q.length,F=x.length,xe=D.length,ve=M.length,de=L(X),me=[],ge=[],pe=[],se=g=0;if(!q)return Ne();if(U||U!==!1&&q.indexOf(re)===-1){for(var I=q.split(D),W=0;W<I.length;W++){if(pe=I[W],g+=pe.length,W!==I.length-1)g+=D.length;else if(R)return Ne();if(!M||pe.substring(0,ve)!==M){if(de){if(me=[],Ve(pe.split(x)),tt(),T)return Ne()}else Ve(pe.split(x));if(H&&H<=W)return me=me.slice(0,H),Ne(!0)}}return Ne()}for(var ce=q.indexOf(x,g),Z=q.indexOf(D,g),Ae=new RegExp(b(S)+b(re),"g"),Ce=q.indexOf(re,g);;)if(q[g]===re)for(Ce=g,g++;;){if((Ce=q.indexOf(re,Ce+1))===-1)return R||ge.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:me.length,index:g}),it();if(Ce===K-1)return it(q.substring(g,Ce).replace(Ae,re));if(re===S&&q[Ce+1]===S)Ce++;else if(re===S||Ce===0||q[Ce-1]!==S){ce!==-1&&ce<Ce+1&&(ce=q.indexOf(x,Ce+1));var ze=ut((Z=Z!==-1&&Z<Ce+1?q.indexOf(D,Ce+1):Z)===-1?ce:Math.min(ce,Z));if(q.substr(Ce+1+ze,F)===x){pe.push(q.substring(g,Ce).replace(Ae,re)),q[g=Ce+1+ze+F]!==re&&(Ce=q.indexOf(re,g)),ce=q.indexOf(x,g),Z=q.indexOf(D,g);break}if(ze=ut(Z),q.substring(Ce+1+ze,Ce+1+ze+xe)===D){if(pe.push(q.substring(g,Ce).replace(Ae,re)),pt(Ce+1+ze+xe),ce=q.indexOf(x,g),Ce=q.indexOf(re,g),de&&(tt(),T))return Ne();if(H&&me.length>=H)return Ne(!0);break}ge.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:me.length,index:g}),Ce++}}else if(M&&pe.length===0&&q.substring(g,g+ve)===M){if(Z===-1)return Ne();g=Z+xe,Z=q.indexOf(D,g),ce=q.indexOf(x,g)}else if(ce!==-1&&(ce<Z||Z===-1))pe.push(q.substring(g,ce)),g=ce+F,ce=q.indexOf(x,g);else{if(Z===-1)break;if(pe.push(q.substring(g,Z)),pt(Z+xe),de&&(tt(),T))return Ne();if(H&&me.length>=H)return Ne(!0)}return it();function Ve(Be){me.push(Be),se=g}function ut(Be){var wt=0;return wt=Be!==-1&&(Be=q.substring(Ce+1,Be))&&Be.trim()===""?Be.length:wt}function it(Be){return R||(Be===void 0&&(Be=q.substring(g)),pe.push(Be),g=K,Ve(pe),de&&tt()),Ne()}function pt(Be){g=Be,Ve(pe),pe=[],Z=q.indexOf(D,g)}function Ne(Be){if(y.header&&!ee&&me.length&&!te){var wt=me[0],zt=Object.create(null),Bt=new Set(wt);let We=!1;for(let Qt=0;Qt<wt.length;Qt++){let Kt=wt[Qt];if(zt[Kt=L(y.transformHeader)?y.transformHeader(Kt,Qt):Kt]){let Wt,tr=zt[Kt];for(;Wt=Kt+"_"+tr,tr++,Bt.has(Wt););Bt.add(Wt),wt[Qt]=Wt,zt[Kt]++,We=!0,(G=G===null?{}:G)[Wt]=Kt}else zt[Kt]=1,wt[Qt]=Kt;Bt.add(Kt)}We&&console.warn("Duplicate headers found and renamed."),te=!0}return{data:me,errors:ge,meta:{delimiter:x,linebreak:D,aborted:T,truncated:!!Be,cursor:se+(ee||0),renamedHeaders:G}}}function tt(){X(Ne()),me=[],ge=[]}},this.abort=function(){T=!0},this.getCharIndex=function(){return g}}function N(y){var x=y.data,D=c[x.workerId],M=!1;if(x.error)D.userError(x.error,x.file);else if(x.results&&x.results.data){var X={abort:function(){M=!0,j(x.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:E,resume:E};if(L(D.userStep)){for(var H=0;H<x.results.data.length&&(D.userStep({data:x.results.data[H],errors:x.results.errors,meta:x.results.meta},X),!M);H++);delete x.results}else L(D.userChunk)&&(D.userChunk(x.results,X,x.file),delete x.results)}x.finished&&!M&&j(x.workerId,x.results)}function j(y,x){var D=c[y];L(D.userComplete)&&D.userComplete(x),D.terminate(),delete c[y]}function E(){throw new Error("Not implemented.")}function A(y){if(typeof y!="object"||y===null)return y;var x,D=Array.isArray(y)?[]:{};for(x in y)D[x]=A(y[x]);return D}function C(y,x){return function(){y.apply(x,arguments)}}function L(y){return typeof y=="function"}return d.parse=function(y,x){var D=(x=x||{}).dynamicTyping||!1;if(L(D)&&(x.dynamicTypingFunction=D,D={}),x.dynamicTyping=D,x.transform=!!L(x.transform)&&x.transform,!x.worker||!d.WORKERS_SUPPORTED)return D=null,d.NODE_STREAM_INPUT,typeof y=="string"?(y=(M=>M.charCodeAt(0)!==65279?M:M.slice(1))(y),D=new(x.download?m:_)(x)):y.readable===!0&&L(y.read)&&L(y.on)?D=new v(x):(a.File&&y instanceof File||y instanceof Object)&&(D=new f(x)),D.stream(y);(D=(()=>{var M;return!!d.WORKERS_SUPPORTED&&(M=(()=>{var X=a.URL||a.webkitURL||null,H=n.toString();return d.BLOB_URL||(d.BLOB_URL=X.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",H,")();"],{type:"text/javascript"})))})(),(M=new a.Worker(M)).onmessage=N,M.id=u++,c[M.id]=M)})()).userStep=x.step,D.userChunk=x.chunk,D.userComplete=x.complete,D.userError=x.error,x.step=L(x.step),x.chunk=L(x.chunk),x.complete=L(x.complete),x.error=L(x.error),delete x.worker,D.postMessage({input:y,config:x,workerId:D.id})},d.unparse=function(y,x){var D=!1,M=!0,X=",",H=`\r
`,U='"',G=U+U,te=!1,re=null,S=!1,g=((()=>{if(typeof x=="object"){if(typeof x.delimiter!="string"||d.BAD_DELIMITERS.filter(function(ee){return x.delimiter.indexOf(ee)!==-1}).length||(X=x.delimiter),typeof x.quotes!="boolean"&&typeof x.quotes!="function"&&!Array.isArray(x.quotes)||(D=x.quotes),typeof x.skipEmptyLines!="boolean"&&typeof x.skipEmptyLines!="string"||(te=x.skipEmptyLines),typeof x.newline=="string"&&(H=x.newline),typeof x.quoteChar=="string"&&(U=x.quoteChar),typeof x.header=="boolean"&&(M=x.header),Array.isArray(x.columns)){if(x.columns.length===0)throw new Error("Option columns is empty");re=x.columns}x.escapeChar!==void 0&&(G=x.escapeChar+U),x.escapeFormulae instanceof RegExp?S=x.escapeFormulae:typeof x.escapeFormulae=="boolean"&&x.escapeFormulae&&(S=/^[=+\-@\t\r].*$/)}})(),new RegExp(b(U),"g"));if(typeof y=="string"&&(y=JSON.parse(y)),Array.isArray(y)){if(!y.length||Array.isArray(y[0]))return T(null,y,te);if(typeof y[0]=="object")return T(re||Object.keys(y[0]),y,te)}else if(typeof y=="object")return typeof y.data=="string"&&(y.data=JSON.parse(y.data)),Array.isArray(y.data)&&(y.fields||(y.fields=y.meta&&y.meta.fields||re),y.fields||(y.fields=Array.isArray(y.data[0])?y.fields:typeof y.data[0]=="object"?Object.keys(y.data[0]):[]),Array.isArray(y.data[0])||typeof y.data[0]=="object"||(y.data=[y.data])),T(y.fields||[],y.data||[],te);throw new Error("Unable to serialize unrecognized input");function T(ee,R,K){var F="",xe=(typeof ee=="string"&&(ee=JSON.parse(ee)),typeof R=="string"&&(R=JSON.parse(R)),Array.isArray(ee)&&0<ee.length),ve=!Array.isArray(R[0]);if(xe&&M){for(var de=0;de<ee.length;de++)0<de&&(F+=X),F+=q(ee[de],de);0<R.length&&(F+=H)}for(var me=0;me<R.length;me++){var ge=(xe?ee:R[me]).length,pe=!1,se=xe?Object.keys(R[me]).length===0:R[me].length===0;if(K&&!xe&&(pe=K==="greedy"?R[me].join("").trim()==="":R[me].length===1&&R[me][0].length===0),K==="greedy"&&xe){for(var I=[],W=0;W<ge;W++){var ce=ve?ee[W]:W;I.push(R[me][ce])}pe=I.join("").trim()===""}if(!pe){for(var Z=0;Z<ge;Z++){0<Z&&!se&&(F+=X);var Ae=xe&&ve?ee[Z]:Z;F+=q(R[me][Ae],Z)}me<R.length-1&&(!K||0<ge&&!se)&&(F+=H)}}return F}function q(ee,R){var K,F;return ee==null?"":ee.constructor===Date?JSON.stringify(ee).slice(1,25):(F=!1,S&&typeof ee=="string"&&S.test(ee)&&(ee="'"+ee,F=!0),K=ee.toString().replace(g,G),(F=F||D===!0||typeof D=="function"&&D(ee,R)||Array.isArray(D)&&D[R]||((xe,ve)=>{for(var de=0;de<ve.length;de++)if(-1<xe.indexOf(ve[de]))return!0;return!1})(K,d.BAD_DELIMITERS)||-1<K.indexOf(X)||K.charAt(0)===" "||K.charAt(K.length-1)===" ")?U+K+U:K)}},d.RECORD_SEP="",d.UNIT_SEP="",d.BYTE_ORDER_MARK="\uFEFF",d.BAD_DELIMITERS=["\r",`
`,'"',d.BYTE_ORDER_MARK],d.WORKERS_SUPPORTED=!o&&!!a.Worker,d.NODE_STREAM_INPUT=1,d.LocalChunkSize=10485760,d.RemoteChunkSize=5242880,d.DefaultDelimiter=",",d.Parser=P,d.ParserHandle=w,d.NetworkStreamer=m,d.FileStreamer=f,d.StringStreamer=_,d.ReadableStreamStreamer=v,a.jQuery&&((s=a.jQuery).fn.parse=function(y){var x=y.config||{},D=[];return this.each(function(H){if(!(s(this).prop("tagName").toUpperCase()==="INPUT"&&s(this).attr("type").toLowerCase()==="file"&&a.FileReader)||!this.files||this.files.length===0)return!0;for(var U=0;U<this.files.length;U++)D.push({file:this.files[U],inputElem:this,instanceConfig:s.extend({},x)})}),M(),this;function M(){if(D.length===0)L(y.complete)&&y.complete();else{var H,U,G,te,re=D[0];if(L(y.before)){var S=y.before(re.file,re.inputElem);if(typeof S=="object"){if(S.action==="abort")return H="AbortError",U=re.file,G=re.inputElem,te=S.reason,void(L(y.error)&&y.error({name:H},U,G,te));if(S.action==="skip")return void X();typeof S.config=="object"&&(re.instanceConfig=s.extend(re.instanceConfig,S.config))}else if(S==="skip")return void X()}var g=re.instanceConfig.complete;re.instanceConfig.complete=function(T){L(g)&&g(T,re.file,re.inputElem),X()},d.parse(re.file,re.instanceConfig)}}function X(){D.splice(0,1),M()}}),i&&(a.onmessage=function(y){y=y.data,d.WORKER_ID===void 0&&y&&(d.WORKER_ID=y.workerId),typeof y.input=="string"?a.postMessage({workerId:d.WORKER_ID,results:d.parse(y.input,y.config),finished:!0}):(a.File&&y.input instanceof File||y.input instanceof Object)&&(y=d.parse(y.input,y.config))&&a.postMessage({workerId:d.WORKER_ID,results:y,finished:!0})}),(m.prototype=Object.create(p.prototype)).constructor=m,(f.prototype=Object.create(p.prototype)).constructor=f,(_.prototype=Object.create(_.prototype)).constructor=_,(v.prototype=Object.create(p.prototype)).constructor=v,d})}(Ao)),Ao.exports}var Vv=Yv();const Un=st(Vv),Wp=async()=>{try{const t=await B.get("/api/business-profile");return{city:t.data.city||"",province:t.data.province||"",country:t.data.country||""}}catch(t){return console.error("Error fetching business profile:",t),{city:"",province:"",country:""}}};function fi(t,r){const[n,a]=l.useState(t);return l.useEffect(()=>{const s=setTimeout(()=>{a(t)},r);return()=>{clearTimeout(s)}},[t,r]),n}const yd={customer_id:"",customer_name:"",contact_person:"",email:"",phone_number:"",street_address:"",city:"",province:"",country:"",postal_code:"",website:"",general_notes:""},xi=({open:t,onClose:r,onSave:n,initialCustomer:a,isEditMode:s=!1,loading:o=!1,onUseExisting:i})=>{const[c,u]=l.useState(yd),[d,p]=l.useState(null),[m,f]=l.useState({}),_=fi(c,300),[v,w]=l.useState([]),[b,P]=l.useState(null),[N,j]=l.useState([]),[E,A]=l.useState([]),[C,L]=l.useState([]),[y,x]=l.useState(""),[D,M]=l.useState(""),[X,H]=l.useState(""),[U,G]=l.useState(""),te=async()=>{try{const I=await Wp();u(W=>({...W,city:I.city,province:I.province,country:I.country}))}catch(I){console.error("Error autofilling from business profile:",I)}};l.useEffect(()=>{if(t){const I={...yd,...a};u(I),p(null),(async()=>{try{const ce=await B.get("/api/customers");w(ce.data||[])}catch{}})(),!s&&(!a?.city||a.city==="")&&(!a?.province||a.province==="")&&(!a?.country||a.country==="")&&te();const W=a?.customer_id;s&&W?(async()=>{try{const ce=await xd(W);j(ce.people||[]),A(ce.emails||[]),L(ce.phones||[])}catch{}})():(j([]),A([]),L([]))}},[t,a,s]);const re=I=>{const{name:W,value:ce}=I.target;u(Z=>({...Z,[W]:ce})),m[W]&&f(Z=>({...Z,[W]:void 0}))},S=()=>c.customer_name.trim()?(p(null),!0):(p("Customer name is required"),!1),g=()=>{S()&&n(c)},T=I=>I.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim().toUpperCase(),q=(I,W)=>{const ce=Math.floor(Math.max(I.length,W.length)/2)-1;if(ce<0)return 0;const Z=new Array(I.length).fill(!1),Ae=new Array(W.length).fill(!1);let Ce=0;for(let Be=0;Be<I.length;Be++){const wt=Math.max(0,Be-ce),zt=Math.min(Be+ce+1,W.length);for(let Bt=wt;Bt<zt;Bt++)if(!Ae[Bt]&&I[Be]===W[Bt]){Z[Be]=!0,Ae[Bt]=!0,Ce++;break}}if(Ce===0)return 0;const ze=[],Ve=[];for(let Be=0;Be<I.length;Be++)Z[Be]&&ze.push(I[Be]);for(let Be=0;Be<W.length;Be++)Ae[Be]&&Ve.push(W[Be]);let ut=0;for(let Be=0;Be<ze.length;Be++)ze[Be]!==Ve[Be]&&ut++;ut=Math.floor(ut/2);const it=(Ce/I.length+Ce/W.length+(Ce-ut)/Ce)/3;let pt=0;const Ne=4;for(let Be=0;Be<Math.min(Ne,I.length,W.length)&&I[Be]===W[Be];Be++)pt++;return it+pt*.1*(1-it)};l.useEffect(()=>{if(!t)return;const I={};_.email&&_.email.trim().length>0&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(_.email.trim())||(I.email="Invalid email format"));let W=null,ce=0;if(_.customer_name&&_.customer_name.trim().length>0){const Z=T(_.customer_name),Ae=(a?.customer_id??_.customer_id)||"";for(const Ce of v){if(String(Ce.customer_id)===String(Ae||""))continue;const Ve=T(Ce.customer_name||""),it=Ve===Z?1:q(Ve,Z);it>ce&&(ce=it,W=Ce)}ce>=.92&&(I.customer_name="A similar customer already exists")}P(ce>=.92&&W?W:null),f(Z=>({...Z,...I}))},[_,t]);const ee=a?.customer_id,R=async()=>{if(!(!s||!ee))try{const I=await xd(ee);j(I.people||[]),A(I.emails||[]),L(I.phones||[])}catch{}},K=async()=>{!ee||!y.trim()||(await Av(ee,{name:y.trim()}),x(""),R())},F=async I=>{ee&&(await Mv(ee,I,{is_preferred:!0}),R())},xe=async I=>{ee&&(await Rv(ee,I),R())},ve=async()=>{!ee||!D.trim()||(await Nv(ee,{email:D.trim()}),M(""),R())},de=async I=>{ee&&(await Lv(ee,I,{is_preferred:!0}),R())},me=async I=>{ee&&(await qv(ee,I),R())},ge=async()=>{!ee||!X.trim()||(await Uv(ee,{phone:X.trim(),label:U.trim()||void 0}),H(""),G(""),R())},pe=async I=>{ee&&(await Fv(ee,I,{is_preferred:!0}),R())},se=async I=>{ee&&(await Wv(ee,I),R())};return e.jsxs(mt,{open:t,onClose:r,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:s?"Edit Customer":"Add New Customer"}),e.jsxs(xt,{children:[e.jsxs(O,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"customer_name",label:"Customer Name",value:c.customer_name,onChange:re,fullWidth:!0,required:!0,error:!!m.customer_name,helperText:m.customer_name,autoFocus:!0})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"contact_person",label:"Contact Person",value:c.contact_person,onChange:re,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"email",label:"Email",type:"email",value:c.email,onChange:re,fullWidth:!0,error:!!m.email,helperText:m.email})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"phone_number",label:"Phone Number",value:c.phone_number,onChange:re,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{name:"street_address",label:"Street Address",value:c.street_address,onChange:re,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"city",label:"City",value:c.city,onChange:re,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"province",label:"Province/State",value:c.province,onChange:re,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"country",label:"Country",value:c.country,onChange:re,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"postal_code",label:"Postal Code",value:c.postal_code,onChange:re,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{name:"website",label:"Website",value:c.website,onChange:re,fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{name:"general_notes",label:"General Notes",value:c.general_notes,onChange:re,fullWidth:!0,multiline:!0,minRows:4})}),s&&ee&&e.jsx(O,{item:!0,xs:12,children:e.jsxs(k,{sx:{mt:2},children:[e.jsx(h,{variant:"h6",sx:{mb:1},children:"Contacts"}),e.jsxs(O,{container:!0,spacing:2,children:[e.jsxs(O,{item:!0,xs:12,md:4,children:[e.jsx(h,{variant:"subtitle1",sx:{mb:1},children:"People"}),e.jsxs(Pe,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(le,{size:"small",label:"Name",value:y,onChange:I=>x(I.target.value),fullWidth:!0}),e.jsx(Q,{variant:"outlined",size:"small",onClick:K,children:"Add"})]}),e.jsxs(Pe,{spacing:1,children:[N.map(I=>e.jsxs(Pe,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(h,{variant:"body2",sx:{flex:1},children:[I.name," ",I.is_preferred?"(Preferred)":""]}),!I.is_preferred&&e.jsx(Q,{size:"small",onClick:()=>F(I.id),children:"Set Preferred"}),e.jsx(Q,{size:"small",color:"error",onClick:()=>xe(I.id),children:"Remove"})]},I.id)),N.length===0&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"No people yet."})]})]}),e.jsxs(O,{item:!0,xs:12,md:4,children:[e.jsx(h,{variant:"subtitle1",sx:{mb:1},children:"Emails"}),e.jsxs(Pe,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(le,{size:"small",label:"Email",value:D,onChange:I=>M(I.target.value),fullWidth:!0}),e.jsx(Q,{variant:"outlined",size:"small",onClick:ve,children:"Add"})]}),e.jsxs(Pe,{spacing:1,children:[E.map(I=>e.jsxs(Pe,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(h,{variant:"body2",sx:{flex:1},children:[I.email," ",I.is_preferred?"(Preferred)":""]}),!I.is_preferred&&e.jsx(Q,{size:"small",onClick:()=>de(I.id),children:"Set Preferred"}),e.jsx(Q,{size:"small",color:"error",onClick:()=>me(I.id),children:"Remove"})]},I.id)),E.length===0&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"No emails yet."})]})]}),e.jsxs(O,{item:!0,xs:12,md:4,children:[e.jsx(h,{variant:"subtitle1",sx:{mb:1},children:"Phones"}),e.jsxs(Pe,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(le,{size:"small",label:"Phone",value:X,onChange:I=>H(I.target.value),fullWidth:!0}),e.jsx(le,{size:"small",label:"Label",value:U,onChange:I=>G(I.target.value),sx:{width:120}}),e.jsx(Q,{variant:"outlined",size:"small",onClick:ge,children:"Add"})]}),e.jsxs(Pe,{spacing:1,children:[C.map(I=>e.jsxs(Pe,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(h,{variant:"body2",sx:{flex:1},children:[I.phone,I.label?` (${I.label})`:""," ",I.is_preferred?"(Preferred)":""]}),!I.is_preferred&&e.jsx(Q,{size:"small",onClick:()=>pe(I.id),children:"Set Preferred"}),e.jsx(Q,{size:"small",color:"error",onClick:()=>se(I.id),children:"Remove"})]},I.id)),C.length===0&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"No phones yet."})]})]})]})]})})]}),d&&e.jsx("div",{style:{color:"red",marginTop:8},children:d}),b&&e.jsxs("div",{style:{marginTop:12},children:[e.jsxs("div",{style:{color:"#b26a00",marginBottom:8},children:['Looks like "',b.customer_name,'" already exists.']}),typeof i=="function"&&e.jsx(Q,{variant:"outlined",size:"small",onClick:()=>{i(b)},children:"Use existing"})]})]}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:r,children:"Cancel"}),e.jsx(Q,{onClick:g,variant:"contained",disabled:o,children:s?"Save Changes":"Add Customer"})]})]})},Gv=()=>{Gt();const[t,r]=l.useState([]),[n,a]=l.useState(""),[s,o]=l.useState(null),[i,c]=l.useState(null),[u,d]=l.useState(!1),[p,m]=l.useState({pageSize:10,page:0}),[f,_]=l.useState(!1);l.useEffect(()=>{v()},[]);const v=async()=>{try{const A=await $v();r(A)}catch(A){console.error("Error fetching customers:",A),z.error("Failed to fetch customers")}},w=async A=>{if(window.confirm("Are you sure you want to delete this customer?"))try{await Bv(A),r(C=>C.filter(L=>L.id!==A)),z.success("Customer deleted successfully")}catch(C){console.error("Error deleting customer:",C),z.error("Failed to delete customer")}},b=A=>{o(A),c({...A}),_(!0),d(!0)},P=()=>{d(!1),o(null),c(null)},N=t.filter(A=>A.customer_name.toLowerCase().includes(n.toLowerCase())||A.email?.toLowerCase().includes(n.toLowerCase())||A.phone_number?.toLowerCase().includes(n.toLowerCase())||`${A.street_address}, ${A.city}, ${A.province}, ${A.country}`.toLowerCase().includes(n.toLowerCase())),j=[{field:"customer_name",headerName:"Customer Name",flex:1.5},{field:"contact_person",headerName:"Contact Person",flex:1},{field:"email",headerName:"Email",flex:1.5},{field:"phone_number",headerName:"Phone Number",flex:1},{field:"actions",headerName:"Actions",width:80,sortable:!1,renderCell:A=>e.jsx(gt,{size:"small",color:"error",onClick:C=>{C.stopPropagation(),w(A.row.id)},children:e.jsx(xr,{})})}],E=()=>{const A=N.map(x=>({customer_name:x.customer_name,contact_person:x.contact_person,email:x.email,phone_number:x.phone_number})),C=Un.unparse(A),L=new Blob([C],{type:"text/csv;charset=utf-8;"}),y=document.createElement("a");if(y.download!==void 0){const x=URL.createObjectURL(L);y.setAttribute("href",x),y.setAttribute("download","customer_list.csv"),y.style.visibility="hidden",document.body.appendChild(y),y.click(),document.body.removeChild(y)}};return e.jsx(nt,{maxWidth:"xl",children:e.jsxs(k,{sx:{my:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Customer List"}),e.jsxs(Pe,{direction:"row",spacing:2,sx:{mb:2,justifyContent:"flex-end"},children:[e.jsx(Q,{variant:"contained",startIcon:e.jsx(Nr,{}),onClick:()=>{c({id:"",customer_id:"",customer_name:"",email:"",phone:"",phone_number:"",address:"",street_address:"",city:"",state:"",province:"",country:"",postal_code:"",contact_person:"",website:"",general_notes:"",created_at:"",updated_at:""}),_(!1),d(!0)},children:"New Customer"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(gr,{}),onClick:E,children:"Export CSV"})]}),e.jsx(Me,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(le,{fullWidth:!0,variant:"outlined",placeholder:"Search customers...",value:n,onChange:A=>a(A.target.value),InputProps:{startAdornment:e.jsx(mr,{position:"start",children:e.jsx(Hr,{})})},sx:{mb:2}}),e.jsx(tn,{rows:N,columns:j,pageSizeOptions:[10,25,50],paginationModel:p,onPaginationModelChange:m,getRowId:A=>A.id,loading:!1,disableRowSelectionOnClick:!0,onRowClick:A=>b(A.row),sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})}),e.jsx(xi,{open:u,onClose:P,onSave:async A=>{try{if(f&&i)await Fp(i.id,A),r(C=>C.map(L=>L.id===i.id?{...L,...A}:L)),z.success("Customer updated successfully");else{const C=await Up(A);r(L=>[...L,C]),z.success("Customer created successfully")}P()}catch(C){console.error("Error saving customer:",C),z.error(f?"Failed to update customer":"Failed to create customer")}},initialCustomer:i||{},isEditMode:f})]})})},Qv=()=>{const{id:t}=jn(),r=Gt(),n=t==="new";console.log("Debug - URL id parameter:",t),console.log("Debug - isNewCustomer calculated:",n);const[a,s]=l.useState(!1),[o,i]=l.useState(!1),[c,u]=l.useState(null),[d,p]=l.useState(!1),[m,f]=l.useState({customer_name:"",email:"",phone_number:"",street_address:"",city:"",province:"",country:"",postal_code:"",contact_person:"",website:"",general_notes:""});l.useEffect(()=>{!n&&t?_():n&&p(!0)},[t,n]);const _=async()=>{s(!0);try{if(!t)throw new Error("Customer ID is required");const w=await zv(t);f(w)}catch(w){console.error("Error fetching customer:",w),u("Failed to load customer data"),z.error("Failed to load customer data")}finally{s(!1)}},v=()=>{r("/customers")};return a?e.jsx(nt,{maxWidth:"md",children:e.jsx(k,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh"},children:e.jsx(ot,{})})}):e.jsx(nt,{maxWidth:"md",children:e.jsxs(k,{sx:{my:4},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",mb:3},children:[e.jsx(Q,{startIcon:e.jsx(Au,{}),onClick:v,sx:{mr:2},children:"Back to Customers"}),e.jsx(h,{variant:"h4",component:"h1",children:n?"Add New Customer":"Edit Customer"})]}),c&&e.jsx(Fe,{severity:"error",sx:{mb:2},children:c}),e.jsx(xi,{open:d,onClose:()=>{p(!1),v()},onSave:async w=>{i(!0);try{n?(await Up(w),z.success("Customer created successfully")):(await Fp(t,w),z.success("Customer updated successfully")),r("/customers")}catch{z.error("Failed to save customer")}finally{i(!1)}},initialCustomer:n?{}:m,isEditMode:!n,loading:o})]})})},Kv=async()=>(await B.get("/api/vendors")).data,vd=async t=>(await B.get(`/api/vendors/${t}/contacts`)).data,Jv=async(t,r)=>(await B.post(`/api/vendors/${t}/contacts/people`,r)).data,Xv=async(t,r,n)=>(await B.put(`/api/vendors/${t}/contacts/people/${r}`,n)).data,Zv=async(t,r)=>(await B.delete(`/api/vendors/${t}/contacts/people/${r}`)).data,eb=async(t,r)=>(await B.post(`/api/vendors/${t}/contacts/emails`,r)).data,tb=async(t,r,n)=>(await B.put(`/api/vendors/${t}/contacts/emails/${r}`,n)).data,rb=async(t,r)=>(await B.delete(`/api/vendors/${t}/contacts/emails/${r}`)).data,nb=async(t,r)=>(await B.post(`/api/vendors/${t}/contacts/phones`,r)).data,sb=async(t,r,n)=>(await B.put(`/api/vendors/${t}/contacts/phones/${r}`,n)).data,ab=async(t,r)=>(await B.delete(`/api/vendors/${t}/contacts/phones/${r}`)).data,bd={vendor_name:"",street_address:"",city:"",province:"",country:"",postal_code:"",contact_person:"",telephone_number:"",email:"",website:""},$p=({open:t,onClose:r,onSave:n,initialVendor:a,isEditMode:s=!1,loading:o=!1})=>{const[i,c]=l.useState(bd),[u,d]=l.useState({}),p=fi(i,300),[m,f]=l.useState([]),[_,v]=l.useState([]),[w,b]=l.useState([]),[P,N]=l.useState([]),[j,E]=l.useState(""),[A,C]=l.useState(""),[L,y]=l.useState(""),[x,D]=l.useState("");l.useEffect(()=>{if(t){console.log("UnifiedVendorDialog: Setting vendor with initialVendor:",a);const F={...bd,...a};c(F),!s&&!a?.city&&!a?.province&&!a?.country&&H(),(async()=>{try{const ve=await B.get("/api/vendors");f(ve.data||[])}catch{}})();const xe=a?.vendor_id;s&&xe?(async()=>{try{const ve=await vd(xe);v(ve.people||[]),b(ve.emails||[]),N(ve.phones||[])}catch{}})():(v([]),b([]),N([]))}},[t,a,s]);const M=F=>{const{name:xe,value:ve}=F.target;c(de=>({...de,[xe]:ve})),u[xe]&&d(de=>({...de,[xe]:void 0}))},X=()=>{n(i)};l.useEffect(()=>{if(!t)return;const F={};if(p.email&&p.email.trim().length>0&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p.email.trim())||(F.email="Invalid email format")),p.vendor_name&&p.vendor_name.trim().length>0){const xe=p.vendor_name.trim().toLowerCase();m.some(de=>(de.vendor_name||"").trim().toLowerCase()===xe)&&!s&&(F.vendor_name="Vendor name already exists")}d(xe=>({...xe,...F}))},[p,t,s,m]);const H=async()=>{try{const F=await Wp();c(xe=>({...xe,city:F.city,province:F.province,country:F.country})),console.log("Autofilled vendor form with business profile data:",F)}catch(F){console.error("Error autofilling from business profile:",F)}},U=a?.vendor_id,G=async()=>{if(!(!s||!U))try{const F=await vd(U);v(F.people||[]),b(F.emails||[]),N(F.phones||[])}catch{}},te=async()=>{!U||!j.trim()||(await Jv(U,{name:j.trim()}),E(""),G())},re=async F=>{U&&(await Xv(U,F,{is_preferred:!0}),G())},S=async F=>{U&&(await Zv(U,F),G())},g=async()=>{!U||!A.trim()||(await eb(U,{email:A.trim()}),C(""),G())},T=async F=>{U&&(await tb(U,F,{is_preferred:!0}),G())},q=async F=>{U&&(await rb(U,F),G())},ee=async()=>{!U||!L.trim()||(await nb(U,{phone:L.trim(),label:x.trim()||void 0}),y(""),D(""),G())},R=async F=>{U&&(await sb(U,F,{is_preferred:!0}),G())},K=async F=>{U&&(await ab(U,F),G())};return e.jsxs(mt,{open:t,onClose:r,maxWidth:"md",fullWidth:!0,sx:{zIndex:F=>F.zIndex.modal+5},children:[e.jsx(ft,{children:s?"Edit Vendor":"Add New Vendor"}),e.jsx(xt,{sx:{form:{autoComplete:"off"}},children:e.jsxs(O,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"vendor_name",label:"Vendor Name",value:i.vendor_name,onChange:M,fullWidth:!0,required:!0,error:!!u.vendor_name,helperText:u.vendor_name,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"contact_person",label:"Contact Person",value:i.contact_person,onChange:M,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"email",label:"Email",type:"email",value:i.email,onChange:M,fullWidth:!0,error:!!u.email,helperText:u.email,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"telephone_number",label:"Telephone",value:i.telephone_number,onChange:M,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{name:"street_address",label:"Street Address",value:i.street_address,onChange:M,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"city",label:"City",value:i.city,onChange:M,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"province",label:"Province/State",value:i.province,onChange:M,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"country",label:"Country",value:i.country,onChange:M,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"postal_code",label:"Postal Code",value:i.postal_code,onChange:M,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{name:"website",label:"Website",value:i.website,onChange:M,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),s&&U&&e.jsx(O,{item:!0,xs:12,children:e.jsxs(k,{sx:{mt:2},children:[e.jsx(h,{variant:"h6",sx:{mb:1},children:"Contacts"}),e.jsxs(O,{container:!0,spacing:2,children:[e.jsxs(O,{item:!0,xs:12,md:4,children:[e.jsx(h,{variant:"subtitle1",sx:{mb:1},children:"People"}),e.jsxs(Pe,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(le,{size:"small",label:"Name",value:j,onChange:F=>E(F.target.value),fullWidth:!0}),e.jsx(Q,{variant:"outlined",size:"small",onClick:te,children:"Add"})]}),e.jsxs(Pe,{spacing:1,children:[_.map(F=>e.jsxs(Pe,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(h,{variant:"body2",sx:{flex:1},children:[F.name," ",F.is_preferred?"(Preferred)":""]}),!F.is_preferred&&e.jsx(Q,{size:"small",onClick:()=>re(F.id),children:"Set Preferred"}),e.jsx(Q,{size:"small",color:"error",onClick:()=>S(F.id),children:"Remove"})]},F.id)),_.length===0&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"No people yet."})]})]}),e.jsxs(O,{item:!0,xs:12,md:4,children:[e.jsx(h,{variant:"subtitle1",sx:{mb:1},children:"Emails"}),e.jsxs(Pe,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(le,{size:"small",label:"Email",value:A,onChange:F=>C(F.target.value),fullWidth:!0}),e.jsx(Q,{variant:"outlined",size:"small",onClick:g,children:"Add"})]}),e.jsxs(Pe,{spacing:1,children:[w.map(F=>e.jsxs(Pe,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(h,{variant:"body2",sx:{flex:1},children:[F.email," ",F.is_preferred?"(Preferred)":""]}),!F.is_preferred&&e.jsx(Q,{size:"small",onClick:()=>T(F.id),children:"Set Preferred"}),e.jsx(Q,{size:"small",color:"error",onClick:()=>q(F.id),children:"Remove"})]},F.id)),w.length===0&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"No emails yet."})]})]}),e.jsxs(O,{item:!0,xs:12,md:4,children:[e.jsx(h,{variant:"subtitle1",sx:{mb:1},children:"Phones"}),e.jsxs(Pe,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(le,{size:"small",label:"Phone",value:L,onChange:F=>y(F.target.value),fullWidth:!0}),e.jsx(le,{size:"small",label:"Label",value:x,onChange:F=>D(F.target.value),sx:{width:120}}),e.jsx(Q,{variant:"outlined",size:"small",onClick:ee,children:"Add"})]}),e.jsxs(Pe,{spacing:1,children:[P.map(F=>e.jsxs(Pe,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(h,{variant:"body2",sx:{flex:1},children:[F.phone,F.label?` (${F.label})`:""," ",F.is_preferred?"(Preferred)":""]}),!F.is_preferred&&e.jsx(Q,{size:"small",onClick:()=>R(F.id),children:"Set Preferred"}),e.jsx(Q,{size:"small",color:"error",onClick:()=>K(F.id),children:"Remove"})]},F.id)),P.length===0&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"No phones yet."})]})]})]})]})})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:r,children:"Cancel"}),e.jsx(Q,{onClick:X,variant:"contained",disabled:o,children:s?"Save Changes":"Add Vendor"})]})]})},ob=()=>{const[t,r]=l.useState(""),[n,a]=l.useState([]),[s,o]=l.useState(!1),[i,c]=l.useState({page:0,pageSize:10}),[u,d]=l.useState(!1),[p,m]=l.useState(!1),[f,_]=l.useState({}),v=n.filter(A=>(A.vendor_name||"").toLowerCase().includes(t.toLowerCase())||(A.contact_person||"").toLowerCase().includes(t.toLowerCase())||(A.email||"").toLowerCase().includes(t.toLowerCase())),w=[{field:"vendor_name",headerName:"Vendor Name",flex:1.5},{field:"contact_person",headerName:"Contact Person",flex:1},{field:"email",headerName:"Email",flex:1.5},{field:"telephone_number",headerName:"Phone Number",flex:1},{field:"actions",headerName:"Actions",width:100,sortable:!1,renderCell:A=>e.jsx(gt,{size:"small",color:"error",onClick:C=>{C.stopPropagation(),j(A.row.vendor_id)},children:e.jsx(xr,{})})}],b=async()=>{o(!0);try{const C=(await Kv()).map(L=>({...L,id:L.vendor_id}));a(C)}catch{z.error("Failed to fetch vendors.")}finally{o(!1)}};l.useEffect(()=>{b()},[]);const P=(A=null)=>{A?(m(!0),_(A)):(m(!1),_({vendor_name:"",street_address:"",city:"",province:"",country:"",contact_person:"",telephone_number:"",email:"",website:"",postal_code:""})),d(!0)},N=()=>{d(!1),_({})},j=async A=>{if(window.confirm("Are you sure you want to delete this vendor?"))try{await B.delete(`/api/vendors/${A}`),z.success("Vendor deleted successfully!"),b()}catch(C){C instanceof _r?z.error(C.response?.data?.error||"Failed to delete vendor."):z.error("An unexpected error occurred while deleting the vendor.")}},E=()=>{const A=Un.unparse(v),C=new Blob([A],{type:"text/csv;charset=utf-8;"}),L=document.createElement("a");if(L.download!==void 0){const y=URL.createObjectURL(C);L.setAttribute("href",y),L.setAttribute("download","vendor_list.csv"),L.style.visibility="hidden",document.body.appendChild(L),L.click(),document.body.removeChild(L)}};return e.jsxs(nt,{maxWidth:"xl",children:[e.jsxs(k,{sx:{my:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Vendor Management"}),e.jsxs(Pe,{direction:"row",spacing:2,sx:{mb:2,justifyContent:"flex-end"},children:[e.jsx(Q,{variant:"contained",startIcon:e.jsx(Nr,{}),onClick:()=>P(),children:"New Vendor"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(gr,{}),onClick:E,children:"Export CSV"})]}),e.jsx(Me,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2,width:"100%"},children:[e.jsx(le,{fullWidth:!0,variant:"outlined",placeholder:"Search vendors...",value:t,onChange:A=>r(A.target.value),InputProps:{startAdornment:e.jsx(mr,{position:"start",children:e.jsx(Hr,{})})},sx:{mb:2}}),e.jsx(tn,{rows:v,columns:w,loading:s,paginationModel:i,onPaginationModelChange:c,pageSizeOptions:[10,25,50],getRowId:A=>A.vendor_id,onRowClick:A=>P(A.row),disableRowSelectionOnClick:!0,sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]}),e.jsx($p,{open:u,onClose:N,onSave:async A=>{try{p?(await B.put(`/api/vendors/${f.vendor_id}`,A),z.success("Vendor updated successfully!")):(await B.post("/api/vendors",A),z.success("Vendor added successfully!")),N(),b()}catch(C){C instanceof _r?z.error(C.response?.data?.error||`Failed to ${p?"update":"add"} vendor.`):z.error(`An unexpected error occurred while ${p?"updating":"adding"} the vendor.`)}},initialVendor:f,isEditMode:p})]})},ib=()=>{const{id:t}=jn();return e.jsx(nt,{maxWidth:"md",children:e.jsxs(k,{sx:{my:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Vendor Detail Page"}),e.jsxs(Me,{sx:{p:3},children:[e.jsxs(h,{variant:"h6",children:["Vendor ID: ",t]}),e.jsx(h,{variant:"body1",children:"This is a placeholder for the Vendor Detail Page."})]})]})})},lb=()=>{const{id:t}=jn();return e.jsx(nt,{maxWidth:"md",children:e.jsxs(k,{sx:{my:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Product Detail Page"}),e.jsxs(Me,{sx:{p:3},children:[e.jsxs(h,{variant:"h6",children:["Product ID: ",t]}),e.jsx(h,{variant:"body1",children:"This is a placeholder for the Product Detail Page."})]})]})})};var _a={},_d;function cb(){if(_d)return _a;_d=1;var t=vt();Object.defineProperty(_a,"__esModule",{value:!0}),_a.default=void 0;var r=t(_t()),n=bt();return _a.default=(0,r.default)((0,n.jsx)("path",{d:"M5 20h14v-2H5zm0-10h4v6h6v-6h4l-7-7z"}),"Upload"),_a}var db=cb();const zp=st(db),Bp=async t=>{const r=t?{partType:t}:{};return(await B.get("/api/inventory",{params:r})).data},ub=async()=>Bp("stock"),pb=async()=>Bp("supply"),hb=async t=>(await B.get(`/api/inventory/${encodeURIComponent(t)}`)).data,mb=async t=>(await B.post("/api/inventory/cleanup-enforce",{partType:t,apply:!1})).data,Hp=async(t,r)=>(await B.post("/api/inventory/cleanup-enforce",{partType:t,apply:!0,merges:r})).data,Mo=async t=>(await B.get(`/api/inventory/${encodeURIComponent(t)}/vendors`)).data,yo=async t=>(await B.get(`/api/inventory/part/${t}/vendors`)).data,fb=async(t,r)=>(await B.post(`/api/inventory/${encodeURIComponent(t)}/vendors`,r)).data,xb=async(t,r)=>(await B.post(`/api/inventory/part/${t}/vendors`,r)).data,gb=async(t,r,n)=>(await B.put(`/api/inventory/${encodeURIComponent(t)}/vendors/${r}`,n)).data,yb=async(t,r,n)=>(await B.put(`/api/inventory/part/${t}/vendors/${r}`,n)).data,vb=async(t,r)=>(await B.delete(`/api/inventory/${encodeURIComponent(t)}/vendors/${r}`)).data,bb=async(t,r)=>(await B.delete(`/api/inventory/part/${t}/vendors/${r}`)).data,_b=async()=>(await B.get("/api/categories")).data,jb=async t=>(await B.post("/api/categories",t)).data.category,jd=async(t,r)=>{const n=r?{reassign:"true"}:{};await B.delete(`/api/categories/${t}`,{params:n})},$i="__ADD_NEW_CATEGORY__",wb=({value:t,onChange:r,label:n="Category",error:a,errorMessage:s,fullWidth:o=!0,disabled:i})=>{const[c,u]=l.useState([]),[d,p]=l.useState(!1),[m,f]=l.useState(!1),[_,v]=l.useState(""),[w,b]=l.useState(""),[P,N]=l.useState(!1),{user:j}=er();l.useEffect(()=>{let y=!0;return(async()=>{p(!0);try{const D=await _b();y&&u(D)}catch(D){console.error("CategorySelect: failed to load categories",D),z.error("Failed to load categories")}finally{y&&p(!1)}})(),()=>{y=!1}},[]);const E=l.useMemo(()=>{const y=c.map(x=>x.category_name);return y.some(x=>x.toLowerCase()==="uncategorized")||y.unshift("Uncategorized"),y.sort((x,D)=>x.localeCompare(D))},[c]),A=y=>{const x=y.target.value;if(x===$i){f(!0);return}r(x)},C=async(y,x)=>{if(x?.preventDefault(),x?.stopPropagation(),y.category_name.toLowerCase()==="uncategorized"){z.warn('Cannot delete the default "Uncategorized" category');return}if(j?.access_role!=="Admin"){z.error("Only Admin users can delete categories");return}if(window.confirm(`Delete category "${y.category_name}"? This cannot be undone.`))try{await jd(y.category_id),u(M=>M.filter(X=>X.category_id!==y.category_id)),t&&t.toLowerCase()===y.category_name.toLowerCase()&&r("Uncategorized"),z.success("Category deleted")}catch(M){const X=M?.response?.data;if(X?.error==="Cannot delete category"&&X?.suggestion){if(window.confirm(`${X.details}

${X.suggestion}

Would you like to reassign all items to "Uncategorized" and delete the category?`))try{await jd(y.category_id,!0),u(U=>U.filter(G=>G.category_id!==y.category_id)),t&&t.toLowerCase()===y.category_name.toLowerCase()&&r("Uncategorized"),z.success(X.details?`Category deleted. ${X.details}`:"Category deleted")}catch(U){const G=U?.response?.data?.error||"Failed to delete category";z.error(G)}}else{const H=X?.error||"Failed to delete category";z.error(H)}}},L=async()=>{const y=_.trim();if(!y){z.warn("Please enter a category name");return}if(E.some(x=>x.toLowerCase()===y.toLowerCase())){z.warn("Category already exists");return}N(!0);try{const x=w.trim(),D=await jb({category_name:y,description:x||void 0});u(M=>[...M,D]),f(!1),v(""),b(""),r(D.category_name),z.success("Category added")}catch(x){console.error("CategorySelect: failed to create category",x),z.error("Failed to add category")}finally{N(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(le,{label:n,value:t,onChange:A,select:!0,fullWidth:o,required:!0,error:!!a,helperText:s,disabled:i||d,children:[c.slice().sort((y,x)=>y.category_name.localeCompare(x.category_name)).map(y=>e.jsxs(Ze,{value:y.category_name,sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:y.category_name}),j?.access_role==="Admin"&&y.category_name.toLowerCase()!=="uncategorized"&&e.jsx(gt,{"aria-label":`Delete ${y.category_name}`,size:"small",edge:"end",onClick:x=>C(y,x),sx:{ml:2,color:"error.main"},children:e.jsx(xr,{fontSize:"small"})})]},y.category_id)),e.jsx(Ze,{value:$i,children:"+ Add new category"},$i)]}),e.jsxs(mt,{open:m,onClose:()=>f(!1),maxWidth:"xs",fullWidth:!0,children:[e.jsx(ft,{children:"Add New Category"}),e.jsx(xt,{children:e.jsxs(Pe,{spacing:2,sx:{mt:1},children:[e.jsx(le,{label:"Category Name",value:_,onChange:y=>v(y.target.value),autoFocus:!0,fullWidth:!0}),e.jsx(le,{label:"Description (optional)",value:w,onChange:y=>b(y.target.value),fullWidth:!0,multiline:!0,minRows:2})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>f(!1),disabled:P,children:"Cancel"}),e.jsx(Q,{onClick:L,variant:"contained",disabled:P,children:"Save"})]})]})]})},zi=["Each","cm","ft","kg","pcs","L"],Sb=["stock","supply"],ns=({open:t,onClose:r,onSave:n,initialPart:a,isEditMode:s=!1,title:o})=>{const{user:i}=er(),[c,u]=l.useState({part_number:"",part_description:"",unit:zi[0],last_unit_cost:"",quantity_on_hand:"",reorder_point:"",part_type:"stock",category:"Uncategorized",...a||{}}),[d,p]=l.useState({}),[m,f]=l.useState(!1),_=l.useRef(null);l.useEffect(()=>{t&&(u({part_id:a?.part_id,part_number:a?.part_number||"",part_description:a?.part_description||"",unit:a?.unit||zi[0],last_unit_cost:a?.last_unit_cost||"",quantity_on_hand:a?.quantity_on_hand||"",reorder_point:a?.reorder_point||"",part_type:a?.part_type||"stock",category:a?.category||"Uncategorized"}),p({}),f(!1))},[t,a?.part_id,a?.part_number]),l.useEffect(()=>{t&&_.current&&setTimeout(()=>_.current?.focus(),100)},[t]);const v=(g,T)=>{g==="part_number"&&(T=T.toUpperCase()),u(g==="part_type"&&T==="supply"?q=>({...q,[g]:T,quantity_on_hand:"NA"}):q=>({...q,[g]:T})),d[g]&&p(q=>({...q,[g]:void 0}))},w=()=>{const g={};c.part_number.trim()||(g.part_number="Part Number is required"),c.part_number&&/\s/.test(c.part_number)&&(g.part_number="Part Number cannot contain spaces"),c.part_number&&!/^[A-Z0-9()\/-]+$/.test(c.part_number)&&(g.part_number="Only letters/numbers and - / ( ) are allowed");const T=c.part_number;if(T&&T.includes("/")&&((()=>{const K=[];for(let me=0;me<T.length;me++)T[me]==="/"&&K.push(me);if(K.length===0)return!0;const F=new Array(T.length).fill(-1);let xe=-1;for(let me=0;me<T.length;me++)T[me]==="("&&(xe=me),F[me]=xe;const ve=new Array(T.length).fill(-1);let de=-1;for(let me=T.length-1;me>=0;me--)T[me]===")"&&(de=me),ve[me]=de;return K.every(me=>F[me]!==-1&&ve[me]!==-1&&F[me]<me&&me<ve[me])})()||(g.part_number="Fractions must be enclosed in parentheses, e.g., (1/2)")),c.part_description.trim()||(g.part_description="Part Description is required"),c.unit||(g.unit="Unit is required"),c.part_type||(g.part_type="Part Type is required"),["stock","supply"].includes(c.part_type)||(g.part_type='Part Type must be either "stock" or "supply"'),(!c.category||c.category.trim()==="")&&(g.category="Category is required"),c.part_type!=="supply"){const R=parseFloat(String(c.quantity_on_hand));c.quantity_on_hand!==""&&(isNaN(R)||R<0)&&(g.quantity_on_hand="Quantity on Hand must be a valid number >= 0")}const q=parseFloat(String(c.last_unit_cost));c.last_unit_cost!==""&&isNaN(q)&&(g.last_unit_cost="Last Unit Cost must be a valid number");const ee=parseFloat(String(c.reorder_point));return c.reorder_point!==""&&isNaN(ee)&&(g.reorder_point="Reorder Point must be a valid number"),p(g),Object.keys(g).length===0},b=async()=>{if(!w()){z.error("Please correct the errors before saving.");return}f(!0);try{const g={...c,part_number:c.part_number.trim().toUpperCase(),part_description:c.part_description.trim(),unit:c.unit.trim(),last_unit_cost:c.last_unit_cost===""?null:parseFloat(String(c.last_unit_cost)),quantity_on_hand:c.part_type==="supply"?"NA":c.quantity_on_hand===""?0:parseFloat(String(c.quantity_on_hand)),reorder_point:c.reorder_point===""?null:parseFloat(String(c.reorder_point)),part_type:c.part_type.trim(),category:c.category.trim()};await n(g),z.success(`Part ${s?"updated":"added"} successfully!`),r()}catch(g){console.error("Error saving part:",g);let T=`Failed to ${s?"update":"add"} part.`;g.response?.data?.error?T=g.response.data.error:g.response?.data?.message&&(T=g.response.data.message),g.response?.status===409||T.includes("Part number already exists")||T.includes("duplicate key value")||T.includes("already exists")?(p(q=>({...q,part_number:"Part number already exists. Please use a unique part number."})),z.error("Part number already exists. Please use a unique part number.")):z.error(T)}finally{f(!1)}},P=()=>{m||r()},N=o||(s?"Edit Part":"Add New Part"),[j,E]=l.useState([]),[A,C]=l.useState([]),[L,y]=l.useState(""),[x,D]=l.useState(""),[M,X]=l.useState(""),[H,U]=l.useState(!1),G=!!c.part_id;l.useEffect(()=>{t&&(async()=>{try{const g=await B.get("/api/vendors");C(g.data||[])}catch{}})()},[t]),l.useEffect(()=>{if(!t)return;const g=c.part_id;if(!g){E([]);return}(async()=>{try{const T=await yo(g);E(T||[])}catch{E([])}})()},[t,c.part_id]);const te=async()=>{const g=String(c.part_number||"").trim().toUpperCase();if(g){if(!L||!x.trim()){z.error("Select a vendor and enter vendor part number");return}try{const T={vendor_id:Number(L),vendor_part_number:x.trim().toUpperCase(),vendor_part_description:M||void 0,preferred:H};if(c.part_id){await xb(c.part_id,T);const q=await yo(c.part_id);E(q||[])}else{await fb(g,T);const q=await Mo(g);E(q||[])}y(""),D(""),X(""),U(!1),z.success("Vendor mapping added")}catch(T){z.error(T?.response?.data?.error||"Failed to add vendor mapping")}}},re=async g=>{try{if(c.part_id){await yb(c.part_id,g.id,{preferred:!g.preferred});const T=await yo(c.part_id);E(T||[])}else{await gb(c.part_number.toUpperCase(),g.id,{preferred:!g.preferred});const T=await Mo(c.part_number.toUpperCase());E(T||[])}}catch{z.error("Failed to update preferred")}},S=async g=>{if(window.confirm("Remove this vendor mapping?"))try{if(c.part_id){await bb(c.part_id,g.id);const T=await yo(c.part_id);E(T||[])}else{await vb(c.part_number.toUpperCase(),g.id);const T=await Mo(c.part_number.toUpperCase());E(T||[])}}catch{z.error("Failed to delete mapping")}};return e.jsxs(mt,{open:t,onClose:P,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:N}),e.jsx(xt,{children:e.jsxs(Pe,{spacing:3,sx:{mt:1},children:[e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Part Number",value:c.part_number,onChange:g=>v("part_number",g.target.value),fullWidth:!0,required:!0,error:!!d.part_number,helperText:d.part_number,inputRef:_})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Part Type",value:c.part_type,onChange:g=>v("part_type",g.target.value),select:!0,fullWidth:!0,required:!0,error:!!d.part_type,helperText:d.part_type,children:Sb.map(g=>e.jsx(Ze,{value:g,children:g.charAt(0).toUpperCase()+g.slice(1)},g))})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(wb,{label:"Category",value:c.category,onChange:g=>v("category",g),error:!!d.category,errorMessage:d.category})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Part Description",value:c.part_description,onChange:g=>v("part_description",g.target.value),fullWidth:!0,required:!0,error:!!d.part_description,helperText:d.part_description,multiline:!0,rows:2})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Unit",value:c.unit,onChange:g=>v("unit",g.target.value),select:!0,fullWidth:!0,required:!0,error:!!d.unit,helperText:d.unit,children:zi.map(g=>e.jsx(Ze,{value:g,children:g},g))})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Last Unit Cost",value:c.last_unit_cost,onChange:g=>v("last_unit_cost",g.target.value),type:"number",fullWidth:!0,error:!!d.last_unit_cost,helperText:d.last_unit_cost,inputProps:{step:"0.01",min:"0"}})}),c.part_type!=="supply"&&e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Quantity on Hand",value:c.quantity_on_hand,onChange:g=>v("quantity_on_hand",g.target.value),type:"number",fullWidth:!0,error:!!d.quantity_on_hand,helperText:d.quantity_on_hand,inputProps:{step:"1",min:"0"},disabled:i?.access_role==="Sales and Purchase"})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Reorder Point",value:c.reorder_point,onChange:g=>v("reorder_point",g.target.value),type:"number",fullWidth:!0,error:!!d.reorder_point,helperText:d.reorder_point,inputProps:{step:"1",min:"0"}})})]}),Object.keys(d).length>0&&e.jsx(Fe,{severity:"error",children:e.jsx(h,{variant:"body2",children:"Please correct the errors above before saving."})}),e.jsxs(k,{children:[e.jsx(h,{variant:"h6",sx:{mb:1},children:"Vendors"}),!G&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"Save the part first to manage vendor mappings."}),G&&e.jsxs(e.Fragment,{children:[e.jsxs(O,{container:!0,spacing:1,sx:{mb:1},children:[e.jsx(O,{item:!0,xs:12,sm:3,children:e.jsxs(le,{label:"Vendor",select:!0,value:L,onChange:g=>y(g.target.value===""?"":Number(g.target.value)),fullWidth:!0,SelectProps:{native:!0},children:[e.jsx("option",{value:""}),A.map(g=>e.jsx("option",{value:g.vendor_id,children:g.vendor_name},g.vendor_id))]})}),e.jsx(O,{item:!0,xs:12,sm:3,children:e.jsx(le,{label:"Vendor Part #",value:x,onChange:g=>D(g.target.value),fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Vendor Part Description",value:M,onChange:g=>X(g.target.value),fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:2,children:e.jsx(Q,{variant:"outlined",onClick:()=>U(g=>!g),fullWidth:!0,children:H?"Preferred ":"Preferred"})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(Q,{variant:"contained",onClick:te,children:"Add Vendor Mapping"})})]}),j.length===0?e.jsx(h,{variant:"body2",color:"text.secondary",children:"No vendor mappings yet."}):e.jsxs(O,{container:!0,spacing:1,children:[e.jsx(O,{item:!0,xs:12,children:e.jsxs(O,{container:!0,spacing:1,sx:{fontWeight:600,mb:1},children:[e.jsx(O,{item:!0,xs:12,sm:2.5,children:"Vendor"}),e.jsx(O,{item:!0,xs:12,sm:2.5,children:"Vendor Part #"}),e.jsx(O,{item:!0,xs:12,sm:3,children:"Description"}),e.jsx(O,{item:!0,xs:12,sm:1,children:"Pref"}),e.jsx(O,{item:!0,xs:12,sm:3,children:"Actions"})]})}),j.map(g=>e.jsx(O,{item:!0,xs:12,children:e.jsxs(O,{container:!0,spacing:1,alignItems:"center",sx:{py:1,borderBottom:"1px solid #e0e0e0"},children:[e.jsx(O,{item:!0,xs:12,sm:2.5,children:e.jsx(h,{variant:"body2",noWrap:!0,children:g.vendor_name||g.vendor_id})}),e.jsx(O,{item:!0,xs:12,sm:2.5,children:e.jsx(h,{variant:"body2",noWrap:!0,children:g.vendor_part_number})}),e.jsx(O,{item:!0,xs:12,sm:3,children:e.jsx(h,{variant:"body2",noWrap:!0,children:g.vendor_part_description||""})}),e.jsx(O,{item:!0,xs:12,sm:1,sx:{textAlign:"center"},children:g.preferred?"":""}),e.jsx(O,{item:!0,xs:12,sm:3,children:e.jsxs(Pe,{direction:"row",spacing:1,sx:{flexWrap:"wrap"},children:[e.jsx(Q,{size:"small",variant:"outlined",onClick:()=>re(g),sx:{minWidth:"fit-content"},children:g.preferred?"Unset":"Set Preferred"}),e.jsx(Q,{size:"small",color:"error",variant:"outlined",onClick:()=>S(g),sx:{minWidth:"fit-content"},children:"Remove"})]})})]})},g.id))]})]})]})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:P,disabled:m,children:"Cancel"}),e.jsx(Q,{onClick:b,variant:"contained",disabled:m,children:m?"Saving...":s?"Update Part":"Save Part"})]})]})},Cb=()=>{const[t,r]=l.useState(""),[n,a]=l.useState([]),[s,o]=l.useState(!1),[i,c]=l.useState(!1),[u,d]=l.useState(null),[p,m]=l.useState(!1),[f,_]=l.useState(0),[v,w]=l.useState(null),[b,P]=l.useState(!1),N=l.useRef(null),[j,E]=l.useState(!1),[A,C]=l.useState(null),[L,y]=l.useState(!1),[x,D]=l.useState(null),[M,X]=l.useState(!1),[H,U]=l.useState({page:0,pageSize:10}),{user:G}=er(),te=async()=>{o(!0);try{const W=await ub();console.log("Raw inventory response:",W),W.length>0&&console.log("Sample inventory item from frontend:",{part_id:W[0].part_id,part_number:W[0].part_number,last_unit_cost:W[0].last_unit_cost,last_unit_cost_type:typeof W[0].last_unit_cost,quantity_on_hand:W[0].quantity_on_hand,quantity_on_hand_type:typeof W[0].quantity_on_hand});const ce=W.map((Z,Ae)=>({...Z,id:Z.part_number||Ae}));a(ce)}catch(W){console.error("Error fetching inventory:",W)}finally{o(!1)}};l.useEffect(()=>{te();const W=()=>te();return window.addEventListener("inventory-updated",W),()=>window.removeEventListener("inventory-updated",W)},[]);const re=n.filter(W=>W.part_number?.toUpperCase().includes(t.toUpperCase())||W.part_description?.toLowerCase().includes(t.toLowerCase())),S=[{field:"part_number",headerName:"Part #",flex:1,headerAlign:"left",editable:!0},{field:"part_description",headerName:"Part Description",flex:2,headerAlign:"left"},{field:"category",headerName:"Category",flex:1,headerAlign:"left"},{field:"quantity_on_hand",headerName:"Quantity on Hand",flex:1,type:"number",editable:G?.access_role!=="Sales and Purchase",align:"center",headerAlign:"left"},{field:"unit",headerName:"UOM",flex:.5,headerAlign:"left"},{field:"last_unit_cost",headerName:"Last Unit Cost",flex:1,type:"number",editable:!0,align:"center",headerAlign:"left",valueFormatter:W=>`$${(Number(W.value)||0).toFixed(2)}`,valueGetter:W=>Number(W.value)||0},{field:"reorder_point",headerName:"Reorder Point",flex:.75,type:"number",editable:!0,align:"center",headerAlign:"left"},{field:"value",headerName:"Value",flex:1,type:"number",valueGetter:W=>{const ce=Number(W.row.quantity_on_hand)||0,Z=Number(W.row.last_unit_cost)||0;return ce*Z},valueFormatter:W=>`$${(Number(W.value)||0).toFixed(2)}`,headerAlign:"center",align:"center"},{field:"actions",headerName:"Actions",width:100,headerAlign:"left",sortable:!1,renderCell:W=>e.jsx(gt,{size:"small",color:"error",onClick:ce=>{ce.stopPropagation(),g(W.row.part_number)},children:e.jsx(xr,{fontSize:"medium",sx:{fontSize:28}})})}].filter(Boolean),g=async W=>{if(window.confirm(`Are you sure you want to delete part ${W}?`))try{console.log(`Deleting part: ${W}`);const ce=await B.delete(`/api/inventory/${encodeURIComponent(W)}`);console.log(`Part ${W} deleted successfully:`,ce.data),alert(`Part ${W} deleted successfully!`),te()}catch(ce){console.error(`Error deleting part ${W}:`,ce),alert(`Error deleting part ${W}. Please check the console.`)}},T=async(W,ce)=>{console.log("Attempting to update row:",W);const Z={};if(W.part_number!==ce.part_number){const Ce=String(W.part_number).trim().toUpperCase();if(!Ce)return alert("Part number cannot be empty."),Promise.reject("Invalid part number");Z.part_number=Ce}if(W.quantity_on_hand!==ce.quantity_on_hand){if(G?.access_role==="Sales and Purchase")return alert("Sales and Purchase users cannot modify quantity on hand for existing parts."),Promise.reject("Access denied");const Ce=parseFloat(String(W.quantity_on_hand));if(isNaN(Ce))return alert("Invalid quantity value. Please enter a valid number."),Promise.reject("Invalid quantity");Z.quantity_on_hand=Ce}if(W.reorder_point!==ce.reorder_point){const Ce=parseFloat(String(W.reorder_point));if(isNaN(Ce))return alert("Invalid reorder point value. Please enter a valid number."),Promise.reject("Invalid reorder point");Z.reorder_point=Ce}if(W.last_unit_cost!==ce.last_unit_cost){const Ce=parseFloat(String(W.last_unit_cost));if(isNaN(Ce))return alert("Invalid last unit cost value. Please enter a valid number."),Promise.reject("Invalid last unit cost");Z.last_unit_cost=Ce}if(W.category!==ce.category&&(Z.category=W.category),Object.keys(Z).length===0)return console.log("No fields changed."),W;const Ae=ce.part_number;try{console.log(" processRowUpdate: Sending PUT request"),console.log(" URL:",`/api/inventory/${encodeURIComponent(Ae)}`),console.log(" Request body:",Z),console.log(" Old part number:",ce.part_number),console.log(" New part number:",W.part_number);const Ce=await B.put(`/api/inventory/${encodeURIComponent(Ae)}`,Z);return console.log(`Inventory updated for part ${Ae}:`,Ce.data),alert(`Part ${Ae} updated successfully!`),await te(),Ce.data.updatedItem||W}catch(Ce){return console.error(`Error updating inventory for part ${Ae}:`,Ce),Ce instanceof _r&&Ce.response&&Ce.response.data&&Ce.response.data.error?alert(`Error updating inventory: ${Ce.response.data.error}`):alert(`Error updating inventory for part ${Ae}. Please check the console.`),Promise.reject(Ce)}},q=()=>{const W=re.map(Ce=>({...Ce,value:(Number(Ce.quantity_on_hand)||0)*(Number(Ce.last_unit_cost)||0)})),ce=Un.unparse(W),Z=new Blob([ce],{type:"text/csv;charset=utf-8;"}),Ae=document.createElement("a");if(Ae.download!==void 0){const Ce=URL.createObjectURL(Z);Ae.setAttribute("href",Ce),Ae.setAttribute("download","inventory_list.csv"),Ae.style.visibility="hidden",document.body.appendChild(Ae),Ae.click()}},ee=()=>{d(null),c(!0)},R=async W=>{const ce={...W,part_number:W.part_number.trim().toUpperCase(),part_description:W.part_description.trim(),unit:W.unit.trim(),part_type:W.part_type.trim()};try{if(u){const Z={...ce,part_number:ce.part_number};console.log(" Frontend: Sending PUT request"),console.log(" URL:",`/api/inventory/${encodeURIComponent(u.part_number)}`),console.log(" Request body:",Z),console.log(" Original part number:",u.part_number),console.log(" New part number:",ce.part_number),await B.put(`/api/inventory/${encodeURIComponent(u.part_number)}`,Z)}else await B.post("/api/inventory",ce);te()}catch(Z){throw Z}},K=()=>{c(!1),d(null)},F=W=>{d({part_id:W.row.part_id,part_number:W.row.part_number,part_description:W.row.part_description||"",unit:W.row.unit||"Each",last_unit_cost:W.row.last_unit_cost||"",quantity_on_hand:W.row.quantity_on_hand||"",reorder_point:W.row.reorder_point||"",part_type:W.row.part_type||"stock",category:W.row.category||"Uncategorized"}),c(!0)},xe=()=>{N.current?.click()},ve=async W=>{const ce=W.target.files?.[0];if(ce){if(!ce.name.endsWith(".csv")&&ce.type!=="text/csv"){alert("Please select a valid CSV file");return}if(ce.size>5*1024*1024){alert("File size must be less than 5MB");return}await de(ce)}},de=async W=>{m(!0),_(0),w(null);const ce=new FormData;ce.append("csvFile",W);try{const Z=setInterval(()=>{_(Ce=>Ce>=90?(clearInterval(Z),90):Ce+10)},200),Ae=await B.post("/api/inventory/upload-csv",ce,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:Ce=>{if(Ce.total){const ze=Math.round(Ce.loaded*90/Ce.total);_(ze)}}});clearInterval(Z),_(100),w(Ae.data),P(!0),setTimeout(()=>{te()},1e3)}catch(Z){console.error("Error uploading CSV:",Z),Z instanceof _r&&Z.response?.data?w({error:"Upload failed",errors:Z.response.data.errors||[Z.response.data.error||"Unknown error"],warnings:Z.response.data.warnings||[]}):w({error:"Upload failed",errors:["An unexpected error occurred during upload"]}),P(!0)}finally{m(!1),_(0),N.current&&(N.current.value="")}},me=async()=>{try{const W=await B.get("/api/inventory/csv-template",{responseType:"blob"}),ce=window.URL.createObjectURL(new Blob([W.data])),Z=document.createElement("a");Z.href=ce,Z.setAttribute("download","inventory_template.csv"),document.body.appendChild(Z),Z.click(),Z.remove(),window.URL.revokeObjectURL(ce)}catch(W){console.error("Error downloading template:",W),alert("Error downloading template")}},ge=()=>{P(!1),w(null)},pe=async()=>{E(!0);try{const W=[],ce=[],Z=Ve=>{const ut=[],it=[];let pt=String(Ve||"");const Ne=pt,tt=pt.replace(/\s+/g,"");tt!==pt&&ut.push("Removed spaces"),pt=tt;const Be=pt.toUpperCase();Be!==pt&&ut.push("Converted to uppercase"),pt=Be;const wt=pt.replace(/[^A-Z0-9\/()]/g,"");wt!==pt&&ut.push("Removed punctuation excluding ( ) /"),pt=wt;const zt=pt;return pt=pt.replace(/(\d)\/(1\d|\d)/g,(Bt,We,Qt,Kt,Wt)=>{const tr=Wt[Kt-1]||"",yr=Wt[Kt+Bt.length]||"";return tr==="("&&yr===")"?Bt:`(${We}/${Qt})`}),pt!==zt&&ut.push("Wrapped fractions with parentheses"),pt.includes("/")&&(/^[A-Z]{3,}/.test(pt)||/[A-Z]{3,}$/.test(pt))&&it.push("Description text detected with fraction"),/\d\.|\.\d/.test(pt)&&it.push("Decimal detected; consider fraction"),{cleaned:pt,actions:ut,warnings:it,original:Ne}},Ae=n.map(Ve=>{const ut=Z(Ve.part_number);return(ut.cleaned!==Ve.part_number||ut.actions.length>0)&&W.push({part_number:Ve.part_number,cleaned_part_number:ut.cleaned,actions:ut.actions}),ut.warnings.length>0&&ce.push({part_number:Ve.part_number,warnings:ut.warnings}),{...Ve,_clean:ut.cleaned}}),Ce={};Ae.forEach(Ve=>{Ce[Ve._clean]||(Ce[Ve._clean]=[]),Ce[Ve._clean].push(Ve)});const ze=Object.entries(Ce).filter(([,Ve])=>Ve.length>1).map(([,Ve])=>{const ut=Ve.map(Ne=>({part_number:Ne.part_number,unit:Ne.unit})),it=Ve[0].part_number,pt=new Set(Ve.map(Ne=>Ne.unit)).size>1;return{proposedKeep:it,candidates:ut,unitMismatch:pt}});D({fixes:W,flags:ce,duplicateGroups:ze}),X(!0)}catch(W){console.error("Error during cleanup preview:",W),alert("Failed to analyze inventory for cleanup.")}finally{E(!1)}},se=async()=>{if(!x)return;const W=(x.duplicateGroups||[]).map(ce=>({keepPartNumber:ce.proposedKeep,mergePartNumbers:ce.candidates.map(Z=>Z.part_number).filter(Z=>Z!==ce.proposedKeep)}));E(!0);try{const ce=await Hp("stock",W);X(!1),C(ce),y(!0),await te()}catch(ce){console.error("Error applying cleanup:",ce),alert("Failed to apply cleanup.")}finally{E(!1)}},I=()=>{y(!1),C(null)};return e.jsxs(nt,{maxWidth:"xl",sx:{mt:4},children:[e.jsxs(k,{sx:{mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Stock"}),e.jsxs(Pe,{direction:"row",spacing:2,children:[e.jsx(Q,{variant:"contained",startIcon:e.jsx(Nr,{}),onClick:ee,children:"New Part"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(zp,{}),onClick:xe,children:"Upload CSV"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(gr,{}),onClick:me,children:"Download Template"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(gr,{}),onClick:q,children:"Export CSV"}),e.jsx(Q,{variant:"outlined",color:"warning",onClick:pe,disabled:j,startIcon:j?e.jsx(ot,{size:20}):e.jsx(xr,{}),children:j?"Cleaning...":"Clean"})]})]}),e.jsx("input",{type:"file",ref:N,onChange:ve,accept:".csv",style:{display:"none"}}),p&&e.jsxs(Me,{sx:{p:2,mb:2},children:[e.jsx(h,{variant:"body2",gutterBottom:!0,children:"Uploading CSV file..."}),e.jsx(Mu,{variant:"determinate",value:f}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:[f,"% complete"]})]}),e.jsx(Me,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(le,{fullWidth:!0,variant:"outlined",placeholder:"Search stock...",value:t,onChange:W=>r(W.target.value),InputProps:{startAdornment:e.jsx(mr,{position:"start",children:e.jsx(Hr,{})})},sx:{mb:2}}),e.jsx(tn,{rows:re,columns:S,loading:s,paginationModel:H,onPaginationModelChange:W=>U(W),pageSizeOptions:[10,20,50],processRowUpdate:T,getRowId:W=>W.id,onRowClick:(W,ce)=>{const Z=ce.target;Z.closest('.MuiDataGrid-cell[data-field="part_number"]')||Z.closest('.MuiDataGrid-cell[data-field="quantity_on_hand"]')||Z.closest('.MuiDataGrid-cell[data-field="last_unit_cost"]')||Z.closest('.MuiDataGrid-cell[data-field="reorder_point"]')||F(W)},sx:{cursor:"pointer","& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]}),e.jsxs(mt,{open:M,onClose:()=>X(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:"Clean and Enforce Rules (Preview)"}),e.jsx(xt,{children:x?e.jsxs(k,{children:[e.jsx(h,{variant:"h6",children:"Fixes"}),e.jsx(kr,{dense:!0,children:(x.fixes||[]).slice(0,200).map((W,ce)=>e.jsx(Ar,{button:!0,onClick:()=>{const Z=n.find(Ae=>Ae.part_number===W.part_number);Z&&(d({part_id:Z.part_id,part_number:Z.part_number,part_description:Z.part_description||"",unit:Z.unit||"Each",last_unit_cost:Z.last_unit_cost||"",quantity_on_hand:Z.quantity_on_hand||"",reorder_point:Z.reorder_point||"",part_type:Z.part_type||"stock",category:Z.category||"Uncategorized"}),c(!0))},children:e.jsx(hr,{primary:`${W.part_number} -> ${W.cleaned_part_number}`,secondary:(W.actions||[]).join(", ")})},ce))}),x.flags&&x.flags.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(h,{variant:"h6",sx:{mt:2},children:"Flags"}),e.jsx(kr,{dense:!0,children:(x.flags||[]).map((W,ce)=>e.jsx(Ar,{button:!0,onClick:()=>{const Z=n.find(Ae=>Ae.part_number===W.part_number);Z&&(d({part_id:Z.part_id,part_number:Z.part_number,part_description:Z.part_description||"",unit:Z.unit||"Each",last_unit_cost:Z.last_unit_cost||"",quantity_on_hand:Z.quantity_on_hand||"",reorder_point:Z.reorder_point||"",part_type:Z.part_type||"stock",category:Z.category||"Uncategorized"}),c(!0))},children:e.jsx(hr,{primary:`${W.part_number}`,secondary:(W.warnings||[]).join(", ")})},ce))})]}),e.jsx(h,{variant:"h6",sx:{mt:2},children:"Potential Duplicates"}),e.jsx(kr,{dense:!0,children:(x.duplicateGroups||[]).map((W,ce)=>e.jsx(Ar,{children:e.jsx(hr,{primary:`Keep ${W.proposedKeep}  merge ${W.candidates.map(Z=>Z.part_number).filter(Z=>Z!==W.proposedKeep).join(", ")||"none"}`,secondary:W.unitMismatch?"Unit mismatch detected - will not merge differing units":void 0})},ce))})]}):e.jsx(h,{children:"Loading preview..."})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>X(!1),children:"Cancel"}),e.jsx(Q,{onClick:se,variant:"contained",disabled:j,children:"Apply"})]})]}),e.jsx(ns,{open:i,onClose:K,onSave:R,initialPart:u||void 0,isEditMode:!!u,title:u?"Edit Inventory Part":"Add New Inventory Part"}),e.jsxs(mt,{open:b,onClose:ge,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:v?.error?"Upload Failed":"Upload Completed"}),e.jsx(xt,{children:v&&e.jsxs(k,{children:[v.error?e.jsx(Fe,{severity:"error",sx:{mb:2},children:v.error}):e.jsx(Fe,{severity:"success",sx:{mb:2},children:v.message}),v.summary&&e.jsxs(k,{sx:{mb:3},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Summary"}),e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Total: ${v.summary.totalProcessed}`,color:"primary"})}),e.jsx(O,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`New: ${v.summary.newItems}`,color:"success"})}),e.jsx(O,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Updated: ${v.summary.updatedItems}`,color:"info"})}),e.jsx(O,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Vendor Mappings: ${v.summary.vendorMappings||0}`,color:"secondary"})}),e.jsx(O,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Errors: ${v.summary.errors}`,color:"error"})}),e.jsx(O,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Warnings: ${v.summary.warnings}`,color:"warning"})})]})]}),v.errors&&v.errors.length>0&&e.jsxs(k,{sx:{mb:3},children:[e.jsxs(h,{variant:"h6",color:"error",gutterBottom:!0,children:["Errors (",v.errors.length,")"]}),e.jsx(kr,{dense:!0,children:v.errors.map((W,ce)=>e.jsx(Ar,{children:e.jsx(hr,{primary:W})},ce))})]}),v.warnings&&v.warnings.length>0&&e.jsxs(k,{sx:{mb:3},children:[e.jsxs(h,{variant:"h6",color:"warning.main",gutterBottom:!0,children:["Warnings (",v.warnings.length,")"]}),e.jsx(kr,{dense:!0,children:v.warnings.map((W,ce)=>e.jsx(Ar,{children:e.jsx(hr,{primary:W})},ce))})]})]})}),e.jsx(jt,{children:e.jsx(Q,{onClick:ge,variant:"contained",children:"Close"})})]}),e.jsxs(mt,{open:L,onClose:I,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:A?.error?"Cleanup Failed":"Cleanup Completed"}),e.jsx(xt,{children:A&&e.jsxs(k,{children:[A.error?e.jsxs(Fe,{severity:"error",sx:{mb:2},children:[A.message,A.details&&e.jsxs(h,{variant:"body2",sx:{mt:1},children:["Details: ",A.details]})]}):e.jsx(Fe,{severity:"success",sx:{mb:2},children:A.message}),A.summary&&e.jsxs(k,{sx:{mb:3},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Summary"}),e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:6,sm:4,children:e.jsx(De,{label:`Total: ${A.summary.totalProcessed}`,color:"primary"})}),e.jsx(O,{item:!0,xs:6,sm:4,children:e.jsx(De,{label:`Updated: ${A.summary.itemsUpdated}`,color:"success"})}),e.jsx(O,{item:!0,xs:6,sm:4,children:e.jsx(De,{label:`Errors: ${A.summary.errors}`,color:"error"})})]})]})]})}),e.jsx(jt,{children:e.jsx(Q,{onClick:I,variant:"contained",children:"Close"})})]})]})},kb=()=>{const[t,r]=l.useState(""),[n,a]=l.useState([]),[s,o]=l.useState(!1),[i,c]=l.useState(!1),[u,d]=l.useState(null),[p,m]=l.useState(!1),[f,_]=l.useState(0),[v,w]=l.useState(null),[b,P]=l.useState(!1),N=l.useRef(null),[j,E]=l.useState({page:0,pageSize:10}),[A,C]=l.useState(!1),[L,y]=l.useState(null),[x,D]=l.useState(!1),[M,X]=l.useState(null),[H,U]=l.useState(!1),G=async()=>{o(!0);try{const I=(await pb()).map((W,ce)=>({...W,id:W.part_number||ce}));a(I)}catch(se){console.error("Error fetching supply inventory:",se)}finally{o(!1)}};l.useEffect(()=>{G();const se=()=>G();return window.addEventListener("supply-updated",se),()=>window.removeEventListener("supply-updated",se)},[]);const te=n.filter(se=>se.part_number?.toUpperCase().includes(t.toUpperCase())||se.part_description?.toLowerCase().includes(t.toLowerCase())),re=[{field:"part_number",headerName:"Part #",flex:1,headerAlign:"left",editable:!0},{field:"part_description",headerName:"Part Description",flex:2,headerAlign:"left"},{field:"category",headerName:"Category",flex:1,headerAlign:"left"},{field:"unit",headerName:"UOM",flex:.5,headerAlign:"left"},{field:"last_unit_cost",headerName:"Last Unit Cost",flex:1,type:"number",editable:!0,align:"center",headerAlign:"left"},{field:"reorder_point",headerName:"Reorder Point",flex:.75,type:"number",editable:!0,align:"center",headerAlign:"left"},{field:"part_type",headerName:"Type",flex:.5,headerAlign:"left"},{field:"value",headerName:"Value",flex:1,type:"number",valueGetter:se=>{const I=se.row.quantity_on_hand==="NA"?0:Number(se.row.quantity_on_hand)||0,W=Number(se.row.last_unit_cost)||0;return I*W},valueFormatter:se=>`$${(Number(se.value)||0).toFixed(2)}`,headerAlign:"center",align:"center"},{field:"actions",headerName:"Actions",width:100,headerAlign:"left",sortable:!1,renderCell:se=>e.jsx(gt,{size:"small",color:"error",onClick:I=>{I.stopPropagation(),S(se.row.part_number)},children:e.jsx(xr,{fontSize:"medium",sx:{fontSize:28}})})}],S=async se=>{if(window.confirm(`Are you sure you want to delete part ${se}?`))try{console.log(`Deleting part: ${se}`);const I=await B.delete(`/api/inventory/${encodeURIComponent(se)}`);console.log(`Part ${se} deleted successfully:`,I.data),alert(`Part ${se} deleted successfully!`),G()}catch(I){console.error(`Error deleting part ${se}:`,I),alert(`Error deleting part ${se}. Please check the console.`)}},g=async(se,I)=>{console.log("Attempting to update row:",se);const W={};if(se.part_number!==I.part_number){const Z=String(se.part_number).trim().toUpperCase();if(!Z)return alert("Part number cannot be empty."),Promise.reject("Invalid part number");W.part_number=Z}if(se.reorder_point!==I.reorder_point){const Z=parseFloat(String(se.reorder_point));if(isNaN(Z))return alert("Invalid reorder point value. Please enter a valid number."),Promise.reject("Invalid reorder point");W.reorder_point=Z}if(se.last_unit_cost!==I.last_unit_cost){const Z=parseFloat(String(se.last_unit_cost));if(isNaN(Z))return alert("Invalid last unit cost value. Please enter a valid number."),Promise.reject("Invalid last unit cost");W.last_unit_cost=Z}if(se.category!==I.category&&(W.category=se.category),Object.keys(W).length===0)return console.log("No fields changed."),se;const ce=W.part_number?I.part_number:se.part_number;try{const Z=await B.put(`/api/inventory/${encodeURIComponent(ce)}`,W);return console.log(`Supply inventory updated for part ${ce}:`,Z.data),alert(`Part ${ce} updated successfully!`),await G(),Z.data.updatedItem||se}catch(Z){return console.error(`Error updating supply inventory for part ${ce}:`,Z),Z instanceof _r&&Z.response&&Z.response.data&&Z.response.data.error?alert(`Error updating inventory: ${Z.response.data.error}`):alert(`Error updating inventory for part ${ce}. Please check the console.`),Promise.reject(Z)}},T=()=>{const se=te.map(Z=>({...Z,value:(Z.quantity_on_hand==="NA"?0:Number(Z.quantity_on_hand)||0)*(Number(Z.last_unit_cost)||0)})),I=Un.unparse(se),W=new Blob([I],{type:"text/csv;charset=utf-8;"}),ce=document.createElement("a");if(ce.download!==void 0){const Z=URL.createObjectURL(W);ce.setAttribute("href",Z),ce.setAttribute("download","supply_list.csv"),ce.style.visibility="hidden",document.body.appendChild(ce),ce.click()}},q=()=>{d({part_number:"",part_description:"",unit:"",last_unit_cost:"",quantity_on_hand:"NA",reorder_point:"",part_type:"supply",category:"Uncategorized"}),c(!0)},ee=async()=>{C(!0);try{const se=await mb("supply");y(se?.preview||se),D(!0)}catch(se){console.error("Error during cleanup preview:",se),alert("Failed to analyze supply for cleanup.")}finally{C(!1)}},R=async()=>{if(!L)return;const se=(L.duplicateGroups||[]).map(I=>({keepPartNumber:I.proposedKeep,mergePartNumbers:I.candidates.map(W=>W.part_number).filter(W=>W!==I.proposedKeep)}));C(!0);try{const I=await Hp("supply",se);D(!1),X(I),U(!0),await G()}catch(I){console.error("Error applying cleanup:",I),alert("Failed to apply cleanup.")}finally{C(!1)}},K=async se=>{const I={...se,part_number:se.part_number.trim().toUpperCase(),part_description:se.part_description.trim(),unit:se.unit.trim(),part_type:se.part_type.trim()};try{if(u){const{part_number:W,...ce}=I;await B.put(`/api/inventory/${encodeURIComponent(W)}`,ce)}else await B.post("/api/inventory",I);G()}catch(W){throw W}},F=()=>{c(!1),d(null)},xe=se=>{d({part_id:se.row.part_id,part_number:se.row.part_number,part_description:se.row.part_description||"",unit:se.row.unit||"Each",last_unit_cost:se.row.last_unit_cost||"",quantity_on_hand:se.row.quantity_on_hand||"",reorder_point:se.row.reorder_point||"",part_type:se.row.part_type||"supply",category:se.row.category||"Uncategorized"}),c(!0)},ve=()=>{N.current?.click()},de=async se=>{const I=se.target.files?.[0];if(I){if(!I.name.endsWith(".csv")&&I.type!=="text/csv"){alert("Please select a valid CSV file");return}if(I.size>5*1024*1024){alert("File size must be less than 5MB");return}await me(I)}},me=async se=>{m(!0),_(0),w(null);const I=new FormData;I.append("csvFile",se);try{const W=setInterval(()=>{_(Z=>Z>=90?(clearInterval(W),90):Z+10)},200),ce=await B.post("/api/inventory/upload-csv",I,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:Z=>{if(Z.total){const Ae=Math.round(Z.loaded*90/Z.total);_(Ae)}}});clearInterval(W),_(100),w(ce.data),P(!0),setTimeout(()=>{G()},1e3)}catch(W){console.error("Error uploading CSV:",W),W instanceof _r&&W.response?.data?w({error:"Upload failed",errors:W.response.data.errors||[W.response.data.error||"Unknown error"],warnings:W.response.data.warnings||[]}):w({error:"Upload failed",errors:["An unexpected error occurred during upload"]}),P(!0)}finally{m(!1),_(0),N.current&&(N.current.value="")}},ge=async()=>{try{const se=await B.get("/api/inventory/csv-template",{responseType:"blob"}),I=window.URL.createObjectURL(new Blob([se.data])),W=document.createElement("a");W.href=I,W.setAttribute("download","supply_template.csv"),document.body.appendChild(W),W.click(),W.remove(),window.URL.revokeObjectURL(I)}catch(se){console.error("Error downloading template:",se),alert("Error downloading template")}},pe=()=>{P(!1),w(null)};return e.jsxs(nt,{maxWidth:"xl",sx:{mt:4},children:[e.jsxs(k,{sx:{mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Supply List"}),e.jsxs(Pe,{direction:"row",spacing:2,children:[e.jsx(Q,{variant:"contained",startIcon:e.jsx(Nr,{}),onClick:q,children:"New Part"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(zp,{}),onClick:ve,children:"Upload CSV"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(gr,{}),onClick:ge,children:"Download Template"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(gr,{}),onClick:T,children:"Export CSV"}),e.jsx(Q,{variant:"outlined",color:"warning",onClick:ee,disabled:A,startIcon:e.jsx(xr,{}),children:A?"Cleaning...":"Clean"})]})]}),e.jsx("input",{type:"file",ref:N,onChange:de,accept:".csv",style:{display:"none"}}),p&&e.jsxs(Me,{sx:{p:2,mb:2},children:[e.jsx(h,{variant:"body2",gutterBottom:!0,children:"Uploading CSV file..."}),e.jsx(Mu,{variant:"determinate",value:f}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:[f,"% complete"]})]}),e.jsx(Me,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(le,{fullWidth:!0,variant:"outlined",placeholder:"Search supply...",value:t,onChange:se=>r(se.target.value),InputProps:{startAdornment:e.jsx(mr,{position:"start",children:e.jsx(Hr,{})})},sx:{mb:2}}),e.jsx(tn,{rows:te,columns:re,loading:s,paginationModel:j,onPaginationModelChange:se=>E(se),pageSizeOptions:[10,20,50],processRowUpdate:g,getRowId:se=>se.id,onRowClick:(se,I)=>{const W=I.target;W.closest('.MuiDataGrid-cell[data-field="part_number"]')||W.closest('.MuiDataGrid-cell[data-field="last_unit_cost"]')||W.closest('.MuiDataGrid-cell[data-field="reorder_point"]')||xe(se)},sx:{cursor:"pointer","& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]}),e.jsx(ns,{open:i,onClose:F,onSave:K,initialPart:u||void 0,isEditMode:!!u,title:u?"Edit Supply Part":"Add New Supply Part"}),e.jsxs(mt,{open:b,onClose:pe,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:v?.error?"Upload Failed":"Upload Completed"}),e.jsx(xt,{children:v&&e.jsxs(k,{children:[v.error?e.jsx(Fe,{severity:"error",sx:{mb:2},children:v.error}):e.jsx(Fe,{severity:"success",sx:{mb:2},children:v.message}),v.summary&&e.jsxs(k,{sx:{mb:3},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Summary"}),e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Total: ${v.summary.totalProcessed}`,color:"primary"})}),e.jsx(O,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`New: ${v.summary.newItems}`,color:"success"})}),e.jsx(O,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Updated: ${v.summary.updatedItems}`,color:"info"})}),e.jsx(O,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Vendor Mappings: ${v.summary.vendorMappings||0}`,color:"secondary"})}),e.jsx(O,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Errors: ${v.summary.errors}`,color:"error"})}),e.jsx(O,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Warnings: ${v.summary.warnings}`,color:"warning"})})]})]}),v.errors&&v.errors.length>0&&e.jsxs(k,{sx:{mb:3},children:[e.jsxs(h,{variant:"h6",color:"error",gutterBottom:!0,children:["Errors (",v.errors.length,")"]}),e.jsx(kr,{dense:!0,children:v.errors.map((se,I)=>e.jsx(Ar,{children:e.jsx(hr,{primary:se})},I))})]}),v.warnings&&v.warnings.length>0&&e.jsxs(k,{sx:{mb:3},children:[e.jsxs(h,{variant:"h6",color:"warning.main",gutterBottom:!0,children:["Warnings (",v.warnings.length,")"]}),e.jsx(kr,{dense:!0,children:v.warnings.map((se,I)=>e.jsx(Ar,{children:e.jsx(hr,{primary:se})},I))})]})]})}),e.jsx(jt,{children:e.jsx(Q,{onClick:pe,variant:"contained",children:"Close"})})]}),e.jsxs(mt,{open:x,onClose:()=>D(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:"Clean and Enforce Rules (Preview)"}),e.jsx(xt,{children:L?e.jsxs(k,{children:[e.jsx(h,{variant:"h6",children:"Fixes"}),e.jsx(kr,{dense:!0,children:(L.fixes||[]).slice(0,200).map((se,I)=>e.jsx(Ar,{children:e.jsx(hr,{primary:`${se.part_number} -> ${se.cleaned_part_number}`,secondary:(se.actions||[]).join(", ")})},I))}),e.jsx(h,{variant:"h6",sx:{mt:2},children:"Potential Duplicates"}),e.jsx(kr,{dense:!0,children:(L.duplicateGroups||[]).map((se,I)=>e.jsx(Ar,{children:e.jsx(hr,{primary:`Keep ${se.proposedKeep}  merge ${se.candidates.map(W=>W.part_number).filter(W=>W!==se.proposedKeep).join(", ")||"none"}`,secondary:se.unitMismatch?"Unit mismatch detected - will not merge differing units":void 0})},I))})]}):e.jsx(h,{children:"Loading preview..."})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>D(!1),children:"Cancel"}),e.jsx(Q,{onClick:R,variant:"contained",disabled:A,children:"Apply"})]})]}),e.jsxs(mt,{open:H,onClose:()=>U(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:"Cleanup Completed"}),e.jsx(xt,{children:M?e.jsxs(k,{children:[e.jsx(Fe,{severity:"success",sx:{mb:2},children:"Cleanup applied successfully."}),e.jsxs(h,{variant:"body2",children:["Fixes applied: ",M?.applied?.fixesApplied||0]}),e.jsxs(h,{variant:"body2",children:["Fixes skipped: ",M?.applied?.fixesSkipped||0]}),e.jsxs(h,{variant:"body2",children:["Merged groups: ",M?.applied?.mergedGroups||0]}),e.jsxs(h,{variant:"body2",children:["Merged items: ",M?.applied?.mergedItems||0]})]}):e.jsx(h,{children:"Loading..."})}),e.jsx(jt,{children:e.jsx(Q,{onClick:()=>U(!1),variant:"contained",children:"Close"})})]})]})};function Rt(t){if(t===null||t===!0||t===!1)return NaN;var r=Number(t);return isNaN(r)?r:r<0?Math.ceil(r):Math.floor(r)}function qe(t,r){if(r.length<t)throw new TypeError(t+" argument"+(t>1?"s":"")+" required, but only "+r.length+" present")}function Le(t){qe(1,arguments);var r=Object.prototype.toString.call(t);return t instanceof Date||ei(t)==="object"&&r==="[object Date]"?new Date(t.getTime()):typeof t=="number"||r==="[object Number]"?new Date(t):((typeof t=="string"||r==="[object String]")&&typeof console<"u"&&(console.warn("Starting with v2.0.0-beta.1 date-fns doesn't accept strings as date arguments. Please use `parseISO` to parse strings. See: https://github.com/date-fns/date-fns/blob/master/docs/upgradeGuide.md#string-arguments"),console.warn(new Error().stack)),new Date(NaN))}function Ro(t,r){qe(2,arguments);var n=Le(t),a=Rt(r);return isNaN(a)?new Date(NaN):(a&&n.setDate(n.getDate()+a),n)}function No(t,r){qe(2,arguments);var n=Le(t),a=Rt(r);if(isNaN(a))return new Date(NaN);if(!a)return n;var s=n.getDate(),o=new Date(n.getTime());o.setMonth(n.getMonth()+a+1,0);var i=o.getDate();return s>=i?o:(n.setFullYear(o.getFullYear(),o.getMonth(),s),n)}function gi(t,r){qe(2,arguments);var n=Le(t).getTime(),a=Rt(r);return new Date(n+a)}var Pb=36e5;function Eb(t,r){qe(2,arguments);var n=Rt(r);return gi(t,n*Pb)}var Db={};function nn(){return Db}function ts(t,r){var n,a,s,o,i,c,u,d;qe(1,arguments);var p=nn(),m=Rt((n=(a=(s=(o=r?.weekStartsOn)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.weekStartsOn)!==null&&s!==void 0?s:p.weekStartsOn)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.weekStartsOn)!==null&&n!==void 0?n:0);if(!(m>=0&&m<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var f=Le(t),_=f.getDay(),v=(_<m?7:0)+_-m;return f.setDate(f.getDate()-v),f.setHours(0,0,0,0),f}function Ms(t){var r=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()));return r.setUTCFullYear(t.getFullYear()),t.getTime()-r.getTime()}function Rs(t){qe(1,arguments);var r=Le(t);return r.setHours(0,0,0,0),r}var Tb=864e5;function Ib(t,r){qe(2,arguments);var n=Rs(t),a=Rs(r),s=n.getTime()-Ms(n),o=a.getTime()-Ms(a);return Math.round((s-o)/Tb)}var Ob=6e4;function Ab(t,r){qe(2,arguments);var n=Rt(r);return gi(t,n*Ob)}function Mb(t,r){qe(2,arguments);var n=Rt(r);return gi(t,n*1e3)}function Rb(t,r){qe(2,arguments);var n=Rt(r),a=n*7;return Ro(t,a)}function wd(t,r){qe(2,arguments);var n=Rt(r);return No(t,n*12)}function Os(t,r){qe(2,arguments);var n=Le(t),a=Le(r),s=n.getTime()-a.getTime();return s<0?-1:s>0?1:s}var yi=6e4,vi=36e5,Nb=1e3;function Lb(t,r){qe(2,arguments);var n=Rs(t),a=Rs(r);return n.getTime()===a.getTime()}function qb(t){return qe(1,arguments),t instanceof Date||ei(t)==="object"&&Object.prototype.toString.call(t)==="[object Date]"}function Yp(t){if(qe(1,arguments),!qb(t)&&typeof t!="number")return!1;var r=Le(t);return!isNaN(Number(r))}function Ub(t,r){qe(2,arguments);var n=Le(t),a=Le(r),s=n.getFullYear()-a.getFullYear(),o=n.getMonth()-a.getMonth();return s*12+o}function Fb(t,r){qe(2,arguments);var n=Le(t),a=Le(r);return n.getFullYear()-a.getFullYear()}function Sd(t,r){var n=t.getFullYear()-r.getFullYear()||t.getMonth()-r.getMonth()||t.getDate()-r.getDate()||t.getHours()-r.getHours()||t.getMinutes()-r.getMinutes()||t.getSeconds()-r.getSeconds()||t.getMilliseconds()-r.getMilliseconds();return n<0?-1:n>0?1:n}function Vp(t,r){qe(2,arguments);var n=Le(t),a=Le(r),s=Sd(n,a),o=Math.abs(Ib(n,a));n.setDate(n.getDate()-s*o);var i=+(Sd(n,a)===-s),c=s*(o-i);return c===0?0:c}function bi(t,r){return qe(2,arguments),Le(t).getTime()-Le(r).getTime()}var Cd={ceil:Math.ceil,round:Math.round,floor:Math.floor,trunc:function(r){return r<0?Math.ceil(r):Math.floor(r)}},Wb="trunc";function lo(t){return t?Cd[t]:Cd[Wb]}function $b(t,r,n){qe(2,arguments);var a=bi(t,r)/vi;return lo(void 0)(a)}function zb(t,r,n){qe(2,arguments);var a=bi(t,r)/yi;return lo(void 0)(a)}function bl(t){qe(1,arguments);var r=Le(t);return r.setHours(23,59,59,999),r}function _l(t){qe(1,arguments);var r=Le(t),n=r.getMonth();return r.setFullYear(r.getFullYear(),n+1,0),r.setHours(23,59,59,999),r}function Bb(t){qe(1,arguments);var r=Le(t);return bl(r).getTime()===_l(r).getTime()}function Gp(t,r){qe(2,arguments);var n=Le(t),a=Le(r),s=Os(n,a),o=Math.abs(Ub(n,a)),i;if(o<1)i=0;else{n.getMonth()===1&&n.getDate()>27&&n.setDate(30),n.setMonth(n.getMonth()-s*o);var c=Os(n,a)===-s;Bb(Le(t))&&o===1&&Os(t,a)===1&&(c=!1),i=s*(o-Number(c))}return i===0?0:i}function Hb(t,r,n){qe(2,arguments);var a=Gp(t,r)/3;return lo(void 0)(a)}function Yb(t,r,n){qe(2,arguments);var a=bi(t,r)/1e3;return lo(void 0)(a)}function Vb(t,r,n){qe(2,arguments);var a=Vp(t,r)/7;return lo(void 0)(a)}function Gb(t,r){qe(2,arguments);var n=Le(t),a=Le(r),s=Os(n,a),o=Math.abs(Fb(n,a));n.setFullYear(1584),a.setFullYear(1584);var i=Os(n,a)===-s,c=s*(o-Number(i));return c===0?0:c}function Qb(t,r){var n;qe(1,arguments);var a=t||{},s=Le(a.start),o=Le(a.end),i=o.getTime();if(!(s.getTime()<=i))throw new RangeError("Invalid interval");var c=[],u=s;u.setHours(0,0,0,0);var d=Number((n=void 0)!==null&&n!==void 0?n:1);if(d<1||isNaN(d))throw new RangeError("`options.step` must be a number greater than 1");for(;u.getTime()<=i;)c.push(Le(u)),u.setDate(u.getDate()+d),u.setHours(0,0,0,0);return c}function kd(t){qe(1,arguments);var r=Le(t);return r.setDate(1),r.setHours(0,0,0,0),r}function Bi(t){qe(1,arguments);var r=Le(t),n=r.getFullYear();return r.setFullYear(n+1,0,0),r.setHours(23,59,59,999),r}function vo(t){qe(1,arguments);var r=Le(t),n=new Date(0);return n.setFullYear(r.getFullYear(),0,1),n.setHours(0,0,0,0),n}function Hi(t,r){var n,a,s,o,i,c,u,d;qe(1,arguments);var p=nn(),m=Rt((n=(a=(s=(o=r?.weekStartsOn)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.weekStartsOn)!==null&&s!==void 0?s:p.weekStartsOn)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.weekStartsOn)!==null&&n!==void 0?n:0);if(!(m>=0&&m<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var f=Le(t),_=f.getDay(),v=(_<m?-7:0)+6-(_-m);return f.setDate(f.getDate()+v),f.setHours(23,59,59,999),f}function Qp(t,r){qe(2,arguments);var n=Rt(r);return gi(t,-n)}var Kb=864e5;function Jb(t){qe(1,arguments);var r=Le(t),n=r.getTime();r.setUTCMonth(0,1),r.setUTCHours(0,0,0,0);var a=r.getTime(),s=n-a;return Math.floor(s/Kb)+1}function Ns(t){qe(1,arguments);var r=1,n=Le(t),a=n.getUTCDay(),s=(a<r?7:0)+a-r;return n.setUTCDate(n.getUTCDate()-s),n.setUTCHours(0,0,0,0),n}function Kp(t){qe(1,arguments);var r=Le(t),n=r.getUTCFullYear(),a=new Date(0);a.setUTCFullYear(n+1,0,4),a.setUTCHours(0,0,0,0);var s=Ns(a),o=new Date(0);o.setUTCFullYear(n,0,4),o.setUTCHours(0,0,0,0);var i=Ns(o);return r.getTime()>=s.getTime()?n+1:r.getTime()>=i.getTime()?n:n-1}function Xb(t){qe(1,arguments);var r=Kp(t),n=new Date(0);n.setUTCFullYear(r,0,4),n.setUTCHours(0,0,0,0);var a=Ns(n);return a}var Zb=6048e5;function Jp(t){qe(1,arguments);var r=Le(t),n=Ns(r).getTime()-Xb(r).getTime();return Math.round(n/Zb)+1}function ss(t,r){var n,a,s,o,i,c,u,d;qe(1,arguments);var p=nn(),m=Rt((n=(a=(s=(o=r?.weekStartsOn)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.weekStartsOn)!==null&&s!==void 0?s:p.weekStartsOn)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.weekStartsOn)!==null&&n!==void 0?n:0);if(!(m>=0&&m<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var f=Le(t),_=f.getUTCDay(),v=(_<m?7:0)+_-m;return f.setUTCDate(f.getUTCDate()-v),f.setUTCHours(0,0,0,0),f}function $l(t,r){var n,a,s,o,i,c,u,d;qe(1,arguments);var p=Le(t),m=p.getUTCFullYear(),f=nn(),_=Rt((n=(a=(s=(o=r?.firstWeekContainsDate)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.firstWeekContainsDate)!==null&&s!==void 0?s:f.firstWeekContainsDate)!==null&&a!==void 0?a:(u=f.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.firstWeekContainsDate)!==null&&n!==void 0?n:1);if(!(_>=1&&_<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var v=new Date(0);v.setUTCFullYear(m+1,0,_),v.setUTCHours(0,0,0,0);var w=ss(v,r),b=new Date(0);b.setUTCFullYear(m,0,_),b.setUTCHours(0,0,0,0);var P=ss(b,r);return p.getTime()>=w.getTime()?m+1:p.getTime()>=P.getTime()?m:m-1}function e_(t,r){var n,a,s,o,i,c,u,d;qe(1,arguments);var p=nn(),m=Rt((n=(a=(s=(o=r?.firstWeekContainsDate)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.firstWeekContainsDate)!==null&&s!==void 0?s:p.firstWeekContainsDate)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.firstWeekContainsDate)!==null&&n!==void 0?n:1),f=$l(t,r),_=new Date(0);_.setUTCFullYear(f,0,m),_.setUTCHours(0,0,0,0);var v=ss(_,r);return v}var t_=6048e5;function Xp(t,r){qe(1,arguments);var n=Le(t),a=ss(n,r).getTime()-e_(n,r).getTime();return Math.round(a/t_)+1}function Et(t,r){for(var n=t<0?"-":"",a=Math.abs(t).toString();a.length<r;)a="0"+a;return n+a}var Pn={y:function(r,n){var a=r.getUTCFullYear(),s=a>0?a:1-a;return Et(n==="yy"?s%100:s,n.length)},M:function(r,n){var a=r.getUTCMonth();return n==="M"?String(a+1):Et(a+1,2)},d:function(r,n){return Et(r.getUTCDate(),n.length)},a:function(r,n){var a=r.getUTCHours()/12>=1?"pm":"am";switch(n){case"a":case"aa":return a.toUpperCase();case"aaa":return a;case"aaaaa":return a[0];case"aaaa":default:return a==="am"?"a.m.":"p.m."}},h:function(r,n){return Et(r.getUTCHours()%12||12,n.length)},H:function(r,n){return Et(r.getUTCHours(),n.length)},m:function(r,n){return Et(r.getUTCMinutes(),n.length)},s:function(r,n){return Et(r.getUTCSeconds(),n.length)},S:function(r,n){var a=n.length,s=r.getUTCMilliseconds(),o=Math.floor(s*Math.pow(10,a-3));return Et(o,n.length)}},bs={midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},r_={G:function(r,n,a){var s=r.getUTCFullYear()>0?1:0;switch(n){case"G":case"GG":case"GGG":return a.era(s,{width:"abbreviated"});case"GGGGG":return a.era(s,{width:"narrow"});case"GGGG":default:return a.era(s,{width:"wide"})}},y:function(r,n,a){if(n==="yo"){var s=r.getUTCFullYear(),o=s>0?s:1-s;return a.ordinalNumber(o,{unit:"year"})}return Pn.y(r,n)},Y:function(r,n,a,s){var o=$l(r,s),i=o>0?o:1-o;if(n==="YY"){var c=i%100;return Et(c,2)}return n==="Yo"?a.ordinalNumber(i,{unit:"year"}):Et(i,n.length)},R:function(r,n){var a=Kp(r);return Et(a,n.length)},u:function(r,n){var a=r.getUTCFullYear();return Et(a,n.length)},Q:function(r,n,a){var s=Math.ceil((r.getUTCMonth()+1)/3);switch(n){case"Q":return String(s);case"QQ":return Et(s,2);case"Qo":return a.ordinalNumber(s,{unit:"quarter"});case"QQQ":return a.quarter(s,{width:"abbreviated",context:"formatting"});case"QQQQQ":return a.quarter(s,{width:"narrow",context:"formatting"});case"QQQQ":default:return a.quarter(s,{width:"wide",context:"formatting"})}},q:function(r,n,a){var s=Math.ceil((r.getUTCMonth()+1)/3);switch(n){case"q":return String(s);case"qq":return Et(s,2);case"qo":return a.ordinalNumber(s,{unit:"quarter"});case"qqq":return a.quarter(s,{width:"abbreviated",context:"standalone"});case"qqqqq":return a.quarter(s,{width:"narrow",context:"standalone"});case"qqqq":default:return a.quarter(s,{width:"wide",context:"standalone"})}},M:function(r,n,a){var s=r.getUTCMonth();switch(n){case"M":case"MM":return Pn.M(r,n);case"Mo":return a.ordinalNumber(s+1,{unit:"month"});case"MMM":return a.month(s,{width:"abbreviated",context:"formatting"});case"MMMMM":return a.month(s,{width:"narrow",context:"formatting"});case"MMMM":default:return a.month(s,{width:"wide",context:"formatting"})}},L:function(r,n,a){var s=r.getUTCMonth();switch(n){case"L":return String(s+1);case"LL":return Et(s+1,2);case"Lo":return a.ordinalNumber(s+1,{unit:"month"});case"LLL":return a.month(s,{width:"abbreviated",context:"standalone"});case"LLLLL":return a.month(s,{width:"narrow",context:"standalone"});case"LLLL":default:return a.month(s,{width:"wide",context:"standalone"})}},w:function(r,n,a,s){var o=Xp(r,s);return n==="wo"?a.ordinalNumber(o,{unit:"week"}):Et(o,n.length)},I:function(r,n,a){var s=Jp(r);return n==="Io"?a.ordinalNumber(s,{unit:"week"}):Et(s,n.length)},d:function(r,n,a){return n==="do"?a.ordinalNumber(r.getUTCDate(),{unit:"date"}):Pn.d(r,n)},D:function(r,n,a){var s=Jb(r);return n==="Do"?a.ordinalNumber(s,{unit:"dayOfYear"}):Et(s,n.length)},E:function(r,n,a){var s=r.getUTCDay();switch(n){case"E":case"EE":case"EEE":return a.day(s,{width:"abbreviated",context:"formatting"});case"EEEEE":return a.day(s,{width:"narrow",context:"formatting"});case"EEEEEE":return a.day(s,{width:"short",context:"formatting"});case"EEEE":default:return a.day(s,{width:"wide",context:"formatting"})}},e:function(r,n,a,s){var o=r.getUTCDay(),i=(o-s.weekStartsOn+8)%7||7;switch(n){case"e":return String(i);case"ee":return Et(i,2);case"eo":return a.ordinalNumber(i,{unit:"day"});case"eee":return a.day(o,{width:"abbreviated",context:"formatting"});case"eeeee":return a.day(o,{width:"narrow",context:"formatting"});case"eeeeee":return a.day(o,{width:"short",context:"formatting"});case"eeee":default:return a.day(o,{width:"wide",context:"formatting"})}},c:function(r,n,a,s){var o=r.getUTCDay(),i=(o-s.weekStartsOn+8)%7||7;switch(n){case"c":return String(i);case"cc":return Et(i,n.length);case"co":return a.ordinalNumber(i,{unit:"day"});case"ccc":return a.day(o,{width:"abbreviated",context:"standalone"});case"ccccc":return a.day(o,{width:"narrow",context:"standalone"});case"cccccc":return a.day(o,{width:"short",context:"standalone"});case"cccc":default:return a.day(o,{width:"wide",context:"standalone"})}},i:function(r,n,a){var s=r.getUTCDay(),o=s===0?7:s;switch(n){case"i":return String(o);case"ii":return Et(o,n.length);case"io":return a.ordinalNumber(o,{unit:"day"});case"iii":return a.day(s,{width:"abbreviated",context:"formatting"});case"iiiii":return a.day(s,{width:"narrow",context:"formatting"});case"iiiiii":return a.day(s,{width:"short",context:"formatting"});case"iiii":default:return a.day(s,{width:"wide",context:"formatting"})}},a:function(r,n,a){var s=r.getUTCHours(),o=s/12>=1?"pm":"am";switch(n){case"a":case"aa":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"});case"aaa":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return a.dayPeriod(o,{width:"narrow",context:"formatting"});case"aaaa":default:return a.dayPeriod(o,{width:"wide",context:"formatting"})}},b:function(r,n,a){var s=r.getUTCHours(),o;switch(s===12?o=bs.noon:s===0?o=bs.midnight:o=s/12>=1?"pm":"am",n){case"b":case"bb":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"});case"bbb":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return a.dayPeriod(o,{width:"narrow",context:"formatting"});case"bbbb":default:return a.dayPeriod(o,{width:"wide",context:"formatting"})}},B:function(r,n,a){var s=r.getUTCHours(),o;switch(s>=17?o=bs.evening:s>=12?o=bs.afternoon:s>=4?o=bs.morning:o=bs.night,n){case"B":case"BB":case"BBB":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"});case"BBBBB":return a.dayPeriod(o,{width:"narrow",context:"formatting"});case"BBBB":default:return a.dayPeriod(o,{width:"wide",context:"formatting"})}},h:function(r,n,a){if(n==="ho"){var s=r.getUTCHours()%12;return s===0&&(s=12),a.ordinalNumber(s,{unit:"hour"})}return Pn.h(r,n)},H:function(r,n,a){return n==="Ho"?a.ordinalNumber(r.getUTCHours(),{unit:"hour"}):Pn.H(r,n)},K:function(r,n,a){var s=r.getUTCHours()%12;return n==="Ko"?a.ordinalNumber(s,{unit:"hour"}):Et(s,n.length)},k:function(r,n,a){var s=r.getUTCHours();return s===0&&(s=24),n==="ko"?a.ordinalNumber(s,{unit:"hour"}):Et(s,n.length)},m:function(r,n,a){return n==="mo"?a.ordinalNumber(r.getUTCMinutes(),{unit:"minute"}):Pn.m(r,n)},s:function(r,n,a){return n==="so"?a.ordinalNumber(r.getUTCSeconds(),{unit:"second"}):Pn.s(r,n)},S:function(r,n){return Pn.S(r,n)},X:function(r,n,a,s){var o=s._originalDate||r,i=o.getTimezoneOffset();if(i===0)return"Z";switch(n){case"X":return Ed(i);case"XXXX":case"XX":return Kn(i);case"XXXXX":case"XXX":default:return Kn(i,":")}},x:function(r,n,a,s){var o=s._originalDate||r,i=o.getTimezoneOffset();switch(n){case"x":return Ed(i);case"xxxx":case"xx":return Kn(i);case"xxxxx":case"xxx":default:return Kn(i,":")}},O:function(r,n,a,s){var o=s._originalDate||r,i=o.getTimezoneOffset();switch(n){case"O":case"OO":case"OOO":return"GMT"+Pd(i,":");case"OOOO":default:return"GMT"+Kn(i,":")}},z:function(r,n,a,s){var o=s._originalDate||r,i=o.getTimezoneOffset();switch(n){case"z":case"zz":case"zzz":return"GMT"+Pd(i,":");case"zzzz":default:return"GMT"+Kn(i,":")}},t:function(r,n,a,s){var o=s._originalDate||r,i=Math.floor(o.getTime()/1e3);return Et(i,n.length)},T:function(r,n,a,s){var o=s._originalDate||r,i=o.getTime();return Et(i,n.length)}};function Pd(t,r){var n=t>0?"-":"+",a=Math.abs(t),s=Math.floor(a/60),o=a%60;if(o===0)return n+String(s);var i=r;return n+String(s)+i+Et(o,2)}function Ed(t,r){if(t%60===0){var n=t>0?"-":"+";return n+Et(Math.abs(t)/60,2)}return Kn(t,r)}function Kn(t,r){var n=r||"",a=t>0?"-":"+",s=Math.abs(t),o=Et(Math.floor(s/60),2),i=Et(s%60,2);return a+o+n+i}var Dd=function(r,n){switch(r){case"P":return n.date({width:"short"});case"PP":return n.date({width:"medium"});case"PPP":return n.date({width:"long"});case"PPPP":default:return n.date({width:"full"})}},Zp=function(r,n){switch(r){case"p":return n.time({width:"short"});case"pp":return n.time({width:"medium"});case"ppp":return n.time({width:"long"});case"pppp":default:return n.time({width:"full"})}},n_=function(r,n){var a=r.match(/(P+)(p+)?/)||[],s=a[1],o=a[2];if(!o)return Dd(r,n);var i;switch(s){case"P":i=n.dateTime({width:"short"});break;case"PP":i=n.dateTime({width:"medium"});break;case"PPP":i=n.dateTime({width:"long"});break;case"PPPP":default:i=n.dateTime({width:"full"});break}return i.replace("{{date}}",Dd(s,n)).replace("{{time}}",Zp(o,n))},jl={p:Zp,P:n_},s_=["D","DD"],a_=["YY","YYYY"];function eh(t){return s_.indexOf(t)!==-1}function th(t){return a_.indexOf(t)!==-1}function Vo(t,r,n){if(t==="YYYY")throw new RangeError("Use `yyyy` instead of `YYYY` (in `".concat(r,"`) for formatting years to the input `").concat(n,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"));if(t==="YY")throw new RangeError("Use `yy` instead of `YY` (in `".concat(r,"`) for formatting years to the input `").concat(n,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"));if(t==="D")throw new RangeError("Use `d` instead of `D` (in `".concat(r,"`) for formatting days of the month to the input `").concat(n,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"));if(t==="DD")throw new RangeError("Use `dd` instead of `DD` (in `".concat(r,"`) for formatting days of the month to the input `").concat(n,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"))}var o_={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},i_=function(r,n,a){var s,o=o_[r];return typeof o=="string"?s=o:n===1?s=o.one:s=o.other.replace("{{count}}",n.toString()),a!=null&&a.addSuffix?a.comparison&&a.comparison>0?"in "+s:s+" ago":s};function Yi(t){return function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},n=r.width?String(r.width):t.defaultWidth,a=t.formats[n]||t.formats[t.defaultWidth];return a}}var l_={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},c_={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},d_={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},u_={date:Yi({formats:l_,defaultWidth:"full"}),time:Yi({formats:c_,defaultWidth:"full"}),dateTime:Yi({formats:d_,defaultWidth:"full"})},p_={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},h_=function(r,n,a,s){return p_[r]};function ja(t){return function(r,n){var a=n!=null&&n.context?String(n.context):"standalone",s;if(a==="formatting"&&t.formattingValues){var o=t.defaultFormattingWidth||t.defaultWidth,i=n!=null&&n.width?String(n.width):o;s=t.formattingValues[i]||t.formattingValues[o]}else{var c=t.defaultWidth,u=n!=null&&n.width?String(n.width):t.defaultWidth;s=t.values[u]||t.values[c]}var d=t.argumentCallback?t.argumentCallback(r):r;return s[d]}}var m_={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},f_={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},x_={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},g_={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},y_={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},v_={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},b_=function(r,n){var a=Number(r),s=a%100;if(s>20||s<10)switch(s%10){case 1:return a+"st";case 2:return a+"nd";case 3:return a+"rd"}return a+"th"},__={ordinalNumber:b_,era:ja({values:m_,defaultWidth:"wide"}),quarter:ja({values:f_,defaultWidth:"wide",argumentCallback:function(r){return r-1}}),month:ja({values:x_,defaultWidth:"wide"}),day:ja({values:g_,defaultWidth:"wide"}),dayPeriod:ja({values:y_,defaultWidth:"wide",formattingValues:v_,defaultFormattingWidth:"wide"})};function wa(t){return function(r){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},a=n.width,s=a&&t.matchPatterns[a]||t.matchPatterns[t.defaultMatchWidth],o=r.match(s);if(!o)return null;var i=o[0],c=a&&t.parsePatterns[a]||t.parsePatterns[t.defaultParseWidth],u=Array.isArray(c)?w_(c,function(m){return m.test(i)}):j_(c,function(m){return m.test(i)}),d;d=t.valueCallback?t.valueCallback(u):u,d=n.valueCallback?n.valueCallback(d):d;var p=r.slice(i.length);return{value:d,rest:p}}}function j_(t,r){for(var n in t)if(t.hasOwnProperty(n)&&r(t[n]))return n}function w_(t,r){for(var n=0;n<t.length;n++)if(r(t[n]))return n}function S_(t){return function(r){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},a=r.match(t.matchPattern);if(!a)return null;var s=a[0],o=r.match(t.parsePattern);if(!o)return null;var i=t.valueCallback?t.valueCallback(o[0]):o[0];i=n.valueCallback?n.valueCallback(i):i;var c=r.slice(s.length);return{value:i,rest:c}}}var C_=/^(\d+)(th|st|nd|rd)?/i,k_=/\d+/i,P_={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},E_={any:[/^b/i,/^(a|c)/i]},D_={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},T_={any:[/1/i,/2/i,/3/i,/4/i]},I_={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},O_={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},A_={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},M_={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},R_={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},N_={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},L_={ordinalNumber:S_({matchPattern:C_,parsePattern:k_,valueCallback:function(r){return parseInt(r,10)}}),era:wa({matchPatterns:P_,defaultMatchWidth:"wide",parsePatterns:E_,defaultParseWidth:"any"}),quarter:wa({matchPatterns:D_,defaultMatchWidth:"wide",parsePatterns:T_,defaultParseWidth:"any",valueCallback:function(r){return r+1}}),month:wa({matchPatterns:I_,defaultMatchWidth:"wide",parsePatterns:O_,defaultParseWidth:"any"}),day:wa({matchPatterns:A_,defaultMatchWidth:"wide",parsePatterns:M_,defaultParseWidth:"any"}),dayPeriod:wa({matchPatterns:R_,defaultMatchWidth:"any",parsePatterns:N_,defaultParseWidth:"any"})},_i={code:"en-US",formatDistance:i_,formatLong:u_,formatRelative:h_,localize:__,match:L_,options:{weekStartsOn:0,firstWeekContainsDate:1}},q_=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,U_=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,F_=/^'([^]*?)'?$/,W_=/''/g,$_=/[a-zA-Z]/;function Cs(t,r,n){var a,s,o,i,c,u,d,p,m,f,_,v,w,b,P,N,j,E;qe(2,arguments);var A=String(r),C=nn(),L=(a=(s=n?.locale)!==null&&s!==void 0?s:C.locale)!==null&&a!==void 0?a:_i,y=Rt((o=(i=(c=(u=n?.firstWeekContainsDate)!==null&&u!==void 0?u:n==null||(d=n.locale)===null||d===void 0||(p=d.options)===null||p===void 0?void 0:p.firstWeekContainsDate)!==null&&c!==void 0?c:C.firstWeekContainsDate)!==null&&i!==void 0?i:(m=C.locale)===null||m===void 0||(f=m.options)===null||f===void 0?void 0:f.firstWeekContainsDate)!==null&&o!==void 0?o:1);if(!(y>=1&&y<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var x=Rt((_=(v=(w=(b=n?.weekStartsOn)!==null&&b!==void 0?b:n==null||(P=n.locale)===null||P===void 0||(N=P.options)===null||N===void 0?void 0:N.weekStartsOn)!==null&&w!==void 0?w:C.weekStartsOn)!==null&&v!==void 0?v:(j=C.locale)===null||j===void 0||(E=j.options)===null||E===void 0?void 0:E.weekStartsOn)!==null&&_!==void 0?_:0);if(!(x>=0&&x<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");if(!L.localize)throw new RangeError("locale must contain localize property");if(!L.formatLong)throw new RangeError("locale must contain formatLong property");var D=Le(t);if(!Yp(D))throw new RangeError("Invalid time value");var M=Ms(D),X=Qp(D,M),H={firstWeekContainsDate:y,weekStartsOn:x,locale:L,_originalDate:D},U=A.match(U_).map(function(G){var te=G[0];if(te==="p"||te==="P"){var re=jl[te];return re(G,L.formatLong)}return G}).join("").match(q_).map(function(G){if(G==="''")return"'";var te=G[0];if(te==="'")return z_(G);var re=r_[te];if(re)return!(n!=null&&n.useAdditionalWeekYearTokens)&&th(G)&&Vo(G,r,String(t)),!(n!=null&&n.useAdditionalDayOfYearTokens)&&eh(G)&&Vo(G,r,String(t)),re(X,G,L.localize,H);if(te.match($_))throw new RangeError("Format string contains an unescaped latin alphabet character `"+te+"`");return G}).join("");return U}function z_(t){var r=t.match(F_);return r?r[1].replace(W_,"'"):t}function zl(t,r){if(t==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n]);return t}function B_(t){return zl({},t)}var Td=1e3*60,Go=60*24,Id=Go*30,Od=Go*365;function H_(t,r,n){var a,s,o;qe(2,arguments);var i=nn(),c=(a=(s=n?.locale)!==null&&s!==void 0?s:i.locale)!==null&&a!==void 0?a:_i;if(!c.formatDistance)throw new RangeError("locale must contain localize.formatDistance property");var u=Os(t,r);if(isNaN(u))throw new RangeError("Invalid time value");var d=zl(B_(n),{addSuffix:!!n?.addSuffix,comparison:u}),p,m;u>0?(p=Le(r),m=Le(t)):(p=Le(t),m=Le(r));var f=String((o=n?.roundingMethod)!==null&&o!==void 0?o:"round"),_;if(f==="floor")_=Math.floor;else if(f==="ceil")_=Math.ceil;else if(f==="round")_=Math.round;else throw new RangeError("roundingMethod must be 'floor', 'ceil' or 'round'");var v=m.getTime()-p.getTime(),w=v/Td,b=Ms(m)-Ms(p),P=(v-b)/Td,N=n?.unit,j;if(N?j=String(N):w<1?j="second":w<60?j="minute":w<Go?j="hour":P<Id?j="day":P<Od?j="month":j="year",j==="second"){var E=_(v/1e3);return c.formatDistance("xSeconds",E,d)}else if(j==="minute"){var A=_(w);return c.formatDistance("xMinutes",A,d)}else if(j==="hour"){var C=_(w/60);return c.formatDistance("xHours",C,d)}else if(j==="day"){var L=_(P/Go);return c.formatDistance("xDays",L,d)}else if(j==="month"){var y=_(P/Id);return y===12&&N!=="month"?c.formatDistance("xYears",1,d):c.formatDistance("xMonths",y,d)}else if(j==="year"){var x=_(P/Od);return c.formatDistance("xYears",x,d)}throw new RangeError("unit must be 'second', 'minute', 'hour', 'day', 'month' or 'year'")}function Y_(t,r){return qe(1,arguments),H_(t,Date.now(),r)}function V_(t,r){var n,a;qe(1,arguments);var s=Le(t);if(isNaN(s.getTime()))throw new RangeError("Invalid time value");var o=String((n=r?.format)!==null&&n!==void 0?n:"extended"),i=String((a=r?.representation)!==null&&a!==void 0?a:"complete");if(o!=="extended"&&o!=="basic")throw new RangeError("format must be 'extended' or 'basic'");if(i!=="date"&&i!=="time"&&i!=="complete")throw new RangeError("representation must be 'date', 'time', or 'complete'");var c="",u="",d=o==="extended"?"-":"",p=o==="extended"?":":"";if(i!=="time"){var m=Et(s.getDate(),2),f=Et(s.getMonth()+1,2),_=Et(s.getFullYear(),4);c="".concat(_).concat(d).concat(f).concat(d).concat(m)}if(i!=="date"){var v=s.getTimezoneOffset();if(v!==0){var w=Math.abs(v),b=Et(Math.floor(w/60),2),P=Et(w%60,2),N=v<0?"+":"-";u="".concat(N).concat(b,":").concat(P)}else u="Z";var j=Et(s.getHours(),2),E=Et(s.getMinutes(),2),A=Et(s.getSeconds(),2),C=c===""?"":"T",L=[j,E,A].join(p);c="".concat(c).concat(C).concat(L).concat(u)}return c}function G_(t){qe(1,arguments);var r=Le(t),n=r.getDate();return n}function rh(t){qe(1,arguments);var r=Le(t),n=r.getFullYear(),a=r.getMonth(),s=new Date(0);return s.setFullYear(n,a+1,0),s.setHours(0,0,0,0),s.getDate()}function Q_(t){qe(1,arguments);var r=Le(t),n=r.getHours();return n}function K_(t){qe(1,arguments);var r=Le(t),n=r.getMilliseconds();return n}function J_(t){qe(1,arguments);var r=Le(t),n=r.getMinutes();return n}function X_(t){qe(1,arguments);var r=Le(t),n=r.getMonth();return n}function Z_(t){qe(1,arguments);var r=Le(t),n=r.getSeconds();return n}function ej(t,r){var n,a,s,o,i,c,u,d;qe(1,arguments);var p=Le(t),m=p.getFullYear(),f=nn(),_=Rt((n=(a=(s=(o=r?.firstWeekContainsDate)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.firstWeekContainsDate)!==null&&s!==void 0?s:f.firstWeekContainsDate)!==null&&a!==void 0?a:(u=f.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.firstWeekContainsDate)!==null&&n!==void 0?n:1);if(!(_>=1&&_<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var v=new Date(0);v.setFullYear(m+1,0,_),v.setHours(0,0,0,0);var w=ts(v,r),b=new Date(0);b.setFullYear(m,0,_),b.setHours(0,0,0,0);var P=ts(b,r);return p.getTime()>=w.getTime()?m+1:p.getTime()>=P.getTime()?m:m-1}function tj(t,r){var n,a,s,o,i,c,u,d;qe(1,arguments);var p=nn(),m=Rt((n=(a=(s=(o=r?.firstWeekContainsDate)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.firstWeekContainsDate)!==null&&s!==void 0?s:p.firstWeekContainsDate)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.firstWeekContainsDate)!==null&&n!==void 0?n:1),f=ej(t,r),_=new Date(0);_.setFullYear(f,0,m),_.setHours(0,0,0,0);var v=ts(_,r);return v}var rj=6048e5;function nj(t,r){qe(1,arguments);var n=Le(t),a=ts(n,r).getTime()-tj(n,r).getTime();return Math.round(a/rj)+1}function sj(t){return qe(1,arguments),Le(t).getFullYear()}function Vi(t,r){qe(2,arguments);var n=Le(t),a=Le(r);return n.getTime()>a.getTime()}function Sa(t,r){qe(2,arguments);var n=Le(t),a=Le(r);return n.getTime()<a.getTime()}function aj(t,r){qe(2,arguments);var n=Le(t),a=Le(r);return n.getTime()===a.getTime()}function Ad(t,r){(r==null||r>t.length)&&(r=t.length);for(var n=0,a=Array(r);n<r;n++)a[n]=t[n];return a}function oj(t,r){if(t){if(typeof t=="string")return Ad(t,r);var n={}.toString.call(t).slice(8,-1);return n==="Object"&&t.constructor&&(n=t.constructor.name),n==="Map"||n==="Set"?Array.from(t):n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ad(t,r):void 0}}function Md(t,r){var n=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=oj(t))||r){n&&(t=n);var a=0,s=function(){};return{s,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(d){throw d},f:s}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var o,i=!0,c=!1;return{s:function(){n=n.call(t)},n:function(){var d=n.next();return i=d.done,d},e:function(d){c=!0,o=d},f:function(){try{i||n.return==null||n.return()}finally{if(c)throw o}}}}function Nt(t,r){if(typeof r!="function"&&r!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&qh(t,r)}function Qo(t){return Qo=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(r){return r.__proto__||Object.getPrototypeOf(r)},Qo(t)}function nh(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(nh=function(){return!!t})()}function ij(t,r){if(r&&(ei(r)=="object"||typeof r=="function"))return r;if(r!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Ke(t)}function Lt(t){var r=nh();return function(){var n,a=Qo(t);if(r){var s=Qo(this).constructor;n=Reflect.construct(a,arguments,s)}else n=a.apply(this,arguments);return ij(this,n)}}function Tt(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function lj(t,r){for(var n=0;n<r.length;n++){var a=r[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,Ru(a.key),a)}}function It(t,r,n){return r&&lj(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function He(t,r,n){return(r=Ru(r))in t?Object.defineProperty(t,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[r]=n,t}var cj=10,sh=function(){function t(){Tt(this,t),He(this,"priority",void 0),He(this,"subPriority",0)}return It(t,[{key:"validate",value:function(n,a){return!0}}]),t}(),dj=function(t){Nt(n,t);var r=Lt(n);function n(a,s,o,i,c){var u;return Tt(this,n),u=r.call(this),u.value=a,u.validateValue=s,u.setValue=o,u.priority=i,c&&(u.subPriority=c),u}return It(n,[{key:"validate",value:function(s,o){return this.validateValue(s,this.value,o)}},{key:"set",value:function(s,o,i){return this.setValue(s,o,this.value,i)}}]),n}(sh),uj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",cj),He(Ke(a),"subPriority",-1),a}return It(n,[{key:"set",value:function(s,o){if(o.timestampIsSet)return s;var i=new Date(0);return i.setFullYear(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate()),i.setHours(s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds(),s.getUTCMilliseconds()),i}}]),n}(sh),Ft=function(){function t(){Tt(this,t),He(this,"incompatibleTokens",void 0),He(this,"priority",void 0),He(this,"subPriority",void 0)}return It(t,[{key:"run",value:function(n,a,s,o){var i=this.parse(n,a,s,o);return i?{setter:new dj(i.value,this.validate,this.set,this.priority,this.subPriority),rest:i.rest}:null}},{key:"validate",value:function(n,a,s){return!0}}]),t}(),pj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",140),He(Ke(a),"incompatibleTokens",["R","u","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"G":case"GG":case"GGG":return i.era(s,{width:"abbreviated"})||i.era(s,{width:"narrow"});case"GGGGG":return i.era(s,{width:"narrow"});case"GGGG":default:return i.era(s,{width:"wide"})||i.era(s,{width:"abbreviated"})||i.era(s,{width:"narrow"})}}},{key:"set",value:function(s,o,i){return o.era=i,s.setUTCFullYear(i,0,1),s.setUTCHours(0,0,0,0),s}}]),n}(Ft),nr={month:/^(1[0-2]|0?\d)/,date:/^(3[0-1]|[0-2]?\d)/,dayOfYear:/^(36[0-6]|3[0-5]\d|[0-2]?\d?\d)/,week:/^(5[0-3]|[0-4]?\d)/,hour23h:/^(2[0-3]|[0-1]?\d)/,hour24h:/^(2[0-4]|[0-1]?\d)/,hour11h:/^(1[0-1]|0?\d)/,hour12h:/^(1[0-2]|0?\d)/,minute:/^[0-5]?\d/,second:/^[0-5]?\d/,singleDigit:/^\d/,twoDigits:/^\d{1,2}/,threeDigits:/^\d{1,3}/,fourDigits:/^\d{1,4}/,anyDigitsSigned:/^-?\d+/,singleDigitSigned:/^-?\d/,twoDigitsSigned:/^-?\d{1,2}/,threeDigitsSigned:/^-?\d{1,3}/,fourDigitsSigned:/^-?\d{1,4}/},ln={basicOptionalMinutes:/^([+-])(\d{2})(\d{2})?|Z/,basic:/^([+-])(\d{2})(\d{2})|Z/,basicOptionalSeconds:/^([+-])(\d{2})(\d{2})((\d{2}))?|Z/,extended:/^([+-])(\d{2}):(\d{2})|Z/,extendedOptionalSeconds:/^([+-])(\d{2}):(\d{2})(:(\d{2}))?|Z/};function sr(t,r){return t&&{value:r(t.value),rest:t.rest}}function Xt(t,r){var n=r.match(t);return n?{value:parseInt(n[0],10),rest:r.slice(n[0].length)}:null}function cn(t,r){var n=r.match(t);if(!n)return null;if(n[0]==="Z")return{value:0,rest:r.slice(1)};var a=n[1]==="+"?1:-1,s=n[2]?parseInt(n[2],10):0,o=n[3]?parseInt(n[3],10):0,i=n[5]?parseInt(n[5],10):0;return{value:a*(s*vi+o*yi+i*Nb),rest:r.slice(n[0].length)}}function ah(t){return Xt(nr.anyDigitsSigned,t)}function Zt(t,r){switch(t){case 1:return Xt(nr.singleDigit,r);case 2:return Xt(nr.twoDigits,r);case 3:return Xt(nr.threeDigits,r);case 4:return Xt(nr.fourDigits,r);default:return Xt(new RegExp("^\\d{1,"+t+"}"),r)}}function Ko(t,r){switch(t){case 1:return Xt(nr.singleDigitSigned,r);case 2:return Xt(nr.twoDigitsSigned,r);case 3:return Xt(nr.threeDigitsSigned,r);case 4:return Xt(nr.fourDigitsSigned,r);default:return Xt(new RegExp("^-?\\d{1,"+t+"}"),r)}}function Bl(t){switch(t){case"morning":return 4;case"evening":return 17;case"pm":case"noon":case"afternoon":return 12;case"am":case"midnight":case"night":default:return 0}}function oh(t,r){var n=r>0,a=n?r:1-r,s;if(a<=50)s=t||100;else{var o=a+50,i=Math.floor(o/100)*100,c=t>=o%100;s=t+i-(c?100:0)}return n?s:1-s}function ih(t){return t%400===0||t%4===0&&t%100!==0}var hj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",130),He(Ke(a),"incompatibleTokens",["Y","R","u","w","I","i","e","c","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){var c=function(d){return{year:d,isTwoDigitYear:o==="yy"}};switch(o){case"y":return sr(Zt(4,s),c);case"yo":return sr(i.ordinalNumber(s,{unit:"year"}),c);default:return sr(Zt(o.length,s),c)}}},{key:"validate",value:function(s,o){return o.isTwoDigitYear||o.year>0}},{key:"set",value:function(s,o,i){var c=s.getUTCFullYear();if(i.isTwoDigitYear){var u=oh(i.year,c);return s.setUTCFullYear(u,0,1),s.setUTCHours(0,0,0,0),s}var d=!("era"in o)||o.era===1?i.year:1-i.year;return s.setUTCFullYear(d,0,1),s.setUTCHours(0,0,0,0),s}}]),n}(Ft),mj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",130),He(Ke(a),"incompatibleTokens",["y","R","u","Q","q","M","L","I","d","D","i","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){var c=function(d){return{year:d,isTwoDigitYear:o==="YY"}};switch(o){case"Y":return sr(Zt(4,s),c);case"Yo":return sr(i.ordinalNumber(s,{unit:"year"}),c);default:return sr(Zt(o.length,s),c)}}},{key:"validate",value:function(s,o){return o.isTwoDigitYear||o.year>0}},{key:"set",value:function(s,o,i,c){var u=$l(s,c);if(i.isTwoDigitYear){var d=oh(i.year,u);return s.setUTCFullYear(d,0,c.firstWeekContainsDate),s.setUTCHours(0,0,0,0),ss(s,c)}var p=!("era"in o)||o.era===1?i.year:1-i.year;return s.setUTCFullYear(p,0,c.firstWeekContainsDate),s.setUTCHours(0,0,0,0),ss(s,c)}}]),n}(Ft),fj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",130),He(Ke(a),"incompatibleTokens",["G","y","Y","u","Q","q","M","L","w","d","D","e","c","t","T"]),a}return It(n,[{key:"parse",value:function(s,o){return Ko(o==="R"?4:o.length,s)}},{key:"set",value:function(s,o,i){var c=new Date(0);return c.setUTCFullYear(i,0,4),c.setUTCHours(0,0,0,0),Ns(c)}}]),n}(Ft),xj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",130),He(Ke(a),"incompatibleTokens",["G","y","Y","R","w","I","i","e","c","t","T"]),a}return It(n,[{key:"parse",value:function(s,o){return Ko(o==="u"?4:o.length,s)}},{key:"set",value:function(s,o,i){return s.setUTCFullYear(i,0,1),s.setUTCHours(0,0,0,0),s}}]),n}(Ft),gj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",120),He(Ke(a),"incompatibleTokens",["Y","R","q","M","L","w","I","d","D","i","e","c","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"Q":case"QQ":return Zt(o.length,s);case"Qo":return i.ordinalNumber(s,{unit:"quarter"});case"QQQ":return i.quarter(s,{width:"abbreviated",context:"formatting"})||i.quarter(s,{width:"narrow",context:"formatting"});case"QQQQQ":return i.quarter(s,{width:"narrow",context:"formatting"});case"QQQQ":default:return i.quarter(s,{width:"wide",context:"formatting"})||i.quarter(s,{width:"abbreviated",context:"formatting"})||i.quarter(s,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(s,o){return o>=1&&o<=4}},{key:"set",value:function(s,o,i){return s.setUTCMonth((i-1)*3,1),s.setUTCHours(0,0,0,0),s}}]),n}(Ft),yj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",120),He(Ke(a),"incompatibleTokens",["Y","R","Q","M","L","w","I","d","D","i","e","c","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"q":case"qq":return Zt(o.length,s);case"qo":return i.ordinalNumber(s,{unit:"quarter"});case"qqq":return i.quarter(s,{width:"abbreviated",context:"standalone"})||i.quarter(s,{width:"narrow",context:"standalone"});case"qqqqq":return i.quarter(s,{width:"narrow",context:"standalone"});case"qqqq":default:return i.quarter(s,{width:"wide",context:"standalone"})||i.quarter(s,{width:"abbreviated",context:"standalone"})||i.quarter(s,{width:"narrow",context:"standalone"})}}},{key:"validate",value:function(s,o){return o>=1&&o<=4}},{key:"set",value:function(s,o,i){return s.setUTCMonth((i-1)*3,1),s.setUTCHours(0,0,0,0),s}}]),n}(Ft),vj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"incompatibleTokens",["Y","R","q","Q","L","w","I","D","i","e","c","t","T"]),He(Ke(a),"priority",110),a}return It(n,[{key:"parse",value:function(s,o,i){var c=function(d){return d-1};switch(o){case"M":return sr(Xt(nr.month,s),c);case"MM":return sr(Zt(2,s),c);case"Mo":return sr(i.ordinalNumber(s,{unit:"month"}),c);case"MMM":return i.month(s,{width:"abbreviated",context:"formatting"})||i.month(s,{width:"narrow",context:"formatting"});case"MMMMM":return i.month(s,{width:"narrow",context:"formatting"});case"MMMM":default:return i.month(s,{width:"wide",context:"formatting"})||i.month(s,{width:"abbreviated",context:"formatting"})||i.month(s,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(s,o){return o>=0&&o<=11}},{key:"set",value:function(s,o,i){return s.setUTCMonth(i,1),s.setUTCHours(0,0,0,0),s}}]),n}(Ft),bj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",110),He(Ke(a),"incompatibleTokens",["Y","R","q","Q","M","w","I","D","i","e","c","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){var c=function(d){return d-1};switch(o){case"L":return sr(Xt(nr.month,s),c);case"LL":return sr(Zt(2,s),c);case"Lo":return sr(i.ordinalNumber(s,{unit:"month"}),c);case"LLL":return i.month(s,{width:"abbreviated",context:"standalone"})||i.month(s,{width:"narrow",context:"standalone"});case"LLLLL":return i.month(s,{width:"narrow",context:"standalone"});case"LLLL":default:return i.month(s,{width:"wide",context:"standalone"})||i.month(s,{width:"abbreviated",context:"standalone"})||i.month(s,{width:"narrow",context:"standalone"})}}},{key:"validate",value:function(s,o){return o>=0&&o<=11}},{key:"set",value:function(s,o,i){return s.setUTCMonth(i,1),s.setUTCHours(0,0,0,0),s}}]),n}(Ft);function _j(t,r,n){qe(2,arguments);var a=Le(t),s=Rt(r),o=Xp(a,n)-s;return a.setUTCDate(a.getUTCDate()-o*7),a}var jj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",100),He(Ke(a),"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","i","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"w":return Xt(nr.week,s);case"wo":return i.ordinalNumber(s,{unit:"week"});default:return Zt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=1&&o<=53}},{key:"set",value:function(s,o,i,c){return ss(_j(s,i,c),c)}}]),n}(Ft);function wj(t,r){qe(2,arguments);var n=Le(t),a=Rt(r),s=Jp(n)-a;return n.setUTCDate(n.getUTCDate()-s*7),n}var Sj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",100),He(Ke(a),"incompatibleTokens",["y","Y","u","q","Q","M","L","w","d","D","e","c","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"I":return Xt(nr.week,s);case"Io":return i.ordinalNumber(s,{unit:"week"});default:return Zt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=1&&o<=53}},{key:"set",value:function(s,o,i){return Ns(wj(s,i))}}]),n}(Ft),Cj=[31,28,31,30,31,30,31,31,30,31,30,31],kj=[31,29,31,30,31,30,31,31,30,31,30,31],Pj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",90),He(Ke(a),"subPriority",1),He(Ke(a),"incompatibleTokens",["Y","R","q","Q","w","I","D","i","e","c","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"d":return Xt(nr.date,s);case"do":return i.ordinalNumber(s,{unit:"date"});default:return Zt(o.length,s)}}},{key:"validate",value:function(s,o){var i=s.getUTCFullYear(),c=ih(i),u=s.getUTCMonth();return c?o>=1&&o<=kj[u]:o>=1&&o<=Cj[u]}},{key:"set",value:function(s,o,i){return s.setUTCDate(i),s.setUTCHours(0,0,0,0),s}}]),n}(Ft),Ej=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",90),He(Ke(a),"subpriority",1),He(Ke(a),"incompatibleTokens",["Y","R","q","Q","M","L","w","I","d","E","i","e","c","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"D":case"DD":return Xt(nr.dayOfYear,s);case"Do":return i.ordinalNumber(s,{unit:"date"});default:return Zt(o.length,s)}}},{key:"validate",value:function(s,o){var i=s.getUTCFullYear(),c=ih(i);return c?o>=1&&o<=366:o>=1&&o<=365}},{key:"set",value:function(s,o,i){return s.setUTCMonth(0,i),s.setUTCHours(0,0,0,0),s}}]),n}(Ft);function Hl(t,r,n){var a,s,o,i,c,u,d,p;qe(2,arguments);var m=nn(),f=Rt((a=(s=(o=(i=n?.weekStartsOn)!==null&&i!==void 0?i:n==null||(c=n.locale)===null||c===void 0||(u=c.options)===null||u===void 0?void 0:u.weekStartsOn)!==null&&o!==void 0?o:m.weekStartsOn)!==null&&s!==void 0?s:(d=m.locale)===null||d===void 0||(p=d.options)===null||p===void 0?void 0:p.weekStartsOn)!==null&&a!==void 0?a:0);if(!(f>=0&&f<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var _=Le(t),v=Rt(r),w=_.getUTCDay(),b=v%7,P=(b+7)%7,N=(P<f?7:0)+v-w;return _.setUTCDate(_.getUTCDate()+N),_}var Dj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",90),He(Ke(a),"incompatibleTokens",["D","i","e","c","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"E":case"EE":case"EEE":return i.day(s,{width:"abbreviated",context:"formatting"})||i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"});case"EEEEE":return i.day(s,{width:"narrow",context:"formatting"});case"EEEEEE":return i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"});case"EEEE":default:return i.day(s,{width:"wide",context:"formatting"})||i.day(s,{width:"abbreviated",context:"formatting"})||i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(s,o){return o>=0&&o<=6}},{key:"set",value:function(s,o,i,c){return s=Hl(s,i,c),s.setUTCHours(0,0,0,0),s}}]),n}(Ft),Tj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",90),He(Ke(a),"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","E","i","c","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i,c){var u=function(p){var m=Math.floor((p-1)/7)*7;return(p+c.weekStartsOn+6)%7+m};switch(o){case"e":case"ee":return sr(Zt(o.length,s),u);case"eo":return sr(i.ordinalNumber(s,{unit:"day"}),u);case"eee":return i.day(s,{width:"abbreviated",context:"formatting"})||i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"});case"eeeee":return i.day(s,{width:"narrow",context:"formatting"});case"eeeeee":return i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"});case"eeee":default:return i.day(s,{width:"wide",context:"formatting"})||i.day(s,{width:"abbreviated",context:"formatting"})||i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(s,o){return o>=0&&o<=6}},{key:"set",value:function(s,o,i,c){return s=Hl(s,i,c),s.setUTCHours(0,0,0,0),s}}]),n}(Ft),Ij=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",90),He(Ke(a),"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","E","i","e","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i,c){var u=function(p){var m=Math.floor((p-1)/7)*7;return(p+c.weekStartsOn+6)%7+m};switch(o){case"c":case"cc":return sr(Zt(o.length,s),u);case"co":return sr(i.ordinalNumber(s,{unit:"day"}),u);case"ccc":return i.day(s,{width:"abbreviated",context:"standalone"})||i.day(s,{width:"short",context:"standalone"})||i.day(s,{width:"narrow",context:"standalone"});case"ccccc":return i.day(s,{width:"narrow",context:"standalone"});case"cccccc":return i.day(s,{width:"short",context:"standalone"})||i.day(s,{width:"narrow",context:"standalone"});case"cccc":default:return i.day(s,{width:"wide",context:"standalone"})||i.day(s,{width:"abbreviated",context:"standalone"})||i.day(s,{width:"short",context:"standalone"})||i.day(s,{width:"narrow",context:"standalone"})}}},{key:"validate",value:function(s,o){return o>=0&&o<=6}},{key:"set",value:function(s,o,i,c){return s=Hl(s,i,c),s.setUTCHours(0,0,0,0),s}}]),n}(Ft);function Oj(t,r){qe(2,arguments);var n=Rt(r);n%7===0&&(n=n-7);var a=1,s=Le(t),o=s.getUTCDay(),i=n%7,c=(i+7)%7,u=(c<a?7:0)+n-o;return s.setUTCDate(s.getUTCDate()+u),s}var Aj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",90),He(Ke(a),"incompatibleTokens",["y","Y","u","q","Q","M","L","w","d","D","E","e","c","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){var c=function(d){return d===0?7:d};switch(o){case"i":case"ii":return Zt(o.length,s);case"io":return i.ordinalNumber(s,{unit:"day"});case"iii":return sr(i.day(s,{width:"abbreviated",context:"formatting"})||i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"}),c);case"iiiii":return sr(i.day(s,{width:"narrow",context:"formatting"}),c);case"iiiiii":return sr(i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"}),c);case"iiii":default:return sr(i.day(s,{width:"wide",context:"formatting"})||i.day(s,{width:"abbreviated",context:"formatting"})||i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"}),c)}}},{key:"validate",value:function(s,o){return o>=1&&o<=7}},{key:"set",value:function(s,o,i){return s=Oj(s,i),s.setUTCHours(0,0,0,0),s}}]),n}(Ft),Mj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",80),He(Ke(a),"incompatibleTokens",["b","B","H","k","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"a":case"aa":case"aaa":return i.dayPeriod(s,{width:"abbreviated",context:"formatting"})||i.dayPeriod(s,{width:"narrow",context:"formatting"});case"aaaaa":return i.dayPeriod(s,{width:"narrow",context:"formatting"});case"aaaa":default:return i.dayPeriod(s,{width:"wide",context:"formatting"})||i.dayPeriod(s,{width:"abbreviated",context:"formatting"})||i.dayPeriod(s,{width:"narrow",context:"formatting"})}}},{key:"set",value:function(s,o,i){return s.setUTCHours(Bl(i),0,0,0),s}}]),n}(Ft),Rj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",80),He(Ke(a),"incompatibleTokens",["a","B","H","k","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"b":case"bb":case"bbb":return i.dayPeriod(s,{width:"abbreviated",context:"formatting"})||i.dayPeriod(s,{width:"narrow",context:"formatting"});case"bbbbb":return i.dayPeriod(s,{width:"narrow",context:"formatting"});case"bbbb":default:return i.dayPeriod(s,{width:"wide",context:"formatting"})||i.dayPeriod(s,{width:"abbreviated",context:"formatting"})||i.dayPeriod(s,{width:"narrow",context:"formatting"})}}},{key:"set",value:function(s,o,i){return s.setUTCHours(Bl(i),0,0,0),s}}]),n}(Ft),Nj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",80),He(Ke(a),"incompatibleTokens",["a","b","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"B":case"BB":case"BBB":return i.dayPeriod(s,{width:"abbreviated",context:"formatting"})||i.dayPeriod(s,{width:"narrow",context:"formatting"});case"BBBBB":return i.dayPeriod(s,{width:"narrow",context:"formatting"});case"BBBB":default:return i.dayPeriod(s,{width:"wide",context:"formatting"})||i.dayPeriod(s,{width:"abbreviated",context:"formatting"})||i.dayPeriod(s,{width:"narrow",context:"formatting"})}}},{key:"set",value:function(s,o,i){return s.setUTCHours(Bl(i),0,0,0),s}}]),n}(Ft),Lj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",70),He(Ke(a),"incompatibleTokens",["H","K","k","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"h":return Xt(nr.hour12h,s);case"ho":return i.ordinalNumber(s,{unit:"hour"});default:return Zt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=1&&o<=12}},{key:"set",value:function(s,o,i){var c=s.getUTCHours()>=12;return c&&i<12?s.setUTCHours(i+12,0,0,0):!c&&i===12?s.setUTCHours(0,0,0,0):s.setUTCHours(i,0,0,0),s}}]),n}(Ft),qj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",70),He(Ke(a),"incompatibleTokens",["a","b","h","K","k","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"H":return Xt(nr.hour23h,s);case"Ho":return i.ordinalNumber(s,{unit:"hour"});default:return Zt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=0&&o<=23}},{key:"set",value:function(s,o,i){return s.setUTCHours(i,0,0,0),s}}]),n}(Ft),Uj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",70),He(Ke(a),"incompatibleTokens",["h","H","k","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"K":return Xt(nr.hour11h,s);case"Ko":return i.ordinalNumber(s,{unit:"hour"});default:return Zt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=0&&o<=11}},{key:"set",value:function(s,o,i){var c=s.getUTCHours()>=12;return c&&i<12?s.setUTCHours(i+12,0,0,0):s.setUTCHours(i,0,0,0),s}}]),n}(Ft),Fj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",70),He(Ke(a),"incompatibleTokens",["a","b","h","H","K","t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"k":return Xt(nr.hour24h,s);case"ko":return i.ordinalNumber(s,{unit:"hour"});default:return Zt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=1&&o<=24}},{key:"set",value:function(s,o,i){var c=i<=24?i%24:i;return s.setUTCHours(c,0,0,0),s}}]),n}(Ft),Wj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",60),He(Ke(a),"incompatibleTokens",["t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"m":return Xt(nr.minute,s);case"mo":return i.ordinalNumber(s,{unit:"minute"});default:return Zt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=0&&o<=59}},{key:"set",value:function(s,o,i){return s.setUTCMinutes(i,0,0),s}}]),n}(Ft),$j=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",50),He(Ke(a),"incompatibleTokens",["t","T"]),a}return It(n,[{key:"parse",value:function(s,o,i){switch(o){case"s":return Xt(nr.second,s);case"so":return i.ordinalNumber(s,{unit:"second"});default:return Zt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=0&&o<=59}},{key:"set",value:function(s,o,i){return s.setUTCSeconds(i,0),s}}]),n}(Ft),zj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",30),He(Ke(a),"incompatibleTokens",["t","T"]),a}return It(n,[{key:"parse",value:function(s,o){var i=function(u){return Math.floor(u*Math.pow(10,-o.length+3))};return sr(Zt(o.length,s),i)}},{key:"set",value:function(s,o,i){return s.setUTCMilliseconds(i),s}}]),n}(Ft),Bj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",10),He(Ke(a),"incompatibleTokens",["t","T","x"]),a}return It(n,[{key:"parse",value:function(s,o){switch(o){case"X":return cn(ln.basicOptionalMinutes,s);case"XX":return cn(ln.basic,s);case"XXXX":return cn(ln.basicOptionalSeconds,s);case"XXXXX":return cn(ln.extendedOptionalSeconds,s);case"XXX":default:return cn(ln.extended,s)}}},{key:"set",value:function(s,o,i){return o.timestampIsSet?s:new Date(s.getTime()-i)}}]),n}(Ft),Hj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",10),He(Ke(a),"incompatibleTokens",["t","T","X"]),a}return It(n,[{key:"parse",value:function(s,o){switch(o){case"x":return cn(ln.basicOptionalMinutes,s);case"xx":return cn(ln.basic,s);case"xxxx":return cn(ln.basicOptionalSeconds,s);case"xxxxx":return cn(ln.extendedOptionalSeconds,s);case"xxx":default:return cn(ln.extended,s)}}},{key:"set",value:function(s,o,i){return o.timestampIsSet?s:new Date(s.getTime()-i)}}]),n}(Ft),Yj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",40),He(Ke(a),"incompatibleTokens","*"),a}return It(n,[{key:"parse",value:function(s){return ah(s)}},{key:"set",value:function(s,o,i){return[new Date(i*1e3),{timestampIsSet:!0}]}}]),n}(Ft),Vj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Tt(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Ke(a),"priority",20),He(Ke(a),"incompatibleTokens","*"),a}return It(n,[{key:"parse",value:function(s){return ah(s)}},{key:"set",value:function(s,o,i){return[new Date(i),{timestampIsSet:!0}]}}]),n}(Ft),Gj={G:new pj,y:new hj,Y:new mj,R:new fj,u:new xj,Q:new gj,q:new yj,M:new vj,L:new bj,w:new jj,I:new Sj,d:new Pj,D:new Ej,E:new Dj,e:new Tj,c:new Ij,i:new Aj,a:new Mj,b:new Rj,B:new Nj,h:new Lj,H:new qj,K:new Uj,k:new Fj,m:new Wj,s:new $j,S:new zj,X:new Bj,x:new Hj,t:new Yj,T:new Vj},Qj=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,Kj=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,Jj=/^'([^]*?)'?$/,Xj=/''/g,Zj=/\S/,e0=/[a-zA-Z]/;function t0(t,r,n,a){var s,o,i,c,u,d,p,m,f,_,v,w,b,P,N,j,E,A;qe(3,arguments);var C=String(t),L=String(r),y=nn(),x=(s=(o=a?.locale)!==null&&o!==void 0?o:y.locale)!==null&&s!==void 0?s:_i;if(!x.match)throw new RangeError("locale must contain match property");var D=Rt((i=(c=(u=(d=a?.firstWeekContainsDate)!==null&&d!==void 0?d:a==null||(p=a.locale)===null||p===void 0||(m=p.options)===null||m===void 0?void 0:m.firstWeekContainsDate)!==null&&u!==void 0?u:y.firstWeekContainsDate)!==null&&c!==void 0?c:(f=y.locale)===null||f===void 0||(_=f.options)===null||_===void 0?void 0:_.firstWeekContainsDate)!==null&&i!==void 0?i:1);if(!(D>=1&&D<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var M=Rt((v=(w=(b=(P=a?.weekStartsOn)!==null&&P!==void 0?P:a==null||(N=a.locale)===null||N===void 0||(j=N.options)===null||j===void 0?void 0:j.weekStartsOn)!==null&&b!==void 0?b:y.weekStartsOn)!==null&&w!==void 0?w:(E=y.locale)===null||E===void 0||(A=E.options)===null||A===void 0?void 0:A.weekStartsOn)!==null&&v!==void 0?v:0);if(!(M>=0&&M<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");if(L==="")return C===""?Le(n):new Date(NaN);var X={firstWeekContainsDate:D,weekStartsOn:M,locale:x},H=[new uj],U=L.match(Kj).map(function(de){var me=de[0];if(me in jl){var ge=jl[me];return ge(de,x.formatLong)}return de}).join("").match(Qj),G=[],te=Md(U),re;try{var S=function(){var me=re.value;!(a!=null&&a.useAdditionalWeekYearTokens)&&th(me)&&Vo(me,L,t),!(a!=null&&a.useAdditionalDayOfYearTokens)&&eh(me)&&Vo(me,L,t);var ge=me[0],pe=Gj[ge];if(pe){var se=pe.incompatibleTokens;if(Array.isArray(se)){var I=G.find(function(ce){return se.includes(ce.token)||ce.token===ge});if(I)throw new RangeError("The format string mustn't contain `".concat(I.fullToken,"` and `").concat(me,"` at the same time"))}else if(pe.incompatibleTokens==="*"&&G.length>0)throw new RangeError("The format string mustn't contain `".concat(me,"` and any other token at the same time"));G.push({token:ge,fullToken:me});var W=pe.run(C,me,x.match,X);if(!W)return{v:new Date(NaN)};H.push(W.setter),C=W.rest}else{if(ge.match(e0))throw new RangeError("Format string contains an unescaped latin alphabet character `"+ge+"`");if(me==="''"?me="'":ge==="'"&&(me=r0(me)),C.indexOf(me)===0)C=C.slice(me.length);else return{v:new Date(NaN)}}};for(te.s();!(re=te.n()).done;){var g=S();if(ei(g)==="object")return g.v}}catch(de){te.e(de)}finally{te.f()}if(C.length>0&&Zj.test(C))return new Date(NaN);var T=H.map(function(de){return de.priority}).sort(function(de,me){return me-de}).filter(function(de,me,ge){return ge.indexOf(de)===me}).map(function(de){return H.filter(function(me){return me.priority===de}).sort(function(me,ge){return ge.subPriority-me.subPriority})}).map(function(de){return de[0]}),q=Le(n);if(isNaN(q.getTime()))return new Date(NaN);var ee=Qp(q,Ms(q)),R={},K=Md(T),F;try{for(K.s();!(F=K.n()).done;){var xe=F.value;if(!xe.validate(ee,X))return new Date(NaN);var ve=xe.set(ee,R,X);Array.isArray(ve)?(ee=ve[0],zl(R,ve[1])):ee=ve}}catch(de){K.e(de)}finally{K.f()}return ee}function r0(t){return t.match(Jj)[1].replace(Xj,"'")}function Rd(t){qe(1,arguments);var r=Le(t);return r.setMinutes(0,0,0),r}function n0(t,r){qe(2,arguments);var n=Rd(t),a=Rd(r);return n.getTime()===a.getTime()}function s0(t,r){qe(2,arguments);var n=Le(t),a=Le(r);return n.getFullYear()===a.getFullYear()&&n.getMonth()===a.getMonth()}function a0(t,r){qe(2,arguments);var n=Le(t),a=Le(r);return n.getFullYear()===a.getFullYear()}function o0(t,r){qe(2,arguments);var n=Le(t).getTime(),a=Le(r.start).getTime(),s=Le(r.end).getTime();if(!(a<=s))throw new RangeError("Invalid interval");return n>=a&&n<=s}function i0(t,r){var n;qe(1,arguments);var a=Rt((n=void 0)!==null&&n!==void 0?n:2);if(a!==2&&a!==1&&a!==0)throw new RangeError("additionalDigits must be 0, 1 or 2");if(!(typeof t=="string"||Object.prototype.toString.call(t)==="[object String]"))return new Date(NaN);var s=u0(t),o;if(s.date){var i=p0(s.date,a);o=h0(i.restDateString,i.year)}if(!o||isNaN(o.getTime()))return new Date(NaN);var c=o.getTime(),u=0,d;if(s.time&&(u=m0(s.time),isNaN(u)))return new Date(NaN);if(s.timezone){if(d=f0(s.timezone),isNaN(d))return new Date(NaN)}else{var p=new Date(c+u),m=new Date(0);return m.setFullYear(p.getUTCFullYear(),p.getUTCMonth(),p.getUTCDate()),m.setHours(p.getUTCHours(),p.getUTCMinutes(),p.getUTCSeconds(),p.getUTCMilliseconds()),m}return new Date(c+u+d)}var bo={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},l0=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,c0=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,d0=/^([+-])(\d{2})(?::?(\d{2}))?$/;function u0(t){var r={},n=t.split(bo.dateTimeDelimiter),a;if(n.length>2)return r;if(/:/.test(n[0])?a=n[0]:(r.date=n[0],a=n[1],bo.timeZoneDelimiter.test(r.date)&&(r.date=t.split(bo.timeZoneDelimiter)[0],a=t.substr(r.date.length,t.length))),a){var s=bo.timezone.exec(a);s?(r.time=a.replace(s[1],""),r.timezone=s[1]):r.time=a}return r}function p0(t,r){var n=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+r)+"})|(\\d{2}|[+-]\\d{"+(2+r)+"})$)"),a=t.match(n);if(!a)return{year:NaN,restDateString:""};var s=a[1]?parseInt(a[1]):null,o=a[2]?parseInt(a[2]):null;return{year:o===null?s:o*100,restDateString:t.slice((a[1]||a[2]).length)}}function h0(t,r){if(r===null)return new Date(NaN);var n=t.match(l0);if(!n)return new Date(NaN);var a=!!n[4],s=Ca(n[1]),o=Ca(n[2])-1,i=Ca(n[3]),c=Ca(n[4]),u=Ca(n[5])-1;if(a)return b0(r,c,u)?x0(r,c,u):new Date(NaN);var d=new Date(0);return!y0(r,o,i)||!v0(r,s)?new Date(NaN):(d.setUTCFullYear(r,o,Math.max(s,i)),d)}function Ca(t){return t?parseInt(t):1}function m0(t){var r=t.match(c0);if(!r)return NaN;var n=Gi(r[1]),a=Gi(r[2]),s=Gi(r[3]);return _0(n,a,s)?n*vi+a*yi+s*1e3:NaN}function Gi(t){return t&&parseFloat(t.replace(",","."))||0}function f0(t){if(t==="Z")return 0;var r=t.match(d0);if(!r)return 0;var n=r[1]==="+"?-1:1,a=parseInt(r[2]),s=r[3]&&parseInt(r[3])||0;return j0(a,s)?n*(a*vi+s*yi):NaN}function x0(t,r,n){var a=new Date(0);a.setUTCFullYear(t,0,4);var s=a.getUTCDay()||7,o=(r-1)*7+n+1-s;return a.setUTCDate(a.getUTCDate()+o),a}var g0=[31,null,31,30,31,30,31,31,30,31,30,31];function lh(t){return t%400===0||t%4===0&&t%100!==0}function y0(t,r,n){return r>=0&&r<=11&&n>=1&&n<=(g0[r]||(lh(t)?29:28))}function v0(t,r){return r>=1&&r<=(lh(t)?366:365)}function b0(t,r,n){return r>=1&&r<=53&&n>=0&&n<=6}function _0(t,r,n){return t===24?r===0&&n===0:n>=0&&n<60&&r>=0&&r<60&&t>=0&&t<25}function j0(t,r){return r>=0&&r<=59}function w0(t,r){qe(2,arguments);var n=Le(t),a=Rt(r),s=n.getFullYear(),o=n.getDate(),i=new Date(0);i.setFullYear(s,a,15),i.setHours(0,0,0,0);var c=rh(i);return n.setMonth(a,Math.min(o,c)),n}function S0(t,r){qe(2,arguments);var n=Le(t),a=Rt(r);return n.setDate(a),n}function C0(t,r){qe(2,arguments);var n=Le(t),a=Rt(r);return n.setHours(a),n}function k0(t,r){qe(2,arguments);var n=Le(t),a=Rt(r);return n.setMilliseconds(a),n}function P0(t,r){qe(2,arguments);var n=Le(t),a=Rt(r);return n.setMinutes(a),n}function E0(t,r){qe(2,arguments);var n=Le(t),a=Rt(r);return n.setSeconds(a),n}function D0(t,r){qe(2,arguments);var n=Le(t),a=Rt(r);return isNaN(n.getTime())?new Date(NaN):(n.setFullYear(a),n)}const Nd=t=>{const r=Number(t);return isFinite(r)?new Intl.NumberFormat("en-CA",{maximumFractionDigits:0}).format(r):""},T0=()=>{const t=Gt(),[r,n]=l.useState([]),[a,s]=l.useState(""),[o,i]=l.useState({page:0,pageSize:10}),[c,u]=l.useState(null),[d,p]=l.useState(null);l.useEffect(()=>{m()},[]);const m=async()=>{try{const N=await B.get("/api/quotes");n(N.data||[])}catch(N){console.error("Error fetching quotes:",N),u("Failed to fetch quotes")}},f=async N=>{if(window.confirm("Are you sure you want to delete this quote?"))try{await B.delete(`/api/quotes/${N}`),p("Quote deleted successfully"),m()}catch{u("Failed to delete quote")}},_=()=>{const N=r.map(L=>({"Quote #":L.quote_number,Customer:L.customer_name,Product:L.product_name,Make:L.vehicle_make||"",Model:L.vehicle_model||"","Est. Price":Nd(L.estimated_cost),"Quote Date":L.quote_date?Cs(new Date(L.quote_date),"MM/dd/yyyy"):"","Valid Until":L.valid_until?Cs(new Date(L.valid_until),"MM/dd/yyyy"):"",Status:L.status})),j=Un.unparse(N),E=new Blob([j],{type:"text/csv;charset=utf-8;"}),A=document.createElement("a"),C=URL.createObjectURL(E);A.setAttribute("href",C),A.setAttribute("download","quotes.csv"),A.style.visibility="hidden",document.body.appendChild(A),A.click(),document.body.removeChild(A)},w=l.useMemo(()=>r.filter(N=>N.quote_number?.toLowerCase?.().includes(a.toLowerCase())||N.customer_name?.toLowerCase?.().includes(a.toLowerCase())||N.product_name?.toLowerCase?.().includes(a.toLowerCase())||N.vehicle_make?.toLowerCase?.().includes(a.toLowerCase())||N.vehicle_model?.toLowerCase?.().includes(a.toLowerCase())),[r,a]).map(N=>({...N,id:N.quote_id})),b=[{field:"quote_number",headerName:"Quote #",flex:1.05,minWidth:150,valueFormatter:N=>N.value?String(N.value).replace("QO-",""):""},{field:"customer_name",headerName:"Customer",flex:1.2,minWidth:170},{field:"product_name",headerName:"Product",flex:1.1,minWidth:160},{field:"vehicle_make",headerName:"Make",flex:.9,minWidth:130},{field:"vehicle_model",headerName:"Model",flex:.9,minWidth:130},{field:"estimated_cost",headerName:"Est. Price",type:"number",flex:.8,minWidth:110,headerAlign:"left",align:"left",valueFormatter:N=>Nd(N.value)},{field:"quote_date",headerName:"Quote Date",flex:.95,minWidth:130,valueFormatter:N=>N.value?Cs(new Date(N.value),"yyyy-MM-dd"):""},{field:"valid_until",headerName:"Valid Until",flex:.95,minWidth:130,valueFormatter:N=>N.value?Cs(new Date(N.value),"yyyy-MM-dd"):""},{field:"actions",headerName:"Actions",width:120,flex:0,sortable:!1,filterable:!1,disableColumnMenu:!0,renderCell:N=>e.jsx(k,{sx:{display:"flex",alignItems:"center"},children:e.jsx(Ht,{title:"Delete",children:e.jsx(gt,{size:"small",color:"error",onClick:j=>{j.stopPropagation();const E=N.row.quote_id;f(E)},children:e.jsx(xr,{})})})})}],P=N=>{const j=N.row;t(`/quotes/${j.quote_id}`)};return e.jsxs(nt,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(h,{variant:"h4",component:"h1",sx:{fontWeight:"bold",color:"text.primary"},children:"Quotes"}),e.jsxs(Pe,{direction:"row",spacing:2,children:[e.jsx(Q,{variant:"contained",color:"primary",startIcon:e.jsx(Nr,{}),onClick:()=>t("/quotes/new"),children:"NEW QUOTE"}),e.jsx(Q,{variant:"outlined",color:"primary",startIcon:e.jsx(gr,{}),onClick:_,children:"EXPORT CSV"})]})]}),e.jsx(Me,{sx:{width:"100%",overflow:"hidden",mb:3,border:"1px solid",borderColor:"divider",borderRadius:1},elevation:0,children:e.jsxs(k,{sx:{p:2},children:[e.jsx(le,{fullWidth:!0,label:"Search",value:a,onChange:N=>s(N.target.value),InputProps:{startAdornment:e.jsx(mr,{position:"start",children:e.jsx(Hr,{sx:{fontSize:22}})})},sx:{mb:2,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"small"}),e.jsx(tn,{rows:w,columns:b,paginationModel:o,onPaginationModelChange:i,pageSizeOptions:[10,25,50],getRowId:N=>N.id,onRowClick:P,disableRowSelectionOnClick:!0,disableColumnMenu:!0,hideFooterSelectedRowCount:!0,initialState:{sorting:{sortModel:[{field:"quote_number",sort:"desc"}]}},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224,224,224,1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224,224,224,1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"},"& .MuiDataGrid-columnSeparator":{display:"none"}}})]})}),e.jsx(vn,{open:!!d,autoHideDuration:6e3,onClose:()=>p(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Fe,{onClose:()=>p(null),severity:"success",sx:{width:"100%"},children:d})}),e.jsx(vn,{open:!!c,autoHideDuration:6e3,onClose:()=>u(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Fe,{onClose:()=>u(null),severity:"error",sx:{width:"100%"},children:c})})]})};var ka={},Ld;function I0(){if(Ld)return ka;Ld=1;var t=vt();Object.defineProperty(ka,"__esModule",{value:!0}),ka.default=void 0;var r=t(_t()),n=bt();return ka.default=(0,r.default)((0,n.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"}),"Save"),ka}var O0=I0();const is=st(O0);var Pa={},qd;function A0(){if(qd)return Pa;qd=1;var t=vt();Object.defineProperty(Pa,"__esModule",{value:!0}),Pa.default=void 0;var r=t(_t()),n=bt();return Pa.default=(0,r.default)((0,n.jsx)("path",{d:"m18 7-1.41-1.41-6.34 6.34 1.41 1.41zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12zM.41 13.41 6 19l1.41-1.41L1.83 12z"}),"DoneAll"),Pa}var M0=A0();const Jo=st(M0);var Ea={},Ud;function R0(){if(Ud)return Ea;Ud=1;var t=vt();Object.defineProperty(Ea,"__esModule",{value:!0}),Ea.default=void 0;var r=t(_t()),n=bt();return Ea.default=(0,r.default)((0,n.jsx)("path",{d:"M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8"}),"AddCircleOutline"),Ea}var N0=R0();const Mn=st(N0),ch=({open:t,onClose:r,type:n,recordId:a,defaultTo:s,defaultSubject:o,defaultMessage:i,allowMessageEdit:c=!0})=>{const{user:u}=er(),[d,p]=l.useState(s||""),[m,f]=l.useState(o||""),[_,v]=l.useState(i||""),[w,b]=l.useState(""),[P,N]=l.useState(!1),[j,E]=l.useState(""),[A,C]=l.useState([]),[L,y]=l.useState("");l.useEffect(()=>{console.log("EmailModal useEffect: open =",t,"defaultTo =",s,"current to =",d),t&&s&&(console.log("Setting to field to:",s),p(s))},[t,s]),l.useEffect(()=>{t&&x()},[t,n]);const x=async()=>{try{const U=await B.get("/api/email/templates");if(U.data.success){const G=U.data.templates.filter(re=>re.type===n);C(G);const te=G.find(re=>re.is_default);te?(y(te.id),f(te.subject),v(te.html_content)):G.length===0&&(n==="quote"?(f("Quote Information"),v("Please find attached the quote details.")):n==="purchase-order"?(f("Purchase Order Information"),v("Please find attached the purchase order details.")):n==="sales-order"&&(f("Sales Order Information"),v("Please find attached the sales order details.")))}}catch(U){console.error("Error loading templates:",U),n==="quote"?(f("Quote Information"),v("Please find attached the quote details.")):n==="purchase-order"?(f("Purchase Order Information"),v("Please find attached the purchase order details.")):n==="sales-order"&&(f("Sales Order Information"),v("Please find attached the sales order details."))}},D=U=>{if(y(U),U!==""){const G=A.find(te=>te.id===U);G&&(f(G.subject),v(G.html_content))}},M=async()=>{if(n==="custom"){if(!d||!m||!_){E("Please fill in all required fields");return}}else if(!d){E("Please enter a recipient email address");return}N(!0),E("");try{let U="/api/email/send",G={to:d,subject:m,message:_};n!=="custom"&&a&&(U=`/api/email/${n.replace("-","-")}/${a}`,G={to:d,...w&&{customMessage:w}});const te=await B.post(U,G);te.data.success?(z.success("Email sent successfully!"),r(),p(""),f(""),v(""),b(""),y("")):E(te.data.message||"Failed to send email")}catch(U){console.error("Error sending email:",U),E(U.response?.data?.message||"Failed to send email")}finally{N(!1)}},X=()=>{P||(r(),E(""))},H=()=>{switch(n){case"sales-order":return"Send Sales Order Email";case"purchase-order":return"Send Purchase Order Email";case"quote":return"Send Quote Email";default:return"Send Email"}};return e.jsxs(mt,{open:t,onClose:X,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:H()}),e.jsx(xt,{children:e.jsxs(k,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[n!=="custom"&&A.length>0&&e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Email Template"}),e.jsxs(Ut,{value:L,onChange:U=>D(U.target.value),label:"Email Template",children:[e.jsx(Ze,{value:"",children:e.jsx("em",{children:"Use default template"})}),A.map(U=>e.jsx(Ze,{value:U.id,children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1},children:[U.name,U.is_default&&e.jsx(De,{label:"Default",size:"small",color:"secondary"})]})},U.id))]})]}),e.jsx(le,{label:"To",value:d,onChange:U=>p(U.target.value),fullWidth:!0,required:!0,type:"email"}),n==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(le,{label:"Subject",value:m,onChange:U=>f(U.target.value),fullWidth:!0,required:!0}),e.jsx(le,{label:"Message",value:_,onChange:U=>v(U.target.value),fullWidth:!0,multiline:!0,rows:6,required:!0})]}),n!=="custom"&&c&&e.jsx(le,{label:"Additional Message (Optional)",value:w,onChange:U=>b(U.target.value),fullWidth:!0,multiline:!0,rows:4,helperText:"Add a custom message to include with the email"}),j&&e.jsx(Fe,{severity:"error",sx:{mt:2},children:j})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:X,disabled:P,children:"Cancel"}),e.jsx(Q,{onClick:M,variant:"contained",disabled:P,startIcon:P?e.jsx(ot,{size:20}):void 0,children:P?"Sending...":"Send Email"})]})]})},Fd={product_name:""},Yl=({open:t,onClose:r,onSave:n,initialProduct:a,isEditMode:s=!1,loading:o=!1})=>{const[i,c]=l.useState(Fd),[u,d]=l.useState(null),p=fi(i,300);l.useEffect(()=>{t&&(c({...Fd,...a}),d(null))},[t,a]);const m=v=>{const{name:w,value:b}=v.target;c(P=>({...P,[w]:b}))},f=()=>i.product_name.trim()?(d(null),!0):(d("Product name is required"),!1),_=()=>{f()&&n(i)};return l.useEffect(()=>{},[p,t]),e.jsxs(mt,{open:t,onClose:r,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:s?"Edit Product":"Add New Product"}),e.jsxs(xt,{children:[e.jsx(O,{container:!0,spacing:2,sx:{mt:1},children:e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{name:"product_name",label:"Product Name",value:i.product_name,onChange:m,fullWidth:!0,required:!0,autoFocus:!0})})}),u&&e.jsx("div",{style:{color:"red",marginTop:8},children:u})]}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:r,children:"Cancel"}),e.jsx(Q,{onClick:_,variant:"contained",disabled:o,children:s?"Save Changes":"Add Product"})]})]})},ji=({when:t,onSave:r})=>{console.log("[UnsavedChangesGuard] Component rendered with when=",t);const[n,a]=l.useState(!1),[s,o]=l.useState(!1),i=l.useRef(""),c=l.useRef(null),u=l.useRef(!1);l.useEffect(()=>{if(!t)return;i.current=window.location.hash,console.log("[UnsavedChangesGuard] activating interceptors. prevHash=",i.current);const f=N=>N.metaKey||N.ctrlKey||N.shiftKey||N.altKey||N.button!==0,_=N=>{let j=N;for(;j&&j!==document.body;){if(j.tagName==="A")return j;j=j.parentElement}return null},v=N=>{if(!t||n)return;const j=_(N.target);if(!j||f(N))return;const E=j.getAttribute("href")||"";if(!E.startsWith("#"))return;const A=E;if(A!==window.location.hash){if(window.__unsavedGuardAllowNext){console.log("[UnsavedChangesGuard] bypass flag set -> allowing click navigation"),window.__unsavedGuardAllowNext=!1,u.current=!0;return}console.log("[UnsavedChangesGuard] click capture -> intercept anchor to",A),N.preventDefault(),N.stopPropagation(),c.current=A,a(!0)}},w=()=>{if(!t)return;if(window.__unsavedGuardAllowNext){console.log("[UnsavedChangesGuard] bypass flag set -> allowing hashchange"),window.__unsavedGuardAllowNext=!1,u.current=!0,i.current=window.location.hash;return}if(u.current){u.current=!1,i.current=window.location.hash,console.log("[UnsavedChangesGuard] hashchange allowed. prevHash ->",i.current);return}if(n)return;const N=window.location.hash;console.log("[UnsavedChangesGuard] hashchange detected -> attempted",N,"reverting to",i.current),c.current=N,a(!0),setTimeout(()=>{window.location.hash!==i.current&&(window.location.hash=i.current)},0)},b=history.pushState,P=history.replaceState;return history.pushState=function(...N){try{const j=N[2],E=typeof j=="string"?j:j?String(j):"",A=E&&E.includes("#")?E.slice(E.indexOf("#")):E;if(window.__unsavedGuardAllowNext)return console.log("[UnsavedChangesGuard] bypass flag set -> allowing pushState",E),window.__unsavedGuardAllowNext=!1,u.current=!0,b.apply(this,N);if(t&&!u.current){console.log("[UnsavedChangesGuard] pushState intercepted ->",E),c.current=A||null,a(!0);return}}catch{}return b.apply(this,N)},history.replaceState=function(...N){try{const j=N[2],E=typeof j=="string"?j:j?String(j):"",A=E&&E.includes("#")?E.slice(E.indexOf("#")):E;if(window.__unsavedGuardAllowNext)return console.log("[UnsavedChangesGuard] bypass flag set -> allowing replaceState",E),window.__unsavedGuardAllowNext=!1,u.current=!0,P.apply(this,N);if(t&&!u.current){console.log("[UnsavedChangesGuard] replaceState intercepted ->",E),c.current=A||null,a(!0);return}}catch{}return P.apply(this,N)},document.addEventListener("click",v,!0),window.addEventListener("hashchange",w),window.addEventListener("popstate",w),()=>{console.log("[UnsavedChangesGuard] deactivating interceptors"),document.removeEventListener("click",v,!0),window.removeEventListener("hashchange",w),window.removeEventListener("popstate",w),history.pushState=b,history.replaceState=P}},[t,n]),l.useEffect(()=>{console.log("[UnsavedChangesGuard] beforeunload useEffect triggered with when=",t);const f=_=>{t&&(console.log("[UnsavedChangesGuard] beforeunload fired"),_.preventDefault(),_.returnValue="")};return t&&(console.log("[UnsavedChangesGuard] registering beforeunload"),window.addEventListener("beforeunload",f)),()=>{console.log("[UnsavedChangesGuard] removing beforeunload listener"),window.removeEventListener("beforeunload",f)}},[t]);const d=()=>{console.log("[UnsavedChangesGuard] user chose: Stay"),a(!1),c.current=null},p=()=>{console.log("[UnsavedChangesGuard] user chose: Leave -> proceeding to",c.current);const f=c.current;a(!1),f&&(u.current=!0,c.current=null,window.location.hash!==f&&(window.location.hash=f))},m=async()=>{if(console.log("[UnsavedChangesGuard] user chose: Save and leave"),!r){p();return}try{o(!0),await r(),p()}catch(f){console.log("[UnsavedChangesGuard] save failed, staying on page",f),o(!1)}finally{o(!1)}};return e.jsxs(mt,{open:n,onClose:d,maxWidth:"xs",fullWidth:!0,children:[e.jsx(ft,{children:"Unsaved Changes"}),e.jsx(xt,{children:e.jsx(h,{variant:"body2",children:"You have unsaved changes. Would you like to save before leaving this page?"})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:d,children:"Cancel"}),e.jsx(Q,{onClick:p,color:"warning",children:"Leave without saving"}),e.jsx(Q,{onClick:m,variant:"contained",disabled:s,children:s?"Saving":"Save and leave"})]})]})},fn={"& .MuiOutlinedInput-root":{height:56,borderRadius:1},"& .MuiInputBase-input":{py:1.25,fontSize:16}},en={fontSize:18,transform:"translate(14px, 18px) scale(1)","&.MuiInputLabel-shrink":{fontSize:14,transform:"translate(14px, -9px) scale(0.9)"}},ks=t=>t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim().toUpperCase(),L0=(t,r)=>{const n=ks(r);return n?t.map(s=>{const o=ks(s.label);let i=-1;return o.startsWith(n)?i=3:o.split(" ").some(c=>c.startsWith(n))?i=2:o.includes(n)&&(i=1),{opt:s,score:i}}).filter(s=>s.score>=0).sort((s,o)=>o.score-s.score||s.opt.label.localeCompare(o.opt.label)).slice(0,8).map(s=>s.opt):t.slice(0,8)},Wd=()=>{const{id:t}=jn(),r=Gt(),a=!!t&&!(t==="new"),[s,o]=l.useState([]),[i,c]=l.useState([]),[u,d]=l.useState(null),[p,m]=l.useState(null),[f,_]=l.useState(null),[v,w]=l.useState(et()),[b,P]=l.useState(et().add(30,"day")),[N,j]=l.useState(null),[E,A]=l.useState(""),[C,L]=l.useState(""),[y,x]=l.useState(""),[D,M]=l.useState(""),[X,H]=l.useState(""),[U,G]=l.useState(""),[te,re]=l.useState(!1),[S,g]=l.useState(null),[T,q]=l.useState(null),[ee,R]=l.useState(!1),[K,F]=l.useState(""),[xe,ve]=l.useState(null),[de,me]=l.useState(!1),ge=l.useRef(null),[pe,se]=l.useState(!1),[I,W]=l.useState(""),[ce,Z]=l.useState(null),[Ae,Ce]=l.useState(!1),[ze,Ve]=l.useState(""),[ut,it]=l.useState(!1),[pt,Ne]=l.useState(""),[tt,Be]=l.useState(!1),[wt,zt]=l.useState(""),[Bt,We]=l.useState(!1),[Qt,Kt]=l.useState(!1),Wt=l.useCallback(()=>({customer:p?.id||u?.customer_id||null,product:f?.label||u?.product_name||"",quoteDate:v?.toISOString?.()||u?.quote_date||null,validUntil:b?.toISOString?.()||u?.valid_until||null,estimatedCost:N??u?.estimated_cost??null,productDescription:(E||"").trim(),terms:(C||"").trim(),customerPoNumber:(y||"").trim(),vinNumber:(D||"").trim(),vehicleMake:(X||"").trim(),vehicleModel:(U||"").trim()}),[p,u,f,v,b,N,E,C,y,D,X,U]);l.useEffect(()=>{if(Bt&&wt===""){const ke=JSON.stringify(Wt());zt(ke),console.log("[QuoteEditor] Initial signature set:",ke)}},[Bt,wt,Wt]);const tr=l.useMemo(()=>JSON.stringify(Wt()),[Wt]),yr=!!wt&&wt!==tr&&!Qt;l.useEffect(()=>{wt&&console.log("[QuoteEditor] Signature comparison:",{isDirty:yr,initialSignature:wt.slice(0,100)+"...",currentSignature:tr.slice(0,100)+"...",signaturesMatch:wt===tr})},[yr,wt,tr]),l.useEffect(()=>{_e(),ye(),a||We(!0)},[]),l.useEffect(()=>{!a||!t||(async()=>{try{const Ie=(await B.get(`/api/quotes/${t}`)).data;d(Ie),m(null),_({label:Ie.product_name}),w(et(Ie.quote_date)),P(et(Ie.valid_until)),j(Number(Ie.estimated_cost??0)),A(Ie.product_description||""),L(Ie.terms||""),x(Ie.customer_po_number||""),M(Ie.vin_number||""),H(Ie.vehicle_make||""),G(Ie.vehicle_model||""),F(Ie.customer_name||""),W(Ie.product_name||""),We(!0)}catch(ke){console.error("Failed to load quote:",ke),g("Failed to load quote")}})()},[t,a]),l.useEffect(()=>{if(u&&s.length>0){const ke=s.find(Ie=>Ie.id===u.customer_id);ke&&m(ke)}},[s,u]),l.useEffect(()=>()=>{xe&&window.clearTimeout(xe),ce&&window.clearTimeout(ce)},[xe,ce]);const _e=async()=>{try{const Ie=((await B.get("/api/customers")).data||[]).map(Xe=>({label:Xe.customer_name,id:Xe.customer_id,email:Xe.email}));o(Ie)}catch{g("Failed to load customers")}},ye=async()=>{try{const ke=await B.get("/api/products");c((ke.data||[]).map(Ie=>({label:Ie.product_name,id:Ie.product_id,description:Ie.product_description})))}catch{g("Failed to load products")}},we=ke=>{const Ie=ks(ke);return s.find(Xe=>ks(Xe.label)===Ie)||null},fe=async()=>{if(!p||!f||!v||!b||N==null){g("Please fill in all required fields");return}re(!0),Kt(!0);try{const ke={customer_id:p.id,product_name:f.label.trim(),quote_date:v.format("YYYY-MM-DD"),valid_until:b.format("YYYY-MM-DD"),estimated_cost:Number(N),product_description:E,terms:C,customer_po_number:y,vin_number:D,vehicle_make:X.trim(),vehicle_model:U.trim()};if(a&&u){await B.put(`/api/quotes/${u.quote_id}`,ke),q("Quote updated successfully");const Ie=JSON.stringify(Wt());zt(Ie),console.log("[QuoteEditor] Signature reset after save:",Ie.slice(0,100)+"..."),setTimeout(()=>{window.__unsavedGuardAllowNext=!0},100)}else{if(window.__quoteCreateInFlight){console.log("[QuoteEditor] Skipping duplicate create (in flight)");return}window.__quoteCreateInFlight=!0;const Ie=await B.post("/api/quotes",ke);q("Quote created successfully");const Xe=Ie?.data??{},Ct=Xe.quote_id??Xe.quoteId??Xe.id??Xe?.quote?.quote_id;if(Ct){const At={quote_id:Ct,quote_number:Xe.quote_number||`Q${Ct}`,customer_id:p.id,customer_name:p.label,quote_date:ke.quote_date,valid_until:ke.valid_until,product_name:ke.product_name,product_description:ke.product_description,estimated_cost:ke.estimated_cost,status:"Open",terms:ke.terms,customer_po_number:ke.customer_po_number,vin_number:ke.vin_number,vehicle_make:ke.vehicle_make,vehicle_model:ke.vehicle_model};d(At),window.__unsavedGuardAllowNext=!0,r(`/quotes/${Ct}`,{replace:!0}),zt(JSON.stringify(Wt()));return}}}catch(ke){const Ie=ke,Xe=Ie.response?.data&&typeof Ie.response.data=="object"&&"message"in Ie.response.data?Ie.response.data.message:"Failed to save quote";g(Xe)}finally{re(!1),Kt(!1),window.__quoteCreateInFlight=!1}},Ee=async()=>{if(u)try{const ke=await B.get(`/api/quotes/${u.quote_id}/pdf`,{responseType:"blob"}),Ie=window.URL.createObjectURL(new Blob([ke.data])),Xe=document.createElement("a");Xe.href=Ie,Xe.setAttribute("download",`Quote_${u.quote_number}.pdf`),document.body.appendChild(Xe),Xe.click(),Xe.parentNode?.removeChild(Xe),window.URL.revokeObjectURL(Ie),q("PDF downloaded successfully.")}catch{g("Failed to download PDF. Please try again.")}},Ue=()=>{if(!u?.quote_id){g("Please save the quote before emailing.");return}Be(!0)},$e=async()=>{if(!u?.quote_id){g("Please save the quote before converting.");return}re(!0);try{const ke=await B.post(`/api/quotes/${u.quote_id}/convert-to-sales-order`);q("Quote converted to sales order successfully!");const Ie=ke.data.salesOrder?.sales_order_id;setTimeout(Ie?()=>{r(`/open-sales-orders/${Ie}`)}:()=>{r("/open-sales-orders")},1500)}catch(ke){const Ie=ke,Xe=Ie.response?.data&&typeof Ie.response.data=="object"&&"message"in Ie.response.data?Ie.response.data.message:"Failed to convert quote to sales order";g(Xe)}finally{re(!1)}},Je=ke=>{const Ie=K.trim(),Xe=ke.key==="Enter",Ct=ke.key==="Tab",At=ke.key==="Escape",Er=ke.key==="ArrowDown"||ke.key==="ArrowUp";if(At){R(!1);return}if(!Er&&(Xe||Ct)){if(Xe&&ke.ctrlKey&&Ie){ke.preventDefault(),me(!0),Ve(Ie),Ce(!0);return}const Yr=we(Ie);if(ee||!Ie)return;ke.preventDefault(),Yr?(m(Yr),F(Yr.label)):(me(!0),Ve(Ie),Ce(!0))}},at=ke=>{if(ke.key==="Enter"){ke.preventDefault();const Ie=I.trim();if(!Ie)return;const Xe=i.find(Ct=>Ct.label.toLowerCase()===Ie.toLowerCase());Xe?(_(Xe),W(Xe.label)):(Ne(Ie),it(!0))}},dt=a&&u?`Edit Quote: ${u.quote_number}`:a?"Edit Quote":"New Quote";return e.jsxs(bn,{dateAdapter:os,children:[e.jsx(ji,{when:yr,onSave:fe}),e.jsxs(nt,{maxWidth:"lg",sx:{mt:4,mb:4,px:{xs:2,sm:3}},children:[e.jsxs(k,{sx:{maxWidth:1e3,mx:"auto",mb:3,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(h,{variant:"h5",sx:{fontWeight:700},children:dt}),e.jsxs(Pe,{direction:"row",spacing:1.25,children:[e.jsx(Q,{variant:"contained",color:"primary",startIcon:e.jsx(is,{}),onClick:fe,disabled:te,children:a?"SAVE CHANGES":"CREATE QUOTE"}),a&&u&&e.jsxs(e.Fragment,{children:[e.jsx(Q,{variant:"contained",color:"primary",startIcon:e.jsx(Jo,{}),onClick:$e,disabled:te,children:"CONVERT TO SO"}),e.jsx(Q,{variant:"contained",color:"primary",startIcon:e.jsx(gr,{}),onClick:Ee,children:"DOWNLOAD PDF"}),e.jsx(Q,{variant:"contained",startIcon:e.jsx(pi,{}),sx:{backgroundColor:"#ff9800","&:hover":{backgroundColor:"#f57c00"}},onClick:Ue,children:"EMAIL QUOTE"})]})]})]}),e.jsx(k,{sx:{maxWidth:1e3,mx:"auto",mt:1.5},children:e.jsx(Me,{sx:{p:3,backgroundColor:"#fff"},elevation:3,children:e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:12,md:4,children:e.jsx(zr,{open:ee,onOpen:()=>R(!0),onClose:()=>R(!1),autoHighlight:!0,options:s,value:p,onChange:(ke,Ie)=>{if(de){me(!1);return}Ie&&Ie.isNew?(Ce(!0),Ve(K),m(null),F("")):m(Ie)},filterOptions:(ke,Ie)=>{const Xe=L0(ke,Ie.inputValue||""),Ct=!!(Ie.inputValue&&s.some(Er=>ks(Er.label)===ks(Ie.inputValue))),At=[...Xe];return(Ie.inputValue||"").trim()!==""&&!Ct&&At.push({label:`Add "${Ie.inputValue}" as New Customer`,isNew:!0}),Xe.length===0&&(Ie.inputValue||"").trim()!==""&&!Ct,At},inputValue:K,onInputChange:(ke,Ie,Xe)=>{if(F(Ie),xe&&window.clearTimeout(xe),Xe==="reset")return;if(Ie.trim().length>0){const At=window.setTimeout(()=>R(!0),180);ve(At)}else R(!1)},getOptionLabel:ke=>typeof ke=="string"?ke:ke.label,isOptionEqualToValue:(ke,Ie)=>ke.id===Ie?.id,renderOption:(ke,Ie)=>{const Xe=Ie.isNew,{key:Ct,...At}=ke;return e.jsxs("li",{...At,style:{display:"flex",alignItems:"center",opacity:Xe?.9:1},children:[Xe&&e.jsx(Mn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),e.jsx("span",{children:Ie.label})]},Ct)},renderInput:ke=>{const Ie=!!ke.inputProps?.value,Xe=!!p||Ie;return e.jsx(le,{...ke,label:"Customer",fullWidth:!0,required:!0,onKeyDown:Je,onBlur:()=>{if(!p){const Ct=K.trim();if(Ct){const At=we(Ct);At&&(m(At),F(At.label))}}},inputRef:Ct=>{ge.current=Ct},sx:fn,InputLabelProps:{...ke.InputLabelProps,sx:en,shrink:Xe}})}})}),e.jsx(O,{item:!0,xs:12,md:4,children:e.jsx(le,{label:"Customer PO #",fullWidth:!0,value:y,onChange:ke=>x(ke.target.value),sx:fn,InputLabelProps:{sx:en}})}),e.jsx(O,{item:!0,xs:12,md:4,children:e.jsx(le,{label:"Estimated Price",type:"number",value:N??"",onChange:ke=>j(ke.target.value===""?null:parseFloat(ke.target.value)),fullWidth:!0,required:!0,InputProps:{startAdornment:e.jsx(mr,{position:"start",children:"$"})},inputProps:{step:"0.01",onWheel:ke=>ke.currentTarget.blur()},sx:fn,InputLabelProps:{sx:en}})}),e.jsx(O,{item:!0,xs:12,md:6,children:e.jsx(zr,{disablePortal:!0,open:pe,onOpen:()=>se(!0),onClose:()=>se(!1),autoHighlight:!0,options:i,value:f,onChange:(ke,Ie)=>{if(Ie&&Ie.isNew){const Xe=Ie.inputValue?.toString?.()||I.trim();it(!0),Ne(Xe),_(null),W(""),se(!1)}else _(Ie),se(!1)},filterOptions:(ke,Ie)=>{const Xe=ke.filter(Ct=>Ct.label.toLowerCase().includes(Ie.inputValue.toLowerCase()));return Ie.inputValue!==""&&!ke.some(Ct=>Ct.label.toLowerCase()===Ie.inputValue.toLowerCase())&&Xe.push({label:`Add "${Ie.inputValue}"`,isNew:!0,inputValue:Ie.inputValue}),Xe},inputValue:I,onInputChange:(ke,Ie,Xe)=>{if(W(Ie),Ne(Ie),ce&&window.clearTimeout(ce),Xe==="reset")return;if(Ie.trim().length>0){const At=window.setTimeout(()=>se(!0),180);Z(At)}else se(!1)},getOptionLabel:ke=>typeof ke=="string"?ke:ke.label,isOptionEqualToValue:(ke,Ie)=>ke.id===Ie?.id,renderInput:ke=>{const Ie=!!ke.inputProps?.value,Xe=!!f||Ie;return e.jsx(le,{...ke,label:"Product",fullWidth:!0,required:!0,onKeyDown:at,onBlur:()=>{if(!f){const Ct=I.trim();if(Ct){const At=i.find(Er=>Er.label.toLowerCase()===Ct.toLowerCase());At&&(_(At),W(At.label))}}},sx:fn,InputLabelProps:{...ke.InputLabelProps,sx:en,shrink:Xe}})}})}),e.jsx(O,{item:!0,xs:12,md:6,children:e.jsx(le,{label:"VIN #",fullWidth:!0,value:D,onChange:ke=>M(ke.target.value),sx:fn,InputLabelProps:{sx:en},error:D.length>0&&D.length!==17,helperText:D.length>0&&D.length!==17?"VIN must be 17 characters":""})}),e.jsx(O,{item:!0,xs:12,md:6,children:e.jsx(le,{label:"Make",fullWidth:!0,value:X,onChange:ke=>H(ke.target.value),sx:fn,InputLabelProps:{sx:en}})}),e.jsx(O,{item:!0,xs:12,md:6,children:e.jsx(le,{label:"Model",fullWidth:!0,value:U,onChange:ke=>G(ke.target.value),sx:fn,InputLabelProps:{sx:en}})}),e.jsx(O,{item:!0,xs:12,md:6,children:e.jsx(Nn,{label:"Quote Date",value:v,onChange:ke=>w(ke),slotProps:{textField:{fullWidth:!0,sx:fn,InputLabelProps:{sx:en}}}})}),e.jsx(O,{item:!0,xs:12,md:6,children:e.jsx(Nn,{label:"Valid Until",value:b,onChange:ke=>P(ke),slotProps:{textField:{fullWidth:!0,sx:fn,InputLabelProps:{sx:en}}}})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Product Description",fullWidth:!0,multiline:!0,minRows:6,value:E,onChange:ke=>A(ke.target.value),sx:{"& .MuiOutlinedInput-root":{borderRadius:1},"& .MuiOutlinedInput-input":{fontSize:15}},InputLabelProps:{sx:en,shrink:!0}})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Terms and Conditions",fullWidth:!0,multiline:!0,minRows:4,value:C,onChange:ke=>L(ke.target.value),sx:{"& .MuiOutlinedInput-root":{borderRadius:1},"& .MuiOutlinedInput-input":{fontSize:15}},InputLabelProps:{sx:en,shrink:!0}})})]})})}),e.jsx(ch,{open:tt,onClose:()=>Be(!1),type:"quote",recordId:u?.quote_id,defaultTo:p?.email||"",allowMessageEdit:!0}),e.jsx(xi,{open:Ae,onClose:()=>Ce(!1),onSave:async ke=>{try{const Xe=(await B.post("/api/customers",ke)).data,Ct={label:Xe.customer_name,id:Xe.customer_id,email:Xe.email||ke.email};o(At=>[...At,Ct]),m(Ct),Ce(!1),F(Ct.label)}catch{g("Failed to add customer")}},initialCustomer:{customer_name:ze},isEditMode:!1}),e.jsx(Yl,{open:ut,onClose:()=>it(!1),onSave:async ke=>{try{const Ie=await B.post("/api/products",ke),Xe={label:ke.product_name,id:Ie.data.product_id,description:ke.product_name};c(Ct=>[...Ct,Xe]),_(Xe),W(Xe.label),it(!1),Ne("")}catch{g("Failed to add product.")}},initialProduct:{product_name:pt||I},isEditMode:!1}),e.jsx(vn,{open:!!T,autoHideDuration:6e3,onClose:()=>q(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Fe,{onClose:()=>q(null),severity:"success",sx:{width:"100%"},children:T})}),e.jsx(vn,{open:!!S,autoHideDuration:6e3,onClose:()=>g(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Fe,{onClose:()=>g(null),severity:"error",sx:{width:"100%"},children:S})})]})]})},q0=({conversations:t,activeConversationId:r,onSelect:n,onStartConversation:a,isLoading:s=!1,unreadConversationIds:o})=>{const[i,c]=l.useState(""),u=l.useMemo(()=>new Set(o??[]),[o]),d=l.useMemo(()=>{const p=i.trim().toLowerCase();return p?t.filter(m=>{const f=m.displayName.toLowerCase(),_=m.participantNames.toLowerCase();return f.includes(p)||_.includes(p)}):t},[t,i]);return e.jsxs(k,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[e.jsxs(Pe,{direction:"row",alignItems:"center",justifyContent:"space-between",spacing:2,sx:{mb:2},children:[e.jsx(h,{variant:"h6",component:"h2",children:"Conversations"}),e.jsx(Q,{variant:"contained",startIcon:e.jsx(ti,{}),onClick:a,size:"small",children:"New"})]}),e.jsx(le,{fullWidth:!0,size:"small",placeholder:"Search conversations",value:i,onChange:p=>c(p.target.value),sx:{mb:2}}),e.jsx(fr,{}),e.jsx(k,{sx:{flexGrow:1,overflowY:"auto"},children:s?e.jsx(k,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",py:4},children:e.jsx(ot,{size:32})}):d.length===0?e.jsx(k,{sx:{textAlign:"center",py:6,px:2},children:e.jsx(h,{variant:"body2",color:"text.secondary",children:i?"No conversations match your search.":"Start a new conversation to begin messaging."})}):e.jsx(kr,{disablePadding:!0,children:d.map(p=>{const m=p.lastMessage?.content,f=p.lastMessageAt||p.updatedAt||p.createdAt,_=Y_(new Date(f),{addSuffix:!0}),v=u.has(p.id);return e.jsxs(Dt.Fragment,{children:[e.jsxs(Uh,{selected:p.id===r,alignItems:"flex-start",onClick:()=>n(p.id),sx:{py:1.5,"&.Mui-selected":{backgroundColor:"action.selected"},bgcolor:v?"action.hover":void 0,"& .MuiListItemText-secondary":{display:"-webkit-box",overflow:"hidden",WebkitBoxOrient:"vertical",WebkitLineClamp:2}},children:[e.jsx(Fh,{children:e.jsx(Rn,{children:p.displayName.charAt(0).toUpperCase()})}),e.jsx(hr,{primary:e.jsxs(Pe,{direction:"row",alignItems:"center",justifyContent:"space-between",spacing:1,children:[e.jsx(h,{variant:"subtitle1",noWrap:!0,sx:{fontWeight:v?600:500},children:p.displayName}),e.jsxs(Pe,{direction:"row",alignItems:"center",spacing:1.25,sx:{flexShrink:0},children:[v&&e.jsx(k,{component:"span",sx:{width:8,height:8,borderRadius:"50%",bgcolor:"primary.main"}}),e.jsx(h,{variant:"caption",color:"text.secondary",children:_})]})]}),secondaryTypographyProps:{fontWeight:v?600:void 0},secondary:m||"No messages yet"})]}),e.jsx(fr,{component:"li"})]},p.id)})})})]})};var Da={},$d;function U0(){if($d)return Da;$d=1;var t=vt();Object.defineProperty(Da,"__esModule",{value:!0}),Da.default=void 0;var r=t(_t()),n=bt();return Da.default=(0,r.default)((0,n.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM8 9h8v10H8zm7.5-5-1-1h-5l-1 1H5v2h14V4z"}),"DeleteOutlineOutlined"),Da}var F0=U0();const W0=st(F0),$0=t=>{try{return Cs(new Date(t),"MMM d, yyyy h:mm a")}catch{return t}},z0=({conversation:t,messages:r,currentUserId:n,isLoading:a,isSending:s,onSendMessage:o,onDeleteMessage:i})=>{const c=l.useRef(null);l.useEffect(()=>{const d=c.current;d&&(d.scrollTop=d.scrollHeight)},[r.length,a]);const u=l.useMemo(()=>t?t.otherParticipants.length>0?t.otherParticipants.map(d=>d.username||d.email||"Unknown user").join(", "):t.participantNames:"",[t]);return t?e.jsxs(Me,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[e.jsxs(k,{sx:{p:2},children:[e.jsx(h,{variant:"h6",component:"h2",children:t.displayName}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:u})]}),e.jsx(fr,{}),e.jsx(k,{ref:c,sx:{flexGrow:1,overflowY:"auto",p:2},children:a?e.jsx(k,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(ot,{size:36})}):r.length===0?e.jsx(k,{sx:{textAlign:"center",color:"text.secondary",mt:6},children:e.jsx(h,{variant:"body2",children:"No messages yet. Start the conversation below."})}):e.jsx(Pe,{spacing:2,children:r.map(d=>{const p=n!==null&&d.senderId===n,m=!!d.isDeletedForUser,f=p?"flex-end":"flex-start",_=d.error?"error.light":m?"grey.300":p?"primary.main":"grey.100",v=d.error?"error.dark":m?"text.secondary":p?"common.white":"text.primary",w=!m&&!d.error&&!d.pending&&typeof d.id=="number",b=m?p?"You deleted this message":"Message deleted":d.content;return e.jsx(k,{sx:{display:"flex",justifyContent:f},children:e.jsxs(k,{sx:{maxWidth:"75%",display:"flex",flexDirection:"column",gap:.5},children:[e.jsxs(Me,{elevation:p?3:1,sx:{p:1.5,bgcolor:_,color:v,borderRadius:2,border:d.error?"1px solid":"none",borderColor:d.error?"error.main":void 0,position:"relative"},children:[e.jsxs(Pe,{spacing:.5,children:[e.jsx(h,{variant:"caption",sx:{opacity:p?.85:.6},children:d.senderName||(p?"You":"Unknown user")}),e.jsx(h,{variant:"body2",sx:{whiteSpace:"pre-wrap",fontStyle:m?"italic":"normal"},children:b}),e.jsx(h,{variant:"caption",sx:{opacity:p?.85:.6,textAlign:"right"},children:$0(d.createdAt)})]}),w&&e.jsx(Ht,{title:"Delete for me",children:e.jsx(gt,{size:"small",onClick:()=>i(Number(d.id)),sx:{position:"absolute",top:4,right:4,color:p?"common.white":"text.secondary",bgcolor:p?"rgba(255,255,255,0.1)":"transparent","&:hover":{bgcolor:p?"rgba(255,255,255,0.2)":"rgba(0,0,0,0.04)"}},children:e.jsx(W0,{fontSize:"inherit"})})})]}),d.pending&&!d.error&&e.jsx(De,{label:"Sending...",size:"small",color:"default",sx:{alignSelf:p?"flex-end":"flex-start",mt:.5}}),d.error&&e.jsx(h,{variant:"caption",color:"error",sx:{alignSelf:p?"flex-end":"flex-start"},children:"Failed to send. Please try again."})]})},d.id)})})}),e.jsx(fr,{}),e.jsx(Ep,{onSendMessage:d=>o(d),disabled:s})]}):e.jsx(Me,{sx:{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",p:4},children:e.jsx(h,{variant:"body1",color:"text.secondary",align:"center",children:"Select a conversation to view messages or start a new chat."})})},B0=()=>{const{user:t}=er(),r=t?Number(t.id):null,{conversations:n,isLoadingConversations:a,activeConversationId:s,selectConversation:o,messagesByConversation:i,isLoadingMessages:c,sendMessage:u,createConversation:d,loadMessages:p,deleteMessage:m,unreadConversationIds:f}=Cp(),[_,v]=l.useState([]),[w,b]=l.useState(!1),[P,N]=l.useState(!1),[j,E]=l.useState([]),[A,C]=l.useState(""),[L,y]=l.useState(!1),[x,D]=l.useState(!1);l.useEffect(()=>{let T=!0;return(async()=>{try{b(!0);const ee=await B.get("/api/employees");if(!T)return;const K=(Array.isArray(ee.data)?ee.data:[]).map(F=>({id:Number(F.id),username:F.username??null,email:F.email??null,access_role:F.access_role})).filter(F=>F.id!==r).sort((F,xe)=>{const ve=(F.username||F.email||"").toLowerCase(),de=(xe.username||xe.email||"").toLowerCase();return ve.localeCompare(de)});v(K)}catch(ee){console.error("Failed to load employees",ee),z.error("Unable to load team members.")}finally{T&&b(!1)}})(),()=>{T=!1}},[r]);const M=l.useMemo(()=>n.find(T=>T.id===s),[s,n]),X=s?i[s]??[]:[],H=s?!!c[s]:!1,U=()=>{E([]),C(""),N(!0)},G=()=>{L||N(!1)},te=async()=>{if(j.length===0){z.error("Select at least one teammate to start a conversation.");return}const T=j.map(ee=>ee.id),q=T.length>1?"group":"direct";if(q==="group"&&!A.trim()){z.error("Enter a name for the group conversation.");return}try{y(!0);const ee=await d({participantIds:T,title:q==="group"?A.trim():void 0,type:q}),{conversation:R,created:K}=ee;z.success(K?"Conversation created successfully.":"Conversation already existed. Opening chat."),N(!1),E([]),C(""),await p(R.id,{force:!0})}catch(ee){console.error("Failed to create conversation",ee),z.error("Unable to start conversation. Please try again.")}finally{y(!1)}},re=async T=>{if(!s){z.error("Select a conversation before sending a message.");return}try{D(!0),await u(s,T)}catch(q){console.error("Failed to send message",q),z.error("Failed to send message. Please try again.")}finally{D(!1)}},S=async T=>{if(!s){z.error("Select a conversation before deleting a message.");return}try{await m(s,T),z.info("Message deleted for you.")}catch(q){console.error("Failed to delete message",q),z.error("Unable to delete message. Please try again.")}},g=l.useMemo(()=>_,[_]);return e.jsxs(k,{sx:{display:"flex",flexDirection:"column",height:"100%",p:{xs:2,md:3},gap:3},children:[e.jsxs(Pe,{spacing:1,children:[e.jsx(h,{variant:"h4",component:"h1",children:"Messaging"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Collaborate with your team using direct messages and group chats."})]}),e.jsxs(Me,{elevation:0,sx:{flexGrow:1,minHeight:{xs:480,md:540},display:"flex",flexDirection:{xs:"column",md:"row"},borderRadius:3,overflow:"hidden",border:"1px solid",borderColor:"divider",backgroundColor:"background.paper"},children:[e.jsx(k,{sx:{width:{xs:"100%",md:340},flexShrink:0,borderRight:{md:"1px solid",xs:"none"},borderColor:"divider",backgroundColor:"background.default"},children:e.jsx(k,{sx:{height:"100%",p:{xs:2,md:2.5}},children:e.jsx(q0,{conversations:n,activeConversationId:s,onSelect:o,onStartConversation:U,isLoading:a,unreadConversationIds:f})})}),e.jsx(fr,{orientation:"vertical",flexItem:!0,sx:{display:{xs:"none",md:"block"}}}),e.jsx(k,{sx:{flex:1,p:{xs:2,md:2.5},display:"flex",flexDirection:"column",backgroundColor:"background.paper"},children:e.jsx(z0,{conversation:M,messages:X,currentUserId:r,isLoading:H,isSending:x,onSendMessage:re,onDeleteMessage:S})})]}),e.jsxs(mt,{open:P,onClose:G,fullWidth:!0,maxWidth:"sm",children:[e.jsx(ft,{children:"Start a Conversation"}),e.jsx(xt,{dividers:!0,children:e.jsxs(Pe,{spacing:2,sx:{mt:1},children:[e.jsx(zr,{multiple:!0,options:g,value:j,onChange:(T,q)=>E(q),getOptionLabel:T=>T.username||T.email||`User ${T.id}`,renderOption:(T,q)=>l.createElement("li",{...T,key:q.id},e.jsxs(Pe,{spacing:.25,children:[e.jsx(h,{variant:"body2",children:q.username||q.email||`User ${q.id}`}),q.email&&e.jsx(h,{variant:"caption",color:"text.secondary",children:q.email})]})),filterSelectedOptions:!0,renderInput:T=>e.jsx(le,{...T,label:"Participants",placeholder:"Select team members",helperText:"Choose one teammate for a direct chat or multiple for a group conversation."}),loading:w,loadingText:"Loading team members..."}),j.length>1&&e.jsx(le,{label:"Group name",value:A,onChange:T=>C(T.target.value),placeholder:"e.g., Operations Leads",inputProps:{maxLength:80}})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:G,disabled:L,children:"Cancel"}),e.jsx(Q,{variant:"contained",onClick:te,disabled:L||j.length===0||j.length>1&&!A.trim(),children:L?"Creating":"Start"})]})]})]})},H0=async()=>(await B.get("/api/employees")).data,zd=["Admin","Sales and Purchase","Time Tracking","Mobile Time Tracker"],Y0=()=>{const[t,r]=l.useState(""),[n,a]=l.useState(""),[s,o]=l.useState(""),[i,c]=l.useState(""),[u,d]=l.useState("Employee"),[p,m]=l.useState(null),[f,_]=l.useState(null),[v,w]=l.useState([]),[b,P]=l.useState(!0);Gt();const[N,j]=l.useState(null),[E,A]=l.useState(""),[C,L]=l.useState(""),[y,x]=l.useState(""),[D,M]=l.useState(!1);l.useEffect(()=>{X()},[]);const X=async()=>{P(!0);try{const S=await H0();w(S)}catch{m("Failed to fetch employees.")}finally{P(!1)}},H=async S=>{if(S.preventDefault(),m(null),_(null),s!==i){m("Passwords do not match");return}try{const g=await B.post("/api/employees",{username:t,email:n,password:s,access_role:u});_(g.data.message),r(""),a(""),o(""),c(""),d("Employee"),X()}catch(g){g instanceof _r?m(g.response?.data?.message||"Employee registration failed"):m("An unexpected error occurred")}},U=async S=>{if(window.confirm("Are you sure you want to delete this employee?"))try{await B.delete(`/api/employees/${S}`),_("Employee deleted successfully"),X()}catch(g){console.error("Error deleting employee:",g),g instanceof _r?m(g.response?.data?.message||"Failed to delete employee"):m("An unexpected error occurred")}},G=S=>{j(S),A(S.username),L(S.access_role),x(""),M(!0)},te=()=>{M(!1),j(null),m(null),_(null)},re=async()=>{if(N){m(null),_(null);try{const S={username:E,access_role:C};y&&(S.password=y);const g=await B.put(`/api/employees/${N.id}`,S);_(g.data.message||"Employee updated successfully"),X(),te()}catch(S){console.error("Error updating employee:",S),S instanceof _r?m(S.response?.data?.message||"Failed to update employee"):m("An unexpected error occurred")}}};return b?e.jsxs(nt,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(ot,{}),e.jsx(h,{children:"Loading employees..."})]}):e.jsxs(nt,{component:"main",maxWidth:"md",children:[e.jsxs(k,{sx:{marginTop:8,display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs(Me,{elevation:6,sx:{p:4,width:"100%",borderRadius:2,mb:4},children:[e.jsx(h,{component:"h1",variant:"h5",sx:{mb:3,textAlign:"center"},children:"Register New Employee"}),e.jsxs(k,{component:"form",onSubmit:H,noValidate:!0,sx:{mt:1},children:[e.jsx(le,{margin:"normal",required:!0,fullWidth:!0,id:"username",label:"Username",name:"username",autoComplete:"new-username",value:t,onChange:S=>r(S.target.value)}),e.jsx(le,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"new-email",value:n,onChange:S=>a(S.target.value)}),e.jsx(le,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Initial Password",type:"password",id:"password",autoComplete:"new-password",value:s,onChange:S=>o(S.target.value)}),e.jsx(le,{margin:"normal",required:!0,fullWidth:!0,name:"confirmPassword",label:"Confirm Initial Password",type:"password",id:"confirmPassword",autoComplete:"new-password",value:i,onChange:S=>c(S.target.value)}),e.jsxs(Mt,{fullWidth:!0,margin:"normal",children:[e.jsx(qt,{id:"access-role-label",children:"Access Role"}),e.jsx(Ut,{labelId:"access-role-label",id:"access-role",value:u,label:"Access Role",onChange:S=>d(S.target.value),children:zd.map(S=>e.jsx(Ze,{value:S,children:S},S))})]}),e.jsx(Q,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2},children:"Register Employee"}),p&&e.jsx(Fe,{severity:"error",sx:{mt:2},children:p}),f&&e.jsx(Fe,{severity:"success",sx:{mt:2},children:f})]})]}),e.jsxs(Me,{elevation:6,sx:{p:4,width:"100%",borderRadius:2},children:[e.jsx(h,{component:"h2",variant:"h5",sx:{mb:3,textAlign:"center"},children:"Existing Employees"}),e.jsx(kr,{children:v.map(S=>e.jsx(Ar,{secondaryAction:e.jsxs(k,{children:[e.jsx(gt,{edge:"end","aria-label":"edit",onClick:()=>G(S),sx:{mr:1},children:e.jsx(ao,{})}),e.jsx(gt,{edge:"end","aria-label":"delete",onClick:()=>U(S.id),children:e.jsx(xr,{})})]}),children:e.jsx(hr,{primary:S.username,secondary:`Email: ${S.email} | Role: ${S.role} | Access: ${S.access_role}`})},S.id))})]})]}),e.jsxs(mt,{open:D,onClose:te,children:[e.jsx(ft,{children:"Edit Employee Roles"}),e.jsxs(xt,{children:[N&&e.jsxs(k,{component:"form",noValidate:!0,sx:{mt:1},children:[e.jsx(le,{margin:"normal",fullWidth:!0,id:"edit-username",label:"Username",value:E,onChange:S=>A(S.target.value),variant:"standard"}),e.jsx(le,{margin:"normal",fullWidth:!0,id:"edit-email",label:"Email",value:N.email,InputProps:{readOnly:!0,disableUnderline:!0},variant:"standard"}),e.jsx(le,{margin:"normal",fullWidth:!0,id:"edit-password",label:"New Password (leave blank to keep current)",type:"password",value:y,onChange:S=>x(S.target.value),variant:"standard"}),e.jsxs(Mt,{fullWidth:!0,margin:"normal",children:[e.jsx(qt,{id:"edit-access-role-label",children:"Access Role"}),e.jsx(Ut,{labelId:"edit-access-role-label",id:"edit-access-role",value:C,label:"Access Role",onChange:S=>L(S.target.value),children:zd.map(S=>e.jsx(Ze,{value:S,children:S},S))})]})]}),p&&e.jsx(Fe,{severity:"error",sx:{mt:2},children:p}),f&&e.jsx(Fe,{severity:"success",sx:{mt:2},children:f})]}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:te,children:"Cancel"}),e.jsx(Q,{onClick:re,variant:"contained",color:"primary",children:"Save Changes"})]})]})]})},V0=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(""),[s,o]=l.useState([]),[i,c]=l.useState(!1),[u,d]=l.useState(!1),[p,m]=l.useState(null),[f,_]=l.useState(""),[v,w]=l.useState(!1),[b,P]=l.useState(!1),[N,j]=l.useState(null),[E,A]=l.useState([]),[C,L]=l.useState([]),[y,x]=l.useState("admin");l.useEffect(()=>{D()},[]),l.useEffect(()=>{y==="admin"?X():n?M(n):o([])},[n,y]);const D=async()=>{try{const g=await B.get("/api/profile-documents/profiles");r(g.data)}catch(g){console.error("Error fetching profiles:",g),z.error("Failed to fetch profiles")}},M=async g=>{c(!0);try{const T=await B.get(`/api/profile-documents/profile/${g}`);o(T.data)}catch(T){console.error("Error fetching documents:",T),z.error("Failed to fetch documents")}finally{c(!1)}},X=async()=>{c(!0);try{const T=(await B.get("/api/profile-documents/all")).data.reduce((ee,R)=>{const K=R.id;return ee[K]||(ee[K]={id:R.id,filename:R.filename,original_filename:R.original_filename,file_size:R.file_size,mime_type:R.mime_type,uploaded_by:R.uploaded_by,uploaded_by_name:R.uploaded_by_name,created_at:R.created_at,visible_to_profiles:[],profile_read_status:{},profile_details:[]}),ee[K].visible_to_profiles.push(R.profile_id),ee[K].profile_read_status[R.profile_id]=R.has_read,ee[K].profile_details.push({profile_id:R.profile_id,profile_name:R.profile_name,has_read:R.has_read,read_at:R.read_at}),ee},{}),q=Object.values(T);console.log("Grouped documents:",q),o(q)}catch(g){console.error("Error fetching all documents:",g),z.error("Failed to fetch documents")}finally{c(!1)}},H=g=>{const T=g.target.files?.[0];T&&(m(T),f||_(T.name))},U=async()=>{if(!p||C.length===0){z.error("Please select a file and at least one profile");return}w(!0);try{const g=new FormData;g.append("document",p),g.append("customName",f),g.append("visibleToProfiles",JSON.stringify(C)),(await B.post("/api/profile-documents/upload",g,{headers:{"Content-Type":"multipart/form-data"}})).data.success&&(z.success("Document uploaded successfully"),d(!1),m(null),_(""),L([]),y==="admin"?X():n&&M(n))}catch(g){console.error("Error uploading document:",g),z.error(g.response?.data?.error||"Failed to upload document")}finally{w(!1)}},G=async g=>{if(window.confirm("Are you sure you want to delete this document?"))try{await B.delete(`/api/profile-documents/${g}`),z.success("Document deleted successfully"),y==="admin"?X():n&&M(n)}catch(T){console.error("Error deleting document:",T),z.error("Failed to delete document")}},te=async g=>{j(g),P(!0);try{const T=await B.get(`/api/profile-documents/${g.id}/stats`);A(T.data)}catch(T){console.error("Error fetching document stats:",T),z.error("Failed to fetch document statistics")}},re=g=>{if(g===0)return"0 Bytes";const T=1024,q=["Bytes","KB","MB","GB"],ee=Math.floor(Math.log(g)/Math.log(T));return parseFloat((g/Math.pow(T,ee)).toFixed(2))+" "+q[ee]},S=g=>new Date(g).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return e.jsxs(k,{p:3,children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsx(h,{variant:"h4",component:"h1",children:"Profile Documents Management"}),e.jsxs(k,{display:"flex",gap:2,alignItems:"center",children:[e.jsxs(Mt,{size:"small",sx:{minWidth:120},children:[e.jsx(qt,{children:"View Mode"}),e.jsxs(Ut,{value:y,onChange:g=>x(g.target.value),label:"View Mode",children:[e.jsx(Ze,{value:"admin",children:"Admin View"}),e.jsx(Ze,{value:"profile",children:"Profile View"})]})]}),e.jsx(Q,{variant:"contained",startIcon:e.jsx(ti,{}),onClick:()=>d(!0),disabled:y==="profile"&&!n,children:"Upload Document"})]})]}),e.jsxs(O,{container:!0,spacing:3,children:[y==="profile"&&e.jsx(O,{item:!0,xs:12,md:4,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Select Profile"}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Profile"}),e.jsx(Ut,{value:n,onChange:g=>a(g.target.value),label:"Profile",children:t.map(g=>e.jsx(Ze,{value:g.id,children:g.name},g.id))})]}),n&&e.jsx(k,{mt:2,children:e.jsx(h,{variant:"body2",color:"text.secondary",children:t.find(g=>g.id===n)?.email})})]})})}),e.jsx(O,{item:!0,xs:12,md:y==="profile"?8:12,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsxs(h,{variant:"h6",gutterBottom:!0,children:["Documents",e.jsx(De,{label:`${s.length} documents`,size:"small",sx:{ml:2}})]}),y==="profile"&&!n?e.jsx(Fe,{severity:"info",children:"Please select a profile to view documents."}):i?e.jsx(k,{display:"flex",justifyContent:"center",p:3,children:e.jsx(ot,{})}):s.length===0?e.jsx(Fe,{severity:"info",children:y==="admin"?"No documents found.":"No documents found for this profile."}):e.jsx(dr,{children:e.jsxs(ir,{size:"small",children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Document Name"}),e.jsx(ne,{align:"center",children:"Size"}),e.jsx(ne,{align:"center",children:"Type"}),y==="admin"?e.jsxs(e.Fragment,{children:[e.jsx(ne,{align:"center",children:"Visible To"}),e.jsx(ne,{align:"center",children:"Read Status"})]}):e.jsx(ne,{align:"center",children:"Read Status"}),e.jsx(ne,{align:"center",children:"Uploaded"}),e.jsx(ne,{align:"center",children:"Actions"})]})}),e.jsx(cr,{children:s.map(g=>e.jsxs(ht,{children:[e.jsxs(ne,{children:[e.jsx(h,{variant:"body2",fontWeight:"medium",children:g.original_filename}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:["by ",g.uploaded_by_name]})]}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",children:re(g.file_size)})}),e.jsx(ne,{align:"center",children:e.jsx(De,{label:g.mime_type.split("/")[1]?.toUpperCase()||"FILE",size:"small",variant:"outlined"})}),y==="admin"?e.jsxs(e.Fragment,{children:[e.jsx(ne,{align:"center",children:e.jsx(k,{display:"flex",flexWrap:"wrap",gap:.5,justifyContent:"center",children:g.profile_details&&g.profile_details.length>0?g.profile_details.map(T=>e.jsx(De,{label:T.profile_name,size:"small",variant:"outlined",color:"primary"},T.profile_id)):g.visible_to_profiles?.map(T=>{const q=t.find(ee=>ee.id===T);return q?e.jsx(De,{label:q.name,size:"small",variant:"outlined",color:"primary"},T):null})})}),e.jsx(ne,{align:"center",children:e.jsx(k,{display:"flex",flexWrap:"wrap",gap:.5,justifyContent:"center",children:g.profile_details&&g.profile_details.length>0?g.profile_details.map(T=>e.jsx(De,{label:T.has_read?"Read":"Unread",size:"small",color:T.has_read?"success":"default",icon:T.has_read?e.jsx(Qa,{}):e.jsx(Ss,{}),title:`${T.profile_name}: ${T.has_read?"Read":"Unread"}`},T.profile_id)):g.visible_to_profiles?.map(T=>{const q=t.find(R=>R.id===T),ee=g.profile_read_status?.[T]||!1;return q?e.jsx(De,{label:ee?"Read":"Unread",size:"small",color:ee?"success":"default",icon:ee?e.jsx(Qa,{}):e.jsx(Ss,{}),title:`${q.name}: ${ee?"Read":"Unread"}`},T):null})})})]}):e.jsx(ne,{align:"center",children:e.jsx(De,{label:g.profile_read_status?.[n]?"Read":"Unread",size:"small",color:g.profile_read_status?.[n]?"success":"default",icon:g.profile_read_status?.[n]?e.jsx(Qa,{}):e.jsx(Ss,{})})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",children:S(g.created_at)})}),e.jsxs(ne,{align:"center",children:[e.jsx(gt,{size:"small",onClick:()=>te(g),title:"View Statistics",children:e.jsx(Wh,{})}),e.jsx(gt,{size:"small",component:"a",href:`/api/profile-documents/file/${g.id}`,target:"_blank",title:"Download",children:e.jsx(Nu,{})}),e.jsx(gt,{size:"small",onClick:()=>G(g.id),title:"Delete",color:"error",children:e.jsx(qs,{})})]})]},g.id))})]})})]})})})]}),e.jsxs(mt,{open:u,onClose:()=>d(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:"Upload Document"}),e.jsx(xt,{children:e.jsxs(k,{sx:{pt:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Select Profiles"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Choose which profiles can see this document"}),e.jsx($h,{children:t.map(g=>e.jsx(yn,{control:e.jsx(gn,{checked:C.includes(g.id),onChange:T=>{T.target.checked?L([...C,g.id]):L(C.filter(q=>q!==g.id))}}),label:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",children:g.name}),e.jsx(h,{variant:"caption",color:"text.secondary",children:g.email})]})},g.id))}),e.jsx(le,{fullWidth:!0,label:"Custom Document Name",value:f,onChange:g=>_(g.target.value),sx:{mb:2,mt:2},helperText:"Leave empty to use original filename"}),e.jsxs(k,{sx:{mb:2},children:[e.jsx("input",{type:"file",id:"file-upload",onChange:H,style:{display:"none"},accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif"}),e.jsx("label",{htmlFor:"file-upload",children:e.jsx(Q,{variant:"outlined",component:"span",startIcon:e.jsx($o,{}),fullWidth:!0,children:p?p.name:"Select File"})})]}),p&&e.jsxs(Fe,{severity:"info",children:["Selected: ",p.name," (",re(p.size),")"]})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>d(!1),disabled:v,children:"Cancel"}),e.jsx(Q,{onClick:U,variant:"contained",disabled:!p||C.length===0||v,startIcon:v?e.jsx(ot,{size:20}):e.jsx($o,{}),children:v?"Uploading...":"Upload"})]})]}),e.jsxs(mt,{open:b,onClose:()=>P(!1),maxWidth:"md",fullWidth:!0,children:[e.jsxs(ft,{children:["Document Statistics: ",N?.original_filename]}),e.jsx(xt,{children:e.jsxs(k,{sx:{pt:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Profile Read Status"}),e.jsx(h,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"View which profiles can see this document and their read status:"}),N&&e.jsx(dr,{sx:{mt:2},children:e.jsxs(ir,{size:"small",children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Profile"}),e.jsx(ne,{children:"Email"}),e.jsx(ne,{align:"center",children:"Read Status"}),e.jsx(ne,{align:"center",children:"Read At"})]})}),e.jsx(cr,{children:N.visible_to_profiles?.map(g=>{const T=t.find(R=>R.id===g),q=N.profile_read_status?.[g]||!1,ee=E.find(R=>R.profile_id===g);return T?e.jsxs(ht,{children:[e.jsx(ne,{children:e.jsx(h,{variant:"body2",fontWeight:"medium",children:T.name})}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",color:"text.secondary",children:T.email})}),e.jsx(ne,{align:"center",children:e.jsx(De,{label:q?"Read":"Unread",size:"small",color:q?"success":"default",icon:q?e.jsx(Qa,{}):e.jsx(Ss,{})})}),e.jsx(ne,{align:"center",children:ee?e.jsx(h,{variant:"body2",children:S(ee.read_at)}):e.jsx(h,{variant:"body2",color:"text.secondary",children:"-"})})]},g):null})})]})})]})}),e.jsx(jt,{children:e.jsx(Q,{onClick:()=>P(!1),children:"Close"})})]})]})},G0=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(!0),[s,o]=l.useState(!1),[i,c]=l.useState(!1),[u,d]=l.useState({margin_id:"",cost_lower_bound:"",cost_upper_bound:"",margin_factor:""}),[p,m]=l.useState(null),[f,_]=l.useState({page:0,pageSize:5}),[v,w]=l.useState(""),[b,P]=l.useState(!1),[N,j]=l.useState(""),[E,A]=l.useState(!1),[C,L]=l.useState(""),[y,x]=l.useState(!1),[D,M]=l.useState(""),[X,H]=l.useState(!1),[U,G]=l.useState(""),[te,re]=l.useState(!1),S=async()=>{try{const Z=await B.get("/api/margin-schedule");r(Z.data.map(Ae=>({...Ae,id:Ae.margin_id}))),a(!1),m(null)}catch(Z){console.error("Error fetching margin schedules:",Z),m("Failed to load margin schedules"),z.error("Failed to load margin schedules"),a(!1)}},g=async()=>{P(!0);try{const Z=await B.get("/api/settings/labour-rate");w(Z.data.labour_rate??"")}catch{w("")}finally{P(!1)}},T=async()=>{A(!0);try{const Z=await B.get("/api/settings/overhead-rate");j(Z.data.overhead_rate??"")}catch{j("")}finally{A(!1)}},q=async()=>{x(!0);try{const Z=await B.get("/api/settings/supply-rate");L(Z.data.supply_rate??"")}catch{L("")}finally{x(!1)}},ee=async()=>{H(!0);try{const Z=await B.get("/api/settings/daily-break-start");M(Z.data.daily_break_start??"")}catch{M("")}finally{H(!1)}},R=async()=>{re(!0);try{const Z=await B.get("/api/settings/daily-break-end");G(Z.data.daily_break_end??"")}catch{G("")}finally{re(!1)}};l.useEffect(()=>{S(),g(),T(),q(),ee(),R()},[]);const K=()=>{c(!1),d({margin_id:"",cost_lower_bound:"",cost_upper_bound:"",margin_factor:""}),o(!0)},F=Z=>{c(!0),d({margin_id:Z.margin_id,cost_lower_bound:String(Z.cost_lower_bound),cost_upper_bound:String(Z.cost_upper_bound),margin_factor:String(Z.margin_factor)}),o(!0)},xe=async Z=>{if(window.confirm("Are you sure you want to delete this margin schedule?"))try{await B.delete(`/api/margin-schedule/${Z}`),z.success("Margin schedule deleted successfully"),S()}catch(Ae){console.error("Error deleting margin schedule:",Ae),z.error("Failed to delete margin schedule")}},ve=()=>{o(!1)},de=Z=>{const{name:Ae,value:Ce}=Z.target;d(ze=>({...ze,[Ae]:Ce}))},me=async Z=>{Z.preventDefault();try{i?(await B.put(`/api/margin-schedule/${u.margin_id}`,{cost_lower_bound:parseFloat(u.cost_lower_bound),cost_upper_bound:parseFloat(u.cost_upper_bound),margin_factor:parseFloat(u.margin_factor)}),z.success("Margin schedule updated successfully")):(await B.post("/api/margin-schedule",{schedule:[{cost_lower_bound:parseFloat(u.cost_lower_bound),cost_upper_bound:parseFloat(u.cost_upper_bound),margin_factor:parseFloat(u.margin_factor)}]}),z.success("Margin schedule created successfully")),ve(),S()}catch(Ae){console.error("Error saving margin schedule:",Ae),z.error("Failed to save margin schedule")}},ge=async()=>{P(!0);try{await B.put("/api/settings/labour-rate",{labour_rate:Number(v)}),g()}catch{}finally{P(!1)}},pe=async()=>{A(!0);try{await B.put("/api/settings/overhead-rate",{overhead_rate:Number(N)}),T()}catch{}finally{A(!1)}},se=async()=>{x(!0);try{await B.put("/api/settings/supply-rate",{supply_rate:Number(C)}),q(),z.success("Supply rate updated successfully")}catch{z.error("Failed to update supply rate")}finally{x(!1)}},I=async()=>{H(!0);try{await B.put("/api/settings/daily-break-start",{daily_break_start:D}),ee(),z.success("Daily break start time updated successfully")}catch{z.error("Failed to update daily break start time")}finally{H(!1)}},W=async()=>{re(!0);try{await B.put("/api/settings/daily-break-end",{daily_break_end:U}),R(),z.success("Daily break end time updated successfully")}catch{z.error("Failed to update daily break end time")}finally{re(!1)}},ce=[{field:"margin_id",headerName:"ID",flex:.5,minWidth:60,headerAlign:"center",align:"center"},{field:"cost_lower_bound",headerName:"Cost Lower Bound",flex:1,minWidth:120,type:"number",headerAlign:"center",align:"center"},{field:"cost_upper_bound",headerName:"Cost Upper Bound",flex:1,minWidth:120,type:"number",headerAlign:"center",align:"center"},{field:"margin_factor",headerName:"Margin Factor",flex:1,minWidth:120,type:"number",headerAlign:"center",align:"center"},{field:"actions",headerName:"Actions",width:80,sortable:!1,headerAlign:"center",align:"center",renderCell:Z=>e.jsx(gt,{size:"small",color:"error",onClick:Ae=>{Ae.stopPropagation(),xe(Z.row.margin_id)},children:e.jsx(xr,{})})}];return e.jsxs(nt,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Global Variables"}),e.jsxs(Pe,{direction:"row",spacing:2,children:[e.jsx(Q,{variant:"contained",onClick:K,startIcon:e.jsx(Nr,{}),children:"New Entry"}),e.jsx(Q,{variant:"contained",onClick:S,children:"Refresh"})]})]}),e.jsx(Me,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsx(k,{sx:{p:2},children:e.jsx(tn,{rows:t,columns:ce,getRowId:Z=>Z.id,paginationModel:f,onPaginationModelChange:Z=>_(Z),pageSizeOptions:[5,10,20],loading:n,disableRowSelectionOnClick:!0,onRowClick:Z=>F(Z.row),sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"},cursor:"pointer"}})})}),e.jsx(Me,{sx:{width:"100%",overflow:"hidden",mb:3,p:2},children:e.jsxs(k,{sx:{display:"flex",gap:4,alignItems:"flex-start"},children:[e.jsxs(k,{sx:{flex:1},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Labour Hourly Rate"}),e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(le,{label:"Hourly Rate ($)",type:"number",value:v,onChange:Z=>w(Z.target.value===""?"":Number(Z.target.value)),disabled:b,InputProps:{startAdornment:e.jsx(mr,{position:"start",children:"$"})},sx:{maxWidth:200}}),e.jsx(Q,{variant:"contained",onClick:ge,disabled:b||v==="",children:"Save"})]})]}),e.jsxs(k,{sx:{flex:1},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Overhead Hourly Rate"}),e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(le,{label:"Hourly Rate ($)",type:"number",value:N,onChange:Z=>j(Z.target.value===""?"":Number(Z.target.value)),disabled:E,InputProps:{startAdornment:e.jsx(mr,{position:"start",children:"$"})},sx:{maxWidth:200}}),e.jsx(Q,{variant:"contained",onClick:pe,disabled:E||N==="",children:"Save"})]})]}),e.jsxs(k,{sx:{flex:1},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Supply Percentage"}),e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(le,{label:"Percentage (%)",type:"number",value:C,onChange:Z=>L(Z.target.value===""?"":Number(Z.target.value)),disabled:y,InputProps:{endAdornment:e.jsx(mr,{position:"end",children:"%"})},sx:{maxWidth:200}}),e.jsx(Q,{variant:"contained",onClick:se,disabled:y||C==="",children:"Save"})]})]}),e.jsxs(k,{sx:{flex:1},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Daily Break Times"}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(le,{label:"Break Start (HH:MM)",type:"time",value:D,onChange:Z=>M(Z.target.value),disabled:X,InputLabelProps:{shrink:!0},sx:{maxWidth:200}}),e.jsx(Q,{variant:"contained",onClick:I,disabled:X||D==="",children:"Save Start"}),e.jsx(le,{label:"Break End (HH:MM)",type:"time",value:U,onChange:Z=>G(Z.target.value),disabled:te,InputLabelProps:{shrink:!0},sx:{maxWidth:200}}),e.jsx(Q,{variant:"contained",onClick:W,disabled:te||U==="",children:"Save End"})]})]})]})}),e.jsxs(mt,{open:s,onClose:ve,children:[e.jsx(ft,{children:i?"Edit Margin Entry":"Add New Margin Entry"}),e.jsx(xt,{children:e.jsxs(Pe,{spacing:2,mt:1,children:[e.jsx(le,{label:"Cost Lower Bound",name:"cost_lower_bound",value:u.cost_lower_bound,onChange:de,fullWidth:!0,type:"number"}),e.jsx(le,{label:"Cost Upper Bound",name:"cost_upper_bound",value:u.cost_upper_bound,onChange:de,fullWidth:!0,type:"number"}),e.jsx(le,{label:"Margin Factor",name:"margin_factor",value:u.margin_factor,onChange:de,fullWidth:!0,type:"number"})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:ve,children:"Cancel"}),e.jsx(Q,{onClick:me,children:i?"Save Changes":"Add Entry"})]})]})]})};var Ta={},Bd;function Q0(){if(Bd)return Ta;Bd=1;var t=vt();Object.defineProperty(Ta,"__esModule",{value:!0}),Ta.default=void 0;var r=t(_t()),n=bt();return Ta.default=(0,r.default)((0,n.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"}),"CheckCircle"),Ta}var K0=Q0();const Ln=st(K0);var Ia={},Hd;function J0(){if(Hd)return Ia;Hd=1;var t=vt();Object.defineProperty(Ia,"__esModule",{value:!0}),Ia.default=void 0;var r=t(_t()),n=bt();return Ia.default=(0,r.default)((0,n.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-2h2zm0-4h-2V7h2z"}),"Error"),Ia}var X0=J0();const wi=st(X0);var Oa={},Yd;function Z0(){if(Yd)return Oa;Yd=1;var t=vt();Object.defineProperty(Oa,"__esModule",{value:!0}),Oa.default=void 0;var r=t(_t()),n=bt();return Oa.default=(0,r.default)((0,n.jsx)("path",{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2m5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12z"}),"Cancel"),Oa}var ew=Z0();const wl=st(ew),tw=t=>{if(typeof t=="string"){const r=t.trim().toLowerCase();if(["needed","need","required","pending"].includes(r))return"needed";if(["done","complete","completed","sent"].includes(r))return"done";if(["true","t","yes","y","1","on"].includes(r))return"needed";if(["false","f","no","n","0","off",""].includes(r))return""}return typeof t=="boolean"&&t?"needed":""},rw=()=>{const[t,r]=l.useState(""),[n,a]=l.useState([]),[s,o]=l.useState("open"),[i,c]=l.useState(0),u=Gt(),d=un(),{user:p}=er(),[m,f]=l.useState(!1),[_,v]=l.useState({page:0,pageSize:10}),w=async(C=s)=>{try{const L=p?.access_role==="Sales and Purchase"?"open":C,x=(await B.get("/api/sales-orders",{params:{status:L,_ts:Date.now()}})).data.sort((M,X)=>{const H=te=>{const re=te.match(/\d+/);return re?parseInt(re[0],10):0},U=H(M.sales_order_number);return H(X.sales_order_number)-U}),D=x.map(M=>({...M,id:M.sales_order_id,subtotal:Number(M.subtotal)||0,total_gst_amount:Number(M.total_gst_amount)||0,total_amount:Number(M.total_amount)||0,invoice_status:tw(M.invoice_status??M.invoice_required)}));if(a(D),C==="open"||C==="all"){const X=(C==="open"?x:x.filter(H=>H.status==="Open")).reduce((H,U)=>{const G=parseFloat(U.subtotal)||0;return H+G},0);c(X)}else c(0)}catch(L){console.error("Error fetching sales orders:",L),a([]),c(0)}};l.useEffect(()=>{w(s)},[s,p?.access_role]),l.useEffect(()=>{setTimeout(()=>{w(s)},500)},[d.key]),l.useEffect(()=>{const C=()=>w(s),L=()=>{document.visibilityState==="visible"&&w(s)};return window.addEventListener("focus",C),document.addEventListener("visibilitychange",L),()=>{window.removeEventListener("focus",C),document.removeEventListener("visibilitychange",L)}},[s]);const b=async C=>{if(window.confirm("Are you sure you want to delete this Sales Order? This action cannot be undone."))try{await B.delete(`/api/sales-orders/${C}`),z.success("Sales Order deleted successfully!"),w()}catch(L){console.error("Error deleting sales order:",L),z.error("Failed to delete sales order.")}},P=n.filter(C=>C.sales_order_number?.toLowerCase().includes(t.toLowerCase())||C.customer_name?.toLowerCase().includes(t.toLowerCase())||C.product_name?.toLowerCase().includes(t.toLowerCase())||C.product_description?.toLowerCase().includes(t.toLowerCase())),N=[{field:"sales_order_number",headerName:"Sales Order #",flex:1,minWidth:120,valueFormatter:C=>C.value?String(C.value).replace("SO-",""):""},{field:"customer_name",headerName:"Customer",flex:1.3,minWidth:150},{field:"product_name",headerName:"Product Name",flex:1,minWidth:120},{field:"product_description",headerName:"Product Description",flex:1.5,minWidth:150},{field:"subtotal",headerName:"Subtotal",flex:.8,minWidth:100,valueFormatter:C=>C.value!=null&&!isNaN(Number(C.value))?`$${Number(C.value).toFixed(2)}`:"$0.00"},{field:"total_amount",headerName:"Total",flex:.8,minWidth:100,valueFormatter:C=>C.value!=null&&!isNaN(Number(C.value))?`$${Number(C.value).toFixed(2)}`:"$0.00"},{field:"status",headerName:"Status",flex:.8,minWidth:100,renderCell:C=>e.jsx(De,{label:C.value,color:C.value==="Open"?"success":"error",size:"small",variant:"outlined"})},{field:"invoice_status",headerName:"Invoice",flex:.6,minWidth:90,valueFormatter:C=>C.value==="done"?"Done":C.value==="needed"?"Needed":"",renderCell:C=>C.value==="done"?e.jsx(Ln,{color:"success",titleAccess:"Invoice done"}):C.value==="needed"?e.jsx(wl,{color:"error",titleAccess:"Invoice needed"}):null,sortable:!1},{field:"exported_to_qbo",headerName:"QBO Exported",flex:.8,minWidth:120,renderCell:C=>C.row.exported_to_qbo?e.jsx(Ln,{color:"success",titleAccess:"Exported to QuickBooks"}):C.row.qbo_export_status?e.jsx(wi,{color:"error",titleAccess:`QBO Export Error: ${C.row.qbo_export_status}`}):C.row.status==="Closed"?e.jsx(Wl,{color:"warning",titleAccess:"Not exported to QuickBooks"}):null},{field:"actions",headerName:"Actions",width:100,sortable:!1,renderCell:C=>e.jsx(k,{sx:{display:"flex",gap:.5},children:C.row.status!=="Closed"&&e.jsx(gt,{size:"small",color:"error",onClick:L=>{L.stopPropagation(),b(C.row.sales_order_id)},children:e.jsx(xr,{})})})}],j=()=>{setTimeout(()=>{w()},500)},E=()=>{let C=P;s==="open"?C=P.filter(D=>D.status==="Open"):s==="closed"&&(C=P.filter(D=>D.status==="Closed"));const L=Un.unparse(C.map(D=>{const M={};return N.forEach(X=>{if(X.field!=="actions"){const H=D[X.field];X.field==="bill_date"||X.field==="sales_date"?M[X.headerName]=H?new Date(H).toLocaleDateString():"":X.type==="number"?M[X.headerName]=H!=null&&!isNaN(parseFloat(String(H)))?parseFloat(String(H)).toFixed(2):"":M[X.headerName]=H!==void 0?String(H):""}}),M})),y=new Blob([L],{type:"text/csv;charset=utf-8;"}),x=document.createElement("a");if(x.download!==void 0){const D=URL.createObjectURL(y);x.setAttribute("href",D),x.setAttribute("download","open_sales_orders.csv"),x.style.visibility="hidden",document.body.appendChild(x),x.click(),document.body.removeChild(x)}},A=C=>{if(console.log("OpenSalesOrdersPage: Row clicked:",C.row),console.log("OpenSalesOrdersPage: User role:",p?.access_role),console.log("OpenSalesOrdersPage: Sales order ID:",C.row.sales_order_id),p?.access_role==="Time Tracking"){const L=`/worker-sales-orders/${C.row.sales_order_id}`;console.log("OpenSalesOrdersPage: Navigating time tracking user to:",L),u(L)}else{const L=`/open-sales-orders/${C.row.sales_order_id}`;console.log("OpenSalesOrdersPage: Navigating regular user to:",L),u(L)}};return p?.access_role==="Time Tracking"?e.jsxs(nt,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{mb:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Sales Orders"}),e.jsx(k,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:e.jsx(Q,{variant:"outlined",startIcon:e.jsx(_n,{}),onClick:j,children:"Refresh"})})]}),e.jsx(Me,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(Pe,{direction:"row",spacing:3,sx:{mb:2},children:e.jsx(le,{label:"Search",variant:"outlined",value:t,onChange:C=>r(C.target.value),InputProps:{startAdornment:e.jsx(mr,{position:"start",children:e.jsx(Hr,{sx:{fontSize:22}})})},sx:{minWidth:340,maxWidth:400,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"small"})}),e.jsx(tn,{rows:P,columns:N.filter(C=>C.field!=="actions"),loading:!1,paginationModel:_,onPaginationModelChange:v,pageSizeOptions:[10,25,50],getRowId:C=>C.id,onRowClick:A,disableRowSelectionOnClick:!0,initialState:{sorting:{sortModel:[{field:"sales_order_number",sort:"desc"}]}},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]}):e.jsxs(nt,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{mb:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:p?.access_role==="Sales and Purchase"?"Sales Orders (Open Only)":"Sales Orders"}),(s==="open"||s==="all")&&e.jsxs(k,{sx:{mb:2,p:2,bgcolor:"background.paper",borderRadius:1,border:"1px solid",borderColor:"divider"},children:[e.jsxs(h,{variant:"h6",component:"div",sx:{fontWeight:"bold",color:"primary.main"},children:["Work In Process: $",i.toFixed(2)]}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Total subtotal value of all open sales orders"})]}),e.jsx(k,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:e.jsxs(Pe,{direction:"row",spacing:2,children:[p?.access_role!=="Time Tracking"&&e.jsx(Q,{variant:"contained",startIcon:e.jsx(Nr,{}),onClick:()=>u("/open-sales-orders/new"),children:"New SO"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(gr,{}),onClick:E,children:"Export CSV"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(_n,{}),onClick:j,children:"Refresh"})]})})]}),e.jsx(Me,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsxs(Pe,{direction:"row",spacing:3,sx:{mb:2},children:[e.jsx(le,{label:"Search",variant:"outlined",value:t,onChange:C=>r(C.target.value),InputProps:{startAdornment:e.jsx(mr,{position:"start",children:e.jsx(Hr,{sx:{fontSize:22}})})},sx:{minWidth:340,maxWidth:400,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"small"}),p?.access_role!=="Sales and Purchase"&&e.jsx(De,{label:"All",onClick:()=>o("all"),color:s==="all"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),e.jsx(De,{label:"Open",onClick:()=>o("open"),color:s==="open"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),p?.access_role!=="Sales and Purchase"&&e.jsx(De,{label:"Closed",onClick:()=>o("closed"),color:s==="closed"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}})]}),e.jsx(tn,{rows:P,columns:N,loading:!1,paginationModel:_,onPaginationModelChange:v,pageSizeOptions:[10,25,50],getRowId:C=>C.id,onRowClick:A,disableRowSelectionOnClick:!0,initialState:{sorting:{sortModel:[{field:"sales_order_number",sort:"desc"}]}},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]})},_o=(t,r)=>{const n=parseFloat(String(t))||0,a=parseFloat(String(r))||0;return Math.round(n*a*100)/100},on=t=>{const r=parseFloat(String(t));return isNaN(r)?0:r},jo=["Each","cm","ft","kg","pcs","hr","L"],Qn=5,Vd=t=>{if(typeof t=="string"){const r=t.trim().toLowerCase();if(["needed","need","required","pending"].includes(r))return"needed";if(["done","complete","completed","sent"].includes(r))return"done";if(["true","t","yes","y","1","on"].includes(r))return"needed";if(["false","f","no","n","0","off",""].includes(r))return""}return typeof t=="boolean"&&t?"needed":""},Xo=t=>t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim().toUpperCase(),nw=(t,r,n=8)=>{const a=Xo(r);if(!a)return t.slice(0,n);const s=t.map(o=>{const i=Xo(o.label);let c=-1;return i.startsWith(a)?c=3:i.split(" ").some(u=>u.startsWith(a))?c=2:i.includes(a)&&(c=1),{opt:o,score:c}}).filter(o=>o.score>=0);return s.sort((o,i)=>i.score-o.score||o.opt.label.localeCompare(i.opt.label)),s.slice(0,n).map(o=>o.opt)},sw=()=>{const{id:t}=jn(),r=t==="new",n=!!t&&/^\d+$/.test(t),a=Gt(),{user:s}=er(),o=s?.access_role==="Sales and Purchase",[i,c]=l.useState([]),[u,d]=l.useState([]),[p,m]=l.useState([]),[f,_]=l.useState([]),[v,w]=l.useState(null),[b,P]=l.useState(null),[N,j]=l.useState(null),[E,A]=l.useState(null),[C,L]=l.useState(""),[y,x]=l.useState(!1),[D,M]=l.useState(null),[X,H]=l.useState(!1),U=l.useRef(null),[G,te]=l.useState(null),[re,S]=l.useState(""),[g,T]=l.useState(!1),[q,ee]=l.useState(null),[R,K]=l.useState(et()),[F,xe]=l.useState(""),[ve,de]=l.useState(""),[me,ge]=l.useState(""),[pe,se]=l.useState(""),[I,W]=l.useState(""),[ce,Z]=l.useState(""),[Ae,Ce]=l.useState(""),ze=l.useCallback((Y,$)=>{Ce($??"")},[]),[Ve,ut]=l.useState(null),[it,pt]=l.useState(""),[Ne,tt]=l.useState([]);l.useMemo(()=>Ne.map(Y=>({part_number:Y.part_number,part_description:Y.part_description,quantity:on(Y.quantity),unit:Y.unit,unit_price:Y.unit_price})),[Ne]);const Be=l.useMemo(()=>{if(!Ne||Ne.length===0)return{subtotal:0,total_gst_amount:0,total_amount:0};const Y=Ne.reduce((oe,be)=>{const Oe=be.line_amount||0;return oe+Oe},0),$=Y*.05,ae=Y+$;return{subtotal:Math.round(Y*100)/100,total_gst_amount:Math.round($*100)/100,total_amount:Math.round(ae*100)/100}},[Ne]),wt=Be.subtotal,zt=Be.total_gst_amount,Bt=Be.total_amount,[We,Qt]=l.useState(null),[Kt,Wt]=l.useState(!r),[tr,yr]=l.useState(null),[_e,ye]=l.useState(null),[we,fe]=l.useState([]),[Ee,Ue]=l.useState(""),[$e,Je]=l.useState(!1),[at,dt]=l.useState(!1),ke=l.useCallback(Y=>JSON.stringify((Y||[]).map($=>({part_number:($.part_number||"").trim(),part_description:($.part_description||"").trim(),quantity:on($.quantity),unit:($.unit||"").trim(),unit_price:on($.unit_price)})).sort(($,ae)=>$.part_number!==ae.part_number?$.part_number.localeCompare(ae.part_number):$.quantity-ae.quantity)),[]),Ie=l.useCallback(()=>({customer:E?{id:E.id,label:E.label}:null,product:G?{id:G.id,label:G.label}:null,salesDate:R?R.toISOString():null,terms:(ve||"").trim(),customerPoNumber:(me||"").trim(),vinNumber:(pe||"").trim(),estimatedCost:Ve!=null?Number(Ve):null,vehicleMake:(I||"").trim(),vehicleModel:(ce||"").trim(),invoiceStatus:Ae}),[E,G,R,ve,me,pe,Ve,I,ce,Ae]);l.useEffect(()=>{if($e&&Ee===""){const Y=JSON.stringify({header:Ie(),lineItems:ke(Ne)});Ue(Y)}},[$e,Ee,Ie,ke,Ne]);const Xe=l.useMemo(()=>JSON.stringify({header:Ie(),lineItems:ke(Ne)}),[Ie,ke,Ne]),Ct=!!Ee&&Ee!==Xe&&!at,At=!!We&&We.status?.toLowerCase()==="closed",[Er,Yr]=l.useState([]),[Lr,Fn]=l.useState([]),[qr,pr]=l.useState(null),[wr,Yt]=l.useState(null),[sn,pn]=l.useState(null),[Wn,$n]=l.useState(null),[Ur,vr]=l.useState(null),[ls,je]=l.useState(null),[rt,ct]=l.useState(!1),[Vt,ur]=l.useState(null),[Dr,Fr]=l.useState(""),[Tr,Sr]=l.useState(!1),[Vr,Gr]=l.useState(null),[Xr,Wr]=l.useState(""),Cr=Lr.length>0?8+64*Lr.length:0;l.useMemo(()=>JSON.stringify(Ne.map(Y=>({part_number:Y.part_number,part_description:Y.part_description,quantity:Y.quantity,unit:Y.unit,unit_price:Y.unit_price,line_amount:Y.line_amount}))),[Ne]);const wn=(Y,$)=>{const ae=(Ne[Y]?.part_number||"").trim(),oe=$.key==="Enter",be=$.key==="Tab",Oe=$.key==="Escape",Ge=$.key==="ArrowDown"||$.key==="ArrowUp";if(Oe){Yt(null);return}if(Ge){$.key==="ArrowDown"&&wr!==Y&&Yt(Y);return}if(!(wr===Y&&(oe||be))&&(oe||be)&&ae){if(oe&&$.ctrlKey){$.preventDefault(),$n(Y),Fr(ae.toUpperCase()),ur(Y),ct(!0),Yt(null);return}!p.find(Pt=>Pt.part_number.toUpperCase()===ae.toUpperCase())&&oe&&($.preventDefault(),$n(Y),Fr(ae.toUpperCase()),ur(Y),ct(!0),Yt(null))}},cs=(Y,$)=>{const ae=(we[Y]?.part_number||"").trim(),oe=$.key==="Enter",be=$.key==="Tab",Oe=$.key==="Escape",Ge=$.key==="ArrowDown"||$.key==="ArrowUp";if(Oe){vr(null);return}if(Ge){$.key==="ArrowDown"&&Ur!==Y&&vr(Y);return}if(!(Ur===Y&&(oe||be))&&(oe||be)&&ae){if(oe&&$.ctrlKey){$.preventDefault(),je(Y),Wr(ae.toUpperCase()),Gr(Y),Sr(!0),vr(null);return}!p.find(Pt=>Pt.part_number.toUpperCase()===ae.toUpperCase())&&oe&&($.preventDefault(),je(Y),Wr(ae.toUpperCase()),Gr(Y),Sr(!0),vr(null))}},Qr=Y=>i.find($=>Xo($.label)===Xo(Y))||null,[ds,hn]=l.useState(!1),[zn,mn]=l.useState(""),[$s,Bn]=l.useState(!1),[us,Hn]=l.useState(""),[co,ps]=l.useState(!1),[hs,zs]=l.useState([]),[ms,fs]=l.useState(null),[Bs,Sn]=l.useState(!1),[Yn,Hs]=l.useState(!1),[xs,Cn]=l.useState(null),[uo,Kr]=l.useState(null),[po,br]=l.useState(null);l.useEffect(()=>{(async()=>{try{const[Y,$,ae,oe]=await Promise.all([B.get("/api/customers"),B.get("/api/products"),B.get("/api/inventory"),B.get("/api/margin-schedule")]);c(Y.data.map(be=>({label:be.customer_name,id:be.customer_id}))),d($.data.map(be=>({label:be.product_name,id:be.product_id,description:be.product_description}))),m(ae.data),_(oe.data),r&&Je(!0)}catch(Y){console.error("Prefetch failed",Y)}})()},[]),l.useEffect(()=>{(async()=>{try{const[Y,$,ae]=await Promise.all([B.get("/api/settings/labour-rate").catch(()=>({data:{labour_rate:null}})),B.get("/api/settings/overhead-rate").catch(()=>({data:{overhead_rate:null}})),B.get("/api/settings/supply-rate").catch(()=>({data:{supply_rate:null}}))]);w(Y.data.labour_rate??null),P($.data.overhead_rate??null),j(ae.data.supply_rate??null)}catch{}})()},[]),l.useEffect(()=>{if(!t||r||!n){r&&(tt([{part_number:"",part_description:"",quantity:"",unit:jo[0],unit_price:0,gst:Qn,line_amount:0}]),Je(!0),pt(""));return}(async()=>{Wt(!0),yr(null);try{const $=(await B.get(`/api/sales-orders/${t}`)).data,ae=Vd($.salesOrder?.invoice_status??$.salesOrder?.invoice_required);Qt($.salesOrder?{...$.salesOrder,invoice_status:ae||null}:null),pt($.salesOrder?.source_quote_number||"");const oe=($.lineItems||$.salesOrder?.line_items||[]).map(Re=>({part_number:Re.part_number,part_description:Re.part_description,unit:Re.unit,unit_price:Re.unit_price,line_amount:Number(Re.line_amount||0),quantity:Re.part_number==="SUPPLY"?"1":["LABOUR","OVERHEAD"].includes(Re.part_number)?String(Re.quantity_sold||0):String(Re.quantity_sold??Re.quantity??0),gst:Qn,part_id:Re.part_id??void 0}));console.log("[SalesOrderDetail] Raw line items from backend:",$.lineItems),console.log("[SalesOrderDetail] Mapped line items:",oe),tt(oe),Yr(oe);const be=($.partsToOrder||[]).map(Re=>({sales_order_id:parseInt(t),part_number:Re.part_number,part_description:Re.part_description,quantity_to_order:String(Re.quantity_needed||0),unit:Re.unit||"Each",unit_price:Number(Re.unit_price||0),line_amount:Number(Re.line_amount||0)}));fe(be),K(et($.salesOrder?.sales_date)),ut($.salesOrder?.estimated_cost||0),xe($.salesOrder?.product_description||""),de($.salesOrder?.terms||""),ge($.salesOrder?.customer_po_number||""),se($.salesOrder?.vin_number||""),W($.salesOrder?.vehicle_make||""),Z($.salesOrder?.vehicle_model||""),Ce(ae);const Oe=i.find(Re=>Re.id===$.salesOrder?.customer_id)||{label:$.salesOrder?.customer_name||"",id:$.salesOrder?.customer_id};A(Oe?.id?Oe:null);const Ge=u.find(Re=>Re.label===$.salesOrder?.product_name)||{label:$.salesOrder?.product_name||""};te(Ge?.label?Ge:null)}catch(Y){console.error(Y),yr(Y?.response?.status===404?"Sales order not found. It may have been deleted.":"Failed to load sales order data. Please try again.")}finally{Wt(!1),Je(!0)}})()},[t,r,n]),l.useEffect(()=>{$e&&v!==null&&tt(Y=>Y.map($=>$.part_number!=="LABOUR"?$:$.unit_price!==v?{...$,unit_price:v}:$))},[v,$e]),l.useEffect(()=>{$e&&b!==null&&tt(Y=>Y.map($=>$.part_number!=="OVERHEAD"?$:$.unit_price!==b?{...$,unit_price:b}:$))},[b,$e]),l.useEffect(()=>{$e&&tt(Y=>{const $=Y.some(oe=>oe.part_number==="LABOUR"),ae=Y.some(oe=>oe.part_number==="SUPPLY");if(N&&N>0){if($&&!ae)return[...Y,{part_number:"SUPPLY",part_description:"Supply",quantity:r?"":"1",unit:r?"":"Each",unit_price:0,gst:Qn,line_amount:0}];if(!$&&ae)return Y.filter(oe=>oe.part_number!=="SUPPLY")}else if(ae)return Y.filter(oe=>oe.part_number!=="SUPPLY");return Y})},[N,Ne,$e,r]);const Zr=Y=>{const $=[...f].sort((ae,oe)=>ae.cost_lower_bound-oe.cost_lower_bound);for(const ae of $){const oe=+ae.cost_lower_bound,be=ae.cost_upper_bound==null?null:+ae.cost_upper_bound,Oe=+ae.margin_factor;if(Y>=oe&&(be===null||Y<be))return Oe}return 1},Ci=Y=>p.find($=>$.part_number===Y),gs=(Y,$)=>{tt(ae=>{const oe=[...ae];if(!$||$.trim()==="")oe[Y]={...oe[Y],part_number:"",part_description:"",quantity:"",unit:jo[0],unit_price:0,line_amount:0};else if($.toUpperCase()==="LABOUR")oe[Y]={...oe[Y],part_number:"LABOUR",part_description:"Labour",unit:"hr",unit_price:v??0,line_amount:0};else if($.toUpperCase()==="OVERHEAD")oe[Y]={...oe[Y],part_number:"OVERHEAD",part_description:"Overhead",unit:"hr",unit_price:b??0,line_amount:0};else if($.toUpperCase()==="SUPPLY")oe[Y]={...oe[Y],part_number:"SUPPLY",part_description:"Supply",unit:r?"":"Each",unit_price:0,line_amount:0};else{const be=Ci($);if(be){const Oe=parseFloat(String(be.last_unit_cost))||0,Ge=Zr(Oe);oe[Y]={...oe[Y],part_number:$,part_description:be.part_description||"",unit:be.unit,unit_price:Oe*Ge,line_amount:0}}else oe[Y]={...oe[Y],part_number:$,part_description:"Part not found",unit_price:0,line_amount:0}}return oe})},ho=(Y,$,ae)=>{tt(oe=>{const be=[...oe],Oe={...be[Y],[$]:ae};return parseFloat(ae)<=0&&Oe.part_number!=="SUPPLY"?be.filter((Ge,Re)=>Re!==Y):(["LABOUR","OVERHEAD"].includes(Oe.part_number),be[Y]=Oe,be)})},ki=()=>{tt(Y=>[...Y,{part_number:"",part_description:"",quantity:"",unit:jo[0],unit_price:0,gst:Qn,line_amount:0}])},Pi=Y=>{tt($=>$.filter((ae,oe)=>oe!==Y))},ys=(Y,$)=>{if(["LABOUR","OVERHEAD","SUPPLY"].includes(Y.part_number))return null;const ae=p.find($t=>$t.part_number.toLowerCase()===Y.part_number.toLowerCase());if(!ae||ae.part_type==="supply")return null;const oe=parseFloat(ae.quantity_on_hand)||0;if(r){const $t=Ne.filter(kn=>kn.part_number.toLowerCase()===Y.part_number.toLowerCase()).reduce((kn,Vs)=>kn+(parseFloat(String(Vs.quantity).replace(/[^\d.-]/g,""))||0),0),rr=oe-$t;return{available:rr<0?Math.floor(rr):Math.round(rr),isNegative:rr<0,currentStock:oe,changeInQuantity:$t,totalQuantityForPart:$t,totalOriginalQuantityForPart:0}}const be=Ne.filter($t=>$t.part_number.toLowerCase()===Y.part_number.toLowerCase()).reduce(($t,rr)=>$t+(parseFloat(String(rr.quantity).replace(/[^\d.-]/g,""))||0),0),Oe=Er.filter($t=>$t.part_number.toLowerCase()===Y.part_number.toLowerCase()).reduce(($t,rr)=>$t+(parseFloat(String(rr.quantity).replace(/[^\d.-]/g,""))||0),0),Ge=be-Oe,Re=oe-Ge,Pt=Re<0?Math.floor(Re):Math.round(Re);return{available:Pt,isNegative:Pt<0,currentStock:oe,changeInQuantity:Ge,totalQuantityForPart:be,totalOriginalQuantityForPart:Oe}},Vn=l.useMemo(()=>Ne.map((Y,$)=>ys(Y)),[Ne,p,Er,r]);l.useEffect(()=>{if(r)return;const Y=[];Ne.forEach(($,ae)=>{const oe=ys($);oe&&oe.available<0&&Y.push({lineItemIndex:ae,partNumber:$.part_number,partDescription:$.part_description,excessQuantity:Math.abs(oe.available),unit:$.unit})}),Fn(Y)},[Ne,p,r]);const Ei=()=>{if(pe&&pe.trim()!==""&&pe.trim().length!==17)return z.error("VIN must be 17 characters"),!1;if(Ne.filter(oe=>!oe.part_number||oe.part_number.trim()==="").length>0)return z.error("Line items with blank part numbers are not allowed."),!1;const $=Ne.filter(oe=>{if(["LABOUR","OVERHEAD","SUPPLY"].includes(String(oe.part_number).toUpperCase()))return!1;const be=oe.part_id;if(be){const Ge=(p||[]).find(Re=>Re.part_id===be);return Ge?Ge.part_type==="supply":!1}const Oe=(p||[]).find(Ge=>String(Ge.part_number).toUpperCase()===String(oe.part_number).trim().toUpperCase());return!Oe||Oe.part_type==="supply"});if($.length>0){const oe=$.map(be=>be.part_number).join(", ");return z.error(`Invalid or supply parts (not allowed): ${oe}`),!1}return Ne.some((oe,be)=>{const Oe=ys(oe);return Oe&&Oe.available<0})?(br("Insufficient inventory for one or more parts."),!1):(br(null),!0)},Ys=Y=>{const $=Y.reduce((ae,oe)=>{const be=oe.part_number.trim().toLowerCase();if(!ae[be]){const Oe=["LABOUR","OVERHEAD","SUPPLY"].includes(oe.part_number.toUpperCase())?null:(p||[]).find(Ge=>String(Ge.part_number).toUpperCase()===oe.part_number.trim().toUpperCase());ae[be]={part_number:oe.part_number.trim(),part_description:oe.part_description.trim(),unit:oe.unit.trim(),unit_price:oe.unit_price!=null?Number(oe.unit_price):0,line_amount:0,quantity_sold:0,...oe.part_id?{part_id:oe.part_id}:Oe&&Oe.part_id?{part_id:Oe.part_id}:{}}}if(oe.part_number.toUpperCase()==="SUPPLY")ae[be].quantity_sold=1,ae[be].unit="Each",ae[be].unit_price=0,ae[be].line_amount+=Number(oe.line_amount||0);else if(["LABOUR","OVERHEAD"].includes(oe.part_number.toUpperCase())){const Oe=parseFloat(String(oe.quantity).replace(/[^\d.-]/g,""))||0;ae[be].quantity_sold=Oe,ae[be].line_amount=Number(oe.line_amount||0)}else{const Oe=parseFloat(String(oe.quantity).replace(/[^\d.-]/g,""))||0;ae[be].quantity_sold+=Math.round(Oe),ae[be].line_amount+=Oe*(oe.unit_price||0)}return ae},{});return Object.values($)},Gn=async()=>{if(!E||!R||!G){z.error("Please fill in required fields.");return}if(!Ei())return;const Y={customer_id:E?.id,sales_date:R?R.toISOString():new Date().toISOString(),product_name:G?.label?.trim(),product_description:F.trim(),terms:ve.trim(),customer_po_number:me.trim(),vin_number:pe.trim(),vehicle_make:I.trim(),vehicle_model:ce.trim(),invoice_status:Ae||null,status:r?"Open":We?.status||"Open",estimated_cost:Ve!=null?Number(Ve):0,lineItems:Ys(Ne),source_quote_number:it?.trim()||null};dt(!0);try{if(r){if(window.__soCreateInFlight){console.log("[SO] Skipping duplicate create (in flight)");return}window.__soCreateInFlight=!0;const $=await B.post("/api/sales-orders",Y);z.success("Sales Order created successfully!"),window.__unsavedGuardAllowNext=!0,a(`/open-sales-orders/${$.data.sales_order_id}`)}else{const $=we.filter(ae=>ae.part_number&&parseFloat(String(ae.quantity_to_order))>0).map(ae=>({sales_order_id:Number(t),part_number:ae.part_number.trim(),part_description:ae.part_description.trim(),quantity_needed:parseFloat(String(ae.quantity_to_order))||0,unit:ae.unit.trim(),unit_price:ae.unit_price,line_amount:ae.line_amount}));await B.put(`/api/sales-orders/${t}`,{...Y,partsToOrder:$}),ye("Sales Order updated successfully!"),setTimeout(()=>{window.__unsavedGuardAllowNext=!0},100),Ue(JSON.stringify({header:{customer:E,product:G,salesDate:R,terms:ve,customerPoNumber:me,vinNumber:pe,estimatedCost:Ve,vehicleMake:I,vehicleModel:ce,invoiceStatus:Ae},lineItems:Ne,quantityToOrderItems:we}));try{const[ae,oe]=await Promise.all([B.get(`/api/sales-orders/${t}`),B.get("/api/inventory")]),be=ae.data,Oe=Vd(be.salesOrder?.invoice_status??be.salesOrder?.invoice_required);Qt(be.salesOrder?{...be.salesOrder,invoice_status:Oe||null}:null),Ce(Oe),pt(be.salesOrder?.source_quote_number||"");const Ge=(be.lineItems||be.salesOrder?.line_items||[]).map(Re=>({part_number:Re.part_number,part_description:Re.part_description,unit:Re.unit,unit_price:Re.unit_price,line_amount:Number(Re.line_amount||0),quantity:Re.part_number==="SUPPLY"?"1":["LABOUR","OVERHEAD"].includes(Re.part_number)?String(Re.quantity_sold||0):String(Re.quantity_sold??Re.quantity??0),gst:Qn,part_id:Re.part_id??void 0}));tt(Ge),Yr(Ge),m(oe.data)}catch{}}}catch($){const ae=$?.response?.data?.error||$?.response?.data?.details||$?.response?.data?.message||"Failed to save sales order.";br(ae)}finally{dt(!1),window.__soCreateInFlight=!1}},V=async()=>{if(r||!We)return;const Y=Ne.filter($=>!["LABOUR","OVERHEAD","SUPPLY"].includes($.part_number)&&(parseFloat(String($.quantity).replace(/[^\d.-]/g,""))||0)===0);if(Y.length>0){z.error(`Cannot close: line items with 0 quantity: ${Y.map($=>$.part_number).join(", ")}`);return}if(we.some($=>parseFloat(String($.quantity_to_order))>0)){const $=we.filter(ae=>parseFloat(String(ae.quantity_to_order))>0).map(ae=>`${ae.part_number} (${ae.quantity_to_order})`).join(", ");z.error(`Cannot close: parts still need to be ordered: ${$}`);return}try{await B.put(`/api/sales-orders/${We.sales_order_id}`,{customer_id:We.customer_id,sales_date:We.sales_date,product_name:G?.label?.trim()||We.product_name,product_description:F.trim(),terms:ve.trim(),status:"Closed",estimated_cost:Ve??We.estimated_cost,lineItems:Ys(Ne)}),z.success("Sales Order closed successfully!"),Qt($=>$&&{...$,status:"Closed"})}catch($){const ae=$?.response?.data?.error||$?.response?.data?.details||$?.response?.data?.message||"Failed to close sales order.";br(ae)}},J=async()=>{if(!(r||!We))try{await B.put(`/api/sales-orders/${We.sales_order_id}`,{customer_id:We.customer_id,sales_date:We.sales_date,product_name:G?.label?.trim()||We.product_name,product_description:F.trim(),terms:ve.trim(),status:"Open",estimated_cost:Ve??We.estimated_cost,lineItems:Ys(Ne)}),z.success("Sales Order reopened successfully!"),Qt(Y=>Y&&{...Y,status:"Open"}),a(`/open-sales-orders/${We.sales_order_id}`)}catch(Y){const $=Y?.response?.data?.error||Y?.response?.data?.details||Y?.response?.data?.message||"Failed to reopen sales order.";br($)}},ie=async()=>{if(r)return await(async()=>(await Gn(),!0))(),void 0;if(We)try{We.status?.toLowerCase()!=="closed"&&await Gn();const Y=await B.get(`/api/sales-orders/${We.sales_order_id}/pdf`,{responseType:"blob"}),$=window.URL.createObjectURL(new Blob([Y.data],{type:"application/pdf"})),ae=document.createElement("a");ae.href=$,ae.download=`sales_order_${We.sales_order_number}.pdf`,document.body.appendChild(ae),ae.click(),ae.remove(),window.URL.revokeObjectURL($),z.success(We.status?.toLowerCase()==="closed"?"PDF downloaded.":"Saved and downloaded PDF.")}catch(Y){const $=Y?.response?.data?.error||Y?.response?.data?.details||Y?.response?.data?.message||"Failed to save or download PDF.";br($)}},he=async()=>{if(!(r||!We)){if(we.some(Y=>parseFloat(String(Y.quantity_to_order))>0)){const Y=we.filter($=>parseFloat(String($.quantity_to_order))>0).map($=>`${$.part_number} (${$.quantity_to_order})`).join(", ");z.error(`Cannot export to QuickBooks: parts to order exist: ${Y}`);return}Hs(!0),Cn(null),Kr(null);try{const Y=await B.post(`/api/sales-orders/${We.sales_order_id}/export-to-qbo`);Kr("Sales Order exported to QuickBooks successfully!"),Qt($=>$&&{...$,exported_to_qbo:!0,qbo_invoice_id:Y.data.qbo_invoice_id,qbo_export_date:new Date().toISOString(),qbo_export_status:"Success"}),z.success("Exported to QuickBooks.")}catch(Y){const $=Y?.response?.data;if($?.error==="CUSTOMER_NOT_FOUND")if(window.confirm(`Customer '${$.customerName}' does not exist in QuickBooks.
Create it and export the Sales Order?`))try{const oe=await B.post(`/api/sales-orders/${We.sales_order_id}/export-to-qbo-with-customer`,{customerData:$.customerData});z.success("Customer created and Sales Order exported."),Kr("Customer created and Sales Order exported."),Qt(be=>be&&{...be,exported_to_qbo:!0,qbo_invoice_id:oe.data.qbo_invoice_id,qbo_export_date:new Date().toISOString(),qbo_export_status:"Success"})}catch(oe){const be=oe?.response?.data?.error||"Failed to create customer and export to QuickBooks.";Cn(be),z.error(be)}else Cn("Export cancelled. Customer must exist in QuickBooks.");else{const ae=$?.error||$?.message||"Failed to export to QuickBooks.";Cn(ae),z.error(ae)}}finally{Hs(!1)}}},ue=async()=>{Sn(!0);try{const Y=await B.get("/api/sales-orders");zs(Y.data)}catch{z.error("Failed to fetch sales orders for import")}finally{Sn(!1)}},Te=()=>{ps(!0),ue()},Qe=async()=>{if(ms){Sn(!0);try{const Y=await B.get(`/api/sales-orders/${ms.sales_order_id}`),oe=(Y.data.lineItems||Y.data.salesOrder?.line_items||[]).filter(be=>(be.part_number||"").toUpperCase()!=="LABOUR").map(be=>({part_number:be.part_number,part_description:be.part_description,quantity:String(r?be.quantity:be.quantity_sold??be.quantity??0),unit:be.unit,unit_price:be.unit_price,gst:Qn,line_amount:be.line_amount,part_id:be.part_id??void 0}));tt(oe),ps(!1),fs(null),z.success("Line items imported!")}catch{z.error("Failed to import line items")}finally{Sn(!1)}}},Ye=Y=>{const $=C.trim(),ae=Y.key==="Enter",oe=Y.key==="Tab";if(Y.key==="Escape"){x(!1);return}if(ae||oe){if(ae&&Y.ctrlKey&&$){Y.preventDefault(),H(!0),mn($),hn(!0);return}if(y||!$)return;Y.preventDefault();const Oe=Qr($);Oe?(A(Oe),L(Oe.label)):(H(!0),mn($),hn(!0))}},yt=Y=>{if(Y.key!=="Enter")return;Y.preventDefault();const $=re.trim();if(!$)return;const ae=u.find(oe=>oe.label.toLowerCase()===$.toLowerCase());ae?(te(ae),S(ae.label)):(Hn($),Bn(!0))},Jt=()=>{if(!We)return null;const Y=Ne||[];let $=Y.reduce((be,Oe)=>be+(Number(Oe.line_amount)||0),0),ae=$*.05,oe=$+ae;return isNaN($)&&($=0),isNaN(ae)&&(ae=0),isNaN(oe)&&(oe=0),e.jsxs(k,{p:{xs:2,md:4},maxWidth:1e3,mx:"auto",children:[uo&&e.jsx(Fe,{severity:"success",sx:{mb:2},onClose:()=>Kr(null),children:uo}),xs&&e.jsx(Fe,{severity:"error",sx:{mb:2},onClose:()=>Cn(null),children:xs}),e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Sales Order Details"}),e.jsx(kt,{variant:"outlined",sx:{mb:3},children:e.jsx(Ot,{children:e.jsxs(O,{container:!0,spacing:{xs:2,md:3},children:[e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Sales Order #:"})," ",We.sales_order_number]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Customer:"})," ",We.customer_name||"N/A"]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Sales Date:"})," ",We.sales_date?new Date(We.sales_date).toLocaleDateString():""]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Status:"})," ",We.status?.toUpperCase()||"N/A"]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"VIN #:"})," ",We.vin_number||"N/A"]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Make:"})," ",We.vehicle_make||"N/A"]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Model:"})," ",We.vehicle_model||"N/A"]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Invoice:"})," ",We.invoice_status==="done"&&e.jsxs(k,{component:"span",sx:{display:"inline-flex",alignItems:"center",gap:.5},children:[e.jsx(Ln,{color:"success",fontSize:"small"})," Done"]}),We.invoice_status==="needed"&&e.jsxs(k,{component:"span",sx:{display:"inline-flex",alignItems:"center",gap:.5},children:[e.jsx(wl,{color:"error",fontSize:"small"})," Needed"]}),!We.invoice_status&&""]}),e.jsxs(O,{item:!0,xs:12,children:[e.jsx("b",{children:"Estimated Price:"})," ",Or(We.estimated_cost||0)]}),e.jsxs(O,{item:!0,xs:12,children:[e.jsx("b",{children:"Product Description:"})," ",We.product_description||"N/A"]}),e.jsxs(O,{item:!0,xs:12,children:[e.jsx("b",{children:"Terms:"})," ",We.terms||"N/A"]}),We.exported_to_qbo&&e.jsxs(O,{item:!0,xs:12,children:[e.jsx("b",{children:"QBO Export:"})," Exported",We.qbo_invoice_id&&` (Invoice ID: ${We.qbo_invoice_id})`,We.qbo_export_date&&` on ${new Date(We.qbo_export_date).toLocaleDateString()}`]})]})})}),e.jsx(h,{variant:"h5",gutterBottom:!0,children:"Items"}),e.jsx(kt,{variant:"outlined",children:e.jsx(Ot,{children:Y.map((be,Oe)=>e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:6,sm:3,md:2,children:be.part_number}),e.jsx(O,{item:!0,xs:6,sm:5,md:4,children:be.part_description}),e.jsx(O,{item:!0,xs:4,sm:2,md:1.5,children:be.quantity}),e.jsx(O,{item:!0,xs:4,sm:2,md:1.5,children:be.unit}),e.jsx(O,{item:!0,xs:4,sm:2,md:1.5,children:Or(be.unit_price)}),e.jsx(O,{item:!0,xs:4,sm:2,md:1,children:Or(be.line_amount)})]},Oe))})}),e.jsxs(k,{mt:4,display:"flex",flexDirection:"column",alignItems:"flex-end",children:[e.jsxs(h,{variant:"h6",children:["Subtotal: ",Or($)]}),e.jsxs(h,{variant:"h6",children:["Total GST: ",Or(ae)]}),e.jsxs(h,{variant:"h6",children:["Total Amount: ",Or(oe)]})]}),e.jsxs(k,{mt:4,display:"flex",justifyContent:{xs:"center",sm:"flex-end"},gap:2,children:[e.jsx(Q,{variant:"contained",color:"primary",startIcon:e.jsx(gr,{}),onClick:ie,children:"Download PDF"}),!We.exported_to_qbo&&e.jsx(Q,{variant:"contained",color:"success",startIcon:e.jsx(so,{}),disabled:Yn,onClick:he,children:Yn?"Exporting...":"Export to QuickBooks"}),s?.access_role!=="Sales and Purchase"&&e.jsx(Q,{variant:"contained",color:"primary",onClick:J,children:"Reopen SO"})]})]})};return!r&&Kt?e.jsxs(nt,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(ot,{}),e.jsx(h,{children:"Loading sales order..."})]}):!r&&tr?e.jsxs(nt,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(Fe,{severity:"error",sx:{mb:2},children:tr}),e.jsx(Q,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Retry"}),e.jsx(Q,{variant:"outlined",onClick:()=>a("/open-sales-orders"),children:"Back to Sales Orders"})]}):!r&&At&&s?.access_role==="Sales and Purchase"?e.jsxs(nt,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(Fe,{severity:"error",sx:{mb:2},children:"Access Denied: Sales and Purchase users cannot view closed sales orders."}),e.jsx(Q,{variant:"outlined",onClick:()=>a("/open-sales-orders"),children:"Back to Sales Orders"})]}):!r&&At?Jt():e.jsxs(bn,{dateAdapter:os,children:[e.jsx(ji,{when:Ct,onSave:Gn}),e.jsxs(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(h,{variant:"h4",component:"h1",children:r?"Create Sales Order":`Edit Sales Order${We?.sales_order_number?`: ${We.sales_order_number}`:""}`}),e.jsxs(Pe,{direction:"row",spacing:1,children:[r&&e.jsx(Q,{variant:"outlined",onClick:()=>{A(null),L(""),K(et()),te(null),S(""),xe(""),de(""),ge(""),se(""),W(""),Z(""),Ce(""),ut(null),tt([{part_number:"",part_description:"",quantity:"",unit:jo[0],unit_price:0,gst:Qn,line_amount:0}]),br(null)},children:"Reset"}),e.jsx(Q,{variant:"contained",startIcon:e.jsx(is,{}),onClick:Gn,children:r?"Save Sales Order":"Save Changes"}),!r&&e.jsxs(e.Fragment,{children:[s?.access_role!=="Sales and Purchase"&&e.jsx(Q,{variant:"contained",startIcon:e.jsx(Jo,{}),onClick:V,children:"Close SO"}),e.jsx(Q,{variant:"contained",startIcon:e.jsx(gr,{}),onClick:ie,children:"Download PDF"})]})]})]}),e.jsx(k,{sx:{mb:2},children:e.jsx(Q,{variant:"outlined",color:"secondary",onClick:Te,children:"Import Line Items"})}),e.jsxs(mt,{open:co,onClose:()=>ps(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:"Import Line Items from Sales Order"}),e.jsx(xt,{children:Bs?e.jsx(k,{display:"flex",alignItems:"center",justifyContent:"center",minHeight:120,children:e.jsx(ot,{})}):e.jsx(zr,{options:hs,getOptionLabel:Y=>{if(!Y)return"";const $=Y.sales_order_number||"",ae=Y.customer_name||"",oe=Y.status||"";return`${$} - ${ae}${oe?` (${oe})`:""}`},value:ms,onChange:(Y,$)=>fs($),renderInput:Y=>e.jsx(le,{...Y,label:"Select Sales Order",fullWidth:!0}),isOptionEqualToValue:(Y,$)=>Y.sales_order_id===$?.sales_order_id})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>ps(!1),children:"Cancel"}),e.jsx(Q,{onClick:Qe,disabled:!ms||Bs,variant:"contained",children:"Import"})]})]}),po&&e.jsxs(Fe,{severity:"warning",sx:{mb:3},onClose:()=>br(null),children:[e.jsx(h,{variant:"body1",sx:{fontWeight:"medium"},children:"Inventory Error"}),e.jsx(h,{variant:"body2",children:po})]}),e.jsx(Me,{sx:{p:3,mb:3,transform:Cr?`translateY(-${Cr}px)`:"none",transition:"transform 200ms ease"},elevation:3,children:e.jsxs(O,{container:!0,spacing:3,children:[e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(zr,{open:y,onOpen:()=>x(!0),onClose:()=>x(!1),autoHighlight:!0,value:E,onChange:(Y,$)=>{if(X){H(!1);return}$&&$.isNew?(hn(!0),mn(C),A(null),L(""),x(!1)):(A($),x(!1))},inputValue:C,onInputChange:(Y,$,ae)=>{if(L($),D&&window.clearTimeout(D),ae==="reset")return;if(($||"").trim().length>0){const be=window.setTimeout(()=>x(!0),200);M(be)}else x(!1)},options:i,filterOptions:(Y,$)=>{const ae=nw(Y,$.inputValue||""),oe=!!Qr($.inputValue||""),be=[...ae];return($.inputValue||"").trim()!==""&&!oe&&be.push({label:`Add "${$.inputValue}" as New Customer`,isNew:!0}),be},getOptionLabel:Y=>typeof Y=="string"?Y:Y.label,isOptionEqualToValue:(Y,$)=>Y.id===$.id,renderOption:(Y,$)=>{const ae=$.isNew,{key:oe,...be}=Y;return e.jsxs("li",{...be,style:{display:"flex",alignItems:"center",opacity:ae?.9:1},children:[ae&&e.jsx(Mn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),e.jsx("span",{children:$.label})]},oe)},renderInput:Y=>e.jsx(le,{...Y,label:"Customer",required:!0,onKeyDown:Ye,onBlur:()=>{if(!E){const $=C.trim();if($){const ae=Qr($);ae&&(A(ae),L(ae.label))}}},inputRef:$=>{U.current=$}})})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Customer PO #",value:me,onChange:Y=>ge(Y.target.value),fullWidth:!0,placeholder:"Optional"})}),!o&&e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Quoted Price",type:"number",value:Ve??"",onChange:Y=>ut(Y.target.value?parseFloat(Y.target.value):null),fullWidth:!0,InputProps:{startAdornment:e.jsx(mr,{position:"start",children:"$"})},inputProps:{onWheel:Y=>Y.currentTarget.blur()}})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Source Quote #",value:it||"",placeholder:"Not converted from a quote",fullWidth:!0,InputProps:{readOnly:!0}})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(zr,{disablePortal:!0,open:g,onOpen:()=>T(!0),onClose:()=>T(!1),autoHighlight:!0,value:G,onChange:(Y,$)=>{if($&&$.isNew){const ae=$.inputValue?.toString?.()||re.trim();Bn(!0),Hn(ae),te(null),S(""),T(!1)}else te($),T(!1)},inputValue:re,onInputChange:(Y,$,ae)=>{if(S($),Hn($),q&&window.clearTimeout(q),ae==="reset")return;if(($||"").trim().length>0){const be=window.setTimeout(()=>T(!0),200);ee(be)}else T(!1)},options:u,filterOptions:(Y,$)=>{const ae=Y.filter(oe=>oe.label.toLowerCase().includes(($.inputValue||"").toLowerCase()));return($.inputValue||"")!==""&&!Y.some(oe=>oe.label.toLowerCase()===($.inputValue||"").toLowerCase())&&ae.push({label:`Add "${$.inputValue}"`,isNew:!0,inputValue:$.inputValue}),ae},getOptionLabel:Y=>typeof Y=="string"?Y:Y.label,renderInput:Y=>e.jsx(le,{...Y,label:"Product Name",required:!0,onKeyDown:yt,onBlur:()=>{if(T(!1),!G){const $=re.trim();if($){const ae=u.find(oe=>oe.label.toLowerCase()===$.toLowerCase());ae&&(te(ae),S(ae.label))}}}}),disabled:!1})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"VIN #",value:pe,onChange:Y=>se(Y.target.value),fullWidth:!0,placeholder:"Optional",error:!!(pe&&pe.trim()!==""&&pe.trim().length!==17),helperText:pe&&pe.trim()!==""&&pe.trim().length!==17?"VIN must be 17 characters":""})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Make",value:I,onChange:Y=>W(Y.target.value),fullWidth:!0,placeholder:"Optional"})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Model",value:ce,onChange:Y=>Z(Y.target.value),fullWidth:!0,placeholder:"Optional"})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsxs(Mt,{component:"fieldset",fullWidth:!0,children:[e.jsx(zh,{sx:{mb:1},children:"Invoice"}),e.jsxs(Bh,{value:Ae||null,exclusive:!0,fullWidth:!0,size:"small",color:"standard","aria-label":"Invoice status",onChange:ze,sx:{"& .MuiToggleButtonGroup-grouped":{textTransform:"none",flex:1,gap:0},"& .MuiToggleButtonGroup-grouped:not(:first-of-type)":{marginLeft:0},"& .MuiToggleButtonGroup-grouped.Mui-selected":{color:"#fff"},"& .MuiToggleButtonGroup-grouped.Mui-selected.MuiToggleButton-colorError":{bgcolor:Y=>Y.palette.error.main,"&:hover":{bgcolor:Y=>Y.palette.error.dark}},"& .MuiToggleButtonGroup-grouped.Mui-selected.MuiToggleButton-colorSuccess":{bgcolor:Y=>Y.palette.success.main,"&:hover":{bgcolor:Y=>Y.palette.success.dark}}},children:[e.jsxs(Jl,{value:"needed",color:"error",children:[e.jsx(wl,{fontSize:"small",sx:{mr:1}}),"Needed"]}),e.jsxs(Jl,{value:"done",color:"success",children:[e.jsx(Ln,{fontSize:"small",sx:{mr:1}}),"Done"]})]})]})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(Nn,{label:"Sales Date",value:R,onChange:K,sx:{width:"100%"},slotProps:{textField:{required:!0}}})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Product Description",value:F,onChange:Y=>xe(Y.target.value),fullWidth:!0,multiline:!0,minRows:2,maxRows:6,sx:{mt:1}})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Terms",value:ve,onChange:Y=>de(Y.target.value),fullWidth:!0,multiline:!0,minRows:3,maxRows:8,sx:{mt:1},placeholder:"Enter payment/delivery terms, etc."})})]})}),e.jsxs(k,{sx:{position:"relative",zIndex:1e3,transform:Cr?`translateY(-${Cr}px)`:"none",transition:"transform 200ms ease"},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"Line Items"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Each part number can only appear once. Edit existing line items to change quantities."})]}),e.jsxs(k,{sx:{position:"relative",mb:3},children:[!r&&Lr.length>0&&e.jsx(k,{sx:{position:"absolute",bottom:"calc(100% + 8px)",left:0,right:0,zIndex:500,display:"flex",flexDirection:"column",gap:1,pointerEvents:"none"},children:Lr.map((Y,$)=>e.jsx(Fe,{severity:"warning",sx:{width:"100%",boxShadow:2,pointerEvents:"auto","& .MuiAlert-message":{width:"100%",padding:0}},children:e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",sx:{width:"100%"},children:[e.jsxs(k,{children:[e.jsxs(h,{variant:"body2",fontWeight:"medium",children:["Insufficient stock for ",Y.partNumber]}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Excess quantity: ",Y.excessQuantity," ",Y.unit]})]}),e.jsxs(Q,{variant:"contained",size:"small",sx:{whiteSpace:"nowrap"},onClick:()=>pr(Y),children:["Transfer ",Y.excessQuantity," to Parts to Order"]})]})},`${Y.lineItemIndex}-${$}`))}),e.jsxs(mt,{open:!!qr,onClose:()=>pr(null),maxWidth:"xs",fullWidth:!0,children:[e.jsx(ft,{children:"Transfer to Parts to Order"}),e.jsx(xt,{children:qr&&e.jsxs(h,{variant:"body2",children:["Transfer ",qr.excessQuantity," ",qr.unit," of ",qr.partNumber," to Parts to Order?"]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>pr(null),children:"Cancel"}),e.jsx(Q,{variant:"contained",onClick:()=>{if(!qr)return;const Y=qr,$=Ne[Y.lineItemIndex],ae=Y.excessQuantity,oe=p.find(Ge=>Ge.part_number.toLowerCase()===$.part_number.toLowerCase()),be={sales_order_id:We?.sales_order_id||0,part_number:$.part_number,part_description:$.part_description,quantity_to_order:String(ae),unit:$.unit,unit_price:oe?.last_unit_cost||0,line_amount:(oe?.last_unit_cost||0)*ae};fe(Ge=>[...Ge,be]);const Oe=Math.max(0,(parseFloat(String($.quantity).replace(/[^\d.-]/g,""))||0)-ae);tt(Ge=>Ge.map((Re,Pt)=>Pt===Y.lineItemIndex?{...Re,quantity:String(Oe)}:Re)),Fn(Ge=>Ge.filter(Re=>Re.lineItemIndex!==Y.lineItemIndex)),pr(null),z.success(`Transferred ${ae} ${$.unit} of ${$.part_number} to parts to order`)},children:"Confirm"})]})]}),e.jsxs(Me,{sx:{p:3,mb:3},elevation:3,children:[e.jsx(O,{container:!0,spacing:2,children:Ne.map((Y,$)=>({item:Y,originalIndex:$})).sort((Y,$)=>{const ae=["LABOUR","OVERHEAD","SUPPLY"].includes(Y.item.part_number),oe=["LABOUR","OVERHEAD","SUPPLY"].includes($.item.part_number);return ae&&!oe?1:!ae&&oe?-1:0}).map(({item:Y,originalIndex:$})=>e.jsxs(Dt.Fragment,{children:[e.jsx(O,{item:!0,xs:12,sm:6,md:2.5,children:e.jsx(zr,{open:wr===$,onOpen:()=>Yt($),onClose:()=>Yt(null),autoHighlight:!0,inputValue:Y.part_number,onChange:(ae,oe)=>{if(typeof oe=="string"){const be=Ne.findIndex((Oe,Ge)=>Ge!==$&&Oe.part_number.trim().toLowerCase()===oe.trim().toLowerCase());if(be!==-1){z.error(`Part "${oe}" already exists as line item ${be+1}. Edit that line item instead.`),tt(Oe=>Oe.map((Ge,Re)=>Re===$?{...Ge,part_number:"",part_description:""}:Ge)),Yt(null);return}gs($,oe),Yt(null)}else if(oe&&typeof oe=="object"&&"isNew"in oe){const be=oe.inputValue||"";Fr(String(be).toUpperCase()),ur($),ct(!0),Yt(null)}},onInputChange:(ae,oe,be)=>{if(be==="reset")return;const Oe=(oe||"").trim();if(tt(Ge=>Ge.map((Re,Pt)=>Pt===$?{...Re,part_number:Oe}:Re)),sn&&window.clearTimeout(sn),Oe.length>0){const Ge=window.setTimeout(()=>Yt($),200);pn(Ge)}else Yt(null)},options:p.filter(ae=>ae.part_type!=="supply").map(ae=>ae.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,handleHomeEndKeys:!0,filterOptions:(ae,oe)=>{const be=(oe.inputValue||"").toUpperCase(),Oe=ae.filter(Pt=>{const $t=p.find(rr=>rr.part_number===Pt);return $t?String(Pt).toUpperCase().includes(be)||String($t.part_description||"").toUpperCase().includes(be):String(Pt).toUpperCase().includes(be)}),Ge=Oe.some(Pt=>String(Pt).toUpperCase()===be),Re=[...Oe];return be&&!Ge&&Re.push({label:`Add "${oe.inputValue}" as New Part`,isNew:!0,inputValue:oe.inputValue}),Re},renderOption:(ae,oe)=>{const be=typeof oe=="object"&&oe.isNew,Oe=typeof oe=="string"?oe:oe.label,{key:Ge,...Re}=ae;return e.jsxs("li",{...Re,children:[be&&e.jsx(Mn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof oe=="string"?e.jsxs(k,{children:[e.jsx(h,{variant:"body2",children:oe}),(()=>{const Pt=p.find($t=>$t.part_number===oe);return Pt?.part_description?e.jsx(h,{variant:"caption",color:"text.secondary",children:Pt.part_description}):null})()]}):Oe]},Ge)},renderInput:ae=>e.jsx(le,{...ae,label:"Part Number",required:!0,fullWidth:!0,onKeyDown:oe=>wn($,oe),onBlur:()=>Yt(null)}),onBlur:()=>{const ae=Ne[$]?.part_number?.trim().toUpperCase();if(!ae)return;p.find(be=>be.part_number===ae)?gs($,ae):(ur($),Fr(ae),ct(!0),Yt(null))}})}),e.jsx(O,{item:!0,xs:12,sm:6,md:2.5,children:e.jsx(le,{label:"Part Description",value:Y.part_description,fullWidth:!0,required:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Qty",value:Y.quantity,onChange:ae=>ho($,"quantity",ae.target.value),type:"number",fullWidth:!0,required:!0,InputProps:{readOnly:["SUPPLY","LABOUR","OVERHEAD"].includes(Y.part_number),disabled:["SUPPLY","LABOUR","OVERHEAD"].includes(Y.part_number)},inputProps:{step:1,onWheel:ae=>ae.target.blur()}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Avail",value:(()=>{const ae=Vn[$];return ae?ae.available<0?`${ae.available} (Insufficient)`:String(ae.available):"N/A"})(),fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:(()=>{const ae=Vn[$];return ae?ae.available>=0?"#e8f5e8":"#ffeaea":"#f5f5f5"})(),"& .MuiInputBase-input":{color:Vn[$]?.isNegative?"#d32f2f":"#2e7d32"}}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Unit",value:Y.part_number==="SUPPLY"?"":Y.unit,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(O,{item:!0,xs:12,sm:2,md:1.5,children:e.jsx(le,{label:"Unit Cost",value:Y.part_number==="LABOUR"?v??0:Y.part_number==="OVERHEAD"?b??0:Y.part_number==="SUPPLY"?"":Y.unit_price,type:"number",fullWidth:!0,InputProps:{readOnly:!0,startAdornment:Y.part_number!=="SUPPLY"?e.jsx(mr,{position:"start",children:"$"}):void 0,disabled:["LABOUR","OVERHEAD","SUPPLY"].includes(Y.part_number)}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Amount",value:Y.line_amount!=null&&!isNaN(Number(Y.line_amount))?Number(Y.line_amount).toFixed(2):"0.00",InputProps:{readOnly:!0},fullWidth:!0})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1,sx:{display:"flex",alignItems:"center"},children:e.jsx(Q,{variant:"outlined",color:"primary",onClick:()=>Pi($),fullWidth:!0,children:"Remove"})})]},$))}),e.jsx(k,{sx:{mt:2},children:e.jsx(Q,{variant:"outlined",color:"primary",onClick:ki,children:"Add Line Item"})})]})]}),e.jsx(Me,{sx:{p:3,mb:3},elevation:3,children:e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsxs(h,{variant:"subtitle1",children:["Subtotal: ",Or(wt)]})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsxs(h,{variant:"subtitle1",children:["Total GST: ",Or(zt)]})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsxs(h,{variant:"h6",children:["Total Amount: ",Or(Bt)]})})]})}),!r&&e.jsxs(Me,{sx:{p:3,mb:3,elevation:3,border:"2px solid #b8860b","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"#b8860b"},"&:hover fieldset":{borderColor:"#b8860b"}}},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Parts to Order"}),e.jsx(h,{variant:"body2",color:"textSecondary",sx:{mb:2},children:"Add parts that need to be ordered for this sales order. These quantities are aggregated across all sales orders."}),e.jsx(O,{container:!0,spacing:2,children:we.map((Y,$)=>e.jsxs(Dt.Fragment,{children:[e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(zr,{open:Ur===$,onOpen:()=>vr($),onClose:()=>vr(null),autoHighlight:!0,value:Y.part_number,onChange:(ae,oe)=>{if(!oe){fe(be=>{const Oe=[...be];return Oe[$]={...Oe[$],part_number:"",part_description:"",unit:"Each",unit_price:0,line_amount:0},Oe});return}if(typeof oe=="string"){const be=p.find(Oe=>Oe.part_number===oe);if(be){const Oe=parseFloat(String(be.last_unit_cost))||0,Ge=Zr(Oe),Re=Oe*Ge;fe(Pt=>{const $t=[...Pt];return $t[$]={...$t[$],part_number:be.part_number,part_description:be.part_description,unit:be.unit||"Each",unit_price:Re,line_amount:0},$t})}else{fe(Ge=>{const Re=[...Ge];return Re[$]={...Re[$],part_number:oe,part_description:"",unit:"Each",unit_price:0,line_amount:0},Re});const Oe=String(oe).toUpperCase();Gr($),Wr(Oe),Sr(!0)}}else if(oe&&typeof oe=="object"&&"isNew"in oe){const be=String(oe.inputValue||"").toUpperCase();Gr($),Wr(be),Sr(!0)}},onInputChange:(ae,oe,be)=>{if(fe(Ge=>{const Re=[...Ge];return Re[$]={...Re[$],part_number:(oe||"").toUpperCase()},Re}),sn&&window.clearTimeout(sn),be==="reset")return;if((oe||"").trim().length>0){const Ge=window.setTimeout(()=>vr($),200);pn(Ge)}else vr(null)},options:p.filter(ae=>ae.part_type!=="supply").map(ae=>ae.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,filterOptions:(ae,oe)=>{const be=(oe.inputValue||"").toUpperCase(),Oe=ae.filter(Pt=>{const $t=p.find(rr=>rr.part_number===Pt);return $t?String(Pt).toUpperCase().includes(be)||String($t.part_description||"").toUpperCase().includes(be):String(Pt).toUpperCase().includes(be)}),Ge=Oe.some(Pt=>String(Pt).toUpperCase()===be),Re=[...Oe];return be&&!Ge&&Re.push({label:`Add "${oe.inputValue}" as New Part`,isNew:!0,inputValue:oe.inputValue}),Re},renderOption:(ae,oe)=>{const be=typeof oe=="object"&&oe.isNew,Oe=typeof oe=="string"?oe:oe.label,{key:Ge,...Re}=ae;return e.jsxs("li",{...Re,children:[be&&e.jsx(Mn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof oe=="string"?e.jsxs(k,{children:[e.jsx(h,{variant:"body2",children:oe}),(()=>{const Pt=p.find($t=>$t.part_number===oe);return Pt?.part_description?e.jsx(h,{variant:"caption",color:"text.secondary",children:Pt.part_description}):null})()]}):Oe]},Ge)},renderInput:ae=>e.jsx(le,{...ae,label:"Part Number",fullWidth:!0,required:!0,onKeyDown:oe=>cs($,oe),onBlur:()=>vr(null)}),onBlur:()=>{const ae=(we[$]?.part_number||"").trim().toUpperCase();if(!ae)return;p.find(be=>be.part_number===ae)||(Gr($),Wr(ae),Sr(!0),vr(null))}})}),e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(le,{label:"Description",value:Y.part_description,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#f5f5f5"}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Qty to Order",value:Y.quantity_to_order,onChange:ae=>{const oe=ae.target.value;fe(be=>{const Oe=[...be],Ge=parseFloat(oe)||0,Re=Oe[$].unit_price||0;return Oe[$]={...Oe[$],quantity_to_order:oe,line_amount:Ge*Re},Oe})},type:"number",fullWidth:!0,required:!0,inputProps:{step:1,min:0,onWheel:ae=>ae.target.blur()}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Unit",value:Y.unit,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(O,{item:!0,xs:12,sm:1.5,children:e.jsx(le,{label:"Unit Price",value:Y.unit_price,type:"number",fullWidth:!0,InputProps:{readOnly:!0,startAdornment:e.jsx(mr,{position:"start",children:"$"})},sx:{backgroundColor:"#f5f5f5"}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Amount",value:Y.line_amount,InputProps:{readOnly:!0},fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,sm:1,md:1,sx:{display:"flex",alignItems:"center",gap:2},children:e.jsx(Q,{variant:"outlined",onClick:()=>fe(ae=>ae.filter((oe,be)=>be!==$)),sx:{flexShrink:0,borderColor:"#b8860b",color:"#b8860b","&:hover":{borderColor:"#8b6914",backgroundColor:"#fff8dc"}},children:"Remove"})})]},$))}),e.jsx(k,{sx:{mt:2},children:e.jsx(Q,{variant:"outlined",color:"primary",onClick:()=>fe(Y=>[...Y,{sales_order_id:Number(t)||0,part_number:"",part_description:"",quantity_to_order:"",unit:"Each",unit_price:0,line_amount:0}]),children:"Add Parts to Order Item"})})]}),e.jsx(xi,{open:ds,onClose:()=>hn(!1),onSave:async Y=>{try{const $=await B.post("/api/customers",Y),ae={label:Y.customer_name,id:$.data.customer_id};c(oe=>[...oe,ae]),A(ae),hn(!1),z.success("Customer added successfully!")}catch{z.error("Failed to add customer.")}},initialCustomer:{customer_name:zn},isEditMode:!1}),e.jsx(Yl,{open:$s,onClose:()=>Bn(!1),onSave:async Y=>{try{const $=await B.post("/api/products",Y),ae={label:Y.product_name,id:$.data.product_id,description:Y.product_name};d(oe=>[...oe,ae]),te(ae),S(ae.label),Bn(!1),Hn(""),z.success("Product added successfully!")}catch{z.error("Failed to add product.")}},initialProduct:{product_name:us||re},isEditMode:!1}),!r&&e.jsxs(e.Fragment,{children:[xs&&e.jsx(Fe,{severity:"error",sx:{mb:2},onClose:()=>Cn(null),children:xs}),e.jsx(vn,{open:!!_e,autoHideDuration:6e3,onClose:()=>ye(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Fe,{onClose:()=>ye(null),severity:"success",sx:{width:"100%"},children:_e})}),!We?.exported_to_qbo&&We?.status?.toLowerCase()==="closed"&&e.jsxs(k,{display:"flex",justifyContent:"flex-end",gap:2,mb:2,children:[e.jsx(Q,{variant:"contained",color:"success",startIcon:e.jsx(so,{}),disabled:Yn,onClick:he,children:Yn?"Exporting...":"Export to QuickBooks"}),s?.access_role!=="Sales and Purchase"&&e.jsx(Q,{variant:"outlined",onClick:J,children:"Reopen SO"})]})]})]}),e.jsx(ns,{open:rt,onClose:()=>{ct(!1),ur(null),Fr("")},onSave:async Y=>{const $=await B.post("/api/inventory",Y),ae=await B.get("/api/inventory");m(ae.data);const oe=$.data.item;Vt!==null&&tt(be=>{const Oe=[...be],Ge=parseFloat(String(oe.last_unit_cost))||0,Re=Zr(Ge),Pt=Ge*Re;return Oe[Vt]={...Oe[Vt],part_number:oe.part_number,part_description:oe.part_description,unit:oe.unit||Oe[Vt].unit,unit_price:Pt},Oe})},title:"Add New Part",initialPart:{part_number:Dr.toUpperCase(),category:"Uncategorized"}}),e.jsx(ns,{open:Tr,onClose:()=>{Sr(!1),Gr(null),Wr("")},onSave:async Y=>{const $=await B.post("/api/inventory",Y),ae=await B.get("/api/inventory");m(ae.data);const oe=$.data.item;Vr!==null&&fe(be=>{const Oe=[...be],Ge=parseFloat(String(oe.last_unit_cost))||0,Re=Zr(Ge),Pt=Ge*Re;return Oe[Vr]={...Oe[Vr],part_number:oe.part_number,part_description:oe.part_description,unit:oe.unit||"Each",unit_price:Pt},Oe})},title:"Add New Part",initialPart:{part_number:Xr.toUpperCase(),category:"Uncategorized"}})]})},Gd=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(!0),[s,o]=l.useState(""),[i,c]=l.useState("open"),[u,d]=l.useState({page:0,pageSize:10}),p=Gt();un();const{user:m}=er(),f=async()=>{a(!0);try{const N=(await B.get("/api/purchase-history",{params:{status:i,searchTerm:s||void 0}})).data.sort((j,E)=>{const A=y=>{const x=y.match(/\d+/);return x?parseInt(x[0],10):0},C=A(j.purchase_number);return A(E.purchase_number)-C});r(N)}catch(P){console.error("Error fetching purchase orders:",P),r([]),z.error("Failed to fetch purchase orders")}finally{a(!1)}};l.useEffect(()=>{f()},[i,s]);const _=P=>{window.confirm("Are you sure you want to delete this purchase order?")&&v(P)},v=async P=>{try{await B.delete(`/api/purchase-orders/${P}`),z.success("Purchase order deleted successfully"),f()}catch(N){console.error("Error deleting purchase order:",N),z.error("Failed to delete purchase order")}},w=()=>{let P=t;i==="open"?P=t.filter(A=>A.status==="Open"):i==="closed"&&(P=t.filter(A=>A.status==="Closed"));const N=Un.unparse(P),j=new Blob([N],{type:"text/csv;charset=utf-8;"}),E=document.createElement("a");E.href=URL.createObjectURL(j),E.download=`purchase_orders_${et().format("YYYY-MM-DD")}.csv`,E.click()},b=[{field:"purchase_number",headerName:"Purchase #",flex:1,minWidth:120,valueFormatter:P=>P.value?String(P.value).replace("PO-",""):""},{field:"vendor_name",headerName:"Vendor",flex:1.3,minWidth:150},{field:"created_at",headerName:"Created On",flex:.9,minWidth:130,valueFormatter:P=>P.value?new Date(P.value).toLocaleDateString():""},{field:"bill_number",headerName:"Bill #",flex:.9,minWidth:100},{field:"subtotal",headerName:"Subtotal",flex:.8,minWidth:100,valueFormatter:P=>P.value!=null&&!isNaN(Number(P.value))?`$${Number(P.value).toFixed(2)}`:"$0.00"},{field:"gst_rate",headerName:"GST Rate (%)",flex:.7,minWidth:80,valueFormatter:P=>P.value!=null&&!isNaN(Number(P.value))?`${Number(P.value).toFixed(2)}%`:"5.00%"},{field:"total_gst_amount",headerName:"GST",flex:.7,minWidth:80,valueFormatter:P=>P.value!=null&&!isNaN(Number(P.value))?`$${Number(P.value).toFixed(2)}`:"$0.00"},{field:"total_amount",headerName:"Total",flex:.8,minWidth:100,valueFormatter:P=>P.value!=null&&!isNaN(Number(P.value))?`$${Number(P.value).toFixed(2)}`:"$0.00"},{field:"status",headerName:"Status",flex:.8,minWidth:100,renderCell:P=>e.jsx(De,{label:P.value,color:P.value==="Open"?"success":"error",size:"small",variant:"outlined"})},{field:"return_summary",headerName:"Returns",flex:.9,minWidth:150,sortable:!1,renderCell:P=>{const N=P.row.return_requested_count??0,j=P.row.return_returned_count??0;return!N&&!j?e.jsx(h,{variant:"body2",color:"text.secondary",children:"None"}):e.jsxs(Pe,{direction:"row",spacing:1,children:[N>0&&e.jsx(De,{label:`Requested ${N}`,color:"warning",size:"small",variant:"outlined"}),j>0&&e.jsx(De,{label:`Returned ${j}`,color:"success",size:"small",variant:"outlined"})]})}},{field:"qbo_exported",headerName:"QBO Exported",flex:.8,minWidth:120,renderCell:P=>P.row.exported_to_qbo?e.jsx(Ln,{color:"success",titleAccess:"Exported to QuickBooks"}):P.row.qbo_export_status?e.jsx(wi,{color:"error",titleAccess:`QBO Export Error: ${P.row.qbo_export_status}`}):P.row.status==="Closed"?e.jsx(Wl,{color:"warning",titleAccess:"Not exported to QuickBooks"}):null},{field:"actions",headerName:"Actions",width:100,sortable:!1,renderCell:P=>e.jsx(k,{sx:{display:"flex",gap:.5},children:P.row.status!=="Closed"&&e.jsx(gt,{size:"small",color:"error",onClick:N=>{N.stopPropagation(),_(P.row.purchase_id)},children:e.jsx(xr,{})})})}];return e.jsx(nt,{maxWidth:"xl",sx:{mt:4},children:e.jsxs(k,{sx:{mb:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:i==="open"?"Open Purchase Orders":i==="closed"?"Purchase Order History":"All Purchase Orders"}),e.jsxs(Pe,{direction:"row",spacing:2,sx:{mb:2,justifyContent:"flex-end"},children:[e.jsx(Q,{variant:"contained",startIcon:e.jsx(Nr,{}),onClick:()=>p("/open-purchase-orders/new"),children:"New PO"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(gr,{}),onClick:w,children:"Export CSV"})]}),e.jsx(Me,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsxs(Pe,{direction:"row",spacing:3,sx:{mb:3},children:[e.jsx(le,{label:"Search",variant:"outlined",value:s,onChange:P=>o(P.target.value),InputProps:{startAdornment:e.jsx(mr,{position:"start",children:e.jsx(Hr,{sx:{fontSize:32}})}),sx:{fontSize:22,height:56}},sx:{minWidth:340,maxWidth:400,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"medium"}),e.jsx(De,{label:"All",onClick:()=>c("all"),color:i==="all"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),e.jsx(De,{label:"Open",onClick:()=>c("open"),color:i==="open"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),e.jsx(De,{label:"Closed",onClick:()=>c("closed"),color:i==="closed"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}})]}),e.jsx(tn,{rows:t,columns:b,loading:n,paginationModel:u,onPaginationModelChange:d,pageSizeOptions:[10,25,50],getRowId:P=>P.purchase_id,disableRowSelectionOnClick:!0,initialState:{sorting:{sortModel:[{field:"purchase_number",sort:"desc"}]}},onRowClick:P=>{const N=P.row.status?.toLowerCase();p(N==="closed"?`/purchase-order/${P.row.purchase_id}`:`/open-purchase-orders/${P.row.purchase_id}`)},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"},cursor:"pointer"}})]})})]})})},aw=async t=>{const r=new FormData;return r.append("document",t),(await B.post("/api/purchase-orders/ocr/upload",r,{headers:{"Content-Type":"multipart/form-data"}})).data};var Aa={},Qd;function ow(){if(Qd)return Aa;Qd=1;var t=vt();Object.defineProperty(Aa,"__esModule",{value:!0}),Aa.default=void 0;var r=t(_t()),n=bt();return Aa.default=(0,r.default)((0,n.jsx)("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),Aa}var iw=ow();const lw=st(iw);var Ma={},Kd;function cw(){if(Kd)return Ma;Kd=1;var t=vt();Object.defineProperty(Ma,"__esModule",{value:!0}),Ma.default=void 0;var r=t(_t()),n=bt();return Ma.default=(0,r.default)((0,n.jsx)("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess"),Ma}var dw=cw();const uw=st(dw),pw=({open:t,onClose:r,purchaseOrderId:n,onSuccess:a,onAllocationSaved:s})=>{const[o,i]=l.useState(!1),[c,u]=l.useState(!1),[d,p]=l.useState(null),[m,f]=l.useState({}),[_,v]=l.useState({}),[w,b]=l.useState({}),[P,N]=l.useState(new Set),[j,E]=l.useState(new Set),[A,C]=l.useState(""),[L,y]=l.useState([]);l.useEffect(()=>{t&&n&&(p(null),f({}),v({}),b({}),N(new Set),y([]),E(new Set),C(""),x())},[t,n]);const x=async()=>{i(!0);try{const K=(await B.get(`/api/purchase-history/${n}/allocation-suggestions`)).data;console.log("Allocation suggestions data:",K),console.log("Number of suggestions:",K.suggestions?.length),K.suggestions?.forEach((ge,pe)=>{console.log(`Suggestion ${pe}: ${ge.part_number} - ${ge.allocation_suggestions?.length} sales orders`),ge.allocation_suggestions?.forEach((se,I)=>{console.log(`  Allocation ${I}: SO ${se.sales_order_number}, current_quantity_needed: ${se.current_quantity_needed}, is_needed: ${se.is_needed}`)})});const F=new Set,xe=[];for(const ge of K.suggestions||[])try{console.log(`Checking part type for: ${ge.part_number}`);const pe=await hb(ge.part_number);console.log(`Part info for ${ge.part_number}:`,pe),pe.part_type==="supply"?(F.add(ge.part_number),console.log(`Filtering out supply part: ${ge.part_number}`)):(console.log(`Including stock part: ${ge.part_number} (type: ${pe.part_type})`),xe.push(ge))}catch(pe){console.warn(`Could not determine part type for ${ge.part_number}, including it:`,pe),xe.push(ge)}N(F),console.log(`Filtering summary: ${F.size} supply parts filtered out, ${xe.length} stock parts remaining`),console.log("Supply parts filtered:",Array.from(F)),console.log("Stock parts included:",xe.map(ge=>ge.part_number));const ve={...K,suggestions:xe};p(ve);let de={},me={};try{const pe=(await B.get(`/api/purchase-history/${n}/allocations`)).data||[],se={};for(const I of pe){const W=String(I.part_number).toUpperCase();se[W]||(se[W]={}),se[W][I.sales_order_id]=Number(I.allocate_qty)||0}de={},me={},xe.forEach(I=>{const W=I.part_number,ce=se[W]||{},Z={};I.allocation_suggestions.forEach(Ce=>{const ze=ce[Ce.sales_order_id];Z[Ce.sales_order_id]=typeof ze=="number"?ze:Ce.suggested_alloc}),de[W]=Z;const Ae=Object.values(Z).reduce((Ce,ze)=>Ce+(Number(ze)||0),0);me[W]=Math.max(0,I.quantity_ordered-Ae)})}catch{de={},me={},xe.forEach(pe=>{de[pe.part_number]={},pe.allocation_suggestions.forEach(I=>{de[pe.part_number][I.sales_order_id]=I.suggested_alloc});const se=Object.values(de[pe.part_number]).reduce((I,W)=>I+(Number(W)||0),0);me[pe.part_number]=Math.max(0,pe.quantity_ordered-se)})}f(de),v(me),E(new Set),y([])}catch(R){console.error("Error fetching allocation suggestions:",R),z.error("Failed to load allocation suggestions")}finally{i(!1)}},D=(R,K,F)=>{if(!d)return{valid:!0};const xe=d.suggestions.find(ce=>ce.part_number===R);if(!xe)return{valid:!0};const ve=xe.allocation_suggestions.find(ce=>ce.sales_order_id===K);if(!ve)return{valid:!0};const de=ve.current_quantity_needed,me=xe.quantity_ordered,ge=xe.allocation_suggestions.filter(ce=>ce.is_needed).reduce((ce,Z)=>ce+Z.current_quantity_needed,0),pe=me>=ge,se=T(R),I=m[R]?.[K]||0,W=me-(se-I);return F>W?{valid:!1,message:`Cannot allocate more than ${W} units (exceeds ordered quantity)`}:pe&&ve.is_needed&&F<de?{valid:!1,message:`Cannot allocate less than ${de} units when surplus exists`}:!pe&&ve.is_needed&&F<de?{valid:!0,warning:`Allocating ${F} units but ${de} units are needed for quantity to order`}:{valid:!0}},M=(R,K,F)=>{const xe=Math.max(0,F),ve=D(R,K,xe);if(!ve.valid){z.error(ve.message);return}ve.warning&&z.warning(ve.warning),f(de=>{const me={...de,[R]:{...de[R],[K]:xe}};if(d){const ge=d.suggestions.find(pe=>pe.part_number===R);if(ge){const pe=me[R]||{},se=Object.values(pe).reduce((W,ce)=>W+ce,0),I=Math.max(0,ge.quantity_ordered-se);v(W=>({...W,[R]:I}))}}return me})},X=R=>{if(!d)return;const K=d.suggestions.find(pe=>pe.part_number===R);if(!K)return;const F=K.quantity_ordered,xe=K.allocation_suggestions.filter(pe=>pe.is_needed).reduce((pe,se)=>pe+se.current_quantity_needed,0),ve=F>=xe,de=K.allocation_suggestions.filter(pe=>pe.is_needed).sort((pe,se)=>pe.sales_order_number.localeCompare(se.sales_order_number)),me={};let ge=F;if(ve){for(const pe of de){const se=pe.current_quantity_needed,I=Math.min(se,ge);I>0&&(me[pe.sales_order_id]=I,ge-=I)}if(ge>0)for(const pe of K.allocation_suggestions){if(ge<=0)break;const se=me[pe.sales_order_id]||0,I=Math.min(ge,1);me[pe.sales_order_id]=se+I,ge-=I}}else for(const pe of de){if(ge<=0)break;const se=pe.current_quantity_needed,I=Math.min(se,ge);I>0&&(me[pe.sales_order_id]=I,ge-=I)}f(pe=>({...pe,[R]:me})),v(pe=>({...pe,[R]:ge}))},H=()=>{d&&d.suggestions.forEach(R=>{X(R.part_number)})},U=(R,K)=>{E(F=>{const xe=new Set(F);return K?xe.add(R):xe.delete(R),xe})},G=R=>{if(!d){E(new Set);return}E(R?new Set(d.suggestions.map(K=>K.part_number)):new Set)},te=l.useMemo(()=>{if(!d)return[];const R=new Map;return d.suggestions.forEach(K=>{K.allocation_suggestions.forEach(F=>{R.has(F.sales_order_id)||R.set(F.sales_order_id,{id:F.sales_order_id,label:F.sales_order_number,customer:F.customer_name})})}),Array.from(R.values()).sort((K,F)=>K.label.localeCompare(F.label))},[d]),re=()=>{if(!d)return;const R=Array.from(j);if(R.length===0){z.error("Select at least one part to allocate.");return}if(A===""){z.error("Select a sales order to allocate the selected parts.");return}const K={...m},F={..._};R.forEach(xe=>{const ve=d.suggestions.find(ge=>ge.part_number===xe);if(!ve)return;const de={};ve.allocation_suggestions.forEach(ge=>{de[ge.sales_order_id]=ge.sales_order_id===A?ve.quantity_ordered:0}),K[xe]=de;const me=Object.values(de).reduce((ge,pe)=>ge+(Number(pe)||0),0);F[xe]=Math.max(0,ve.quantity_ordered-me)}),f(K),v(F),z.success("Selected parts allocated to the chosen sales order.")},S=()=>{const R=[];return d?(d.suggestions.forEach(K=>{const F=K.part_number,xe=K.quantity_ordered,ve=m[F]||{},de=Object.values(ve).reduce((pe,se)=>pe+se,0);de>xe&&R.push(`Total allocation (${de}) exceeds ordered quantity (${xe}) for part ${F}`);const me=K.allocation_suggestions.filter(pe=>pe.is_needed).reduce((pe,se)=>pe+se.current_quantity_needed,0);if(xe>=me){for(const pe of K.allocation_suggestions)if(pe.is_needed){const se=ve[pe.sales_order_id]||0,I=pe.current_quantity_needed;se<I&&R.push(`Sales order ${pe.sales_order_number} must receive at least ${I} units when surplus exists`)}}}),y(R),R.length===0):!1},g=async()=>{if(S()){u(!0);try{const R=[];for(const[F,xe]of Object.entries(m))for(const[ve,de]of Object.entries(xe))de>0&&R.push({sales_order_id:parseInt(ve),part_number:F,allocate_qty:de});const K=await B.post(`/api/purchase-history/${n}/save-allocations`,{allocations:R,surplusPerPart:_});z.success("Allocations saved successfully"),s&&s(),r()}catch(R){console.error("Error saving allocations:",R);const K=R.response?.data?.error||"Failed to save allocations";z.error(K)}finally{u(!1)}}},T=R=>{const K=m[R]||{};return Object.values(K).reduce((F,xe)=>F+xe,0)},q=R=>{if(!d)return 0;const K=d.suggestions.find(xe=>xe.part_number===R);if(!K)return 0;const F=T(R);return K.quantity_ordered-F},ee=R=>{b(K=>({...K,[R]:!K[R]}))};return o?e.jsxs(mt,{open:t,onClose:r,maxWidth:"lg",fullWidth:!0,children:[e.jsx(ft,{children:"Loading Allocation Suggestions..."}),e.jsx(xt,{children:e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"200px",children:e.jsx(ot,{})})})]}):e.jsxs(mt,{open:t,onClose:r,maxWidth:"lg",fullWidth:!0,children:[e.jsxs(ft,{children:["Allocate Purchase Order: ",d?.purchase_order_number]}),e.jsxs(xt,{children:[d&&d.suggestions.length>0&&e.jsxs(Me,{sx:{mb:3,p:2,backgroundColor:"grey.50"},children:[e.jsxs(h,{variant:"h6",gutterBottom:!0,children:["Purchase Order Summary (",d.suggestions.length," parts)"]}),e.jsx(k,{display:"flex",flexWrap:"wrap",gap:1,children:d.suggestions.map((R,K)=>e.jsx(De,{label:`${R.part_number}: ${R.quantity_ordered} ordered`,color:"primary",variant:"outlined",size:"small"},`${R.part_number}-${K}`))})]}),P.size>0&&e.jsxs(Fe,{severity:"info",sx:{mb:2},children:[e.jsxs(h,{variant:"body2",children:[e.jsx("strong",{children:"Note:"})," ",P.size," supply part",P.size>1?"s":""," ",P.size>1?"have":"has"," been filtered out from allocation. Supply parts are not tracked for inventory allocation."]}),e.jsx(k,{mt:1,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Filtered parts: ",Array.from(P).join(", ")]})})]}),L.length>0&&e.jsxs(Fe,{severity:"error",sx:{mb:2},children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:"Please correct the following errors:"}),L.map((R,K)=>e.jsxs(h,{variant:"body2",children:[" ",R]},K))]}),d&&d.suggestions.length>0&&e.jsx(Me,{sx:{mb:3,p:2},variant:"outlined",children:e.jsxs(Pe,{direction:{xs:"column",md:"row"},spacing:2,alignItems:{xs:"flex-start",md:"center"},children:[e.jsxs(k,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(yn,{control:e.jsx(gn,{checked:j.size===d.suggestions.length&&d.suggestions.length>0,indeterminate:j.size>0&&j.size<d.suggestions.length,onChange:R=>G(R.target.checked)}),label:"Select all parts"}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:[j.size," selected"]})]}),e.jsxs(Mt,{size:"small",sx:{minWidth:220},children:[e.jsx(qt,{id:"bulk-sales-order-label",children:"Sales Order"}),e.jsxs(Ut,{labelId:"bulk-sales-order-label",label:"Sales Order",value:A,onChange:R=>C(R.target.value),displayEmpty:!0,children:[e.jsx(Ze,{value:"",children:e.jsx("em",{children:"Select sales order"})}),te.map(R=>e.jsxs(Ze,{value:R.id,children:[R.label,"  ",R.customer]},R.id))]})]}),e.jsx(Q,{variant:"contained",onClick:re,disabled:j.size===0||A==="",children:"Allocate selected parts to sales order"})]})}),d?.suggestions.length===0?e.jsx(Fe,{severity:"info",sx:{mb:2},children:e.jsx(h,{variant:"body1",children:"No parts found in this purchase order to allocate."})}):d?.suggestions.map((R,K)=>e.jsxs(Me,{sx:{mb:2,p:2},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(k,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(gn,{checked:j.has(R.part_number),onChange:F=>U(R.part_number,F.target.checked),inputProps:{"aria-label":`Select part ${R.part_number}`}}),e.jsx(gt,{size:"small",onClick:()=>ee(R.part_number),sx:{p:.5},children:w[R.part_number]?e.jsx(uw,{}):e.jsx(lw,{})}),e.jsxs(h,{variant:"h6",children:[R.part_number," - ",R.part_description]})]}),e.jsxs(k,{display:"flex",gap:1,alignItems:"center",children:[e.jsx(De,{label:`Ordered: ${R.quantity_ordered}`,color:"primary",variant:"outlined",size:"small"}),e.jsx(De,{label:`Total Needed: ${R.total_needed}`,color:"secondary",variant:"outlined",size:"small"}),e.jsx(De,{label:`Remaining: ${q(R.part_number)}`,color:q(R.part_number)<0?"error":"default",variant:"outlined",size:"small"}),e.jsx(Q,{variant:"outlined",size:"small",onClick:()=>X(R.part_number),children:"Auto Allocate (FIFO)"})]})]}),e.jsx(Lu,{in:w[R.part_number],children:e.jsx(k,{mt:2,children:e.jsx(dr,{children:e.jsxs(ir,{size:"small",children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Sales Order"}),e.jsx(ne,{children:"Customer"}),e.jsx(ne,{children:"Date"}),e.jsx(ne,{align:"right",children:"Quantity to Order"}),e.jsx(ne,{align:"right",children:"Allocate Qty"}),e.jsx(ne,{children:"Status"})]})}),e.jsx(cr,{children:R.allocation_suggestions.map(F=>(console.log(`Rendering allocation for SO ${F.sales_order_number}: current_quantity_needed = ${F.current_quantity_needed}, is_needed = ${F.is_needed}`),e.jsxs(ht,{sx:{backgroundColor:F.is_needed?"warning.light":"grey.50","&:hover":{backgroundColor:F.is_needed?"warning.main":"grey.100"},borderLeft:F.is_needed?"4px solid #ff9800":"4px solid transparent"},children:[e.jsx(ne,{children:e.jsx(h,{variant:"body2",fontWeight:"medium",children:F.sales_order_number})}),e.jsx(ne,{children:F.customer_name}),e.jsx(ne,{children:new Date(F.sales_date).toLocaleDateString()}),e.jsx(ne,{align:"right",children:e.jsx(h,{variant:"body2",color:"black",fontWeight:F.is_needed?"bold":"normal",children:F.current_quantity_needed||0})}),e.jsx(ne,{align:"right",children:e.jsx(le,{type:"number",value:m[R.part_number]?.[F.sales_order_id]||0,onChange:xe=>{const ve=parseFloat(xe.target.value)||0;M(R.part_number,F.sales_order_id,ve)},onBlur:xe=>{const ve=parseFloat(xe.target.value)||0,de=T(R.part_number),me=m[R.part_number]?.[F.sales_order_id]||0,ge=R.quantity_ordered-(de-me);ve>ge&&M(R.part_number,F.sales_order_id,ge)},size:"small",sx:{width:80},inputProps:{min:0,step:1,max:R.quantity_ordered}})}),e.jsx(ne,{children:e.jsx(De,{label:F.is_needed?"Needs Part":"No Need",color:F.is_needed?"warning":"default",size:"small",variant:"outlined"})})]},`${R.part_number}-${F.sales_order_id}`)))})]})})})}),e.jsxs(k,{mt:2,display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(h,{variant:"body2",children:["Total Allocated: ",T(R.part_number)]}),e.jsxs(k,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(h,{variant:"body2",children:"Surplus to Stock:"}),e.jsx(le,{type:"number",value:_[R.part_number]||0,disabled:!0,size:"small",sx:{width:80},inputProps:{min:0,step:1}})]})]})]},`${R.part_number}-${K}`))]}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:r,disabled:c,children:"Cancel"}),e.jsx(Q,{onClick:H,variant:"outlined",disabled:c,sx:{mr:"auto"},children:"Auto Allocate All (FIFO)"}),e.jsx(Q,{onClick:g,variant:"contained",disabled:c||L.length>0,children:c?e.jsx(ot,{size:20}):"Save Allocations"})]})]})},Sl=(t,r)=>{const n=parseFloat(String(t))||0,a=parseFloat(String(r))||0;return Math.round(n*a*100)/100},hw=(t,r=5)=>{const n=t.reduce((o,i)=>{const c=Sl(i.quantity,i.unit_cost);return o+c},0),a=n*(r/100),s=n+a;return{subtotal:Math.round(n*100)/100,total_gst_amount:Math.round(a*100)/100,total_amount:Math.round(s*100)/100}},mw=(t,r=!1)=>{const n={};t.part_number?.trim()||(n.part_number="Part Number is required"),t.part_description?.trim()||(n.part_description="Part Description is required");const a=parseFloat(String(t.quantity));if((isNaN(a)||a<=0)&&(n.quantity="Quantity must be greater than 0"),r){const s=parseFloat(String(t.unit_cost));(isNaN(s)||s<=0)&&(n.unit_cost="Unit Cost must be greater than 0")}return n},fw=(t,r,n=!1)=>{const a={};r||(a.vendor="Vendor is required");const s=t.map(i=>mw(i,n));return s.some(i=>Object.keys(i).length>0)&&(a.lineItems=s),a},_s=t=>{const r=parseFloat(String(t));return isNaN(r)?0:r},xn=["Each","cm","ft","kg","pcs","L"],Jd=5,Xd=()=>{const{id:t}=jn(),r=Gt(),{user:n}=er(),a=t==="new";console.log("Is creation mode:",a,"ID:",t);const[s,o]=l.useState(null),[i,c]=l.useState(null),[u,d]=l.useState(et()),[p,m]=l.useState(""),[f,_]=l.useState([]),v=fi(f,300),[w,b]=l.useState([]),[P,N]=l.useState("Open"),[j,E]=l.useState(Jd),[A,C]=l.useState({}),[L,y]=l.useState(0),[x,D]=l.useState([]),[M,X]=l.useState(""),H=l.useRef(null),[U,G]=l.useState(!1),[te,re]=l.useState(null),[S,g]=l.useState(null),[T,q]=l.useState(!1),[ee,R]=l.useState([]),[K,F]=l.useState({}),[xe,ve]=l.useState(null),[de,me]=l.useState(null),[ge,pe]=l.useState(!1),[se,I]=l.useState(null),W=l.useRef(null),[ce,Z]=l.useState(!0),[Ae,Ce]=l.useState(!1),[ze,Ve]=l.useState(null),[ut,it]=l.useState(""),[pt,Ne]=l.useState(void 0),[tt,Be]=l.useState("manual"),[wt,zt]=l.useState([]),[Bt,We]=l.useState(null),[Qt,Kt]=l.useState(null),[Wt,tr]=l.useState(null),[yr,_e]=l.useState({}),[ye,we]=l.useState({});l.useMemo(()=>Hh(),[]);const[fe,Ee]=l.useState(null),[Ue,$e]=l.useState(!1),[Je,at]=l.useState(null),[dt,ke]=l.useState(""),[Ie,Xe]=l.useState(!1),[Ct,At]=l.useState(!1),Er=async()=>{try{console.log("Fetching aggregate quantities...");const V=new AbortController,J=setTimeout(()=>V.abort(),1e4),ie=await B.get("/api/sales-orders/parts-to-order/all",{signal:V.signal});clearTimeout(J);const{aggregatedParts:he}=ie.data;if(console.log("Full API response:",ie.data),console.log("Aggregated parts response:",he),he&&he.length>0){const ue={};he.forEach(Te=>{const Qe=typeof Te.total_quantity_needed=="string"?parseFloat(Te.total_quantity_needed):Te.total_quantity_needed;ue[Te.part_number.toUpperCase()]=Qe}),console.log("Calculated quantities:",ue),C(ue),b(Te=>{const Qe=Te.map(Ye=>({...Ye,quantity_to_order:ue[Ye.part_number]||0}));return console.log("Updated line items with quantities:",Qe),Qe})}else console.log("No aggregated parts found, clearing quantities"),C({}),b(ue=>ue.map(Te=>({...Te,quantity_to_order:0})))}catch(V){console.error("Error fetching aggregate quantities:",V),V.name==="AbortError"&&console.error("Request timed out"),C({}),b(J=>J.map(ie=>({...ie,quantity_to_order:0})))}},Yr=async()=>{if(console.log("fetchData called. ID:",t),a)try{console.log(" Fetching vendors and inventory for creation mode...");const V=new AbortController,J=setTimeout(()=>V.abort(),15e3),[ie,he]=await Promise.all([B.get("/api/vendors",{signal:V.signal}),B.get("/api/inventory",{signal:V.signal})]);clearTimeout(J),console.log(" Vendors and inventory fetched successfully"),console.log("Raw vendors data:",ie.data);const ue=ie.data.map(Te=>({label:Te.vendor_name,id:Te.vendor_id,email:Te.email}));console.log("Mapped vendors:",ue),D(ue),R(he.data),b([]);try{await Er()}catch(Te){console.error("Error fetching aggregate quantities:",Te)}Z(!1),Xe(!0),console.log(" Creation mode initialization complete");return}catch(V){console.error(" Error fetching vendors/inventory:",V),V.name==="AbortError"?Ee("Request timed out. Please try again."):Ee("Failed to fetch vendors and inventory. Please check your connection and try again."),Z(!1);return}try{const[V,J,ie]=await Promise.all([B.get(`/api/purchase-orders/${t}`),B.get("/api/vendors"),B.get("/api/inventory")]),he=V.data;if(console.log("Fetched Order Data:",he),o(he),he.vendor_name&&he.vendor_id){const Ye=J.data.find(yt=>yt.vendor_id===he.vendor_id);c({label:he.vendor_name,id:he.vendor_id,email:Ye?.email})}else if(he.vendor_id){const Ye=J.data.find(yt=>yt.vendor_id===he.vendor_id);Ye?c({label:Ye.vendor_name,id:Ye.vendor_id,email:Ye.email}):(!i||!i.id)&&c(null)}else(!i||!i.id)&&c(null);d(et(he.purchase_date)),m(he.bill_number||""),console.log("Original line items from backend:",he.lineItems);const ue=he.lineItems.map(Ye=>{const yt={...Ye,quantity:String(Ye.quantity||""),unit_cost:String(Ye.unit_cost||""),line_amount:parseFloat(String(Ye.line_amount??Ye.line_total??0)),quantity_to_order:0};return console.log("Mapped line item:",yt),yt});console.log("Final mapped line items:",ue),b(ue),_(ue);const Te=he.status==="Closed"?"Closed":"Open";console.log("Setting purchase order status:",Te,"from fetched status:",he.status),N(Te),E(he.global_gst_rate||Jd),console.log("State after setting:",{purchaseOrder:he,billNumber:he.bill_number||"",lineItems:he.lineItems,mappedLineItems:ue,subTotal:parseFloat(String(he.subtotal))||0,totalGSTAmount:parseFloat(String(he.total_gst_amount))||0,totalAmount:parseFloat(String(he.total_amount))||0}),console.log("Raw vendors data (edit mode):",J.data);const Qe=J.data.map(Ye=>({label:Ye.vendor_name,id:Ye.vendor_id,email:Ye.email}));console.log("Mapped vendors (edit mode):",Qe),D(Qe),R(ie.data),await Er(),Z(!1),Xe(!0)}catch(V){console.error("Error fetching data:",V),V instanceof _r&&V.response?.data?.message?Ee(V.response.data.message):Ee("An unexpected error occurred")}};l.useEffect(()=>{t&&Yr()},[t]),l.useEffect(()=>{console.log("lineItems state changed:",w)},[w]),l.useEffect(()=>{_(w)},[w]),l.useEffect(()=>{G(!1),We(null)},[t]);const Lr=V=>Sl(_s(V.quantity),_s(V.unit_cost)),Fn=l.useMemo(()=>v.map(V=>({part_number:V.part_number,part_description:V.part_description,quantity:_s(V.quantity),unit:V.unit,unit_cost:_s(V.unit_cost)})),[v]),qr=l.useMemo(()=>hw(Fn,j),[Fn,j]),pr=qr.subtotal,wr=qr.total_gst_amount,Yt=qr.total_amount,sn=l.useCallback(V=>JSON.stringify(V.map(J=>({part_number:J.part_number.trim(),part_description:J.part_description.trim(),quantity:parseFloat(String(J.quantity)),unit:J.unit.trim(),unit_cost:parseFloat(String(J.unit_cost))})).sort((J,ie)=>J.part_number!==ie.part_number?J.part_number.localeCompare(ie.part_number):J.quantity-ie.quantity)),[]);l.useEffect(()=>{if(!a&&!ce&&s&&dt===""&&Ie){console.log("[PO Detail] Setting initial signature for dirty tracking");const V=JSON.stringify({vendor:i?{id:i.id,label:i.label}:null,billNumber:p.trim(),date:u?.toISOString(),lineItems:sn(w),pickup_time:s.pickup_time||null,pickup_location:s.pickup_location||null,pickup_contact_person:s.pickup_contact_person||null,pickup_phone:s.pickup_phone||null,pickup_instructions:s.pickup_instructions||null,pickup_notes:s.pickup_notes||null,order_placed:s.order_placed||!1,order_placed_at:s.order_placed_at||null,order_placed_by:s.order_placed_by||null,order_placed_method:s.order_placed_method||null,vendor_confirmation_status:s.vendor_confirmation_status||"pending",vendor_confirmation_notes:s.vendor_confirmation_notes||null,vendor_confirmation_date:s.vendor_confirmation_date||null,pricing_updated:s.pricing_updated||!1,pricing_updated_at:s.pricing_updated_at||null,pricing_updated_by:s.pricing_updated_by||null,pricing_updated_method:s.pricing_updated_method||null,quantity_adjusted:s.quantity_adjusted||!1,quantity_adjusted_at:s.quantity_adjusted_at||null,quantity_adjusted_by:s.quantity_adjusted_by||null,quantity_adjusted_method:s.quantity_adjusted_method||null,original_quantities:s.original_quantities||null,adjusted_quantities:s.adjusted_quantities||null,vendor_pricing_notes:s.vendor_pricing_notes||null});ke(V)}},[a,ce,s,Ie,dt]);const pn=l.useMemo(()=>JSON.stringify({vendor:i?{id:i.id,label:i.label}:null,billNumber:p.trim(),date:u?.toISOString(),lineItems:sn(w),pickup_time:s?.pickup_time||null,pickup_location:s?.pickup_location||null,pickup_contact_person:s?.pickup_contact_person||null,pickup_phone:s?.pickup_phone||null,pickup_instructions:s?.pickup_instructions||null,pickup_notes:s?.pickup_notes||null,order_placed:s?.order_placed||!1,order_placed_at:s?.order_placed_at||null,order_placed_by:s?.order_placed_by||null,order_placed_method:s?.order_placed_method||null,vendor_confirmation_status:s?.vendor_confirmation_status||"pending",vendor_confirmation_notes:s?.vendor_confirmation_notes||null,vendor_confirmation_date:s?.vendor_confirmation_date||null,pricing_updated:s?.pricing_updated||!1,pricing_updated_at:s?.pricing_updated_at||null,pricing_updated_by:s?.pricing_updated_by||null,pricing_updated_method:s?.pricing_updated_method||null,quantity_adjusted:s?.quantity_adjusted||!1,quantity_adjusted_at:s?.quantity_adjusted_at||null,quantity_adjusted_by:s?.quantity_adjusted_by||null,quantity_adjusted_method:s?.quantity_adjusted_method||null,original_quantities:s?.original_quantities||null,adjusted_quantities:s?.adjusted_quantities||null,vendor_pricing_notes:s?.vendor_pricing_notes||null}),[i,p,u,w,s]),Wn=!!dt&&dt!==pn&&!Ct;l.useEffect(()=>{console.log("[PO Detail] isDirty changed:",{isDirty:Wn,hasInitialSignature:!!dt,signaturesMatch:dt===pn,initialSignature:dt.slice(0,100)+"...",currentSignature:pn.slice(0,100)+"..."}),console.log("[PO Detail] About to render UnsavedChangesGuard with when=",Wn)},[Wn,dt,pn]),l.useEffect(()=>{console.log("Aggregate quantities changed:",A),Object.keys(A).length>0&&b(V=>{const J=V.map(ie=>{const he=A[ie.part_number]||A[ie.part_number.toUpperCase()]||A[ie.part_number.toLowerCase()]||0,ue=typeof he=="string"?parseFloat(he):he;return{...ie,quantity_to_order:ue}});return console.log("Updated line items from aggregate quantities effect:",J),J})},[A]);const $n=(V,J,ie)=>{b(he=>{const ue=[...he];if(!ue[V])return console.log("Item at index",V,"not found in handleLineItemChange"),he;const Te={...ue[V],[J]:ie};return J==="quantity"&&parseFloat(ie)<=0?ue.filter((Qe,Ye)=>Ye!==V):((J==="quantity"||J==="unit_cost")&&(Te.line_amount=Lr(Te)),ue[V]=Te,ue)})},Ur=()=>{b(V=>[...V,{part_number:"",part_description:"",quantity:"",unit:xn[0],unit_cost:"",line_amount:0,quantity_to_order:0}])},vr=V=>{const J=[],ie=[];if(!V||V.length===0)return{mapped:J,pending:ie};const he=ue=>ue?ue.trim().toUpperCase():"";return V.filter(ue=>ue.description&&ue.description.trim().length>0||ue.partNumber&&ue.partNumber.trim().length>0).forEach(ue=>{const Te=ue.quantity??0,Qe=ue.match?.lastUnitCost??ue.unitCost??0,Ye=ue.match?.status==="existing"?he(ue.match?.matchedPartNumber||ue.partNumber||ue.match?.normalizedPartNumber||""):he(ue.match?.suggestedPartNumber||ue.partNumber||ue.normalizedPartNumber||""),yt=ue.description||ue.match?.partDescription||"",Jt=ue.match?.status==="existing"?ue.match?.unit||ue.unit||xn[0]:ue.unit||xn[0],Y=ue.match?.status==="existing"&&ue.match?.lastUnitCost!=null?String(ue.match.lastUnitCost):ue.unitCost!=null?String(ue.unitCost):"",$={part_number:Ye,part_description:yt,quantity:ue.quantity!==null&&ue.quantity!==void 0?String(ue.quantity):"",unit:Jt,unit_cost:Y,line_amount:Sl(Te,Qe),quantity_to_order:0},ae=J.length;if(J.push($),ue.match?.status==="missing"&&Ye){const oe={part_number:he(ue.match.suggestedPartNumber||Ye),part_description:ue.description||"",unit:ue.unit||xn[0],last_unit_cost:ue.unitCost??"",part_type:"stock",category:"Uncategorized"};ie.push({index:ae,suggestion:oe})}else if(ue.match?.status==="existing"&&ue.match.descriptionMatches===!1){const oe=`Invoice description for part "${ue.match.matchedPartNumber||Ye}" differs from inventory. Create a new part using the invoice details?`;if(typeof window<"u"?window.confirm(oe):!1){const Oe={part_number:he(ue.match.suggestedPartNumber||Ye),part_description:ue.description||"",unit:ue.unit||ue.match?.unit||xn[0],last_unit_cost:ue.unitCost??ue.match?.lastUnitCost??"",part_type:"stock",category:"Uncategorized"};ie.push({index:ae,suggestion:Oe})}}}),{mapped:J,pending:ie}},ls=async V=>{const J=V.target.files?.[0];if(J){I(null),pe(!0);try{const ie=await aw(J);me(ie),z.success("Gemini analysis completed for the uploaded document. Review the detected values before applying them.")}catch(ie){console.error("Error processing OCR document:",ie);let he="Failed to analyze the document with AI. Please ensure OCR and Gemini are configured on the server.";ie instanceof _r&&ie.response?.data?.error?he=ie.response.data.error:ie?.message&&(he=ie.message),I(he),z.error(he)}finally{pe(!1),V.target&&(V.target.value="")}}},je=()=>{if(!de)return;const{normalized:V}=de.ocr,J=V.vendorMatch,ie=J?.vendorName||V.vendorName||"";if(J&&J.status==="existing"&&J.vendorId){const he=x.find(Qe=>Qe.id===J.vendorId),ue=J.matchedVendorName||ie,Te=J.details?.email||"";if(he)c(he),X(he.label);else{const Qe={label:ue||ie,id:J.vendorId,email:Te};D(Ye=>Ye.some(yt=>yt.id===J.vendorId)?Ye:[...Ye,Qe]),c(Qe),X(Qe.label)}ue&&z.info(`Matched invoice vendor to "${ue}".`)}else if(J&&J.status==="missing"&&ie){c(null),X(ie);const he={vendor_name:ie,street_address:J.details?.streetAddress||"",city:J.details?.city||"",province:J.details?.province||"",country:J.details?.country||"",postal_code:J.details?.postalCode||"",contact_person:J.details?.contactPerson||"",telephone_number:J.details?.telephone||"",email:J.details?.email||"",website:J.details?.website||""};br(he),(typeof window<"u"?window.confirm(`Vendor "${ie}" was not found. Would you like to add this vendor now?`):!1)?Kr(!0):z.warn(`Vendor "${ie}" is not in the system. Review the captured details before continuing.`)}else if(ie){const he=x.find(ue=>ue.label.toLowerCase()===ie.toLowerCase());he?(c(he),X(he.label)):(c(null),X(ie))}if(V.billNumber&&m(V.billNumber),V.billDate){const he=et(V.billDate);he.isValid()&&d(he)}if(typeof V.gstRate=="number"&&!Number.isNaN(V.gstRate)&&E(V.gstRate),V.lineItems?.length){const{mapped:he,pending:ue}=vr(V.lineItems);he.length>0&&(b(he),_(he)),zt(ue)}else zt([]);z.success("OCR data applied. Please review the form before saving.")},rt=async V=>{const J=V.toUpperCase();if(!K[J])try{const ie=await Mo(J);F(he=>({...he,[J]:ie}))}catch{}},ct=(V,J)=>{const ie=K[V.toUpperCase()]||[];if(ie.length===0)return V;if(J){const Te=ie.filter(Qe=>Qe.vendor_id===J);if(Te.length>0){const Qe=Te.find(yt=>yt.preferred);if(Qe)return Qe.vendor_part_number;const Ye=[...Te].sort((yt,Jt)=>(Jt.usage_count||0)-(yt.usage_count||0))[0];if(Ye)return Ye.vendor_part_number}}const he=ie.find(Te=>Te.preferred);if(he)return he.vendor_part_number;const ue=[...ie].sort((Te,Qe)=>(Qe.usage_count||0)-(Te.usage_count||0))[0];return ue?ue.vendor_part_number:V};l.useEffect(()=>{i&&b(V=>V.map(J=>{const ie=(J.part_number||"").toUpperCase(),he=K[ie];if(!he||he.length===0)return J;const ue=ct(ie,i?.id||null);return{...J,part_number:ue}}))},[i,K]);const Vt=V=>{b(J=>J.filter((ie,he)=>he!==V))},ur=V=>ee.find(J=>J.part_number===V),Dr=(V,J)=>{console.log("handlePartNumberChange called:",{idx:V,newValue:J,inventoryItemsLength:ee.length}),_(ie=>{const he=[...ie],ue=he[V];if(console.log("Current item before change:",ue),!ue)return console.log("Current item not found, creating default item"),he[V]={part_number:"",part_description:"",quantity:"",unit:xn[0],unit_cost:"",line_amount:0,quantity_to_order:0},he;if(J===null||typeof J=="string"&&J.trim()==="")console.log("Resetting line item to empty values"),!ue.part_number&&!ue.part_description&&!ue.quantity&&!ue.unit_cost?he[V]={...ue,part_number:"",part_description:"",quantity:"",unit:xn[0],unit_cost:"",line_amount:0,quantity_to_order:0}:console.log("Preserving existing data despite empty input value");else if(typeof J!="string"&&J.isNew){console.log("Opening part dialog for new part"),Ve(V);const Te=J.inputValue||"";it(Te),Ne({part_number:Te.toUpperCase(),category:"Uncategorized"}),Be("manual"),Ce(!0)}else if(typeof J=="string"){const Te=ur(J);console.log("Found inventory item:",Te);const Qe=A[J]||A[J.toUpperCase()]||A[J.toLowerCase()]||0,Ye=typeof Qe=="string"?parseFloat(Qe):Qe;if(console.log(`Quantity to order for ${J}:`,Qe,"as number:",Ye),console.log("Available aggregate quantities keys:",Object.keys(A)),console.log("Looking for part:",J,"in aggregate quantities:",A),Te){const yt=ue.unit_cost,Jt=!yt||yt===""||yt==="0";he[V]={...ue,part_number:J,part_description:Te.part_description,unit:Te.unit,unit_cost:Jt?String(Te.last_unit_cost):yt,quantity_to_order:Ye}}else console.log("Inventory item not found, preserving existing data"),he[V]={...ue,part_number:J,quantity_to_order:Ye}}return he[V].line_amount=Lr(he[V]),console.log("Updated item after change:",he[V]),he}),typeof J=="string"&&J.trim()!==""&&Er()},Fr=async(V,J)=>{if(!V||V.trim()==="")return!1;try{return(await B.get("/api/purchase-history/check-bill-number",{params:{bill_number:V.trim(),exclude_purchase_id:J}})).data.exists}catch(ie){return console.error("Error checking duplicate bill number:",ie),!1}},Tr=(V=!1,J=!1)=>{let ie={};i||(ie.vendor="Vendor is required."),u||(ie.date="Date is required."),V&&!p.trim()&&(ie.billNumber="Bill Number is required.");const he=w.map(Te=>({part_number:Te.part_number,part_description:Te.part_description,quantity:_s(Te.quantity),unit:Te.unit,unit_cost:_s(Te.unit_cost)})),ue=fw(he,i,J);return ue.lineItems&&w.length>0&&(ie.lineItems=ue.lineItems),we(ie),ie},Sr=async()=>{const V=Tr(!1,!1);if(Object.keys(V).length>0){z.error("Please correct the errors before saving.");return}if(!(p&&p.trim()&&await Fr(p,s?.purchase_id)&&!window.confirm(`Warning: Bill number "${p}" already exists in another purchase order. Do you want to proceed anyway?`))){At(!0);try{if(a){const J={vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:w.map(ue=>({part_number:ue.part_number.trim(),part_description:ue.part_description.trim(),unit:ue.unit.trim(),quantity:parseFloat(String(ue.quantity)),unit_cost:parseFloat(String(ue.unit_cost)),line_amount:parseFloat(String(ue.line_amount))})),status:"Open",subtotal:pr,total_gst_amount:wr,total_amount:Yt,global_gst_rate:j,company_id:n?.company_id,created_by:n?.id,pickup_time:s?.pickup_time||null,pickup_location:s?.pickup_location||null,pickup_contact_person:s?.pickup_contact_person||null,pickup_phone:s?.pickup_phone||null,pickup_instructions:s?.pickup_instructions||null,pickup_notes:s?.pickup_notes||null,order_placed:s?.order_placed||!1,order_placed_at:s?.order_placed_at||null,order_placed_by:s?.order_placed_by||null,order_placed_method:s?.order_placed_method||null,vendor_confirmation_status:s?.vendor_confirmation_status||"pending",vendor_confirmation_notes:s?.vendor_confirmation_notes||null,vendor_confirmation_date:s?.vendor_confirmation_date||null,pricing_updated:s?.pricing_updated||!1,pricing_updated_at:s?.pricing_updated_at||null,pricing_updated_by:s?.pricing_updated_by||null,pricing_updated_method:s?.pricing_updated_method||null,quantity_adjusted:s?.quantity_adjusted||!1,quantity_adjusted_at:s?.quantity_adjusted_at||null,quantity_adjusted_by:s?.quantity_adjusted_by||null,quantity_adjusted_method:s?.quantity_adjusted_method||null,original_quantities:s?.original_quantities||null,adjusted_quantities:s?.adjusted_quantities||null,vendor_pricing_notes:s?.vendor_pricing_notes||null};if(console.log("Creating new purchase order:",J),window.__poCreateInFlight){console.log("[PO] Skipping duplicate create (in flight)");return}window.__poCreateInFlight=!0;const ie=await B.post("/api/purchase-orders",J);z.success("Purchase Order created successfully!");const he=ie.data.purchase_id;window.__unsavedGuardAllowNext=!0,r(`/open-purchase-orders/${he}`)}else{const J={...s,vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:w.map(he=>({...he,part_number:he.part_number.trim(),part_description:he.part_description.trim(),unit:he.unit.trim(),quantity:parseFloat(String(he.quantity)),unit_cost:parseFloat(String(he.unit_cost)),line_amount:parseFloat(String(he.line_amount))})),status:P,subtotal:pr,total_gst_amount:wr,total_amount:Yt,global_gst_rate:j,gst_rate:j,pickup_time:s?.pickup_time||null,pickup_location:s?.pickup_location||null,pickup_contact_person:s?.pickup_contact_person||null,pickup_phone:s?.pickup_phone||null,pickup_instructions:s?.pickup_instructions||null,pickup_notes:s?.pickup_notes||null,order_placed:s?.order_placed||!1,order_placed_at:s?.order_placed_at||null,order_placed_by:s?.order_placed_by||null,order_placed_method:s?.order_placed_method||null,vendor_confirmation_status:s?.vendor_confirmation_status||"pending",vendor_confirmation_notes:s?.vendor_confirmation_notes||null,vendor_confirmation_date:s?.vendor_confirmation_date||null,pricing_updated:s?.pricing_updated||!1,pricing_updated_at:s?.pricing_updated_at||null,pricing_updated_by:s?.pricing_updated_by||null,pricing_updated_method:s?.pricing_updated_method||null,quantity_adjusted:s?.quantity_adjusted||!1,quantity_adjusted_at:s?.quantity_adjusted_at||null,quantity_adjusted_by:s?.quantity_adjusted_by||null,quantity_adjusted_method:s?.quantity_adjusted_method||null,original_quantities:s?.original_quantities||null,adjusted_quantities:s?.adjusted_quantities||null,vendor_pricing_notes:s?.vendor_pricing_notes||null};console.log("Sending to backend (handleSave):",J);const ie=await B.put(`/api/purchase-orders/${t}`,J);at("Purchase Order updated successfully!"),setTimeout(()=>{window.__unsavedGuardAllowNext=!0},100),ke(JSON.stringify({vendor:i,billNumber:p,date:u,lineItems:w,pickup_time:s?.pickup_time,pickup_location:s?.pickup_location,pickup_contact_person:s?.pickup_contact_person,pickup_phone:s?.pickup_phone,pickup_instructions:s?.pickup_instructions,pickup_notes:s?.pickup_notes,order_placed:s?.order_placed,order_placed_at:s?.order_placed_at,order_placed_by:s?.order_placed_by,order_placed_method:s?.order_placed_method,vendor_confirmation_status:s?.vendor_confirmation_status,vendor_confirmation_notes:s?.vendor_confirmation_notes,vendor_confirmation_date:s?.vendor_confirmation_date,pricing_updated:s?.pricing_updated,pricing_updated_at:s?.pricing_updated_at,pricing_updated_by:s?.pricing_updated_by,pricing_updated_method:s?.pricing_updated_method,quantity_adjusted:s?.quantity_adjusted,quantity_adjusted_at:s?.quantity_adjusted_at,quantity_adjusted_by:s?.quantity_adjusted_by,quantity_adjusted_method:s?.quantity_adjusted_method,original_quantities:s?.original_quantities,adjusted_quantities:s?.adjusted_quantities,vendor_pricing_notes:s?.vendor_pricing_notes}))}}catch(J){console.error("Error saving Purchase Order:",J),J instanceof _r&&J.response?.data?.error?z.error(`Error saving Purchase Order: ${J.response.data.error}`):z.error("Error saving Purchase Order. Please try again.")}finally{At(!1),window.__poCreateInFlight=!1}}},Vr=async()=>{if(!s?.purchase_id){z.error("Purchase order not loaded. Cannot export.");return}if(s.status!=="Closed"){z.error("Only closed purchase orders can be exported to QuickBooks.");return}if(s.exported_to_qbo){z.error("Purchase order has already been exported to QuickBooks.");return}co(!0);try{const V=await B.post(`/api/purchase-orders/${s.purchase_id}/export-to-qbo`);z.success("Exported to QuickBooks successfully!"),o(J=>J&&{...J,exported_to_qbo:!0})}catch(V){const J=V?.response?.data?.error||"Failed to export to QuickBooks.";z.error(J)}finally{co(!1)}},Gr=async()=>{if(!s?.purchase_id){z.error("Purchase order not loaded. Cannot reopen.");return}if(window.confirm("Are you sure you want to reopen this purchase order?"))try{const V={...s,vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:w.map(J=>({...J,part_number:J.part_number.trim(),part_description:J.part_description.trim(),unit:J.unit.trim(),quantity:parseFloat(String(J.quantity)),unit_cost:parseFloat(String(J.unit_cost)),line_amount:parseFloat(String(J.line_amount))})),status:"Open",subtotal:pr,total_gst_amount:wr,total_amount:Yt,global_gst_rate:j,gst_rate:j,pickup_time:s?.pickup_time||null,pickup_location:s?.pickup_location||null,pickup_contact_person:s?.pickup_contact_person||null,pickup_phone:s?.pickup_phone||null,pickup_instructions:s?.pickup_instructions||null,pickup_notes:s?.pickup_notes||null,order_placed:s?.order_placed||!1,order_placed_at:s?.order_placed_at||null,order_placed_by:s?.order_placed_by||null,order_placed_method:s?.order_placed_method||null,vendor_confirmation_status:s?.vendor_confirmation_status||"pending",vendor_confirmation_notes:s?.vendor_confirmation_notes||null,vendor_confirmation_date:s?.vendor_confirmation_date||null,pricing_updated:s?.pricing_updated||!1,pricing_updated_at:s?.pricing_updated_at||null,pricing_updated_by:s?.pricing_updated_by||null,pricing_updated_method:s?.pricing_updated_method||null,quantity_adjusted:s?.quantity_adjusted||!1,quantity_adjusted_at:s?.quantity_adjusted_at||null,quantity_adjusted_by:s?.quantity_adjusted_by||null,quantity_adjusted_method:s?.quantity_adjusted_method||null,original_quantities:s?.original_quantities||null,adjusted_quantities:s?.adjusted_quantities||null,vendor_pricing_notes:s?.vendor_pricing_notes||null};await B.put(`/api/purchase-orders/${s.purchase_id}`,V),z.success("Purchase Order reopened successfully!"),o(J=>J&&{...J,status:"Open"}),N("Open"),r(`/open-purchase-orders/${s.purchase_id}`)}catch(V){if(console.error("Error reopening purchase order:",V),V instanceof _r&&V.response?.data?.error){const J=V.response.data.error;J.toLowerCase().includes("negative quantity")||J.toLowerCase().includes("insufficient inventory")||J.toLowerCase().includes("inventory constraint")?z.error(`Cannot reopen: ${J}`):z.error(`Error reopening PO: ${J}`)}else z.error("Failed to reopen purchase order. Please try again.")}},Xr=async()=>{s?.purchase_id&&await Wr()},Wr=async()=>{if(!s?.purchase_id)return;const V=Tr(!0,!0);if(Object.keys(V).length>0){V.lineItems?.some(he=>he.unit_cost)?z.error("Unit cost is required for all line items before closing a purchase order."):($e(!0),z.error("A bill number is required to close the purchase order."));return}if(!(await Fr(p,s.purchase_id)&&!window.confirm(`Warning: Bill number "${p}" already exists in another purchase order. Do you want to proceed with closing this purchase order anyway?`)))try{const ie={...s,vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:w.map(ue=>({...ue,part_number:ue.part_number.trim(),part_description:ue.part_description.trim(),unit:ue.unit.trim(),quantity:parseFloat(String(ue.quantity)),unit_cost:parseFloat(String(ue.unit_cost)),line_amount:parseFloat(String(ue.line_amount))})),status:"Closed",subtotal:pr,total_gst_amount:wr,total_amount:Yt,global_gst_rate:j,gst_rate:j,pickup_time:s?.pickup_time||null,pickup_location:s?.pickup_location||null,pickup_contact_person:s?.pickup_contact_person||null,pickup_phone:s?.pickup_phone||null,pickup_instructions:s?.pickup_instructions||null,pickup_notes:s?.pickup_notes||null,order_placed:s?.order_placed||!1,order_placed_at:s?.order_placed_at||null,order_placed_by:s?.order_placed_by||null,order_placed_method:s?.order_placed_method||null,vendor_confirmation_status:s?.vendor_confirmation_status||"pending",vendor_confirmation_notes:s?.vendor_confirmation_notes||null,vendor_confirmation_date:s?.vendor_confirmation_date||null,pricing_updated:s?.pricing_updated||!1,pricing_updated_at:s?.pricing_updated_at||null,pricing_updated_by:s?.pricing_updated_by||null,pricing_updated_method:s?.pricing_updated_method||null,quantity_adjusted:s?.quantity_adjusted||!1,quantity_adjusted_at:s?.quantity_adjusted_at||null,quantity_adjusted_by:s?.quantity_adjusted_by||null,quantity_adjusted_method:s?.quantity_adjusted_method||null,original_quantities:s?.original_quantities||null,adjusted_quantities:s?.adjusted_quantities||null,vendor_pricing_notes:s?.vendor_pricing_notes||null},he=await B.put(`/api/purchase-orders/${s.purchase_id}`,ie);he.status===200?(console.log("Purchase Order closed:",he.data),z.success("Purchase Order closed successfully!"),o(ue=>ue&&{...ue,status:"Closed"}),N("Closed"),r(`/open-purchase-orders/${s.purchase_id}`)):z.error("Failed to close purchase order")}catch(ie){if(console.error("Error closing purchase order:",ie),ie instanceof _r&&ie.response?.data?.error){const he=ie.response.data.error;he.toLowerCase().includes("negative quantity")||he.toLowerCase().includes("insufficient inventory")||he.toLowerCase().includes("inventory constraint")?z.error(`Cannot close: ${he}`):z.error(`Error closing PO: ${he}`)}else z.error("Failed to close purchase order. Please try again.")}},Ir=()=>{r(`/open-purchase-orders/${s?.purchase_id}`)},Cr=()=>{Yr(),z.success("Allocation changes saved successfully. Purchase order remains open.")},wn=async()=>{if(!Tr(!1)){z.error("Please correct the errors before proceeding with allocation.");return}try{const V={...s,vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:w.map(J=>({...J,part_number:J.part_number.trim(),part_description:J.part_description.trim(),unit:J.unit.trim(),quantity:parseFloat(String(J.quantity)),unit_cost:parseFloat(String(J.unit_cost)),line_amount:parseFloat(String(J.line_amount))})),subtotal:pr,total_gst_amount:wr,total_amount:Yt,global_gst_rate:j,gst_rate:j,pickup_time:s?.pickup_time||null,pickup_location:s?.pickup_location||null,pickup_contact_person:s?.pickup_contact_person||null,pickup_phone:s?.pickup_phone||null,pickup_instructions:s?.pickup_instructions||null,pickup_notes:s?.pickup_notes||null,order_placed:s?.order_placed||!1,order_placed_at:s?.order_placed_at||null,order_placed_by:s?.order_placed_by||null,order_placed_method:s?.order_placed_method||null,vendor_confirmation_status:s?.vendor_confirmation_status||"pending",vendor_confirmation_notes:s?.vendor_confirmation_notes||null,vendor_confirmation_date:s?.vendor_confirmation_date||null,pricing_updated:s?.pricing_updated||!1,pricing_updated_at:s?.pricing_updated_at||null,pricing_updated_by:s?.pricing_updated_by||null,pricing_updated_method:s?.pricing_updated_method||null,quantity_adjusted:s?.quantity_adjusted||!1,quantity_adjusted_at:s?.quantity_adjusted_at||null,quantity_adjusted_by:s?.quantity_adjusted_by||null,quantity_adjusted_method:s?.quantity_adjusted_method||null,original_quantities:s?.original_quantities||null,adjusted_quantities:s?.adjusted_quantities||null,vendor_pricing_notes:s?.vendor_pricing_notes||null};await B.put(`/api/purchase-orders/${s.purchase_id}`,V),o(V),zn(!0),z.success("Changes saved successfully. Opening allocation modal...")}catch(V){console.error("Error saving changes before allocation:",V),V instanceof _r&&V.response?.data?.error?z.error(`Error saving changes: ${V.response.data.error}`):z.error("Failed to save changes before allocation. Please try again.")}},cs=async()=>{if(!s?.purchase_id){z.error("Purchase order not loaded. Cannot download PDF.");return}try{const V=await B.get(`/api/purchase-orders/${s.purchase_id}/pdf`,{responseType:"blob"}),J=window.URL.createObjectURL(new Blob([V.data])),ie=document.createElement("a");ie.href=J,ie.download=`purchase_order_${s.purchase_number}.pdf`,document.body.appendChild(ie),ie.click(),ie.remove(),window.URL.revokeObjectURL(J)}catch(V){console.error("Error downloading PDF:",V),z.error("Failed to download PDF. Please try again.")}},Qr=async()=>{await Sr(),!(Object.keys(ye).length>0)&&await cs()},ds=()=>{if(!s)return;const V=w.map(ie=>ie.quantity),J=prompt(`Enter adjusted quantities (comma-separated, e.g., 50,100,25):
Current quantities: `+V.join(", ")+`
Note: Adjust based on vendor minimum orders (e.g., sold by 10ft packs)`);if(J)try{const ie=J.split(",").map(he=>parseFloat(he.trim()));if(ie.length!==w.length){z.error("Number of quantities must match number of line items");return}b(he=>he.map((ue,Te)=>({...ue,quantity:ie[Te]}))),o(he=>he&&{...he,quantity_adjusted:!0,quantity_adjusted_at:new Date().toISOString(),quantity_adjusted_by:Number(n?.id),quantity_adjusted_method:"manual",original_quantities:V,adjusted_quantities:ie}),z.success("Quantities adjusted based on vendor confirmation")}catch{z.error("Invalid quantity format. Please use numbers separated by commas.")}},[hn,zn]=l.useState(!1),[mn,$s]=l.useState(!1),[Bn,us]=l.useState(""),[Hn,co]=l.useState(!1),[ps,hs]=l.useState(!1),[zs,ms]=l.useState([]),[fs,Bs]=l.useState(!1),[Sn,Yn]=l.useState(null),[Hs,xs]=l.useState({}),Cn=async()=>{if(s?.purchase_id){Bs(!0),Yn(null);try{const V=await B.get(`/api/purchase-history/${s.purchase_id}/allocations`);ms(V.data||[]);const J=Array.from(new Set((V.data||[]).map(ie=>ie.sales_order_id).filter(Boolean)));if(J.length>0)try{const ie=await Promise.all(J.map(ue=>B.get(`/api/sales-orders/${ue}`))),he={};ie.forEach((ue,Te)=>{const Qe=J[Te],Ye=ue.data?.salesOrder?.sales_order_number||ue.data?.salesOrder?.sales_number||"";Ye&&(he[Qe]=Ye)}),xs(he)}catch(ie){console.warn("Unable to fetch one or more sales order numbers:",ie)}hs(!0)}catch(V){console.error("Error fetching allocations:",V),Yn("Failed to load allocations."),hs(!0)}finally{Bs(!1)}}},[uo,Kr]=l.useState(!1),[po,br]=l.useState({}),Zr=V=>V.normalize("NFD").replace(/[-]/g,"").replace(/[^a-zA-Z0-9\s]/g," ").replace(/\s+/g," ").trim().toUpperCase(),Ci=(V,J)=>{const ie=Zr(J);if(!ie)return V.slice(0,8);const he=V.map(ue=>{const Te=Zr(ue.label);let Qe=-1;return Te.startsWith(ie)?Qe=3:Te.split(" ").some(Ye=>Ye.startsWith(ie))?Qe=2:Te.includes(ie)&&(Qe=1),{opt:ue,score:Qe}}).filter(ue=>ue.score>=0);return he.sort((ue,Te)=>Te.score-ue.score||ue.opt.label.localeCompare(Te.opt.label)),he.slice(0,8).map(ue=>ue.opt)},gs=V=>{const J=Zr(V);return x.find(ie=>Zr(ie.label)===J)||null},ho=V=>{const J=Zr(V),ie=ee.find(he=>Zr(he.part_number)===J);return ie?ie.part_number:null},ki=V=>{const J=M.trim(),ie=V.key==="Enter",he=V.key==="Tab",ue=V.key==="Escape",Te=V.key==="ArrowDown"||V.key==="ArrowUp";if(ue){G(!1);return}if(Te){V.key==="ArrowDown"&&!U&&G(!0);return}if(ie||he){if(ie&&V.ctrlKey&&J){V.preventDefault(),q(!0),br({vendor_name:J}),Kr(!0),G(!1);return}if(U){if(ie){const Ye=S;Ye&&Ye.isNew&&(V.preventDefault(),q(!0),br({vendor_name:J}),Kr(!0),G(!1))}return}const Qe=gs(J);if(!J)return;V.preventDefault(),Qe?(c(Qe),X(Qe.label)):(q(!0),br({vendor_name:J}),Kr(!0),G(!1))}},Pi=(V,J)=>{const ie=(w[V]?.part_number||"").trim(),he=J.key==="Enter",ue=J.key==="Tab",Te=J.key==="Escape",Qe=J.key==="ArrowDown"||J.key==="ArrowUp";if(Te){We(null);return}if(Qe){J.key==="ArrowDown"&&Bt!==V&&We(V);return}if(!(Bt===V&&(he||ue))&&(he||ue)){if(he&&J.ctrlKey&&ie){J.preventDefault(),tr(V),it(ie),Ve(V),Ne({part_number:ie.toUpperCase(),category:"Uncategorized"}),Be("manual"),Ce(!0),We(null);return}const Ye=ho(ie);if(!ie)return;J.preventDefault(),Ye?Dr(V,Ye):(tr(V),it(ie),Ve(V),Ne({part_number:ie.toUpperCase(),category:"Uncategorized"}),Be("manual"),Ce(!0),We(null))}},ys=()=>{Ce(!1),Ve(null),Ne(void 0),Be("manual"),it("")},Vn=V=>{const J=x.find(ie=>ie.id===V);return console.log("Getting vendor email for vendor ID:",V),console.log("Selected vendor:",J),console.log("Vendor email:",J?.email),J?.email||""},Ei=async()=>{if(!i?.id){z.error("Please select a vendor first");return}if(a){if(!Tr(!1)){z.error("Please correct the errors before sending email.");return}try{const V={vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:w.map(Te=>({part_number:Te.part_number.trim(),part_description:Te.part_description.trim(),unit:Te.unit.trim(),quantity:parseFloat(String(Te.quantity)),unit_cost:parseFloat(String(Te.unit_cost)),line_amount:parseFloat(String(Te.line_amount))})),status:"Open",subtotal:pr,total_gst_amount:wr,total_amount:Yt,global_gst_rate:j,company_id:n?.company_id,created_by:n?.id,pickup_time:s?.pickup_time||null,pickup_location:s?.pickup_location||null,pickup_contact_person:s?.pickup_contact_person||null,pickup_phone:s?.pickup_phone||null,pickup_instructions:s?.pickup_instructions||null,pickup_notes:s?.pickup_notes||null,order_placed:s?.order_placed||!1,order_placed_at:s?.order_placed_at||null,order_placed_by:s?.order_placed_by||null,order_placed_method:s?.order_placed_method||null,vendor_confirmation_status:s?.vendor_confirmation_status||"pending",vendor_confirmation_notes:s?.vendor_confirmation_notes||null,vendor_confirmation_date:s?.vendor_confirmation_date||null,pricing_updated:s?.pricing_updated||!1,pricing_updated_at:s?.pricing_updated_at||null,pricing_updated_by:s?.pricing_updated_by||null,pricing_updated_method:s?.pricing_updated_method||null,quantity_adjusted:s?.quantity_adjusted||!1,quantity_adjusted_at:s?.quantity_adjusted_at||null,quantity_adjusted_by:s?.quantity_adjusted_by||null,quantity_adjusted_method:s?.quantity_adjusted_method||null,original_quantities:s?.original_quantities||null,adjusted_quantities:s?.adjusted_quantities||null,vendor_pricing_notes:s?.vendor_pricing_notes||null};console.log("Creating new purchase order for email:",V);const ie=(await B.post("/api/purchase-orders",V)).data;o(ie);const he=ie.purchase_id;r(`/open-purchase-orders/${he}`);const ue=Vn(i.id);us(ue),$s(!0),z.success("Purchase Order created and email modal opened!")}catch(V){console.error("Error creating Purchase Order for email:",V),V instanceof _r&&V.response?.data?.error?z.error(`Error creating Purchase Order: ${V.response.data.error}`):z.error("Error creating Purchase Order. Please try again.")}}else{const V=Vn(i.id);console.log("Email button clicked - vendor ID:",i.id),console.log("Retrieved email:",V),us(V),$s(!0)}};l.useEffect(()=>{console.log("Part modal state changed - openPartDialog:",Ae,"partNumberForModal:",ut,"partToAddIndex:",ze)},[Ae,ut,ze]),l.useEffect(()=>{if(!Ae&&wt.length>0){const[V,...J]=wt;zt(J),Ve(V.index),it(V.suggestion.part_number?String(V.suggestion.part_number):""),Ne({part_number:V.suggestion.part_number??"",part_description:V.suggestion.part_description??"",unit:V.suggestion.unit??xn[0],last_unit_cost:V.suggestion.last_unit_cost??"",quantity_on_hand:V.suggestion.quantity_on_hand??"",reorder_point:V.suggestion.reorder_point??"",part_type:V.suggestion.part_type??"stock",category:V.suggestion.category??"Uncategorized"}),Be("ocr"),Ce(!0)}},[Ae,wt]),l.useEffect(()=>{Ae&&We(null)},[Ae]),l.useEffect(()=>{if(i?.id){const V=Vn(i.id);console.log("Vendor changed - updating email:",V),us(V)}else us("")},[i,x]);const Ys=()=>{if(!s)return null;const V=w||[];let J=V.reduce((ue,Te)=>ue+(Number(Te.line_amount)||0),0),ie=J*(s.global_gst_rate||5)/100,he=J+ie;return isNaN(J)&&(J=0),isNaN(ie)&&(ie=0),isNaN(he)&&(he=0),e.jsxs(k,{p:{xs:2,md:4},maxWidth:1e3,mx:"auto",children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Purchase Order Details"}),e.jsx(kt,{variant:"outlined",sx:{mb:3},children:e.jsx(Ot,{children:e.jsxs(O,{container:!0,spacing:{xs:2,md:3},children:[e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Purchase Order #:"})," ",s.purchase_number]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Vendor:"})," ",s.vendor_name||"N/A"]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Purchase Date:"})," ",s.purchase_date?new Date(s.purchase_date).toLocaleDateString():""]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Created On:"})," ",s.created_at?new Date(s.created_at).toLocaleDateString():"N/A"]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Status:"})," ",s.status?.toUpperCase()||"N/A"]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Bill Number:"})," ",s.bill_number||"N/A"]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"GST Rate:"})," ",(s.global_gst_rate||5).toFixed(2),"%"]}),e.jsxs(O,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"QuickBooks Export:"})," ",s.exported_to_qbo?"Exported":s.qbo_export_status?`Error: ${s.qbo_export_status}`:"Not Exported"]})]})})}),s.return_orders&&e.jsx(k,{mb:3,children:Gn()}),e.jsx(h,{variant:"h5",gutterBottom:!0,children:"Items"}),e.jsx(kt,{variant:"outlined",children:e.jsx(Ot,{children:V.map((ue,Te)=>e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:6,sm:3,md:2,children:ue.part_number}),e.jsx(O,{item:!0,xs:6,sm:5,md:4,children:ue.part_description}),e.jsx(O,{item:!0,xs:4,sm:2,md:1.5,children:ue.quantity}),e.jsx(O,{item:!0,xs:4,sm:2,md:1.5,children:ue.unit}),e.jsx(O,{item:!0,xs:4,sm:2,md:1.5,children:Or(Number(ue.unit_cost)||0)}),e.jsx(O,{item:!0,xs:4,sm:2,md:1,children:Or(Number(ue.line_amount)||0)})]},Te))})}),e.jsxs(k,{mt:4,display:"flex",flexDirection:"column",alignItems:"flex-end",children:[e.jsxs(h,{variant:"h6",children:["Subtotal: ",Or(J)]}),e.jsxs(h,{variant:"h6",children:["Total GST: ",Or(ie)]}),e.jsxs(h,{variant:"h6",children:["Total Amount: ",Or(he)]})]}),e.jsxs(k,{mt:4,display:"flex",justifyContent:{xs:"center",sm:"flex-end"},gap:2,children:[e.jsx(Q,{variant:"contained",color:"primary",startIcon:e.jsx(gr,{}),onClick:Qr,children:"Download PDF"}),!s?.exported_to_qbo&&n?.access_role==="Admin"&&e.jsx(Q,{variant:"contained",color:"success",startIcon:e.jsx(so,{}),onClick:Vr,disabled:Hn,children:Hn?"Exporting...":"Export to QuickBooks"}),(n?.access_role==="Admin"||n?.access_role==="Sales and Purchase")&&e.jsx(Q,{variant:"contained",color:"primary",onClick:Gr,children:"Reopen PO"}),e.jsx(Q,{variant:"outlined",color:"primary",onClick:Cn,children:"View Allocations"})]}),e.jsxs(mt,{open:ps,onClose:()=>hs(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:"Allocations"}),e.jsxs(xt,{dividers:!0,children:[fs&&e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",py:4,children:e.jsx(ot,{})}),!fs&&Sn&&e.jsx(Fe,{severity:"error",children:Sn}),!fs&&!Sn&&(()=>{if(!zs||zs.length===0)return e.jsx(h,{variant:"body2",children:"No allocations were saved for this purchase order."});const ue=zs.reduce((Qe,Ye)=>{const yt=(Ye.part_number||"").toString();return Qe[yt]||(Qe[yt]=[]),Qe[yt].push(Ye),Qe},{}),Te=Object.keys(ue).sort();return e.jsx(Pe,{spacing:3,children:Te.map(Qe=>{const Ye=ue[Qe],yt=Ye.find(Y=>Y.part_description)?.part_description||"",Jt=Ye.reduce((Y,$)=>Y+(Number($.allocate_qty)||0),0);return e.jsxs(k,{children:[e.jsxs(h,{variant:"subtitle1",sx:{fontWeight:"bold"},children:[Qe," ",yt?`- ${yt}`:""]}),e.jsx(dr,{component:Me,sx:{mt:1},children:e.jsxs(ir,{size:"small",children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Sales Order"}),e.jsx(ne,{children:"Sales Order Number"}),e.jsx(ne,{align:"right",children:"Allocated Qty"})]})}),e.jsxs(cr,{children:[Ye.map(Y=>e.jsxs(ht,{children:[e.jsxs(ne,{children:["#",Y.sales_order_id]}),e.jsx(ne,{children:Hs[Y.sales_order_id]?`SO-${Hs[Y.sales_order_id]}`:"-"}),e.jsx(ne,{align:"right",children:Number(Y.allocate_qty||0).toFixed(2)})]},Y.allocation_id)),e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontWeight:600},children:"Total"}),e.jsx(ne,{align:"right",sx:{fontWeight:600},children:Jt.toFixed(2)})]})]})]})})]},Qe)})})})()]}),e.jsx(jt,{children:e.jsx(Q,{onClick:()=>hs(!1),children:"Close"})})]})]})},Gn=()=>{if(!s)return null;const V=s.return_orders??[],J=s.return_summary??{};return e.jsxs(Me,{sx:{p:3},elevation:1,children:[e.jsxs(Pe,{direction:{xs:"column",md:"row"},alignItems:{xs:"flex-start",md:"center"},justifyContent:"space-between",spacing:2,children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h6",children:"Return Orders"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"View vendor returns associated with this purchase order."})]}),e.jsxs(Pe,{direction:"row",spacing:1,children:[e.jsx(De,{label:`Requested: ${J.requested_count??0}`,color:"warning",variant:"outlined",size:"small"}),e.jsx(De,{label:`Returned: ${J.returned_count??0}`,color:"success",variant:"outlined",size:"small"}),e.jsx(Q,{variant:"outlined",onClick:()=>r(`/return-orders/new?purchaseId=${s.purchase_id}`),children:"Create Return"})]})]}),V.length===0?e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mt:2},children:"No return orders have been logged for this purchase order."}):e.jsx(dr,{component:k,sx:{mt:2},children:e.jsxs(ir,{size:"small",children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Return #"}),e.jsx(ne,{children:"Status"}),e.jsx(ne,{children:"Requested"}),e.jsx(ne,{children:"Returned"}),e.jsx(ne,{align:"right",children:"Total Qty"}),e.jsx(ne,{align:"right",children:"Actions"})]})}),e.jsx(cr,{children:V.map(ie=>e.jsxs(ht,{hover:!0,children:[e.jsx(ne,{children:ie.return_number}),e.jsx(ne,{children:e.jsx(De,{label:ie.status,size:"small",color:ie.status==="Returned"?"success":"warning",variant:"outlined"})}),e.jsx(ne,{children:ie.requested_at?new Date(ie.requested_at).toLocaleString():""}),e.jsx(ne,{children:ie.returned_at?new Date(ie.returned_at).toLocaleString():""}),e.jsx(ne,{align:"right",children:Number(ie.total_quantity??0).toFixed(2)}),e.jsx(ne,{align:"right",children:e.jsx(Q,{size:"small",onClick:()=>r(`/return-orders/${ie.return_id}`),children:"View"})})]},ie.return_id))})]})})]})};return!a&&!s?e.jsx(k,{p:4,children:e.jsx(h,{variant:"h5",children:"Loading Purchase Order..."})}):ce?e.jsx(k,{p:4,children:e.jsx(h,{variant:"h5",children:"Loading..."})}):!a&&P==="Closed"?Ys():e.jsxs(e.Fragment,{children:[e.jsxs(bn,{dateAdapter:os,children:[e.jsx(ji,{when:Wn,onSave:Sr}),e.jsxs(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:a?"Create New Purchase Order":`Edit Purchase Order: ${s?.purchase_number}`}),!a&&s&&e.jsxs(e.Fragment,{children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2,mt:1},children:[e.jsx(De,{label:s.order_placed?"Order Placed":"Order Not Placed",color:s.order_placed?"success":"warning",variant:"outlined",size:"small"}),e.jsx(De,{label:`Vendor: ${s.vendor_confirmation_status||"pending"}`,color:s.vendor_confirmation_status==="confirmed"?"success":s.vendor_confirmation_status==="partial"?"warning":s.vendor_confirmation_status==="unavailable"?"error":"default",variant:"outlined",size:"small"}),s.pricing_updated&&e.jsx(De,{label:"Pricing Updated",color:"info",variant:"outlined",size:"small"}),s.quantity_adjusted&&e.jsx(De,{label:"Quantities Adjusted",color:"secondary",variant:"outlined",size:"small"})]}),s.created_at&&e.jsxs(h,{variant:"subtitle1",color:"text.secondary",sx:{mt:1},children:["Created On: ",new Date(s.created_at).toLocaleDateString()]})]})]}),e.jsxs(Pe,{direction:"row",spacing:1,children:[e.jsx(Q,{variant:"contained",color:"primary",onClick:Sr,startIcon:e.jsx(is,{}),children:a?"Create Purchase Order":"Save Changes"}),!a&&e.jsxs(e.Fragment,{children:[e.jsx(Q,{variant:"contained",color:"primary",onClick:Xr,startIcon:e.jsx(Jo,{}),children:"Close PO"}),e.jsx(Q,{variant:"contained",color:"primary",onClick:Qr,startIcon:e.jsx(gr,{}),children:"Download PDF"}),e.jsx(Q,{variant:"contained",onClick:Ei,startIcon:e.jsx(pi,{}),sx:{backgroundColor:"#ff9800","&:hover":{backgroundColor:"#f57c00"}},children:"Email Vendor"})]})]})]}),!a&&s&&e.jsx(k,{sx:{mb:3},children:Gn()}),Ue&&e.jsxs(Fe,{severity:"warning",sx:{mb:3},onClose:()=>$e(!1),children:[e.jsx(h,{variant:"body1",sx:{fontWeight:"medium"},children:"Bill Number Required"}),e.jsx(h,{variant:"body2",children:"A bill number is required to close this purchase order. Please enter a bill number before closing."})]}),e.jsx(kt,{variant:"outlined",sx:{mb:3},children:e.jsxs(Ot,{children:[e.jsxs(Pe,{direction:{xs:"column",sm:"row"},spacing:2,alignItems:{xs:"stretch",sm:"center"},children:[e.jsxs(k,{sx:{flexGrow:1},children:[e.jsx(h,{variant:"h6",children:"Invoice / Packing Slip OCR Prefill"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Upload a vendor invoice or packing slip to extract vendor, bill, and line item details using on-server Tesseract OCR."})]}),e.jsx("input",{type:"file",accept:"image/*,.pdf",hidden:!0,ref:W,onChange:ls}),e.jsx(Q,{variant:"contained",color:"secondary",startIcon:e.jsx(so,{}),onClick:()=>W.current?.click(),disabled:ge,children:ge?"Processing":"Upload Document"}),ge&&e.jsx(ot,{size:24})]}),se&&e.jsx(Fe,{severity:"error",sx:{mt:2},children:se}),de&&e.jsxs(k,{sx:{mt:3},children:[e.jsxs(Pe,{direction:{xs:"column",md:"row"},spacing:2,alignItems:{xs:"flex-start",md:"center"},children:[e.jsxs(k,{sx:{flexGrow:1},children:[e.jsxs(Pe,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(h,{variant:"subtitle1",children:"Detected Fields"}),e.jsx(De,{size:"small",color:de.source==="ai"?"info":"default",variant:de.source==="ai"?"filled":"outlined",label:de.source==="ai"?"Gemini AI analysis":"OCR extraction"})]}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Review the extracted details and apply them to this purchase order."})]}),e.jsx(Pe,{direction:"row",spacing:1,children:e.jsx(Q,{variant:"contained",color:"primary",onClick:je,children:"Apply to Form"})})]}),e.jsxs(O,{container:!0,spacing:2,sx:{mt:1},children:[e.jsxs(O,{item:!0,xs:12,md:6,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Vendor"}),e.jsx(h,{variant:"body1",children:de.ocr.normalized.vendorName||"Not detected"}),de.ocr.normalized.vendorAddress&&e.jsx(h,{variant:"body2",color:"text.secondary",children:de.ocr.normalized.vendorAddress})]}),e.jsxs(O,{item:!0,xs:12,md:3,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Bill Number"}),e.jsx(h,{variant:"body1",children:de.ocr.normalized.billNumber||"Not detected"})]}),e.jsxs(O,{item:!0,xs:12,md:3,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Bill Date"}),e.jsx(h,{variant:"body1",children:de.ocr.normalized.billDate||"Not detected"})]})]}),de.ocr.normalized.lineItems.length>0&&e.jsxs(k,{sx:{mt:2},children:[e.jsxs(h,{variant:"body2",color:"text.secondary",sx:{mb:1},children:["Sample of detected line items (",de.ocr.normalized.lineItems.length," total)"]}),e.jsx(Me,{variant:"outlined",sx:{maxHeight:200,overflowY:"auto",p:1},children:de.ocr.normalized.lineItems.slice(0,5).map((V,J)=>e.jsxs(k,{sx:{py:.5},children:[e.jsxs(h,{variant:"body2",sx:{fontWeight:500},children:[V.partNumber?`${V.partNumber}  `:"",V.description]}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:["Qty: ",V.quantity??"n/a"," | Unit Cost: ",V.unitCost??"n/a"," | Total: ",V.totalCost??"n/a"]})]},`${V.rawLine}-${J}`))})]}),(de.ocr.warnings.length>0||de.ocr.notes.length>0)&&e.jsxs(Pe,{direction:"row",spacing:1,sx:{mt:2,flexWrap:"wrap"},children:[de.ocr.warnings.map((V,J)=>e.jsx(De,{label:V,color:"warning",variant:"outlined",sx:{mr:1,mb:1}},`ocr-warning-${J}`)),de.ocr.notes.map((V,J)=>e.jsx(De,{label:V,color:"info",variant:"outlined",sx:{mr:1,mb:1}},`ocr-note-${J}`))]})]})]})}),e.jsx(Me,{sx:{p:3},children:e.jsxs(O,{container:!0,spacing:3,children:[e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(zr,{disablePortal:!1,open:U,onOpen:()=>G(!0),onClose:()=>G(!1),autoHighlight:!0,value:i,onChange:(V,J)=>{if(T){q(!1);return}J&&J.isNew?(Kr(!0),br({vendor_name:M}),c(null),X(""),G(!1)):(c(J),G(!1))},filterOptions:(V,J)=>{const ie=Ci(V,J.inputValue||""),he=!!gs(J.inputValue||""),ue=[...ie];return(J.inputValue||"").trim()!==""&&!he&&ue.push({label:`Add "${J.inputValue}" as New Vendor`,isNew:!0}),ie.length===0&&(J.inputValue||"").trim()!==""&&!he,ue},inputValue:M,onInputChange:(V,J,ie)=>{if(X(J),ie==="reset")return;(J||"").trim()||G(!1)},options:x,getOptionLabel:V=>typeof V=="string"?V:V.label,isOptionEqualToValue:(V,J)=>V.id===J.id,onHighlightChange:(V,J)=>g(J),ListboxProps:{role:"listbox",style:{maxHeight:320,overflowY:"auto"}},renderOption:(V,J)=>{const ie=J.isNew,{key:he,...ue}=V;return e.jsxs("li",{...ue,style:{display:"flex",alignItems:"center",opacity:ie?.9:1},children:[ie&&e.jsx(Mn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),e.jsx("span",{children:J.label})]},he)},renderInput:V=>e.jsx(le,{...V,label:"Vendor",error:!!ye.vendor,helperText:ye.vendor,onKeyDown:ki,onBlur:()=>{if(G(!1),!i){const J=M.trim();if(J){const ie=gs(J);ie&&(c(ie),X(ie.label))}}},inputRef:J=>{H.current=J}})})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Bill Number",value:p,onChange:V=>{m(V.target.value),V.target.value.trim()!==""&&$e(!1)},fullWidth:!0,error:!!ye.billNumber,helperText:ye.billNumber})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"GST Rate (%)",type:"number",value:j,onChange:V=>E(Number(V.target.value)),fullWidth:!0,inputProps:{min:0,max:100,step:"0.01",readOnly:P==="Closed",onWheel:V=>V.currentTarget.blur()},helperText:"Change GST rate if needed (default 5%). This will affect GST and total calculations.",disabled:P==="Closed"})})]})}),e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:3,mb:2},children:[e.jsx(h,{variant:"h6",children:"Line Items"}),e.jsx(Q,{variant:"contained",onClick:wn,startIcon:e.jsx(Jo,{}),sx:{backgroundColor:a?"#e0e0e0":"#ff9800",color:"#fff","&:hover":{backgroundColor:a?"#e0e0e0":"#f57c00"},"&.Mui-disabled":{color:"#fff"}},disabled:a,children:"  Allocate Parts"})]}),e.jsxs(Me,{sx:{p:3,mb:3,mt:0},elevation:3,children:[e.jsx(O,{container:!0,spacing:2,children:w.map((V,J)=>e.jsxs(Dt.Fragment,{children:[e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(zr,{disablePortal:!1,open:Bt===J,onOpen:()=>We(J),onClose:()=>We(null),autoHighlight:!0,value:V.part_number,inputValue:yr[J]??V.part_number,onInputChange:(ie,he,ue)=>{if(_e(Qe=>({...Qe,[J]:he})),ue==="reset")return;(he||"").trim()||We(null)},onChange:(ie,he)=>{if(typeof he=="string"){const ue=he,Te=ee.find(yt=>yt.part_number===ue),Qe=A[ue]||A[ue?.toUpperCase?.()||""]||A[ue?.toLowerCase?.()||""]||0,Ye=typeof Qe=="string"?parseFloat(Qe):Qe;b(yt=>{const Jt=[...yt],Y=Jt[J];if(Te){const $=Y.unit_cost,oe=String(!$||$===""||$==="0"?Te.last_unit_cost:$),be={...Y,part_number:ue,part_description:Te.part_description,unit:Te.unit,unit_cost:oe,quantity_to_order:Ye};if(be.line_amount=Lr(be),Jt[J]=be,rt(Te.part_number),i?.id){const Oe=(()=>{const Ge=K[Te.part_number.toUpperCase()]||[];if(Ge.length===0)return null;const Re=Ge.filter(rr=>rr.vendor_id===i.id);if(Re.length>0){const rr=Re.find(Vs=>Vs.preferred);if(rr)return rr.vendor_part_number;const kn=[...Re].sort((Vs,_h)=>(_h.usage_count||0)-(Vs.usage_count||0))[0];if(kn)return kn.vendor_part_number}const Pt=Ge.find(rr=>rr.preferred);if(Pt)return Pt.vendor_part_number;const $t=[...Ge].sort((rr,kn)=>(kn.usage_count||0)-(rr.usage_count||0))[0];return $t?$t.vendor_part_number:null})();Oe&&(Jt[J].part_number=Oe)}}else Jt[J]={...Y,part_number:ue};return Jt}),Dr(J,ue),We(null),_e(yt=>({...yt,[J]:""}))}else if(he&&typeof he=="object"&&"isNew"in he){const ue=he.inputValue||"";it(ue),Ve(J),Ne({part_number:ue.toUpperCase(),category:"Uncategorized"}),Be("manual"),Ce(!0),We(null),_e(Te=>({...Te,[J]:""}))}},options:ee.map(ie=>ie.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,handleHomeEndKeys:!0,getOptionLabel:ie=>typeof ie=="string"?ie:ie.label,renderOption:(ie,he)=>{const ue=typeof he=="object"&&he.isNew,Te=typeof he=="string"?he:he.label,{key:Qe,...Ye}=ie;return e.jsxs("li",{...Ye,children:[ue&&e.jsx(Mn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof he=="string"?e.jsxs(k,{children:[e.jsx(h,{variant:"body2",children:he}),(()=>{const yt=ee.find(Jt=>Jt.part_number===he);return yt?.part_description?e.jsx(h,{variant:"caption",color:"text.secondary",children:yt.part_description}):null})()]}):Te]},Qe)},filterOptions:(ie,he)=>{const ue=(he.inputValue||"").toUpperCase(),Te=ie.filter(yt=>{const Jt=ee.find(Y=>Y.part_number===yt);return Jt?String(yt).toUpperCase().includes(ue)||String(Jt.part_description||"").toUpperCase().includes(ue):String(yt).toUpperCase().includes(ue)}),Qe=Te.some(yt=>String(yt).toUpperCase()===ue),Ye=[...Te];return ue&&!Qe&&Ye.push({inputValue:he.inputValue,label:`Add "${he.inputValue}" as New Part`,isNew:!0}),Ye},ListboxProps:{role:"listbox",style:{maxHeight:320,overflowY:"auto"}},renderInput:ie=>e.jsx(le,{...ie,label:"Part Number",fullWidth:!0,required:!0,error:!!ye.lineItems?.[J]?.part_number,helperText:ye.lineItems?.[J]?.part_number,onKeyDown:he=>Pi(J,he),onBlur:()=>{We(null);const ue=(w[J]?.part_number||"").trim();if(!ue)return;const Te=ho(ue);if(Te){const Qe=ee.find(Jt=>Jt.part_number===Te),Ye=A[Te]||A[Te?.toUpperCase?.()||""]||A[Te?.toLowerCase?.()||""]||0,yt=typeof Ye=="string"?parseFloat(Ye):Ye;b(Jt=>{const Y=[...Jt],$=Y[J];if(Qe){const ae=$.unit_cost,be=String(!ae||ae===""||ae==="0"?Qe.last_unit_cost:ae),Oe={...$,part_number:Te,part_description:Qe.part_description,unit:Qe.unit,unit_cost:be,quantity_to_order:yt};Oe.line_amount=Lr(Oe),Y[J]=Oe}else Y[J]={...$,part_number:Te};return Y}),Dr(J,Te)}}})})}),e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(le,{label:"Part Description",value:V.part_description,InputProps:{readOnly:!0},fullWidth:!0,error:!!ye.lineItems?.[J]?.part_description,helperText:ye.lineItems?.[J]?.part_description})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Qty",value:V.quantity,onChange:ie=>$n(J,"quantity",ie.target.value),type:"number",fullWidth:!0,required:!0,error:!!ye.lineItems?.[J]?.quantity,helperText:ye.lineItems?.[J]?.quantity,inputProps:{step:"1",onWheel:ie=>ie.currentTarget.blur()}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Unit",value:V.unit,select:!0,fullWidth:!0,disabled:!0,InputProps:{readOnly:!0},children:xn.map(ie=>e.jsx(Ze,{value:ie,children:ie},ie))})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Unit Cost",value:V.unit_cost,onChange:ie=>$n(J,"unit_cost",ie.target.value),type:"number",fullWidth:!0,error:!!ye.lineItems?.[J]?.unit_cost,helperText:ye.lineItems?.[J]?.unit_cost,inputProps:{step:"0.01",onWheel:ie=>ie.currentTarget.blur()}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Amount",value:V.line_amount!=null&&!isNaN(Number(V.line_amount))?Number(V.line_amount).toFixed(2):"0.00",InputProps:{readOnly:!0},fullWidth:!0})}),e.jsxs(O,{item:!0,xs:12,sm:1,md:1,sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Q,{variant:"outlined",color:"primary",onClick:()=>Vt(J),sx:{flexShrink:0},children:"Remove"}),(()=>{const ie=a?"Open":P,he=ie==="Open"&&typeof V.quantity_to_order=="number"&&V.quantity_to_order>0;return console.log(`Rendering Qty to Order for ${V.part_number}:`,{status:P,isCreationMode:a,effectiveStatus:ie,quantity_to_order:V.quantity_to_order,type:typeof V.quantity_to_order,shouldShow:he}),he?e.jsx(le,{label:"Qty to Order",value:V.quantity_to_order,size:"small",InputProps:{readOnly:!0},sx:{backgroundColor:"#fff3cd",minWidth:"120px","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"#ffc107"},"&:hover fieldset":{borderColor:"#ffc107"}}}}):null})()]})]},J))}),e.jsx(k,{sx:{mt:2},children:e.jsx(Q,{variant:"outlined",color:"primary",onClick:Ur,children:"Add Line Item"})})]}),e.jsx(Me,{sx:{p:3,mb:3},elevation:3,children:e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsxs(h,{variant:"subtitle1",children:["Subtotal: $",pr!=null&&!isNaN(Number(pr))?Number(pr).toFixed(2):"0.00"]})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsxs(h,{variant:"subtitle1",children:["Total GST: $",wr!=null&&!isNaN(Number(wr))?Number(wr).toFixed(2):"0.00"]})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsxs(h,{variant:"h6",children:["Total Amount: $",Yt!=null&&!isNaN(Number(Yt))?Number(Yt).toFixed(2):"0.00"]})})]})}),e.jsx(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:3,mb:2},children:e.jsx(h,{variant:"h6",children:"Pickup Details for Drivers"})}),e.jsx(Me,{sx:{p:3,mb:3},elevation:3,children:e.jsxs(O,{container:!0,spacing:3,children:[e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Pickup Time",placeholder:"e.g., tomorrow at 2 PM, Friday morning",value:s?.pickup_time||"",onChange:V=>{s&&o({...s,pickup_time:V.target.value})},fullWidth:!0,helperText:"When to pick up the order"})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Pickup Location",placeholder:"e.g., 123 Main St, Building A, Loading Dock",value:s?.pickup_location||"",onChange:V=>{s&&o({...s,pickup_location:V.target.value})},fullWidth:!0,helperText:"Where to pick up the order"})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Contact Person",placeholder:"e.g., John Smith, Warehouse Manager",value:s?.pickup_contact_person||"",onChange:V=>{s&&o({...s,pickup_contact_person:V.target.value})},fullWidth:!0,helperText:"Name of person to contact at pickup location"})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Contact Phone",placeholder:"e.g., (555) 123-4567",value:s?.pickup_phone||"",onChange:V=>{s&&o({...s,pickup_phone:V.target.value})},fullWidth:!0,helperText:"Phone number for pickup contact person"})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Pickup Instructions",placeholder:"e.g., Use loading dock on east side, call 15 minutes before arrival, parking available in lot B",value:s?.pickup_instructions||"",onChange:V=>{s&&o({...s,pickup_instructions:V.target.value})},fullWidth:!0,multiline:!0,rows:3,helperText:"Special instructions for pickup (parking, loading dock, etc.)"})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Pickup Notes",placeholder:"e.g., After-hours pickup available, bring ID, parts are in warehouse section C",value:s?.pickup_notes||"",onChange:V=>{s&&o({...s,pickup_notes:V.target.value})},fullWidth:!0,multiline:!0,rows:2,helperText:"General notes about pickup for drivers"})})]})}),e.jsx(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:3,mb:2},children:e.jsx(h,{variant:"h6",children:"Order Placement Tracking"})}),e.jsx(Me,{sx:{p:3,mb:3},elevation:3,children:e.jsxs(O,{container:!0,spacing:3,children:[e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx("input",{type:"checkbox",checked:s?.order_placed||!1,onChange:V=>{s&&o({...s,order_placed:V.target.checked,order_placed_at:V.target.checked?new Date().toISOString():void 0,order_placed_by:V.target.checked?Number(n?.id):void 0,order_placed_method:V.target.checked?"manual":void 0})},style:{transform:"scale(1.5)"}}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"Order Placed with Vendor"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:s?.order_placed?`Placed on ${new Date(s.order_placed_at||"").toLocaleDateString()}`:"Order not yet placed"})]})]})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsxs(le,{select:!0,label:"Vendor Confirmation Status",value:s?.vendor_confirmation_status||"pending",onChange:V=>{s&&o({...s,vendor_confirmation_status:V.target.value,vendor_confirmation_date:V.target.value!=="pending"?new Date().toISOString():void 0})},fullWidth:!0,helperText:"Current vendor confirmation status",children:[e.jsx(Ze,{value:"pending",children:"Pending"}),e.jsx(Ze,{value:"confirmed",children:"Confirmed"}),e.jsx(Ze,{value:"partial",children:"Partially Available"}),e.jsx(Ze,{value:"unavailable",children:"Unavailable"})]})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Vendor Confirmation Notes",placeholder:"e.g., Parts available, pricing confirmed, minimum order 10ft packs",value:s?.vendor_confirmation_notes||"",onChange:V=>{s&&o({...s,vendor_confirmation_notes:V.target.value})},fullWidth:!0,multiline:!0,rows:2,helperText:"Notes from vendor about order confirmation, availability, and pricing"})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx("input",{type:"checkbox",checked:s?.pricing_updated||!1,onChange:V=>{s&&o({...s,pricing_updated:V.target.checked,pricing_updated_at:V.target.checked?new Date().toISOString():void 0,pricing_updated_by:V.target.checked?Number(n?.id):void 0,pricing_updated_method:V.target.checked?"manual":void 0})},style:{transform:"scale(1.5)"}}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"Pricing Updated"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:s?.pricing_updated?`Updated on ${new Date(s.pricing_updated_at||"").toLocaleDateString()}`:"Pricing not yet updated"})]})]})}),e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx("input",{type:"checkbox",checked:s?.quantity_adjusted||!1,onChange:V=>{s&&o({...s,quantity_adjusted:V.target.checked,quantity_adjusted_at:V.target.checked?new Date().toISOString():void 0,quantity_adjusted_by:V.target.checked?Number(n?.id):void 0,quantity_adjusted_method:V.target.checked?"manual":void 0})},style:{transform:"scale(1.5)"}}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"Quantities Adjusted"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:s?.quantity_adjusted?`Adjusted on ${new Date(s.quantity_adjusted_at||"").toLocaleDateString()}`:"Quantities not yet adjusted"})]})]})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Vendor Pricing Structure Notes",placeholder:"e.g., Sold by 10ft packs, minimum order 50ft, bulk pricing available over 100ft",value:s?.vendor_pricing_notes||"",onChange:V=>{s&&o({...s,vendor_pricing_notes:V.target.value})},fullWidth:!0,multiline:!0,rows:2,helperText:"Notes about vendor pricing structure, minimum orders, and packaging units"})}),e.jsxs(O,{item:!0,xs:12,children:[e.jsx(k,{sx:{display:"flex",justifyContent:"center",mt:2},children:e.jsx(Q,{variant:"outlined",color:"primary",onClick:ds,disabled:!s||w.length===0,sx:{minWidth:"200px"},children:"Adjust Quantities (Vendor Confirmation)"})}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{textAlign:"center",mt:1},children:"Use this when vendor confirms different quantities (e.g., sold by 10ft packs)"})]}),(s?.original_quantities||s?.adjusted_quantities)&&e.jsxs(O,{item:!0,xs:12,children:[e.jsx(h,{variant:"subtitle1",sx:{fontWeight:"bold",mb:2},children:"Quantity Adjustments"}),e.jsx(O,{container:!0,spacing:2,children:w.map((V,J)=>{const ie=s?.original_quantities?.[J]||V.quantity,he=s?.adjusted_quantities?.[J]||V.quantity;return ie!==he?e.jsx(O,{item:!0,xs:12,sm:6,children:e.jsxs(Me,{sx:{p:2,backgroundColor:"#f5f5f5"},elevation:1,children:[e.jsx(h,{variant:"body2",sx:{fontWeight:"bold"},children:V.part_number}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Original: ",ie,"  Adjusted: ",he]})]})},J):null})})]})]})}),e.jsx(ns,{open:Ae,onClose:ys,onSave:async V=>{try{const J=await B.post("/api/inventory",V);console.log("New part added successfully:",J.data);const ie=await B.get("/api/inventory");R(ie.data);const he=J.data.item;ze!==null&&b(ue=>{const Te=[...ue];return Te[ze]={...Te[ze],part_number:he.part_number,part_description:he.part_description,unit:he.unit,unit_cost:String(he.last_unit_cost),quantity:Te[ze].quantity},Te[ze].line_amount=Lr(Te[ze]),Te}),ys()}catch(J){throw J}},title:tt==="ocr"?"Add New Part from OCR":"Add New Part",initialPart:pt??{part_number:ut.toUpperCase(),category:"Uncategorized"}}),e.jsx($p,{open:uo,onClose:()=>{Kr(!1),br({})},onSave:async V=>{try{const ie=(await B.post("/api/vendors",V)).data.vendor;D(he=>[...he,{label:ie.vendor_name,id:ie.vendor_id,email:ie.email}]),c({label:ie.vendor_name,id:ie.vendor_id,email:ie.email}),!a&&s&&o(he=>he&&{...he,vendor_id:ie.vendor_id,vendor_name:ie.vendor_name}),Kr(!1),br({}),z.success("Vendor added successfully!")}catch{z.error("Failed to add vendor.")}},initialVendor:po,isEditMode:!1}),e.jsx(pw,{open:hn,onClose:()=>zn(!1),purchaseOrderId:s?.purchase_id||0,onSuccess:Ir,onAllocationSaved:Cr}),e.jsx(ch,{open:mn,onClose:()=>$s(!1),type:"purchase-order",recordId:s?.purchase_id,defaultTo:Bn,allowMessageEdit:!0}),mn&&e.jsxs("div",{style:{display:"none"},children:["Debug: vendorEmail = ",Bn,", vendor = ",JSON.stringify(i)]})]})]}),e.jsx(vn,{open:!!Je,autoHideDuration:6e3,onClose:()=>at(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Fe,{onClose:()=>at(null),severity:"success",sx:{width:"100%"},children:Je})})]})};var Ra={},Zd;function xw(){if(Zd)return Ra;Zd=1;var t=vt();Object.defineProperty(Ra,"__esModule",{value:!0}),Ra.default=void 0;var r=t(_t()),n=bt();return Ra.default=(0,r.default)((0,n.jsx)("path",{d:"m22 9.24-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28z"}),"StarBorder"),Ra}var gw=xw();const yw=st(gw);var Na={},eu;function vw(){if(eu)return Na;eu=1;var t=vt();Object.defineProperty(Na,"__esModule",{value:!0}),Na.default=void 0;var r=t(_t()),n=bt();return Na.default=(0,r.default)((0,n.jsx)("path",{d:"M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"}),"Star"),Na}var bw=vw();const _w=st(bw);var La={},tu;function jw(){if(tu)return La;tu=1;var t=vt();Object.defineProperty(La,"__esModule",{value:!0}),La.default=void 0;var r=t(_t()),n=bt();return La.default=(0,r.default)((0,n.jsx)("path",{d:"M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3m5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72z"}),"Mic"),La}var ww=jw();const Sw=st(ww);var qa={},ru;function Cw(){if(ru)return qa;ru=1;var t=vt();Object.defineProperty(qa,"__esModule",{value:!0}),qa.default=void 0;var r=t(_t()),n=bt();return qa.default=(0,r.default)((0,n.jsx)("path",{d:"M6 6h12v12H6z"}),"Stop"),qa}var kw=Cw();const Pw=st(kw);class Ew{mediaRecorder=null;audioChunks=[];isRecording=!1;stream=null;async startRecording(){try{this.stream=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});const r={mimeType:"audio/webm;codecs=opus",audioBitsPerSecond:16e3};MediaRecorder.isTypeSupported(r.mimeType)||delete r.mimeType,this.mediaRecorder=new MediaRecorder(this.stream,r),this.audioChunks=[],this.isRecording=!0,this.mediaRecorder.ondataavailable=n=>{n.data.size>0&&this.audioChunks.push(n.data)},this.mediaRecorder.start(1e3)}catch(r){throw console.error("Error starting voice recording:",r),new Error("Failed to start voice recording. Please check microphone permissions.")}}async stopRecording(){return new Promise((r,n)=>{if(!this.mediaRecorder||!this.isRecording){n(new Error("No active recording"));return}this.mediaRecorder.onstop=async()=>{try{this.isRecording=!1;const a=new Blob(this.audioChunks,{type:"audio/wav"}),s=await this.processAudioQuery(a);r(s)}catch(a){n(a)}finally{this.cleanup()}},this.mediaRecorder.stop()})}cleanup(){this.stream&&(this.stream.getTracks().forEach(r=>r.stop()),this.stream=null),this.mediaRecorder=null,this.audioChunks=[],this.isRecording=!1}async processAudioQuery(r){try{if(r.size>1048576)throw new Error(`Audio file too large (${(r.size/1024/1024).toFixed(2)}MB). Please record a shorter message.`);const a=await this.blobToBase64(r);return(await B.post("/api/voice-search/search-parts",{audioData:a,audioFormat:r.type||"audio/webm"})).data}catch(n){throw console.error("Error processing voice query:",n),n instanceof Error?new Error(n.message):new Error("Failed to process voice query. Please try again.")}}blobToBase64(r){return new Promise((n,a)=>{const s=new FileReader;s.onload=()=>{const i=s.result.split(",")[1];n(i)},s.onerror=a,s.readAsDataURL(r)})}async interpretTextQuery(r){try{return(await B.post("/api/voice-search/interpret-query",{query:r})).data}catch(n){return console.error("Error interpreting text query:",n),{query:r,searchInPartNumbers:!0,searchInDescriptions:!0,extractedTerms:[r]}}}isRecordingActive(){return this.isRecording}cancelRecording(){this.isRecording&&(this.mediaRecorder?.stop(),this.cleanup())}}const Dw=new Ew,Tw=({onSearchTerms:t,disabled:r=!1})=>{const[n,a]=l.useState(!1),[s,o]=l.useState(!1),[i,c]=l.useState(""),u=l.useRef(null),d=l.useRef(null),p=()=>{const w=typeof window<"u"&&window.process&&window.process.type;if(typeof window<"u"&&"webkitSpeechRecognition"in window&&!u.current){const b=window.webkitSpeechRecognition||window.SpeechRecognition;u.current=new b,u.current.continuous=!1,u.current.interimResults=!0,u.current.lang="en-US",w&&console.log("Running in Electron environment"),u.current.onresult=P=>{let N="",j="";for(let E=P.resultIndex;E<P.results.length;E++){const A=P.results[E][0].transcript;P.results[E].isFinal?N+=A:j+=A}c(N+j),N.trim()&&_(N.trim())},u.current.onerror=P=>{console.error("Speech recognition error:",P.error),P.error==="network"?(typeof window<"u"&&window.process&&window.process.type?z.error("Voice recognition network error in Electron. Please try again or use text search."):z.error("Voice recognition requires internet connection. Please try again."),a(!1)):P.error==="not-allowed"?(z.error("Microphone access denied. Please allow microphone access."),a(!1)):P.error==="no-speech"?(z.info("No speech detected. Please try again."),a(!1)):P.error==="audio-capture"?(z.error("Audio capture error. Please check your microphone."),a(!1)):P.error==="service-not-allowed"?(z.error("Voice recognition service not allowed. This is common in Electron apps."),a(!1)):(console.error("Speech recognition error:",P.error),z.error(`Voice recognition error: ${P.error}. Please try again.`),a(!1))},u.current.onend=()=>{a(!1),c("")}}},m=()=>{try{if(!(typeof window<"u"&&("webkitSpeechRecognition"in window||"SpeechRecognition"in window))){z.error("Voice recognition not available in this browser.");return}typeof window<"u"&&window.process&&window.process.type&&z.info("Voice recognition in Electron may have limitations. If it doesn't work, please use text search."),p(),u.current&&(a(!0),c(""),u.current.start(),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{n&&f()},8e3))}catch(w){console.error("Error starting voice recognition:",w),z.error("Failed to start voice recognition."),a(!1)}},f=()=>{u.current&&u.current.stop(),a(!1),d.current&&clearTimeout(d.current)},_=async w=>{try{o(!0),c("");const b=await Dw.interpretTextQuery(w);t(b.extractedTerms,{searchInPartNumbers:b.searchInPartNumbers,searchInDescriptions:b.searchInDescriptions}),z.success(`Voice search: "${w}"  ${b.extractedTerms.join(", ")}`)}catch(b){console.error("Error processing voice input:",b),z.error("Failed to process voice input. Please try again.")}finally{o(!1)}},v=()=>{n?f():m()};return e.jsxs(k,{children:[e.jsx(Q,{variant:"contained",size:"large",onClick:v,disabled:r||s,startIcon:s?e.jsx(ot,{size:20,color:"inherit"}):n?e.jsx(Pw,{}):e.jsx(Sw,{}),sx:{backgroundColor:n?"error.main":"primary.main",color:"white","&:hover":{backgroundColor:n?"error.dark":"primary.dark"},minWidth:120,height:48},children:s?"Processing...":n?"Stop":"Voice Search"}),n&&e.jsxs(k,{display:"flex",alignItems:"center",gap:1,mt:1,children:[e.jsx(k,{sx:{width:8,height:8,borderRadius:"50%",backgroundColor:"error.main",animation:"pulse 1s infinite","@keyframes pulse":{"0%":{opacity:1},"50%":{opacity:.3},"100%":{opacity:1}}}}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:["Listening... ",i&&`"${i}"`]})]})]})},Iw="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),Ow="0123456789".split("");function dh(t,r,n){return`so:${r}:${t}:${n}`}function nu(t,r,n){try{const a=localStorage.getItem(dh(t,r,n));if(!a)return[];const s=JSON.parse(a);return Array.isArray(s)?s:[]}catch{return[]}}function su(t,r,n,a){try{localStorage.setItem(dh(t,r,n),JSON.stringify(a.slice(0,50)))}catch{}}function uh(){return"partFinder:usage:global"}function ph(t,r){return`partFinder:usage:so:${t}:${r}`}function Aw(){try{const t=localStorage.getItem(uh());return t?JSON.parse(t):{}}catch{return{}}}function Mw(t){try{localStorage.setItem(uh(),JSON.stringify(t))}catch{}}function Rw(t,r){try{const n=localStorage.getItem(ph(t,r));return n?JSON.parse(n):{}}catch{return{}}}function Nw(t,r,n){try{localStorage.setItem(ph(t,r),JSON.stringify(n))}catch{}}function Lw(t){const{open:r,onClose:n,onSelect:a,salesOrderId:s,context:o,inventoryItems:i}=t,[c,u]=l.useState(""),[d,p]=l.useState(""),[m,f]=l.useState([]),[_,v]=l.useState([]),[w,b]=l.useState([]),[P,N]=l.useState({}),[j,E]=l.useState({}),[A,C]=l.useState([]),[L,y]=l.useState(null);l.useEffect(()=>{r&&(v(nu("favorites",s,o)),b(nu("recents",s,o)),N(Rw(s,o)),E(Aw()))},[r,s,o]);const x=l.useMemo(()=>{const S=c.toUpperCase(),g=new Set(m.map(ee=>ee.toUpperCase())),T=new Set(A.map(ee=>ee.toUpperCase())),q=d.trim().toUpperCase();return i.filter(ee=>{const R=(ee.part_number||"").toUpperCase(),K=(ee.part_description||"").toUpperCase();if(S&&!R.startsWith(S)||q&&!(R.includes(q)||K.includes(q)))return!1;for(const F of g)if(!(R.includes(F)||K.includes(F)))return!1;if(A.length>0&&L){let F=!1;for(const xe of T){if(L.searchInPartNumbers&&R.includes(xe)){F=!0;break}if(L.searchInDescriptions&&K.includes(xe)){F=!0;break}}if(!F)return!1}return!0})},[i,c,m,d,A,L]),D=l.useMemo(()=>{const S={},g=new Set(m.map(de=>de.toUpperCase())),T=new Set(_),q=new Set(w),ee={SS:"STAINLESS",STAIN:"STAINLESS",STAINLESS:"STAINLESS",AL:"ALUMINUM",ALUM:"ALUMINUM",GALV:"GALVANIZED",GALVANIZED:"GALVANIZED",SQ:"SQUARE",RECT:"RECTANGULAR",TUBE:"TUBING"},R=new Set(["TUBING","PIPE","ANGLE","BAR","FLAT","BEAM","CHANNEL","SHEET","PLATE","ROUND","SQUARE","RECTANGULAR"]),K=de=>ee[de]||de,F=(de,me)=>{const ge=de.trim();!ge||g.has(ge)||(S[ge]=(S[ge]||0)+me)},xe=de=>{const[me,ge]=de.split("/").map(Number);return!me||!ge?null:(me/ge).toFixed(4).replace(/0+$/,"").replace(/\.$/,"")},ve=de=>{const me=[];if(!de)return me;let ge=de.toUpperCase().replace(/[\s-]+/g,"").replace(//g,"X").replace(/[()]/g,"");const pe=ge.match(/\d+\/\d+/g)||[];if(ge.includes("X")){const se=ge.split("X");se.length>=2&&se.length<=4&&(me.push(se.slice(0,2).join("X")),me.push(se.join("X")))}return pe.forEach(se=>{me.push(se);const I=xe(se);I&&me.push(I)}),(ge.match(/(\d+)GA/g)||[]).forEach(se=>me.push(se)),(ge.match(/SCH\s*\d+/g)||[]).forEach(se=>me.push(se.replace(/\s+/g,""))),(ge.match(/OD\d+(?:\.\d+)?/g)||[]).forEach(se=>me.push(se)),(ge.match(/ID\d+(?:\.\d+)?/g)||[]).forEach(se=>me.push(se)),(ge.match(/\d+(?:\.\d+)?/g)||[]).slice(0,3).forEach(se=>me.push(se)),Array.from(new Set(me))};for(const de of x){const ge=String(de.part_description||"").toUpperCase().split(/[^A-Z0-9]+/).filter(tt=>tt.length>=2&&!g.has(tt)).map(K),pe=P[de.part_number]?.count||0,se=j[de.part_number]?.count||0,I=P[de.part_number]?.last||0,W=Date.now(),ce=I?(W-I)/(1e3*60*60*24):365,Z=ce<=7?1:ce<=30?.5:0;let Ae=1+pe*.5+se*.25+Z;T.has(de.part_number)&&(Ae+=3),q.has(de.part_number)&&(Ae+=1);const Ce=d.trim().toUpperCase(),ze=(de.part_number||"").toUpperCase(),Ve=(de.part_description||"").toUpperCase(),ut=Ce&&(ze.startsWith(Ce)||Ve.includes(Ce))?.5:0,it=[];ge.forEach(tt=>{R.has(tt)&&it.push(tt),F(tt,Ae*(1+ut+(Ce&&tt.includes(Ce)?.5:0)))});const pt=Array.from(new Set(ge));pt.forEach(tt=>pt.forEach(Be=>{tt!==Be&&(R.has(tt)||R.has(Be))&&F(`${tt} ${Be}`,Ae*1.2)}));const Ne=ve(ze);Ne.forEach(tt=>F(tt,Ae*1.3)),Ne[0]&&it.slice(0,2).forEach(tt=>F(`${tt} ${Ne[0]}`,Ae*1.5))}return Object.entries(S).sort((de,me)=>me[1]-de[1]).slice(0,24).map(([de])=>de)},[x,m,_,w,P,j,d]),M=x,X=l.useMemo(()=>M.slice(0,200),[M]),H=S=>{f(g=>g.includes(S)?g.filter(T=>T!==S):[...g,S])},U=()=>{u(""),f([]),C([]),y(null)},G=S=>_.includes(S),te=S=>{v(g=>{const T=g.includes(S)?g.filter(q=>q!==S):[S,...g];su("favorites",s,o,T);try{fetch(`/api/part-finder/${s}/favorite`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_number:S,context:o,value:!g.includes(S)})}).catch(()=>{})}catch{}return T})},re=S=>{b(g=>{const T=[S.part_number,...g.filter(q=>q!==S.part_number)].slice(0,20);return su("recents",s,o,T),T}),N(g=>{const T={...g},q=T[S.part_number]||{count:0,last:0};return q.count+=1,q.last=Date.now(),T[S.part_number]=q,Nw(s,o,T),T}),E(g=>{const T={...g},q=T[S.part_number]||{count:0,last:0};return q.count+=1,q.last=Date.now(),T[S.part_number]=q,Mw(T),T}),a(S);try{fetch(`/api/part-finder/${s}/use`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_number:S.part_number,context:o})}).catch(()=>{})}catch{}};return e.jsxs(mt,{open:r,onClose:n,maxWidth:"lg",fullWidth:!0,fullScreen:!1,"aria-labelledby":"part-finder-title",children:[e.jsx(ft,{id:"part-finder-title",children:"Find Part"}),e.jsxs(xt,{dividers:!0,children:[e.jsx(k,{mb:2,children:e.jsxs(k,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[e.jsx(le,{fullWidth:!0,placeholder:"Search by part # or description",value:d,onChange:S=>p(S.target.value),InputProps:{startAdornment:e.jsx(mr,{position:"start",children:e.jsx(Hr,{})})}}),e.jsx(Tw,{onSearchTerms:(S,g)=>{C(S),y(g)},disabled:!1})]})}),null,e.jsxs(k,{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mb:2,children:[!!c&&e.jsx(De,{label:`Prefix: ${c}`,color:"primary",onDelete:()=>u(""),sx:{height:40,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:16,fontWeight:600}}}),m.map(S=>e.jsx(De,{label:S,color:"secondary",onDelete:()=>H(S),sx:{height:38,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:15,fontWeight:600}}},S)),A.length>0&&e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(h,{variant:"caption",color:"text.secondary",children:"Voice:"}),A.map(S=>e.jsx(De,{label:S,color:"success",variant:"outlined",size:"small",sx:{height:32,"& .MuiChip-label":{px:1.5,py:.5,fontSize:12}}},S)),L&&e.jsxs(h,{variant:"caption",color:"text.secondary",sx:{ml:1},children:["(",L.searchInPartNumbers?"Part#":"",L.searchInPartNumbers&&L.searchInDescriptions?" + ":"",L.searchInDescriptions?"Desc":"",")"]})]}),(!!c||m.length>0||A.length>0)&&e.jsx(Q,{onClick:U,children:"Clear All"})]}),e.jsxs(k,{display:"flex",gap:2,mb:2,flexWrap:"wrap",children:[e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:"Part # Starts With"}),e.jsxs(k,{display:"flex",flexWrap:"wrap",gap:1.5,children:[Iw.map(S=>e.jsx(De,{label:S,variant:c.startsWith(S)?"filled":"outlined",onClick:()=>u(S),sx:{height:44,borderRadius:2,"& .MuiChip-label":{px:2.25,py:1.25,fontSize:18,fontWeight:700}}},S)),Ow.map(S=>e.jsx(De,{label:S,variant:c.startsWith(S)?"filled":"outlined",onClick:()=>u(S),sx:{height:44,borderRadius:2,"& .MuiChip-label":{px:2.25,py:1.25,fontSize:18,fontWeight:700}}},S))]})]}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:"Description Tokens"}),e.jsx(k,{display:"flex",flexWrap:"wrap",gap:1.5,children:D.map(S=>e.jsx(De,{label:S,clickable:!0,color:m.includes(S)?"secondary":"default",onClick:()=>H(S),sx:{height:40,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:16,fontWeight:600}}},S))})]})]}),e.jsx(fr,{sx:{my:2}}),e.jsxs(k,{mb:2,children:[_.length>0&&e.jsxs(k,{mb:1,children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:"Favorites for this Sales Order"}),e.jsx(k,{display:"flex",flexWrap:"wrap",gap:1.25,children:_.map(S=>{const g=i.find(T=>T.part_number===S);return g?e.jsx(De,{label:`${g.part_number}`,onClick:()=>re(g),title:g.part_description,sx:{height:38,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:15,fontWeight:600}}},S):null})})]}),w.length>0&&e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:"Recents for this Sales Order"}),e.jsx(k,{display:"flex",flexWrap:"wrap",gap:1.25,children:w.map(S=>{const g=i.find(T=>T.part_number===S);return g?e.jsx(De,{variant:"outlined",label:`${g.part_number}`,onClick:()=>re(g),title:g.part_description,sx:{height:38,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:15,fontWeight:600}}},S):null})})]})]}),e.jsxs(O,{container:!0,spacing:2,children:[X.map(S=>e.jsx(O,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsxs(k,{sx:{border:"1px solid #ddd",borderRadius:1,p:1.5,display:"flex",flexDirection:"column",gap:1,height:"100%"},children:[e.jsxs(k,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(h,{variant:"subtitle1",sx:{fontWeight:700},children:S.part_number}),e.jsx(Ht,{title:G(S.part_number)?"Remove favorite":"Add favorite",children:e.jsx(gt,{size:"small",onClick:()=>te(S.part_number),children:G(S.part_number)?e.jsx(_w,{color:"warning",fontSize:"small"}):e.jsx(yw,{fontSize:"small"})})})]}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{minHeight:40},children:S.part_description||""}),e.jsxs(k,{mt:"auto",display:"flex",gap:1,children:[e.jsx(Q,{variant:"contained",size:"small",onClick:()=>re(S),children:"Add"}),e.jsx(Q,{variant:"outlined",size:"small",onClick:()=>{re(S)},children:"Add & Keep Open"})]})]})},S.part_number)),X.length===0&&e.jsx(O,{item:!0,xs:12,children:e.jsx(h,{variant:"body2",color:"text.secondary",children:"No parts match the current filters."})})]})]}),e.jsx(jt,{children:e.jsx(Q,{onClick:n,children:"Close"})})]})}const au=["Each","cm","ft","kg","pcs","hr","L"],Qi=5,ou=()=>{const{id:t}=jn(),r=Gt(),n=!!t&&/^\d+$/.test(t);console.log("WokerSalesOrderPage: Component rendered with id:",t,"isNumericId:",n),l.useEffect(()=>(console.log("WokerSalesOrderPage: Component mounted"),()=>{console.log("WokerSalesOrderPage: Component unmounted")}),[]);const[a,s]=l.useState(null),[o,i]=l.useState(!0),[c,u]=l.useState(null),[d,p]=l.useState(null),[m,f]=l.useState([]),[_,v]=l.useState([]),[w,b]=l.useState(null),[P,N]=l.useState(null),[j,E]=l.useState([]),[A,C]=l.useState([]),[L,y]=l.useState([]),[x,D]=l.useState([]),M=l.useRef(null),X=l.useRef(0);l.useLayoutEffect(()=>{const _e=M.current,ye=_e?_e.getBoundingClientRect().height:0,we=ye-X.current;we!==0&&(window.scrollBy({top:we,left:0,behavior:"auto"}),X.current=ye)},[L.length]);const[H,U]=l.useState(null),[G,te]=l.useState(null),[re,S]=l.useState(null),[g,T]=l.useState(!1),[q,ee]=l.useState(null),[R,K]=l.useState(""),[F,xe]=l.useState(!1),[ve,de]=l.useState(null),[me,ge]=l.useState(""),[pe,se]=l.useState(!1),[I,W]=l.useState("line"),[ce,Z]=l.useState(0),Ae=_e=>{const ye=[..._].sort((we,fe)=>we.cost_lower_bound-fe.cost_lower_bound);for(const we of ye){const fe=+we.cost_lower_bound,Ee=we.cost_upper_bound==null?null:+we.cost_upper_bound,Ue=+we.margin_factor;if(_e>=fe&&(Ee===null||_e<Ee))return Ue}return 1},Ce=_e=>m.find(ye=>ye.part_number===_e),ze=(_e,ye)=>{const we=m.find(dt=>dt.part_number.toLowerCase()===_e.part_number.toLowerCase());if(!we||we.part_type==="supply")return null;const fe=parseFloat(we.quantity_on_hand)||0,Ee=j.filter(dt=>dt.part_number.toLowerCase()===_e.part_number.toLowerCase()).reduce((dt,ke)=>dt+(parseFloat(String(ke.quantity).replace(/[^\d.-]/g,""))||0),0),Ue=A.filter(dt=>dt.part_number.toLowerCase()===_e.part_number.toLowerCase()).reduce((dt,ke)=>dt+(parseFloat(String(ke.quantity).replace(/[^\d.-]/g,""))||0),0),$e=Ee-Ue,Je=fe-$e,at=Je<0?Math.floor(Je):Math.round(Je);return{available:at,isNegative:at<0,currentStock:fe,changeInQuantity:$e,totalQuantityForPart:Ee,totalOriginalQuantityForPart:Ue}},Ve=(_e,ye)=>{const we=j.filter(Ee=>Ee.part_number.toLowerCase()===_e.part_number.toLowerCase());if(we.length<=1)return!0;const fe=Math.max(...we.map((Ee,Ue)=>j.findIndex($e=>$e.part_number.toLowerCase()===_e.part_number.toLowerCase()&&j.indexOf($e)===Ue)));return ye===fe},ut=l.useMemo(()=>j.map(_e=>({part_number:_e.part_number,part_description:_e.part_description,quantity:on(_e.quantity),unit:_e.unit,unit_price:on(_e.unit_price)})),[j]),it=l.useMemo(()=>ut.reduce((_e,ye)=>_e+_o(ye.quantity,ye.unit_price),0),[ut]),pt=l.useMemo(()=>it*(Qi/100),[it]);l.useMemo(()=>it+pt,[it,pt]);const[Ne,tt]=l.useState("");l.useEffect(()=>{a&&tt(JSON.stringify({lineItems:j,partsToOrder:x}))},[a]);const Be=!!Ne&&Ne!==JSON.stringify({lineItems:j,partsToOrder:x});l.useEffect(()=>{(async()=>{try{const[_e,ye,we,fe]=await Promise.all([B.get("/api/inventory"),B.get("/api/margin-schedule"),B.get("/api/settings/labour-rate").catch(()=>({data:{labour_rate:null}})),B.get("/api/settings/overhead-rate").catch(()=>({data:{overhead_rate:null}}))]);f(_e.data),v(ye.data),b(we.data.labour_rate??null),N(fe.data.overhead_rate??null)}catch(_e){console.error("Prefetch failed",_e)}})()},[]),l.useEffect(()=>{if(console.log("WokerSalesOrderPage: useEffect triggered with id:",t,"isNumericId:",n),!t||!n){console.log("WokerSalesOrderPage: Invalid ID, setting error"),u("Invalid sales order ID."),i(!1);return}(async()=>{console.log("WokerSalesOrderPage: Fetching sales order data for ID:",t),i(!0),u(null);try{console.log("WokerSalesOrderPage: Making API call to /api/sales-orders/${id}");const _e=await B.get(`/api/sales-orders/${t}`);if(console.log("WokerSalesOrderPage: API response received:",_e),console.log("WokerSalesOrderPage: API response data:",_e.data),!_e.data||!_e.data.salesOrder){console.error("WokerSalesOrderPage: No sales order data in response"),u("Invalid response format from server"),i(!1);return}const ye=_e.data.salesOrder;console.log("WokerSalesOrderPage: Parsed sales order:",ye),s({sales_order_id:ye.sales_order_id,sales_order_number:ye.sales_order_number,status:ye.status});const we=(_e.data.lineItems||ye?.line_items||[]).filter(Ee=>!["LABOUR","OVERHEAD","SUPPLY"].includes(Ee.part_number?.toUpperCase())).map(Ee=>({line_item_id:Ee.line_item_id,part_number:Ee.part_number,part_description:Ee.part_description,unit:Ee.unit,unit_price:Ee.unit_price,line_amount:Ee.line_amount,quantity:String(Ee.quantity_sold??Ee.quantity??0),gst:Qi,part_id:Ee.part_id??void 0}));console.log("WokerSalesOrderPage: Loaded line items (filtered):",we),E(we),C(we);const fe=(_e.data.partsToOrder||[]).map(Ee=>({sales_order_id:ye.sales_order_id,part_number:Ee.part_number,part_description:Ee.part_description,quantity_to_order:String(Ee.quantity_needed??Ee.quantity_to_order??""),unit:Ee.unit||"Each",unit_price:Number(Ee.unit_price||0),line_amount:Number(Ee.line_amount||0)}));console.log("WokerSalesOrderPage: Loaded parts to order:",fe),D(fe),console.log("WokerSalesOrderPage: Successfully loaded sales order data")}catch(_e){console.error("WokerSalesOrderPage: Error loading sales order:",_e),console.error("WokerSalesOrderPage: Error details:",{message:_e?.message,status:_e?.response?.status,statusText:_e?.response?.statusText,data:_e?.response?.data,url:_e?.config?.url}),u(_e?.response?.status===404?"Sales order not found. It may have been deleted.":"Failed to load sales order data. Please try again.")}finally{i(!1)}})()},[t,n]),l.useEffect(()=>{w!==null&&E(_e=>_e.map(ye=>ye.part_number==="LABOUR"?{...ye,unit_price:w}:ye))},[w]),l.useEffect(()=>{P!==null&&E(_e=>_e.map(ye=>ye.part_number==="OVERHEAD"?{...ye,unit_price:P}:ye))},[P]),l.useEffect(()=>{const _e=[];j.forEach((ye,we)=>{if(Ve(ye,we)){const fe=ze(ye);fe&&fe.available<0&&_e.push({lineItemIndex:we,partNumber:ye.part_number,partDescription:ye.part_description,excessQuantity:Math.abs(fe.available),unit:ye.unit})}}),y(_e)},[j,m]);const wt=(_e,ye)=>{E(we=>{const fe=[...we];if(!ye||ye.trim()==="")fe[_e]={...fe[_e],part_number:"",part_description:"",quantity:"",unit:au[0],unit_price:0,line_amount:0};else{const $e=Ce(ye);if($e){const Je=parseFloat(String($e.last_unit_cost))||0,at=Ae(Je);fe[_e]={...fe[_e],part_number:ye,part_description:$e.part_description||"",unit:$e.unit||"Each",unit_price:Je*at}}else fe[_e]={...fe[_e],part_number:ye,part_description:"Part not found",unit_price:0}}const Ee=on(fe[_e].quantity),Ue=on(fe[_e].unit_price);return fe[_e].line_amount=_o(Ee,Ue),fe})},zt=(_e,ye,we)=>{E(fe=>{const Ee=[...fe],Ue={...Ee[_e],[ye]:we};if(parseFloat(we)<=0)return Ee.filter((at,dt)=>dt!==_e);const $e=on(Ue.quantity),Je=on(Ue.unit_price);return Ue.line_amount=_o($e,Je),Ee[_e]=Ue,Ee})},Bt=()=>{E(_e=>[..._e,{part_number:"",part_description:"",quantity:"",unit:au[0],unit_price:0,gst:Qi,line_amount:0}])},We=_e=>{E(ye=>ye.filter((we,fe)=>fe!==_e))},Qt=()=>{if(j.filter(fe=>!fe.part_number||fe.part_number.trim()==="").length>0)return z.error("Line items with blank part numbers are not allowed."),!1;const ye=j.filter(fe=>{if(["LABOUR","OVERHEAD","SUPPLY"].includes(String(fe.part_number).toUpperCase()))return!1;const Ee=fe.part_id;if(Ee){const $e=(m||[]).find(Je=>Je.part_id===Ee);return $e?$e.part_type==="supply":!1}const Ue=(m||[]).find($e=>String($e.part_number).toUpperCase()===String(fe.part_number).trim().toUpperCase());return!Ue||Ue.part_type==="supply"});if(ye.length>0){const fe=ye.map(Ee=>Ee.part_number).join(", ");return z.error(`Invalid or supply parts (not allowed): ${fe}`),!1}return j.some((fe,Ee)=>{if(!Ve(fe,Ee))return!1;const Ue=ze(fe);return Ue&&Ue.available<0})?(z.error("Insufficient inventory for one or more parts."),!1):!0},Kt=_e=>{const ye=_e.reduce((we,fe)=>{const Ee=fe.part_number.trim().toLowerCase();if(!we[Ee]){const $e=["LABOUR","OVERHEAD","SUPPLY"].includes(fe.part_number.toUpperCase())?null:(m||[]).find(Je=>String(Je.part_number).toUpperCase()===fe.part_number.trim().toUpperCase());we[Ee]={part_number:fe.part_number.trim(),part_description:fe.part_description.trim(),unit:fe.unit.trim(),unit_price:fe.unit_price!=null?Number(fe.unit_price):0,line_amount:0,quantity_sold:0,...fe.part_id?{part_id:fe.part_id}:$e&&$e.part_id?{part_id:$e.part_id}:{}}}const Ue=parseFloat(String(fe.quantity).replace(/[^\d.-]/g,""))||0;return we[Ee].quantity_sold+=Math.round(Ue),we[Ee].line_amount+=Ue*(fe.unit_price||0),we},{});return Object.values(ye)},Wt=async()=>{if(a&&Qt())try{const _e={lineItems:Kt(j),partsToOrder:x.filter(ye=>ye.part_number&&parseFloat(String(ye.quantity_to_order))>0).map(ye=>({sales_order_id:a.sales_order_id,part_number:ye.part_number.trim(),part_description:ye.part_description.trim(),quantity_needed:parseFloat(String(ye.quantity_to_order))||0,unit:ye.unit.trim(),unit_price:ye.unit_price,line_amount:ye.line_amount}))};await B.put(`/api/sales-orders/${a.sales_order_id}`,_e),p("Sales Order updated successfully!"),tt(JSON.stringify({lineItems:j,partsToOrder:x}));try{const ye=await B.get("/api/inventory");f(ye.data)}catch{}}catch(_e){const ye=_e?.response?.data?.error||_e?.response?.data?.details||_e?.response?.data?.message||"Failed to save sales order.";z.error(ye)}},tr=(_e,ye)=>{const we=(j[_e]?.part_number||"").trim(),fe=ye.key==="Enter",Ee=ye.key==="Tab",Ue=ye.key==="Escape",$e=ye.key==="ArrowDown"||ye.key==="ArrowUp";if(Ue){U(null);return}if($e){ye.key==="ArrowDown"&&H!==_e&&U(_e);return}if(!(H===_e&&(fe||Ee))&&(fe||Ee)&&we){if(fe&&ye.ctrlKey){ye.preventDefault(),K(we.toUpperCase()),ee(_e),T(!0),U(null);return}!m.find(at=>at.part_number.toUpperCase()===we.toUpperCase())&&fe&&(ye.preventDefault(),K(we.toUpperCase()),ee(_e),T(!0),U(null))}},yr=(_e,ye)=>{const we=(x[_e]?.part_number||"").trim(),fe=ye.key==="Enter",Ee=ye.key==="Tab",Ue=ye.key==="Escape",$e=ye.key==="ArrowDown"||ye.key==="ArrowUp";if(Ue){te(null);return}if($e){ye.key==="ArrowDown"&&G!==_e&&te(_e);return}if(!(G===_e&&(fe||Ee))&&(fe||Ee)&&we){if(fe&&ye.ctrlKey){ye.preventDefault(),ge(we.toUpperCase()),de(_e),xe(!0),te(null);return}!m.find(at=>at.part_number.toUpperCase()===we.toUpperCase())&&fe&&(ye.preventDefault(),ge(we.toUpperCase()),de(_e),xe(!0),te(null))}};return o?e.jsxs(nt,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(ot,{}),e.jsx(h,{children:"Loading sales order..."})]}):c?e.jsxs(nt,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(Fe,{severity:"error",sx:{mb:2},children:c}),e.jsx(Q,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Retry"}),e.jsx(Q,{variant:"outlined",onClick:()=>r("/open-sales-orders"),children:"Back to Sales Orders"})]}):a?e.jsxs(bn,{dateAdapter:os,children:[e.jsx(ji,{when:Be,onSave:Wt}),e.jsxs(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{position:"relative",zIndex:1},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(h,{variant:"h5",sx:{fontWeight:700},children:["Edit Lines & Parts to Order  SO ",a.sales_order_number||a.sales_order_id]}),e.jsx(Q,{variant:"contained",onClick:Wt,children:"Save Changes"})]}),e.jsx(h,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"Line Items"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"You can add multiple line items with the same part number. They will be automatically merged on save."})]}),e.jsx(k,{ref:M,sx:{mb:L.length?2:0,display:L.length?"flex":"none",flexDirection:"column",gap:1},children:L.map((_e,ye)=>{const we=j[_e.lineItemIndex];return!we||!Ve(we,_e.lineItemIndex)?null:e.jsx(Fe,{severity:"warning",sx:{width:"100%",boxShadow:2,"& .MuiAlert-message":{width:"100%",padding:0}},children:e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",sx:{width:"100%"},children:[e.jsxs(k,{sx:{flex:1},children:[e.jsxs(h,{variant:"body2",fontWeight:"medium",children:["Insufficient stock for ",_e.partNumber]}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Excess quantity: ",_e.excessQuantity," ",_e.unit]})]}),e.jsxs(Q,{variant:"contained",size:"small",sx:{whiteSpace:"nowrap"},onClick:()=>{const fe=_e.excessQuantity,Ee=m.find(Je=>Je.part_number.toLowerCase()===we.part_number.toLowerCase()),Ue={sales_order_id:a.sales_order_id,part_number:we.part_number,part_description:we.part_description,quantity_to_order:String(fe),unit:we.unit,unit_price:Ee?.last_unit_cost||0,line_amount:(Ee?.last_unit_cost||0)*fe};D(Je=>[...Je,Ue]);const $e=Math.max(0,(parseFloat(String(we.quantity).replace(/[^\d.-]/g,""))||0)-fe);E(Je=>Je.map((at,dt)=>dt===_e.lineItemIndex?{...at,quantity:String($e)}:at)),y(Je=>Je.filter(at=>at.lineItemIndex!==_e.lineItemIndex)),z.success(`Transferred ${fe} ${we.unit} of ${we.part_number} to parts to order`)},children:["Transfer ",_e.excessQuantity," to Parts to Order"]})]})},`${_e.lineItemIndex}-${ye}`)})}),e.jsxs(Me,{sx:{p:3,mb:3},elevation:3,children:[e.jsx(O,{container:!0,spacing:2,children:j.map((_e,ye)=>e.jsxs(Dt.Fragment,{children:[e.jsxs(O,{item:!0,xs:12,sm:6,md:3.5,children:[e.jsx(zr,{open:H===ye,onOpen:()=>U(ye),onClose:()=>U(null),autoHighlight:!0,inputValue:_e.part_number,onChange:(we,fe)=>{if(typeof fe=="string")wt(ye,fe),U(null);else if(fe&&typeof fe=="object"&&"isNew"in fe){const Ee=fe.inputValue||"";K(String(Ee).toUpperCase()),ee(ye),T(!0),U(null)}},onInputChange:(we,fe,Ee)=>{if(E($e=>{const Je=[...$e];return Je[ye]={...Je[ye],part_number:(fe||"").toUpperCase()},Je}),re&&window.clearTimeout(re),Ee==="reset")return;if((fe||"").trim().length>0){const $e=window.setTimeout(()=>U(ye),200);S($e)}else U(null)},options:m.filter(we=>we.part_type!=="supply").map(we=>we.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,handleHomeEndKeys:!0,filterOptions:(we,fe)=>{const Ee=(fe.inputValue||"").toUpperCase(),Ue=we.filter(at=>{const dt=m.find(ke=>ke.part_number===at);return dt?String(at).toUpperCase().includes(Ee)||String(dt.part_description||"").toUpperCase().includes(Ee):String(at).toUpperCase().includes(Ee)}),$e=Ue.some(at=>String(at).toUpperCase()===Ee),Je=[...Ue];return Ee&&!$e&&Je.push({label:`Add "${fe.inputValue}" as New Part`,isNew:!0,inputValue:fe.inputValue}),Je},renderOption:(we,fe)=>{const Ee=typeof fe=="object"&&fe.isNew,Ue=typeof fe=="string"?fe:fe.label,{key:$e,...Je}=we;return e.jsxs("li",{...Je,children:[Ee&&e.jsx(Mn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof fe=="string"?e.jsxs(k,{children:[e.jsx(h,{variant:"body2",children:fe}),(()=>{const at=m.find(dt=>dt.part_number===fe);return at?.part_description?e.jsx(h,{variant:"caption",color:"text.secondary",children:at.part_description}):null})()]}):Ue]},$e)},renderInput:we=>e.jsx(le,{...we,label:"Part Number",required:!0,fullWidth:!0,onKeyDown:fe=>tr(ye,fe),onBlur:()=>U(null)}),onBlur:()=>{const we=j[ye]?.part_number?.trim().toUpperCase();if(!we)return;m.find(Ee=>Ee.part_number===we)?wt(ye,we):(ee(ye),K(we),T(!0),U(null))}}),e.jsx(k,{mt:1,children:e.jsx(Q,{size:"small",variant:"outlined",onClick:()=>{W("line"),Z(ye),se(!0)},children:"Find Part"})})]}),e.jsx(O,{item:!0,xs:12,sm:6,md:3.5,children:e.jsx(le,{label:"Part Description",value:_e.part_description,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Qty",value:_e.quantity,onChange:we=>zt(ye,"quantity",we.target.value),type:"number",fullWidth:!0,required:!0,inputProps:{step:1,onWheel:we=>we.target.blur()}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Avail",value:(()=>{if(!Ve(_e,ye))return"N/A";const we=ze(_e);return we?we.available<0?`${we.available} (Insufficient)`:String(we.available):"N/A"})(),fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:(()=>{if(!Ve(_e,ye))return"#f5f5f5";const we=ze(_e);return we?we.available>=0?"#e8f5e8":"#ffeaea":"#f5f5f5"})(),"& .MuiInputBase-input":{color:Ve(_e,ye)?ze(_e)?.isNegative?"#d32f2f":"#2e7d32":"#666"}}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Unit",value:_e.unit,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1,sx:{display:"flex",alignItems:"stretch"},children:e.jsx(Q,{variant:"outlined",color:"primary",onClick:()=>We(ye),fullWidth:!0,sx:{height:"56px"},children:"Remove"})})]},ye))}),e.jsx(k,{sx:{mt:2},children:e.jsx(Q,{variant:"outlined",color:"primary",onClick:Bt,children:"Add Line Item"})})]}),e.jsxs(Me,{sx:{p:3,mb:3,border:"2px solid #b8860b","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"#b8860b"},"&:hover fieldset":{borderColor:"#b8860b"}}},elevation:0,children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Parts to Order"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Add parts that need to be ordered for this sales order. These quantities are aggregated across all sales orders."}),e.jsx(O,{container:!0,spacing:2,children:x.map((_e,ye)=>e.jsxs(Dt.Fragment,{children:[e.jsxs(O,{item:!0,xs:12,sm:6,md:3.5,children:[e.jsx(zr,{open:G===ye,onOpen:()=>te(ye),onClose:()=>te(null),autoHighlight:!0,value:_e.part_number,onChange:(we,fe)=>{if(!fe){D(Ee=>{const Ue=[...Ee];return Ue[ye]={...Ue[ye],part_number:"",part_description:"",unit:"Each",unit_price:0,line_amount:0},Ue});return}if(typeof fe=="string"){const Ee=m.find(Ue=>Ue.part_number===fe);if(Ee){const Ue=parseFloat(String(Ee.last_unit_cost))||0,$e=Ae(Ue),Je=Ue*$e;D(at=>{const dt=[...at];return dt[ye]={...dt[ye],part_number:Ee.part_number,part_description:Ee.part_description,unit:Ee.unit||"Each",unit_price:Je,line_amount:0},dt})}else{D($e=>{const Je=[...$e];return Je[ye]={...Je[ye],part_number:fe,part_description:"",unit:"Each",unit_price:0,line_amount:0},Je});const Ue=String(fe).toUpperCase();de(ye),ge(Ue),xe(!0)}}else if(fe&&typeof fe=="object"&&"isNew"in fe){const Ee=String(fe.inputValue||"").toUpperCase();de(ye),ge(Ee),xe(!0)}},onInputChange:(we,fe,Ee)=>{if(D($e=>{const Je=[...$e];return Je[ye]={...Je[ye],part_number:(fe||"").toUpperCase()},Je}),re&&window.clearTimeout(re),Ee==="reset")return;if((fe||"").trim().length>0){const $e=window.setTimeout(()=>te(ye),200);S($e)}else te(null)},options:m.filter(we=>we.part_type!=="supply").map(we=>we.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,filterOptions:(we,fe)=>{const Ee=(fe.inputValue||"").toUpperCase(),Ue=we.filter(at=>{const dt=m.find(ke=>ke.part_number===at);return dt?String(at).toUpperCase().includes(Ee)||String(dt.part_description||"").toUpperCase().includes(Ee):String(at).toUpperCase().includes(Ee)}),$e=Ue.some(at=>String(at).toUpperCase()===Ee),Je=[...Ue];return Ee&&!$e&&Je.push({label:`Add "${fe.inputValue}" as New Part`,isNew:!0,inputValue:fe.inputValue}),Je},renderOption:(we,fe)=>{const Ee=typeof fe=="object"&&fe.isNew,Ue=typeof fe=="string"?fe:fe.label,{key:$e,...Je}=we;return e.jsxs("li",{...Je,children:[Ee&&e.jsx(Mn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof fe=="string"?e.jsxs(k,{children:[e.jsx(h,{variant:"body2",children:fe}),(()=>{const at=m.find(dt=>dt.part_number===fe);return at?.part_description?e.jsx(h,{variant:"caption",color:"text.secondary",children:at.part_description}):null})()]}):Ue]},$e)},renderInput:we=>e.jsx(le,{...we,label:"Part Number",fullWidth:!0,required:!0,onKeyDown:fe=>yr(ye,fe),onBlur:()=>te(null)}),onBlur:()=>{const we=(x[ye]?.part_number||"").trim().toUpperCase();if(!we)return;m.find(Ee=>Ee.part_number===we)||(de(ye),ge(we),xe(!0),te(null))}}),e.jsx(k,{mt:1,children:e.jsx(Q,{size:"small",variant:"outlined",onClick:()=>{W("pto"),Z(ye),se(!0)},children:"Find Part"})})]}),e.jsx(O,{item:!0,xs:12,sm:6,md:3.5,children:e.jsx(le,{label:"Description",value:_e.part_description,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#f5f5f5"}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Qty to Order",value:_e.quantity_to_order,onChange:we=>{const fe=we.target.value;D(Ee=>{const Ue=[...Ee],$e=parseFloat(fe)||0,Je=Ue[ye].unit_price||0;return Ue[ye]={...Ue[ye],quantity_to_order:fe,line_amount:$e*Je},Ue})},type:"number",fullWidth:!0,required:!0,inputProps:{step:1,min:0,onWheel:we=>we.target.blur()}})}),e.jsx(O,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Unit",value:_e.unit,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(O,{item:!0,xs:12,sm:1,md:1,sx:{display:"flex",alignItems:"stretch",gap:2},children:e.jsx(Q,{variant:"outlined",onClick:()=>D(we=>we.filter((fe,Ee)=>Ee!==ye)),sx:{height:"56px",flexShrink:0,borderColor:"#b8860b",color:"#b8860b","&:hover":{borderColor:"#8b6914",backgroundColor:"#fff8dc"}},children:"Remove"})})]},ye))}),e.jsx(k,{sx:{mt:2},children:e.jsx(Q,{variant:"outlined",color:"primary",onClick:()=>D(_e=>[..._e,{sales_order_id:a.sales_order_id,part_number:"",part_description:"",quantity_to_order:"",unit:"Each",unit_price:0,line_amount:0}]),children:"Add Parts to Order Item"})})]}),e.jsxs(k,{display:"flex",justifyContent:"flex-end",gap:2,children:[e.jsx(Q,{variant:"outlined",onClick:()=>r(`/open-sales-orders/${a.sales_order_id}`),children:"Back to SO"}),e.jsx(Q,{variant:"contained",onClick:Wt,children:"Save Changes"})]}),e.jsx(vn,{open:!!d,autoHideDuration:6e3,onClose:()=>p(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Fe,{onClose:()=>p(null),severity:"success",sx:{width:"100%"},children:d})})]}),e.jsx(ns,{open:g,onClose:()=>{T(!1),ee(null),K("")},onSave:async _e=>{const ye=await B.post("/api/inventory",_e),we=await B.get("/api/inventory");f(we.data);const fe=ye.data.item;q!==null&&E(Ee=>{const Ue=[...Ee],$e=parseFloat(String(fe.last_unit_cost))||0,Je=Ae($e),at=$e*Je;Ue[q]={...Ue[q],part_number:fe.part_number,part_description:fe.part_description,unit:fe.unit||Ue[q].unit,unit_price:at};const dt=on(Ue[q].quantity);return Ue[q].line_amount=_o(dt,at),Ue})},title:"Add New Part",initialPart:{part_number:R.toUpperCase(),category:"Uncategorized"}}),e.jsx(Lw,{open:pe,onClose:()=>se(!1),onSelect:_e=>{if(a)if(I==="line"){const ye=ce;E(we=>{const fe=[...we];return fe[ye]?(fe[ye]={...fe[ye],part_number:_e.part_number,part_description:_e.part_description},fe):we})}else{const ye=ce;D(we=>{const fe=[...we];return fe[ye]?(fe[ye]={...fe[ye],part_number:_e.part_number,part_description:_e.part_description},fe):we})}},salesOrderId:a?.sales_order_id||0,context:I,inventoryItems:m.map(_e=>({part_number:_e.part_number,part_description:_e.part_description}))}),e.jsx(ns,{open:F,onClose:()=>{xe(!1),de(null),ge("")},onSave:async _e=>{const ye=await B.post("/api/inventory",_e),we=await B.get("/api/inventory");f(we.data);const fe=ye.data.item;ve!==null&&D(Ee=>{const Ue=[...Ee],$e=parseFloat(String(fe.last_unit_cost))||0,Je=Ae($e),at=$e*Je;Ue[ve]={...Ue[ve],part_number:fe.part_number,part_description:fe.part_description,unit:fe.unit||"Each",unit_price:at};const dt=parseFloat(String(Ue[ve].quantity_to_order))||0;return Ue[ve].line_amount=dt*at,Ue})},title:"Add New Part",initialPart:{part_number:me.toUpperCase(),category:"Uncategorized"}})]}):null},Zo=t=>new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString(),hh=()=>crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,Vl=async()=>{try{const t=await B.get("/api/time-tracking/profiles");return localStorage.setItem("tt_profiles_cache",JSON.stringify(t.data)),t.data}catch{const r=localStorage.getItem("tt_profiles_cache");return r?JSON.parse(r):[]}},qw=async(t,r)=>(await B.post("/api/time-tracking/profiles",{name:t,email:r})).data,mh=async()=>{try{const t=await B.get("/api/time-tracking/sales-orders");return localStorage.setItem("tt_sales_orders_cache",JSON.stringify(t.data)),t.data}catch{const r=localStorage.getItem("tt_sales_orders_cache");return r?JSON.parse(r):[]}},Uw=async(t,r)=>{const n={date:t};return r&&(n.profile_id=r),(await B.get("/api/time-tracking/time-entries",{params:n})).data},Fw=async(t,r)=>{try{return(await B.post("/api/time-tracking/time-entries/clock-in",{profile_id:t,so_id:r})).data}catch{const a={event_id:hh(),user_id:t,device_id:localStorage.getItem("deviceId")||"unknown-device",type:"time_clock_in",timestamp_utc:Zo(new Date),payload_json:JSON.stringify({profile_id:t,so_id:r}),created_at:Zo(new Date)};return await window?.api?.timeEvents?.insert?.(a),{id:-Math.floor(Math.random()*1e9),profile_id:t,profile_name:"",sales_order_id:r,sales_order_number:"",clock_in:new Date().toISOString(),clock_out:null,duration:null,unit_price:0,__pending:!0,__pending_event_id:a.event_id}}},Ww=async t=>{try{return(await B.post(`/api/time-tracking/time-entries/${t}/clock-out`)).data}catch{const n={event_id:hh(),device_id:localStorage.getItem("deviceId")||"unknown-device",type:"time_clock_out",timestamp_utc:Zo(new Date),payload_json:JSON.stringify({id:t}),created_at:Zo(new Date)};return await window?.api?.timeEvents?.insert?.(n),{id:t,clock_out:new Date().toISOString(),__pending:!0,__pending_event_id:n.event_id}}},$w=async(t,r,n)=>(await B.put(`/api/time-tracking/time-entries/${t}`,{clock_in:r,clock_out:n})).data,zw=async t=>{await B.delete(`/api/time-tracking/time-entries/${t}`)},Bw=async(t,r,n,a)=>(await B.post("/api/time-tracking/time-entries/manual",{profile_id:t,sales_order_id:r,clock_in:n,clock_out:a})).data,Hw=async(t,r,n,a)=>(await B.get("/api/time-tracking/reports/time-entries",{params:{from:t,to:r,profile:n,so:a}})).data,Yw=async(t,r,n,a,s="csv")=>(await B.get("/api/time-tracking/reports/time-entries/export",{params:{from:t,to:r,profile:n,so:a,format:s},responseType:"blob"})).data,Vw=async t=>(await B.get("/api/time-tracking/time-entries/open",{params:{profile_id:t}})).data,Gw=()=>{const{user:t}=er(),[r,n]=l.useState([]),[a,s]=l.useState([]),[o,i]=l.useState([]),[c,u]=l.useState(""),[d,p]=l.useState(""),[m,f]=l.useState(!0),[_,v]=l.useState(null),[w,b]=l.useState(null),P=l.useRef(null),N=y=>{P.current&&window.clearTimeout(P.current),b(y),P.current=window.setTimeout(()=>{b(null),P.current=null},2500)};l.useEffect(()=>()=>{P.current&&window.clearTimeout(P.current)},[]),l.useEffect(()=>{j()},[]),l.useEffect(()=>{c?E():i([])},[c]),l.useEffect(()=>{const y=setInterval(()=>{i(x=>x.map(D=>{if(!D.clock_out){const M=new Date,X=new Date(D.clock_in),H=(M.getTime()-X.getTime())/(1e3*60*60);return{...D,duration:H}}return D}))},1e3);return()=>clearInterval(y)},[]);const j=async()=>{try{f(!0);const[y,x]=await Promise.all([Vl(),mh()]);console.log("Sales orders data received:",x),n(y),s(x),v(null)}catch(y){v("Failed to fetch data. Please try again."),console.error("Error fetching data:",y)}finally{f(!1)}},E=async()=>{if(c)try{const[y,x]=await Promise.all([Uw(new Date().toISOString().split("T")[0],c),Vw(c)]),D=new Map;[...y,...x].forEach(M=>{D.set(M.id,M)}),i(Array.from(D.values()))}catch(y){v("Failed to fetch time entries. Please try again."),console.error("Error fetching time entries:",y)}},A=async()=>{if(!c||!d){v("Please select both a profile and a sales order");return}if(o.find(x=>x.sales_order_id===d&&!x.clock_out)){v("You are already clocked in for this sales order");return}try{const x=await Fw(c,d);i([x,...o]),u(""),p(""),i([]),v(null),N("Successfully clocked in.")}catch(x){x.response&&x.response.data&&x.response.data.error.includes("attendance")?v("You must clock in for attendance before you can clock in for a sales order."):v("Failed to clock in. Please try again."),console.error("Error clocking in:",x)}},C=async y=>{try{const x=await Ww(y);i(o.map(D=>D.id===y?x:D)),u(""),p(""),i([]),v(null),N("Successfully clocked out.")}catch(x){v("Failed to clock out. Please try again."),console.error("Error clocking out:",x)}},L=c&&o.some(y=>y.profile_id===c&&!y.clock_out);return m?e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(ot,{})}):e.jsxs(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Time Tracking"}),_&&e.jsx(Fe,{severity:"error",sx:{mb:2},children:_}),e.jsxs(mt,{open:!!w,onClose:()=>b(null),PaperProps:{sx:{px:6,py:4,textAlign:"center"}},children:[e.jsx(ft,{sx:{fontSize:"2rem"},children:"Success"}),e.jsx(xt,{children:e.jsx(h,{variant:"h4",component:"p",children:w})})]}),e.jsxs(O,{container:!0,spacing:3,children:[e.jsx(O,{item:!0,xs:12,md:6,children:e.jsxs(Me,{sx:{p:2},children:[e.jsx(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:e.jsx(h,{variant:"h6",children:"Profile"})}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Select Profile"}),e.jsx(Ut,{value:c,label:"Select Profile",onChange:y=>u(y.target.value),sx:{"& .MuiSelect-select":{fontSize:"1.1rem"}},children:r.map(y=>e.jsx(Ze,{value:y.id,sx:{fontSize:"1.1rem"},children:y.name},y.id))})]})]})}),c&&e.jsx(O,{item:!0,xs:12,md:6,children:e.jsxs(Me,{sx:{p:2},children:[e.jsx(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:e.jsx(h,{variant:"h6",children:"Sales Order"})}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Select Sales Order"}),e.jsx(Ut,{value:d,label:"Select Sales Order",onChange:y=>p(y.target.value),sx:{"& .MuiSelect-select":{fontSize:"1.1rem"}},children:a.map(y=>{const x=o.some(D=>D.sales_order_id===y.id&&!D.clock_out);return e.jsxs(Ze,{value:y.id,disabled:x,sx:{fontSize:"1.1rem"},children:[y.number," - ",y.product_name||"No Product Name",x?" - Already Clocked In":""]},y.id)})})]})]})}),c&&d&&e.jsx(O,{item:!0,xs:12,children:e.jsx(Me,{sx:{p:2},children:e.jsx(k,{display:"flex",justifyContent:"center",gap:2,children:e.jsx(Q,{variant:"contained",sx:{backgroundColor:"green","&:hover":{backgroundColor:"darkgreen"}},onClick:A,disabled:L,children:"Clock In"})})})}),c&&e.jsx(O,{item:!0,xs:12,children:e.jsxs(Me,{sx:{p:2},children:[e.jsxs(h,{variant:"h6",gutterBottom:!0,children:["Today's Time Entries for ",r.find(y=>y.id===c)?.name]}),e.jsx(dr,{children:e.jsxs(ir,{children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Sales Order"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Clock In"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Clock Out"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Duration"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Actions"})]})}),e.jsx(cr,{children:o.map(y=>e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.1rem"},children:y.sales_order_number}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:new Date(y.clock_in).toLocaleTimeString()}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:y.clock_out?new Date(y.clock_out).toLocaleTimeString():"-"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:y.duration!==null&&y.duration!==void 0&&!isNaN(Number(y.duration))?`${Number(y.duration).toFixed(3)} hrs`:"-"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:!y.clock_out&&e.jsx(Q,{variant:"contained",sx:{backgroundColor:"red","&:hover":{backgroundColor:"darkred"}},onClick:()=>C(y.id),children:"Clock Out"})})]},y.id))})]})})]})})]})]})};var wo={exports:{}},iu;function Qw(){return iu||(iu=1,function(t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=void 0;var n=function(u,d){switch(u){case"P":return d.date({width:"short"});case"PP":return d.date({width:"medium"});case"PPP":return d.date({width:"long"});case"PPPP":default:return d.date({width:"full"})}},a=function(u,d){switch(u){case"p":return d.time({width:"short"});case"pp":return d.time({width:"medium"});case"ppp":return d.time({width:"long"});case"pppp":default:return d.time({width:"full"})}},s=function(u,d){var p=u.match(/(P+)(p+)?/)||[],m=p[1],f=p[2];if(!f)return n(u,d);var _;switch(m){case"P":_=d.dateTime({width:"short"});break;case"PP":_=d.dateTime({width:"medium"});break;case"PPP":_=d.dateTime({width:"long"});break;case"PPPP":default:_=d.dateTime({width:"full"});break}return _.replace("{{date}}",n(m,d)).replace("{{time}}",a(f,d))},o={p:a,P:s},i=o;r.default=i,t.exports=r.default}(wo,wo.exports)),wo.exports}var Kw=Qw();const Jw=st(Kw),Xw={y:{sectionType:"year",contentType:"digit",maxLength:4},yy:"year",yyy:{sectionType:"year",contentType:"digit",maxLength:4},yyyy:"year",M:{sectionType:"month",contentType:"digit",maxLength:2},MM:"month",MMMM:{sectionType:"month",contentType:"letter"},MMM:{sectionType:"month",contentType:"letter"},L:{sectionType:"month",contentType:"digit",maxLength:2},LL:"month",LLL:{sectionType:"month",contentType:"letter"},LLLL:{sectionType:"month",contentType:"letter"},d:{sectionType:"day",contentType:"digit",maxLength:2},dd:"day",do:{sectionType:"day",contentType:"digit-with-letter"},E:{sectionType:"weekDay",contentType:"letter"},EE:{sectionType:"weekDay",contentType:"letter"},EEE:{sectionType:"weekDay",contentType:"letter"},EEEE:{sectionType:"weekDay",contentType:"letter"},EEEEE:{sectionType:"weekDay",contentType:"letter"},i:{sectionType:"weekDay",contentType:"digit",maxLength:1},ii:"weekDay",iii:{sectionType:"weekDay",contentType:"letter"},iiii:{sectionType:"weekDay",contentType:"letter"},e:{sectionType:"weekDay",contentType:"digit",maxLength:1},ee:"weekDay",eee:{sectionType:"weekDay",contentType:"letter"},eeee:{sectionType:"weekDay",contentType:"letter"},eeeee:{sectionType:"weekDay",contentType:"letter"},eeeeee:{sectionType:"weekDay",contentType:"letter"},c:{sectionType:"weekDay",contentType:"digit",maxLength:1},cc:"weekDay",ccc:{sectionType:"weekDay",contentType:"letter"},cccc:{sectionType:"weekDay",contentType:"letter"},ccccc:{sectionType:"weekDay",contentType:"letter"},cccccc:{sectionType:"weekDay",contentType:"letter"},a:"meridiem",aa:"meridiem",aaa:"meridiem",H:{sectionType:"hours",contentType:"digit",maxLength:2},HH:"hours",h:{sectionType:"hours",contentType:"digit",maxLength:2},hh:"hours",m:{sectionType:"minutes",contentType:"digit",maxLength:2},mm:"minutes",s:{sectionType:"seconds",contentType:"digit",maxLength:2},ss:"seconds"},Zw={year:"yyyy",month:"LLLL",monthShort:"MMM",dayOfMonth:"d",weekday:"EEEE",weekdayShort:"EEEEEE",hours24h:"HH",hours12h:"hh",meridiem:"aa",minutes:"mm",seconds:"ss",fullDate:"PP",fullDateWithWeekday:"PPPP",keyboardDate:"P",shortDate:"MMM d",normalDate:"d MMMM",normalDateWithWeekday:"EEE, MMM d",monthAndYear:"LLLL yyyy",monthAndDate:"MMMM d",fullTime:"p",fullTime12h:"hh:mm aa",fullTime24h:"HH:mm",fullDateTime:"PP p",fullDateTime12h:"PP hh:mm aa",fullDateTime24h:"PP HH:mm",keyboardDateTime:"P p",keyboardDateTime12h:"P hh:mm aa",keyboardDateTime24h:"P HH:mm"};class eS{constructor(r){this.isMUIAdapter=!0,this.isTimezoneCompatible=!1,this.lib="date-fns",this.locale=void 0,this.formats=void 0,this.formatTokenMap=Xw,this.escapedCharacters={start:"'",end:"'"},this.longFormatters=void 0,this.date=o=>typeof o>"u"?new Date:o===null?null:new Date(o),this.dateWithTimezone=o=>this.date(o),this.getTimezone=()=>"default",this.setTimezone=o=>o,this.toJsDate=o=>o,this.getCurrentLocaleCode=()=>{var o;return((o=this.locale)==null?void 0:o.code)||"en-US"},this.is12HourCycleInCurrentLocale=()=>this.locale?/a/.test(this.locale.formatLong.time({width:"short"})):!0,this.expandFormat=o=>{const i=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g;return o.match(i).map(c=>{const u=c[0];if(u==="p"||u==="P"){const d=this.longFormatters[u];return d(c,this.locale.formatLong)}return c}).join("")},this.getFormatHelperText=o=>this.expandFormat(o).replace(/(aaa|aa|a)/g,"(a|p)m").toLocaleLowerCase(),this.isNull=o=>o===null,this.formatNumber=o=>o,this.getMeridiemText=o=>o==="am"?"AM":"PM";const{locale:n,formats:a,longFormatters:s}=r;this.locale=n,this.formats=Cu({},Zw,a),this.longFormatters=s}}class lu extends eS{constructor({locale:r,formats:n}={}){if(typeof Ro!="function")throw new Error(["MUI: The `date-fns` package v3.x is not compatible with this adapter.","Please, install v2.x of the package or use the `AdapterDateFnsV3` instead."].join(`
`));super({locale:r??_i,formats:n,longFormatters:Jw}),this.parseISO=a=>i0(a),this.toISO=a=>V_(a,{format:"extended"}),this.parse=(a,s)=>a===""?null:t0(a,s,new Date,{locale:this.locale}),this.isValid=a=>Yp(this.date(a)),this.format=(a,s)=>this.formatByString(a,this.formats[s]),this.formatByString=(a,s)=>Cs(a,s,{locale:this.locale}),this.getDiff=(a,s,o)=>{switch(o){case"years":return Gb(a,this.date(s));case"quarters":return Hb(a,this.date(s));case"months":return Gp(a,this.date(s));case"weeks":return Vb(a,this.date(s));case"days":return Vp(a,this.date(s));case"hours":return $b(a,this.date(s));case"minutes":return zb(a,this.date(s));case"seconds":return Yb(a,this.date(s));default:return bi(a,this.date(s))}},this.isEqual=(a,s)=>a===null&&s===null?!0:aj(a,s),this.isSameYear=(a,s)=>a0(a,s),this.isSameMonth=(a,s)=>s0(a,s),this.isSameDay=(a,s)=>Lb(a,s),this.isSameHour=(a,s)=>n0(a,s),this.isAfter=(a,s)=>Vi(a,s),this.isAfterYear=(a,s)=>Vi(a,Bi(s)),this.isAfterDay=(a,s)=>Vi(a,bl(s)),this.isBefore=(a,s)=>Sa(a,s),this.isBeforeYear=(a,s)=>Sa(a,vo(s)),this.isBeforeDay=(a,s)=>Sa(a,Rs(s)),this.isWithinRange=(a,[s,o])=>o0(a,{start:s,end:o}),this.startOfYear=a=>vo(a),this.startOfMonth=a=>kd(a),this.startOfWeek=a=>ts(a,{locale:this.locale}),this.startOfDay=a=>Rs(a),this.endOfYear=a=>Bi(a),this.endOfMonth=a=>_l(a),this.endOfWeek=a=>Hi(a,{locale:this.locale}),this.endOfDay=a=>bl(a),this.addYears=(a,s)=>wd(a,s),this.addMonths=(a,s)=>No(a,s),this.addWeeks=(a,s)=>Rb(a,s),this.addDays=(a,s)=>Ro(a,s),this.addHours=(a,s)=>Eb(a,s),this.addMinutes=(a,s)=>Ab(a,s),this.addSeconds=(a,s)=>Mb(a,s),this.getYear=a=>sj(a),this.getMonth=a=>X_(a),this.getDate=a=>G_(a),this.getHours=a=>Q_(a),this.getMinutes=a=>J_(a),this.getSeconds=a=>Z_(a),this.getMilliseconds=a=>K_(a),this.setYear=(a,s)=>D0(a,s),this.setMonth=(a,s)=>w0(a,s),this.setDate=(a,s)=>S0(a,s),this.setHours=(a,s)=>C0(a,s),this.setMinutes=(a,s)=>P0(a,s),this.setSeconds=(a,s)=>E0(a,s),this.setMilliseconds=(a,s)=>k0(a,s),this.getDaysInMonth=a=>rh(a),this.getNextMonth=a=>No(a,1),this.getPreviousMonth=a=>No(a,-1),this.getMonthArray=a=>{const o=[vo(a)];for(;o.length<12;){const i=o[o.length-1];o.push(this.getNextMonth(i))}return o},this.mergeDateAndTime=(a,s)=>this.setSeconds(this.setMinutes(this.setHours(a,this.getHours(s)),this.getMinutes(s)),this.getSeconds(s)),this.getWeekdays=()=>{const a=new Date;return Qb({start:ts(a,{locale:this.locale}),end:Hi(a,{locale:this.locale})}).map(s=>this.formatByString(s,"EEEEEE"))},this.getWeekArray=a=>{const s=ts(kd(a),{locale:this.locale}),o=Hi(_l(a),{locale:this.locale});let i=0,c=s;const u=[];for(;Sa(c,o);){const d=Math.floor(i/7);u[d]=u[d]||[],u[d].push(c),c=Ro(c,1),i+=1}return u},this.getWeekNumber=a=>nj(a,{locale:this.locale}),this.getYearRange=(a,s)=>{const o=vo(a),i=Bi(s),c=[];let u=o;for(;Sa(u,i);)c.push(u),u=wd(u,1);return c}}}const Ls=t=>new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString(),Gl=()=>crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,tS=async t=>(await B.get("/api/attendance",{params:{profile_id:t}})).data,rS=async t=>{try{return(await B.post("/api/attendance/clock-in",{profile_id:t})).data}catch{const n={event_id:Gl(),user_id:t,device_id:localStorage.getItem("deviceId")||"unknown-device",type:"attendance_clock_in",timestamp_utc:Ls(new Date),payload_json:JSON.stringify({profile_id:t}),created_at:Ls(new Date)};return await window?.api?.timeEvents?.insert?.(n),{id:-Math.floor(Math.random()*1e9),profile_id:t,clock_in:new Date().toISOString(),clock_out:null,duration:null,__pending:!0,__pending_event_id:n.event_id}}},nS=async t=>{try{return(await B.post("/api/attendance/clock-out",{shift_id:t})).data}catch{const n={event_id:Gl(),user_id:void 0,device_id:localStorage.getItem("deviceId")||"unknown-device",type:"attendance_clock_out",timestamp_utc:Ls(new Date),payload_json:JSON.stringify({shift_id:t}),created_at:Ls(new Date)};return await window?.api?.timeEvents?.insert?.(n),{id:t,clock_out:new Date().toISOString(),__pending:!0,__pending_event_id:n.event_id}}},sS=async(t,r,n)=>{try{return(await B.post("/api/attendance/manual",{profile_id:t,clock_in:r,clock_out:n})).data}catch(a){throw a}},aS=async(t,r,n)=>{try{return(await B.put(`/api/attendance/${t}`,{clock_in:r,clock_out:n})).data}catch(a){if(a?.response)throw a;const s={event_id:Gl(),device_id:localStorage.getItem("deviceId")||"unknown-device",type:"attendance_update",timestamp_utc:Ls(new Date),payload_json:JSON.stringify({shift_id:t,clock_in:r,clock_out:n}),created_at:Ls(new Date)};return await window?.api?.timeEvents?.insert?.(s),{id:t,clock_in:r,clock_out:n,__pending:!0,__pending_event_id:s.event_id}}},oS=async(t,r,n)=>(await B.get("/api/attendance",{params:{profile_id:t,from:r,to:n}})).data,iS=async t=>{await B.delete(`/api/attendance/${t}`)};function En(t){if(!t)return"";const r=new Date(t),n=r.getTimezoneOffset()*6e4;return new Date(r.getTime()-n).toISOString().slice(0,16)}function js(t){return t?new Date(t).toISOString():null}function Cl(t){return new Date(t.getFullYear(),t.getMonth(),t.getDate())}function Ua(t){const r=Cl(t),n=r.getFullYear(),a=String(r.getMonth()+1).padStart(2,"0"),s=String(r.getDate()).padStart(2,"0");return`${n}-${a}-${s}`}const lS=()=>{const[t,r]=l.useState([]),[n,a]=l.useState([]),[s,o]=l.useState([]),[i,c]=l.useState(""),[u,d]=l.useState(""),p=new Date,m=new Date;m.setDate(p.getDate()-1);const f=new Date;f.setDate(m.getDate()-13);const[_,v]=l.useState(f),[w,b]=l.useState(m),[P,N]=l.useState(!0),[j,E]=l.useState(null),[A,C]=l.useState(null),[L,y]=l.useState(""),[x,D]=l.useState(""),[M,X]=l.useState(null),[H,U]=l.useState([]),[G,te]=l.useState({}),[re,S]=l.useState([]),[g,T]=l.useState(null),[q,ee]=l.useState(null),[R,K]=l.useState(""),[F,xe]=l.useState(""),[ve,de]=l.useState(!1),[me,ge]=l.useState(!0),[pe,se]=l.useState(!1),[I,W]=l.useState(null),[ce,Z]=l.useState(""),[Ae,Ce]=l.useState(""),[ze,Ve]=l.useState(""),[ut,it]=l.useState(!1),[pt,Ne]=l.useState(!1),[tt,Be]=l.useState(""),[wt,zt]=l.useState(""),[Bt,We]=l.useState(""),[Qt,Kt]=l.useState(!1),[Wt,tr]=l.useState(null),[yr,_e]=l.useState(!1),[ye,we]=l.useState(null),[fe,Ee]=l.useState(null),[Ue,$e]=l.useState(!1),[Je,at]=l.useState(null);l.useEffect(()=>{dt()},[]);const dt=async()=>{try{N(!0);const[je,rt]=await Promise.all([Vl(),mh()]);r(je),a(rt),E(null)}catch(je){E("Failed to fetch data. Please try again."),console.error("Error fetching data:",je)}finally{N(!1)}},ke=async()=>{if(!_||!w){E("Please select a date range");return}try{N(!0);const je=Cl(_),rt=new Date(w.getFullYear(),w.getMonth(),w.getDate()+1),ct=Ua(je),Vt=Ua(rt);console.log("Requesting shifts for:",ct,Vt);const ur={from_date:ct,to_date:Vt};i&&(ur.profile_id=i),u&&(ur.sales_order_id=u);const Dr=await Hw(ct,Vt,i||void 0,u||void 0);if(o(Dr),u)U([]),te({}),S([]);else{const Tr=(await oS(i||void 0,ct,Vt)).map(Ir=>({...Ir,id:Number(Ir.id),profile_id:Number(Ir.profile_id)}));console.log("Fetched shifts:",Tr),U(Tr);const Sr=[];let Vr=new Date(je);const Gr=new Date(rt);for(;Vr<Gr;){const Cr={date:Ua(Vr)};i&&(Cr.profile_id=i);const wn=await B.get("/api/time-tracking/time-entries",{params:Cr});Sr.push(...wn.data),Vr.setDate(Vr.getDate()+1)}const Xr={},Wr=[];Tr.forEach(Ir=>{const Cr=Number(Ir.id);Number.isNaN(Cr)||(Xr[Cr]=[])}),Sr.forEach(Ir=>{const Cr=new Date(Ir.clock_in).getTime(),wn=Number(Ir.profile_id);let cs=!1;for(const Qr of Tr){const ds=Number(Qr.id);if(Number.isNaN(ds))continue;const hn=new Date(Qr.clock_in).getTime(),zn=Qr.clock_out?new Date(Qr.clock_out).getTime():null,mn=Number(Qr.profile_id);if(zn&&!Number.isNaN(wn)&&!Number.isNaN(mn)&&wn===mn&&Cr>=hn&&Cr<zn){Xr[ds].push(Ir),cs=!0;break}}cs||Wr.push(Ir)}),te(Xr),S(Wr)}E(null)}catch(je){E("Failed to generate report. Please try again."),console.error("Error generating report:",je)}finally{N(!1)}},Ie=async je=>{if(!_||!w){E("Please select both from and to dates");return}try{const rt=Cl(_),ct=new Date(w.getFullYear(),w.getMonth(),w.getDate()+1),Vt=Ua(rt),ur=Ua(ct),Dr=await Yw(Vt,ur,i||void 0,u||void 0,je),Fr=u?`time-entries-report-so-${u}.${je}`:`time-entries-report.${je}`;cS(Dr,Fr)}catch(rt){E("Failed to export report. Please try again."),console.error("Error exporting report:",rt)}},Xe=async()=>{if(A){X(null),E(null);try{const je=js(L),rt=js(x),ct=await $w(A.id,je,rt);o(s.map(Vt=>Vt.id===A.id?{...Vt,clock_in:ct.clock_in,clock_out:ct.clock_out,duration:ct.duration}:Vt)),X(null),C(null),E(null)}catch(je){const ct=(je?.response?.data?.message??je?.response?.data?.error)||"Failed to update time entry. Please try again.";X(ct),E(ct),console.error("Error updating time entry:",je)}}},Ct=je=>{W(je),se(!0),Z(u!==""?u:""),Ce(je.clock_in?En(je.clock_in):""),Ve(je.clock_out?En(je.clock_out):""),E(null)},At=()=>{se(!1),W(null),Ce(""),Ve(""),Z(u!==""?u:""),it(!1)},Er=async()=>{if(!I||ce===""||!Ae||!ze)return;const je=js(Ae),rt=js(ze);if(!(!je||!rt)){it(!0),E(null);try{await Bw(I.profile_id,Number(ce),je,rt),At(),await ke()}catch(ct){const Vt=ct?.response?.data?.message||ct?.response?.data?.error||"Failed to create time entry. Please try again.";E(Vt),console.error("Error creating manual time entry:",ct)}finally{it(!1)}}},Yr=je=>{we(null),E(null),tr(je)},Lr=()=>{yr||(tr(null),we(null))},Fn=async()=>{if(!Wt)return;const je=Wt.id;_e(!0),we(null),E(null);try{await zw(je),tr(null),await ke()}catch(rt){const ct=rt?.response?.data?.message||rt?.response?.data?.error||"Failed to delete time entry.";we(ct),E(ct)}finally{_e(!1)}},qr=je=>{at(null),E(null),Ee(je)},pr=()=>{Ue||(Ee(null),at(null))},wr=async()=>{if(!fe)return;const je=fe.id;$e(!0),at(null),E(null);try{await iS(je),Ee(null),await ke()}catch(rt){const ct=rt?.response?.data?.message||rt?.response?.data?.error||"Failed to delete shift.";at(ct),E(ct)}finally{$e(!1)}};if(l.useEffect(()=>{q&&(K(q.clock_in?En(q.clock_in):""),xe(q.clock_out?En(q.clock_out):""))},[q]),P)return e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(ot,{})});const Yt=Ae?new Date(Ae):null,sn=ze?new Date(ze):null,pn=!!(I&&ce!==""&&Yt&&sn&&sn.getTime()>Yt.getTime()),Wn=I?I.profile_name||t.find(je=>je.id===I.profile_id)?.name||`Profile ${I.profile_id}`:"",$n=fe?fe.profile_name||t.find(je=>je.id===fe.profile_id)?.name||`Profile ${fe.profile_id}`:"",Ur={};H.forEach(je=>{if(je.clock_in&&je.clock_out){const rt=Number(je.id);if(Number.isNaN(rt))return;const ct=Number(je.profile_id);if(Number.isNaN(ct))return;const Vt=new Date(je.clock_in).getTime(),ur=new Date(je.clock_out).getTime(),Dr=Math.max(0,(ur-Vt)/(1e3*60*60)),Fr=G[rt]||[];let Tr=0;Fr.forEach(Xr=>{const Wr=typeof Xr.duration=="number"?Xr.duration:Number(Xr.duration)||0;Tr+=Wr});const Sr=Math.max(0,Dr-Tr),Vr=Math.min(Dr,8),Gr=Math.max(0,Dr-8);Ur[ct]||(Ur[ct]={hours:0,idle:0,regular:0,overtime:0}),Ur[ct].hours+=Dr,Ur[ct].idle+=Sr,Ur[ct].regular+=Vr,Ur[ct].overtime+=Gr}});let vr={},ls={};return u&&s.forEach(je=>{const rt=je.profile_name||"Unknown",ct=typeof je.duration=="number"?je.duration:Number(je.duration)||0;vr[rt]=(vr[rt]||0)+ct,ls[rt]||(ls[rt]=[]),ls[rt].push({date:je.date,duration:ct})}),e.jsxs(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsx(h,{variant:"h4",gutterBottom:!0,sx:{fontSize:"2.5rem"},children:"Time Tracking Reports"}),j&&e.jsx(Fe,{severity:"error",sx:{mb:2},children:j}),e.jsxs(O,{container:!0,spacing:3,children:[e.jsx(O,{item:!0,xs:12,children:e.jsxs(Me,{sx:{p:2},children:[e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:12,md:2,children:e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{shrink:!0,children:"Profile"}),e.jsxs(Ut,{value:i,label:"Profile",onChange:je=>c(je.target.value),displayEmpty:!0,sx:{"& .MuiSelect-select":{fontSize:"1.2rem"}},children:[e.jsx(Ze,{value:"",sx:{fontSize:"1.2rem"},children:"All Profiles"}),t.map(je=>e.jsx(Ze,{value:je.id,sx:{fontSize:"1.1rem"},children:je.name},je.id))]})]})}),e.jsx(O,{item:!0,xs:12,md:2,children:e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{shrink:!0,children:"Sales Order"}),e.jsxs(Ut,{value:u,label:"Sales Order",onChange:je=>d(je.target.value),displayEmpty:!0,sx:{"& .MuiSelect-select":{fontSize:"1.2rem"}},children:[e.jsx(Ze,{value:"",sx:{fontSize:"1.2rem"},children:"All Sales Orders"}),n.map(je=>e.jsx(Ze,{value:je.id,sx:{fontSize:"1.1rem"},children:je.number},je.id))]})]})}),e.jsx(O,{item:!0,xs:12,md:2,children:e.jsx(bn,{dateAdapter:lu,children:e.jsx(Nn,{label:"From Date",value:_,onChange:je=>v(je),slotProps:{textField:{fullWidth:!0}}})})}),e.jsx(O,{item:!0,xs:12,md:2,children:e.jsx(bn,{dateAdapter:lu,children:e.jsx(Nn,{label:"To Date",value:w,onChange:je=>b(je),slotProps:{textField:{fullWidth:!0}}})})})]}),e.jsxs(k,{display:"flex",justifyContent:"center",gap:2,mt:2,children:[e.jsx(Q,{variant:"contained",color:"secondary",onClick:()=>{Be(i===""?"":i),zt(""),We(""),E(null),Ne(!0)},children:"Add Shift"}),e.jsx(Q,{variant:"contained",color:"primary",onClick:ke,children:"Generate Report"}),e.jsx(Q,{variant:"outlined",onClick:()=>Ie("csv"),children:"Export CSV"}),e.jsx(Q,{variant:"outlined",onClick:()=>Ie("pdf"),children:"Download PDF"})]})]})}),e.jsx(O,{item:!0,xs:12,children:u?e.jsxs(Me,{sx:{p:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,sx:{fontSize:"1.5rem"},children:"Time Entries Report for Sales Order"}),e.jsx(k,{mb:2,children:e.jsxs(Me,{elevation:2,sx:{p:2,background:"#ede9fe",borderLeft:"6px solid #7c3aed"},children:[e.jsx(h,{variant:"h6",color:"#7c3aed",fontWeight:700,sx:{fontSize:"1.5rem"},children:"Total Hours by Profile on Sales Order"}),Object.entries(vr).map(([je,rt])=>e.jsxs(h,{variant:"body1",sx:{ml:2,fontSize:"1.2rem"},children:[" ",je,": ",rt.toFixed(2)," hrs"]},je))]})}),e.jsxs(Me,{elevation:3,sx:{p:2,mb:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Time Entries for Sales Order"}),e.jsx(dr,{children:e.jsxs(ir,{children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Profile"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Date"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Clock In"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Clock Out"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Duration"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Actions"})]})}),e.jsx(cr,{children:s.map(je=>e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.1rem"},children:je.profile_name}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:new Date(je.date).toLocaleDateString()}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:new Date(je.clock_in).toLocaleTimeString()}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:je.clock_out?new Date(je.clock_out).toLocaleTimeString():"-"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:je.duration!==null&&je.duration!==void 0&&!isNaN(Number(je.duration))?`${Number(je.duration).toFixed(3)} hrs`:"-"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:je.clock_out&&e.jsx(Q,{variant:"text",startIcon:e.jsx(ri,{}),onClick:()=>{X(null),E(null),C(je),y(En(je.clock_in)),D(En(je.clock_out))},sx:{ml:1},children:"Edit"})})]},je.id))})]})})]})]}):e.jsxs(Me,{sx:{p:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,sx:{fontSize:"1.5rem"},children:"Time Entries Report"}),e.jsx(k,{display:"flex",alignItems:"center",mb:2,children:e.jsx(yn,{control:e.jsx(ni,{checked:me,onChange:je=>ge(je.target.checked),color:"primary"}),label:e.jsx(h,{sx:{fontSize:"1.1rem"},children:"Show time entry breakdown"})})}),H.length>0&&e.jsx(k,{mb:2,children:e.jsxs(Me,{elevation:2,sx:{p:2,background:"#ede9fe",borderLeft:"6px solid #7c3aed"},children:[e.jsx(h,{variant:"h6",color:"#7c3aed",fontWeight:700,children:"Summary of Shift Hours by Profile"}),e.jsx(dr,{component:Me,sx:{mt:2},children:e.jsxs(ir,{size:"small",children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Profile Name"}),e.jsx(ne,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Total hr"}),e.jsx(ne,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Idle hr"}),e.jsx(ne,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Regular hr"}),e.jsx(ne,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Overtime hr"})]})}),e.jsx(cr,{children:Object.entries(Ur).map(([je,rt])=>{const Vt=H.find(ur=>ur.profile_id===Number(je))?.profile_name||t.find(ur=>ur.id===Number(je))?.name||`Profile ${je}`;return e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.2rem"},children:Vt}),e.jsx(ne,{sx:{fontSize:"1.2rem"},children:rt.hours.toFixed(2)}),e.jsx(ne,{sx:{fontSize:"1.2rem"},children:rt.idle.toFixed(2)}),e.jsx(ne,{sx:{fontSize:"1.2rem"},children:rt.regular.toFixed(2)}),e.jsx(ne,{sx:{fontSize:"1.2rem"},children:rt.overtime.toFixed(2)})]},je)})})]})})]})}),H.length===0&&!P&&e.jsx(Fe,{severity:"info",sx:{mb:2},children:"No shifts found"}),H.map(je=>{const rt=Number(je.id);return Number.isNaN(rt)?null:e.jsx(dS,{shift:je,entries:G[rt]||[],expanded:g===rt,onExpand:()=>T(g===rt?null:rt),onAddEntry:Ct,setEditEntry:C,setEditClockIn:y,setEditClockOut:D,profiles:t,setEditShift:ee,showBreakdown:me,setEditEntryError:X,setError:E,onDeleteShift:qr,onDeleteEntry:Yr},rt)}),re.length>0&&e.jsx(Me,{elevation:3,sx:{mb:2,borderLeft:"6px solid #a21caf",background:"#f3e8ff"},children:e.jsxs(k,{p:2,children:[e.jsx(h,{variant:"subtitle1",fontWeight:700,color:"#a21caf",sx:{fontSize:"1.2rem"},children:"Unscheduled Entries"}),e.jsx(fh,{entries:re,setEditEntry:C,setEditClockIn:y,setEditClockOut:D,setEditEntryError:X,setError:E,onDeleteEntry:Yr})]})})]})})]}),e.jsxs(mt,{open:pe,onClose:At,children:[e.jsx(ft,{children:"Add Time Entry"}),e.jsxs(xt,{children:[I&&e.jsx(h,{variant:"body2",sx:{mb:2},children:`Profile: ${Wn} | Shift Date: ${new Date(I.clock_in).toLocaleDateString()}`}),e.jsxs(Mt,{fullWidth:!0,sx:{mb:2},children:[e.jsx(qt,{id:"add-entry-sales-order-label",children:"Sales Order"}),e.jsxs(Ut,{labelId:"add-entry-sales-order-label",value:ce,label:"Sales Order",displayEmpty:!0,onChange:je=>{const rt=je.target.value;Z(rt===""?"":Number(rt))},children:[e.jsx(Ze,{value:"",disabled:!0,children:e.jsx("em",{children:"Select a Sales Order"})}),n.map(je=>e.jsx(Ze,{value:je.id,children:je.number},je.id))]})]}),e.jsx(le,{label:"Clock In",type:"datetime-local",value:Ae,onChange:je=>Ce(je.target.value),fullWidth:!0,sx:{mb:2}}),e.jsx(le,{label:"Clock Out",type:"datetime-local",value:ze,onChange:je=>Ve(je.target.value),fullWidth:!0})]}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:At,disabled:ut,children:"Cancel"}),e.jsx(Q,{onClick:Er,variant:"contained",disabled:!pn||ut,children:"Save"})]})]}),e.jsxs(mt,{open:!!A,onClose:()=>{C(null),X(null)},children:[e.jsx(ft,{children:"Edit Time Entry"}),e.jsxs(xt,{children:[M&&e.jsx(Fe,{severity:"error",sx:{mb:2},children:M}),e.jsx(le,{label:"Clock In",type:"datetime-local",value:L,onChange:je=>y(je.target.value),fullWidth:!0,sx:{mb:2}}),e.jsx(le,{label:"Clock Out",type:"datetime-local",value:x,onChange:je=>D(je.target.value),fullWidth:!0})]}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>{C(null),X(null)},children:"Cancel"}),e.jsx(Q,{onClick:Xe,variant:"contained",startIcon:e.jsx(qu,{}),children:"Save"})]})]}),e.jsxs(mt,{open:!!Wt,onClose:Lr,children:[e.jsx(ft,{children:"Delete Time Entry"}),e.jsxs(xt,{children:[ye&&e.jsx(Fe,{severity:"error",sx:{mb:2},children:ye}),Wt&&e.jsxs(h,{variant:"body2",children:["Are you sure you want to delete the entry for sales order ",Wt.sales_order_number," on"," ",new Date(Wt.clock_in).toLocaleString(),"?"]})]}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:Lr,disabled:yr,children:"Cancel"}),e.jsx(Q,{onClick:Fn,variant:"contained",color:"error",disabled:yr,children:"Delete"})]})]}),e.jsxs(mt,{open:pt,onClose:()=>{Qt||Ne(!1)},children:[e.jsx(ft,{children:"Add Shift"}),e.jsxs(xt,{children:[e.jsxs(Mt,{fullWidth:!0,sx:{mb:2},children:[e.jsx(qt,{id:"add-shift-profile-label",children:"Profile"}),e.jsxs(Ut,{labelId:"add-shift-profile-label",value:tt,label:"Profile",onChange:je=>Be(je.target.value),displayEmpty:!0,renderValue:je=>{if(je==null)return e.jsx("em",{children:"Select Profile"});if(typeof je=="string"&&je==="")return e.jsx("em",{children:"Select Profile"});const rt=t.find(ct=>ct.id===Number(je));return rt?rt.name:String(je)},children:[e.jsx(Ze,{value:"",children:e.jsx("em",{children:"Select Profile"})}),t.map(je=>e.jsx(Ze,{value:je.id,children:je.name},je.id))]})]}),e.jsx(le,{label:"Clock In",type:"datetime-local",value:wt,onChange:je=>zt(je.target.value),fullWidth:!0,sx:{mb:2},InputLabelProps:{shrink:!0}}),e.jsx(le,{label:"Clock Out",type:"datetime-local",value:Bt,onChange:je=>We(je.target.value),fullWidth:!0,InputLabelProps:{shrink:!0}})]}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>{Qt||Ne(!1)},children:"Cancel"}),e.jsx(Q,{onClick:async()=>{if(tt===""||!wt||!Bt)return;const je=js(wt),rt=js(Bt);if(!je||!rt){E("Please provide valid shift times.");return}Kt(!0);try{await sS(tt,je,rt),Ne(!1),zt(""),We(""),E(null),await ke()}catch(ct){const Vt=ct?.response?.data?.message||ct?.response?.data?.error||"Failed to create shift.";E(Vt)}finally{Kt(!1)}},variant:"contained",color:"primary",disabled:Qt||tt===""||!wt||!Bt,children:"Save"})]})]}),e.jsxs(mt,{open:!!q,onClose:()=>ee(null),children:[e.jsx(ft,{children:"Edit Shift"}),e.jsxs(xt,{children:[e.jsx(le,{label:"Clock In",type:"datetime-local",value:R,onChange:je=>K(je.target.value),fullWidth:!0,sx:{mb:2}}),e.jsx(le,{label:"Clock Out",type:"datetime-local",value:F,onChange:je=>xe(je.target.value),fullWidth:!0})]}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>ee(null),children:"Cancel"}),e.jsx(Q,{onClick:async()=>{if(q){de(!0);try{await aS(q.id,new Date(R).toISOString(),new Date(F).toISOString()),ee(null),de(!1),await ke()}catch(je){de(!1);const rt=je?.response?.data?.message||je?.response?.data?.error||"Failed to update shift.";E(rt)}}},variant:"contained",color:"primary",disabled:ve,children:"Save"})]})]}),e.jsxs(mt,{open:!!fe,onClose:pr,children:[e.jsx(ft,{children:"Delete Shift"}),e.jsxs(xt,{children:[Je&&e.jsx(Fe,{severity:"error",sx:{mb:2},children:Je}),fe&&e.jsxs(h,{variant:"body2",children:["Are you sure you want to delete the shift for ",$n," on"," ",new Date(fe.clock_in).toLocaleString(),"? Any associated time entries must be removed first."]})]}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:pr,disabled:Ue,children:"Cancel"}),e.jsx(Q,{onClick:wr,variant:"contained",color:"error",disabled:Ue,children:"Delete"})]})]})]})};function cS(t,r){const n=window.URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=r,document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(n),document.body.removeChild(a)}function dS({shift:t,entries:r,expanded:n,onExpand:a,onAddEntry:s,setEditEntry:o,setEditClockIn:i,setEditClockOut:c,profiles:u,setEditShift:d,showBreakdown:p,setEditEntryError:m,setError:f,onDeleteShift:_,onDeleteEntry:v}){const w=new Date(t.clock_in),b=t.clock_out?new Date(t.clock_out):null,P=t.duration!==null&&t.duration!==void 0?Number(t.duration):0,N=t.profile_name||u.find(A=>A.id===t.profile_id)?.name||`Profile ${t.profile_id}`;let j=0;r.forEach(A=>{const C=typeof A.duration=="number"?A.duration:Number(A.duration)||0;j+=C});const E=Math.max(0,P-j);return e.jsx(Me,{elevation:3,sx:{mb:2,borderLeft:"6px solid #7c3aed",background:n?"#f3e8ff":"white"},children:e.jsxs(k,{p:2,children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(h,{variant:"subtitle1",fontWeight:700,color:"#7c3aed",sx:{fontSize:"1.2rem"},children:["Profile: ",N,"  Date: ",w.toLocaleDateString()]}),e.jsxs(k,{display:"flex",gap:1,children:[p&&e.jsx(Q,{variant:"contained",color:"primary",size:"small",onClick:a,children:n?"Hide Entries":"Show Entries"}),e.jsx(Q,{variant:"outlined",color:"primary",size:"small",onClick:()=>s(t),children:"Add Entry"}),e.jsx(Q,{variant:"contained",color:"primary",size:"small",onClick:()=>d(t),children:"Edit Shift"}),e.jsx(Q,{variant:"outlined",color:"error",size:"small",onClick:()=>_(t),startIcon:e.jsx(qs,{}),children:"Delete Shift"})]})]}),e.jsxs(h,{variant:"body1",sx:{mt:1,fontSize:"1.1rem"},children:["Shift: ",w.toLocaleTimeString(),"  ",b?b.toLocaleTimeString():"-"," (",P.toFixed(2)," hrs)"]}),p&&e.jsxs(k,{sx:{mt:1,ml:2},children:[r.map((A,C)=>{const L=typeof A.duration=="number"?A.duration:Number(A.duration)||0,y=new Date(A.clock_in),x=A.clock_out?new Date(A.clock_out):null;return e.jsxs(h,{variant:"body2",sx:{fontSize:"1.1rem"},children:[" ",A.sales_order_number,": ",y.toLocaleTimeString(),"  ",x?x.toLocaleTimeString():"-"," (",L.toFixed(3)," hrs)"]},A.id||C)}),E>0&&e.jsxs(h,{variant:"body2",sx:{fontSize:"1.1rem"},children:[" Idle: ",E.toFixed(3)," hrs"]})]}),p&&n&&e.jsx(fh,{entries:r,setEditEntry:o,setEditClockIn:i,setEditClockOut:c,setEditEntryError:m,setError:f,onDeleteEntry:v})]})})}function fh({entries:t,setEditEntry:r,setEditClockIn:n,setEditClockOut:a,setEditEntryError:s,setError:o,onDeleteEntry:i}){return e.jsx(dr,{sx:{mt:1,mb:1},children:e.jsxs(ir,{size:"small",children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Sales Order"}),e.jsx(ne,{children:"Clock In"}),e.jsx(ne,{children:"Clock Out"}),e.jsx(ne,{children:"Duration"}),e.jsx(ne,{children:"Actions"})]})}),e.jsx(cr,{children:t.map(c=>e.jsxs(ht,{children:[e.jsx(ne,{children:c.sales_order_number}),e.jsx(ne,{children:new Date(c.clock_in).toLocaleTimeString()}),e.jsx(ne,{children:c.clock_out?new Date(c.clock_out).toLocaleTimeString():"-"}),e.jsx(ne,{children:c.duration!==null&&c.duration!==void 0&&!isNaN(Number(c.duration))?`${Number(c.duration).toFixed(3)} hrs`:"-"}),e.jsxs(ne,{children:[c.clock_out&&e.jsx(Q,{variant:"text",startIcon:e.jsx(ri,{}),onClick:()=>{s(null),o(null),r(c),n(En(c.clock_in)),a(En(c.clock_out))},sx:{ml:1},children:"Edit"}),i&&e.jsx(Q,{variant:"text",color:"error",startIcon:e.jsx(qs,{}),onClick:()=>i(c),sx:{ml:c.clock_out?1:0},children:"Delete"})]})]},c.id))})]})})}const Jr={submitRequest:async t=>(await B.post("/api/leave-management/request",t)).data,getMyRequests:async()=>(await B.get("/api/leave-management/my-requests")).data,getAllRequests:async()=>(await B.get("/api/leave-management/all-requests")).data,getCalendar:async(t,r)=>{const n={};return t&&(n.start_date=t),r&&(n.end_date=r),(await B.get("/api/leave-management/calendar",{params:n})).data},approveRequest:async(t,r,n,a)=>(await B.post(`/api/leave-management/approve/${t}`,{admin_notes:r,proposed_start_date:n,proposed_end_date:a})).data,denyRequest:async(t,r)=>(await B.post(`/api/leave-management/deny/${t}`,{admin_notes:r})).data,proposeVacationDates:async(t,r,n,a)=>(await B.post(`/api/leave-management/propose/${t}`,{proposed_start_date:r,proposed_end_date:n,admin_notes:a})).data,getProfiles:async()=>(await B.get("/api/leave-management/profiles")).data,getLeaveHistory:async()=>(await B.get("/api/leave-management/history")).data,getVacationSettings:async()=>(await B.get("/api/leave-management/vacation-settings")).data,updateVacationSettings:async t=>(await B.put("/api/leave-management/vacation-settings",{reset_date:t})).data,updateEmployeeVacationDays:async(t,r)=>(await B.put(`/api/leave-management/profiles/${t}/vacation-days`,{total_vacation_days:r})).data,resetAllVacationDays:async()=>(await B.post("/api/leave-management/reset-vacation-days")).data,getLeaveStatistics:async()=>(await B.get("/api/leave-management/statistics")).data},uS=()=>{const{user:t}=er(),r=Gt(),[n,a]=l.useState([]),[s,o]=l.useState([]),[i,c]=l.useState(!0),[u,d]=l.useState(null),[p,m]=l.useState(()=>{const g=et(),T=g.day();return g.subtract(T,"day").startOf("day")}),[f,_]=l.useState({open:!1,requestId:0,action:"approve"}),[v,w]=l.useState(""),[b,P]=l.useState(null),[N,j]=l.useState(null),[E,A]=l.useState(!1),[C,L]=l.useState(!0);l.useEffect(()=>{console.log("LeaveManagementPage - User data:",t),(t?.access_role==="Admin"||t?.access_role==="Time Tracking")&&y()},[t]);const y=async()=>{try{console.log("LeaveManagementPage - Fetching data..."),c(!0);const[g,T]=await Promise.all([Jr.getAllRequests(),Jr.getProfiles()]);console.log("LeaveManagementPage - Data received:",{requestsData:g,profilesData:T}),a(g||[]),o(T||[]),d(null)}catch(g){console.error("LeaveManagementPage - Error fetching data:",g),d(g.response?.data?.message||"Failed to load data. Please try again.")}finally{c(!1)}},x=()=>{const g=[],T=et();for(let q=0;q<7;q++){const ee=p.add(q,"day"),R=ee.isSame(T,"day"),K=n.filter(F=>{if(F.status!=="approved")return!1;const xe=et(F.start_date),ve=et(F.end_date);return(xe.isSame(ee,"day")||xe.isBefore(ee))&&(ve.isSame(ee,"day")||ve.isAfter(ee))}).map(F=>F.profile_name);g.push({date:ee,isToday:R,hasTimeOff:K.length>0,timeOffProfiles:K})}return g},D=g=>{m(g==="prev"?T=>T.subtract(7,"day"):T=>T.add(7,"day"))},M=()=>{const g=et(),T=g.day();m(g.subtract(T,"day").startOf("day"))},X=()=>{const g=p.add(6,"day");return n.filter(T=>{if(T.status!=="approved")return!1;const q=et(T.start_date),ee=et(T.end_date);return(q.isSame(g,"day")||q.isBefore(g))&&(ee.isSame(p,"day")||ee.isAfter(p))}).map(T=>({profileName:T.profile_name,startDate:et(T.start_date),endDate:et(T.end_date),requestType:T.request_type,reason:T.reason})).sort((T,q)=>T.startDate.valueOf()-q.startDate.valueOf())},H=()=>{const g=et(),T=g.startOf("month"),q=g.endOf("month");return n.filter(R=>{if(R.status!=="approved")return!1;const K=et(R.start_date),F=et(R.end_date);return(K.isSame(q,"day")||K.isBefore(q))&&(F.isSame(T,"day")||F.isAfter(T))}).map(R=>({profileName:R.profile_name,startDate:et(R.start_date),endDate:et(R.end_date),requestType:R.request_type})).sort((R,K)=>R.startDate.valueOf()-K.startDate.valueOf())},U=()=>{const g=H();if(g.length===0)return"No employees on leave this month";const T=new Map;return g.forEach(ee=>{T.has(ee.profileName)||T.set(ee.profileName,[]),T.get(ee.profileName).push(ee)}),Array.from(T.entries()).map(([ee,R])=>{const K=R.map(F=>{const xe=F.startDate.format("MMM D"),ve=F.endDate.format("MMM D");return`${xe}-${ve}`}).join(", ");return`${ee}: ${K}`}).slice(0,3).join("  ")},G=(g,T)=>{_({open:!0,requestId:g,action:T}),w(""),P(null),j(null)},te=async()=>{A(!0);try{const{requestId:g,action:T}=f;if(T==="approve")await Jr.approveRequest(g,v,b?.format("YYYY-MM-DD"),N?.format("YYYY-MM-DD"));else if(T==="deny")await Jr.denyRequest(g,v);else if(T==="propose"){if(!b||!N){d("Please enter both start and end dates"),A(!1);return}if(N.isBefore(b)){d("End date cannot be before start date"),A(!1);return}await Jr.proposeVacationDates(g,b.format("YYYY-MM-DD"),N.format("YYYY-MM-DD"),v)}_({open:!1,requestId:0,action:"approve"}),await y()}catch(g){d(g.response?.data?.message||"Action failed. Please try again.")}finally{A(!1)}},re=g=>{const q={pending:{color:"warning",label:"Pending"},approved:{color:"success",label:"Approved"},denied:{color:"error",label:"Denied"},modified:{color:"info",label:"Modified"}}[g]||{color:"default",label:g};return e.jsx(De,{label:q.label,color:q.color,size:"small"})},S=g=>({vacation:"Vacation",sick:"Sick Day",personal:"Personal",bereavement:"Bereavement"})[g]||g;return t?t.access_role!=="Admin"&&t.access_role!=="Time Tracking"?e.jsx(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(Fe,{severity:"error",children:"Access denied. Admin or Time Tracking privileges required to view this page."})}):i?e.jsx(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(ot,{})})}):e.jsx(bn,{dateAdapter:os,children:e.jsxs(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(h,{variant:"h4",component:"h1",children:["Leave Management",t.access_role==="Admin"?" (Admin)":" (View Only)"]}),e.jsxs(k,{display:"flex",gap:2,children:[e.jsx(Q,{variant:"outlined",startIcon:e.jsx(tl,{}),onClick:()=>r("/leave-history"),children:"View History"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(Ds,{}),onClick:()=>r("/vacation-days-management"),children:"Manage Vacation Days"})]})]}),e.jsx(h,{variant:"body1",color:"text.secondary",paragraph:!0,children:U()}),u&&e.jsx(Fe,{severity:"error",sx:{mb:2},children:u}),e.jsxs(O,{container:!0,spacing:3,children:[e.jsx(O,{item:!0,xs:12,children:e.jsxs(Me,{sx:{p:3},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(h,{variant:"h6",children:[e.jsx(Ts,{sx:{mr:1,verticalAlign:"middle"}}),"Weekly Leave Schedule"]}),e.jsxs(k,{display:"flex",gap:1,children:[e.jsx(Q,{variant:"outlined",size:"small",onClick:()=>D("prev"),startIcon:e.jsx(Yh,{}),children:"Previous Week"}),e.jsx(Q,{variant:"outlined",size:"small",onClick:M,startIcon:e.jsx(Vh,{}),children:"Today"}),e.jsx(Q,{variant:"outlined",size:"small",onClick:()=>D("next"),endIcon:e.jsx(Gh,{}),children:"Next Week"})]})]}),e.jsxs(h,{variant:"body2",color:"text.secondary",mb:3,children:["Week of ",p.format("MMMM D, YYYY")]}),e.jsx(k,{sx:{overflowX:"auto"},children:e.jsx(dr,{component:Me,variant:"outlined",children:e.jsxs(ir,{size:"small",children:[e.jsx(lr,{children:e.jsxs(ht,{sx:{backgroundColor:"grey.50"},children:[e.jsx(ne,{sx:{fontWeight:"bold",minWidth:140},children:"Employee Name"}),x().map((g,T)=>e.jsx(ne,{align:"center",sx:{fontWeight:"bold",minWidth:70},children:e.jsxs(k,{children:[e.jsx(h,{variant:"caption",display:"block",sx:{fontWeight:"bold"},children:g.date.format("ddd")}),e.jsx(h,{variant:"body2",children:g.date.format("MMM D")}),g.isToday&&e.jsx(h,{variant:"caption",display:"block",sx:{color:"primary.main",fontWeight:"bold"},children:"Today"})]})},T))]})}),e.jsxs(cr,{children:[X().map((g,T)=>e.jsxs(ht,{hover:!0,children:[e.jsx(ne,{sx:{fontWeight:"medium"},children:g.profileName}),x().map((q,ee)=>{const R=(g.startDate.isSame(q.date,"day")||g.startDate.isBefore(q.date))&&(g.endDate.isSame(q.date,"day")||g.endDate.isAfter(q.date));return e.jsx(ne,{align:"center",sx:{backgroundColor:R?"error.light":"inherit",color:R?"error.dark":"text.primary",fontWeight:R?"medium":"normal"},children:R?e.jsxs(k,{children:[e.jsx(h,{variant:"caption",display:"block",sx:{fontWeight:"bold",textTransform:"capitalize"},children:S(g.requestType)}),g.reason&&e.jsx(Ht,{title:g.reason,children:e.jsx(h,{variant:"caption",sx:{opacity:.75},children:g.reason.length>8?g.reason.substring(0,8)+"...":g.reason})})]}):e.jsx(h,{variant:"body2",color:"text.secondary",children:"-"})},ee)})]},T)),X().length===0&&e.jsx(ht,{children:e.jsx(ne,{colSpan:8,align:"center",sx:{py:4},children:e.jsxs(k,{sx:{textAlign:"center"},children:[e.jsx(Ts,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(h,{color:"text.secondary",children:"No employees on leave this week"})]})})})]})]})})})]})}),e.jsx(O,{item:!0,xs:12,children:e.jsxs(Me,{sx:{p:3},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(h,{variant:"h6",children:[e.jsx(Qh,{sx:{mr:1,verticalAlign:"middle"}}),"Leave Requests",t.access_role!=="Admin"&&e.jsx(h,{variant:"caption",display:"block",color:"text.secondary",sx:{mt:1},children:"View-only mode. Admin actions are restricted to administrators."})]}),e.jsxs(k,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Show:"}),e.jsx(Q,{variant:C?"contained":"outlined",size:"small",onClick:()=>L(!0),sx:{minWidth:100},children:"Pending"}),e.jsx(Q,{variant:C?"outlined":"contained",size:"small",onClick:()=>L(!1),sx:{minWidth:100},children:"All"})]})]}),e.jsx(dr,{children:e.jsxs(ir,{children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontWeight:"bold"},children:"Employee"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Type"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Dates"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Days"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Status"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Reason"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Admin Notes"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Actions"})]})}),e.jsx(cr,{children:(()=>{const g=C?n.filter(T=>T.status==="pending"):n;return g.length===0?e.jsx(ht,{children:e.jsx(ne,{colSpan:8,align:"center",sx:{py:4},children:e.jsx(h,{color:"text.secondary",children:C?"No pending leave requests found":"No leave requests found"})})}):g.map(T=>e.jsxs(ht,{hover:!0,children:[e.jsx(ne,{children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",sx:{fontWeight:"medium"},children:T.profile_name}),e.jsx(h,{variant:"caption",color:"text.secondary",children:T.user_email})]})}),e.jsx(ne,{children:e.jsx(De,{label:S(T.request_type),size:"small",variant:"outlined"})}),e.jsxs(ne,{children:[e.jsx(h,{variant:"body2",children:et(T.start_date).format("MMM D, YYYY")}),e.jsxs(h,{variant:"body2",children:["to ",et(T.end_date).format("MMM D, YYYY")]})]}),e.jsx(ne,{children:e.jsxs(h,{variant:"body2",children:[T.total_days," day",T.total_days!==1?"s":""]})}),e.jsx(ne,{children:re(T.status)}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",sx:{maxWidth:200},children:T.reason||"-"})}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",sx:{maxWidth:200},children:T.admin_notes||"-"})}),e.jsx(ne,{children:T.status==="pending"&&t.access_role==="Admin"&&e.jsxs(k,{display:"flex",gap:1,children:[e.jsx(Ht,{title:"Approve Request",children:e.jsx(gt,{color:"success",size:"small",onClick:()=>G(T.request_id,"approve"),children:e.jsx(Qa,{})})}),e.jsx(Ht,{title:"Deny Request",children:e.jsx(gt,{color:"error",size:"small",onClick:()=>G(T.request_id,"deny"),children:e.jsx(Ss,{})})}),(T.request_type==="vacation"||T.request_type==="personal"||T.request_type==="bereavement")&&e.jsx(Ht,{title:"Propose Dates",children:e.jsx(gt,{color:"info",size:"small",onClick:()=>G(T.request_id,"propose"),children:e.jsx(Ts,{})})})]})})]},T.request_id))})()})]})})]})})]}),e.jsxs(mt,{open:f.open,onClose:()=>_({open:!1,requestId:0,action:"approve"}),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:f.action==="approve"?"Approve Request":f.action==="deny"?"Deny Request":"Propose Dates"}),e.jsx(xt,{children:e.jsxs(k,{sx:{pt:2},children:[(f.action==="propose"||f.action==="approve")&&e.jsx(k,{sx:{mb:3},children:e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:6,children:e.jsx(Nn,{label:f.action==="propose"?"Proposed Start Date":"Proposed Start Date (Optional)",value:b,onChange:g=>P(g),slotProps:{textField:{fullWidth:!0,size:"small"}}})}),e.jsx(O,{item:!0,xs:6,children:e.jsx(Nn,{label:f.action==="propose"?"Proposed End Date":"Proposed End Date (Optional)",value:N,onChange:g=>j(g),minDate:b,disabled:!b,slotProps:{textField:{fullWidth:!0,size:"small"}}})})]})}),e.jsx(le,{fullWidth:!0,multiline:!0,rows:3,label:"Admin Notes",value:v,onChange:g=>w(g.target.value),placeholder:"Add notes about this decision...",variant:"outlined",size:"small"})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>_({open:!1,requestId:0,action:"approve"}),disabled:E,children:"Cancel"}),e.jsx(Q,{onClick:te,disabled:E,variant:"contained",color:f.action==="deny"?"error":"primary",children:E?"Processing...":f.action==="approve"?"Approve":f.action==="deny"?"Deny":"Propose"})]})]})]})}):e.jsx(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:[e.jsx(ot,{}),e.jsx(h,{variant:"body2",sx:{ml:2},children:"Loading user data..."})]})})},pS=()=>{const{user:t}=er(),[r,n]=l.useState([]),[a,s]=l.useState(null),[o,i]=l.useState(!0),[c,u]=l.useState(null);l.useEffect(()=>{(t?.access_role==="Admin"||t?.access_role==="Time Tracking")&&d()},[t]);const d=async()=>{try{i(!0);const[v,w]=await Promise.all([Jr.getLeaveHistory(),Jr.getLeaveStatistics()]);n(v||[]),s(w),u(null)}catch(v){console.error("Error fetching leave history:",v),u(v.response?.data?.message||"Failed to load leave history. Please try again.")}finally{i(!1)}},p=v=>et(v+"-01").format("MMMM YYYY"),m=v=>{let w=0;return Object.values(v.months).forEach(b=>{w+=b.total_days}),w},f=()=>{const v=new Set;return r.forEach(w=>{Object.keys(w.months).forEach(b=>v.add(b))}),Array.from(v).sort().reverse()};if(!t)return e.jsx(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:[e.jsx(ot,{}),e.jsx(h,{variant:"body2",sx:{ml:2},children:"Loading user data..."})]})});if(t.access_role!=="Admin"&&t.access_role!=="Time Tracking")return e.jsx(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(Fe,{severity:"error",children:"Access denied. Admin or Time Tracking privileges required to view this page."})});if(o)return e.jsx(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(ot,{})})});const _=f();return e.jsxs(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(h,{variant:"h4",component:"h1",gutterBottom:!0,children:[e.jsx(tl,{sx:{mr:1,verticalAlign:"middle"}}),"Leave History (Past 12 Months)"]}),e.jsx(h,{variant:"body1",color:"text.secondary",paragraph:!0,children:"View leave history for all employees over the past 12 months"}),c&&e.jsx(Fe,{severity:"error",sx:{mb:2},children:c}),r.length===0?e.jsxs(Me,{sx:{p:4,textAlign:"center"},children:[e.jsx(tl,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(h,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"No Leave History Found"}),e.jsx(h,{color:"text.secondary",children:"No approved leave requests found in the past 12 months."})]}):e.jsxs(k,{children:[e.jsxs(O,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(O,{item:!0,xs:12,md:4,children:e.jsx(kt,{children:e.jsx(Ot,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Dl,{sx:{fontSize:40,color:"primary.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"div",children:a?.employees_with_leave_this_month||0}),e.jsx(h,{color:"text.secondary",children:"Employees with Leave This Month"})]})]})})})}),e.jsx(O,{item:!0,xs:12,md:4,children:e.jsx(kt,{children:e.jsx(Ot,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Ts,{sx:{fontSize:40,color:"success.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"div",children:a?.total_days_this_month||0}),e.jsx(h,{color:"text.secondary",children:"Total Days of Leave This Month"})]})]})})})}),e.jsx(O,{item:!0,xs:12,md:4,children:e.jsx(kt,{children:e.jsx(Ot,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Uu,{sx:{fontSize:40,color:"info.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"div",children:a?.total_days_past_12_months||0}),e.jsx(h,{color:"text.secondary",children:"Total Days of Leave (Past 12 Months)"})]})]})})})})]}),r.map(v=>e.jsxs(Kh,{sx:{mb:2},children:[e.jsx(Jh,{expandIcon:e.jsx(Fu,{}),children:e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%",children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h6",children:v.profile_name}),e.jsx(h,{variant:"body2",color:"text.secondary",children:v.profile_email})]}),e.jsxs(k,{display:"flex",alignItems:"center",gap:2,children:[e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Total: ",m(v).toFixed(1)," days"]}),e.jsx(De,{label:`${Object.keys(v.months).length} months`,size:"small",variant:"outlined"})]})]})}),e.jsx(Xh,{children:e.jsx(dr,{component:Me,variant:"outlined",children:e.jsxs(ir,{size:"small",children:[e.jsx(lr,{children:e.jsxs(ht,{sx:{backgroundColor:"grey.50"},children:[e.jsx(ne,{sx:{fontWeight:"bold"},children:"Month"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Vacation"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Sick"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Personal"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Bereavement"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Total"})]})}),e.jsx(cr,{children:_.map(w=>{const b=v.months[w];return!b||b.total_days===0?null:e.jsxs(ht,{hover:!0,children:[e.jsx(ne,{sx:{fontWeight:"medium"},children:p(w)}),e.jsx(ne,{align:"center",children:b.vacation_days>0?e.jsx(De,{label:b.vacation_days,size:"small",color:"success",variant:"outlined"}):"-"}),e.jsx(ne,{align:"center",children:b.sick_days>0?e.jsx(De,{label:b.sick_days,size:"small",color:"error",variant:"outlined"}):"-"}),e.jsx(ne,{align:"center",children:b.personal_days>0?e.jsx(De,{label:b.personal_days,size:"small",color:"info",variant:"outlined"}):"-"}),e.jsx(ne,{align:"center",children:b.bereavement_days>0?e.jsx(De,{label:b.bereavement_days,size:"small",color:"warning",variant:"outlined"}):"-"}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",sx:{fontWeight:"bold"},children:b.total_days})})]},w)})})]})})})]},v.profile_id))]})]})},hS=()=>{const{user:t}=er(),[r,n]=l.useState([]),[a,s]=l.useState(null),[o,i]=l.useState(!0),[c,u]=l.useState(null),[d,p]=l.useState(null),[m,f]=l.useState(0),[_,v]=l.useState(!1),[w,b]=l.useState(null),[P,N]=l.useState(!1);l.useEffect(()=>{t?.access_role==="Admin"&&j()},[t]);const j=async()=>{try{i(!0);const[H,U]=await Promise.all([Jr.getProfiles(),Jr.getVacationSettings()]);n(H||[]),s(U),u(null)}catch(H){console.error("Error fetching data:",H),u(H.response?.data?.message||"Failed to load data. Please try again.")}finally{i(!1)}},E=H=>{p(H.id),f(H.total_vacation_days||H.vacation_days_available||20)},A=async()=>{if(!d)return;const H=Math.round(m);try{N(!0),await Jr.updateEmployeeVacationDays(d,H),await j(),p(null),f(0)}catch(U){u(U.response?.data?.message||"Failed to update vacation days.")}finally{N(!1)}},C=()=>{p(null),f(0)},L=()=>{b(a?.reset_date?et(a.reset_date):null),v(!0)},y=async()=>{if(!w){u("Please select a reset date.");return}try{N(!0),await Jr.updateVacationSettings(w.format("YYYY-MM-DD")),await j(),v(!1)}catch(H){u(H.response?.data?.message||"Failed to update settings.")}finally{N(!1)}},x=async()=>{if(window.confirm("This will reset vacation days for ALL employees. Are you sure?"))try{N(!0),await Jr.resetAllVacationDays(),await j()}catch(H){u(H.response?.data?.message||"Failed to reset vacation days.")}finally{N(!1)}};if(!t)return e.jsx(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:[e.jsx(ot,{}),e.jsx(h,{variant:"body2",sx:{ml:2},children:"Loading user data..."})]})});if(t.access_role!=="Admin")return e.jsx(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(Fe,{severity:"error",children:"Access denied. Admin privileges required to view this page."})});if(o)return e.jsx(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(ot,{})})});const D=r.length,M=r.reduce((H,U)=>H+(U.total_vacation_days||U.vacation_days_available||20),0),X=r.reduce((H,U)=>H+Math.round(U.days_used||0),0);return e.jsx(bn,{dateAdapter:os,children:e.jsxs(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(h,{variant:"h4",component:"h1",children:[e.jsx(Ds,{sx:{mr:1,verticalAlign:"middle"}}),"Vacation Days Management"]}),e.jsxs(k,{display:"flex",gap:2,children:[e.jsx(Q,{variant:"outlined",startIcon:e.jsx(Ts,{}),onClick:L,children:"Reset Settings"}),e.jsx(Q,{variant:"contained",color:"warning",startIcon:e.jsx(Ol,{}),onClick:x,disabled:P,children:"Reset All Days"})]})]}),e.jsx(h,{variant:"body1",color:"text.secondary",paragraph:!0,children:"Manage vacation days allocation for each employee and set the global reset date."}),c&&e.jsx(Fe,{severity:"error",sx:{mb:2},children:c}),e.jsxs(O,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(O,{item:!0,xs:12,md:3,children:e.jsx(kt,{children:e.jsx(Ot,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Dl,{sx:{fontSize:40,color:"primary.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"div",children:D}),e.jsx(h,{color:"text.secondary",children:"Total Employees"})]})]})})})}),e.jsx(O,{item:!0,xs:12,md:3,children:e.jsx(kt,{children:e.jsx(Ot,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Ts,{sx:{fontSize:40,color:"success.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"div",children:M}),e.jsx(h,{color:"text.secondary",children:"Total Days Allocated"})]})]})})})}),e.jsx(O,{item:!0,xs:12,md:3,children:e.jsx(kt,{children:e.jsx(Ot,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Uu,{sx:{fontSize:40,color:"info.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"div",children:X}),e.jsx(h,{color:"text.secondary",children:"Days Used"})]})]})})})}),e.jsx(O,{item:!0,xs:12,md:3,children:e.jsx(kt,{children:e.jsx(Ot,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Ds,{sx:{fontSize:40,color:"warning.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h6",component:"div",children:a?.reset_date?et(a.reset_date).format("MMM D, YYYY"):"Not Set"}),e.jsx(h,{color:"text.secondary",children:"Reset Date"})]})]})})})})]}),e.jsxs(Me,{sx:{p:3},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Employee Vacation Days"}),e.jsx(dr,{children:e.jsxs(ir,{children:[e.jsx(lr,{children:e.jsxs(ht,{sx:{backgroundColor:"grey.50"},children:[e.jsx(ne,{sx:{fontWeight:"bold"},children:"Employee"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Total Days"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Days Used"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Days Remaining"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Reset Date"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Actions"})]})}),e.jsx(cr,{children:r.map(H=>e.jsxs(ht,{hover:!0,children:[e.jsx(ne,{children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",sx:{fontWeight:"medium"},children:H.name}),e.jsx(h,{variant:"caption",color:"text.secondary",children:H.email})]})}),e.jsx(ne,{align:"center",children:d===H.id?e.jsx(le,{type:"number",value:m,onChange:U=>f(Math.max(0,parseInt(U.target.value)||0)),size:"small",sx:{width:80},inputProps:{min:0,step:1}}):e.jsx(h,{variant:"body2",sx:{fontWeight:"bold"},children:H.total_vacation_days||H.vacation_days_available||20})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",color:"text.secondary",children:Math.round(H.days_used||0)})}),e.jsx(ne,{align:"center",children:e.jsx(De,{label:Math.round(H.days_remaining||H.vacation_days_available||20),size:"small",color:H.days_remaining&&H.days_remaining<5?"warning":"success",variant:"outlined"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",color:"text.secondary",children:H.reset_date?et(H.reset_date).format("MMM D, YYYY"):"-"})}),e.jsx(ne,{align:"center",children:d===H.id?e.jsxs(k,{display:"flex",gap:1,children:[e.jsx(Ht,{title:"Save",children:e.jsx(gt,{color:"success",size:"small",onClick:A,disabled:P,children:e.jsx(qu,{})})}),e.jsx(Ht,{title:"Cancel",children:e.jsx(gt,{color:"error",size:"small",onClick:C,disabled:P,children:e.jsx(Ss,{})})})]}):e.jsx(Ht,{title:"Edit Vacation Days",children:e.jsx(gt,{color:"primary",size:"small",onClick:()=>E(H),children:e.jsx(ri,{})})})})]},H.id))})]})})]}),e.jsxs(mt,{open:_,onClose:()=>v(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Ds,{sx:{mr:1}}),"Vacation Reset Settings"]})}),e.jsx(xt,{children:e.jsxs(k,{sx:{pt:2},children:[e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Set the date when vacation days will reset for all employees. This date will be the same for everyone and will repeat on the same month and day every year (e.g., January 1st, July 1st, etc.)."}),e.jsx(Nn,{label:"Reset Date",value:w,onChange:H=>b(H),slotProps:{textField:{fullWidth:!0,size:"small"}}}),w&&e.jsxs(Fe,{severity:"info",sx:{mt:2},children:["Vacation days will reset on ",w.format("MMMM D")," every year for all employees."]})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>v(!1),disabled:P,children:"Cancel"}),e.jsx(Q,{onClick:y,disabled:P||!w,variant:"contained",children:P?"Saving...":"Save Settings"})]})]})]})})},mS=async()=>(await B.get("/api/products")).data,fS=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(!1),[s,o]=l.useState(null),[i,c]=l.useState({page:0,pageSize:10}),[u,d]=l.useState(""),[p,m]=l.useState(!1),[f,_]=l.useState(null),[v,w]=l.useState(null);l.useEffect(()=>{b()},[]);const b=async()=>{a(!0),o(null);try{const y=[...await mS()].sort((x,D)=>Number(D.product_id)-Number(x.product_id));r(y)}catch{o("Failed to fetch products"),z.error("Failed to fetch products")}finally{a(!1)}},P=t.filter(L=>{const y=u.toLowerCase();return L.product_name?.toLowerCase().includes(y)||L.product_description?.toLowerCase?.().includes(y)||String(L.product_id??"").toLowerCase().includes(y)}),N=async L=>{if(window.confirm("Are you sure you want to delete this product?"))try{await B.delete(`/api/products/${L}`),r(y=>y.filter(x=>x.product_id!==L)),z.success("Product deleted successfully")}catch{z.error("Failed to delete product")}},j=()=>{const L=P.map(X=>({"Product ID":X.product_id,"Product Name":X.product_name,"Product Description":X.product_description??""})),y=Un.unparse(L),x=new Blob([y],{type:"text/csv;charset=utf-8;"}),D=document.createElement("a"),M=URL.createObjectURL(x);D.href=M,D.setAttribute("download","products.csv"),D.style.visibility="hidden",document.body.appendChild(D),D.click(),document.body.removeChild(D),w("Products exported to CSV.")},E=()=>m(!0),A=()=>m(!1),C=[{field:"product_id",headerName:"Product ID",flex:.8,minWidth:110},{field:"product_name",headerName:"Product Name",flex:1.4,minWidth:200},{field:"product_description",headerName:"Product Description",flex:2,minWidth:250,valueGetter:L=>L.row.product_description??""},{field:"actions",headerName:"Actions",width:90,sortable:!1,filterable:!1,disableColumnMenu:!0,renderCell:L=>e.jsx(gt,{size:"small",color:"error",onClick:y=>{y.stopPropagation(),N(L.row.product_id)},children:e.jsx(xr,{})})}];return e.jsxs(nt,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{mb:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Product List"}),e.jsx(k,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:e.jsxs(Pe,{direction:"row",spacing:2,children:[e.jsx(Q,{variant:"contained",startIcon:e.jsx(Nr,{}),onClick:E,children:"New Product"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(gr,{}),onClick:j,children:"Export CSV"})]})})]}),e.jsx(Me,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(le,{fullWidth:!0,label:"Search",variant:"outlined",value:u,onChange:L=>d(L.target.value),InputProps:{startAdornment:e.jsx(mr,{position:"start",children:e.jsx(Hr,{sx:{fontSize:22}})})},sx:{mb:2,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"small"}),e.jsx(tn,{rows:P.map(L=>({...L,id:L.product_id})),columns:C,loading:n,paginationModel:i,onPaginationModelChange:c,pageSizeOptions:[10,25,50],getRowId:L=>L.id,disableRowSelectionOnClick:!0,initialState:{sorting:{sortModel:[{field:"product_id",sort:"desc"}]}},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})}),f&&e.jsx(Fe,{severity:"error",sx:{mt:2},onClose:()=>_(null),children:f}),v&&e.jsx(Fe,{severity:"success",sx:{mt:2},onClose:()=>w(null),children:v}),s&&e.jsx(h,{color:"error",children:s}),e.jsx(Yl,{open:p,onClose:A,onSave:async L=>{try{await B.post("/api/products",L),z.success("Product added successfully!"),m(!1),b()}catch{z.error("Failed to add product")}},isEditMode:!1})]})},xS=({open:t,onClose:r,onSettingsSaved:n})=>{const[a,s]=l.useState({customBackupDir:"",customRestoreDir:""}),[o,i]=l.useState(!1),[c,u]=l.useState(!1),[d,p]=l.useState(null),[m,f]=l.useState(!1);l.useEffect(()=>{t&&_()},[t]);const _=async()=>{i(!0);try{const j=await B.get("/api/backup/settings");s(j.data)}catch(j){console.error("Error fetching backup settings:",j),z.error("Failed to load backup settings")}finally{i(!1)}},v=async()=>{u(!0);try{await B.post("/api/backup/settings",a),z.success("Backup settings saved successfully!"),n(),r()}catch(j){console.error("Error saving backup settings:",j),z.error("Failed to save backup settings")}finally{u(!1)}},w=j=>{const E=j.target.files?.[0];E&&p(E)},b=async()=>{if(!d){z.error("Please select a backup file to upload");return}f(!0);try{const j=new FormData;j.append("backup",d);const E=await B.post("/api/backup/upload",j,{headers:{"Content-Type":"multipart/form-data"}});z.success("Backup uploaded successfully!"),p(null),n(),r()}catch(j){console.error("Error uploading backup:",j),z.error("Failed to upload backup file")}finally{f(!1)}},P=async()=>{try{if(window.api?.browseDirectory){const j=await window.api.browseDirectory({title:"Select Restore Directory"});j.success&&j.directory&&s(E=>({...E,customRestoreDir:j.directory}))}else z.info("Please enter the restore directory path manually")}catch(j){console.error("Error browsing restore directory:",j),z.error("Failed to browse directory")}},N=async()=>{try{if(window.api?.browseDirectory){const j=await window.api.browseDirectory({title:"Select Backup Directory"});j.success&&j.directory&&s(E=>({...E,customBackupDir:j.directory}))}else z.info("In web version, please enter the backup directory path manually. Example: C:\\MyBackups or /home/user/backups")}catch(j){console.error("Error browsing backup directory:",j),z.error("Failed to browse directory")}};return e.jsxs(mt,{open:t,onClose:r,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ds,{}),"Backup Settings"]})}),e.jsx(xt,{children:o?e.jsx(k,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(ot,{})}):e.jsxs(k,{sx:{mt:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Custom Backup Directory"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Set a custom directory where backups will be stored on the server device. Note: Backups are created on the server, not your local device. The directory must be accessible from the server where the application is running."}),e.jsxs(O,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(O,{item:!0,xs:!0,children:e.jsx(le,{fullWidth:!0,label:"Backup Directory Path",value:a.customBackupDir,onChange:j=>s(E=>({...E,customBackupDir:j.target.value})),placeholder:"e.g., C:\\MyBackups or /home/user/backups",helperText:a.customBackupDir?`Backups will be stored in: ${a.customBackupDir}`:"Leave empty to use default backup location (backups folder in server directory)"})}),e.jsx(O,{item:!0,children:e.jsx(Ht,{title:"Browse for backup directory (Desktop app only)",children:e.jsx(gt,{onClick:N,children:e.jsx(Xl,{})})})})]}),!a.customBackupDir&&e.jsxs(Fe,{severity:"info",sx:{mt:1},children:[e.jsx(Ti,{children:"Default Backup Location"}),"Backups will be stored in the default location: ",e.jsx("strong",{children:"backups/"})," folder in the server directory. To use a custom location, enter a valid directory path above."]}),a.customBackupDir&&!a.customDirExists&&e.jsxs(Fe,{severity:"warning",sx:{mt:1},children:[e.jsx(Ti,{children:"Directory Not Found"}),"The specified backup directory does not exist: ",e.jsx("strong",{children:a.customBackupDir}),"Backups will fall back to the default location until this directory is created."]}),a.currentBackupDir&&e.jsxs(Fe,{severity:"success",sx:{mt:1},children:[e.jsx(Ti,{children:"Current Backup Location"}),"Backups are currently being stored in: ",e.jsx("strong",{children:a.currentBackupDir})]}),e.jsx(fr,{sx:{my:3}}),e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Custom Restore Directory"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Set a custom directory on the server to look for backup files when restoring. Note: This directory must be accessible from the server."}),e.jsxs(O,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(O,{item:!0,xs:!0,children:e.jsx(le,{fullWidth:!0,label:"Restore Directory Path",value:a.customRestoreDir,onChange:j=>s(E=>({...E,customRestoreDir:j.target.value})),placeholder:"e.g., C:\\ExternalBackups or /home/user/external-backups",helperText:"Leave empty to use default restore location"})}),e.jsx(O,{item:!0,children:e.jsx(Ht,{title:"Browse for restore directory",children:e.jsx(gt,{onClick:P,children:e.jsx(Xl,{})})})})]}),e.jsx(fr,{sx:{my:3}}),e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Upload External Backup"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Upload a backup file from your device to restore from"}),e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsxs(Q,{variant:"outlined",component:"label",startIcon:e.jsx($o,{}),disabled:m,children:["Select Backup File",e.jsx("input",{type:"file",hidden:!0,accept:".zip,.sql,.json",onChange:w})]}),d&&e.jsxs(h,{variant:"body2",children:["Selected: ",d.name]}),d&&e.jsx(Q,{variant:"contained",onClick:b,disabled:m,startIcon:m?e.jsx(ot,{size:20}):e.jsx($o,{}),children:m?"Uploading...":"Upload & Restore"})]}),e.jsx(Fe,{severity:"info",sx:{mt:2},children:e.jsxs(h,{variant:"body2",children:[e.jsx("strong",{children:"Note:"})," Custom directories must be accessible by the application. Make sure the directories exist and have proper read/write permissions."]})})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:r,children:"Cancel"}),e.jsx(Q,{onClick:v,variant:"contained",disabled:c||o,startIcon:c?e.jsx(ot,{size:20}):void 0,children:c?"Saving...":"Save Settings"})]})]})},gS=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(null),[s,o]=l.useState(!1),[i,c]=l.useState(!1),[u,d]=l.useState(null),[p,m]=l.useState(null),[f,_]=l.useState(null),[v,w]=l.useState(!1),b=async()=>{o(!0);try{const[x,D]=await Promise.all([B.get("/api/backup/list"),B.get("/api/backup/stats")]);r(x.data.backups),a(D.data)}catch(x){console.error("Error fetching backups:",x),z.error("Failed to fetch backups")}finally{o(!1)}};l.useEffect(()=>{b()},[]);const P=async()=>{c(!0);try{const x=await B.post("/api/backup/create");z.success("Backup created successfully!"),b()}catch(x){console.error("Error creating backup:",x),z.error("Failed to create backup")}finally{c(!1)}},N=async x=>{try{const D=await B.get(`/api/backup/download/${x}`,{responseType:"blob"}),M=window.URL.createObjectURL(new Blob([D.data])),X=document.createElement("a");X.href=M,X.setAttribute("download",x),document.body.appendChild(X),X.click(),X.remove(),window.URL.revokeObjectURL(M),z.success("Backup downloaded successfully!")}catch(D){console.error("Error downloading backup:",D),z.error("Failed to download backup")}},j=async x=>{try{await B.delete(`/api/backup/delete/${x}`),z.success("Backup deleted successfully!"),m(null),b()}catch(D){console.error("Error deleting backup:",D),z.error("Failed to delete backup")}},E=async x=>{d(x.manifest);try{const M=(await B.post(`/api/backup/restore/${x.manifest}`)).data.results,X=Object.values(M).filter(U=>U==="success").length,H=Object.keys(M).length;X===H?z.success("Backup restored successfully! Please refresh the page."):z.warning(`Restore completed with ${X}/${H} components successful`),_(null),d(null)}catch(D){console.error("Error restoring backup:",D),z.error("Failed to restore backup"),d(null)}},A=x=>{if(x===0)return"0 Bytes";const D=1024,M=["Bytes","KB","MB","GB"],X=Math.floor(Math.log(x)/Math.log(D));return parseFloat((x/Math.pow(D,X)).toFixed(2))+" "+M[X]},C=x=>x.replace(/(\d{4}-\d{2}-\d{2})T(\d{2})-(\d{2})-(\d{2})-(\d{3})Z/,"$1T$2:$3:$4.$5Z"),L=x=>new Date(C(x)).toLocaleString(),y=x=>{const D=x.components,M=Object.keys(D).length;return`${Object.values(D).filter(H=>H!==null).length}/${M}`};return e.jsxs(nt,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{mb:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Backup Management"}),e.jsx(h,{variant:"body1",color:"text.secondary",gutterBottom:!0,children:"Create, manage, and restore backups of your application data"})]}),n&&e.jsxs(O,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsx(h,{color:"text.secondary",gutterBottom:!0,children:"Total Backups"}),e.jsx(h,{variant:"h4",component:"div",children:n.total_backups})]})})}),e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsx(h,{color:"text.secondary",gutterBottom:!0,children:"Total Size"}),e.jsx(h,{variant:"h4",component:"div",children:A(n.total_size)})]})})})]}),e.jsxs(k,{sx:{mb:3,display:"flex",gap:2,flexWrap:"wrap"},children:[e.jsx(Q,{variant:"contained",startIcon:i?e.jsx(ot,{size:20}):e.jsx(Il,{}),onClick:P,disabled:i,children:i?"Creating Backup...":"Create Backup"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(Ol,{}),onClick:b,disabled:s,children:"Refresh"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(Ds,{}),onClick:()=>w(!0),children:"Backup Settings"})]}),e.jsx(Fe,{severity:"warning",sx:{mb:3},children:e.jsxs(h,{variant:"body2",children:[e.jsx("strong",{children:"Important:"})," Restoring a backup will overwrite your current data. Make sure you have a backup of your current data before proceeding."]})}),e.jsx(Me,{sx:{width:"100%",overflow:"hidden"},children:e.jsx(dr,{children:e.jsxs(ir,{children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Date & Time"}),e.jsx(ne,{children:"Components"}),e.jsx(ne,{children:"Size"}),e.jsx(ne,{children:"System Info"}),e.jsx(ne,{align:"center",children:"Actions"})]})}),e.jsx(cr,{children:s?e.jsx(ht,{children:e.jsx(ne,{colSpan:5,align:"center",children:e.jsx(ot,{})})}):t.length===0?e.jsx(ht,{children:e.jsx(ne,{colSpan:5,align:"center",children:e.jsx(h,{variant:"body2",color:"text.secondary",children:"No backups found. Create your first backup to get started."})})}):t.map(x=>e.jsxs(ht,{hover:!0,children:[e.jsx(ne,{children:e.jsx(h,{variant:"body2",children:L(x.timestamp)})}),e.jsxs(ne,{children:[e.jsxs(k,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[x.components.database&&e.jsx(De,{label:"Database",size:"small",color:"primary"}),x.components.uploads&&e.jsx(De,{label:"Uploads",size:"small",color:"secondary"}),x.components.config&&e.jsx(De,{label:"Config",size:"small",color:"default"})]}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:[y(x)," components available"]})]}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",children:A(x.size)})}),e.jsx(ne,{children:e.jsxs(h,{variant:"caption",color:"text.secondary",children:[x.system_info.platform,"  ",x.system_info.arch]})}),e.jsx(ne,{align:"center",children:e.jsxs(k,{sx:{display:"flex",gap:1,justifyContent:"center"},children:[e.jsx(Ht,{title:"Download Backup",children:e.jsx(gt,{size:"small",onClick:()=>N(x.manifest),children:e.jsx(Nu,{})})}),e.jsx(Ht,{title:"Restore Backup",children:e.jsx(gt,{size:"small",color:"primary",onClick:()=>_(x),children:e.jsx(Zl,{})})}),e.jsx(Ht,{title:"Delete Backup",children:e.jsx(gt,{size:"small",color:"error",onClick:()=>m(x.manifest),children:e.jsx(qs,{})})})]})})]},x.manifest))})]})})}),e.jsxs(mt,{open:!!p,onClose:()=>m(null),children:[e.jsx(ft,{children:"Delete Backup"}),e.jsx(xt,{children:e.jsx(h,{children:"Are you sure you want to delete this backup? This action cannot be undone."})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>m(null),children:"Cancel"}),e.jsx(Q,{onClick:()=>p&&j(p),color:"error",variant:"contained",children:"Delete"})]})]}),e.jsxs(mt,{open:!!f,onClose:()=>_(null),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Zh,{color:"warning"}),"Restore Backup"]})}),e.jsxs(xt,{children:[e.jsx(Fe,{severity:"warning",sx:{mb:2},children:e.jsxs(h,{variant:"body2",children:[e.jsx("strong",{children:"Warning:"})," This will overwrite your current data with the backup from"," ",f?L(f.timestamp):"","."]})}),e.jsx(h,{variant:"body2",gutterBottom:!0,children:"Backup components:"}),e.jsxs(k,{sx:{display:"flex",gap:1,mb:2},children:[f?.components.database&&e.jsx(De,{label:"Database",size:"small",color:"primary"}),f?.components.uploads&&e.jsx(De,{label:"Uploads",size:"small",color:"secondary"}),f?.components.config&&e.jsx(De,{label:"Config",size:"small",color:"default"})]}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Make sure you have a backup of your current data before proceeding."})]}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>_(null),children:"Cancel"}),e.jsx(Q,{onClick:()=>f&&E(f),color:"warning",variant:"contained",disabled:u===f?.manifest,startIcon:u===f?.manifest?e.jsx(ot,{size:20}):e.jsx(Zl,{}),children:u===f?.manifest?"Restoring...":"Restore"})]})]}),e.jsx(xS,{open:v,onClose:()=>w(!1),onSettingsSaved:b})]})},yS=()=>{const{user:t}=er(),[r,n]=l.useState([]),[a,s]=l.useState([]),[o,i]=l.useState(""),[c,u]=l.useState(!0),[d,p]=l.useState(null),[m,f]=l.useState(!1),[_,v]=l.useState({name:"",email:""}),[w,b]=l.useState(!1),[P,N]=l.useState(null),j=l.useRef(null),E=M=>{j.current&&window.clearTimeout(j.current),N(M),j.current=window.setTimeout(()=>{N(null),j.current=null},2500)};l.useEffect(()=>()=>{j.current&&window.clearTimeout(j.current)},[]),l.useEffect(()=>{A()},[]),l.useEffect(()=>{o?C():s([])},[o]);const A=async()=>{try{u(!0);const M=await Vl();n(M),p(null)}catch(M){p("Failed to fetch data. Please try again."),console.error("Error fetching data:",M)}finally{u(!1)}},C=async()=>{if(o)try{const M=await tS(o);s(M);const X=new Date;X.setDate(X.getDate()-1);const H=M.find(U=>!U.clock_out&&new Date(U.clock_in).toDateString()!==new Date().toDateString());b(!!H)}catch(M){p("Failed to fetch shifts. Please try again."),console.error("Error fetching shifts:",M)}},L=async()=>{if(!o){p("Please select a profile");return}if(a.some(M=>!M.clock_out)){p("You are already clocked in. Please clock out first.");return}try{const M=await rS(o);s([M,...a]),p(null),i(""),s([]),E("Successfully clocked in.")}catch(M){p("Failed to clock in. Please try again."),console.error("Error clocking in:",M)}},y=async M=>{try{const X=await nS(M);s(a.map(H=>H.id===M?X:H)),p(null),i(""),s([]),E("Successfully clocked out.")}catch(X){p("Failed to clock out. Please try again."),console.error("Error clocking out:",X)}},x=async()=>{try{const M=await qw(_.name,_.email);n([...r,M]),f(!1),v({name:"",email:""}),p(null)}catch(M){p("Failed to create profile. Please try again."),console.error("Error creating profile:",M)}},D=o&&a.some(M=>M.profile_id===o&&!M.clock_out);return c?e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(ot,{})}):e.jsxs(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Attendance (Shift Tracking)"}),d&&e.jsx(Fe,{severity:"error",sx:{mb:2},children:d}),w&&e.jsx(Fe,{severity:"warning",sx:{mb:2},children:"You have an unclosed shift from a previous day. Please clock out before starting a new shift."}),e.jsxs(mt,{open:!!P,onClose:()=>N(null),PaperProps:{sx:{px:6,py:4,textAlign:"center"}},children:[e.jsx(ft,{sx:{fontSize:"2rem"},children:"Success"}),e.jsx(xt,{children:e.jsx(h,{variant:"h4",component:"p",children:P})})]}),e.jsxs(O,{container:!0,spacing:3,children:[e.jsx(O,{item:!0,xs:12,md:6,children:e.jsxs(Me,{sx:{p:2},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsx(h,{variant:"h6",children:"Profile"}),t?.access_role!=="Time Tracking"&&e.jsx(Q,{startIcon:e.jsx(ti,{}),onClick:()=>f(!0),children:"Add Profile"})]}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Select Profile"}),e.jsx(Ut,{value:o,label:"Select Profile",onChange:M=>i(M.target.value),sx:{"& .MuiSelect-select":{fontSize:"1.1rem"}},renderValue:M=>{const X=r.find(H=>H.id===M);return X?X.name:""},children:r.map(M=>e.jsxs(Ze,{value:M.id,sx:{fontSize:"1.1rem",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:M.name}),t?.access_role==="Admin"&&e.jsx(gt,{"aria-label":`Delete ${M.name}`,size:"small",edge:"end",onClick:async X=>{if(X.preventDefault(),X.stopPropagation(),!!window.confirm(`Delete profile "${M.name}"? This cannot be undone.`))try{await B.delete(`/api/time-tracking/profiles/${M.id}`),n(U=>U.filter(G=>G.id!==M.id)),o===M.id&&i(""),z.success("Profile deleted")}catch(U){const G=U?.response?.data?.error||"Failed to delete profile";z.error(G)}},sx:{ml:2,color:"error.main"},children:e.jsx(qs,{fontSize:"small"})})]},M.id))})]})]})}),o&&!D&&e.jsx(O,{item:!0,xs:12,children:e.jsx(Me,{sx:{p:2},children:e.jsx(k,{display:"flex",justifyContent:"center",gap:2,children:e.jsx(Q,{variant:"contained",sx:{backgroundColor:"green","&:hover":{backgroundColor:"darkgreen"}},onClick:L,children:"Clock In"})})})}),o&&e.jsx(O,{item:!0,xs:12,children:e.jsxs(Me,{sx:{p:2},children:[e.jsx(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:e.jsxs(h,{variant:"h6",gutterBottom:!0,children:["Shift History for ",r.find(M=>M.id===o)?.name]})}),e.jsx(dr,{children:e.jsxs(ir,{children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Clock In"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Clock Out"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Duration"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Actions"})]})}),e.jsx(cr,{children:a.map(M=>{const X=new Date(M.clock_in),H=M.clock_out?new Date(M.clock_out):null,U=M.duration!==null&&M.duration!==void 0?Number(M.duration):null;return e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.1rem"},children:X.toLocaleString()}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:H?H.toLocaleString():"-"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:U!==null?`${U.toFixed(2)} hrs`:"-"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:!M.clock_out&&e.jsx(Q,{variant:"contained",sx:{backgroundColor:"red","&:hover":{backgroundColor:"darkred"}},onClick:()=>y(M.id),children:"Clock Out"})})]},M.id)})})]})})]})})]}),e.jsxs(mt,{open:m,onClose:()=>f(!1),children:[e.jsx(ft,{children:"Add Profile"}),e.jsxs(xt,{children:[e.jsx(le,{label:"Name",value:_.name,onChange:M=>v({..._,name:M.target.value}),fullWidth:!0,sx:{mb:2}}),e.jsx(le,{label:"Email",value:_.email,onChange:M=>v({..._,email:M.target.value}),fullWidth:!0})]}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>f(!1),children:"Cancel"}),e.jsx(Q,{onClick:x,variant:"contained",children:"Save"})]})]})]})};var Fa={},cu;function vS(){if(cu)return Fa;cu=1;var t=vt();Object.defineProperty(Fa,"__esModule",{value:!0}),Fa.default=void 0;var r=t(_t()),n=bt();return Fa.default=(0,r.default)((0,n.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"}),"ArrowBack"),Fa}var bS=vS();const Si=st(bS);var Wa={},du;function _S(){if(du)return Wa;du=1;var t=vt();Object.defineProperty(Wa,"__esModule",{value:!0}),Wa.default=void 0;var r=t(_t()),n=bt();return Wa.default=(0,r.default)((0,n.jsx)("path",{d:"M4 10h3v7H4zm6.5 0h3v7h-3zM2 19h20v3H2zm15-9h3v7h-3zm-5-9L2 6v2h20V6z"}),"AccountBalance"),Wa}var jS=_S();const kl=st(jS),wS=()=>{const t=Gt(),[r,n]=l.useState(!0),[a,s]=l.useState(!1),[o,i]=l.useState([]),[c,u]=l.useState({}),[d,p]=l.useState(null),[m,f]=l.useState(null),[_,v]=l.useState(""),[w,b]=l.useState(""),[P,N]=l.useState(""),[j,E]=l.useState(""),[A,C]=l.useState(""),[L,y]=l.useState(""),[x,D]=l.useState(""),[M,X]=l.useState(""),[H,U]=l.useState(""),[G,te]=l.useState(""),[re,S]=l.useState(""),[g,T]=l.useState(""),[q,ee]=l.useState(!1),[R,K]=l.useState(""),[F,xe]=l.useState("");l.useEffect(()=>{de()},[]);const ve=()=>{const W=`${Is().baseURL}/api/qbo/auth`;window.location.href=W},de=async()=>{n(!0);try{const I=await B.get("/api/qbo-accounts/test-connection");if(f(I.data),I.data.connected){const W=await B.get("/api/qbo-accounts/accounts");i(W.data.accounts),u(W.data.accountTypes);const ce=await B.get("/api/qbo-accounts/mapping");ce.data.mapping&&(p(ce.data.mapping),v(ce.data.mapping.qbo_inventory_account_id),b(ce.data.mapping.qbo_gst_account_id),N(ce.data.mapping.qbo_ap_account_id),E(ce.data.mapping.qbo_supply_expense_account_id||""),C(ce.data.mapping.qbo_sales_account_id||""),y(ce.data.mapping.qbo_labour_sales_account_id||""),D(ce.data.mapping.qbo_ar_account_id||""),X(ce.data.mapping.qbo_cogs_account_id||""),U(ce.data.mapping.qbo_cost_of_labour_account_id||""),te(ce.data.mapping.qbo_cost_of_materials_account_id||""),S(ce.data.mapping.qbo_labour_expense_reduction_account_id||""),T(ce.data.mapping.qbo_overhead_cogs_account_id||""))}}catch(I){console.error("Error loading QBO data:",I),z.error("Failed to load QuickBooks data")}finally{n(!1)}},me=async()=>{if(!_||!w||!P){z.error("Please select all required accounts");return}s(!0);try{const I=await B.post("/api/qbo-accounts/mapping",{qbo_inventory_account_id:_,qbo_gst_account_id:w,qbo_ap_account_id:P,qbo_supply_expense_account_id:j,qbo_sales_account_id:A,qbo_labour_sales_account_id:L,qbo_ar_account_id:x,qbo_cogs_account_id:M,qbo_cost_of_labour_account_id:H,qbo_cost_of_materials_account_id:G,qbo_labour_expense_reduction_account_id:re,qbo_overhead_cogs_account_id:g});p(I.data.mapping),z.success("Account mapping saved successfully")}catch(I){console.error("Error saving mapping:",I),z.error("Failed to save account mapping")}finally{s(!1)}},ge=I=>{const W=I.AccountNumber?`#${I.AccountNumber}`:"";return`${I.Name} ${W} (${I.AccountType})`},pe=I=>{let W=o.filter(ce=>ce.Classification===I);if(F){const ce=F.toLowerCase();W=W.filter(Z=>Z.Name.toLowerCase().includes(ce)||Z.AccountNumber&&Z.AccountNumber.includes(ce)||Z.Description&&Z.Description.toLowerCase().includes(ce))}return W},se=()=>e.jsxs(mt,{open:q,onClose:()=>ee(!1),maxWidth:"md",fullWidth:!0,children:[e.jsxs(ft,{children:["QuickBooks Accounts - ",R]}),e.jsx(xt,{children:e.jsx(k,{sx:{mt:2},children:c[R]?.map(I=>e.jsx(kt,{sx:{mb:1,p:2},children:e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"flex-start",children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h6",children:I.Name}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Type: ",I.AccountType," | Subtype: ",I.AccountSubType]}),I.AccountNumber&&e.jsxs(h,{variant:"body2",color:"primary",fontWeight:500,children:["Account #: ",I.AccountNumber]}),I.Description&&e.jsx(h,{variant:"body2",color:"text.secondary",children:I.Description})]}),e.jsx(De,{label:I.AccountNumber||"No Number",size:"small",color:I.AccountNumber?"primary":"default",variant:"outlined"})]})},I.Id))})}),e.jsx(jt,{children:e.jsx(Q,{onClick:()=>ee(!1),children:"Close"})})]});return r?e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(ot,{})}):e.jsxs(nt,{maxWidth:"lg",sx:{py:4},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Q,{startIcon:e.jsx(Si,{}),onClick:()=>t("/business-profile"),sx:{mr:2},children:"Back"}),e.jsx(h,{variant:"h4",component:"h1",children:"QuickBooks Account Mapping"})]}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(kl,{}),onClick:ve,sx:{borderRadius:2,fontWeight:600},children:"Connect to QuickBooks"})]}),m&&e.jsx(kt,{sx:{mb:3},children:e.jsxs(Ot,{children:[e.jsxs(k,{display:"flex",alignItems:"center",gap:2,children:[m.connected?e.jsx(Ln,{color:"success"}):e.jsx(wi,{color:"error"}),e.jsx(h,{variant:"h6",children:m.connected?"Connected to QuickBooks":"Not Connected"})]}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mt:1},children:m.message}),m.connected&&m.realmId&&e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Realm ID: ",m.realmId]})]})}),m?.connected?e.jsxs(e.Fragment,{children:[e.jsx(O,{container:!0,spacing:3,sx:{mb:3},children:Object.entries(c).map(([I,W])=>e.jsx(O,{item:!0,xs:12,sm:6,md:4,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:I}),e.jsx(h,{variant:"h4",color:"primary",children:W.length}),e.jsx(Q,{size:"small",onClick:()=>{K(I),ee(!0)},sx:{mt:1},children:"View Accounts"})]})})},I))}),e.jsxs(Me,{sx:{p:3},children:[e.jsx(h,{variant:"h5",gutterBottom:!0,children:"Map QuickBooks Accounts"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Select the QuickBooks accounts that correspond to your business accounts. Different companies use different account names, so choose the accounts that make sense for your business."}),e.jsxs(Fe,{severity:"info",sx:{mb:3},children:[e.jsxs(h,{variant:"body2",children:[e.jsx("strong",{children:"How this works:"})," Configure your QuickBooks accounts to map to your business transactions. Accounts used by both purchase orders and sales orders are shown at the top."]}),e.jsxs(h,{variant:"body2",sx:{mt:1},children:[e.jsx("strong",{children:"Purchase Orders:"})," Stock items  Inventory Account, Supply items  Supply Expense Account, GST  GST Account, Total  Accounts Payable."]}),e.jsxs(h,{variant:"body2",sx:{mt:1},children:[e.jsx("strong",{children:"Sales Orders:"})," Materials  Sales Account, Labour  Labour Sales Account, GST  GST Account, Total  Accounts Receivable, Costs  COGS Account."]})]}),e.jsx(k,{sx:{mb:3},children:e.jsx(le,{fullWidth:!0,label:"Search accounts by name, number, or description",value:F,onChange:I=>xe(I.target.value),placeholder:"e.g., 1200, Inventory, GST...",size:"small",InputProps:{startAdornment:e.jsx(Hr,{sx:{mr:1,color:"text.secondary"}})}})}),e.jsx(h,{variant:"h6",sx:{mt:4,mb:2,color:"primary.main"},children:"Shared Accounts (Purchase Orders & Sales Orders)"}),e.jsxs(O,{container:!0,spacing:3,children:[e.jsxs(O,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"GST/Tax Account"}),e.jsx(Ut,{value:w,onChange:I=>b(I.target.value),label:"GST/Tax Account",children:pe("Liability").map(I=>e.jsx(Ze,{value:I.Id,children:ge(I)},I.Id))})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Account for GST/HST/tax tracking (used by both purchase orders and sales orders)"})]}),e.jsxs(O,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Inventory Account"}),e.jsx(Ut,{value:_,onChange:I=>v(I.target.value),label:"Inventory Account",children:pe("Asset").map(I=>e.jsx(Ze,{value:I.Id,children:ge(I)},I.Id))})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Account for tracking inventory (stock purchases and sales cost reduction)"})]})]}),e.jsx(h,{variant:"h6",sx:{mt:4,mb:2},children:"Purchase Order Account Mapping"}),e.jsxs(O,{container:!0,spacing:3,children:[e.jsxs(O,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Supply Expense Account"}),e.jsxs(Ut,{value:j,onChange:I=>E(I.target.value),label:"Supply Expense Account",children:[e.jsx(Ze,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),pe("Expense").map(I=>e.jsx(Ze,{value:I.Id,children:ge(I)},I.Id))]})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Account for supply items (e.g., Office Supplies, Tools, etc.) - Optional"})]}),e.jsxs(O,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Accounts Payable"}),e.jsx(Ut,{value:P,onChange:I=>N(I.target.value),label:"Accounts Payable",children:pe("Liability").map(I=>e.jsx(Ze,{value:I.Id,children:ge(I)},I.Id))})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:'Account for tracking vendor payables (usually "Accounts Payable")'})]})]}),e.jsx(h,{variant:"h6",sx:{mt:4,mb:2},children:"Sales Order Account Mapping"}),e.jsxs(O,{container:!0,spacing:3,children:[e.jsxs(O,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Sales Account"}),e.jsx(Ut,{value:A,onChange:I=>C(I.target.value),label:"Sales Account",children:pe("Revenue").map(I=>e.jsx(Ze,{value:I.Id,children:ge(I)},I.Id))})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Revenue account for sales (e.g., Sales, Revenue, etc.) - Used for invoice creation"})]}),e.jsxs(O,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Accounts Receivable"}),e.jsx(Ut,{value:x,onChange:I=>D(I.target.value),label:"Accounts Receivable",children:pe("Asset").map(I=>e.jsx(Ze,{value:I.Id,children:ge(I)},I.Id))})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:'Account for tracking customer receivables (usually "Accounts Receivable") - Used for invoice total amount'})]})]}),e.jsx(h,{variant:"h6",sx:{mt:4,mb:2},children:"Cost Accounts (Journal Entries)"}),e.jsxs(O,{container:!0,spacing:3,children:[e.jsxs(O,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Cost of Materials"}),e.jsxs(Ut,{value:G,onChange:I=>te(I.target.value),label:"Cost of Materials",children:[e.jsx(Ze,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),pe("Expense").map(I=>e.jsx(Ze,{value:I.Id,children:ge(I)},I.Id))]})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Expense account for tracking cost of materials sold - Used for COGS journal entries - Optional"})]}),e.jsxs(O,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Cost of Labour"}),e.jsxs(Ut,{value:H,onChange:I=>U(I.target.value),label:"Cost of Labour",children:[e.jsx(Ze,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),pe("Expense").map(I=>e.jsx(Ze,{value:I.Id,children:ge(I)},I.Id))]})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Expense account for tracking cost of labour sold - Used for COGS journal entries - Optional"})]}),e.jsxs(O,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Labour Expense Reduction Account"}),e.jsxs(Ut,{value:re,onChange:I=>S(I.target.value),label:"Labour Expense Reduction Account",children:[e.jsx(Ze,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),pe("Expense").map(I=>e.jsx(Ze,{value:I.Id,children:ge(I)},I.Id))]})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Expense account for reducing labour costs when sold (e.g., Labour Expense, Wages Expense) - Used for COGS journal entries - Optional"})]}),e.jsxs(O,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Overhead COGS Account"}),e.jsxs(Ut,{value:g,onChange:I=>T(I.target.value),label:"Overhead COGS Account",children:[e.jsx(Ze,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),pe("Expense").map(I=>e.jsx(Ze,{value:I.Id,children:ge(I)},I.Id))]})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Expense account for tracking overhead costs when sold - Used for COGS journal entries - Optional"})]})]}),e.jsx(k,{sx:{mt:3,display:"flex",justifyContent:"center"},children:e.jsx(Q,{variant:"outlined",onClick:()=>t("/overhead-management"),sx:{width:"100%",maxWidth:"600px",borderRadius:2,fontWeight:600,py:1.5,fontSize:"1.1rem"},children:"Manage Overhead Settings"})}),e.jsxs(k,{sx:{mt:3,display:"flex",gap:2},children:[e.jsx(Q,{variant:"contained",startIcon:e.jsx(is,{}),onClick:me,disabled:a||!_||!w||!P,children:a?"Saving...":"Save Mapping"}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(_n,{}),onClick:de,disabled:r,children:"Refresh"})]}),d&&e.jsxs(k,{sx:{mt:3,p:2,bgcolor:"grey.50",borderRadius:1},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Current Mapping"}),e.jsx(h,{variant:"subtitle2",color:"primary",sx:{mt:2,mb:1},children:"Shared Accounts (Purchase Orders & Sales Orders)"}),e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["GST/Tax: ",(()=>{const I=o.find(W=>W.Id===d.qbo_gst_account_id);return I?`${I.Name}${I.AccountNumber?` (#${I.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(O,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Inventory: ",(()=>{const I=o.find(W=>W.Id===d.qbo_inventory_account_id);return I?`${I.Name}${I.AccountNumber?` (#${I.AccountNumber})`:""}`:"Not configured"})()]})})]}),e.jsx(h,{variant:"subtitle2",color:"primary",sx:{mt:2,mb:1},children:"Purchase Order Accounts"}),e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Supply Expense: ",(()=>{const I=o.find(W=>W.Id===d.qbo_supply_expense_account_id);return I?`${I.Name}${I.AccountNumber?` (#${I.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(O,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Accounts Payable: ",(()=>{const I=o.find(W=>W.Id===d.qbo_ap_account_id);return I?`${I.Name}${I.AccountNumber?` (#${I.AccountNumber})`:""}`:"Not configured"})()]})})]}),e.jsx(h,{variant:"subtitle2",color:"primary",sx:{mt:2,mb:1},children:"Sales Order Accounts"}),e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Sales: ",(()=>{const I=o.find(W=>W.Id===d.qbo_sales_account_id);return I?`${I.Name}${I.AccountNumber?` (#${I.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(O,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Accounts Receivable: ",(()=>{const I=o.find(W=>W.Id===d.qbo_ar_account_id);return I?`${I.Name}${I.AccountNumber?` (#${I.AccountNumber})`:""}`:"Not configured"})()]})})]}),e.jsx(h,{variant:"subtitle2",color:"primary",sx:{mt:2,mb:1},children:"Cost Accounts"}),e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Cost of Materials: ",(()=>{const I=o.find(W=>W.Id===d.qbo_cost_of_materials_account_id);return I?`${I.Name}${I.AccountNumber?` (#${I.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(O,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Cost of Labour: ",(()=>{const I=o.find(W=>W.Id===d.qbo_cost_of_labour_account_id);return I?`${I.Name}${I.AccountNumber?` (#${I.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(O,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Labour Expense Reduction: ",(()=>{const I=o.find(W=>W.Id===d.qbo_labour_expense_reduction_account_id);return I?`${I.Name}${I.AccountNumber?` (#${I.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(O,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Overhead COGS: ",(()=>{const I=o.find(W=>W.Id===d.qbo_overhead_cogs_account_id);return I?`${I.Name}${I.AccountNumber?` (#${I.AccountNumber})`:""}`:"Not configured"})()]})})]})]})]})]}):e.jsx(Fe,{severity:"warning",sx:{mb:3},children:"Please connect your QuickBooks account first in the Business Profile page."}),se()]})},SS=()=>{const t=Gt(),[r,n]=l.useState(!0),[a,s]=l.useState(!1),[o,i]=l.useState([]),[c,u]=l.useState({}),[d,p]=l.useState([]),[m,f]=l.useState(null),[_,v]=l.useState(!1),[w,b]=l.useState(""),[P,N]=l.useState(""),[j,E]=l.useState(!1),[A,C]=l.useState(null),[L,y]=l.useState({expense_account_id:"",percentage:"",description:""});l.useEffect(()=>{x()},[]);const x=async()=>{n(!0);try{const[S,g]=await Promise.all([B.get("/api/qbo-accounts/accounts"),B.get("/api/overhead/distribution")]);i(S.data.accounts||[]),u(S.data.accountTypes||{}),p(g.data||[]),f({connected:!0,message:"Connected to QuickBooks"})}catch(S){console.error("Error loading data:",S),f({connected:!1,message:S.response?.data?.error||"Failed to connect to QuickBooks"}),z.error("Failed to load overhead management data")}finally{n(!1)}},D=async()=>{if(!L.expense_account_id||!L.percentage){z.error("Please fill in all required fields");return}const S=parseFloat(L.percentage);if(isNaN(S)||S<=0||S>100){z.error("Percentage must be between 0 and 100");return}const g=d.filter(T=>T.id!==A?.id).reduce((T,q)=>T+q.percentage,0);if(g+S>100){z.error(`Total percentage would exceed 100%. Current total: ${g}%, adding: ${S}%`);return}s(!0);try{A?(await B.put(`/api/overhead/distribution/${A.id}`,{expense_account_id:L.expense_account_id,percentage:S,description:L.description}),z.success("Distribution updated successfully")):(await B.post("/api/overhead/distribution",{expense_account_id:L.expense_account_id,percentage:S,description:L.description}),z.success("Distribution added successfully")),E(!1),C(null),y({expense_account_id:"",percentage:"",description:""}),x()}catch(T){console.error("Error saving distribution:",T),z.error(T.response?.data?.error||"Failed to save distribution")}finally{s(!1)}},M=S=>{C(S),y({expense_account_id:S.expense_account_id,percentage:S.percentage.toString(),description:S.description}),E(!0)},X=async S=>{if(window.confirm("Are you sure you want to delete this distribution?"))try{await B.delete(`/api/overhead/distribution/${S}`),z.success("Distribution deleted successfully"),x()}catch(g){console.error("Error deleting distribution:",g),z.error(g.response?.data?.error||"Failed to delete distribution")}},H=()=>{C(null),y({expense_account_id:"",percentage:"",description:""}),E(!0)},U=S=>`${S.Name} (${S.AccountType})`,G=S=>(c[S]||[]).filter(g=>g.Classification===S).map(g=>({label:U(g),value:g.Id,account:g})),te=()=>e.jsxs(mt,{open:_,onClose:()=>v(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:e.jsxs(k,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(kl,{}),"QuickBooks Accounts"]})}),e.jsxs(xt,{children:[e.jsx(k,{mb:2,children:e.jsx(le,{fullWidth:!0,label:"Search accounts",value:P,onChange:S=>N(S.target.value),InputProps:{startAdornment:e.jsx(Hr,{})}})}),e.jsxs(Mt,{fullWidth:!0,sx:{mb:2},children:[e.jsx(qt,{children:"Account Type"}),e.jsxs(Ut,{value:w,onChange:S=>b(S.target.value),label:"Account Type",children:[e.jsx(Ze,{value:"",children:"All Types"}),e.jsx(Ze,{value:"Asset",children:"Asset"}),e.jsx(Ze,{value:"Liability",children:"Liability"}),e.jsx(Ze,{value:"Equity",children:"Equity"}),e.jsx(Ze,{value:"Revenue",children:"Revenue"}),e.jsx(Ze,{value:"Expense",children:"Expense"})]})]}),e.jsx(k,{maxHeight:400,overflow:"auto",children:Object.entries(c).map(([S,g])=>{if(w&&S!==w)return null;const T=g.filter(q=>q.Name.toLowerCase().includes(P.toLowerCase())||q.AccountType.toLowerCase().includes(P.toLowerCase()));return T.length===0?null:e.jsxs(k,{mb:3,children:[e.jsxs(h,{variant:"h6",gutterBottom:!0,children:[S," Accounts (",T.length,")"]}),e.jsx(O,{container:!0,spacing:1,children:T.map(q=>e.jsx(O,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(kt,{variant:"outlined",sx:{p:1},children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:q.Name}),e.jsx(h,{variant:"caption",color:"textSecondary",children:q.AccountType}),q.AccountNumber&&e.jsxs(h,{variant:"caption",display:"block",color:"textSecondary",children:["#",q.AccountNumber]})]})},q.Id))})]},S)})})]}),e.jsx(jt,{children:e.jsx(Q,{onClick:()=>v(!1),children:"Close"})})]}),re=d.reduce((S,g)=>S+g.percentage,0);return e.jsxs(nt,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(gt,{onClick:()=>t(-1),children:e.jsx(Si,{})}),e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Overhead Management"})]}),e.jsxs(Pe,{direction:"row",spacing:2,children:[e.jsx(Q,{variant:"outlined",onClick:()=>v(!0),startIcon:e.jsx(kl,{}),children:"View QBO Accounts"}),e.jsx(Q,{variant:"contained",onClick:H,startIcon:e.jsx(Nr,{}),children:"Add Distribution"}),e.jsx(Q,{variant:"outlined",onClick:x,startIcon:e.jsx(_n,{}),children:"Refresh"})]})]}),m&&e.jsx(Fe,{severity:m.connected?"success":"error",icon:m.connected?e.jsx(Ln,{}):e.jsx(wi,{}),sx:{mb:3},children:m.message}),e.jsxs(Me,{sx:{p:3,mb:3},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Distribution Summary"}),e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Total Distributions"}),e.jsx(h,{variant:"h4",children:d.length})]})})}),e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Total Percentage"}),e.jsxs(h,{variant:"h4",color:re===100?"success.main":"warning.main",children:[re.toFixed(1),"%"]})]})})}),e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Remaining"}),e.jsxs(h,{variant:"h4",color:re>100?"error.main":"text.primary",children:[(100-re).toFixed(1),"%"]})]})})}),e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Status"}),e.jsx(De,{label:re===100?"Complete":re>100?"Over 100%":"Incomplete",color:re===100?"success":re>100?"error":"warning"})]})})})]})]}),e.jsx(Me,{sx:{width:"100%",overflow:"hidden"},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Expense Distributions"}),r?e.jsx(k,{display:"flex",justifyContent:"center",p:3,children:e.jsx(ot,{})}):d.length===0?e.jsx(Fe,{severity:"info",children:'No expense distributions configured. Click "Add Distribution" to get started.'}):e.jsx(O,{container:!0,spacing:2,children:d.map(S=>{const g=o.find(T=>T.Id===S.expense_account_id);return e.jsx(O,{item:!0,xs:12,sm:6,md:4,children:e.jsx(kt,{children:e.jsx(Ot,{children:e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"flex-start",children:[e.jsxs(k,{flex:1,children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:S.description||g?.Name||"Unknown Account"}),e.jsxs(h,{variant:"body2",color:"textSecondary",gutterBottom:!0,children:[g?.Name," (",g?.AccountType,")"]}),e.jsx(De,{label:`${S.percentage}%`,color:"primary",size:"small"})]}),e.jsxs(k,{children:[e.jsx(gt,{size:"small",onClick:()=>M(S),children:e.jsx(ao,{})}),e.jsx(gt,{size:"small",color:"error",onClick:()=>X(S.id),children:e.jsx(xr,{})})]})]})})})},S.id)})})]})}),e.jsxs(mt,{open:j,onClose:()=>E(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:A?"Edit Distribution":"Add Distribution"}),e.jsx(xt,{children:e.jsxs(Pe,{spacing:3,sx:{mt:1},children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Expense Account"}),e.jsx(Ut,{value:L.expense_account_id,onChange:S=>y(g=>({...g,expense_account_id:S.target.value})),label:"Expense Account",children:G("Expense").map(S=>e.jsx(Ze,{value:S.value,children:S.label},S.value))})]}),e.jsx(le,{label:"Percentage",type:"number",value:L.percentage,onChange:S=>y(g=>({...g,percentage:S.target.value})),inputProps:{min:0,max:100,step:.01},helperText:`Current total: ${re}%${A?` (excluding this item: ${(re-A.percentage).toFixed(1)}%)`:""}`}),e.jsx(le,{label:"Description (Optional)",value:L.description,onChange:S=>y(g=>({...g,description:S.target.value})),helperText:"A description to help identify this distribution"})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>E(!1),children:"Cancel"}),e.jsx(Q,{onClick:D,variant:"contained",disabled:a||!L.expense_account_id||!L.percentage,startIcon:a?e.jsx(ot,{size:20}):e.jsx(is,{}),children:a?"Saving...":"Save"})]})]}),te()]})},CS=()=>{const[t,r]=l.useState(!1),[n,a]=l.useState(!1),[s,o]=l.useState([]),[i,c]=l.useState(new Set),[u,d]=l.useState(new Set),[p,m]=l.useState(!1),[f,_]=l.useState([]),v=Gt();l.useEffect(()=>{w();const x=()=>{console.log(" Parts to order update event received, refreshing data..."),w()};return window.addEventListener("parts-to-order-updated",x),()=>{window.removeEventListener("parts-to-order-updated",x)}},[]);const w=async()=>{r(!0);try{const x=await B.get("/api/sales-orders/parts-to-order/all"),{individualParts:D,aggregatedParts:M}=x.data;if(M&&M.length>0)o(M);else{const X=b(D);o(X)}}catch(x){console.error("Error fetching parts to order:",x),z.error("Failed to load parts to order data")}finally{r(!1)}},b=x=>{const D={};return x.forEach(M=>{D[M.part_number]||(D[M.part_number]={part_number:M.part_number,part_description:M.part_description,total_quantity_needed:0,unit:M.unit,unit_price:M.unit_price,total_line_amount:0,sales_orders:[]}),D[M.part_number].total_quantity_needed+=M.quantity_needed,D[M.part_number].total_line_amount+=M.line_amount,D[M.part_number].sales_orders.push(M)}),Object.values(D)},P=x=>{const D=new Set(i);D.has(x)?D.delete(x):D.add(x),c(D)},N=()=>{w()},j=x=>{d(D=>{const M=new Set(D);return M.has(x)?M.delete(x):M.add(x),M})},E=()=>{u.size===s.length?d(new Set):d(new Set(s.map(x=>x.part_number)))},A=()=>{if(u.size===0){z.warning("Please select at least one part to create a purchase order");return}const x=s.filter(D=>u.has(D.part_number));_(x),m(!0)},C=()=>{m(!1),_([])},L=async()=>{if(f.length===0){z.warning("No parts selected for purchase order");return}a(!0);try{const x=await B.post("/api/purchase-orders/auto-create-from-parts-to-order",{parts:f});if(x.data.success)if(z.success(`Purchase order created successfully! PO Number: ${x.data.purchase_order_number}`),x.data.purchase_orders&&x.data.purchase_orders.length===1){const D=x.data.purchase_orders[0].purchase_id;C(),d(new Set),v(`/open-purchase-orders/${D}`)}else C(),d(new Set),w();else z.error(x.data.message||"Failed to create purchase order")}catch(x){console.error("Error creating purchase order:",x),z.error(x.response?.data?.error||"Failed to create purchase order")}finally{a(!1)}},y=async x=>{let D=s;if(x){const M=s.find(X=>X.part_number===x);if(!M){z.warning(`Part ${x} not found for purchase order creation.`);return}D=[M]}if(D.length===0){z.warning("No parts to order");return}a(!0);try{const M=await B.post("/api/purchase-orders/auto-create-from-parts-to-order",{parts:D});if(M.data.success)if(z.success(`Purchase order created successfully! PO Number: ${M.data.purchase_order_number}`),M.data.purchase_orders&&M.data.purchase_orders.length===1){const X=M.data.purchase_orders[0].purchase_id;v(`/open-purchase-orders/${X}`)}else w();else z.error(M.data.message||"Failed to create purchase order")}catch(M){console.error("Error creating purchase order:",M),z.error(M.response?.data?.error||"Failed to create purchase order")}finally{a(!1)}};return t?e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(ot,{})}):e.jsxs(k,{p:3,children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsx(h,{variant:"h3",component:"h1",children:"Parts to Order"}),e.jsxs(k,{display:"flex",gap:2,children:[u.size>0&&e.jsxs(Q,{variant:"contained",color:"primary",startIcon:e.jsx(em,{}),onClick:A,disabled:n,children:["Create PO (",u.size,")"]}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(Ol,{}),onClick:N,children:"Refresh"})]})]}),s.length===0?e.jsx(Fe,{severity:"info",children:"No parts currently need to be ordered."}):e.jsx(dr,{component:Me,children:e.jsxs(ir,{size:"medium",children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{padding:"checkbox",children:e.jsx(gn,{indeterminate:u.size>0&&u.size<s.length,checked:s.length>0&&u.size===s.length,onChange:E})}),e.jsx(ne,{children:e.jsx(h,{variant:"h6",fontWeight:"bold"})}),e.jsx(ne,{children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Part Number"})}),e.jsx(ne,{children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Description"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Quantity to Order"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Unit"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Unit Price"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Total Amount"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Actions"})})]})}),e.jsx(cr,{children:s.map(x=>e.jsxs(Dt.Fragment,{children:[e.jsxs(ht,{children:[e.jsx(ne,{padding:"checkbox",children:e.jsx(gn,{checked:u.has(x.part_number),onChange:()=>j(x.part_number)})}),e.jsx(ne,{children:e.jsx(gt,{size:"small",onClick:()=>P(x.part_number),children:i.has(x.part_number)?e.jsx(tm,{}):e.jsx(Fu,{})})}),e.jsx(ne,{children:e.jsx(h,{variant:"body1",fontWeight:"medium",fontSize:"1.1rem",children:x.part_number})}),e.jsx(ne,{children:e.jsx(h,{variant:"body1",fontSize:"1.1rem",children:x.part_description})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body1",fontWeight:"medium",fontSize:"1.1rem",children:Number(x.total_quantity_needed)||0})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body1",fontSize:"1.1rem",children:x.unit})}),e.jsx(ne,{align:"center",children:e.jsxs(h,{variant:"body1",fontSize:"1.1rem",children:["$",(Number(x.unit_price)||0).toFixed(2)]})}),e.jsx(ne,{align:"center",children:e.jsxs(h,{variant:"body1",fontSize:"1.1rem",children:["$",(Number(x.total_line_amount)||0).toFixed(2)]})}),e.jsx(ne,{align:"center",children:e.jsx(Q,{variant:"contained",color:"primary",size:"medium",startIcon:e.jsx(ec,{}),onClick:()=>y(x.part_number),disabled:n,children:"Create PO"})})]}),e.jsx(ht,{children:e.jsx(ne,{style:{paddingBottom:0,paddingTop:0},colSpan:9,children:e.jsx(Lu,{in:i.has(x.part_number),timeout:"auto",unmountOnExit:!0,children:e.jsxs(k,{sx:{margin:1},children:[e.jsx(h,{variant:"h5",gutterBottom:!0,component:"div",children:"Sales Orders Requiring This Part"}),e.jsxs(ir,{size:"medium",children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:e.jsx(h,{variant:"subtitle1",fontWeight:"bold",children:"Sales Order"})}),e.jsx(ne,{children:e.jsx(h,{variant:"subtitle1",fontWeight:"bold",children:"Customer"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"subtitle1",fontWeight:"bold",children:"Quantity to Order"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"subtitle1",fontWeight:"bold",children:"Unit Price"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"subtitle1",fontWeight:"bold",children:"Line Amount"})})]})}),e.jsx(cr,{children:x.sales_orders.map(D=>e.jsxs(ht,{children:[e.jsx(ne,{children:e.jsx(h,{variant:"body1",fontSize:"1rem",children:D.sales_order_number})}),e.jsx(ne,{children:e.jsx(h,{variant:"body1",fontSize:"1rem",children:D.customer_name})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body1",fontSize:"1rem",children:Number(D.quantity_needed)||0})}),e.jsx(ne,{align:"center",children:e.jsxs(h,{variant:"body1",fontSize:"1rem",children:["$",(Number(D.unit_price)||0).toFixed(2)]})}),e.jsx(ne,{align:"center",children:e.jsxs(h,{variant:"body1",fontSize:"1rem",children:["$",(Number(D.line_amount)||0).toFixed(2)]})})]},`${D.sales_order_id}-${D.part_number}`))})]})]})})})})]},x.part_number))})]})}),e.jsxs(mt,{open:p,onClose:C,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:"Create Purchase Order"}),e.jsxs(xt,{children:[e.jsx(h,{variant:"body1",sx:{mb:2},children:"Selected parts for purchase order:"}),e.jsx(dr,{component:Me,variant:"outlined",children:e.jsxs(ir,{size:"small",children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Part Number"}),e.jsx(ne,{children:"Description"}),e.jsx(ne,{align:"center",children:"Quantity"}),e.jsx(ne,{align:"center",children:"Unit"}),e.jsx(ne,{align:"center",children:"Unit Price"}),e.jsx(ne,{align:"center",children:"Total"})]})}),e.jsx(cr,{children:f.map(x=>e.jsxs(ht,{children:[e.jsx(ne,{children:e.jsx(h,{variant:"body2",fontWeight:"medium",children:x.part_number})}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",children:x.part_description})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",children:Number(x.total_quantity_needed)||0})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",children:x.unit})}),e.jsx(ne,{align:"center",children:e.jsxs(h,{variant:"body2",children:["$",(Number(x.unit_price)||0).toFixed(2)]})}),e.jsx(ne,{align:"center",children:e.jsxs(h,{variant:"body2",fontWeight:"medium",children:["$",(Number(x.total_line_amount)||0).toFixed(2)]})})]},x.part_number))})]})}),e.jsx(k,{sx:{mt:2,p:2,backgroundColor:"grey.50",borderRadius:1},children:e.jsxs(h,{variant:"h6",align:"right",children:["Total Amount: $",f.reduce((x,D)=>x+(Number(D.total_line_amount)||0),0).toFixed(2)]})})]}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:C,disabled:n,children:"Cancel"}),e.jsx(Q,{onClick:L,variant:"contained",color:"primary",disabled:n,startIcon:n?e.jsx(ot,{size:20}):e.jsx(ec,{}),children:n?"Creating...":"Create Purchase Order"})]})]})]})},kS=()=>{const t=Gt(),[r,n]=l.useState(!0),[a,s]=l.useState(!1),[o,i]=l.useState([]),[c,u]=l.useState([]),[d,p]=l.useState([]),[m,f]=l.useState(!1),[_,v]=l.useState(""),[w,b]=l.useState("");l.useEffect(()=>{P()},[]);const P=async()=>{n(!0);try{const[C,L,y]=await Promise.all([B.get("/api/time-tracking/admin/available-users"),B.get("/api/time-tracking/profiles"),B.get("/api/time-tracking/admin/user-profile-access")]);i(C.data||[]),u(L.data||[]),p(y.data||[])}catch(C){console.error("Error loading data:",C),z.error("Failed to load mobile user access data")}finally{n(!1)}},N=async()=>{if(!_||!w){z.error("Please select both a user and a profile");return}s(!0);try{await B.post("/api/time-tracking/admin/user-profile-access",{user_id:_,profile_id:w}),z.success("Profile access granted successfully"),f(!1),v(""),b(""),P()}catch(C){console.error("Error granting access:",C),z.error(C.response?.data?.error||"Failed to grant access")}finally{s(!1)}},j=async C=>{if(window.confirm("Are you sure you want to revoke this profile access?"))try{await B.delete(`/api/time-tracking/admin/user-profile-access/${C}`),z.success("Profile access revoked successfully"),P()}catch(L){console.error("Error revoking access:",L),z.error(L.response?.data?.error||"Failed to revoke access")}},E=d.filter(C=>C.is_active),A=d.filter(C=>!C.is_active);return e.jsxs(nt,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(gt,{onClick:()=>t(-1),children:e.jsx(Si,{})}),e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Mobile User Access Management"})]}),e.jsxs(Pe,{direction:"row",spacing:2,children:[e.jsx(Q,{variant:"contained",onClick:()=>f(!0),startIcon:e.jsx(Nr,{}),children:"Grant Access"}),e.jsx(Q,{variant:"outlined",onClick:P,startIcon:e.jsx(_n,{}),children:"Refresh"})]})]}),e.jsxs(O,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Mobile Users"}),e.jsx(h,{variant:"h4",children:o.length})]})})}),e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Available Profiles"}),e.jsx(h,{variant:"h4",children:c.length})]})})}),e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Active Access"}),e.jsx(h,{variant:"h4",color:"success.main",children:E.length})]})})}),e.jsx(O,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Revoked Access"}),e.jsx(h,{variant:"h4",color:"text.secondary",children:A.length})]})})})]}),r?e.jsx(k,{display:"flex",justifyContent:"center",p:3,children:e.jsx(ot,{})}):e.jsxs(e.Fragment,{children:[e.jsx(Me,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Active Profile Access"}),E.length===0?e.jsx(Fe,{severity:"info",children:'No active profile access assignments. Click "Grant Access" to get started.'}):e.jsx(dr,{children:e.jsxs(ir,{children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Mobile User"}),e.jsx(ne,{children:"Profile"}),e.jsx(ne,{children:"Granted By"}),e.jsx(ne,{children:"Granted At"}),e.jsx(ne,{children:"Actions"})]})}),e.jsx(cr,{children:E.map(C=>e.jsxs(ht,{children:[e.jsx(ne,{children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:C.user_email}),e.jsx(De,{label:C.user_role,size:"small",color:"primary",variant:"outlined"})]})}),e.jsx(ne,{children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:C.profile_name}),e.jsx(h,{variant:"caption",color:"textSecondary",children:C.profile_email})]})}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",children:C.granted_by_email||"System"})}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",children:new Date(C.granted_at).toLocaleDateString()})}),e.jsx(ne,{children:e.jsx(gt,{color:"error",onClick:()=>j(C.id),title:"Revoke Access",children:e.jsx(xr,{})})})]},C.id))})]})})]})}),A.length>0&&e.jsx(Me,{sx:{width:"100%",overflow:"hidden"},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Revoked Profile Access"}),e.jsx(dr,{children:e.jsxs(ir,{children:[e.jsx(lr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Mobile User"}),e.jsx(ne,{children:"Profile"}),e.jsx(ne,{children:"Revoked At"})]})}),e.jsx(cr,{children:A.map(C=>e.jsxs(ht,{children:[e.jsx(ne,{children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:C.user_email}),e.jsx(De,{label:C.user_role,size:"small",color:"default",variant:"outlined"})]})}),e.jsx(ne,{children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:C.profile_name}),e.jsx(h,{variant:"caption",color:"textSecondary",children:C.profile_email})]})}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",children:new Date(C.updated_at).toLocaleDateString()})})]},C.id))})]})})]})})]}),e.jsxs(mt,{open:m,onClose:()=>f(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:e.jsxs(k,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(Nr,{}),"Grant Profile Access"]})}),e.jsx(xt,{children:e.jsxs(Pe,{spacing:3,sx:{mt:1},children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Mobile User"}),e.jsx(Ut,{value:_,onChange:C=>v(Number(C.target.value)),label:"Mobile User",children:o.map(C=>e.jsx(Ze,{value:C.id,children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:C.email}),e.jsx(h,{variant:"caption",color:"textSecondary",children:C.access_role})]})},C.id))})]}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Profile"}),e.jsx(Ut,{value:w,onChange:C=>b(Number(C.target.value)),label:"Profile",children:c.map(C=>e.jsx(Ze,{value:C.id,children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:C.name}),e.jsx(h,{variant:"caption",color:"textSecondary",children:C.email})]})},C.id))})]})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:()=>f(!1),children:"Cancel"}),e.jsx(Q,{onClick:N,variant:"contained",disabled:a||!_||!w,startIcon:a?e.jsx(ot,{size:20}):e.jsx(Ln,{}),children:a?"Granting...":"Grant Access"})]})]})]})};var $a={},uu;function PS(){if(uu)return $a;uu=1;var t=vt();Object.defineProperty($a,"__esModule",{value:!0}),$a.default=void 0;var r=t(_t()),n=bt();return $a.default=(0,r.default)((0,n.jsx)("path",{d:"M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5c-.49 0-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20zm-6 8h-4v-2h4zm0-4h-4v-2h4z"}),"BugReport"),$a}var ES=PS();const DS=st(ES);var za={},pu;function TS(){if(pu)return za;pu=1;var t=vt();Object.defineProperty(za,"__esModule",{value:!0}),za.default=void 0;var r=t(_t()),n=bt();return za.default=(0,r.default)((0,n.jsx)("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8zm2 16H8v-2h8zm0-4H8v-2h8zm-3-5V3.5L18.5 9z"}),"Description"),za}var IS=TS();const OS=st(IS),hu=[{value:"gmail",label:"Gmail",host:"smtp.gmail.com",port:587,secure:!1},{value:"outlook",label:"Outlook/Hotmail",host:"smtp-mail.outlook.com",port:587,secure:!1},{value:"yahoo",label:"Yahoo",host:"smtp.mail.yahoo.com",port:587,secure:!1},{value:"icloud",label:"iCloud",host:"smtp.mail.me.com",port:587,secure:!1},{value:"titan",label:"Titan Email",host:"smtp.titan.email",port:465,secure:!0},{value:"custom",label:"Custom SMTP",host:"",port:587,secure:!1}],AS=()=>{const t=Gt(),[r,n]=l.useState({email_provider:"gmail",email_host:"smtp.gmail.com",email_port:587,email_secure:!1,email_user:"",email_from:""}),[a,s]=l.useState(""),[o,i]=l.useState(!1),[c,u]=l.useState(!1),[d,p]=l.useState(!1),[m,f]=l.useState("unknown");l.useEffect(()=>{_()},[]);const _=async()=>{try{const E=await B.get("/api/email/user-settings");if(E.data.success&&E.data.settings){const A=E.data.settings;n({email_provider:A.email_provider,email_host:A.email_host,email_port:A.email_port,email_secure:A.email_secure,email_user:A.email_user,email_from:A.email_from||A.email_user}),p(!0)}}catch(E){console.error("Error loading user email settings:",E)}},v=async()=>{if(!r.email_host||!r.email_port||!r.email_user){z.error("Please fill in all required fields");return}d&&!a&&z.info("Password field is empty - keeping existing password"),i(!0);try{const E={...r,...a&&{email_pass:a}},A=await B.post("/api/email/user-settings",E);A.data.success?(z.success("Email settings saved successfully!"),p(!0),s(""),f("unknown")):z.error(A.data.message||"Failed to save email settings")}catch(E){console.error("Error saving email settings:",E),z.error(E.response?.data?.message||"Failed to save email settings")}finally{i(!1)}},w=async()=>{if(!d){z.error("Please save your email settings first");return}u(!0);try{const E=await B.post("/api/email/test-user-connection");E.data.success?(f("connected"),z.success("Email connection test successful!")):(f("failed"),z.error(E.data.message||"Email connection test failed"))}catch(E){console.error("Error testing email connection:",E),f("failed"),z.error(E.response?.data?.message||"Email connection test failed")}finally{u(!1)}},b=E=>{const A=hu.find(C=>C.value===E);A&&n(C=>({...C,email_provider:E,email_host:A.host,email_port:A.port,email_secure:A.secure}))},P=(E,A)=>{n(C=>({...C,[E]:A}))},N=()=>{switch(m){case"connected":return"success";case"failed":return"error";default:return"info"}},j=()=>{switch(m){case"connected":return"Connected";case"failed":return"Connection Failed";default:return"Not Tested"}};return e.jsxs(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",mb:3},children:[e.jsx(pi,{sx:{mr:2,fontSize:32}}),e.jsx(h,{variant:"h4",component:"h1",children:"My Email Settings"})]}),e.jsx(Fe,{severity:"info",sx:{mb:3},children:"Configure your personal email settings to send emails from your own email account. These settings are private to your account and will be used when you send emails from the system."}),e.jsxs(Fe,{severity:"warning",sx:{mb:3},children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:e.jsx("strong",{children:"Important for Gmail users:"})}),e.jsxs(h,{variant:"body2",children:[`If you're using Gmail with 2-Factor Authentication, you need to use an "App Password" instead of your regular password.`,e.jsx("br",{})," Go to ",e.jsx("a",{href:"https://myaccount.google.com/apppasswords",target:"_blank",rel:"noopener noreferrer",children:"Google App Passwords"}),e.jsx("br",{}),' Generate an app password for "Mail"',e.jsx("br",{}),' Use that 16-character password in the "App Password" field below']})]}),e.jsxs(O,{container:!0,spacing:3,children:[e.jsx(O,{item:!0,xs:12,md:8,children:e.jsxs(kt,{children:[e.jsxs(Ot,{children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Email Configuration"}),e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{select:!0,label:"Email Provider",value:r.email_provider,onChange:E=>b(E.target.value),fullWidth:!0,helperText:"Select your email provider or choose Custom for other SMTP servers",children:hu.map(E=>e.jsx(Ze,{value:E.value,children:E.label},E.value))})}),e.jsx(O,{item:!0,xs:12,sm:8,children:e.jsx(le,{label:"SMTP Host",value:r.email_host,onChange:E=>P("email_host",E.target.value),fullWidth:!0,required:!0,disabled:r.email_provider!=="custom"})}),e.jsx(O,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"SMTP Port",type:"number",value:r.email_port,onChange:E=>P("email_port",parseInt(E.target.value)),fullWidth:!0,required:!0,disabled:r.email_provider!=="custom"})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(yn,{control:e.jsx(ni,{checked:r.email_secure,onChange:E=>P("email_secure",E.target.checked),disabled:r.email_provider!=="custom"}),label:"Use SSL/TLS (usually for port 465)"})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Email Address",type:"email",value:r.email_user,onChange:E=>P("email_user",E.target.value),fullWidth:!0,required:!0,helperText:"Your email address for authentication"})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:d?"Update App Password":"App Password",type:"password",value:a,onChange:E=>s(E.target.value),fullWidth:!0,required:!d,helperText:d?"Leave blank to keep current password, or enter new password to update":"Your email password or app password (for Gmail with 2FA)"})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"From Name (Optional)",value:r.email_from,onChange:E=>P("email_from",E.target.value),fullWidth:!0,helperText:"Display name for outgoing emails (defaults to email address)"})})]})]}),e.jsx(rl,{children:e.jsx(Q,{variant:"contained",startIcon:o?e.jsx(ot,{size:20}):e.jsx(is,{}),onClick:v,disabled:o,children:o?"Saving...":"Save Settings"})})]})}),e.jsxs(O,{item:!0,xs:12,md:4,children:[e.jsxs(kt,{children:[e.jsxs(Ot,{children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Connection Status"}),e.jsx(Fe,{severity:N(),sx:{mb:2},children:j()}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Test your email configuration to ensure it works correctly."})]}),e.jsx(rl,{children:e.jsx(Q,{variant:"outlined",startIcon:c?e.jsx(ot,{size:20}):e.jsx(DS,{}),onClick:w,disabled:c||!d,fullWidth:!0,children:c?"Testing...":"Test Connection"})})]}),e.jsx(kt,{sx:{mt:2},children:e.jsxs(Ot,{children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Setup Instructions"}),e.jsxs(h,{variant:"body2",sx:{mb:1},children:[e.jsx("strong",{children:"Gmail:"})," Use an App Password instead of your regular password."]}),e.jsxs(h,{variant:"body2",sx:{mb:1},children:[e.jsx("strong",{children:"Outlook:"})," Use an App Password for enhanced security."]}),e.jsxs(h,{variant:"body2",children:[e.jsx("strong",{children:"Other providers:"})," Check your email provider's SMTP settings."]})]})}),e.jsx(kt,{sx:{mt:2,border:"2px solid red"},children:e.jsxs(Ot,{children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Quick Actions"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Manage your email templates and customize email content for different types of communications."}),e.jsx(Q,{fullWidth:!0,variant:"outlined",onClick:()=>t("/email-templates"),startIcon:e.jsx(OS,{}),sx:{mb:1},color:"primary",children:"Manage Email Templates"})]})})]})]})]})},MS=()=>{const{user:t}=er(),[r,n]=l.useState([]),[a,s]=l.useState(!0),[o,i]=l.useState(!1),[c,u]=l.useState(null),[d,p]=l.useState({name:"",type:"purchase_order",subject:"",html_content:"",text_content:"",is_default:!1}),[m,f]=l.useState(""),[_,v]=l.useState("");l.useEffect(()=>{w()},[]);const w=async()=>{try{s(!0);const C=await B.get("/api/email/templates");C.data.success&&n(C.data.templates)}catch(C){console.error("Error loading templates:",C),f("Failed to load email templates")}finally{s(!1)}},b=C=>{C?(u(C),p({name:C.name,type:C.type,subject:C.subject,html_content:C.html_content,text_content:C.text_content||"",is_default:C.is_default})):(u(null),p({name:"",type:"purchase_order",subject:"",html_content:"",text_content:"",is_default:!1})),i(!0)},P=()=>{i(!1),u(null),p({name:"",type:"purchase_order",subject:"",html_content:"",text_content:"",is_default:!1})},N=async()=>{try{c?(await B.put(`/api/email/templates/${c.id}`,d),v("Email template updated successfully")):(await B.post("/api/email/templates",d),v("Email template created successfully")),P(),w()}catch(C){console.error("Error saving template:",C),f(C.response?.data?.message||"Failed to save template")}},j=async C=>{if(window.confirm("Are you sure you want to delete this template?"))try{await B.delete(`/api/email/templates/${C}`),v("Email template deleted successfully"),w()}catch(L){console.error("Error deleting template:",L),f(L.response?.data?.message||"Failed to delete template")}},E=C=>{switch(C){case"purchase_order":return"primary";case"sales_order":return"success";case"quote":return"warning";case"custom":return"info";default:return"default"}},A=C=>{switch(C){case"purchase_order":return"Purchase Order";case"sales_order":return"Sales Order";case"quote":return"Quote";case"custom":return"Custom";default:return C}};return a?e.jsx(nt,{maxWidth:"lg",children:e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Loading..."})}):e.jsxs(nt,{maxWidth:"lg",children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Email Templates"}),e.jsx(Q,{variant:"contained",startIcon:e.jsx(ti,{}),onClick:()=>b(),children:"Create Template"})]}),e.jsx(O,{container:!0,spacing:3,children:r.map(C=>e.jsx(O,{item:!0,xs:12,md:6,lg:4,children:e.jsx(kt,{children:e.jsxs(Ot,{children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:[e.jsx(h,{variant:"h6",component:"div",children:C.name}),e.jsxs(k,{children:[e.jsx(gt,{size:"small",onClick:()=>b(C),color:"primary",children:e.jsx(ri,{})}),e.jsx(gt,{size:"small",onClick:()=>j(C.id),color:"error",children:e.jsx(qs,{})})]})]}),e.jsx(De,{label:A(C.type),color:E(C.type),size:"small",sx:{mb:1}}),C.is_default&&e.jsx(De,{label:"Default",color:"secondary",size:"small",sx:{ml:1}}),e.jsxs(h,{variant:"body2",color:"text.secondary",sx:{mt:1},children:[e.jsx("strong",{children:"Subject:"})," ",C.subject]}),e.jsxs(h,{variant:"body2",color:"text.secondary",sx:{mt:1},children:[e.jsx("strong",{children:"Created:"})," ",new Date(C.created_at).toLocaleDateString()]}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:"Updated:"})," ",new Date(C.updated_at).toLocaleDateString()]})]})})},C.id))}),r.length===0&&e.jsxs(k,{sx:{textAlign:"center",mt:4},children:[e.jsx(h,{variant:"h6",color:"text.secondary",children:"No email templates found"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Create your first email template to get started"})]}),e.jsxs(mt,{open:o,onClose:P,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:c?"Edit Email Template":"Create Email Template"}),e.jsx(xt,{children:e.jsxs(k,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsx(le,{label:"Template Name",value:d.name,onChange:C=>p({...d,name:C.target.value}),fullWidth:!0,required:!0}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{children:"Template Type"}),e.jsxs(Ut,{value:d.type,onChange:C=>p({...d,type:C.target.value}),label:"Template Type",children:[e.jsx(Ze,{value:"purchase_order",children:"Purchase Order"}),e.jsx(Ze,{value:"sales_order",children:"Sales Order"}),e.jsx(Ze,{value:"quote",children:"Quote"}),e.jsx(Ze,{value:"custom",children:"Custom"})]})]}),e.jsx(le,{label:"Subject",value:d.subject,onChange:C=>p({...d,subject:C.target.value}),fullWidth:!0,required:!0}),e.jsx(le,{label:"HTML Content",value:d.html_content,onChange:C=>p({...d,html_content:C.target.value}),fullWidth:!0,multiline:!0,rows:8,required:!0,helperText:"Use HTML formatting for rich email content"}),e.jsx(le,{label:"Text Content (Optional)",value:d.text_content,onChange:C=>p({...d,text_content:C.target.value}),fullWidth:!0,multiline:!0,rows:4,helperText:"Plain text version for email clients that don't support HTML"}),e.jsx(yn,{control:e.jsx(ni,{checked:d.is_default,onChange:C=>p({...d,is_default:C.target.checked})}),label:"Set as default template for this type"})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:P,children:"Cancel"}),e.jsx(Q,{onClick:N,variant:"contained",children:c?"Update":"Create"})]})]}),e.jsx(vn,{open:!!m,autoHideDuration:6e3,onClose:()=>f(""),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Fe,{onClose:()=>f(""),severity:"error",sx:{width:"100%"},children:m})}),e.jsx(vn,{open:!!_,autoHideDuration:6e3,onClose:()=>v(""),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Fe,{onClose:()=>v(""),severity:"success",sx:{width:"100%"},children:_})})]})};var Lo={exports:{}},RS=Lo.exports,mu;function NS(){return mu||(mu=1,function(t,r){(function(n,a){t.exports=a()})(RS,function(){return function(n,a,s){n=n||{};var o=a.prototype,i={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function c(d,p,m,f){return o.fromToBase(d,p,m,f)}s.en.relativeTime=i,o.fromToBase=function(d,p,m,f,_){for(var v,w,b,P=m.$locale().relativeTime||i,N=n.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],j=N.length,E=0;E<j;E+=1){var A=N[E];A.d&&(v=f?s(d).diff(m,A.d,!0):m.diff(d,A.d,!0));var C=(n.rounding||Math.round)(Math.abs(v));if(b=v>0,C<=A.r||!A.r){C<=1&&E>0&&(A=N[E-1]);var L=P[A.l];_&&(C=_(""+C)),w=typeof L=="string"?L.replace("%d",C):L(C,p,A.l,b);break}}if(p)return w;var y=b?P.future:P.past;return typeof y=="function"?y(w):y.replace("%s",w)},o.to=function(d,p){return c(d,p,this,!0)},o.from=function(d,p){return c(d,p,this)};var u=function(d){return d.$u?s.utc():s()};o.toNow=function(d){return this.to(u(this),d)},o.fromNow=function(d){return this.from(u(this),d)}}})}(Lo)),Lo.exports}var LS=NS();const xh=st(LS);var Ba={},fu;function qS(){if(fu)return Ba;fu=1;var t=vt();Object.defineProperty(Ba,"__esModule",{value:!0}),Ba.default=void 0;var r=t(_t()),n=bt();return Ba.default=(0,r.default)((0,n.jsx)("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"}),"Send"),Ba}var US=qS();const FS=st(US),qo={async fetchMessages(t,r){return(await B.get(`/api/tasks/${t}/messages`,{params:r?{after:r}:void 0})).data},async postMessage(t,r){return(await B.post(`/api/tasks/${t}/messages`,r)).data},async markMessagesRead(t,r){return(await B.post(`/api/tasks/${t}/messages/mark-read`,{lastMessageId:r})).data},async getTaskDetail(t){return(await B.get(`/api/tasks/${t}`)).data}};et.extend(xh);const gh=t=>[...t].sort((r,n)=>{const a=new Date(r.createdAt).getTime(),s=new Date(n.createdAt).getTime();return a===s?r.id-n.id:a-s}),WS=(t,r)=>{if(!r.length)return{merged:t,appended:[]};const n=new Map;t.forEach(o=>n.set(o.id,o));const a=[];return r.forEach(o=>{n.has(o.id)||a.push(o),n.set(o.id,o)}),{merged:gh(Array.from(n.values())),appended:a}},$S=({taskId:t,pollIntervalMs:r=15e3,onUnreadChange:n,createdByAgent:a})=>{const{user:s}=er(),o=l.useMemo(()=>{if(!s?.id)return null;const R=Number(s.id);return Number.isFinite(R)?R:null},[s?.id]),[i,c]=l.useState([]),[u,d]=l.useState(null),[p,m]=l.useState(0),[f,_]=l.useState(!0),[v,w]=l.useState(!1),[b,P]=l.useState(!1),[N,j]=l.useState(""),[E,A]=l.useState(null),[C,L]=l.useState(null),y=l.useRef(null),x=l.useRef(null),D=l.useRef(!0),M=l.useRef(null),X=l.useCallback(R=>{m(R),n?.(R)},[n]),H=l.useCallback((R=!1)=>{const K=y.current;K&&K.scrollTo({top:K.scrollHeight,behavior:R?"smooth":"auto"})},[]),U=l.useCallback(()=>{const R=y.current;return R?R.scrollHeight-R.scrollTop-R.clientHeight<=120:!0},[]),G=l.useCallback(async R=>{try{const K=await qo.markMessagesRead(t,R??void 0);d(K.participant),X(K.unreadCount)}catch(K){console.warn("Failed to update read state for task chat",K)}},[X,t]),te=l.useCallback(R=>{!R.length||D.current||R.filter(K=>K.sender?.userId&&o&&K.sender.userId!==o).forEach(K=>{const F=K.sender?.name||"Task teammate";z.info(`New message from ${F}`)})},[o]),re=l.useCallback((R,K=!1)=>{const F=U();let xe=[],ve=M.current;return c(de=>{if(K){const pe=gh(R);return xe=pe,ve=pe.length?pe[pe.length-1].id:null,pe}const{merged:me,appended:ge}=WS(de,R);return xe=ge,ve=me.length?me[me.length-1].id:ve,me}),ve!=null&&(M.current==null||ve>M.current)&&(M.current=ve),xe.length?(te(xe),F&&setTimeout(()=>H(!0),50)):F&&K&&setTimeout(()=>H(!0),50),{appended:xe,latestId:ve}},[te,H,U]),S=l.useCallback(async R=>{try{R?.initial?_(!0):L(null);const K=R?.forceFull?void 0:M.current??void 0,F=await qo.fetchMessages(t,K);d(F.participant),A(F.lastSyncedAt);const{appended:xe,latestId:ve}=re(F.messages,!!R?.initial||R?.forceFull);X(F.unreadCount),(F.unreadCount>0||xe.length>0)&&ve!=null&&await G(ve),R?.initial&&(D.current=!1)}catch(K){console.error("Failed to load task messages",K);const F=K?.response?.data?.message||"Unable to load task messages.";L(F),R?.initial&&z.error(F)}finally{R?.initial&&_(!1)}},[re,G,X,t]);l.useEffect(()=>(D.current=!0,M.current=null,c([]),d(null),X(0),S({initial:!0,forceFull:!0}).catch(()=>{}),()=>{x.current&&(clearInterval(x.current),x.current=null)}),[S,X,t]),l.useEffect(()=>{if(x.current&&clearInterval(x.current),!(r<=0))return x.current=setInterval(()=>{S({forceFull:!1}).catch(()=>{})},r),()=>{x.current&&(clearInterval(x.current),x.current=null)}},[S,r]);const g=l.useCallback(async R=>{if(R.preventDefault(),!!N.trim())try{P(!0);const K=await qo.postMessage(t,{content:N.trim()});d(K.participant),X(K.unreadCount),re([K.message]),M.current=K.message.id,j(""),setTimeout(()=>H(!0),50)}catch(K){console.error("Failed to send message",K),z.error(K?.response?.data?.message||"Failed to send message")}finally{P(!1)}},[re,N,X,H,t]),T=l.useCallback(async()=>{try{w(!0),await S({forceFull:!0})}finally{w(!1)}},[S]),q=l.useMemo(()=>E?`Updated ${et(E).fromNow()}`:"Not synced yet",[E]),ee=R=>{const K=!!(R.metadata&&R.metadata.agent||R.isSystem),F=!K&&o!=null&&R.sender?.userId===o,xe=K?"Workspace Copilot":F?"You":R.sender?.name||"Team member",ve=et(R.createdAt).format("MMM D, YYYY h:mm A");return e.jsxs(k,{display:"flex",flexDirection:"column",alignItems:F?"flex-end":"flex-start",mb:2,children:[e.jsxs(k,{sx:{maxWidth:"80%",bgcolor:K?"rgba(25, 118, 210, 0.08)":F?"primary.main":"grey.100",color:K?"text.primary":F?"primary.contrastText":"text.primary",px:2,py:1,borderRadius:2,boxShadow:1,border:K?"1px solid":void 0,borderColor:K?"info.light":void 0},children:[K&&e.jsx(De,{label:"Workspace Copilot",size:"small",color:"info",sx:{mb:.5}}),e.jsx(h,{variant:"body2",sx:{whiteSpace:"pre-wrap"},children:R.content})]}),e.jsxs(h,{variant:"caption",color:"text.secondary",sx:{mt:.5},children:[xe,"  ",ve]})]},R.id)};return e.jsxs(Me,{elevation:2,sx:{display:"flex",flexDirection:"column",height:"100%"},children:[e.jsxs(k,{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1.5,children:[e.jsxs(k,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(h,{variant:"h6",children:"Task chat"}),e.jsx(Pl,{color:"secondary",badgeContent:p,invisible:p===0,children:e.jsx(De,{label:"Unread",size:"small",variant:p?"filled":"outlined"})})]}),e.jsxs(k,{display:"flex",alignItems:"center",gap:1,children:[E&&e.jsx(h,{variant:"caption",color:"text.secondary",children:q}),e.jsx(Ht,{title:"Refresh conversation",children:e.jsx("span",{children:e.jsx(gt,{onClick:T,disabled:v||f,size:"small",children:v?e.jsx(ot,{size:18}):e.jsx(_n,{fontSize:"small"})})})})]})]}),a&&e.jsx(k,{px:2,pb:1,children:e.jsx(Fe,{severity:"info",variant:"outlined",sx:{borderRadius:2},children:"Workspace Copilot created this task and will keep the conversation updated."})}),e.jsx(fr,{}),e.jsx(k,{ref:y,flex:1,overflow:"auto",px:2,py:2,children:f?e.jsx(k,{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",children:e.jsx(ot,{size:32})}):C?e.jsx(h,{color:"error",variant:"body2",children:C}):i.length===0?e.jsx(k,{textAlign:"center",color:"text.secondary",children:e.jsx(h,{variant:"body2",children:"No messages yet. Start the conversation below."})}):i.map(R=>ee(R))}),e.jsx(fr,{}),e.jsxs(k,{component:"form",onSubmit:g,display:"flex",gap:1,px:2,py:1.5,children:[e.jsx(le,{value:N,onChange:R=>j(R.target.value),placeholder:"Write a message",fullWidth:!0,minRows:2,maxRows:4,multiline:!0,disabled:b}),e.jsx(Q,{type:"submit",variant:"contained",endIcon:b?e.jsx(ot,{color:"inherit",size:18}):e.jsx(FS,{}),disabled:b||N.trim().length===0,children:"Send"})]})]})};et.extend(xh);const zS=()=>{const{id:t}=jn(),r=l.useMemo(()=>{if(!t)return NaN;const v=Number(t);return Number.isFinite(v)?v:NaN},[t]),[n,a]=l.useState(null),[s,o]=l.useState(!0),[i,c]=l.useState(null),[u,d]=l.useState(0),p=l.useCallback(async()=>{if(!Number.isFinite(r)){c("Invalid task identifier"),o(!1);return}try{o(!0),c(null);const v=await qo.getTaskDetail(r);a(v)}catch(v){console.error("Failed to load task details",v);const w=v?.response?.data?.message||"Unable to load task details.";c(w),z.error(w)}finally{o(!1)}},[r]);l.useEffect(()=>{p()},[p]);const m=l.useCallback(v=>{d(v)},[]);if(!Number.isFinite(r))return e.jsx(k,{p:3,children:e.jsx(h,{color:"error",children:"Invalid task identifier."})});if(s)return e.jsx(k,{p:3,display:"flex",alignItems:"center",justifyContent:"center",minHeight:"40vh",children:e.jsx(ot,{})});if(i)return e.jsx(k,{p:3,children:e.jsx(h,{color:"error",children:i})});if(!n)return null;const{task:f,participants:_}=n;return e.jsxs(k,{p:3,display:"flex",flexDirection:"column",gap:3,children:[e.jsxs(k,{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,justifyContent:"space-between",children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:f.title}),e.jsxs(k,{display:"flex",flexWrap:"wrap",gap:1,alignItems:"center",children:[e.jsx(De,{label:f.status,color:f.status==="completed"?"success":"default"}),e.jsx(De,{label:`Priority: ${f.priority??"N/A"}`,variant:"outlined"}),f.dueDate&&e.jsx(De,{label:`Due ${et(f.dueDate).format("MMM D, YYYY")}`,color:"warning"}),f.createdByAgent&&e.jsx(De,{label:"Created by Workspace Copilot",color:"info",variant:"outlined"}),u>0&&e.jsx(De,{label:`${u} unread`,color:"secondary"})]})]}),e.jsxs(k,{textAlign:{xs:"left",md:"right"},color:"text.secondary",children:[f.updatedAt&&e.jsxs(h,{variant:"body2",children:["Updated ",et(f.updatedAt).format("MMM D, YYYY h:mm A")]}),f.createdAt&&e.jsxs(h,{variant:"body2",children:["Created ",et(f.createdAt).format("MMM D, YYYY h:mm A")]})]})]}),f.description&&e.jsxs(Me,{variant:"outlined",sx:{p:2},children:[e.jsx(h,{variant:"subtitle1",gutterBottom:!0,children:"Description"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{whiteSpace:"pre-wrap"},children:f.description})]}),e.jsxs(O,{container:!0,spacing:3,alignItems:"stretch",children:[e.jsx(O,{item:!0,xs:12,md:4,children:e.jsxs(Me,{variant:"outlined",sx:{p:2,height:"100%"},children:[e.jsx(h,{variant:"subtitle1",gutterBottom:!0,children:"Participants"}),_.length===0?e.jsx(h,{variant:"body2",color:"text.secondary",children:"No participants assigned."}):e.jsx(k,{display:"flex",flexDirection:"column",gap:1.5,children:_.map(v=>{const w=(v.name||v.email||"T")[0]?.toUpperCase();return e.jsxs(k,{display:"flex",alignItems:"center",gap:1.5,children:[e.jsx(Rn,{sx:{bgcolor:"primary.main"},children:w}),e.jsxs(k,{flex:1,children:[e.jsx(h,{variant:"body2",children:v.name||"Unnamed user"}),e.jsxs(h,{variant:"caption",color:"text.secondary",display:"block",children:[v.email||"No email","  ",v.role||"Participant"]}),v.lastReadAt&&e.jsxs(h,{variant:"caption",color:"text.secondary",display:"block",children:["Read ",et(v.lastReadAt).fromNow()]})]})]},v.id)})})]})}),e.jsx(O,{item:!0,xs:12,md:8,children:e.jsx($S,{taskId:r,onUnreadChange:m,createdByAgent:!!f.createdByAgent})})]})]})},xu=[{value:"pending",label:"Pending"},{value:"in_progress",label:"In Progress"},{value:"completed",label:"Completed"},{value:"archived",label:"Archived"}],BS=({filters:t,assignees:r,onChange:n,onReset:a})=>{const s=u=>{const d=u.target.value,p=typeof d=="string"?d.split(","):d;n({...t,status:p.filter(Boolean)})},o=u=>{const d=u.target.value;n({...t,assignedTo:d?Number(d):void 0})},i=u=>d=>{n({...t,[u]:d.target.value||void 0})},c=u=>d=>{n({...t,[u]:d.target.checked})};return e.jsx(Me,{variant:"outlined",sx:{p:{xs:2.5,md:3},borderRadius:3,backgroundColor:"background.paper"},children:e.jsxs(Pe,{direction:{xs:"column",lg:"row"},spacing:2,useFlexGap:!0,flexWrap:"wrap",alignItems:{xs:"stretch",lg:"flex-end"},children:[e.jsxs(Mt,{sx:{minWidth:180,flex:"1 1 200px"},size:"small",children:[e.jsx(qt,{id:"task-status-label",children:"Status"}),e.jsx(Ut,{labelId:"task-status-label",multiple:!0,value:t.status??[],onChange:s,input:e.jsx(Wu,{label:"Status"}),renderValue:u=>u.map(d=>xu.find(p=>p.value===d)?.label??d).join(", "),children:xu.map(u=>e.jsxs(Ze,{value:u.value,children:[e.jsx(gn,{checked:t.status?.includes(u.value)??!1}),e.jsx(hr,{primary:u.label})]},u.value))})]}),e.jsxs(Mt,{sx:{minWidth:180,flex:"1 1 200px"},size:"small",children:[e.jsx(qt,{id:"task-assigned-label",children:"Assigned to"}),e.jsxs(Ut,{labelId:"task-assigned-label",value:t.assignedTo?String(t.assignedTo):"",label:"Assigned to",onChange:o,children:[e.jsx(Ze,{value:"",children:e.jsx("em",{children:"All team members"})}),r.map(u=>e.jsx(Ze,{value:u.id,children:u.username||u.email},u.id))]})]}),e.jsx(le,{label:"Search",size:"small",value:t.search??"",onChange:i("search"),sx:{flex:"1 1 200px"}}),e.jsx(le,{label:"Due from",type:"date",size:"small",value:t.dueFrom?.slice(0,10)??"",onChange:i("dueFrom"),InputLabelProps:{shrink:!0},sx:{flex:"1 1 180px"}}),e.jsx(le,{label:"Due to",type:"date",size:"small",value:t.dueTo?.slice(0,10)??"",onChange:i("dueTo"),InputLabelProps:{shrink:!0},sx:{flex:"1 1 180px"}}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column",gap:1,flex:"1 1 220px"},children:[e.jsx(yn,{control:e.jsx(gn,{checked:t.includeCompleted??!1,onChange:c("includeCompleted")}),label:"Show completed"}),e.jsx(yn,{control:e.jsx(gn,{checked:t.includeArchived??!1,onChange:c("includeArchived")}),label:"Show archived"})]}),a&&e.jsx(k,{sx:{display:"flex",alignItems:"center"},children:e.jsx(Q,{variant:"text",onClick:a,color:"secondary",children:"Reset"})})]})})};var Ha={},gu;function HS(){if(gu)return Ha;gu=1;var t=vt();Object.defineProperty(Ha,"__esModule",{value:!0}),Ha.default=void 0;var r=t(_t()),n=bt();return Ha.default=(0,r.default)((0,n.jsx)("path",{d:"M3 18h12v-2H3zM3 6v2h18V6zm0 7h18v-2H3z"}),"Notes"),Ha}var YS=HS();const yu=st(YS);var Ya={},vu;function VS(){if(vu)return Ya;vu=1;var t=vt();Object.defineProperty(Ya,"__esModule",{value:!0}),Ya.default=void 0;var r=t(_t()),n=bt();return Ya.default=(0,r.default)((0,n.jsx)("path",{d:"M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 18H4V8h16z"}),"CalendarToday"),Ya}var GS=VS();const QS=st(GS),yh=({completed:t,disabled:r,onToggle:n,label:a})=>{const s=o=>{n(o.target.checked)};return e.jsx(Ht,{title:t?"Mark as incomplete":"Mark as completed",children:e.jsx(yn,{control:e.jsx(ni,{checked:t,onChange:s,disabled:r,color:"success",size:"small"}),label:a??(t?"Completed":"Mark complete")})})},KS={pending:"Pending",in_progress:"In Progress",completed:"Completed",archived:"Archived"},JS={pending:"warning",in_progress:"info",completed:"success",archived:"default"},vh=t=>t?new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric",year:"numeric"}).format(new Date(t)):"No due date",Ki=typeof Intl<"u"&&"RelativeTimeFormat"in Intl?new Intl.RelativeTimeFormat(void 0,{numeric:"auto"}):null,bu=t=>{if(!t)return"Never";const r=new Date(t);if(Number.isNaN(r.getTime())||!Ki)return vh(t);const n=r.getTime()-Date.now(),a=Math.abs(n),s=[["day",1e3*60*60*24],["hour",1e3*60*60],["minute",1e3*60]];for(const[o,i]of s)if(a>=i||o==="minute"){const c=Math.round(n/i);return Ki.format(c,o)}return Ki.format(0,"minute")},XS=({tasks:t,onSelect:r,onToggleComplete:n,onEdit:a,onDelete:s})=>t.length===0?e.jsxs(k,{textAlign:"center",py:6,color:"text.secondary",sx:{border:"1px dashed",borderColor:"divider",borderRadius:3,backgroundColor:"background.paper"},children:[e.jsx(yu,{sx:{fontSize:48,mb:1}}),e.jsx(h,{variant:"h6",children:"No tasks found"}),e.jsx(h,{variant:"body2",children:"Use the New task button above to create your first assignment."})]}):e.jsx(Pe,{spacing:2.5,children:t.map(o=>{const i=o.dueDate?new Date(o.dueDate):null,c=Date.now(),u=!!(i&&i.getTime()<c&&o.status!=="completed"),d=i&&o.status!=="completed"?Math.ceil((i.getTime()-c)/(1e3*60*60*24)):null,p=typeof d=="number"&&d>=0&&d<=3,m=u?"error.main":o.status==="completed"?"success.main":p?"warning.main":"info.main";return e.jsxs(kt,{elevation:0,sx:{position:"relative",borderRadius:3,border:"1px solid",borderColor:"divider",overflow:"hidden",transition:"all 0.2s ease-in-out",backgroundColor:o.createdByAgent?"rgba(25, 118, 210, 0.06)":"background.paper","&:hover":{boxShadow:8,transform:"translateY(-2px)"}},children:[e.jsx(k,{sx:{position:"absolute",top:0,left:0,bottom:0,width:6,bgcolor:m}}),e.jsx(rm,{onClick:()=>r(o),sx:{alignSelf:"stretch"},children:e.jsx(k,{sx:{p:{xs:2.5,sm:3}},children:e.jsxs(Pe,{spacing:2,children:[e.jsxs(Pe,{direction:{xs:"column",md:"row"},spacing:1.5,justifyContent:"space-between",alignItems:{xs:"flex-start",md:"center"},children:[e.jsx(h,{variant:"h6",children:o.title}),e.jsxs(Pe,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",useFlexGap:!0,children:[e.jsx(De,{label:KS[o.status],color:JS[o.status],size:"small"}),o.createdByAgent&&e.jsx(De,{label:"AI",size:"small",color:"info",variant:"outlined"}),u&&o.status!=="completed"&&e.jsx(De,{label:"Overdue",color:"error",size:"small",variant:"outlined"}),o.status==="completed"&&e.jsx(De,{label:`Completed ${bu(o.completedAt)}`,color:"success",size:"small",variant:"outlined"})]})]}),o.description&&e.jsx(h,{variant:"body2",color:"text.secondary",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:o.description}),e.jsxs(Pe,{direction:{xs:"column",md:"row"},spacing:2,justifyContent:"space-between",alignItems:{xs:"flex-start",md:"center"},children:[e.jsxs(Pe,{direction:"row",spacing:1,flexWrap:"wrap",useFlexGap:!0,children:[e.jsx(De,{icon:e.jsx(QS,{fontSize:"small"}),label:vh(o.dueDate),color:u?"error":p?"warning":"default",variant:o.dueDate?"filled":"outlined",size:"small"}),e.jsx(De,{icon:e.jsx(yu,{fontSize:"small"}),label:`${o.noteCount} note${o.noteCount===1?"":"s"}`,size:"small",variant:"outlined"}),e.jsx(De,{icon:e.jsx(kp,{fontSize:"small"}),label:`Updated ${bu(o.updatedAt)}`,size:"small",variant:"outlined"})]}),o.assignees.length>0?e.jsx(nm,{max:4,sx:{"& .MuiAvatar-root":{width:32,height:32,fontSize:14}},children:o.assignees.map(f=>e.jsx(Ht,{title:f.username||f.email,children:e.jsx(Rn,{children:(f.username||f.email||"?").charAt(0).toUpperCase()})},`${o.id}-assignee-${f.id}`))}):e.jsx(De,{label:"Unassigned",size:"small",variant:"outlined"})]})]})})}),e.jsx(fr,{}),e.jsxs(rl,{sx:{px:{xs:2,sm:3},py:1.5,justifyContent:"space-between",alignItems:"center"},children:[e.jsx(k,{onClick:f=>f.stopPropagation(),sx:{display:"flex",alignItems:"center"},children:e.jsx(yh,{completed:o.status==="completed",onToggle:f=>n(o,f),label:o.status==="completed"?"Completed":"Mark complete"})}),e.jsxs(Pe,{direction:"row",spacing:1.5,alignItems:"center",children:[e.jsx(Ht,{title:"Edit task",children:e.jsx(gt,{onClick:f=>{f.stopPropagation(),a(o)},children:e.jsx(ao,{})})}),e.jsx(Ht,{title:"Delete task",children:e.jsx(gt,{color:"error",onClick:f=>{f.stopPropagation(),s(o)},children:e.jsx(xr,{})})})]})]})]},o.id)})});var Va={},_u;function ZS(){if(_u)return Va;_u=1;var t=vt();Object.defineProperty(Va,"__esModule",{value:!0}),Va.default=void 0;var r=t(_t()),n=bt();return Va.default=(0,r.default)((0,n.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close"),Va}var e1=ZS();const t1=st(e1),Ga=t=>t?new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric"}).format(new Date(t)):"Not set",r1=({open:t,task:r,loading:n,onClose:a,onEdit:s,onToggleComplete:o,onAddNote:i})=>{const[c,u]=l.useState(""),[d,p]=l.useState(!1),[m,f]=l.useState(!1);l.useEffect(()=>{t||(u(""),p(!1),f(!1))},[t]);const _=async()=>{if(c.trim()){p(!0);try{await i(c.trim()),u("")}finally{p(!1)}}},v=async w=>{f(!0);try{await o(w)}finally{f(!1)}};return e.jsxs(mt,{open:t,onClose:a,fullWidth:!0,maxWidth:"md",children:[e.jsxs(ft,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(h,{variant:"h6",children:"Task details"}),e.jsx(gt,{onClick:a,children:e.jsx(t1,{})})]}),e.jsx(xt,{dividers:!0,children:n&&!r?e.jsx(h,{variant:"body2",children:"Loading task details"}):r?e.jsxs(Pe,{spacing:3,children:[e.jsxs(k,{children:[e.jsxs(Pe,{direction:"row",spacing:2,alignItems:"center",flexWrap:"wrap",children:[e.jsx(h,{variant:"h5",children:r.title}),e.jsx(De,{label:r.status.replace("_"," "),color:r.status==="completed"?"success":"default"})]}),r.description&&e.jsx(h,{variant:"body1",sx:{mt:1},color:"text.secondary",children:r.description})]}),e.jsxs(Pe,{direction:{xs:"column",sm:"row"},spacing:3,children:[e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",color:"text.secondary",children:"Due date"}),e.jsx(h,{variant:"body1",children:Ga(r.dueDate)})]}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",color:"text.secondary",children:"Last updated"}),e.jsx(h,{variant:"body1",children:Ga(r.updatedAt)})]}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",color:"text.secondary",children:"Completed at"}),e.jsx(h,{variant:"body1",children:Ga(r.completedAt)})]})]}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Assigned team members"}),r.assignees.length===0?e.jsx(h,{variant:"body2",color:"text.secondary",children:"No assignees yet."}):e.jsx(Pe,{direction:"row",spacing:1,flexWrap:"wrap",children:r.assignees.map(w=>e.jsx(De,{label:w.username||w.email},w.id))})]}),e.jsx(fr,{}),e.jsxs(Pe,{direction:{xs:"column",sm:"row"},spacing:2,alignItems:{xs:"flex-start",sm:"center"},children:[e.jsx(yh,{completed:r.status==="completed",onToggle:v,disabled:m}),e.jsx(Q,{variant:"outlined",onClick:s,children:"Edit task"})]}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:"Notes"}),r.notes&&r.notes.length>0?e.jsx(kr,{dense:!0,children:r.notes.map(w=>e.jsx(Ar,{alignItems:"flex-start",disableGutters:!0,children:e.jsx(hr,{primary:w.note,secondary:w.authorName?`${w.authorName}  ${Ga(w.createdAt)}`:Ga(w.createdAt)})},w.id))}):e.jsx(h,{variant:"body2",color:"text.secondary",children:"No notes yet."})]}),e.jsxs(Pe,{direction:{xs:"column",sm:"row"},spacing:2,alignItems:{xs:"stretch",sm:"center"},children:[e.jsx(le,{label:"Add a note",fullWidth:!0,value:c,onChange:w=>u(w.target.value),multiline:!0,minRows:2}),e.jsx(Q,{variant:"contained",onClick:_,disabled:!c.trim()||d,children:"Add note"})]})]}):e.jsx(h,{variant:"body2",children:"Task not found."})}),e.jsx(jt,{children:e.jsx(Q,{onClick:a,children:"Close"})})]})},n1=[{value:"pending",label:"Pending"},{value:"in_progress",label:"In Progress"},{value:"completed",label:"Completed"},{value:"archived",label:"Archived"}],s1=t=>{if(!t)return"";try{const r=new Date(t);return Number.isNaN(r.getTime())?"":r.toISOString().slice(0,10)}catch{return""}},a1=({open:t,mode:r,initialTask:n,assignees:a,submitting:s,onClose:o,onSubmit:i})=>{const[c,u]=l.useState(""),[d,p]=l.useState(""),[m,f]=l.useState(""),[_,v]=l.useState("pending"),[w,b]=l.useState([]),[P,N]=l.useState(""),[j,E]=l.useState({});l.useEffect(()=>{t&&(r==="edit"&&n?(u(n.title),p(n.description??""),f(s1(n.dueDate)),v(n.status),b(n.assignees.map(y=>y.id))):(u(""),p(""),f(""),v("pending"),b([])),N(""),E({}))},[t,r,n]);const A=l.useMemo(()=>[...a].sort((y,x)=>(y.username||y.email||"").localeCompare(x.username||x.email||"")),[a]),C=async()=>{const y=c.trim();if(!y){E({title:"Title is required"});return}const x=d.trim(),D={title:y,description:x.length>0?x:null,dueDate:m?new Date(m).toISOString():null,status:_,assigneeIds:w};r==="create"&&P.trim()&&(D.initialNote=P.trim()),await i(D)},L=r==="create"?"Create task":"Edit task";return e.jsxs(mt,{open:t,onClose:o,fullWidth:!0,maxWidth:"sm",children:[e.jsx(ft,{children:L}),e.jsx(xt,{children:e.jsxs(Pe,{spacing:3,sx:{mt:1},children:[e.jsx(le,{label:"Title",value:c,onChange:y=>u(y.target.value),error:!!j.title,helperText:j.title,required:!0,autoFocus:!0}),e.jsx(le,{label:"Description",value:d,onChange:y=>p(y.target.value),multiline:!0,minRows:3}),e.jsx(le,{label:"Due date",type:"date",value:m,onChange:y=>f(y.target.value),InputLabelProps:{shrink:!0}}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{id:"task-status-select",children:"Status"}),e.jsx(Ut,{labelId:"task-status-select",value:_,label:"Status",onChange:y=>v(y.target.value),children:n1.map(y=>e.jsx(Ze,{value:y.value,children:y.label},y.value))})]}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(qt,{id:"task-assignees-label",children:"Assign to"}),e.jsx(Ut,{labelId:"task-assignees-label",multiple:!0,value:w.map(String),onChange:y=>{const x=y.target.value,D=typeof x=="string"?x.split(","):x;b(D.map(M=>Number(M)).filter(M=>!Number.isNaN(M)))},input:e.jsx(Wu,{label:"Assign to"}),renderValue:y=>{const x=y;return x.length===0?"No assignees":x.map(D=>{const M=A.find(X=>X.id===Number(D));return M?.username||M?.email||D}).join(", ")},children:A.map(y=>e.jsx(Ze,{value:String(y.id),children:e.jsx(hr,{primary:y.username||y.email})},y.id))})]}),r==="create"&&e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Initial note (optional)"}),e.jsx(le,{placeholder:"Share context with your team",value:P,onChange:y=>N(y.target.value),fullWidth:!0,multiline:!0,minRows:2})]})]})}),e.jsxs(jt,{children:[e.jsx(Q,{onClick:o,disabled:s,children:"Cancel"}),e.jsx(Q,{onClick:C,variant:"contained",disabled:s,children:r==="create"?"Create task":"Save changes"})]})]})},ju=t=>[...t].sort((r,n)=>r-n),o1=(t,r)=>{if(t.length!==r.length)return!1;const n=ju(t),a=ju(r);return n.every((s,o)=>s===a[o])},wu={includeCompleted:!1,includeArchived:!1},i1=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(wu),[s,o]=l.useState([]),[i,c]=l.useState(null),[u,d]=l.useState(!0),[p,m]=l.useState(null),[f,_]=l.useState(null),[v,w]=l.useState(!1),[b,P]=l.useState(!1),[N,j]=l.useState(!1),[E,A]=l.useState("create"),[C,L]=l.useState(!1),[y,x]=l.useState(null),D=l.useCallback(async()=>{d(!0),m(null);try{const[K,F]=await Promise.all([dv(n),vl()]);r(K),c(F)}catch(K){console.error(K),m("Failed to load tasks. Please try again later.")}finally{d(!1)}},[n]),M=l.useCallback(async()=>{try{const K=await vl();c(K)}catch(K){console.error("Failed to refresh task summary",K)}},[]);l.useEffect(()=>{D()},[D]),l.useEffect(()=>{(async()=>{try{const F=await yv();o(F)}catch(F){console.error(F),z.error("Unable to load team members")}})()},[]);const X=K=>{a(K)},H=()=>{a(wu)},U=()=>{D()},G=()=>{A("create"),x(null),j(!0)},te=K=>{A("edit"),x(K),j(!0)},re=async K=>{P(!0);try{const F=await uv(K.id);_(F),w(!0)}catch(F){console.error(F),z.error("Unable to load task details")}finally{P(!1)}},S=l.useCallback(K=>{r(F=>F.some(ve=>ve.id===K.id)?F.map(ve=>ve.id===K.id?{...ve,...K}:ve):[K,...F])},[]),g=async K=>{try{if(L(!0),E==="create"){const F=await pv({...K,description:K.description??null});z.success("Task created successfully"),j(!1),x(null),S(F)}else if(E==="edit"&&y){const F=await hv(y.id,{title:K.title,description:K.description??null,status:K.status,dueDate:K.dueDate??null}),xe=y.assignees?.map(me=>me.id)??[],de=!o1(xe,K.assigneeIds)?await mv(y.id,K.assigneeIds):{...F,assignees:y.assignees};z.success("Task updated successfully"),j(!1),x(null),S(de),_(me=>me&&me.id===de.id?{...me,...de,notes:me.notes}:me)}await D()}catch(F){console.error(F),z.error("Failed to save task changes")}finally{L(!1)}},T=async(K,F)=>{try{const xe=await fv(K.id,F);S(xe),_(ve=>ve&&ve.id===xe.id?{...ve,...xe,notes:ve.notes}:ve),z.success(F?"Task marked as completed":"Task reopened"),await M()}catch(xe){console.error(xe),z.error("Failed to update task status")}},q=async K=>{if(window.confirm(`Delete task "${K.title}"? This action cannot be undone.`))try{await gv(K.id),r(xe=>xe.filter(ve=>ve.id!==K.id)),f?.id===K.id&&(w(!1),_(null)),z.success("Task deleted"),await D()}catch(xe){console.error(xe),z.error("Failed to delete task")}},ee=async K=>{if(f)try{const F=await xv(f.id,K);_(xe=>xe&&{...xe,notes:[F,...xe.notes??[]],noteCount:(xe.noteCount??0)+1,lastNoteAt:F.createdAt}),r(xe=>xe.map(ve=>ve.id===f.id?{...ve,noteCount:ve.noteCount+1,lastNoteAt:F.createdAt}:ve)),z.success("Note added")}catch(F){console.error(F),z.error("Failed to add note")}},R=l.useMemo(()=>n,[n]);return e.jsxs(nt,{maxWidth:"lg",sx:{py:4},children:[e.jsxs(Pe,{spacing:3,children:[e.jsx(qp,{summary:i,loading:u&&t.length===0,onRefresh:U}),e.jsxs(Me,{sx:{p:{xs:2.5,md:4},borderRadius:3,border:"1px solid",borderColor:"divider",boxShadow:"0 24px 60px -36px rgba(15, 23, 42, 0.45)",background:"linear-gradient(145deg, rgba(15, 118, 110, 0.04) 0%, rgba(30, 64, 175, 0.05) 100%)"},children:[e.jsxs(Pe,{direction:{xs:"column",md:"row"},spacing:2,justifyContent:"space-between",alignItems:{xs:"flex-start",md:"center"},children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Tasks"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Manage assignments, due dates, and shared notes for your team."})]}),e.jsxs(Pe,{direction:"row",spacing:1,children:[e.jsx(Q,{variant:"outlined",startIcon:e.jsx(_n,{}),onClick:U,children:"Refresh"}),e.jsx(Q,{variant:"contained",startIcon:e.jsx(Nr,{}),onClick:G,children:"New task"})]})]}),e.jsx(k,{sx:{mt:3},children:e.jsx(BS,{filters:R,assignees:s,onChange:X,onReset:H})}),p&&e.jsx(Fe,{severity:"error",sx:{mt:2},children:p}),e.jsx(k,{sx:{mt:3},children:u&&t.length===0?e.jsx(k,{display:"flex",justifyContent:"center",py:6,children:e.jsx(ot,{})}):e.jsx(XS,{tasks:t,onSelect:re,onToggleComplete:T,onEdit:te,onDelete:q})})]})]}),e.jsx(r1,{open:v,task:f,loading:b,onClose:()=>w(!1),onEdit:()=>{f&&te(f)},onToggleComplete:K=>f?T(f,K):Promise.resolve(),onAddNote:ee}),e.jsx(a1,{open:N,mode:E,initialTask:y,assignees:s,submitting:C,onClose:()=>j(!1),onSubmit:g})]})},l1=async(t="all")=>(await B.get("/api/return-orders",{params:{status:t}})).data,c1=async t=>(await B.get(`/api/return-orders/${t}`)).data,d1=async t=>(await B.post("/api/return-orders",t)).data,u1=async(t,r)=>{await B.put(`/api/return-orders/${t}`,r)},p1=async t=>(await B.get(`/api/return-orders/by-purchase/${t}`)).data,h1=async(t,r)=>(await B.get(`/api/return-orders/purchase/${t}/line-items`,{params:r?{excludeReturnId:r}:void 0})).data.items,bh=t=>{window.open(`/api/return-orders/${t}/pdf`,"_blank")},m1=[{label:"Return Requested",value:"Requested"},{label:"Returned",value:"Returned"},{label:"All",value:"all"}],f1=()=>{const[t,r]=l.useState("Requested"),[n,a]=l.useState(""),[s,o]=l.useState([]),[i,c]=l.useState(!1),u=Gt(),d=l.useCallback(async()=>{c(!0);try{const f=await l1(t);o(f)}catch(f){console.error("Failed to load return orders",f),o([])}finally{c(!1)}},[t]);l.useEffect(()=>{d()},[d]);const p=l.useMemo(()=>{if(!n)return s;const f=n.toLowerCase();return s.filter(_=>_.return_number?.toLowerCase().includes(f)||_.purchase_number?.toLowerCase().includes(f)||_.vendor_name?.toLowerCase().includes(f))},[s,n]),m=[{field:"return_number",headerName:"Return #",flex:1,minWidth:150,renderCell:f=>e.jsx(h,{color:"primary",sx:{cursor:"pointer"},children:f.value})},{field:"purchase_number",headerName:"Purchase Order",flex:1,minWidth:150,renderCell:f=>e.jsx(h,{color:"primary",sx:{cursor:"pointer"},children:f.value||"-"})},{field:"vendor_name",headerName:"Vendor",flex:1.3,minWidth:160,valueGetter:f=>f.value||"No Vendor"},{field:"status",headerName:"Status",flex:.8,minWidth:130,renderCell:f=>e.jsx(De,{label:f.value,color:f.value==="Returned"?"success":"warning",variant:"outlined",size:"small"})},{field:"requested_at",headerName:"Requested On",flex:.9,minWidth:150,valueFormatter:f=>f.value?et(f.value).format("YYYY-MM-DD HH:mm"):""},{field:"returned_at",headerName:"Returned On",flex:.9,minWidth:150,valueFormatter:f=>f.value?et(f.value).format("YYYY-MM-DD HH:mm"):""},{field:"total_quantity",headerName:"Total Qty",flex:.6,minWidth:110,type:"number",valueFormatter:f=>Number(f.value??0).toFixed(2)},{field:"actions",headerName:"Actions",sortable:!1,filterable:!1,width:120,renderCell:f=>e.jsx(Pe,{direction:"row",spacing:1,children:e.jsx(Q,{size:"small",variant:"outlined",color:"primary",startIcon:e.jsx(gr,{fontSize:"small"}),onClick:_=>{_.stopPropagation(),bh(Number(f.row.return_id))},children:"PDF"})})}];return e.jsx(nt,{maxWidth:"xl",sx:{mt:4},children:e.jsxs(Pe,{spacing:3,children:[e.jsxs(k,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Return Orders"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Track requested and completed vendor returns linked to purchase orders."})]}),e.jsxs(Pe,{direction:{xs:"column",sm:"row"},spacing:2,alignItems:{xs:"stretch",sm:"center"},children:[e.jsx(le,{size:"small",placeholder:"Search return #, purchase #, vendor",value:n,onChange:f=>a(f.target.value),InputProps:{startAdornment:e.jsx(Hr,{color:"action",sx:{mr:1}})}}),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(_n,{}),onClick:d,disabled:i,children:"Refresh"}),e.jsx(Q,{variant:"contained",startIcon:e.jsx(Nr,{}),onClick:()=>u("/return-orders/new"),children:"New Return Order"})]})]}),e.jsx(Me,{elevation:0,sx:{p:2},children:e.jsx(sm,{value:t,onChange:(f,_)=>r(_),variant:"scrollable",scrollButtons:"auto",children:m1.map(f=>e.jsx(am,{label:f.label,value:f.value},f.value))})}),e.jsx(Me,{elevation:0,sx:{height:600},children:e.jsx(tn,{rows:p,columns:m,loading:i,getRowId:f=>f.return_id,disableRowSelectionOnClick:!0,onRowClick:f=>u(`/return-orders/${f.row.return_id}`),sx:{border:"none","& .MuiDataGrid-cell":{cursor:"pointer"}}})})]})})},x1=async t=>{try{return(await B.get("/api/purchase-history",{params:t})).data}catch(r){throw console.error("Error fetching purchase orders:",r),r}};function g1(){return new URLSearchParams(un().search)}const Su=()=>{const{id:t}=jn(),r=Gt(),n=g1(),a=!t||t==="new",[s,o]=l.useState(!0),[i,c]=l.useState(!1),[u,d]=l.useState([]),[p,m]=l.useState(null),[f,_]=l.useState("Requested"),[v,w]=l.useState(""),[b,P]=l.useState(void 0),[N,j]=l.useState(""),[E,A]=l.useState([]),[C,L]=l.useState(null),[y,x]=l.useState(null),[D,M]=l.useState({}),X=l.useCallback(async()=>{try{const g=(await x1({status:"all"})).map(T=>({label:`${T.purchase_number}  ${T.vendor_name??"No Vendor"}`,purchase_id:T.purchase_id,purchase_number:T.purchase_number,vendor_name:T.vendor_name}));return d(g),g}catch(S){return console.error("Failed to load purchase orders",S),d([]),[]}},[]),H=l.useCallback(async S=>{try{const g=await p1(S),T=g.filter(ee=>ee.status==="Requested").length,q=g.filter(ee=>ee.status==="Returned").length;M(ee=>({...ee,[S]:{requested:T,returned:q}}))}catch(g){console.warn("Unable to load return summary for purchase",g)}},[]),U=l.useCallback(async(S,g,T)=>{try{const ee=(await h1(S,T))?.map(R=>{const K=g?.find(F=>F.purchase_line_item_id===R.line_item_id);return{purchase_line_item_id:R.line_item_id,part_number:R.part_number,part_description:R.part_description,unit:R.unit,quantityPurchased:R.quantity,returnable_quantity:R.returnable_quantity+(K?Number(K.quantity):0),already_requested:R.already_requested,inputQuantity:K?String(K.quantity):"",reason:K?.reason??""}});A(ee??[])}catch(q){console.error("Failed to load available return items",q),A([])}},[]);l.useEffect(()=>{(async()=>{const g=await X(),T=n.get("purchaseId");if(!a&&t){try{const q=await c1(Number(t));L(q),_(q.status),w(q.requested_by??""),P(q.requested_at),j(q.notes??"");const ee={label:`${q.purchase_number||""}  ${q.vendor_name||"No Vendor"}`,purchase_id:q.purchase_id,purchase_number:q.purchase_number||"",vendor_name:q.vendor_name||void 0};m(ee),await U(q.purchase_id,q.line_items,q.return_id),await H(q.purchase_id)}catch(q){console.error("Failed to load return order detail",q),x("Unable to load return order.")}finally{o(!1)}return}if(T){const q=Number(T);if(Number.isFinite(q)){const R=(g.length?g:u).find(K=>K.purchase_id===q);R&&(m(R),await U(q),await H(q))}}o(!1)})()},[U,t,a,X,H,n]);const G=async(S,g)=>{m(g),g?(await U(g.purchase_id,C?.line_items,C?.return_id??void 0),await H(g.purchase_id)):A([])},te=l.useMemo(()=>E.reduce((S,g)=>{const T=parseFloat(g.inputQuantity||"0");return S+(Number.isFinite(T)?T:0)},0),[E]),re=async()=>{if(x(null),!p){x("Select a purchase order before saving.");return}const S=E.map(T=>({purchase_line_item_id:T.purchase_line_item_id,quantity:parseFloat(T.inputQuantity||"0"),reason:T.reason?.trim()?T.reason.trim():void 0,maxQuantity:T.returnable_quantity,part_number:T.part_number})).filter(T=>Number.isFinite(T.quantity)&&T.quantity>0);if(S.length===0){x("Enter a quantity for at least one part to return.");return}for(const T of S)if(T.quantity>(T.maxQuantity??0)+1e-6){x(`Return quantity for part ${T.part_number} exceeds the available quantity.`);return}const g={purchase_id:p.purchase_id,status:f,requested_by:v||void 0,requested_at:b,notes:N||void 0,line_items:S.map(({purchase_line_item_id:T,quantity:q,reason:ee})=>({purchase_line_item_id:T,quantity:q,reason:ee}))};try{if(c(!0),a){const T=await d1(g);z.success(`Return order ${T.return_number} created.`)}else t&&(await u1(Number(t),{status:g.status,requested_by:g.requested_by,requested_at:g.requested_at,notes:g.notes,line_items:g.line_items}),z.success("Return order updated."));r("/return-orders")}catch(T){console.error("Failed to save return order",T);const q=T?.response?.data?.error||"Unable to save return order.";x(q),z.error(q)}finally{c(!1)}};return s?e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"60vh",children:e.jsx(ot,{})}):e.jsx(nt,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(Pe,{spacing:3,children:[e.jsxs(Pe,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"h1",children:a?"Create Return Order":`Return Order ${C?.return_number??""}`}),p&&e.jsxs(Pe,{direction:"row",spacing:1,sx:{mt:1},children:[e.jsx(De,{label:`Purchase: ${p.purchase_number}`,color:"primary",variant:"outlined"}),e.jsx(De,{label:`Vendor: ${p.vendor_name??"No Vendor"}`,variant:"outlined",color:"secondary"}),D[p.purchase_id]&&e.jsx(De,{label:`Returns - Requested: ${D[p.purchase_id].requested}  Completed: ${D[p.purchase_id].returned}`,color:"default",variant:"outlined"})]})]}),e.jsxs(Pe,{direction:{xs:"column",sm:"row"},spacing:2,children:[e.jsx(Q,{variant:"outlined",startIcon:e.jsx(Si,{}),onClick:()=>r("/return-orders"),children:"Back to List"}),!a&&t&&e.jsx(Q,{variant:"outlined",startIcon:e.jsx(gr,{}),onClick:()=>bh(Number(t)),children:"Download"}),e.jsx(Q,{variant:"contained",startIcon:e.jsx(is,{}),onClick:re,disabled:i,children:i?"Saving":"Save & Close"})]})]}),y&&e.jsx(Fe,{severity:"error",children:y}),e.jsx(Me,{sx:{p:3},elevation:1,children:e.jsxs(O,{container:!0,spacing:3,children:[e.jsx(O,{item:!0,xs:12,md:6,children:e.jsx(zr,{options:u,value:p,onChange:G,getOptionLabel:S=>S.label,renderInput:S=>e.jsx(le,{...S,label:"Purchase Order",placeholder:"Select purchase order"}),disabled:!a&&!!C})}),e.jsx(O,{item:!0,xs:12,md:3,children:e.jsxs(le,{select:!0,SelectProps:{native:!0},label:"Status",value:f,onChange:S=>_(S.target.value),fullWidth:!0,children:[e.jsx("option",{value:"Requested",children:"Requested"}),e.jsx("option",{value:"Returned",children:"Returned"})]})}),e.jsx(O,{item:!0,xs:12,md:3,children:e.jsx(le,{label:"Requested By",value:v,onChange:S=>w(S.target.value),fullWidth:!0})}),e.jsx(O,{item:!0,xs:12,md:6,children:e.jsx(le,{label:"Requested At",type:"datetime-local",fullWidth:!0,value:b?et(b).format("YYYY-MM-DDTHH:mm"):"",onChange:S=>P(S.target.value?new Date(S.target.value).toISOString():void 0),helperText:"Optional timestamp for when the return was requested"})}),e.jsx(O,{item:!0,xs:12,children:e.jsx(le,{label:"Notes",value:N,onChange:S=>j(S.target.value),multiline:!0,rows:3,fullWidth:!0,placeholder:"Add any notes for the vendor or internal team"})})]})}),e.jsx(Me,{sx:{p:3},elevation:1,children:e.jsxs(Pe,{spacing:2,children:[e.jsxs(Pe,{direction:{xs:"column",md:"row"},justifyContent:"space-between",alignItems:{xs:"flex-start",md:"center"},children:[e.jsx(h,{variant:"h6",children:"Return Line Items"}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Total Selected Quantity: ",te.toFixed(2)]})]}),E.length===0?e.jsx(h,{variant:"body2",color:"text.secondary",children:"Select a purchase order to view parts eligible for return."}):e.jsxs(k,{sx:{overflowX:"auto"},children:[e.jsxs(O,{container:!0,spacing:2,sx:{minWidth:800},children:[e.jsx(O,{item:!0,xs:2,children:e.jsx(h,{variant:"subtitle2",children:"Part Number"})}),e.jsx(O,{item:!0,xs:3,children:e.jsx(h,{variant:"subtitle2",children:"Description"})}),e.jsx(O,{item:!0,xs:1.5,children:e.jsx(h,{variant:"subtitle2",children:"Purchased"})}),e.jsx(O,{item:!0,xs:1.5,children:e.jsx(h,{variant:"subtitle2",children:"Available"})}),e.jsx(O,{item:!0,xs:1.5,children:e.jsx(h,{variant:"subtitle2",children:"Qty to Return"})}),e.jsx(O,{item:!0,xs:2.5,children:e.jsx(h,{variant:"subtitle2",children:"Reason"})})]}),E.map(S=>e.jsxs(O,{container:!0,spacing:2,sx:{minWidth:800,mt:1},children:[e.jsxs(O,{item:!0,xs:2,children:[e.jsx(h,{variant:"body2",sx:{fontWeight:600},children:S.part_number}),e.jsx(h,{variant:"caption",color:"text.secondary",children:S.unit?`Unit: ${S.unit}`:""})]}),e.jsx(O,{item:!0,xs:3,children:e.jsx(h,{variant:"body2",children:S.part_description||"-"})}),e.jsx(O,{item:!0,xs:1.5,children:e.jsx(h,{variant:"body2",children:S.quantityPurchased.toFixed(2)})}),e.jsxs(O,{item:!0,xs:1.5,children:[e.jsx(h,{variant:"body2",children:S.returnable_quantity.toFixed(2)}),S.already_requested>0&&e.jsxs(h,{variant:"caption",color:"text.secondary",children:["Already requested: ",S.already_requested.toFixed(2)]})]}),e.jsx(O,{item:!0,xs:1.5,children:e.jsx(le,{type:"number",size:"small",value:S.inputQuantity,onChange:g=>{const T=g.target.value;A(q=>q.map(ee=>ee.purchase_line_item_id===S.purchase_line_item_id?{...ee,inputQuantity:T}:ee))},inputProps:{min:0,step:.01,max:S.returnable_quantity},fullWidth:!0})}),e.jsx(O,{item:!0,xs:2.5,children:e.jsx(le,{size:"small",value:S.reason,onChange:g=>{const T=g.target.value;A(q=>q.map(ee=>ee.purchase_line_item_id===S.purchase_line_item_id?{...ee,reason:T}:ee))},placeholder:"Optional",fullWidth:!0})})]},S.purchase_line_item_id))]})]})})]})})},y1=({children:t})=>{const{isAuthenticated:r,user:n}=er(),s=un().pathname;if(!r)return e.jsx(ws,{to:"/login",replace:!0});if(n?.access_role==="Time Tracking"){if(s==="/"||s==="/dashboard")return e.jsx(ws,{to:"/attendance",replace:!0});if(s!=="/time-tracking"&&s!=="/attendance"&&s!=="/messaging"&&!s.startsWith("/open-sales-orders")&&!s.startsWith("/woker-sales-orders"))return e.jsx(ws,{to:"/attendance",replace:!0})}return n?.access_role==="Sales and Purchase"&&!["/","/open-sales-orders","/open-purchase-orders","/purchase-order","/return-orders","/parts-to-order","/inventory","/supply","/email-settings","/tasks","/messaging"].includes(s)&&!s.startsWith("/open-sales-orders/")&&!s.startsWith("/open-purchase-orders/")&&!s.startsWith("/purchase-order/")&&!s.startsWith("/return-orders/")?e.jsx(ws,{to:"/",replace:!0}):n?.access_role==="Quotes"&&s!=="/quotes"&&!s.startsWith("/quotes/")&&s!=="/messaging"?e.jsx(ws,{to:"/quotes",replace:!0}):e.jsx(e.Fragment,{children:t})},v1=()=>e.jsxs(of,{children:[e.jsx(lt,{path:"/login",element:e.jsx(Yy,{})}),e.jsx(lt,{path:"/register",element:e.jsx(Vy,{})}),e.jsxs(lt,{path:"/",element:e.jsx(y1,{children:e.jsx(Hy,{})}),children:[e.jsx(lt,{index:!0,element:e.jsx(ld,{})}),e.jsx(lt,{path:"dashboard",element:e.jsx(ld,{})}),e.jsx(lt,{path:"business-profile",element:e.jsx(kv,{})}),e.jsx(lt,{path:"qbo-account-mapping",element:e.jsx(wS,{})}),e.jsx(lt,{path:"customers",element:e.jsx(Gv,{})}),e.jsx(lt,{path:"customers/:id",element:e.jsx(Qv,{})}),e.jsx(lt,{path:"products",element:e.jsx(fS,{})}),e.jsx(lt,{path:"products/:id",element:e.jsx(lb,{})}),e.jsx(lt,{path:"purchase-order",element:e.jsx(Gd,{})}),e.jsx(lt,{path:"purchase-order/:id",element:e.jsx(Xd,{})}),e.jsx(lt,{path:"open-purchase-orders",element:e.jsx(Gd,{})}),e.jsx(lt,{path:"open-purchase-orders/:id",element:e.jsx(Xd,{})}),e.jsx(lt,{path:"return-orders",element:e.jsx(f1,{})}),e.jsx(lt,{path:"return-orders/new",element:e.jsx(Su,{})}),e.jsx(lt,{path:"return-orders/:id",element:e.jsx(Su,{})}),e.jsx(lt,{path:"vendors",element:e.jsx(ob,{})}),e.jsx(lt,{path:"vendors/:id",element:e.jsx(ib,{})}),e.jsx(lt,{path:"inventory",element:e.jsx(Cb,{})}),e.jsx(lt,{path:"supply",element:e.jsx(kb,{})}),e.jsx(lt,{path:"employees",element:e.jsx(Y0,{})}),e.jsx(lt,{path:"profile-documents",element:e.jsx(V0,{})}),e.jsx(lt,{path:"time-tracking",element:e.jsx(Gw,{})}),e.jsx(lt,{path:"attendance",element:e.jsx(yS,{})}),e.jsx(lt,{path:"time-tracking/reports",element:e.jsx(lS,{})}),e.jsx(lt,{path:"leave-management",element:e.jsx(uS,{})}),e.jsx(lt,{path:"leave-history",element:e.jsx(pS,{})}),e.jsx(lt,{path:"vacation-days-management",element:e.jsx(hS,{})}),e.jsx(lt,{path:"open-sales-orders",element:e.jsx(rw,{})}),e.jsx(lt,{path:"open-sales-orders/:id",element:e.jsx(sw,{})}),e.jsx(lt,{path:"woker-sales-orders",element:e.jsx(ou,{})}),e.jsx(lt,{path:"woker-sales-orders/:id",element:e.jsx(ou,{})}),e.jsx(lt,{path:"quotes",element:e.jsx(T0,{})}),e.jsx(lt,{path:"quotes/new",element:e.jsx(Wd,{})}),e.jsx(lt,{path:"quotes/:id",element:e.jsx(Wd,{})}),e.jsx(lt,{path:"margin-schedule",element:e.jsx(G0,{})}),e.jsx(lt,{path:"overhead-management",element:e.jsx(SS,{})}),e.jsx(lt,{path:"parts-to-order",element:e.jsx(CS,{})}),e.jsx(lt,{path:"tasks",element:e.jsx(i1,{})}),e.jsx(lt,{path:"backup-management",element:e.jsx(gS,{})}),e.jsx(lt,{path:"mobile-user-access",element:e.jsx(kS,{})}),e.jsx(lt,{path:"email-settings",element:e.jsx(AS,{})}),e.jsx(lt,{path:"email-templates",element:e.jsx(MS,{})}),e.jsx(lt,{path:"tasks/:id",element:e.jsx(zS,{})}),e.jsx(lt,{path:"messaging",element:e.jsx(B0,{})})]}),e.jsx(lt,{path:"*",element:e.jsx(ws,{to:"/",replace:!0})})]}),b1=()=>{const[t,r]=l.useState(0);return l.useEffect(()=>{window.__triggerSync=async()=>{try{await Ka()>0&&!window.__backendUnavailableSince&&(await rd(),r(await Ka()))}catch{}};let n=!0;const a=async()=>{try{const o=await Ka();if(n&&r(o),!window.__backendUnavailableSince&&o>0){await rd();const i=await Ka();n&&r(i)}}catch{}},s=setInterval(a,15e3);return a(),()=>{n=!1,clearInterval(s)}},[]),e.jsxs(om,{theme:Zx,children:[e.jsx(im,{}),e.jsx(Kx,{children:e.jsx(Xx,{children:e.jsxs(bn,{dateAdapter:os,children:[e.jsx(mf,{children:e.jsx(v1,{})}),e.jsx(Xg,{position:"top-right",autoClose:3e3,newestOnTop:!1,closeOnClick:!0,pauseOnFocusLoss:!0,draggable:!0,pauseOnHover:!0,theme:"colored"})]})})})]})};pm.createRoot(document.getElementById("root")).render(e.jsx(b1,{}));
