import{r as l,R as Ph,j as e,c as Dh,b as Eh,_ as Iu,F as Ih,B as ii,C as Tu,u as Th,a as yt,d as vt,S as ke,P as Ae,T as h,e as De,G as M,f as k,L as Pr,g as Mr,h as Ou,i as fr,A as Nn,k as Al,l as In,D as xr,m as Ml,n as Oh,o as G,p as le,q as Vt,I as gt,s as Ah,t as It,v as Tn,w as it,x as nl,y as sl,K as Mh,z as Rh,E as al,H as ec,J as ks,M as Yo,N as Fr,O as Au,Q as ol,U as Ps,V as to,W as Mu,X as Qn,Y as Ru,Z as Nu,$ as Nh,a0 as Lu,a1 as Rl,a2 as Vo,a3 as Go,a4 as Nl,a5 as Ni,a6 as Lh,a7 as qh,a8 as qu,a9 as Uh,aa as Wh,ab as at,ac as We,ad as vn,ae as on,af as Fh,ag as kt,ah as Tt,ai as $h,aj as tc,ak as mt,al as ft,am as xt,an as _t,ao as pr,ap as Jr,aq as et,ar as Uu,as as li,at as zh,au as Xe,av as Wu,aw as bn,ax as Mt,ay as Ut,az as Wt,aA as _n,aB as $r,aC as Ln,aD as ci,aE as Bh,aF as Hh,aG as lr,aH as nr,aI as sr,aJ as ht,aK as ne,aL as ar,aM as Ja,aN as ws,aO as Yh,aP as Fu,aQ as qs,aR as Vh,aS as Qo,aT as Gh,aU as Qh,aV as rc,aW as $u,aX as Kh,aY as di,aZ as ui,a_ as zu,a$ as il,b0 as Ds,b1 as Es,b2 as Jh,b3 as Xh,b4 as Zh,b5 as em,b6 as Bu,b7 as tm,b8 as rm,b9 as Hu,ba as nm,bb as Ll,bc as nc,bd as Li,be as sc,bf as sm,bg as am,bh as om,bi as ac,bj as ll,bk as Yu,bl as im,bm as lm,bn as cm,bo as dm,bp as um,bq as pm}from"./mui-D3U_MBdr.js";import{a as hm,g as st,b as mm}from"./vendor-kq2j8kjo.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();var _o={},oc;function fm(){if(oc)return _o;oc=1;var t=hm();return _o.createRoot=t.createRoot,_o.hydrateRoot=t.hydrateRoot,_o}var xm=fm();const gm=st(xm);/**
 * @remix-run/router v1.23.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function ro(){return ro=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(t[a]=n[a])}return t},ro.apply(this,arguments)}var On;(function(t){t.Pop="POP",t.Push="PUSH",t.Replace="REPLACE"})(On||(On={}));const ic="popstate";function ym(t){t===void 0&&(t={});function r(s,o){let{pathname:i="/",search:c="",hash:u=""}=ns(s.location.hash.substr(1));return!i.startsWith("/")&&!i.startsWith(".")&&(i="/"+i),cl("",{pathname:i,search:c,hash:u},o.state&&o.state.usr||null,o.state&&o.state.key||"default")}function n(s,o){let i=s.document.querySelector("base"),c="";if(i&&i.getAttribute("href")){let u=s.location.href,d=u.indexOf("#");c=d===-1?u:u.slice(0,d)}return c+"#"+(typeof o=="string"?o:Ko(o))}function a(s,o){ql(s.pathname.charAt(0)==="/","relative pathnames are not supported in hash history.push("+JSON.stringify(o)+")")}return bm(r,n,a,t)}function or(t,r){if(t===!1||t===null||typeof t>"u")throw new Error(r)}function ql(t,r){if(!t){typeof console<"u"&&console.warn(r);try{throw new Error(r)}catch{}}}function vm(){return Math.random().toString(36).substr(2,8)}function lc(t,r){return{usr:t.state,key:t.key,idx:r}}function cl(t,r,n,a){return n===void 0&&(n=null),ro({pathname:typeof t=="string"?t:t.pathname,search:"",hash:""},typeof r=="string"?ns(r):r,{state:n,key:r&&r.key||a||vm()})}function Ko(t){let{pathname:r="/",search:n="",hash:a=""}=t;return n&&n!=="?"&&(r+=n.charAt(0)==="?"?n:"?"+n),a&&a!=="#"&&(r+=a.charAt(0)==="#"?a:"#"+a),r}function ns(t){let r={};if(t){let n=t.indexOf("#");n>=0&&(r.hash=t.substr(n),t=t.substr(0,n));let a=t.indexOf("?");a>=0&&(r.search=t.substr(a),t=t.substr(0,a)),t&&(r.pathname=t)}return r}function bm(t,r,n,a){a===void 0&&(a={});let{window:s=document.defaultView,v5Compat:o=!1}=a,i=s.history,c=On.Pop,u=null,d=p();d==null&&(d=0,i.replaceState(ro({},i.state,{idx:d}),""));function p(){return(i.state||{idx:null}).idx}function f(){c=On.Pop;let _=p(),P=_==null?null:_-d;d=_,u&&u({action:c,location:w.location,delta:P})}function m(_,P){c=On.Push;let L=cl(w.location,_,P);n&&n(L,_),d=p()+1;let C=lc(L,d),D=w.createHref(L);try{i.pushState(C,"",D)}catch(A){if(A instanceof DOMException&&A.name==="DataCloneError")throw A;s.location.assign(D)}o&&u&&u({action:c,location:w.location,delta:1})}function j(_,P){c=On.Replace;let L=cl(w.location,_,P);n&&n(L,_),d=p();let C=lc(L,d),D=w.createHref(L);i.replaceState(C,"",D),o&&u&&u({action:c,location:w.location,delta:0})}function v(_){let P=s.location.origin!=="null"?s.location.origin:s.location.href,L=typeof _=="string"?_:Ko(_);return L=L.replace(/ $/,"%20"),or(P,"No window.location.(origin|href) available to create URL for href: "+L),new URL(L,P)}let w={get action(){return c},get location(){return t(s,i)},listen(_){if(u)throw new Error("A history only accepts one active listener");return s.addEventListener(ic,f),u=_,()=>{s.removeEventListener(ic,f),u=null}},createHref(_){return r(s,_)},createURL:v,encodeLocation(_){let P=v(_);return{pathname:P.pathname,search:P.search,hash:P.hash}},push:m,replace:j,go(_){return i.go(_)}};return w}var cc;(function(t){t.data="data",t.deferred="deferred",t.redirect="redirect",t.error="error"})(cc||(cc={}));function _m(t,r,n){return n===void 0&&(n="/"),jm(t,r,n)}function jm(t,r,n,a){let s=typeof r=="string"?ns(r):r,o=Ul(s.pathname||"/",n);if(o==null)return null;let i=Vu(t);wm(i);let c=null;for(let u=0;c==null&&u<i.length;++u){let d=Rm(o);c=Om(i[u],d)}return c}function Vu(t,r,n,a){r===void 0&&(r=[]),n===void 0&&(n=[]),a===void 0&&(a="");let s=(o,i,c)=>{let u={relativePath:c===void 0?o.path||"":c,caseSensitive:o.caseSensitive===!0,childrenIndex:i,route:o};u.relativePath.startsWith("/")&&(or(u.relativePath.startsWith(a),'Absolute route path "'+u.relativePath+'" nested under path '+('"'+a+'" is not valid. An absolute child route path ')+"must start with the combined path of all its parent routes."),u.relativePath=u.relativePath.slice(a.length));let d=Mn([a,u.relativePath]),p=n.concat(u);o.children&&o.children.length>0&&(or(o.index!==!0,"Index routes must not have child routes. Please remove "+('all child routes from route path "'+d+'".')),Vu(o.children,r,p,d)),!(o.path==null&&!o.index)&&r.push({path:d,score:Im(d,o.index),routesMeta:p})};return t.forEach((o,i)=>{var c;if(o.path===""||!((c=o.path)!=null&&c.includes("?")))s(o,i);else for(let u of Gu(o.path))s(o,i,u)}),r}function Gu(t){let r=t.split("/");if(r.length===0)return[];let[n,...a]=r,s=n.endsWith("?"),o=n.replace(/\?$/,"");if(a.length===0)return s?[o,""]:[o];let i=Gu(a.join("/")),c=[];return c.push(...i.map(u=>u===""?o:[o,u].join("/"))),s&&c.push(...i),c.map(u=>t.startsWith("/")&&u===""?"/":u)}function wm(t){t.sort((r,n)=>r.score!==n.score?n.score-r.score:Tm(r.routesMeta.map(a=>a.childrenIndex),n.routesMeta.map(a=>a.childrenIndex)))}const Sm=/^:[\w-]+$/,Cm=3,km=2,Pm=1,Dm=10,Em=-2,dc=t=>t==="*";function Im(t,r){let n=t.split("/"),a=n.length;return n.some(dc)&&(a+=Em),r&&(a+=km),n.filter(s=>!dc(s)).reduce((s,o)=>s+(Sm.test(o)?Cm:o===""?Pm:Dm),a)}function Tm(t,r){return t.length===r.length&&t.slice(0,-1).every((a,s)=>a===r[s])?t[t.length-1]-r[r.length-1]:0}function Om(t,r,n){let{routesMeta:a}=t,s={},o="/",i=[];for(let c=0;c<a.length;++c){let u=a[c],d=c===a.length-1,p=o==="/"?r:r.slice(o.length)||"/",f=Am({path:u.relativePath,caseSensitive:u.caseSensitive,end:d},p),m=u.route;if(!f)return null;Object.assign(s,f.params),i.push({params:s,pathname:Mn([o,f.pathname]),pathnameBase:Um(Mn([o,f.pathnameBase])),route:m}),f.pathnameBase!=="/"&&(o=Mn([o,f.pathnameBase]))}return i}function Am(t,r){typeof t=="string"&&(t={path:t,caseSensitive:!1,end:!0});let[n,a]=Mm(t.path,t.caseSensitive,t.end),s=r.match(n);if(!s)return null;let o=s[0],i=o.replace(/(.)\/+$/,"$1"),c=s.slice(1);return{params:a.reduce((d,p,f)=>{let{paramName:m,isOptional:j}=p;if(m==="*"){let w=c[f]||"";i=o.slice(0,o.length-w.length).replace(/(.)\/+$/,"$1")}const v=c[f];return j&&!v?d[m]=void 0:d[m]=(v||"").replace(/%2F/g,"/"),d},{}),pathname:o,pathnameBase:i,pattern:t}}function Mm(t,r,n){r===void 0&&(r=!1),n===void 0&&(n=!0),ql(t==="*"||!t.endsWith("*")||t.endsWith("/*"),'Route path "'+t+'" will be treated as if it were '+('"'+t.replace(/\*$/,"/*")+'" because the `*` character must ')+"always follow a `/` in the pattern. To get rid of this warning, "+('please change the route path to "'+t.replace(/\*$/,"/*")+'".'));let a=[],s="^"+t.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(i,c,u)=>(a.push({paramName:c,isOptional:u!=null}),u?"/?([^\\/]+)?":"/([^\\/]+)"));return t.endsWith("*")?(a.push({paramName:"*"}),s+=t==="*"||t==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):n?s+="\\/*$":t!==""&&t!=="/"&&(s+="(?:(?=\\/|$))"),[new RegExp(s,r?void 0:"i"),a]}function Rm(t){try{return t.split("/").map(r=>decodeURIComponent(r).replace(/\//g,"%2F")).join("/")}catch(r){return ql(!1,'The URL path "'+t+'" could not be decoded because it is is a malformed URL segment. This is probably due to a bad percent '+("encoding ("+r+").")),t}}function Ul(t,r){if(r==="/")return t;if(!t.toLowerCase().startsWith(r.toLowerCase()))return null;let n=r.endsWith("/")?r.length-1:r.length,a=t.charAt(n);return a&&a!=="/"?null:t.slice(n)||"/"}function Nm(t,r){r===void 0&&(r="/");let{pathname:n,search:a="",hash:s=""}=typeof t=="string"?ns(t):t;return{pathname:n?n.startsWith("/")?n:Lm(n,r):r,search:Wm(a),hash:Fm(s)}}function Lm(t,r){let n=r.replace(/\/+$/,"").split("/");return t.split("/").forEach(s=>{s===".."?n.length>1&&n.pop():s!=="."&&n.push(s)}),n.length>1?n.join("/"):"/"}function qi(t,r,n,a){return"Cannot include a '"+t+"' character in a manually specified "+("`to."+r+"` field ["+JSON.stringify(a)+"].  Please separate it out to the ")+("`to."+n+"` field. Alternatively you may provide the full path as ")+'a string in <Link to="..."> and the router will parse it for you.'}function qm(t){return t.filter((r,n)=>n===0||r.route.path&&r.route.path.length>0)}function Wl(t,r){let n=qm(t);return r?n.map((a,s)=>s===n.length-1?a.pathname:a.pathnameBase):n.map(a=>a.pathnameBase)}function Fl(t,r,n,a){a===void 0&&(a=!1);let s;typeof t=="string"?s=ns(t):(s=ro({},t),or(!s.pathname||!s.pathname.includes("?"),qi("?","pathname","search",s)),or(!s.pathname||!s.pathname.includes("#"),qi("#","pathname","hash",s)),or(!s.search||!s.search.includes("#"),qi("#","search","hash",s)));let o=t===""||s.pathname==="",i=o?"/":s.pathname,c;if(i==null)c=n;else{let f=r.length-1;if(!a&&i.startsWith("..")){let m=i.split("/");for(;m[0]==="..";)m.shift(),f-=1;s.pathname=m.join("/")}c=f>=0?r[f]:"/"}let u=Nm(s,c),d=i&&i!=="/"&&i.endsWith("/"),p=(o||i===".")&&n.endsWith("/");return!u.pathname.endsWith("/")&&(d||p)&&(u.pathname+="/"),u}const Mn=t=>t.join("/").replace(/\/\/+/g,"/"),Um=t=>t.replace(/\/+$/,"").replace(/^\/*/,"/"),Wm=t=>!t||t==="?"?"":t.startsWith("?")?t:"?"+t,Fm=t=>!t||t==="#"?"":t.startsWith("#")?t:"#"+t;function $m(t){return t!=null&&typeof t.status=="number"&&typeof t.statusText=="string"&&typeof t.internal=="boolean"&&"data"in t}const Qu=["post","put","patch","delete"];new Set(Qu);const zm=["get",...Qu];new Set(zm);/**
 * React Router v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function no(){return no=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(t[a]=n[a])}return t},no.apply(this,arguments)}const $l=l.createContext(null),Bm=l.createContext(null),Un=l.createContext(null),pi=l.createContext(null),ln=l.createContext({outlet:null,matches:[],isDataRoute:!1}),Ku=l.createContext(null);function Hm(t,r){let{relative:n}=r===void 0?{}:r;Us()||or(!1);let{basename:a,navigator:s}=l.useContext(Un),{hash:o,pathname:i,search:c}=Xu(t,{relative:n}),u=i;return a!=="/"&&(u=i==="/"?a:Mn([a,i])),s.createHref({pathname:u,search:c,hash:o})}function Us(){return l.useContext(pi)!=null}function cn(){return Us()||or(!1),l.useContext(pi).location}function Ju(t){l.useContext(Un).static||l.useLayoutEffect(t)}function Kt(){let{isDataRoute:t}=l.useContext(ln);return t?of():Ym()}function Ym(){Us()||or(!1);let t=l.useContext($l),{basename:r,future:n,navigator:a}=l.useContext(Un),{matches:s}=l.useContext(ln),{pathname:o}=cn(),i=JSON.stringify(Wl(s,n.v7_relativeSplatPath)),c=l.useRef(!1);return Ju(()=>{c.current=!0}),l.useCallback(function(d,p){if(p===void 0&&(p={}),!c.current)return;if(typeof d=="number"){a.go(d);return}let f=Fl(d,JSON.parse(i),o,p.relative==="path");t==null&&r!=="/"&&(f.pathname=f.pathname==="/"?r:Mn([r,f.pathname])),(p.replace?a.replace:a.push)(f,p.state,p)},[r,a,i,o,t])}const Vm=l.createContext(null);function Gm(t){let r=l.useContext(ln).outlet;return r&&l.createElement(Vm.Provider,{value:t},r)}function wn(){let{matches:t}=l.useContext(ln),r=t[t.length-1];return r?r.params:{}}function Xu(t,r){let{relative:n}=r===void 0?{}:r,{future:a}=l.useContext(Un),{matches:s}=l.useContext(ln),{pathname:o}=cn(),i=JSON.stringify(Wl(s,a.v7_relativeSplatPath));return l.useMemo(()=>Fl(t,JSON.parse(i),o,n==="path"),[t,i,o,n])}function Qm(t,r){return Km(t,r)}function Km(t,r,n,a){Us()||or(!1);let{navigator:s}=l.useContext(Un),{matches:o}=l.useContext(ln),i=o[o.length-1],c=i?i.params:{};i&&i.pathname;let u=i?i.pathnameBase:"/";i&&i.route;let d=cn(),p;if(r){var f;let _=typeof r=="string"?ns(r):r;u==="/"||(f=_.pathname)!=null&&f.startsWith(u)||or(!1),p=_}else p=d;let m=p.pathname||"/",j=m;if(u!=="/"){let _=u.replace(/^\//,"").split("/");j="/"+m.replace(/^\//,"").split("/").slice(_.length).join("/")}let v=_m(t,{pathname:j}),w=tf(v&&v.map(_=>Object.assign({},_,{params:Object.assign({},c,_.params),pathname:Mn([u,s.encodeLocation?s.encodeLocation(_.pathname).pathname:_.pathname]),pathnameBase:_.pathnameBase==="/"?u:Mn([u,s.encodeLocation?s.encodeLocation(_.pathnameBase).pathname:_.pathnameBase])})),o,n,a);return r&&w?l.createElement(pi.Provider,{value:{location:no({pathname:"/",search:"",hash:"",state:null,key:"default"},p),navigationType:On.Pop}},w):w}function Jm(){let t=af(),r=$m(t)?t.status+" "+t.statusText:t instanceof Error?t.message:JSON.stringify(t),n=t instanceof Error?t.stack:null,s={padding:"0.5rem",backgroundColor:"rgba(200,200,200, 0.5)"};return l.createElement(l.Fragment,null,l.createElement("h2",null,"Unexpected Application Error!"),l.createElement("h3",{style:{fontStyle:"italic"}},r),n?l.createElement("pre",{style:s},n):null,null)}const Xm=l.createElement(Jm,null);class Zm extends l.Component{constructor(r){super(r),this.state={location:r.location,revalidation:r.revalidation,error:r.error}}static getDerivedStateFromError(r){return{error:r}}static getDerivedStateFromProps(r,n){return n.location!==r.location||n.revalidation!=="idle"&&r.revalidation==="idle"?{error:r.error,location:r.location,revalidation:r.revalidation}:{error:r.error!==void 0?r.error:n.error,location:n.location,revalidation:r.revalidation||n.revalidation}}componentDidCatch(r,n){console.error("React Router caught the following error during render",r,n)}render(){return this.state.error!==void 0?l.createElement(ln.Provider,{value:this.props.routeContext},l.createElement(Ku.Provider,{value:this.state.error,children:this.props.component})):this.props.children}}function ef(t){let{routeContext:r,match:n,children:a}=t,s=l.useContext($l);return s&&s.static&&s.staticContext&&(n.route.errorElement||n.route.ErrorBoundary)&&(s.staticContext._deepestRenderedBoundaryId=n.route.id),l.createElement(ln.Provider,{value:r},a)}function tf(t,r,n,a){var s;if(r===void 0&&(r=[]),n===void 0&&(n=null),a===void 0&&(a=null),t==null){var o;if(!n)return null;if(n.errors)t=n.matches;else if((o=a)!=null&&o.v7_partialHydration&&r.length===0&&!n.initialized&&n.matches.length>0)t=n.matches;else return null}let i=t,c=(s=n)==null?void 0:s.errors;if(c!=null){let p=i.findIndex(f=>f.route.id&&c?.[f.route.id]!==void 0);p>=0||or(!1),i=i.slice(0,Math.min(i.length,p+1))}let u=!1,d=-1;if(n&&a&&a.v7_partialHydration)for(let p=0;p<i.length;p++){let f=i[p];if((f.route.HydrateFallback||f.route.hydrateFallbackElement)&&(d=p),f.route.id){let{loaderData:m,errors:j}=n,v=f.route.loader&&m[f.route.id]===void 0&&(!j||j[f.route.id]===void 0);if(f.route.lazy||v){u=!0,d>=0?i=i.slice(0,d+1):i=[i[0]];break}}}return i.reduceRight((p,f,m)=>{let j,v=!1,w=null,_=null;n&&(j=c&&f.route.id?c[f.route.id]:void 0,w=f.route.errorElement||Xm,u&&(d<0&&m===0?(lf("route-fallback"),v=!0,_=null):d===m&&(v=!0,_=f.route.hydrateFallbackElement||null)));let P=r.concat(i.slice(0,m+1)),L=()=>{let C;return j?C=w:v?C=_:f.route.Component?C=l.createElement(f.route.Component,null):f.route.element?C=f.route.element:C=p,l.createElement(ef,{match:f,routeContext:{outlet:p,matches:P,isDataRoute:n!=null},children:C})};return n&&(f.route.ErrorBoundary||f.route.errorElement||m===0)?l.createElement(Zm,{location:n.location,revalidation:n.revalidation,component:w,error:j,children:L(),routeContext:{outlet:null,matches:P,isDataRoute:!0}}):L()},null)}var Zu=function(t){return t.UseBlocker="useBlocker",t.UseRevalidator="useRevalidator",t.UseNavigateStable="useNavigate",t}(Zu||{}),ep=function(t){return t.UseBlocker="useBlocker",t.UseLoaderData="useLoaderData",t.UseActionData="useActionData",t.UseRouteError="useRouteError",t.UseNavigation="useNavigation",t.UseRouteLoaderData="useRouteLoaderData",t.UseMatches="useMatches",t.UseRevalidator="useRevalidator",t.UseNavigateStable="useNavigate",t.UseRouteId="useRouteId",t}(ep||{});function rf(t){let r=l.useContext($l);return r||or(!1),r}function nf(t){let r=l.useContext(Bm);return r||or(!1),r}function sf(t){let r=l.useContext(ln);return r||or(!1),r}function tp(t){let r=sf(),n=r.matches[r.matches.length-1];return n.route.id||or(!1),n.route.id}function af(){var t;let r=l.useContext(Ku),n=nf(),a=tp();return r!==void 0?r:(t=n.errors)==null?void 0:t[a]}function of(){let{router:t}=rf(Zu.UseNavigateStable),r=tp(ep.UseNavigateStable),n=l.useRef(!1);return Ju(()=>{n.current=!0}),l.useCallback(function(s,o){o===void 0&&(o={}),n.current&&(typeof s=="number"?t.navigate(s):t.navigate(s,no({fromRouteId:r},o)))},[t,r])}const uc={};function lf(t,r,n){uc[t]||(uc[t]=!0)}function cf(t,r){t?.v7_startTransition,t?.v7_relativeSplatPath}function _s(t){let{to:r,replace:n,state:a,relative:s}=t;Us()||or(!1);let{future:o,static:i}=l.useContext(Un),{matches:c}=l.useContext(ln),{pathname:u}=cn(),d=Kt(),p=Fl(r,Wl(c,o.v7_relativeSplatPath),u,s==="path"),f=JSON.stringify(p);return l.useEffect(()=>d(JSON.parse(f),{replace:n,state:a,relative:s}),[d,f,s,n,a]),null}function df(t){return Gm(t.context)}function dt(t){or(!1)}function uf(t){let{basename:r="/",children:n=null,location:a,navigationType:s=On.Pop,navigator:o,static:i=!1,future:c}=t;Us()&&or(!1);let u=r.replace(/^\/*/,"/"),d=l.useMemo(()=>({basename:u,navigator:o,static:i,future:no({v7_relativeSplatPath:!1},c)}),[u,c,o,i]);typeof a=="string"&&(a=ns(a));let{pathname:p="/",search:f="",hash:m="",state:j=null,key:v="default"}=a,w=l.useMemo(()=>{let _=Ul(p,u);return _==null?null:{location:{pathname:_,search:f,hash:m,state:j,key:v},navigationType:s}},[u,p,f,m,j,v,s]);return w==null?null:l.createElement(Un.Provider,{value:d},l.createElement(pi.Provider,{children:n,value:w}))}function pf(t){let{children:r,location:n}=t;return Qm(dl(r),n)}new Promise(()=>{});function dl(t,r){r===void 0&&(r=[]);let n=[];return l.Children.forEach(t,(a,s)=>{if(!l.isValidElement(a))return;let o=[...r,s];if(a.type===l.Fragment){n.push.apply(n,dl(a.props.children,o));return}a.type!==dt&&or(!1),!a.props.index||!a.props.children||or(!1);let i={id:a.props.id||o.join("-"),caseSensitive:a.props.caseSensitive,element:a.props.element,Component:a.props.Component,index:a.props.index,path:a.props.path,loader:a.props.loader,action:a.props.action,errorElement:a.props.errorElement,ErrorBoundary:a.props.ErrorBoundary,hasErrorBoundary:a.props.ErrorBoundary!=null||a.props.errorElement!=null,shouldRevalidate:a.props.shouldRevalidate,handle:a.props.handle,lazy:a.props.lazy};a.props.children&&(i.children=dl(a.props.children,o)),n.push(i)}),n}/**
 * React Router DOM v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function ul(){return ul=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(t[a]=n[a])}return t},ul.apply(this,arguments)}function hf(t,r){if(t==null)return{};var n={},a=Object.keys(t),s,o;for(o=0;o<a.length;o++)s=a[o],!(r.indexOf(s)>=0)&&(n[s]=t[s]);return n}function mf(t){return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}function ff(t,r){return t.button===0&&(!r||r==="_self")&&!mf(t)}const xf=["onClick","relative","reloadDocument","replace","state","target","to","preventScrollReset","viewTransition"],gf="6";try{window.__reactRouterVersion=gf}catch{}const yf="startTransition",pc=Ph[yf];function vf(t){let{basename:r,children:n,future:a,window:s}=t,o=l.useRef();o.current==null&&(o.current=ym({window:s,v5Compat:!0}));let i=o.current,[c,u]=l.useState({action:i.action,location:i.location}),{v7_startTransition:d}=a||{},p=l.useCallback(f=>{d&&pc?pc(()=>u(f)):u(f)},[u,d]);return l.useLayoutEffect(()=>i.listen(p),[i,p]),l.useEffect(()=>cf(a),[a]),l.createElement(uf,{basename:r,children:n,location:c.location,navigationType:c.action,navigator:i,future:a})}const bf=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u",_f=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,rp=l.forwardRef(function(r,n){let{onClick:a,relative:s,reloadDocument:o,replace:i,state:c,target:u,to:d,preventScrollReset:p,viewTransition:f}=r,m=hf(r,xf),{basename:j}=l.useContext(Un),v,w=!1;if(typeof d=="string"&&_f.test(d)&&(v=d,bf))try{let C=new URL(window.location.href),D=d.startsWith("//")?new URL(C.protocol+d):new URL(d),A=Ul(D.pathname,j);D.origin===C.origin&&A!=null?d=A+D.search+D.hash:w=!0}catch{}let _=Hm(d,{relative:s}),P=jf(d,{replace:i,state:c,target:u,preventScrollReset:p,relative:s,viewTransition:f});function L(C){a&&a(C),C.defaultPrevented||P(C)}return l.createElement("a",ul({},m,{href:v||_,onClick:w||o?a:L,ref:n,target:u}))});var hc;(function(t){t.UseScrollRestoration="useScrollRestoration",t.UseSubmit="useSubmit",t.UseSubmitFetcher="useSubmitFetcher",t.UseFetcher="useFetcher",t.useViewTransitionState="useViewTransitionState"})(hc||(hc={}));var mc;(function(t){t.UseFetcher="useFetcher",t.UseFetchers="useFetchers",t.UseScrollRestoration="useScrollRestoration"})(mc||(mc={}));function jf(t,r){let{target:n,replace:a,state:s,preventScrollReset:o,relative:i,viewTransition:c}=r===void 0?{}:r,u=Kt(),d=cn(),p=Xu(t,{relative:i});return l.useCallback(f=>{if(ff(f,n)){f.preventDefault();let m=a!==void 0?a:Ko(d)===Ko(p);u(t,{replace:m,state:s,preventScrollReset:o,relative:i,viewTransition:c})}},[d,u,p,a,s,n,t,o,i,c])}function np(t,r){return function(){return t.apply(r,arguments)}}const{toString:wf}=Object.prototype,{getPrototypeOf:zl}=Object,{iterator:hi,toStringTag:sp}=Symbol,mi=(t=>r=>{const n=wf.call(r);return t[n]||(t[n]=n.slice(8,-1).toLowerCase())})(Object.create(null)),Xr=t=>(t=t.toLowerCase(),r=>mi(r)===t),fi=t=>r=>typeof r===t,{isArray:Ws}=Array,so=fi("undefined");function Sf(t){return t!==null&&!so(t)&&t.constructor!==null&&!so(t.constructor)&&Rr(t.constructor.isBuffer)&&t.constructor.isBuffer(t)}const ap=Xr("ArrayBuffer");function Cf(t){let r;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?r=ArrayBuffer.isView(t):r=t&&t.buffer&&ap(t.buffer),r}const kf=fi("string"),Rr=fi("function"),op=fi("number"),xi=t=>t!==null&&typeof t=="object",Pf=t=>t===!0||t===!1,To=t=>{if(mi(t)!=="object")return!1;const r=zl(t);return(r===null||r===Object.prototype||Object.getPrototypeOf(r)===null)&&!(sp in t)&&!(hi in t)},Df=Xr("Date"),Ef=Xr("File"),If=Xr("Blob"),Tf=Xr("FileList"),Of=t=>xi(t)&&Rr(t.pipe),Af=t=>{let r;return t&&(typeof FormData=="function"&&t instanceof FormData||Rr(t.append)&&((r=mi(t))==="formdata"||r==="object"&&Rr(t.toString)&&t.toString()==="[object FormData]"))},Mf=Xr("URLSearchParams"),[Rf,Nf,Lf,qf]=["ReadableStream","Request","Response","Headers"].map(Xr),Uf=t=>t.trim?t.trim():t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function lo(t,r,{allOwnKeys:n=!1}={}){if(t===null||typeof t>"u")return;let a,s;if(typeof t!="object"&&(t=[t]),Ws(t))for(a=0,s=t.length;a<s;a++)r.call(null,t[a],a,t);else{const o=n?Object.getOwnPropertyNames(t):Object.keys(t),i=o.length;let c;for(a=0;a<i;a++)c=o[a],r.call(null,t[c],c,t)}}function ip(t,r){r=r.toLowerCase();const n=Object.keys(t);let a=n.length,s;for(;a-- >0;)if(s=n[a],r===s.toLowerCase())return s;return null}const Kn=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,lp=t=>!so(t)&&t!==Kn;function pl(){const{caseless:t}=lp(this)&&this||{},r={},n=(a,s)=>{const o=t&&ip(r,s)||s;To(r[o])&&To(a)?r[o]=pl(r[o],a):To(a)?r[o]=pl({},a):Ws(a)?r[o]=a.slice():r[o]=a};for(let a=0,s=arguments.length;a<s;a++)arguments[a]&&lo(arguments[a],n);return r}const Wf=(t,r,n,{allOwnKeys:a}={})=>(lo(r,(s,o)=>{n&&Rr(s)?t[o]=np(s,n):t[o]=s},{allOwnKeys:a}),t),Ff=t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),$f=(t,r,n,a)=>{t.prototype=Object.create(r.prototype,a),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:r.prototype}),n&&Object.assign(t.prototype,n)},zf=(t,r,n,a)=>{let s,o,i;const c={};if(r=r||{},t==null)return r;do{for(s=Object.getOwnPropertyNames(t),o=s.length;o-- >0;)i=s[o],(!a||a(i,t,r))&&!c[i]&&(r[i]=t[i],c[i]=!0);t=n!==!1&&zl(t)}while(t&&(!n||n(t,r))&&t!==Object.prototype);return r},Bf=(t,r,n)=>{t=String(t),(n===void 0||n>t.length)&&(n=t.length),n-=r.length;const a=t.indexOf(r,n);return a!==-1&&a===n},Hf=t=>{if(!t)return null;if(Ws(t))return t;let r=t.length;if(!op(r))return null;const n=new Array(r);for(;r-- >0;)n[r]=t[r];return n},Yf=(t=>r=>t&&r instanceof t)(typeof Uint8Array<"u"&&zl(Uint8Array)),Vf=(t,r)=>{const a=(t&&t[hi]).call(t);let s;for(;(s=a.next())&&!s.done;){const o=s.value;r.call(t,o[0],o[1])}},Gf=(t,r)=>{let n;const a=[];for(;(n=t.exec(r))!==null;)a.push(n);return a},Qf=Xr("HTMLFormElement"),Kf=t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(n,a,s){return a.toUpperCase()+s}),fc=(({hasOwnProperty:t})=>(r,n)=>t.call(r,n))(Object.prototype),Jf=Xr("RegExp"),cp=(t,r)=>{const n=Object.getOwnPropertyDescriptors(t),a={};lo(n,(s,o)=>{let i;(i=r(s,o,t))!==!1&&(a[o]=i||s)}),Object.defineProperties(t,a)},Xf=t=>{cp(t,(r,n)=>{if(Rr(t)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const a=t[n];if(Rr(a)){if(r.enumerable=!1,"writable"in r){r.writable=!1;return}r.set||(r.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")})}})},Zf=(t,r)=>{const n={},a=s=>{s.forEach(o=>{n[o]=!0})};return Ws(t)?a(t):a(String(t).split(r)),n},ex=()=>{},tx=(t,r)=>t!=null&&Number.isFinite(t=+t)?t:r;function rx(t){return!!(t&&Rr(t.append)&&t[sp]==="FormData"&&t[hi])}const nx=t=>{const r=new Array(10),n=(a,s)=>{if(xi(a)){if(r.indexOf(a)>=0)return;if(!("toJSON"in a)){r[s]=a;const o=Ws(a)?[]:{};return lo(a,(i,c)=>{const u=n(i,s+1);!so(u)&&(o[c]=u)}),r[s]=void 0,o}}return a};return n(t,0)},sx=Xr("AsyncFunction"),ax=t=>t&&(xi(t)||Rr(t))&&Rr(t.then)&&Rr(t.catch),dp=((t,r)=>t?setImmediate:r?((n,a)=>(Kn.addEventListener("message",({source:s,data:o})=>{s===Kn&&o===n&&a.length&&a.shift()()},!1),s=>{a.push(s),Kn.postMessage(n,"*")}))(`axios@${Math.random()}`,[]):n=>setTimeout(n))(typeof setImmediate=="function",Rr(Kn.postMessage)),ox=typeof queueMicrotask<"u"?queueMicrotask.bind(Kn):typeof process<"u"&&process.nextTick||dp,ix=t=>t!=null&&Rr(t[hi]),Se={isArray:Ws,isArrayBuffer:ap,isBuffer:Sf,isFormData:Af,isArrayBufferView:Cf,isString:kf,isNumber:op,isBoolean:Pf,isObject:xi,isPlainObject:To,isReadableStream:Rf,isRequest:Nf,isResponse:Lf,isHeaders:qf,isUndefined:so,isDate:Df,isFile:Ef,isBlob:If,isRegExp:Jf,isFunction:Rr,isStream:Of,isURLSearchParams:Mf,isTypedArray:Yf,isFileList:Tf,forEach:lo,merge:pl,extend:Wf,trim:Uf,stripBOM:Ff,inherits:$f,toFlatObject:zf,kindOf:mi,kindOfTest:Xr,endsWith:Bf,toArray:Hf,forEachEntry:Vf,matchAll:Gf,isHTMLForm:Qf,hasOwnProperty:fc,hasOwnProp:fc,reduceDescriptors:cp,freezeMethods:Xf,toObjectSet:Zf,toCamelCase:Kf,noop:ex,toFiniteNumber:tx,findKey:ip,global:Kn,isContextDefined:lp,isSpecCompliantForm:rx,toJSONObject:nx,isAsyncFn:sx,isThenable:ax,setImmediate:dp,asap:ox,isIterable:ix};function wt(t,r,n,a,s){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",r&&(this.code=r),n&&(this.config=n),a&&(this.request=a),s&&(this.response=s,this.status=s.status?s.status:null)}Se.inherits(wt,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:Se.toJSONObject(this.config),code:this.code,status:this.status}}});const up=wt.prototype,pp={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{pp[t]={value:t}});Object.defineProperties(wt,pp);Object.defineProperty(up,"isAxiosError",{value:!0});wt.from=(t,r,n,a,s,o)=>{const i=Object.create(up);return Se.toFlatObject(t,i,function(u){return u!==Error.prototype},c=>c!=="isAxiosError"),wt.call(i,t.message,r,n,a,s),i.cause=t,i.name=t.name,o&&Object.assign(i,o),i};const lx=null;function hl(t){return Se.isPlainObject(t)||Se.isArray(t)}function hp(t){return Se.endsWith(t,"[]")?t.slice(0,-2):t}function xc(t,r,n){return t?t.concat(r).map(function(s,o){return s=hp(s),!n&&o?"["+s+"]":s}).join(n?".":""):r}function cx(t){return Se.isArray(t)&&!t.some(hl)}const dx=Se.toFlatObject(Se,{},null,function(r){return/^is[A-Z]/.test(r)});function gi(t,r,n){if(!Se.isObject(t))throw new TypeError("target must be an object");r=r||new FormData,n=Se.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(w,_){return!Se.isUndefined(_[w])});const a=n.metaTokens,s=n.visitor||p,o=n.dots,i=n.indexes,u=(n.Blob||typeof Blob<"u"&&Blob)&&Se.isSpecCompliantForm(r);if(!Se.isFunction(s))throw new TypeError("visitor must be a function");function d(v){if(v===null)return"";if(Se.isDate(v))return v.toISOString();if(Se.isBoolean(v))return v.toString();if(!u&&Se.isBlob(v))throw new wt("Blob is not supported. Use a Buffer instead.");return Se.isArrayBuffer(v)||Se.isTypedArray(v)?u&&typeof Blob=="function"?new Blob([v]):Buffer.from(v):v}function p(v,w,_){let P=v;if(v&&!_&&typeof v=="object"){if(Se.endsWith(w,"{}"))w=a?w:w.slice(0,-2),v=JSON.stringify(v);else if(Se.isArray(v)&&cx(v)||(Se.isFileList(v)||Se.endsWith(w,"[]"))&&(P=Se.toArray(v)))return w=hp(w),P.forEach(function(C,D){!(Se.isUndefined(C)||C===null)&&r.append(i===!0?xc([w],D,o):i===null?w:w+"[]",d(C))}),!1}return hl(v)?!0:(r.append(xc(_,w,o),d(v)),!1)}const f=[],m=Object.assign(dx,{defaultVisitor:p,convertValue:d,isVisitable:hl});function j(v,w){if(!Se.isUndefined(v)){if(f.indexOf(v)!==-1)throw Error("Circular reference detected in "+w.join("."));f.push(v),Se.forEach(v,function(P,L){(!(Se.isUndefined(P)||P===null)&&s.call(r,P,Se.isString(L)?L.trim():L,w,m))===!0&&j(P,w?w.concat(L):[L])}),f.pop()}}if(!Se.isObject(t))throw new TypeError("data must be an object");return j(t),r}function gc(t){const r={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(a){return r[a]})}function Bl(t,r){this._pairs=[],t&&gi(t,this,r)}const mp=Bl.prototype;mp.append=function(r,n){this._pairs.push([r,n])};mp.toString=function(r){const n=r?function(a){return r.call(this,a,gc)}:gc;return this._pairs.map(function(s){return n(s[0])+"="+n(s[1])},"").join("&")};function ux(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function fp(t,r,n){if(!r)return t;const a=n&&n.encode||ux;Se.isFunction(n)&&(n={serialize:n});const s=n&&n.serialize;let o;if(s?o=s(r,n):o=Se.isURLSearchParams(r)?r.toString():new Bl(r,n).toString(a),o){const i=t.indexOf("#");i!==-1&&(t=t.slice(0,i)),t+=(t.indexOf("?")===-1?"?":"&")+o}return t}class yc{constructor(){this.handlers=[]}use(r,n,a){return this.handlers.push({fulfilled:r,rejected:n,synchronous:a?a.synchronous:!1,runWhen:a?a.runWhen:null}),this.handlers.length-1}eject(r){this.handlers[r]&&(this.handlers[r]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(r){Se.forEach(this.handlers,function(a){a!==null&&r(a)})}}const xp={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},px=typeof URLSearchParams<"u"?URLSearchParams:Bl,hx=typeof FormData<"u"?FormData:null,mx=typeof Blob<"u"?Blob:null,fx={isBrowser:!0,classes:{URLSearchParams:px,FormData:hx,Blob:mx},protocols:["http","https","file","blob","url","data"]},Hl=typeof window<"u"&&typeof document<"u",ml=typeof navigator=="object"&&navigator||void 0,xx=Hl&&(!ml||["ReactNative","NativeScript","NS"].indexOf(ml.product)<0),gx=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",yx=Hl&&window.location.href||"http://localhost",vx=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:Hl,hasStandardBrowserEnv:xx,hasStandardBrowserWebWorkerEnv:gx,navigator:ml,origin:yx},Symbol.toStringTag,{value:"Module"})),_r={...vx,...fx};function bx(t,r){return gi(t,new _r.classes.URLSearchParams,Object.assign({visitor:function(n,a,s,o){return _r.isNode&&Se.isBuffer(n)?(this.append(a,n.toString("base64")),!1):o.defaultVisitor.apply(this,arguments)}},r))}function _x(t){return Se.matchAll(/\w+|\[(\w*)]/g,t).map(r=>r[0]==="[]"?"":r[1]||r[0])}function jx(t){const r={},n=Object.keys(t);let a;const s=n.length;let o;for(a=0;a<s;a++)o=n[a],r[o]=t[o];return r}function gp(t){function r(n,a,s,o){let i=n[o++];if(i==="__proto__")return!0;const c=Number.isFinite(+i),u=o>=n.length;return i=!i&&Se.isArray(s)?s.length:i,u?(Se.hasOwnProp(s,i)?s[i]=[s[i],a]:s[i]=a,!c):((!s[i]||!Se.isObject(s[i]))&&(s[i]=[]),r(n,a,s[i],o)&&Se.isArray(s[i])&&(s[i]=jx(s[i])),!c)}if(Se.isFormData(t)&&Se.isFunction(t.entries)){const n={};return Se.forEachEntry(t,(a,s)=>{r(_x(a),s,n,0)}),n}return null}function wx(t,r,n){if(Se.isString(t))try{return(r||JSON.parse)(t),Se.trim(t)}catch(a){if(a.name!=="SyntaxError")throw a}return(n||JSON.stringify)(t)}const co={transitional:xp,adapter:["xhr","http","fetch"],transformRequest:[function(r,n){const a=n.getContentType()||"",s=a.indexOf("application/json")>-1,o=Se.isObject(r);if(o&&Se.isHTMLForm(r)&&(r=new FormData(r)),Se.isFormData(r))return s?JSON.stringify(gp(r)):r;if(Se.isArrayBuffer(r)||Se.isBuffer(r)||Se.isStream(r)||Se.isFile(r)||Se.isBlob(r)||Se.isReadableStream(r))return r;if(Se.isArrayBufferView(r))return r.buffer;if(Se.isURLSearchParams(r))return n.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),r.toString();let c;if(o){if(a.indexOf("application/x-www-form-urlencoded")>-1)return bx(r,this.formSerializer).toString();if((c=Se.isFileList(r))||a.indexOf("multipart/form-data")>-1){const u=this.env&&this.env.FormData;return gi(c?{"files[]":r}:r,u&&new u,this.formSerializer)}}return o||s?(n.setContentType("application/json",!1),wx(r)):r}],transformResponse:[function(r){const n=this.transitional||co.transitional,a=n&&n.forcedJSONParsing,s=this.responseType==="json";if(Se.isResponse(r)||Se.isReadableStream(r))return r;if(r&&Se.isString(r)&&(a&&!this.responseType||s)){const i=!(n&&n.silentJSONParsing)&&s;try{return JSON.parse(r)}catch(c){if(i)throw c.name==="SyntaxError"?wt.from(c,wt.ERR_BAD_RESPONSE,this,null,this.response):c}}return r}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:_r.classes.FormData,Blob:_r.classes.Blob},validateStatus:function(r){return r>=200&&r<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};Se.forEach(["delete","get","head","post","put","patch"],t=>{co.headers[t]={}});const Sx=Se.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),Cx=t=>{const r={};let n,a,s;return t&&t.split(`
`).forEach(function(i){s=i.indexOf(":"),n=i.substring(0,s).trim().toLowerCase(),a=i.substring(s+1).trim(),!(!n||r[n]&&Sx[n])&&(n==="set-cookie"?r[n]?r[n].push(a):r[n]=[a]:r[n]=r[n]?r[n]+", "+a:a)}),r},vc=Symbol("internals");function Gs(t){return t&&String(t).trim().toLowerCase()}function Oo(t){return t===!1||t==null?t:Se.isArray(t)?t.map(Oo):String(t)}function kx(t){const r=Object.create(null),n=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let a;for(;a=n.exec(t);)r[a[1]]=a[2];return r}const Px=t=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(t.trim());function Ui(t,r,n,a,s){if(Se.isFunction(a))return a.call(this,r,n);if(s&&(r=n),!!Se.isString(r)){if(Se.isString(a))return r.indexOf(a)!==-1;if(Se.isRegExp(a))return a.test(r)}}function Dx(t){return t.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(r,n,a)=>n.toUpperCase()+a)}function Ex(t,r){const n=Se.toCamelCase(" "+r);["get","set","has"].forEach(a=>{Object.defineProperty(t,a+n,{value:function(s,o,i){return this[a].call(this,r,s,o,i)},configurable:!0})})}let Nr=class{constructor(r){r&&this.set(r)}set(r,n,a){const s=this;function o(c,u,d){const p=Gs(u);if(!p)throw new Error("header name must be a non-empty string");const f=Se.findKey(s,p);(!f||s[f]===void 0||d===!0||d===void 0&&s[f]!==!1)&&(s[f||u]=Oo(c))}const i=(c,u)=>Se.forEach(c,(d,p)=>o(d,p,u));if(Se.isPlainObject(r)||r instanceof this.constructor)i(r,n);else if(Se.isString(r)&&(r=r.trim())&&!Px(r))i(Cx(r),n);else if(Se.isObject(r)&&Se.isIterable(r)){let c={},u,d;for(const p of r){if(!Se.isArray(p))throw TypeError("Object iterator must return a key-value pair");c[d=p[0]]=(u=c[d])?Se.isArray(u)?[...u,p[1]]:[u,p[1]]:p[1]}i(c,n)}else r!=null&&o(n,r,a);return this}get(r,n){if(r=Gs(r),r){const a=Se.findKey(this,r);if(a){const s=this[a];if(!n)return s;if(n===!0)return kx(s);if(Se.isFunction(n))return n.call(this,s,a);if(Se.isRegExp(n))return n.exec(s);throw new TypeError("parser must be boolean|regexp|function")}}}has(r,n){if(r=Gs(r),r){const a=Se.findKey(this,r);return!!(a&&this[a]!==void 0&&(!n||Ui(this,this[a],a,n)))}return!1}delete(r,n){const a=this;let s=!1;function o(i){if(i=Gs(i),i){const c=Se.findKey(a,i);c&&(!n||Ui(a,a[c],c,n))&&(delete a[c],s=!0)}}return Se.isArray(r)?r.forEach(o):o(r),s}clear(r){const n=Object.keys(this);let a=n.length,s=!1;for(;a--;){const o=n[a];(!r||Ui(this,this[o],o,r,!0))&&(delete this[o],s=!0)}return s}normalize(r){const n=this,a={};return Se.forEach(this,(s,o)=>{const i=Se.findKey(a,o);if(i){n[i]=Oo(s),delete n[o];return}const c=r?Dx(o):String(o).trim();c!==o&&delete n[o],n[c]=Oo(s),a[c]=!0}),this}concat(...r){return this.constructor.concat(this,...r)}toJSON(r){const n=Object.create(null);return Se.forEach(this,(a,s)=>{a!=null&&a!==!1&&(n[s]=r&&Se.isArray(a)?a.join(", "):a)}),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([r,n])=>r+": "+n).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(r){return r instanceof this?r:new this(r)}static concat(r,...n){const a=new this(r);return n.forEach(s=>a.set(s)),a}static accessor(r){const a=(this[vc]=this[vc]={accessors:{}}).accessors,s=this.prototype;function o(i){const c=Gs(i);a[c]||(Ex(s,i),a[c]=!0)}return Se.isArray(r)?r.forEach(o):o(r),this}};Nr.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);Se.reduceDescriptors(Nr.prototype,({value:t},r)=>{let n=r[0].toUpperCase()+r.slice(1);return{get:()=>t,set(a){this[n]=a}}});Se.freezeMethods(Nr);function Wi(t,r){const n=this||co,a=r||n,s=Nr.from(a.headers);let o=a.data;return Se.forEach(t,function(c){o=c.call(n,o,s.normalize(),r?r.status:void 0)}),s.normalize(),o}function yp(t){return!!(t&&t.__CANCEL__)}function Fs(t,r,n){wt.call(this,t??"canceled",wt.ERR_CANCELED,r,n),this.name="CanceledError"}Se.inherits(Fs,wt,{__CANCEL__:!0});function vp(t,r,n){const a=n.config.validateStatus;!n.status||!a||a(n.status)?t(n):r(new wt("Request failed with status code "+n.status,[wt.ERR_BAD_REQUEST,wt.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n))}function Ix(t){const r=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return r&&r[1]||""}function Tx(t,r){t=t||10;const n=new Array(t),a=new Array(t);let s=0,o=0,i;return r=r!==void 0?r:1e3,function(u){const d=Date.now(),p=a[o];i||(i=d),n[s]=u,a[s]=d;let f=o,m=0;for(;f!==s;)m+=n[f++],f=f%t;if(s=(s+1)%t,s===o&&(o=(o+1)%t),d-i<r)return;const j=p&&d-p;return j?Math.round(m*1e3/j):void 0}}function Ox(t,r){let n=0,a=1e3/r,s,o;const i=(d,p=Date.now())=>{n=p,s=null,o&&(clearTimeout(o),o=null),t.apply(null,d)};return[(...d)=>{const p=Date.now(),f=p-n;f>=a?i(d,p):(s=d,o||(o=setTimeout(()=>{o=null,i(s)},a-f)))},()=>s&&i(s)]}const Jo=(t,r,n=3)=>{let a=0;const s=Tx(50,250);return Ox(o=>{const i=o.loaded,c=o.lengthComputable?o.total:void 0,u=i-a,d=s(u),p=i<=c;a=i;const f={loaded:i,total:c,progress:c?i/c:void 0,bytes:u,rate:d||void 0,estimated:d&&c&&p?(c-i)/d:void 0,event:o,lengthComputable:c!=null,[r?"download":"upload"]:!0};t(f)},n)},bc=(t,r)=>{const n=t!=null;return[a=>r[0]({lengthComputable:n,total:t,loaded:a}),r[1]]},_c=t=>(...r)=>Se.asap(()=>t(...r)),Ax=_r.hasStandardBrowserEnv?((t,r)=>n=>(n=new URL(n,_r.origin),t.protocol===n.protocol&&t.host===n.host&&(r||t.port===n.port)))(new URL(_r.origin),_r.navigator&&/(msie|trident)/i.test(_r.navigator.userAgent)):()=>!0,Mx=_r.hasStandardBrowserEnv?{write(t,r,n,a,s,o){const i=[t+"="+encodeURIComponent(r)];Se.isNumber(n)&&i.push("expires="+new Date(n).toGMTString()),Se.isString(a)&&i.push("path="+a),Se.isString(s)&&i.push("domain="+s),o===!0&&i.push("secure"),document.cookie=i.join("; ")},read(t){const r=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return r?decodeURIComponent(r[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function Rx(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)}function Nx(t,r){return r?t.replace(/\/?\/$/,"")+"/"+r.replace(/^\/+/,""):t}function bp(t,r,n){let a=!Rx(r);return t&&(a||n==!1)?Nx(t,r):r}const jc=t=>t instanceof Nr?{...t}:t;function es(t,r){r=r||{};const n={};function a(d,p,f,m){return Se.isPlainObject(d)&&Se.isPlainObject(p)?Se.merge.call({caseless:m},d,p):Se.isPlainObject(p)?Se.merge({},p):Se.isArray(p)?p.slice():p}function s(d,p,f,m){if(Se.isUndefined(p)){if(!Se.isUndefined(d))return a(void 0,d,f,m)}else return a(d,p,f,m)}function o(d,p){if(!Se.isUndefined(p))return a(void 0,p)}function i(d,p){if(Se.isUndefined(p)){if(!Se.isUndefined(d))return a(void 0,d)}else return a(void 0,p)}function c(d,p,f){if(f in r)return a(d,p);if(f in t)return a(void 0,d)}const u={url:o,method:o,data:o,baseURL:i,transformRequest:i,transformResponse:i,paramsSerializer:i,timeout:i,timeoutMessage:i,withCredentials:i,withXSRFToken:i,adapter:i,responseType:i,xsrfCookieName:i,xsrfHeaderName:i,onUploadProgress:i,onDownloadProgress:i,decompress:i,maxContentLength:i,maxBodyLength:i,beforeRedirect:i,transport:i,httpAgent:i,httpsAgent:i,cancelToken:i,socketPath:i,responseEncoding:i,validateStatus:c,headers:(d,p,f)=>s(jc(d),jc(p),f,!0)};return Se.forEach(Object.keys(Object.assign({},t,r)),function(p){const f=u[p]||s,m=f(t[p],r[p],p);Se.isUndefined(m)&&f!==c||(n[p]=m)}),n}const _p=t=>{const r=es({},t);let{data:n,withXSRFToken:a,xsrfHeaderName:s,xsrfCookieName:o,headers:i,auth:c}=r;r.headers=i=Nr.from(i),r.url=fp(bp(r.baseURL,r.url,r.allowAbsoluteUrls),t.params,t.paramsSerializer),c&&i.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):"")));let u;if(Se.isFormData(n)){if(_r.hasStandardBrowserEnv||_r.hasStandardBrowserWebWorkerEnv)i.setContentType(void 0);else if((u=i.getContentType())!==!1){const[d,...p]=u?u.split(";").map(f=>f.trim()).filter(Boolean):[];i.setContentType([d||"multipart/form-data",...p].join("; "))}}if(_r.hasStandardBrowserEnv&&(a&&Se.isFunction(a)&&(a=a(r)),a||a!==!1&&Ax(r.url))){const d=s&&o&&Mx.read(o);d&&i.set(s,d)}return r},Lx=typeof XMLHttpRequest<"u",qx=Lx&&function(t){return new Promise(function(n,a){const s=_p(t);let o=s.data;const i=Nr.from(s.headers).normalize();let{responseType:c,onUploadProgress:u,onDownloadProgress:d}=s,p,f,m,j,v;function w(){j&&j(),v&&v(),s.cancelToken&&s.cancelToken.unsubscribe(p),s.signal&&s.signal.removeEventListener("abort",p)}let _=new XMLHttpRequest;_.open(s.method.toUpperCase(),s.url,!0),_.timeout=s.timeout;function P(){if(!_)return;const C=Nr.from("getAllResponseHeaders"in _&&_.getAllResponseHeaders()),A={data:!c||c==="text"||c==="json"?_.responseText:_.response,status:_.status,statusText:_.statusText,headers:C,config:t,request:_};vp(function(N){n(N),w()},function(N){a(N),w()},A),_=null}"onloadend"in _?_.onloadend=P:_.onreadystatechange=function(){!_||_.readyState!==4||_.status===0&&!(_.responseURL&&_.responseURL.indexOf("file:")===0)||setTimeout(P)},_.onabort=function(){_&&(a(new wt("Request aborted",wt.ECONNABORTED,t,_)),_=null)},_.onerror=function(){a(new wt("Network Error",wt.ERR_NETWORK,t,_)),_=null},_.ontimeout=function(){let D=s.timeout?"timeout of "+s.timeout+"ms exceeded":"timeout exceeded";const A=s.transitional||xp;s.timeoutErrorMessage&&(D=s.timeoutErrorMessage),a(new wt(D,A.clarifyTimeoutError?wt.ETIMEDOUT:wt.ECONNABORTED,t,_)),_=null},o===void 0&&i.setContentType(null),"setRequestHeader"in _&&Se.forEach(i.toJSON(),function(D,A){_.setRequestHeader(A,D)}),Se.isUndefined(s.withCredentials)||(_.withCredentials=!!s.withCredentials),c&&c!=="json"&&(_.responseType=s.responseType),d&&([m,v]=Jo(d,!0),_.addEventListener("progress",m)),u&&_.upload&&([f,j]=Jo(u),_.upload.addEventListener("progress",f),_.upload.addEventListener("loadend",j)),(s.cancelToken||s.signal)&&(p=C=>{_&&(a(!C||C.type?new Fs(null,t,_):C),_.abort(),_=null)},s.cancelToken&&s.cancelToken.subscribe(p),s.signal&&(s.signal.aborted?p():s.signal.addEventListener("abort",p)));const L=Ix(s.url);if(L&&_r.protocols.indexOf(L)===-1){a(new wt("Unsupported protocol "+L+":",wt.ERR_BAD_REQUEST,t));return}_.send(o||null)})},Ux=(t,r)=>{const{length:n}=t=t?t.filter(Boolean):[];if(r||n){let a=new AbortController,s;const o=function(d){if(!s){s=!0,c();const p=d instanceof Error?d:this.reason;a.abort(p instanceof wt?p:new Fs(p instanceof Error?p.message:p))}};let i=r&&setTimeout(()=>{i=null,o(new wt(`timeout ${r} of ms exceeded`,wt.ETIMEDOUT))},r);const c=()=>{t&&(i&&clearTimeout(i),i=null,t.forEach(d=>{d.unsubscribe?d.unsubscribe(o):d.removeEventListener("abort",o)}),t=null)};t.forEach(d=>d.addEventListener("abort",o));const{signal:u}=a;return u.unsubscribe=()=>Se.asap(c),u}},Wx=function*(t,r){let n=t.byteLength;if(n<r){yield t;return}let a=0,s;for(;a<n;)s=a+r,yield t.slice(a,s),a=s},Fx=async function*(t,r){for await(const n of $x(t))yield*Wx(n,r)},$x=async function*(t){if(t[Symbol.asyncIterator]){yield*t;return}const r=t.getReader();try{for(;;){const{done:n,value:a}=await r.read();if(n)break;yield a}}finally{await r.cancel()}},wc=(t,r,n,a)=>{const s=Fx(t,r);let o=0,i,c=u=>{i||(i=!0,a&&a(u))};return new ReadableStream({async pull(u){try{const{done:d,value:p}=await s.next();if(d){c(),u.close();return}let f=p.byteLength;if(n){let m=o+=f;n(m)}u.enqueue(new Uint8Array(p))}catch(d){throw c(d),d}},cancel(u){return c(u),s.return()}},{highWaterMark:2})},yi=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",jp=yi&&typeof ReadableStream=="function",zx=yi&&(typeof TextEncoder=="function"?(t=>r=>t.encode(r))(new TextEncoder):async t=>new Uint8Array(await new Response(t).arrayBuffer())),wp=(t,...r)=>{try{return!!t(...r)}catch{return!1}},Bx=jp&&wp(()=>{let t=!1;const r=new Request(_r.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!r}),Sc=64*1024,fl=jp&&wp(()=>Se.isReadableStream(new Response("").body)),Xo={stream:fl&&(t=>t.body)};yi&&(t=>{["text","arrayBuffer","blob","formData","stream"].forEach(r=>{!Xo[r]&&(Xo[r]=Se.isFunction(t[r])?n=>n[r]():(n,a)=>{throw new wt(`Response type '${r}' is not supported`,wt.ERR_NOT_SUPPORT,a)})})})(new Response);const Hx=async t=>{if(t==null)return 0;if(Se.isBlob(t))return t.size;if(Se.isSpecCompliantForm(t))return(await new Request(_r.origin,{method:"POST",body:t}).arrayBuffer()).byteLength;if(Se.isArrayBufferView(t)||Se.isArrayBuffer(t))return t.byteLength;if(Se.isURLSearchParams(t)&&(t=t+""),Se.isString(t))return(await zx(t)).byteLength},Yx=async(t,r)=>{const n=Se.toFiniteNumber(t.getContentLength());return n??Hx(r)},Vx=yi&&(async t=>{let{url:r,method:n,data:a,signal:s,cancelToken:o,timeout:i,onDownloadProgress:c,onUploadProgress:u,responseType:d,headers:p,withCredentials:f="same-origin",fetchOptions:m}=_p(t);d=d?(d+"").toLowerCase():"text";let j=Ux([s,o&&o.toAbortSignal()],i),v;const w=j&&j.unsubscribe&&(()=>{j.unsubscribe()});let _;try{if(u&&Bx&&n!=="get"&&n!=="head"&&(_=await Yx(p,a))!==0){let A=new Request(r,{method:"POST",body:a,duplex:"half"}),b;if(Se.isFormData(a)&&(b=A.headers.get("content-type"))&&p.setContentType(b),A.body){const[N,g]=bc(_,Jo(_c(u)));a=wc(A.body,Sc,N,g)}}Se.isString(f)||(f=f?"include":"omit");const P="credentials"in Request.prototype;v=new Request(r,{...m,signal:j,method:n.toUpperCase(),headers:p.normalize().toJSON(),body:a,duplex:"half",credentials:P?f:void 0});let L=await fetch(v,m);const C=fl&&(d==="stream"||d==="response");if(fl&&(c||C&&w)){const A={};["status","statusText","headers"].forEach(x=>{A[x]=L[x]});const b=Se.toFiniteNumber(L.headers.get("content-length")),[N,g]=c&&bc(b,Jo(_c(c),!0))||[];L=new Response(wc(L.body,Sc,N,()=>{g&&g(),w&&w()}),A)}d=d||"text";let D=await Xo[Se.findKey(Xo,d)||"text"](L,t);return!C&&w&&w(),await new Promise((A,b)=>{vp(A,b,{data:D,headers:Nr.from(L.headers),status:L.status,statusText:L.statusText,config:t,request:v})})}catch(P){throw w&&w(),P&&P.name==="TypeError"&&/Load failed|fetch/i.test(P.message)?Object.assign(new wt("Network Error",wt.ERR_NETWORK,t,v),{cause:P.cause||P}):wt.from(P,P&&P.code,t,v)}}),xl={http:lx,xhr:qx,fetch:Vx};Se.forEach(xl,(t,r)=>{if(t){try{Object.defineProperty(t,"name",{value:r})}catch{}Object.defineProperty(t,"adapterName",{value:r})}});const Cc=t=>`- ${t}`,Gx=t=>Se.isFunction(t)||t===null||t===!1,Sp={getAdapter:t=>{t=Se.isArray(t)?t:[t];const{length:r}=t;let n,a;const s={};for(let o=0;o<r;o++){n=t[o];let i;if(a=n,!Gx(n)&&(a=xl[(i=String(n)).toLowerCase()],a===void 0))throw new wt(`Unknown adapter '${i}'`);if(a)break;s[i||"#"+o]=a}if(!a){const o=Object.entries(s).map(([c,u])=>`adapter ${c} `+(u===!1?"is not supported by the environment":"is not available in the build"));let i=r?o.length>1?`since :
`+o.map(Cc).join(`
`):" "+Cc(o[0]):"as no adapter specified";throw new wt("There is no suitable adapter to dispatch the request "+i,"ERR_NOT_SUPPORT")}return a},adapters:xl};function Fi(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new Fs(null,t)}function kc(t){return Fi(t),t.headers=Nr.from(t.headers),t.data=Wi.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),Sp.getAdapter(t.adapter||co.adapter)(t).then(function(a){return Fi(t),a.data=Wi.call(t,t.transformResponse,a),a.headers=Nr.from(a.headers),a},function(a){return yp(a)||(Fi(t),a&&a.response&&(a.response.data=Wi.call(t,t.transformResponse,a.response),a.response.headers=Nr.from(a.response.headers))),Promise.reject(a)})}const Cp="1.10.0",vi={};["object","boolean","number","function","string","symbol"].forEach((t,r)=>{vi[t]=function(a){return typeof a===t||"a"+(r<1?"n ":" ")+t}});const Pc={};vi.transitional=function(r,n,a){function s(o,i){return"[Axios v"+Cp+"] Transitional option '"+o+"'"+i+(a?". "+a:"")}return(o,i,c)=>{if(r===!1)throw new wt(s(i," has been removed"+(n?" in "+n:"")),wt.ERR_DEPRECATED);return n&&!Pc[i]&&(Pc[i]=!0,console.warn(s(i," has been deprecated since v"+n+" and will be removed in the near future"))),r?r(o,i,c):!0}};vi.spelling=function(r){return(n,a)=>(console.warn(`${a} is likely a misspelling of ${r}`),!0)};function Qx(t,r,n){if(typeof t!="object")throw new wt("options must be an object",wt.ERR_BAD_OPTION_VALUE);const a=Object.keys(t);let s=a.length;for(;s-- >0;){const o=a[s],i=r[o];if(i){const c=t[o],u=c===void 0||i(c,o,t);if(u!==!0)throw new wt("option "+o+" must be "+u,wt.ERR_BAD_OPTION_VALUE);continue}if(n!==!0)throw new wt("Unknown option "+o,wt.ERR_BAD_OPTION)}}const Ao={assertOptions:Qx,validators:vi},rn=Ao.validators;let Jn=class{constructor(r){this.defaults=r||{},this.interceptors={request:new yc,response:new yc}}async request(r,n){try{return await this._request(r,n)}catch(a){if(a instanceof Error){let s={};Error.captureStackTrace?Error.captureStackTrace(s):s=new Error;const o=s.stack?s.stack.replace(/^.+\n/,""):"";try{a.stack?o&&!String(a.stack).endsWith(o.replace(/^.+\n.+\n/,""))&&(a.stack+=`
`+o):a.stack=o}catch{}}throw a}}_request(r,n){typeof r=="string"?(n=n||{},n.url=r):n=r||{},n=es(this.defaults,n);const{transitional:a,paramsSerializer:s,headers:o}=n;a!==void 0&&Ao.assertOptions(a,{silentJSONParsing:rn.transitional(rn.boolean),forcedJSONParsing:rn.transitional(rn.boolean),clarifyTimeoutError:rn.transitional(rn.boolean)},!1),s!=null&&(Se.isFunction(s)?n.paramsSerializer={serialize:s}:Ao.assertOptions(s,{encode:rn.function,serialize:rn.function},!0)),n.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?n.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:n.allowAbsoluteUrls=!0),Ao.assertOptions(n,{baseUrl:rn.spelling("baseURL"),withXsrfToken:rn.spelling("withXSRFToken")},!0),n.method=(n.method||this.defaults.method||"get").toLowerCase();let i=o&&Se.merge(o.common,o[n.method]);o&&Se.forEach(["delete","get","head","post","put","patch","common"],v=>{delete o[v]}),n.headers=Nr.concat(i,o);const c=[];let u=!0;this.interceptors.request.forEach(function(w){typeof w.runWhen=="function"&&w.runWhen(n)===!1||(u=u&&w.synchronous,c.unshift(w.fulfilled,w.rejected))});const d=[];this.interceptors.response.forEach(function(w){d.push(w.fulfilled,w.rejected)});let p,f=0,m;if(!u){const v=[kc.bind(this),void 0];for(v.unshift.apply(v,c),v.push.apply(v,d),m=v.length,p=Promise.resolve(n);f<m;)p=p.then(v[f++],v[f++]);return p}m=c.length;let j=n;for(f=0;f<m;){const v=c[f++],w=c[f++];try{j=v(j)}catch(_){w.call(this,_);break}}try{p=kc.call(this,j)}catch(v){return Promise.reject(v)}for(f=0,m=d.length;f<m;)p=p.then(d[f++],d[f++]);return p}getUri(r){r=es(this.defaults,r);const n=bp(r.baseURL,r.url,r.allowAbsoluteUrls);return fp(n,r.params,r.paramsSerializer)}};Se.forEach(["delete","get","head","options"],function(r){Jn.prototype[r]=function(n,a){return this.request(es(a||{},{method:r,url:n,data:(a||{}).data}))}});Se.forEach(["post","put","patch"],function(r){function n(a){return function(o,i,c){return this.request(es(c||{},{method:r,headers:a?{"Content-Type":"multipart/form-data"}:{},url:o,data:i}))}}Jn.prototype[r]=n(),Jn.prototype[r+"Form"]=n(!0)});let Kx=class kp{constructor(r){if(typeof r!="function")throw new TypeError("executor must be a function.");let n;this.promise=new Promise(function(o){n=o});const a=this;this.promise.then(s=>{if(!a._listeners)return;let o=a._listeners.length;for(;o-- >0;)a._listeners[o](s);a._listeners=null}),this.promise.then=s=>{let o;const i=new Promise(c=>{a.subscribe(c),o=c}).then(s);return i.cancel=function(){a.unsubscribe(o)},i},r(function(o,i,c){a.reason||(a.reason=new Fs(o,i,c),n(a.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(r){if(this.reason){r(this.reason);return}this._listeners?this._listeners.push(r):this._listeners=[r]}unsubscribe(r){if(!this._listeners)return;const n=this._listeners.indexOf(r);n!==-1&&this._listeners.splice(n,1)}toAbortSignal(){const r=new AbortController,n=a=>{r.abort(a)};return this.subscribe(n),r.signal.unsubscribe=()=>this.unsubscribe(n),r.signal}static source(){let r;return{token:new kp(function(s){r=s}),cancel:r}}};function Jx(t){return function(n){return t.apply(null,n)}}function Xx(t){return Se.isObject(t)&&t.isAxiosError===!0}const gl={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(gl).forEach(([t,r])=>{gl[r]=t});function Pp(t){const r=new Jn(t),n=np(Jn.prototype.request,r);return Se.extend(n,Jn.prototype,r,{allOwnKeys:!0}),Se.extend(n,r,null,{allOwnKeys:!0}),n.create=function(s){return Pp(es(t,s))},n}const ir=Pp(co);ir.Axios=Jn;ir.CanceledError=Fs;ir.CancelToken=Kx;ir.isCancel=yp;ir.VERSION=Cp;ir.toFormData=gi;ir.AxiosError=wt;ir.Cancel=ir.CanceledError;ir.all=function(r){return Promise.all(r)};ir.spread=Jx;ir.isAxiosError=Xx;ir.mergeConfig=es;ir.AxiosHeaders=Nr;ir.formToJSON=t=>gp(Se.isHTMLForm(t)?new FormData(t):t);ir.getAdapter=Sp.getAdapter;ir.HttpStatusCode=gl;ir.default=ir;const{Axios:L1,AxiosError:kr,CanceledError:q1,isCancel:U1,CancelToken:W1,VERSION:F1,all:$1,Cancel:z1,isAxiosError:B1,spread:H1,toFormData:Y1,AxiosHeaders:V1,HttpStatusCode:G1,formToJSON:Q1,getAdapter:K1,mergeConfig:J1}=ir,yl=typeof window<"u"&&!!window.electronAPI;function Zx(t){return t&&t.includes("localhost")&&t.startsWith("https://")?t.replace("https://","http://"):t}console.log("API baseURL:",void 0);console.log("Is Electron:",yl);const eg={cloudflare:{baseURL:"https://api.yourdomain.com"}};function Is(){return console.log("Environment variables:",{VITE_API_BASE_URL:void 0,VITE_CLOUDFLARE_URL:void 0,MODE:"production",NODE_ENV:"production",isElectron:yl}),yl&&console.log("Running in Electron - checking environment variables"),console.log("Using production config"),{baseURL:Zx(eg.cloudflare.baseURL),timeout:12e4}}const Dc=Is(),B=ir.create({baseURL:Dc.baseURL,timeout:Dc.timeout,withCredentials:!0});B.interceptors.request.use(t=>{const r=localStorage.getItem("sessionToken");r&&(t.headers.Authorization=`Bearer ${r}`);const n=localStorage.getItem("deviceId");n&&(t.headers["x-device-id"]=n);try{const a=typeof Intl<"u"?Intl.DateTimeFormat().resolvedOptions().timeZone:void 0;a&&(t.headers["x-timezone"]=a)}catch{}return t},t=>Promise.reject(t));B.interceptors.response.use(t=>{try{window.__backendUnavailableSince=void 0;const r=window.__triggerSync;typeof r=="function"&&setTimeout(()=>{try{r()}catch{}},0)}catch{}return t},async t=>{try{const n=t?.response?.status,a=!t.response&&(t.code==="ECONNABORTED"||t.message?.includes("Network Error"));(typeof n=="number"&&n>=500||a)&&(window.__backendUnavailableSince=window.__backendUnavailableSince||Date.now())}catch{}const r=t.config;if(t.response?.status===401&&!r._retry){r._retry=!0;const n=localStorage.getItem("refreshToken");if(n)try{const a=await B.post("/api/auth/refresh",{refreshToken:n}),{sessionToken:s,refreshToken:o}=a.data;return localStorage.setItem("sessionToken",s),localStorage.setItem("refreshToken",o),B.defaults.headers.common.Authorization=`Bearer ${s}`,B(r)}catch(a){return localStorage.removeItem("sessionToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),window.location.href="/login",Promise.reject(a)}else localStorage.removeItem("sessionToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),window.location.href="/login"}return Promise.reject(t)});const Dp=l.createContext(void 0),tg=({children:t})=>{const[r,n]=l.useState(null),[a,s]=l.useState(!1),[o,i]=l.useState("");l.useEffect(()=>{let j=localStorage.getItem("deviceId");j||(j=crypto.randomUUID(),localStorage.setItem("deviceId",j)),i(j)},[]),l.useEffect(()=>{const j=localStorage.getItem("sessionToken"),v=localStorage.getItem("refreshToken"),w=localStorage.getItem("user");if(j&&v&&w)try{const _=JSON.parse(w);n(_),s(!0),B.defaults.headers.common.Authorization=`Bearer ${j}`,B.defaults.headers.common["x-device-id"]=o}catch(_){console.error("Error parsing user data:",_),u()}},[o]);const c=(j,v,w)=>{localStorage.setItem("sessionToken",j),localStorage.setItem("refreshToken",v),localStorage.setItem("user",JSON.stringify(w)),n(w),s(!0)},u=()=>{localStorage.removeItem("sessionToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),n(null),s(!1)},d=async()=>{try{await B.post("/api/auth/logout-all"),u()}catch(j){console.error("Error logging out from all devices:",j),u()}},p=async()=>{try{const j=localStorage.getItem("refreshToken");if(!j)return!1;const v=await B.post("/api/auth/refresh",{refreshToken:j}),{sessionToken:w,refreshToken:_}=v.data;return localStorage.setItem("sessionToken",w),localStorage.setItem("refreshToken",_),!0}catch(j){return console.error("Error refreshing session:",j),u(),!1}},f=async()=>{try{return(await B.get("/api/auth/sessions")).data}catch(j){return console.error("Error fetching user sessions:",j),[]}},m=async j=>{try{return await B.delete(`/api/auth/sessions/${j}`),!0}catch(v){return console.error("Error deactivating session:",v),!1}};return e.jsx(Dp.Provider,{value:{user:r,isAuthenticated:a,login:c,logout:u,logoutFromAllDevices:d,refreshSession:p,getUserSessions:f,deactivateSession:m,currentDeviceId:o},children:t})},Zt=()=>{const t=l.useContext(Dp);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t},Ec=t=>({id:Number(t.id),companyId:Number(t.companyId??t.company_id),conversationType:t.conversationType??t.conversation_type,title:t.title??null,createdBy:Number(t.createdBy??t.created_by),createdAt:t.createdAt??t.created_at,updatedAt:t.updatedAt??t.updated_at,lastMessageAt:t.lastMessageAt??t.last_message_at??null,participants:Array.isArray(t.participants)?t.participants.map(r=>({id:Number(r.id),username:r.username??null,email:r.email??null,isAdmin:!!(r.isAdmin??r.is_admin??!1)})):[],lastMessage:t.lastMessage?{id:Number(t.lastMessage.id),conversationId:Number(t.lastMessage.conversationId??t.lastMessage.conversation_id??t.id),senderId:t.lastMessage.senderId!==void 0&&t.lastMessage.senderId!==null?Number(t.lastMessage.senderId):null,senderName:t.lastMessage.senderName??null,content:t.lastMessage.isDeletedForUser||t.lastMessage.is_deleted_for_user?"Message deleted":t.lastMessage.content??"",isSystem:!!t.lastMessage.isSystem,createdAt:t.lastMessage.createdAt??"",updatedAt:t.lastMessage.updatedAt??t.lastMessage.createdAt??"",isDeletedForUser:!!(t.lastMessage.isDeletedForUser??t.lastMessage.is_deleted_for_user??!1),deletedAt:t.lastMessage.deletedAt??t.lastMessage.deleted_at??null}:null}),$i=t=>({id:typeof t.id=="number"||typeof t.id=="string"?t.id:Number(t.id),conversationId:Number(t.conversationId??t.conversation_id),senderId:t.senderId!==void 0&&t.senderId!==null?Number(t.senderId):t.sender_id!==void 0&&t.sender_id!==null?Number(t.sender_id):null,senderName:t.senderName??t.sender_name??t.username??null,content:t.isDeletedForUser||t.is_deleted_for_user?"Message deleted":t.content??"",isSystem:!!(t.isSystem??t.is_system??!1),createdAt:t.createdAt??t.created_at??new Date().toISOString(),updatedAt:t.updatedAt??t.updated_at??t.createdAt??t.created_at??new Date().toISOString(),pending:t.pending,error:t.error,isDeletedForUser:!!(t.isDeletedForUser??t.is_deleted_for_user??!1),deletedAt:t.deletedAt??t.deleted_at??null}),Qs={async createConversation(t){const r=await B.post("/api/messaging/conversations",t),{conversation:n,created:a}=r.data;return{conversation:Ec(n),created:!!a}},async getConversations(){return((await B.get("/api/messaging/conversations")).data?.conversations??[]).map(n=>Ec(n))},async getMessages(t,r={}){return((await B.get(`/api/messaging/conversations/${t}/messages`,{params:r})).data?.messages??[]).map(s=>$i(s))},async postMessage(t,r){const n=await B.post(`/api/messaging/conversations/${t}/messages`,{content:r});return $i(n.data?.message??n.data)},async deleteMessage(t,r){const n=await B.delete(`/api/messaging/conversations/${t}/messages/${r}`);return $i(n.data?.message??n.data)}},Ep=l.createContext(void 0),rg=(t,r)=>{const n=t.participants??[],a=r?n.filter(i=>i.id!==r):n,s=n.map(i=>i.username||i.email||"Unknown user").join(", ");if(t.conversationType==="group"){const i=t.title?.trim(),c=`${n.length} participants`;return{displayName:i||c,otherParticipants:a,participantNames:s}}if(a.length===1){const i=a[0];return{displayName:i.username||i.email||"Direct message",otherParticipants:a,participantNames:s}}return{displayName:a.length>0?a.map(i=>i.username||i.email||"Direct message").join(", "):t.title||"Direct message",otherParticipants:a,participantNames:s}},Ic=t=>[...t].sort((r,n)=>{const a=r.lastMessageAt||r.updatedAt||r.createdAt,s=n.lastMessageAt||n.updatedAt||n.createdAt;return new Date(s).getTime()-new Date(a).getTime()}),ng=({children:t})=>{const{isAuthenticated:r,user:n}=Zt(),a=n?Number(n.id):null,[s,o]=l.useState([]),[i,c]=l.useState(!1),[u,d]=l.useState({}),[p,f]=l.useState({}),[m,j]=l.useState(null),[v,w]=l.useState({}),[_,P]=l.useState([]),L=l.useRef({});l.useEffect(()=>{L.current=u},[u]);const C=l.useMemo(()=>a?`messaging:last-read:${a}`:null,[a]);l.useEffect(()=>{if(!C){w({});return}try{const J=localStorage.getItem(C);if(J){const z=JSON.parse(J);w(z)}else w({})}catch{w({})}},[C]),l.useEffect(()=>{if(C)try{localStorage.setItem(C,JSON.stringify(v))}catch{}},[v,C]);const D=l.useCallback((J,z)=>{C&&w(Z=>{const Q=z??new Date().toISOString(),X=Z[J];return X&&new Date(X).getTime()>=new Date(Q).getTime()?Z:{...Z,[J]:Q}})},[C]),A=l.useCallback(J=>{const{displayName:z,otherParticipants:Z,participantNames:Q}=rg(J,a);return{...J,displayName:z,otherParticipants:Z,participantNames:Q}},[a]),b=l.useCallback(async(J={})=>{if(r){J.silent||c(!0);try{const z=await Qs.getConversations(),Z=Ic(z.map(A));o(Z)}catch(z){console.error("Failed to load conversations",z)}finally{J.silent||c(!1)}}},[A,r]);l.useEffect(()=>{if(!r){o([]),d({}),c(!1),f({}),j(null),P([]);return}b()},[r,b]),l.useEffect(()=>{if(!r)return;const J=setInterval(()=>{b({silent:!0}).catch(()=>{})},1e4);return()=>clearInterval(J)},[r,b]),l.useEffect(()=>{!r||s.length===0||(!m||!s.some(J=>J.id===m))&&j(s[0].id)},[m,s,r]);const N=l.useCallback(async(J,z={})=>{if(r&&!(!z.force&&L.current[J])){z.silent||f(Z=>({...Z,[J]:!0}));try{const Z=await Qs.getMessages(J);d(Q=>({...Q,[J]:Z.map(X=>({...X,pending:!1,error:!1}))}))}catch(Z){console.error("Failed to load messages",Z)}finally{z.silent||f(Z=>({...Z,[J]:!1}))}}},[r]);l.useEffect(()=>{m&&N(m).catch(()=>{})},[m,N]),l.useEffect(()=>{if(!m||!r)return;const J=setInterval(()=>{N(m,{force:!0,silent:!0}).catch(()=>{})},1e4);return()=>clearInterval(J)},[m,r,N]);const g=l.useCallback(J=>{j(J),J&&N(J).catch(()=>{})},[N]),x=l.useCallback(async(J,z)=>{if(!r||!n)throw new Error("Not authenticated");const Z=z.trim();if(!Z)throw new Error("Message cannot be empty");const Q=`temp-${Date.now()}`,X={id:Q,conversationId:J,senderId:a,senderName:n.username||n.email||null,content:Z,isSystem:!1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),pending:!0};d(I=>{const y=I[J]??[];return{...I,[J]:[...y,X]}});try{const I=await Qs.postMessage(J,Z);return d(y=>{const S=y[J]??[];return{...y,[J]:S.map(U=>U.id===Q?I:U)}}),await b(),D(J,new Date().toISOString()),I}catch(I){throw d(y=>{const S=y[J]??[];return{...y,[J]:S.map(U=>U.id===Q?{...U,pending:!1,error:!0}:U)}}),I}},[a,r,b,n]),R=l.useCallback(async(J,z)=>{if(!r)throw new Error("Not authenticated");const Z=await Qs.deleteMessage(J,z);return d(Q=>{const X=Q[J]??[];return{...Q,[J]:X.map(I=>Number(I.id)===Number(z)?{...I,...Z,id:I.id,content:"Message deleted",isDeletedForUser:!0,deletedAt:Z.deletedAt??null,pending:!1,error:!1}:I)}}),b({silent:!0}).catch(()=>{}),Z},[r,b]),O=l.useCallback(async J=>{if(!r)throw new Error("Not authenticated");const z=await Qs.createConversation(J),Z=A(z.conversation);return o(Q=>{const X=Q.filter(I=>I.id!==Z.id);return Ic([Z,...X])}),j(Z.id),z.created&&d(Q=>({...Q,[Z.id]:[]})),D(Z.id,new Date().toISOString()),{conversation:Z,created:z.created}},[A,r,D]);l.useEffect(()=>{if(!r){P([]);return}const J=s.filter(z=>{const Z=z.lastMessage;if(!Z)return!1;const Q=z.lastMessageAt||Z.updatedAt||Z.createdAt;if(!Q)return!1;const X=new Date(Q).getTime();if(!X||Number.isNaN(X))return!1;const I=v[z.id]?new Date(v[z.id]).getTime():0;if(I&&I>=X)return!1;const y=Z.senderId!==null&&Z.senderId!==void 0?Number(Z.senderId):null;return!(y!==null&&a!==null&&y===a)}).map(z=>z.id);P(J)},[s,a,r,v]),l.useEffect(()=>{if(!m)return;const J=s.find(Z=>Z.id===m);if(!J)return;const z=J.lastMessageAt||J.updatedAt||J.createdAt;z&&D(m,z)},[m,s,D]);const ee=l.useMemo(()=>({conversations:s,isLoadingConversations:i,activeConversationId:m,selectConversation:g,messagesByConversation:u,loadMessages:N,isLoadingMessages:p,sendMessage:x,createConversation:O,refreshConversations:b,deleteMessage:R,unreadConversationIds:_,unreadConversationCount:_.length,markConversationRead:D}),[s,i,m,g,u,N,p,x,O,b,R,_,D]);return e.jsx(Ep.Provider,{value:ee,children:t})},Ip=()=>{const t=l.useContext(Ep);if(!t)throw new Error("useMessaging must be used within a MessagingProvider");return t},sg=Dh({palette:{primary:{main:"#7c3aed"},secondary:{main:"#ffd600"}},typography:{h4:{fontSize:"1.5rem",fontWeight:600},h6:{fontSize:"1.2rem",fontWeight:500}}});var Mo={exports:{}},ag=Mo.exports,Tc;function og(){return Tc||(Tc=1,function(t,r){(function(n,a){t.exports=a()})(ag,function(){var n=1e3,a=6e4,s=36e5,o="millisecond",i="second",c="minute",u="hour",d="day",p="week",f="month",m="quarter",j="year",v="date",w="Invalid Date",_=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,P=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,L={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(z){var Z=["th","st","nd","rd"],Q=z%100;return"["+z+(Z[(Q-20)%10]||Z[Q]||Z[0])+"]"}},C=function(z,Z,Q){var X=String(z);return!X||X.length>=Z?z:""+Array(Z+1-X.length).join(Q)+z},D={s:C,z:function(z){var Z=-z.utcOffset(),Q=Math.abs(Z),X=Math.floor(Q/60),I=Q%60;return(Z<=0?"+":"-")+C(X,2,"0")+":"+C(I,2,"0")},m:function z(Z,Q){if(Z.date()<Q.date())return-z(Q,Z);var X=12*(Q.year()-Z.year())+(Q.month()-Z.month()),I=Z.clone().add(X,f),y=Q-I<0,S=Z.clone().add(X+(y?-1:1),f);return+(-(X+(Q-I)/(y?I-S:S-I))||0)},a:function(z){return z<0?Math.ceil(z)||0:Math.floor(z)},p:function(z){return{M:f,y:j,w:p,d,D:v,h:u,m:c,s:i,ms:o,Q:m}[z]||String(z||"").toLowerCase().replace(/s$/,"")},u:function(z){return z===void 0}},A="en",b={};b[A]=L;var N="$isDayjsObject",g=function(z){return z instanceof ee||!(!z||!z[N])},x=function z(Z,Q,X){var I;if(!Z)return A;if(typeof Z=="string"){var y=Z.toLowerCase();b[y]&&(I=y),Q&&(b[y]=Q,I=y);var S=Z.split("-");if(!I&&S.length>1)return z(S[0])}else{var U=Z.name;b[U]=Z,I=U}return!X&&I&&(A=I),I||!X&&A},R=function(z,Z){if(g(z))return z.clone();var Q=typeof Z=="object"?Z:{};return Q.date=z,Q.args=arguments,new ee(Q)},O=D;O.l=x,O.i=g,O.w=function(z,Z){return R(z,{locale:Z.$L,utc:Z.$u,x:Z.$x,$offset:Z.$offset})};var ee=function(){function z(Q){this.$L=x(Q.locale,null,!0),this.parse(Q),this.$x=this.$x||Q.x||{},this[N]=!0}var Z=z.prototype;return Z.parse=function(Q){this.$d=function(X){var I=X.date,y=X.utc;if(I===null)return new Date(NaN);if(O.u(I))return new Date;if(I instanceof Date)return new Date(I);if(typeof I=="string"&&!/Z$/i.test(I)){var S=I.match(_);if(S){var U=S[2]-1||0,K=(S[7]||"0").substring(0,3);return y?new Date(Date.UTC(S[1],U,S[3]||1,S[4]||0,S[5]||0,S[6]||0,K)):new Date(S[1],U,S[3]||1,S[4]||0,S[5]||0,S[6]||0,K)}}return new Date(I)}(Q),this.init()},Z.init=function(){var Q=this.$d;this.$y=Q.getFullYear(),this.$M=Q.getMonth(),this.$D=Q.getDate(),this.$W=Q.getDay(),this.$H=Q.getHours(),this.$m=Q.getMinutes(),this.$s=Q.getSeconds(),this.$ms=Q.getMilliseconds()},Z.$utils=function(){return O},Z.isValid=function(){return this.$d.toString()!==w},Z.isSame=function(Q,X){var I=R(Q);return this.startOf(X)<=I&&I<=this.endOf(X)},Z.isAfter=function(Q,X){return R(Q)<this.startOf(X)},Z.isBefore=function(Q,X){return this.endOf(X)<R(Q)},Z.$g=function(Q,X,I){return O.u(Q)?this[X]:this.set(I,Q)},Z.unix=function(){return Math.floor(this.valueOf()/1e3)},Z.valueOf=function(){return this.$d.getTime()},Z.startOf=function(Q,X){var I=this,y=!!O.u(X)||X,S=O.p(Q),U=function(xe,me){var he=O.w(I.$u?Date.UTC(I.$y,me,xe):new Date(I.$y,me,xe),I);return y?he:he.endOf(d)},K=function(xe,me){return O.w(I.toDate()[xe].apply(I.toDate("s"),(y?[0,0,0,0]:[23,59,59,999]).slice(me)),I)},E=this.$W,V=this.$M,q=this.$D,ue="set"+(this.$u?"UTC":"");switch(S){case j:return y?U(1,0):U(31,11);case f:return y?U(1,V):U(0,V+1);case p:var ye=this.$locale().weekStart||0,ge=(E<ye?E+7:E)-ye;return U(y?q-ge:q+(6-ge),V);case d:case v:return K(ue+"Hours",0);case u:return K(ue+"Minutes",1);case c:return K(ue+"Seconds",2);case i:return K(ue+"Milliseconds",3);default:return this.clone()}},Z.endOf=function(Q){return this.startOf(Q,!1)},Z.$set=function(Q,X){var I,y=O.p(Q),S="set"+(this.$u?"UTC":""),U=(I={},I[d]=S+"Date",I[v]=S+"Date",I[f]=S+"Month",I[j]=S+"FullYear",I[u]=S+"Hours",I[c]=S+"Minutes",I[i]=S+"Seconds",I[o]=S+"Milliseconds",I)[y],K=y===d?this.$D+(X-this.$W):X;if(y===f||y===j){var E=this.clone().set(v,1);E.$d[U](K),E.init(),this.$d=E.set(v,Math.min(this.$D,E.daysInMonth())).$d}else U&&this.$d[U](K);return this.init(),this},Z.set=function(Q,X){return this.clone().$set(Q,X)},Z.get=function(Q){return this[O.p(Q)]()},Z.add=function(Q,X){var I,y=this;Q=Number(Q);var S=O.p(X),U=function(V){var q=R(y);return O.w(q.date(q.date()+Math.round(V*Q)),y)};if(S===f)return this.set(f,this.$M+Q);if(S===j)return this.set(j,this.$y+Q);if(S===d)return U(1);if(S===p)return U(7);var K=(I={},I[c]=a,I[u]=s,I[i]=n,I)[S]||1,E=this.$d.getTime()+Q*K;return O.w(E,this)},Z.subtract=function(Q,X){return this.add(-1*Q,X)},Z.format=function(Q){var X=this,I=this.$locale();if(!this.isValid())return I.invalidDate||w;var y=Q||"YYYY-MM-DDTHH:mm:ssZ",S=O.z(this),U=this.$H,K=this.$m,E=this.$M,V=I.weekdays,q=I.months,ue=I.meridiem,ye=function(me,he,ae,T){return me&&(me[he]||me(X,y))||ae[he].slice(0,T)},ge=function(me){return O.s(U%12||12,me,"0")},xe=ue||function(me,he,ae){var T=me<12?"AM":"PM";return ae?T.toLowerCase():T};return y.replace(P,function(me,he){return he||function(ae){switch(ae){case"YY":return String(X.$y).slice(-2);case"YYYY":return O.s(X.$y,4,"0");case"M":return E+1;case"MM":return O.s(E+1,2,"0");case"MMM":return ye(I.monthsShort,E,q,3);case"MMMM":return ye(q,E);case"D":return X.$D;case"DD":return O.s(X.$D,2,"0");case"d":return String(X.$W);case"dd":return ye(I.weekdaysMin,X.$W,V,2);case"ddd":return ye(I.weekdaysShort,X.$W,V,3);case"dddd":return V[X.$W];case"H":return String(U);case"HH":return O.s(U,2,"0");case"h":return ge(1);case"hh":return ge(2);case"a":return xe(U,K,!0);case"A":return xe(U,K,!1);case"m":return String(K);case"mm":return O.s(K,2,"0");case"s":return String(X.$s);case"ss":return O.s(X.$s,2,"0");case"SSS":return O.s(X.$ms,3,"0");case"Z":return S}return null}(me)||S.replace(":","")})},Z.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},Z.diff=function(Q,X,I){var y,S=this,U=O.p(X),K=R(Q),E=(K.utcOffset()-this.utcOffset())*a,V=this-K,q=function(){return O.m(S,K)};switch(U){case j:y=q()/12;break;case f:y=q();break;case m:y=q()/3;break;case p:y=(V-E)/6048e5;break;case d:y=(V-E)/864e5;break;case u:y=V/s;break;case c:y=V/a;break;case i:y=V/n;break;default:y=V}return I?y:O.a(y)},Z.daysInMonth=function(){return this.endOf(f).$D},Z.$locale=function(){return b[this.$L]},Z.locale=function(Q,X){if(!Q)return this.$L;var I=this.clone(),y=x(Q,X,!0);return y&&(I.$L=y),I},Z.clone=function(){return O.w(this.$d,this)},Z.toDate=function(){return new Date(this.valueOf())},Z.toJSON=function(){return this.isValid()?this.toISOString():null},Z.toISOString=function(){return this.$d.toISOString()},Z.toString=function(){return this.$d.toUTCString()},z}(),J=ee.prototype;return R.prototype=J,[["$ms",o],["$s",i],["$m",c],["$H",u],["$W",d],["$M",f],["$y",j],["$D",v]].forEach(function(z){J[z[1]]=function(Z){return this.$g(Z,z[0],z[1])}}),R.extend=function(z,Z){return z.$i||(z(Z,ee,R),z.$i=!0),R},R.locale=x,R.isDayjs=g,R.unix=function(z){return R(1e3*z)},R.en=b[A],R.Ls=b,R.p={},R})}(Mo)),Mo.exports}var ig=og();const $e=st(ig);var Ro={exports:{}},lg=Ro.exports,Oc;function cg(){return Oc||(Oc=1,function(t,r){(function(n,a){t.exports=a()})(lg,function(){var n="week",a="year";return function(s,o,i){var c=o.prototype;c.week=function(u){if(u===void 0&&(u=null),u!==null)return this.add(7*(u-this.week()),"day");var d=this.$locale().yearStart||1;if(this.month()===11&&this.date()>25){var p=i(this).startOf(a).add(1,a).date(d),f=i(this).endOf(n);if(p.isBefore(f))return 1}var m=i(this).startOf(a).date(d).startOf(n).subtract(1,"millisecond"),j=this.diff(m,n,!0);return j<0?i(this).startOf("week").week():Math.ceil(j)},c.weeks=function(u){return u===void 0&&(u=null),this.week(u)}}})}(Ro)),Ro.exports}var dg=cg();const ug=st(dg);var No={exports:{}},pg=No.exports,Ac;function hg(){return Ac||(Ac=1,function(t,r){(function(n,a){t.exports=a()})(pg,function(){var n={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},a=/(\[[^[]*\])|([-_:/.,()\s]+)|(A|a|Q|YYYY|YY?|ww?|MM?M?M?|Do|DD?|hh?|HH?|mm?|ss?|S{1,3}|z|ZZ?)/g,s=/\d/,o=/\d\d/,i=/\d\d?/,c=/\d*[^-_:/,()\s\d]+/,u={},d=function(_){return(_=+_)+(_>68?1900:2e3)},p=function(_){return function(P){this[_]=+P}},f=[/[+-]\d\d:?(\d\d)?|Z/,function(_){(this.zone||(this.zone={})).offset=function(P){if(!P||P==="Z")return 0;var L=P.match(/([+-]|\d\d)/g),C=60*L[1]+(+L[2]||0);return C===0?0:L[0]==="+"?-C:C}(_)}],m=function(_){var P=u[_];return P&&(P.indexOf?P:P.s.concat(P.f))},j=function(_,P){var L,C=u.meridiem;if(C){for(var D=1;D<=24;D+=1)if(_.indexOf(C(D,0,P))>-1){L=D>12;break}}else L=_===(P?"pm":"PM");return L},v={A:[c,function(_){this.afternoon=j(_,!1)}],a:[c,function(_){this.afternoon=j(_,!0)}],Q:[s,function(_){this.month=3*(_-1)+1}],S:[s,function(_){this.milliseconds=100*+_}],SS:[o,function(_){this.milliseconds=10*+_}],SSS:[/\d{3}/,function(_){this.milliseconds=+_}],s:[i,p("seconds")],ss:[i,p("seconds")],m:[i,p("minutes")],mm:[i,p("minutes")],H:[i,p("hours")],h:[i,p("hours")],HH:[i,p("hours")],hh:[i,p("hours")],D:[i,p("day")],DD:[o,p("day")],Do:[c,function(_){var P=u.ordinal,L=_.match(/\d+/);if(this.day=L[0],P)for(var C=1;C<=31;C+=1)P(C).replace(/\[|\]/g,"")===_&&(this.day=C)}],w:[i,p("week")],ww:[o,p("week")],M:[i,p("month")],MM:[o,p("month")],MMM:[c,function(_){var P=m("months"),L=(m("monthsShort")||P.map(function(C){return C.slice(0,3)})).indexOf(_)+1;if(L<1)throw new Error;this.month=L%12||L}],MMMM:[c,function(_){var P=m("months").indexOf(_)+1;if(P<1)throw new Error;this.month=P%12||P}],Y:[/[+-]?\d+/,p("year")],YY:[o,function(_){this.year=d(_)}],YYYY:[/\d{4}/,p("year")],Z:f,ZZ:f};function w(_){var P,L;P=_,L=u&&u.formats;for(var C=(_=P.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(R,O,ee){var J=ee&&ee.toUpperCase();return O||L[ee]||n[ee]||L[J].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(z,Z,Q){return Z||Q.slice(1)})})).match(a),D=C.length,A=0;A<D;A+=1){var b=C[A],N=v[b],g=N&&N[0],x=N&&N[1];C[A]=x?{regex:g,parser:x}:b.replace(/^\[|\]$/g,"")}return function(R){for(var O={},ee=0,J=0;ee<D;ee+=1){var z=C[ee];if(typeof z=="string")J+=z.length;else{var Z=z.regex,Q=z.parser,X=R.slice(J),I=Z.exec(X)[0];Q.call(O,I),R=R.replace(I,"")}}return function(y){var S=y.afternoon;if(S!==void 0){var U=y.hours;S?U<12&&(y.hours+=12):U===12&&(y.hours=0),delete y.afternoon}}(O),O}}return function(_,P,L){L.p.customParseFormat=!0,_&&_.parseTwoDigitYear&&(d=_.parseTwoDigitYear);var C=P.prototype,D=C.parse;C.parse=function(A){var b=A.date,N=A.utc,g=A.args;this.$u=N;var x=g[1];if(typeof x=="string"){var R=g[2]===!0,O=g[3]===!0,ee=R||O,J=g[2];O&&(J=g[2]),u=this.$locale(),!R&&J&&(u=L.Ls[J]),this.$d=function(X,I,y,S){try{if(["x","X"].indexOf(I)>-1)return new Date((I==="X"?1e3:1)*X);var U=w(I)(X),K=U.year,E=U.month,V=U.day,q=U.hours,ue=U.minutes,ye=U.seconds,ge=U.milliseconds,xe=U.zone,me=U.week,he=new Date,ae=V||(K||E?1:he.getDate()),T=K||he.getFullYear(),$=0;K&&!E||($=E>0?E-1:he.getMonth());var ce,re=q||0,Me=ue||0,Ce=ye||0,Ye=ge||0;return xe?new Date(Date.UTC(T,$,ae,re,Me,Ce,Ye+60*xe.offset*1e3)):y?new Date(Date.UTC(T,$,ae,re,Me,Ce,Ye)):(ce=new Date(T,$,ae,re,Me,Ce,Ye),me&&(ce=S(ce).week(me).toDate()),ce)}catch{return new Date("")}}(b,x,N,L),this.init(),J&&J!==!0&&(this.$L=this.locale(J).$L),ee&&b!=this.format(x)&&(this.$d=new Date("")),u={}}else if(x instanceof Array)for(var z=x.length,Z=1;Z<=z;Z+=1){g[1]=x[Z-1];var Q=L.apply(this,g);if(Q.isValid()){this.$d=Q.$d,this.$L=Q.$L,this.init();break}Z===z&&(this.$d=new Date(""))}else D.call(this,A)}}})}(No)),No.exports}var mg=hg();const fg=st(mg);var Lo={exports:{}},xg=Lo.exports,Mc;function gg(){return Mc||(Mc=1,function(t,r){(function(n,a){t.exports=a()})(xg,function(){var n={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"};return function(a,s,o){var i=s.prototype,c=i.format;o.en.formats=n,i.format=function(u){u===void 0&&(u="YYYY-MM-DDTHH:mm:ssZ");var d=this.$locale().formats,p=function(f,m){return f.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(j,v,w){var _=w&&w.toUpperCase();return v||m[w]||n[w]||m[_].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(P,L,C){return L||C.slice(1)})})}(u,d===void 0?{}:d);return c.call(this,p)}}})}(Lo)),Lo.exports}var yg=gg();const vg=st(yg);var qo={exports:{}},bg=qo.exports,Rc;function _g(){return Rc||(Rc=1,function(t,r){(function(n,a){t.exports=a()})(bg,function(){return function(n,a,s){a.prototype.isBetween=function(o,i,c,u){var d=s(o),p=s(i),f=(u=u||"()")[0]==="(",m=u[1]===")";return(f?this.isAfter(d,c):!this.isBefore(d,c))&&(m?this.isBefore(p,c):!this.isAfter(p,c))||(f?this.isBefore(d,c):!this.isAfter(d,c))&&(m?this.isAfter(p,c):!this.isBefore(p,c))}}})}(qo)),qo.exports}var jg=_g();const wg=st(jg);$e.extend(fg);$e.extend(vg);$e.extend(wg);const Sg=Eh(["Your locale has not been found.","Either the locale key is not a supported one. Locales supported by dayjs are available here: https://github.com/iamkun/dayjs/tree/dev/src/locale","Or you forget to import the locale from 'dayjs/locale/{localeUsed}'","fallback on English locale"]),Cg={YY:"year",YYYY:{sectionType:"year",contentType:"digit",maxLength:4},M:{sectionType:"month",contentType:"digit",maxLength:2},MM:"month",MMM:{sectionType:"month",contentType:"letter"},MMMM:{sectionType:"month",contentType:"letter"},D:{sectionType:"day",contentType:"digit",maxLength:2},DD:"day",Do:{sectionType:"day",contentType:"digit-with-letter"},d:{sectionType:"weekDay",contentType:"digit",maxLength:2},dd:{sectionType:"weekDay",contentType:"letter"},ddd:{sectionType:"weekDay",contentType:"letter"},dddd:{sectionType:"weekDay",contentType:"letter"},A:"meridiem",a:"meridiem",H:{sectionType:"hours",contentType:"digit",maxLength:2},HH:"hours",h:{sectionType:"hours",contentType:"digit",maxLength:2},hh:"hours",m:{sectionType:"minutes",contentType:"digit",maxLength:2},mm:"minutes",s:{sectionType:"seconds",contentType:"digit",maxLength:2},ss:"seconds"},kg={year:"YYYY",month:"MMMM",monthShort:"MMM",dayOfMonth:"D",weekday:"dddd",weekdayShort:"dd",hours24h:"HH",hours12h:"hh",meridiem:"A",minutes:"mm",seconds:"ss",fullDate:"ll",fullDateWithWeekday:"dddd, LL",keyboardDate:"L",shortDate:"MMM D",normalDate:"D MMMM",normalDateWithWeekday:"ddd, MMM D",monthAndYear:"MMMM YYYY",monthAndDate:"MMMM D",fullTime:"LT",fullTime12h:"hh:mm A",fullTime24h:"HH:mm",fullDateTime:"lll",fullDateTime12h:"ll hh:mm A",fullDateTime24h:"ll HH:mm",keyboardDateTime:"L LT",keyboardDateTime12h:"L hh:mm A",keyboardDateTime24h:"L HH:mm"},zi=["Missing UTC plugin","To be able to use UTC or timezones, you have to enable the `utc` plugin","Find more information on https://mui.com/x/react-date-pickers/timezone/#day-js-and-utc"].join(`
`),Nc=["Missing timezone plugin","To be able to use timezones, you have to enable both the `utc` and the `timezone` plugin","Find more information on https://mui.com/x/react-date-pickers/timezone/#day-js-and-timezone"].join(`
`),Pg=(t,r)=>r?(...n)=>t(...n).locale(r):t;class ss{constructor({locale:r,formats:n,instance:a}={}){var s;this.isMUIAdapter=!0,this.isTimezoneCompatible=!0,this.lib="dayjs",this.rawDayJsInstance=void 0,this.dayjs=void 0,this.locale=void 0,this.formats=void 0,this.escapedCharacters={start:"[",end:"]"},this.formatTokenMap=Cg,this.setLocaleToValue=o=>{const i=this.getCurrentLocaleCode();return i===o.locale()?o:o.locale(i)},this.hasUTCPlugin=()=>typeof $e.utc<"u",this.hasTimezonePlugin=()=>typeof $e.tz<"u",this.isSame=(o,i,c)=>{const u=this.setTimezone(i,this.getTimezone(o));return o.format(c)===u.format(c)},this.cleanTimezone=o=>{switch(o){case"default":return;case"system":return $e.tz.guess();default:return o}},this.createSystemDate=o=>{if(this.rawDayJsInstance)return this.rawDayJsInstance(o);if(this.hasUTCPlugin()&&this.hasTimezonePlugin()){const i=$e.tz.guess();return i!=="UTC"?$e.tz(o,i):$e(o)}return $e(o)},this.createUTCDate=o=>{if(!this.hasUTCPlugin())throw new Error(zi);return $e.utc(o)},this.createTZDate=(o,i)=>{if(!this.hasUTCPlugin())throw new Error(zi);if(!this.hasTimezonePlugin())throw new Error(Nc);const c=o!==void 0&&!o.endsWith("Z");return $e(o).tz(this.cleanTimezone(i),c)},this.getLocaleFormats=()=>{const o=$e.Ls,i=this.locale||"en";let c=o[i];return c===void 0&&(Sg(),c=o.en),c.formats},this.adjustOffset=o=>{if(!this.hasTimezonePlugin())return o;const i=this.getTimezone(o);if(i!=="UTC"){var c,u;const d=o.tz(this.cleanTimezone(i),!0);if(((c=d.$offset)!=null?c:0)===((u=o.$offset)!=null?u:0))return o;o.$offset=d.$offset}return o},this.date=o=>o===null?null:this.dayjs(o),this.dateWithTimezone=(o,i)=>{if(o===null)return null;let c;return i==="UTC"?c=this.createUTCDate(o):i==="system"||i==="default"&&!this.hasTimezonePlugin()?c=this.createSystemDate(o):c=this.createTZDate(o,i),this.locale===void 0?c:c.locale(this.locale)},this.getTimezone=o=>{if(this.hasTimezonePlugin()){var i;const c=(i=o.$x)==null?void 0:i.$timezone;if(c)return c}return this.hasUTCPlugin()&&o.isUTC()?"UTC":"system"},this.setTimezone=(o,i)=>{if(this.getTimezone(o)===i)return o;if(i==="UTC"){if(!this.hasUTCPlugin())throw new Error(zi);return o.utc()}if(i==="system")return o.local();if(!this.hasTimezonePlugin()){if(i==="default")return o;throw new Error(Nc)}return $e.tz(o,this.cleanTimezone(i))},this.toJsDate=o=>o.toDate(),this.parseISO=o=>this.dayjs(o),this.toISO=o=>o.toISOString(),this.parse=(o,i)=>o===""?null:this.dayjs(o,i,this.locale,!0),this.getCurrentLocaleCode=()=>this.locale||"en",this.is12HourCycleInCurrentLocale=()=>/A|a/.test(this.getLocaleFormats().LT||""),this.expandFormat=o=>{const i=this.getLocaleFormats(),c=u=>u.replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,(d,p,f)=>p||f.slice(1));return o.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,(u,d,p)=>{const f=p&&p.toUpperCase();return d||i[p]||c(i[f])})},this.getFormatHelperText=o=>this.expandFormat(o).replace(/a/gi,"(a|p)m").toLocaleLowerCase(),this.isNull=o=>o===null,this.isValid=o=>this.dayjs(o).isValid(),this.format=(o,i)=>this.formatByString(o,this.formats[i]),this.formatByString=(o,i)=>this.dayjs(o).format(i),this.formatNumber=o=>o,this.getDiff=(o,i,c)=>o.diff(i,c),this.isEqual=(o,i)=>o===null&&i===null?!0:this.dayjs(o).toDate().getTime()===this.dayjs(i).toDate().getTime(),this.isSameYear=(o,i)=>this.isSame(o,i,"YYYY"),this.isSameMonth=(o,i)=>this.isSame(o,i,"YYYY-MM"),this.isSameDay=(o,i)=>this.isSame(o,i,"YYYY-MM-DD"),this.isSameHour=(o,i)=>o.isSame(i,"hour"),this.isAfter=(o,i)=>o>i,this.isAfterYear=(o,i)=>this.hasUTCPlugin()?!this.isSameYear(o,i)&&o.utc()>i.utc():o.isAfter(i,"year"),this.isAfterDay=(o,i)=>this.hasUTCPlugin()?!this.isSameDay(o,i)&&o.utc()>i.utc():o.isAfter(i,"day"),this.isBefore=(o,i)=>o<i,this.isBeforeYear=(o,i)=>this.hasUTCPlugin()?!this.isSameYear(o,i)&&o.utc()<i.utc():o.isBefore(i,"year"),this.isBeforeDay=(o,i)=>this.hasUTCPlugin()?!this.isSameDay(o,i)&&o.utc()<i.utc():o.isBefore(i,"day"),this.isWithinRange=(o,[i,c])=>o>=i&&o<=c,this.startOfYear=o=>this.adjustOffset(o.startOf("year")),this.startOfMonth=o=>this.adjustOffset(o.startOf("month")),this.startOfWeek=o=>this.adjustOffset(o.startOf("week")),this.startOfDay=o=>this.adjustOffset(o.startOf("day")),this.endOfYear=o=>this.adjustOffset(o.endOf("year")),this.endOfMonth=o=>this.adjustOffset(o.endOf("month")),this.endOfWeek=o=>this.adjustOffset(o.endOf("week")),this.endOfDay=o=>this.adjustOffset(o.endOf("day")),this.addYears=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"year"):o.add(i,"year")),this.addMonths=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"month"):o.add(i,"month")),this.addWeeks=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"week"):o.add(i,"week")),this.addDays=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"day"):o.add(i,"day")),this.addHours=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"hour"):o.add(i,"hour")),this.addMinutes=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"minute"):o.add(i,"minute")),this.addSeconds=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"second"):o.add(i,"second")),this.getYear=o=>o.year(),this.getMonth=o=>o.month(),this.getDate=o=>o.date(),this.getHours=o=>o.hour(),this.getMinutes=o=>o.minute(),this.getSeconds=o=>o.second(),this.getMilliseconds=o=>o.millisecond(),this.setYear=(o,i)=>this.adjustOffset(o.set("year",i)),this.setMonth=(o,i)=>this.adjustOffset(o.set("month",i)),this.setDate=(o,i)=>this.adjustOffset(o.set("date",i)),this.setHours=(o,i)=>this.adjustOffset(o.set("hour",i)),this.setMinutes=(o,i)=>this.adjustOffset(o.set("minute",i)),this.setSeconds=(o,i)=>this.adjustOffset(o.set("second",i)),this.setMilliseconds=(o,i)=>this.adjustOffset(o.set("millisecond",i)),this.getDaysInMonth=o=>o.daysInMonth(),this.getNextMonth=o=>this.addMonths(o,1),this.getPreviousMonth=o=>this.addMonths(o,-1),this.getMonthArray=o=>{const c=[o.startOf("year")];for(;c.length<12;){const u=c[c.length-1];c.push(this.addMonths(u,1))}return c},this.mergeDateAndTime=(o,i)=>o.hour(i.hour()).minute(i.minute()).second(i.second()),this.getWeekdays=()=>{const o=this.dayjs().startOf("week");return[0,1,2,3,4,5,6].map(i=>this.formatByString(this.addDays(o,i),"dd"))},this.getWeekArray=o=>{const i=this.setLocaleToValue(o),c=i.startOf("month").startOf("week"),u=i.endOf("month").endOf("week");let d=0,p=c;const f=[];for(;p<u;){const m=Math.floor(d/7);f[m]=f[m]||[],f[m].push(p),p=this.addDays(p,1),d+=1}return f},this.getWeekNumber=o=>o.week(),this.getYearRange=(o,i)=>{const c=o.startOf("year"),u=i.endOf("year"),d=[];let p=c;for(;p<u;)d.push(p),p=this.addYears(p,1);return d},this.getMeridiemText=o=>o==="am"?"AM":"PM",this.rawDayJsInstance=a,this.dayjs=Pg((s=this.rawDayJsInstance)!=null?s:$e,r),this.locale=r,this.formats=Iu({},kg,n),$e.extend(ug)}}const Dg=({onClick:t,isOpen:r,unreadCount:n=0})=>e.jsx(Ih,{"aria-label":"Workspace Copilot",onClick:t,sx:{position:"fixed",bottom:{xs:16,sm:24},right:{xs:16,sm:24},zIndex:1300,bgcolor:a=>a.palette.background.paper,color:a=>a.palette.primary.main,boxShadow:"0 18px 40px rgba(33, 150, 243, 0.25)",border:"1px solid",borderColor:a=>a.palette.divider,transition:"transform 0.2s ease, box-shadow 0.2s ease","&:hover":{transform:"translateY(-3px)",boxShadow:"0 22px 48px rgba(33, 150, 243, 0.32)",bgcolor:a=>a.palette.primary.main,color:"common.white"}},children:e.jsx(ii,{color:"error",badgeContent:n,invisible:n===0,sx:{"& .MuiBadge-badge":{fontWeight:600}},children:e.jsx(Tu,{})})});var Ks={},Bi={};const Eg=mm(Th);var Lc;function bt(){return Lc||(Lc=1,function(t){"use client";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return r.createSvgIcon}});var r=Eg}(Bi)),Bi}var qc;function Ig(){if(qc)return Ks;qc=1;var t=yt();Object.defineProperty(Ks,"__esModule",{value:!0}),Ks.default=void 0;var r=t(bt()),n=vt();return Ks.default=(0,r.default)((0,n.jsx)("path",{d:"M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2m0 4-8 5-8-5V6l8 5 8-5z"}),"Email"),Ks}var Tg=Ig();const bi=st(Tg);var Js={},Uc;function Og(){if(Uc)return Js;Uc=1;var t=yt();Object.defineProperty(Js,"__esModule",{value:!0}),Js.default=void 0;var r=t(bt()),n=vt();return Js.default=(0,r.default)((0,n.jsx)("path",{d:"M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02z"}),"Phone"),Js}var Ag=Og();const Mg=st(Ag);var Xs={},Wc;function Rg(){if(Wc)return Xs;Wc=1;var t=yt();Object.defineProperty(Xs,"__esModule",{value:!0}),Xs.default=void 0;var r=t(bt()),n=vt();return Xs.default=(0,r.default)([(0,n.jsx)("path",{d:"M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"},"0"),(0,n.jsx)("path",{d:"M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"},"1")],"Schedule"),Xs}var Ng=Rg();const Tp=st(Ng);var Zs={},Fc;function Lg(){if(Fc)return Zs;Fc=1;var t=yt();Object.defineProperty(Zs,"__esModule",{value:!0}),Zs.default=void 0;var r=t(bt()),n=vt();return Zs.default=(0,r.default)((0,n.jsx)("path",{d:"M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1m-2 14-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9z"}),"AssignmentTurnedIn"),Zs}var qg=Lg();const Ug=st(qg);var ea={},$c;function Wg(){if($c)return ea;$c=1;var t=yt();Object.defineProperty(ea,"__esModule",{value:!0}),ea.default=void 0;var r=t(bt()),n=vt();return ea.default=(0,r.default)((0,n.jsx)("path",{d:"M9 18h12v-2H9zM3 6v2h18V6zm6 7h12v-2H9z"}),"Segment"),ea}var Fg=Wg();const $g=st(Fg),zg={initiated:"warning",ringing:"warning",connected:"success",completed:"success",hangup:"default",failed:"error"},Bg=({artifacts:t})=>t.length?e.jsx(ke,{spacing:2,children:t.map(r=>e.jsx(Ae,{variant:"outlined",sx:{p:2.5,borderRadius:2,bgcolor:n=>n.palette.grey[50]},children:e.jsxs(ke,{spacing:2,children:[e.jsxs(ke,{direction:{xs:"column",sm:"row"},spacing:1.5,alignItems:{xs:"flex-start",sm:"center"},children:[e.jsxs(h,{variant:"subtitle1",sx:{fontWeight:700},children:["Vendor call #",r.sessionId]}),e.jsx(De,{size:"small",color:zg[r.status?.toLowerCase()]??"default",label:r.status?.toUpperCase()||"UNKNOWN"}),r.purchaseNumber&&e.jsx(De,{size:"small",variant:"outlined",label:`PO ${r.purchaseNumber}`})]}),e.jsxs(M,{container:!0,spacing:2,children:[r.vendor?.name&&e.jsxs(M,{item:!0,xs:12,sm:6,md:4,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Vendor"}),e.jsx(h,{variant:"body1",fontWeight:600,children:r.vendor.name}),r.vendor.phone&&e.jsxs(ke,{direction:"row",alignItems:"center",spacing:1,mt:.5,children:[e.jsx(Mg,{fontSize:"small",color:"action"}),e.jsx(h,{variant:"body2",children:r.vendor.phone})]})]}),r.capturedEmail&&e.jsxs(M,{item:!0,xs:12,sm:6,md:4,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Contact Email"}),e.jsxs(ke,{direction:"row",alignItems:"center",spacing:1,mt:.5,children:[e.jsx(bi,{fontSize:"small",color:"action"}),e.jsx(h,{variant:"body2",children:r.capturedEmail})]})]}),r.pickupTime&&e.jsxs(M,{item:!0,xs:12,sm:6,md:4,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Pickup Window"}),e.jsxs(ke,{direction:"row",alignItems:"center",spacing:1,mt:.5,children:[e.jsx(Tp,{fontSize:"small",color:"action"}),e.jsx(h,{variant:"body2",children:r.pickupTime})]})]})]}),r.parts&&r.parts.length>0&&e.jsxs(k,{children:[e.jsx(h,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Confirmed Parts"}),e.jsx(Pr,{dense:!0,children:r.parts.map((n,a)=>e.jsxs(Mr,{disablePadding:!0,children:[e.jsx(Ou,{sx:{minWidth:32},children:e.jsx($g,{fontSize:"small",color:"action"})}),e.jsx(fr,{primary:`${n.part_number}  ${n.quantity}`,secondary:n.notes||void 0})]},`${r.sessionId}-part-${a}`))})]}),r.summary&&e.jsxs(k,{children:[e.jsx(h,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Call Summary"}),e.jsx(h,{variant:"body2",sx:{whiteSpace:"pre-wrap"},children:r.summary})]}),r.nextSteps&&r.nextSteps.length>0&&e.jsxs(k,{children:[e.jsxs(ke,{direction:"row",alignItems:"center",spacing:1,mb:1,children:[e.jsx(Ug,{fontSize:"small",color:"action"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Next Steps"})]}),e.jsx(Pr,{dense:!0,children:r.nextSteps.map((n,a)=>e.jsx(Mr,{disablePadding:!0,children:e.jsx(fr,{primary:n})},`${r.sessionId}-step-${a}`))})]}),r.transcriptPreview&&e.jsxs(k,{children:[e.jsx(h,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Transcript Preview"}),e.jsx(h,{variant:"caption",sx:{whiteSpace:"pre-wrap",color:"text.secondary"},children:r.transcriptPreview})]})]})},r.sessionId))}):null,Hg=t=>{if(!t)return"";const r=$e(t);return r.isValid()?r.format("MMM D, YYYY h:mm A"):""},Yg=({message:t})=>{const r=t.role==="user",n=Hg(t.timestamp||t.createdAt),a=i=>{if(!t.task)return null;const c=t.task.status.replace("_"," ").replace(/\b\w/g,u=>u.toUpperCase());return e.jsx(Ae,{variant:"outlined",sx:{px:2.5,py:2,borderRadius:3,borderColor:"divider",backgroundColor:"background.paper"},children:e.jsxs(ke,{spacing:1.5,children:[e.jsxs(ke,{direction:"row",alignItems:"center",spacing:1.5,children:[e.jsx(Oh,{color:"primary",fontSize:"small"}),e.jsx(h,{variant:"subtitle1",sx:{fontWeight:600},children:i==="task_created"?"Task created":i==="task_updated"?"Task updated":"Task note"}),t.task.createdByAgent&&e.jsx(De,{label:"AI",color:"primary",size:"small"})]}),e.jsxs(k,{children:[e.jsx(h,{variant:"h6",children:t.task.title}),e.jsxs(ke,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",useFlexGap:!0,children:[e.jsx(De,{label:c,size:"small"}),t.task.dueDate&&e.jsx(De,{label:`Due ${$e(t.task.dueDate).format("MMM D")}`,size:"small",color:"warning",variant:"outlined"})]})]}),t.summary&&e.jsx(h,{variant:"body2",color:"text.secondary",children:t.summary}),t.link&&e.jsx(G,{component:rp,to:t.link,variant:"contained",size:"small",sx:{alignSelf:"flex-start",textTransform:"none",borderRadius:999},children:"View task"})]})})},s=()=>!t.chunks||t.chunks.length===0?null:e.jsxs(Ae,{variant:"outlined",sx:{px:2,py:1.75,borderRadius:3,borderColor:"divider",backgroundColor:"background.paper"},children:[e.jsx(h,{variant:"subtitle2",sx:{fontWeight:600,mb:1},children:t.info||"Relevant documentation"}),e.jsx(ke,{spacing:1.25,children:t.chunks.map((i,c)=>e.jsxs(k,{children:[e.jsx(h,{variant:"body2",sx:{fontWeight:600},children:i?.path||"Documentation"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:i?.chunk||""})]},c))})]}),o=()=>t.type==="task_created"||t.type==="task_updated"||t.type==="task_message"?a(t.type):t.type==="docs"?s():e.jsx(h,{variant:"body2",sx:{whiteSpace:"pre-wrap",lineHeight:1.7},children:t.content||t.summary});return e.jsxs(ke,{direction:"row",justifyContent:r?"flex-end":"flex-start",sx:{width:"100%"},spacing:1.5,children:[!r&&e.jsx(Nn,{sx:{bgcolor:"primary.main",width:34,height:34,boxShadow:"0 10px 20px rgba(64, 132, 253, 0.25)"},children:e.jsx(Al,{fontSize:"small"})}),e.jsxs(Ae,{elevation:0,sx:{px:{xs:2.25,sm:2.75},py:{xs:1.5,sm:1.75},maxWidth:{xs:"82%",sm:"72%"},borderRadius:3,borderTopRightRadius:r?4:3,borderTopLeftRadius:r?3:4,background:i=>r?`linear-gradient(135deg, ${In(i.palette.primary.main,.95)} 0%, ${i.palette.primary.main} 100%)`:"rgba(255, 255, 255, 0.92)",color:r?"common.white":"text.primary",border:r?"none":"1px solid rgba(148, 163, 184, 0.25)",boxShadow:r?"0 18px 32px -24px rgba(64, 132, 253, 0.65)":"0 12px 28px -22px rgba(15, 23, 42, 0.35)",backdropFilter:r?void 0:"blur(18px)"},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1,gap:1.5},children:[e.jsx(h,{variant:"overline",sx:{fontWeight:700,letterSpacing:1,color:r?In("#ffffff",.8):"text.secondary"},children:r?"You":"Workspace Copilot"}),n&&e.jsx(h,{variant:"caption",sx:{color:r?In("#ffffff",.75):"text.disabled",whiteSpace:"nowrap"},children:n})]}),o(),!r&&t.callArtifacts?.length?e.jsxs(k,{sx:{mt:2},children:[e.jsx(xr,{sx:{mb:2,opacity:.4}}),e.jsx(Bg,{artifacts:t.callArtifacts})]}):null]}),r&&e.jsx(Nn,{sx:{bgcolor:"secondary.main",width:34,height:34,boxShadow:"0 10px 20px rgba(244, 63, 94, 0.25)"},children:e.jsx(Ml,{fontSize:"small"})})]})},Op=({onSendMessage:t,disabled:r=!1,placeholder:n="Type your message..."})=>{const[a,s]=l.useState(""),o=()=>{a.trim()&&!r&&(t(a.trim()),s(""))},i=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),o())};return e.jsx(Ae,{elevation:0,sx:{px:{xs:2,sm:3},py:2.5,borderTop:"1px solid",borderColor:"divider",bgcolor:"transparent",backdropFilter:"blur(6px)"},children:e.jsxs(k,{sx:{display:"flex",alignItems:{xs:"stretch",sm:"center"},gap:1.5,bgcolor:"rgba(255, 255, 255, 0.92)",borderRadius:3,px:{xs:1.5,sm:2.5},py:{xs:1.25,sm:1.5},border:"1px solid rgba(148, 163, 184, 0.25)",boxShadow:"0 18px 36px -28px rgba(15, 23, 42, 0.4)"},children:[e.jsx(le,{fullWidth:!0,multiline:!0,maxRows:4,value:a,onChange:c=>s(c.target.value),onKeyDown:i,placeholder:n,disabled:r,variant:"standard",size:"medium",sx:{"& .MuiInputBase-root":{fontSize:15,lineHeight:1.7,"&::before, &::after":{display:"none"}},"& textarea":{padding:0}}}),e.jsx(Vt,{title:"Send message",children:e.jsx("span",{children:e.jsx(gt,{onClick:o,disabled:!a.trim()||r,sx:{bgcolor:"primary.main",color:"common.white",p:1.4,borderRadius:"18px",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:c=>`0 16px 32px -18px ${c.palette.primary.main}`,"&:hover":{bgcolor:"primary.dark",transform:"translateY(-1px)",boxShadow:c=>`0 20px 38px -20px ${c.palette.primary.dark}`},"&.Mui-disabled":{bgcolor:"grey.200",color:"grey.500",boxShadow:"none",transform:"none"}},children:e.jsx(Ah,{fontSize:"small"})})})})]})})},ao=t=>typeof t=="number"&&!isNaN(t),Xn=t=>typeof t=="string",zr=t=>typeof t=="function",Uo=t=>Xn(t)||zr(t)?t:null,vl=t=>l.isValidElement(t)||Xn(t)||zr(t)||ao(t);function Vg(t,r,n){n===void 0&&(n=300);const{scrollHeight:a,style:s}=t;requestAnimationFrame(()=>{s.minHeight="initial",s.height=a+"px",s.transition=`all ${n}ms`,requestAnimationFrame(()=>{s.height="0",s.padding="0",s.margin="0",setTimeout(r,n)})})}function _i(t){let{enter:r,exit:n,appendPosition:a=!1,collapse:s=!0,collapseDuration:o=300}=t;return function(i){let{children:c,position:u,preventExitTransition:d,done:p,nodeRef:f,isIn:m,playToast:j}=i;const v=a?`${r}--${u}`:r,w=a?`${n}--${u}`:n,_=l.useRef(0);return l.useLayoutEffect(()=>{const P=f.current,L=v.split(" "),C=D=>{D.target===f.current&&(j(),P.removeEventListener("animationend",C),P.removeEventListener("animationcancel",C),_.current===0&&D.type!=="animationcancel"&&P.classList.remove(...L))};P.classList.add(...L),P.addEventListener("animationend",C),P.addEventListener("animationcancel",C)},[]),l.useEffect(()=>{const P=f.current,L=()=>{P.removeEventListener("animationend",L),s?Vg(P,p,o):p()};m||(d?L():(_.current=1,P.className+=` ${w}`,P.addEventListener("animationend",L)))},[m]),It.createElement(It.Fragment,null,c)}}function zc(t,r){return t!=null?{content:t.content,containerId:t.props.containerId,id:t.props.toastId,theme:t.props.theme,type:t.props.type,data:t.props.data||{},isLoading:t.props.isLoading,icon:t.props.icon,status:r}:{}}const Dr=new Map;let oo=[];const bl=new Set,Gg=t=>bl.forEach(r=>r(t)),Ap=()=>Dr.size>0;function Mp(t,r){var n;if(r)return!((n=Dr.get(r))==null||!n.isToastActive(t));let a=!1;return Dr.forEach(s=>{s.isToastActive(t)&&(a=!0)}),a}function Rp(t,r){vl(t)&&(Ap()||oo.push({content:t,options:r}),Dr.forEach(n=>{n.buildToast(t,r)}))}function Bc(t,r){Dr.forEach(n=>{r!=null&&r!=null&&r.containerId?r?.containerId===n.id&&n.toggle(t,r?.id):n.toggle(t,r?.id)})}function Qg(t){const{subscribe:r,getSnapshot:n,setProps:a}=l.useRef(function(o){const i=o.containerId||1;return{subscribe(c){const u=function(p,f,m){let j=1,v=0,w=[],_=[],P=[],L=f;const C=new Map,D=new Set,A=()=>{P=Array.from(C.values()),D.forEach(g=>g())},b=g=>{_=g==null?[]:_.filter(x=>x!==g),A()},N=g=>{const{toastId:x,onOpen:R,updateId:O,children:ee}=g.props,J=O==null;g.staleId&&C.delete(g.staleId),C.set(x,g),_=[..._,g.props.toastId].filter(z=>z!==g.staleId),A(),m(zc(g,J?"added":"updated")),J&&zr(R)&&R(l.isValidElement(ee)&&ee.props)};return{id:p,props:L,observe:g=>(D.add(g),()=>D.delete(g)),toggle:(g,x)=>{C.forEach(R=>{x!=null&&x!==R.props.toastId||zr(R.toggle)&&R.toggle(g)})},removeToast:b,toasts:C,clearQueue:()=>{v-=w.length,w=[]},buildToast:(g,x)=>{if((K=>{let{containerId:E,toastId:V,updateId:q}=K;const ue=E?E!==p:p!==1,ye=C.has(V)&&q==null;return ue||ye})(x))return;const{toastId:R,updateId:O,data:ee,staleId:J,delay:z}=x,Z=()=>{b(R)},Q=O==null;Q&&v++;const X={...L,style:L.toastStyle,key:j++,...Object.fromEntries(Object.entries(x).filter(K=>{let[E,V]=K;return V!=null})),toastId:R,updateId:O,data:ee,closeToast:Z,isIn:!1,className:Uo(x.className||L.toastClassName),bodyClassName:Uo(x.bodyClassName||L.bodyClassName),progressClassName:Uo(x.progressClassName||L.progressClassName),autoClose:!x.isLoading&&(I=x.autoClose,y=L.autoClose,I===!1||ao(I)&&I>0?I:y),deleteToast(){const K=C.get(R),{onClose:E,children:V}=K.props;zr(E)&&E(l.isValidElement(V)&&V.props),m(zc(K,"removed")),C.delete(R),v--,v<0&&(v=0),w.length>0?N(w.shift()):A()}};var I,y;X.closeButton=L.closeButton,x.closeButton===!1||vl(x.closeButton)?X.closeButton=x.closeButton:x.closeButton===!0&&(X.closeButton=!vl(L.closeButton)||L.closeButton);let S=g;l.isValidElement(g)&&!Xn(g.type)?S=l.cloneElement(g,{closeToast:Z,toastProps:X,data:ee}):zr(g)&&(S=g({closeToast:Z,toastProps:X,data:ee}));const U={content:S,props:X,staleId:J};L.limit&&L.limit>0&&v>L.limit&&Q?w.push(U):ao(z)?setTimeout(()=>{N(U)},z):N(U)},setProps(g){L=g},setToggle:(g,x)=>{C.get(g).toggle=x},isToastActive:g=>_.some(x=>x===g),getSnapshot:()=>P}}(i,o,Gg);Dr.set(i,u);const d=u.observe(c);return oo.forEach(p=>Rp(p.content,p.options)),oo=[],()=>{d(),Dr.delete(i)}},setProps(c){var u;(u=Dr.get(i))==null||u.setProps(c)},getSnapshot(){var c;return(c=Dr.get(i))==null?void 0:c.getSnapshot()}}}(t)).current;a(t);const s=l.useSyncExternalStore(r,n,n);return{getToastToRender:function(o){if(!s)return[];const i=new Map;return t.newestOnTop&&s.reverse(),s.forEach(c=>{const{position:u}=c.props;i.has(u)||i.set(u,[]),i.get(u).push(c)}),Array.from(i,c=>o(c[0],c[1]))},isToastActive:Mp,count:s?.length}}function Kg(t){const[r,n]=l.useState(!1),[a,s]=l.useState(!1),o=l.useRef(null),i=l.useRef({start:0,delta:0,removalDistance:0,canCloseOnClick:!0,canDrag:!1,didMove:!1}).current,{autoClose:c,pauseOnHover:u,closeToast:d,onClick:p,closeOnClick:f}=t;var m,j;function v(){n(!0)}function w(){n(!1)}function _(C){const D=o.current;i.canDrag&&D&&(i.didMove=!0,r&&w(),i.delta=t.draggableDirection==="x"?C.clientX-i.start:C.clientY-i.start,i.start!==C.clientX&&(i.canCloseOnClick=!1),D.style.transform=`translate3d(${t.draggableDirection==="x"?`${i.delta}px, var(--y)`:`0, calc(${i.delta}px + var(--y))`},0)`,D.style.opacity=""+(1-Math.abs(i.delta/i.removalDistance)))}function P(){document.removeEventListener("pointermove",_),document.removeEventListener("pointerup",P);const C=o.current;if(i.canDrag&&i.didMove&&C){if(i.canDrag=!1,Math.abs(i.delta)>i.removalDistance)return s(!0),t.closeToast(),void t.collapseAll();C.style.transition="transform 0.2s, opacity 0.2s",C.style.removeProperty("transform"),C.style.removeProperty("opacity")}}(j=Dr.get((m={id:t.toastId,containerId:t.containerId,fn:n}).containerId||1))==null||j.setToggle(m.id,m.fn),l.useEffect(()=>{if(t.pauseOnFocusLoss)return document.hasFocus()||w(),window.addEventListener("focus",v),window.addEventListener("blur",w),()=>{window.removeEventListener("focus",v),window.removeEventListener("blur",w)}},[t.pauseOnFocusLoss]);const L={onPointerDown:function(C){if(t.draggable===!0||t.draggable===C.pointerType){i.didMove=!1,document.addEventListener("pointermove",_),document.addEventListener("pointerup",P);const D=o.current;i.canCloseOnClick=!0,i.canDrag=!0,D.style.transition="none",t.draggableDirection==="x"?(i.start=C.clientX,i.removalDistance=D.offsetWidth*(t.draggablePercent/100)):(i.start=C.clientY,i.removalDistance=D.offsetHeight*(t.draggablePercent===80?1.5*t.draggablePercent:t.draggablePercent)/100)}},onPointerUp:function(C){const{top:D,bottom:A,left:b,right:N}=o.current.getBoundingClientRect();C.nativeEvent.type!=="touchend"&&t.pauseOnHover&&C.clientX>=b&&C.clientX<=N&&C.clientY>=D&&C.clientY<=A?w():v()}};return c&&u&&(L.onMouseEnter=w,t.stacked||(L.onMouseLeave=v)),f&&(L.onClick=C=>{p&&p(C),i.canCloseOnClick&&d()}),{playToast:v,pauseToast:w,isRunning:r,preventExitTransition:a,toastRef:o,eventHandlers:L}}function Jg(t){let{delay:r,isRunning:n,closeToast:a,type:s="default",hide:o,className:i,style:c,controlledProgress:u,progress:d,rtl:p,isIn:f,theme:m}=t;const j=o||u&&d===0,v={...c,animationDuration:`${r}ms`,animationPlayState:n?"running":"paused"};u&&(v.transform=`scaleX(${d})`);const w=Tn("Toastify__progress-bar",u?"Toastify__progress-bar--controlled":"Toastify__progress-bar--animated",`Toastify__progress-bar-theme--${m}`,`Toastify__progress-bar--${s}`,{"Toastify__progress-bar--rtl":p}),_=zr(i)?i({rtl:p,type:s,defaultClassName:w}):Tn(w,i),P={[u&&d>=1?"onTransitionEnd":"onAnimationEnd"]:u&&d<1?null:()=>{f&&a()}};return It.createElement("div",{className:"Toastify__progress-bar--wrp","data-hidden":j},It.createElement("div",{className:`Toastify__progress-bar--bg Toastify__progress-bar-theme--${m} Toastify__progress-bar--${s}`}),It.createElement("div",{role:"progressbar","aria-hidden":j?"true":"false","aria-label":"notification timer",className:_,style:v,...P}))}let Xg=1;const Np=()=>""+Xg++;function Zg(t){return t&&(Xn(t.toastId)||ao(t.toastId))?t.toastId:Np()}function eo(t,r){return Rp(t,r),r.toastId}function Zo(t,r){return{...r,type:r&&r.type||t,toastId:Zg(r)}}function jo(t){return(r,n)=>eo(r,Zo(t,n))}function H(t,r){return eo(t,Zo("default",r))}H.loading=(t,r)=>eo(t,Zo("default",{isLoading:!0,autoClose:!1,closeOnClick:!1,closeButton:!1,draggable:!1,...r})),H.promise=function(t,r,n){let a,{pending:s,error:o,success:i}=r;s&&(a=Xn(s)?H.loading(s,n):H.loading(s.render,{...n,...s}));const c={isLoading:null,autoClose:null,closeOnClick:null,closeButton:null,draggable:null},u=(p,f,m)=>{if(f==null)return void H.dismiss(a);const j={type:p,...c,...n,data:m},v=Xn(f)?{render:f}:f;return a?H.update(a,{...j,...v}):H(v.render,{...j,...v}),m},d=zr(t)?t():t;return d.then(p=>u("success",i,p)).catch(p=>u("error",o,p)),d},H.success=jo("success"),H.info=jo("info"),H.error=jo("error"),H.warning=jo("warning"),H.warn=H.warning,H.dark=(t,r)=>eo(t,Zo("default",{theme:"dark",...r})),H.dismiss=function(t){(function(r){var n;if(Ap()){if(r==null||Xn(n=r)||ao(n))Dr.forEach(a=>{a.removeToast(r)});else if(r&&("containerId"in r||"id"in r)){const a=Dr.get(r.containerId);a?a.removeToast(r.id):Dr.forEach(s=>{s.removeToast(r.id)})}}else oo=oo.filter(a=>r!=null&&a.options.toastId!==r)})(t)},H.clearWaitingQueue=function(t){t===void 0&&(t={}),Dr.forEach(r=>{!r.props.limit||t.containerId&&r.id!==t.containerId||r.clearQueue()})},H.isActive=Mp,H.update=function(t,r){r===void 0&&(r={});const n=((a,s)=>{var o;let{containerId:i}=s;return(o=Dr.get(i||1))==null?void 0:o.toasts.get(a)})(t,r);if(n){const{props:a,content:s}=n,o={delay:100,...a,...r,toastId:r.toastId||t,updateId:Np()};o.toastId!==t&&(o.staleId=t);const i=o.render||s;delete o.render,eo(i,o)}},H.done=t=>{H.update(t,{progress:1})},H.onChange=function(t){return bl.add(t),()=>{bl.delete(t)}},H.play=t=>Bc(!0,t),H.pause=t=>Bc(!1,t);const ey=typeof window<"u"?l.useLayoutEffect:l.useEffect,wo=t=>{let{theme:r,type:n,isLoading:a,...s}=t;return It.createElement("svg",{viewBox:"0 0 24 24",width:"100%",height:"100%",fill:r==="colored"?"currentColor":`var(--toastify-icon-color-${n})`,...s})},Hi={info:function(t){return It.createElement(wo,{...t},It.createElement("path",{d:"M12 0a12 12 0 1012 12A12.013 12.013 0 0012 0zm.25 5a1.5 1.5 0 11-1.5 1.5 1.5 1.5 0 011.5-1.5zm2.25 13.5h-4a1 1 0 010-2h.75a.25.25 0 00.25-.25v-4.5a.25.25 0 00-.25-.25h-.75a1 1 0 010-2h1a2 2 0 012 2v4.75a.25.25 0 00.25.25h.75a1 1 0 110 2z"}))},warning:function(t){return It.createElement(wo,{...t},It.createElement("path",{d:"M23.32 17.191L15.438 2.184C14.728.833 13.416 0 11.996 0c-1.42 0-2.733.833-3.443 2.184L.533 17.448a4.744 4.744 0 000 4.368C1.243 23.167 2.555 24 3.975 24h16.05C22.22 24 24 22.044 24 19.632c0-.904-.251-1.746-.68-2.44zm-9.622 1.46c0 1.033-.724 1.823-1.698 1.823s-1.698-.79-1.698-1.822v-.043c0-1.028.724-1.822 1.698-1.822s1.698.79 1.698 1.822v.043zm.039-12.285l-.84 8.06c-.057.581-.408.943-.897.943-.49 0-.84-.367-.896-.942l-.84-8.065c-.057-.624.25-1.095.779-1.095h1.91c.528.005.84.476.784 1.1z"}))},success:function(t){return It.createElement(wo,{...t},It.createElement("path",{d:"M12 0a12 12 0 1012 12A12.014 12.014 0 0012 0zm6.927 8.2l-6.845 9.289a1.011 1.011 0 01-1.43.188l-4.888-3.908a1 1 0 111.25-1.562l4.076 3.261 6.227-8.451a1 1 0 111.61 1.183z"}))},error:function(t){return It.createElement(wo,{...t},It.createElement("path",{d:"M11.983 0a12.206 12.206 0 00-8.51 3.653A11.8 11.8 0 000 12.207 11.779 11.779 0 0011.8 24h.214A12.111 12.111 0 0024 11.791 11.766 11.766 0 0011.983 0zM10.5 16.542a1.476 1.476 0 011.449-1.53h.027a1.527 1.527 0 011.523 1.47 1.475 1.475 0 01-1.449 1.53h-.027a1.529 1.529 0 01-1.523-1.47zM11 12.5v-6a1 1 0 012 0v6a1 1 0 11-2 0z"}))},spinner:function(){return It.createElement("div",{className:"Toastify__spinner"})}},ty=t=>{const{isRunning:r,preventExitTransition:n,toastRef:a,eventHandlers:s,playToast:o}=Kg(t),{closeButton:i,children:c,autoClose:u,onClick:d,type:p,hideProgressBar:f,closeToast:m,transition:j,position:v,className:w,style:_,bodyClassName:P,bodyStyle:L,progressClassName:C,progressStyle:D,updateId:A,role:b,progress:N,rtl:g,toastId:x,deleteToast:R,isIn:O,isLoading:ee,closeOnClick:J,theme:z}=t,Z=Tn("Toastify__toast",`Toastify__toast-theme--${z}`,`Toastify__toast--${p}`,{"Toastify__toast--rtl":g},{"Toastify__toast--close-on-click":J}),Q=zr(w)?w({rtl:g,position:v,type:p,defaultClassName:Z}):Tn(Z,w),X=function(U){let{theme:K,type:E,isLoading:V,icon:q}=U,ue=null;const ye={theme:K,type:E};return q===!1||(zr(q)?ue=q({...ye,isLoading:V}):l.isValidElement(q)?ue=l.cloneElement(q,ye):V?ue=Hi.spinner():(ge=>ge in Hi)(E)&&(ue=Hi[E](ye))),ue}(t),I=!!N||!u,y={closeToast:m,type:p,theme:z};let S=null;return i===!1||(S=zr(i)?i(y):l.isValidElement(i)?l.cloneElement(i,y):function(U){let{closeToast:K,theme:E,ariaLabel:V="close"}=U;return It.createElement("button",{className:`Toastify__close-button Toastify__close-button--${E}`,type:"button",onClick:q=>{q.stopPropagation(),K(q)},"aria-label":V},It.createElement("svg",{"aria-hidden":"true",viewBox:"0 0 14 16"},It.createElement("path",{fillRule:"evenodd",d:"M7.71 8.23l3.75 3.75-1.48 1.48-3.75-3.75-3.75 3.75L1 11.98l3.75-3.75L1 4.48 2.48 3l3.75 3.75L9.98 3l1.48 1.48-3.75 3.75z"})))}(y)),It.createElement(j,{isIn:O,done:R,position:v,preventExitTransition:n,nodeRef:a,playToast:o},It.createElement("div",{id:x,onClick:d,"data-in":O,className:Q,...s,style:_,ref:a},It.createElement("div",{...O&&{role:b},className:zr(P)?P({type:p}):Tn("Toastify__toast-body",P),style:L},X!=null&&It.createElement("div",{className:Tn("Toastify__toast-icon",{"Toastify--animate-icon Toastify__zoom-enter":!ee})},X),It.createElement("div",null,c)),S,It.createElement(Jg,{...A&&!I?{key:`pb-${A}`}:{},rtl:g,theme:z,delay:u,isRunning:r,isIn:O,closeToast:m,hide:f,type:p,style:D,className:C,controlledProgress:I,progress:N||0})))},ji=function(t,r){return r===void 0&&(r=!1),{enter:`Toastify--animate Toastify__${t}-enter`,exit:`Toastify--animate Toastify__${t}-exit`,appendPosition:r}},ry=_i(ji("bounce",!0));_i(ji("slide",!0));_i(ji("zoom"));_i(ji("flip"));const ny={position:"top-right",transition:ry,autoClose:5e3,closeButton:!0,pauseOnHover:!0,pauseOnFocusLoss:!0,draggable:"touch",draggablePercent:80,draggableDirection:"x",role:"alert",theme:"light"};function sy(t){let r={...ny,...t};const n=t.stacked,[a,s]=l.useState(!0),o=l.useRef(null),{getToastToRender:i,isToastActive:c,count:u}=Qg(r),{className:d,style:p,rtl:f,containerId:m}=r;function j(w){const _=Tn("Toastify__toast-container",`Toastify__toast-container--${w}`,{"Toastify__toast-container--rtl":f});return zr(d)?d({position:w,rtl:f,defaultClassName:_}):Tn(_,Uo(d))}function v(){n&&(s(!0),H.play())}return ey(()=>{if(n){var w;const _=o.current.querySelectorAll('[data-in="true"]'),P=12,L=(w=r.position)==null?void 0:w.includes("top");let C=0,D=0;Array.from(_).reverse().forEach((A,b)=>{const N=A;N.classList.add("Toastify__toast--stacked"),b>0&&(N.dataset.collapsed=`${a}`),N.dataset.pos||(N.dataset.pos=L?"top":"bot");const g=C*(a?.2:1)+(a?0:P*b);N.style.setProperty("--y",`${L?g:-1*g}px`),N.style.setProperty("--g",`${P}`),N.style.setProperty("--s",""+(1-(a?D:0))),C+=N.offsetHeight,D+=.025})}},[a,u,n]),It.createElement("div",{ref:o,className:"Toastify",id:m,onMouseEnter:()=>{n&&(s(!1),H.pause())},onMouseLeave:v},i((w,_)=>{const P=_.length?{...p}:{...p,pointerEvents:"none"};return It.createElement("div",{className:j(w),style:P,key:`container-${w}`},_.map(L=>{let{content:C,props:D}=L;return It.createElement(ty,{...D,stacked:n,collapseAll:v,isIn:c(D.toastId,D.containerId),style:D.style,key:`toast-${D.key}`},C)}))}))}const Hc=t=>{if(Array.isArray(t))return t.filter(r=>typeof r=="object"&&r!==null)},ay=t=>{if(!Array.isArray(t))return;const r=t.map(n=>{if(!n||typeof n!="object")return null;const a=n.key??n.stage??n.subagent;return!a||typeof a!="string"?null:{key:a,resultKey:n.resultKey??n.result_key??null}}).filter(Boolean);return r.length>0?r:void 0},oy=(t,r)=>{if(!r||typeof r!="object")return null;const n=r.planStepId??r.plan_step_id??r.stepId;if(!n||typeof n!="string")return null;const a=r.sessionId??r.session_id??t,s=r.cursor??r.lastEventId??r.last_event_id??null,o=r.plannerContext&&typeof r.plannerContext=="object"?r.plannerContext:r.planner_context&&typeof r.planner_context=="object"?r.planner_context:void 0;return{sessionId:String(a??t),planStepId:n,cursor:s!=null?String(s):null,expectedSubagents:ay(r.expectedSubagents??r.expected_subagents),plannerContext:o??null}},ta={async createSession(){return(await B.post("/api/agent/v2/session")).data.sessionId},async listSessions(t=4,r){const n={limit:t};r!=null&&(n.include=r);const a=await B.get("/api/agent/v2/sessions",{params:n});return(Array.isArray(a.data?.sessions)?a.data.sessions:[]).map(o=>({id:Number(o.id),title:String(o.title??`Chat ${o.id}`),preview:typeof o.preview=="string"?o.preview:null,lastMessageAt:o.lastMessageAt??o.last_message_at??null,createdAt:o.createdAt??o.created_at??new Date().toISOString(),lastActivityAt:o.lastActivityAt??o.last_activity_at??null}))},async fetchMessages(t){const r=await B.get(`/api/agent/v2/session/${t}/messages`);return(Array.isArray(r.data?.messages)?r.data.messages:[]).map(a=>({...a,callArtifacts:Hc(a.callArtifacts)}))},async sendMessage(t,r){const n=await B.post("/api/agent/v2/chat",{sessionId:t,message:r}),s=(Array.isArray(n.data?.events)?n.data.events:[]).map(i=>({...i,callArtifacts:Hc(i.callArtifacts)})),o=oy(t,n.data?.plan??n.data?.plannerStream);return{events:s,plan:o}}},ra="agent_v2_session_id",iy=45e3,Lp=(t,r)=>{if(r&&r.length)return{content:t,artifacts:r};if(!t)return{content:t,artifacts:void 0};const n=t.match(/\{"type":"vendor_call_summary"[\s\S]*\}$/);if(!n)return{content:t,artifacts:void 0};try{const a=JSON.parse(n[0]);if(a&&a.type==="vendor_call_summary")return{content:t.replace(n[0],"").trim(),artifacts:[a]}}catch(a){console.warn("Failed to parse vendor call summary payload",a)}return{content:t,artifacts:void 0}},ly=t=>{const{content:r,artifacts:n}=Lp(t.type==="text"?t.content:void 0,t.callArtifacts),a=t.type==="summary"?t.summary??t.content:t.type==="text"?r??t.content:t.content;return{id:t.id,role:t.role,type:t.type||(t.role==="user"?"user_text":"text"),content:a,summary:t.summary,task:t.task,link:t.link,info:t.info,chunks:t.chunks,timestamp:t.timestamp,createdAt:t.createdAt,callArtifacts:n??t.callArtifacts}},qp=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(!1),[s,o]=l.useState(!1),[i,c]=l.useState(0),[u,d]=l.useState(null),[p,f]=l.useState([]),[m,j]=l.useState(!1),[v,w]=l.useState(()=>{const Q=localStorage.getItem(ra);if(!Q)return null;const X=Number(Q);return Number.isFinite(X)?X:null}),_=l.useRef(null),P=l.useRef(null),L=l.useRef(null),C=l.useCallback(async Q=>{const X=Q?.activeId??v??null;Q?.quiet||j(!0);try{const I=await ta.listSessions(4,X??void 0);if(f(I),!v&&I.length>0){const y=I[0].id;w(y),localStorage.setItem(ra,String(y))}}catch(I){console.error("Failed to load chat sessions",I)}finally{Q?.quiet||j(!1)}},[v]),D=l.useCallback(async()=>{if(v)return p.length||C({activeId:v,quiet:!0}).catch(()=>{}),v;const Q=await ta.createSession();return localStorage.setItem(ra,String(Q)),w(Q),await C({activeId:Q,quiet:!0}),Q},[v,p.length,C]),A=l.useCallback(Q=>{const X=Q.filter(S=>S.role==="assistant"),I=X.reduce((S,U)=>{const K=typeof U.id=="number"?U.id:Number(U.id);return Number.isFinite(K)&&(S==null||K>S)?K:S},null),y=_.current;if(I!=null){if(y!=null&&I>y&&!s){const S=X.filter(U=>{const K=typeof U.id=="number"?U.id:Number(U.id);return Number.isFinite(K)&&K>y});if(S.length>0){c(K=>K+S.length);const U=S.length===1?"Workspace Copilot posted an update":`Workspace Copilot posted ${S.length} updates`;H.info(U,{toastId:"chat-unread"})}}_.current=I}s&&c(0)},[s]),b=l.useCallback(async Q=>{if(L.current)return L.current;const X=(async()=>{const I=Q?.sessionId??await D();Q?.showSpinner&&a(!0);try{const S=(await ta.fetchMessages(I)).map(ly);r(S),Q?.skipUnreadTracking||A(S)}catch(y){console.error("Failed to load chat history",y),Q?.showSpinner||H.error("Unable to load chat messages.")}finally{Q?.showSpinner&&a(!1),L.current=null}})();return L.current=X,X},[A,D]);l.useEffect(()=>{D().catch(Q=>{console.error("Failed to initialize agent session",Q),H.error("Unable to start AI assistant session.")})},[D]),l.useEffect(()=>{C({activeId:v??void 0,quiet:!0}).catch(Q=>{console.error("Failed to initialize chat sessions",Q)})},[C,v]),l.useEffect(()=>{v&&b({showSpinner:!0}).catch(Q=>{console.error("Failed to load chat history",Q)})},[b,v]),l.useEffect(()=>(P.current&&(clearInterval(P.current),P.current=null),(async()=>{try{await D()}catch(X){console.error("Failed to ensure chat session",X);return}P.current=setInterval(()=>{b().catch(X=>{console.error("Failed to poll chat messages",X)})},iy)})(),()=>{P.current&&(clearInterval(P.current),P.current=null)}),[D,b]);const N=l.useCallback(Q=>{!Q||Q.length===0||r(X=>{const I=[...X,...Q.map((y,S)=>{const U=y.type==="text"?y.content:void 0,{content:K,artifacts:E}=Lp(U,y.callArtifacts);return{id:`${Date.now()}-${S}`,role:"assistant",type:y.type,content:y.type==="text"?K??y.content:y.content,summary:y.summary,task:y.task,link:y.link,info:y.info,chunks:y.chunks,timestamp:y.timestamp??new Date().toISOString(),callArtifacts:E??y.callArtifacts}})];return A(I),I})},[A]),g=l.useCallback(async Q=>{const X=Q.trim();if(!X)return;const I=await D(),y={id:`${Date.now()}-user`,role:"user",type:"user_text",content:X,timestamp:new Date().toISOString()};r(S=>[...S,y]),a(!0);try{const{events:S,plan:U}=await ta.sendMessage(I,X);N(S),d(U??null),await b(),C({activeId:I,quiet:!0})}catch(S){console.error("Error sending message:",S),H.error("Sorry, the Workspace Copilot encountered an error.")}finally{a(!1)}},[N,D,b,C]),x=l.useCallback(()=>{d(null)},[]),R=l.useCallback(async()=>{try{a(!0);const Q=await ta.createSession();return localStorage.setItem(ra,String(Q)),w(Q),r([]),c(0),d(null),_.current=null,await C({activeId:Q}),Q}catch(Q){return console.error("Failed to start new chat session",Q),H.error("Unable to create a new chat right now."),null}finally{a(!1)}},[C]),O=l.useCallback(async Q=>{v!==Q&&(localStorage.setItem(ra,String(Q)),w(Q),r([]),d(null),_.current=null,await C({activeId:Q,quiet:!0}))},[C,v]),ee=l.useCallback(()=>{o(Q=>{const X=!Q;return X&&(c(0),b().catch(()=>{})),X})},[b]),J=l.useCallback(()=>{o(!1)},[]),z=l.useCallback(async()=>{o(!0),c(0),await b()},[b]),Z=l.useCallback(()=>{c(0)},[]);return{messages:t,isLoading:n,isOpen:s,unreadCount:i,sendMessage:g,toggleChat:ee,closeChat:J,openChat:z,acknowledgeMessages:Z,plannerStream:u,clearPlannerStream:x,sessions:p,isFetchingSessions:m,selectSession:O,startNewChat:R,sessionId:v}};var na={},Yc;function cy(){if(Yc)return na;Yc=1;var t=yt();Object.defineProperty(na,"__esModule",{value:!0}),na.default=void 0;var r=t(bt()),n=vt();return na.default=(0,r.default)((0,n.jsx)("path",{d:"M16.59 7.58 10 14.17l-3.59-3.58L5 12l5 5 8-8zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"}),"CheckCircleOutline"),na}var dy=cy();const Vc=st(dy);var sa={},Gc;function uy(){if(Gc)return sa;Gc=1;var t=yt();Object.defineProperty(sa,"__esModule",{value:!0}),sa.default=void 0;var r=t(bt()),n=vt();return sa.default=(0,r.default)((0,n.jsx)("path",{d:"M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"}),"ErrorOutline"),sa}var py=uy();const Yi=st(py);var aa={},Qc;function hy(){if(Qc)return aa;Qc=1;var t=yt();Object.defineProperty(aa,"__esModule",{value:!0}),aa.default=void 0;var r=t(bt()),n=vt();return aa.default=(0,r.default)((0,n.jsx)("path",{d:"M6 2v6h.01L6 8.01 10 12l-4 4 .01.01H6V22h12v-5.99h-.01L18 16l-4-4 4-3.99-.01-.01H18V2zm10 14.5V20H8v-3.5l4-4zm-4-5-4-4V4h8v3.5z"}),"HourglassEmpty"),aa}var my=hy();const Yl=st(my);var oa={},Kc;function fy(){if(Kc)return oa;Kc=1;var t=yt();Object.defineProperty(oa,"__esModule",{value:!0}),oa.default=void 0;var r=t(bt()),n=vt();return oa.default=(0,r.default)((0,n.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2M7 13.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5m5 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5m5 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5"}),"Pending"),oa}var xy=fy();const gy=st(xy);var ia={},Jc;function yy(){if(Jc)return ia;Jc=1;var t=yt();Object.defineProperty(ia,"__esModule",{value:!0}),ia.default=void 0;var r=t(bt()),n=vt();return ia.default=(0,r.default)([(0,n.jsx)("path",{d:"M12 5.99 19.53 19H4.47zM12 2 1 21h22z"},"0"),(0,n.jsx)("path",{d:"M13 16h-2v2h2zm0-6h-2v5h2z"},"1")],"WarningAmber"),ia}var vy=yy();const js=st(vy);var la={},Xc;function by(){if(Xc)return la;Xc=1;var t=yt();Object.defineProperty(la,"__esModule",{value:!0}),la.default=void 0;var r=t(bt()),n=vt();return la.default=(0,r.default)((0,n.jsx)("circle",{cx:"12",cy:"12",r:"8"}),"FiberManualRecord"),la}var _y=by();const jy=st(_y);var ca={},Zc;function wy(){if(Zc)return ca;Zc=1;var t=yt();Object.defineProperty(ca,"__esModule",{value:!0}),ca.default=void 0;var r=t(bt()),n=vt();return ca.default=(0,r.default)((0,n.jsx)("path",{d:"M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6m6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26"}),"Autorenew"),ca}var Sy=wy();const Vi=st(Sy),ed={pending:{icon:e.jsx(gy,{fontSize:"small"}),color:"default",label:"Pending"},in_progress:{icon:e.jsx(Vi,{fontSize:"small"}),color:"info",label:"In progress"},running:{icon:e.jsx(Vi,{fontSize:"small"}),color:"info",label:"In progress"},partial:{icon:e.jsx(js,{fontSize:"small"}),color:"warning",label:"Partial"},partial_success:{icon:e.jsx(js,{fontSize:"small"}),color:"warning",label:"Partial"},completed:{icon:e.jsx(Vc,{fontSize:"small"}),color:"success",label:"Completed"},success:{icon:e.jsx(Vc,{fontSize:"small"}),color:"success",label:"Completed"},timeout:{icon:e.jsx(Yl,{fontSize:"small"}),color:"warning",label:"Timed out"},error:{icon:e.jsx(Yi,{fontSize:"small"}),color:"error",label:"Error"},failed:{icon:e.jsx(Yi,{fontSize:"small"}),color:"error",label:"Error"},failure:{icon:e.jsx(Yi,{fontSize:"small"}),color:"error",label:"Error"},degraded:{icon:e.jsx(js,{fontSize:"small"}),color:"warning",label:"Degraded"},cancelled:{icon:e.jsx(js,{fontSize:"small"}),color:"warning",label:"Cancelled"},canceled:{icon:e.jsx(js,{fontSize:"small"}),color:"warning",label:"Cancelled"},retry:{icon:e.jsx(Vi,{fontSize:"small"}),color:"warning",label:"Retrying"}},_l=t=>{const r=(t||"").trim().toLowerCase();return r&&ed[r]?ed[r]:{icon:e.jsx(jy,{fontSize:"small"}),color:"default",label:t||"Unknown"}},Up=t=>t?t.replace(/[_-]+/g," ").replace(/\b\w/g,r=>r.toUpperCase()):"Subagent",Cy=t=>{if(!t)return!1;const r=t.trim().toLowerCase();return["partial","partial_success","completed","success","error","failed","failure","degraded"].includes(r)},ky={idle:{label:"Idle",color:"default"},connecting:{label:"Connecting",color:"info"},open:{label:"Live",color:"success"},reconnecting:{label:"Reconnecting",color:"warning"},closed:{label:"Closed",color:"default"},error:{label:"Error",color:"error"}},Py=t=>{if(!t)return null;const r=$e(t);return r.isValid()?r.format("MMM D, YYYY h:mm:ss A"):null},So=(t,r)=>{if(r==="default")return{background:t.palette.grey[200],foreground:t.palette.grey[800]};const n=t.palette[r];return{background:n.light,foreground:n.main}},Dy=({subagents:t,connectionState:r,stepStatus:n,plannerContext:a,completedPayload:s,replayComplete:o,lastHeartbeatAt:i,isTerminal:c})=>{const u=ky[r],d=t.length>0,p=Py(i),f=n?_l(n):null;return e.jsx(Ae,{variant:"outlined",sx:{borderRadius:3,borderColor:"divider",px:2.5,py:2,backgroundColor:"background.paper",mb:2},children:e.jsxs(ke,{spacing:2,children:[e.jsxs(ke,{direction:"row",alignItems:"center",justifyContent:"space-between",spacing:2,children:[e.jsxs(ke,{spacing:.5,children:[e.jsx(h,{variant:"subtitle2",sx:{fontWeight:700},children:"Planner progress"}),a?.plan_summary&&e.jsx(h,{variant:"caption",color:"text.secondary",children:a.plan_summary})]}),e.jsxs(ke,{direction:"row",spacing:1,alignItems:"center",children:[!o&&r!=="error"&&r!=="closed"?e.jsx(it,{size:18,thickness:5}):null,e.jsx(De,{size:"small",variant:"outlined",color:u.color,label:u.label})]})]}),p&&e.jsxs(h,{variant:"caption",color:"text.secondary",children:["Last heartbeat: ",p]}),e.jsx(ke,{spacing:1.25,children:d?t.map(m=>{const j=_l(m.status);return e.jsx(Ae,{variant:"outlined",sx:{borderRadius:2,borderColor:"divider",px:1.5,py:1,backgroundColor:"background.default"},children:e.jsxs(ke,{direction:"row",spacing:1.5,alignItems:"center",justifyContent:"space-between",children:[e.jsxs(ke,{direction:"row",spacing:1.25,alignItems:"center",children:[e.jsx(k,{sx:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:28,height:28,borderRadius:"50%",backgroundColor:v=>So(v,j.color).background,color:v=>So(v,j.color).foreground},children:j.icon}),e.jsxs(k,{children:[e.jsx(h,{variant:"body2",sx:{fontWeight:600},children:Up(m.key)}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:[j.label,m.resultKey?`  ${m.resultKey}`:""]})]})]}),m.payload&&Object.keys(m.payload).length>0?e.jsx(Vt,{title:e.jsx("pre",{style:{margin:0},children:JSON.stringify(m.payload,null,2)}),children:e.jsx(De,{size:"small",label:"Payload",variant:"outlined"})}):null]})},m.key)}):e.jsx(h,{variant:"body2",color:"text.secondary",children:"Waiting for planner updates"})}),f&&e.jsxs(ke,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(k,{sx:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:28,height:28,borderRadius:"50%",backgroundColor:m=>So(m,f.color).background,color:m=>So(m,f.color).foreground},children:f.icon}),e.jsxs(h,{variant:"body2",sx:{fontWeight:600},children:["Step status: ",f.label]})]}),c&&s&&Object.keys(s).length>0&&e.jsxs(Ae,{variant:"outlined",sx:{borderRadius:2,borderColor:"divider",backgroundColor:"background.default",px:1.5,py:1},children:[e.jsx(h,{variant:"caption",color:"text.secondary",sx:{fontWeight:600},children:"Final payload"}),e.jsx(h,{variant:"body2",sx:{mt:.5,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:s.summary??JSON.stringify(s,null,2)})]})]})})},td=(t,r)=>{if(r==="default")return{background:t.palette.grey[200],foreground:t.palette.grey[800]};const n=t.palette[r];return{background:n.light,foreground:n.main}},Ey=({update:t,onAcknowledge:r,onDismiss:n,disabled:a=!1,actionState:s})=>{const o=_l(t.status),i=$e(t.timestamp),c=i.isValid()?i.format("MMM D, YYYY h:mm A"):null,u=t.summary||t.message||t.payload?.summary,d=t.payload?.details||t.payload?.description||t.payload?.notes,p=!!s?.acknowledged,f=!!s?.dismissed,m=s?.pendingAction,j=s?.error,v=a||f||p||m==="dismiss"||m==="ack",w=a||f||p||m==="ack"||m==="dismiss",_=t.payload&&Object.keys(t.payload).length>0?e.jsx(Vt,{title:e.jsx("pre",{style:{margin:0,maxWidth:320,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:JSON.stringify(t.payload,null,2)}),placement:"top",arrow:!0,children:e.jsx(De,{size:"small",variant:"outlined",label:"Payload"})}):null;return e.jsx(nl,{in:!0,timeout:300,children:e.jsx(Ae,{variant:"outlined",sx:{borderRadius:3,borderColor:f?"error.light":"divider",backgroundColor:f?"error.lighter":"background.paper",px:2.5,py:2},children:e.jsxs(ke,{spacing:1.5,children:[e.jsxs(ke,{direction:"row",alignItems:"center",justifyContent:"space-between",spacing:1.5,children:[e.jsxs(ke,{direction:"row",spacing:1.25,alignItems:"center",children:[e.jsx(k,{sx:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:32,height:32,borderRadius:"50%",backgroundColor:P=>td(P,o.color).background,color:P=>td(P,o.color).foreground},children:o.icon}),e.jsxs(ke,{children:[e.jsx(h,{variant:"subtitle2",sx:{fontWeight:700},children:Up(t.stageKey)}),e.jsxs(ke,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(De,{size:"small",color:o.color,label:o.label,variant:"outlined"}),t.revision!=null&&e.jsx(De,{size:"small",label:`Revision ${t.revision}`,variant:"outlined"}),typeof t.retryCount=="number"&&t.retryCount>0&&e.jsx(De,{size:"small",color:"warning",label:`Retry ${t.retryCount}`,variant:"outlined"}),_]})]})]}),c&&e.jsx(h,{variant:"caption",color:"text.secondary",children:c})]}),u&&e.jsx(h,{variant:"body2",sx:{whiteSpace:"pre-wrap",lineHeight:1.6},children:u}),d&&e.jsx(h,{variant:"body2",color:"text.secondary",sx:{whiteSpace:"pre-wrap"},children:d}),e.jsxs(ke,{direction:"row",spacing:1,children:[e.jsx(G,{size:"small",variant:p?"contained":"outlined",color:"success",disabled:v,onClick:r,sx:{textTransform:"none",borderRadius:999,px:2},children:p?"Acknowledged":m==="ack"?"Acknowledging":"Acknowledge"}),e.jsx(G,{size:"small",variant:f?"contained":"outlined",color:"error",disabled:w,onClick:n,sx:{textTransform:"none",borderRadius:999,px:2},children:f?"Dismissed":m==="dismiss"?"Dismissing":"Dismiss"})]}),j&&e.jsx(h,{variant:"caption",color:"error",children:j})]})})})},Iy=(t,r)=>{const n=t.content?.resultKey??t.content?.result_key??t.content?.result??t.content?.resultId??t.content?.result_id??r;return String(n??r)},Ty=t=>{const r=t.content?.revision??t.content?.rev;if(typeof r=="number"&&Number.isFinite(r))return r},Oy=t=>{const r=t.content?.retry_count??t.content?.retryCount;if(typeof r=="number"&&r>=0)return r},Ay=(t,r,n)=>`${t}::${r||"default"}::${n??"latest"}`,My=t=>{if(!Array.isArray(t)||t.length===0)return[];const r=new Map;for(const n of t){if(n.type!=="subagent_result"&&n.type!=="plan_step_completed")continue;const a=n.content?.stage??n.content?.subagent??n.content?.key??n.content?.agent,s=a?String(a):"planner",o=Iy(n,s),i=Ty(n),c=Ay(n.planStepId,o,i),u=typeof n.content?.summary=="string"?n.content.summary:typeof n.content?.description=="string"?n.content.description:typeof n.content?.headline=="string"?n.content.headline:void 0,d=typeof n.content?.message=="string"?n.content.message:void 0,p=n.content?.payload&&typeof n.content.payload=="object"?n.content.payload:void 0,f=Oy(n),m={id:c,planStepId:n.planStepId,stageKey:s,resultKey:o,revision:i,status:typeof n.content?.status=="string"?n.content.status:void 0,summary:u??(p?.summary&&typeof p.summary=="string"?p.summary:void 0),message:d,payload:p??null,telemetry:n.telemetry,timestamp:n.timestamp,sequence:n.sequence,retryCount:f},j=r.get(c);(!j||m.sequence>=j.sequence)&&r.set(c,m)}return Array.from(r.values()).sort((n,a)=>n.sequence-a.sequence)},Wp=(t,r)=>{const n={};return t&&(typeof t.trace_id=="string"&&(n["x-trace-id"]=t.trace_id),typeof t.traceId=="string"&&(n["x-trace-id"]=t.traceId),typeof t.span_id=="string"&&(n["x-span-id"]=t.span_id),typeof t.spanId=="string"&&(n["x-span-id"]=t.spanId),typeof t.parent_span_id=="string"&&(n["x-parent-span-id"]=t.parent_span_id)),r!=null&&(n["x-sequence"]=String(r)),n},Fp=t=>({resultKey:t.resultKey,revision:t.revision??null}),Ry=async t=>{const{sessionId:r,planStepId:n}=t;await B.patch(`/api/planner/sessions/${encodeURIComponent(r)}/steps/${encodeURIComponent(n)}/ack`,Fp(t),{headers:Wp(t.telemetry,t.sequence)})},Ny=async t=>{const{sessionId:r,planStepId:n}=t;await B.patch(`/api/planner/sessions/${encodeURIComponent(r)}/steps/${encodeURIComponent(n)}/dismiss`,Fp(t),{headers:Wp(t.telemetry,t.sequence)})},Ly=async t=>{const{sessionId:r,planStepId:n,after:a,limit:s}=t,o={};return a!=null&&(o.after=String(a)),typeof s=="number"&&(o.limit=String(s)),(await B.get(`/api/planner/sessions/${encodeURIComponent(r)}/steps/${encodeURIComponent(n)}/events`,{params:o})).data},jl={acknowledge:Ry,dismiss:Ny,fetchReplay:Ly},rd=({action:t,details:r={},level:n="info",error:a})=>{({...r,timestamp:new Date().toISOString()})},da={action(t,r){rd({action:t,details:r,level:"info"})},error(t,r,n){rd({action:t,details:n,level:"error",error:r})}},qy=({sessionId:t,planStepId:r,events:n})=>{const a=t!=null?String(t):void 0,s=r!=null?String(r):void 0,o=l.useMemo(()=>My(n),[n]),[i,c]=l.useState({});l.useEffect(()=>{c(d=>{const p={};for(const f of o)p[f.id]=d[f.id]??{pendingAction:null,acknowledged:!1,dismissed:!1,error:null};return p})},[o]);const u=l.useCallback(async(d,p)=>{if(c(m=>({...m,[d.id]:{...m[d.id],pendingAction:p,error:null}})),!a||!s){c(m=>({...m,[d.id]:{...m[d.id],pendingAction:null,error:"Planner session is unavailable. Please retry after the stream reconnects."}}));return}const f={sessionId:a,planStepId:s,resultKey:d.resultKey,revision:d.revision??null,sequence:d.sequence,status:d.status,stageKey:d.stageKey};try{p==="ack"?(da.action("planner_ui.ack_start",f),await jl.acknowledge({sessionId:a,planStepId:s,resultKey:d.resultKey,revision:d.revision,telemetry:d.telemetry,sequence:d.sequence}),da.action("planner_ui.ack_success",f)):(da.action("planner_ui.dismiss_start",f),await jl.dismiss({sessionId:a,planStepId:s,resultKey:d.resultKey,revision:d.revision,telemetry:d.telemetry,sequence:d.sequence}),da.action("planner_ui.dismiss_success",f)),c(m=>({...m,[d.id]:{...m[d.id],pendingAction:null,acknowledged:p==="ack"?!0:m[d.id]?.acknowledged,dismissed:p==="dismiss"?!0:m[d.id]?.dismissed,error:null}}))}catch(m){da.error(p==="ack"?"planner_ui.ack_error":"planner_ui.dismiss_error",m,f),c(j=>({...j,[d.id]:{...j[d.id],pendingAction:null,error:p==="ack"?"Failed to acknowledge update. Please try again.":"Failed to dismiss update. Please try again."}}))}},[a,s]);return o.length===0?null:e.jsxs(ke,{spacing:1.5,sx:{mb:2},children:[e.jsx(h,{variant:"subtitle2",sx:{fontWeight:700,color:"text.secondary",pl:.5},children:"Planner updates"}),o.map(d=>{const p=i[d.id],f=!a||!s,m=Cy(d.status),j=f||!m;return e.jsx(Ey,{update:d,disabled:j,onAcknowledge:()=>u(d,"ack"),onDismiss:()=>u(d,"dismiss"),actionState:p},d.id)})]})},Uy={events:[],subagentsByKey:{},subagentOrder:[],plannerContext:void 0,stepStatus:void 0,completedPayload:void 0,lastSequence:void 0},Os=()=>new Date().toISOString(),Wy=t=>{if(!t||typeof t!="object")return null;const r=t.key??t.subagent??t.stage;return!r||typeof r!="string"?null:{key:r,resultKey:t.resultKey??t.result_key??null}},wl=t=>{if(t==null)return t===null?null:void 0;if(typeof t=="object")return t},Sl=(t,r,n)=>{if(!r||r.length===0)return t;const a={},s=[],o=t.subagentsByKey;for(const i of r){if(!i?.key)continue;const c=String(i.key);s.push(c);const u=o[c];a[c]={key:c,status:u?.status??"pending",resultKey:i.resultKey??u?.resultKey??null,payload:u?.payload??null,revision:u?.revision,lastUpdated:u?.lastUpdated??n,telemetry:u?.telemetry}}for(const i of Object.keys(o))a[i]||(a[i]=o[i],s.push(i));return{...t,subagentsByKey:a,subagentOrder:s}},Fy=(t,r)=>{if(!r||r.length===0)return t;let n={...t},a=t.events.slice(),s=t.subagentOrder.slice(),o={...t.subagentsByKey},i=t.plannerContext,c=t.stepStatus,u=t.completedPayload,d=t.lastSequence;const p=f=>{s.includes(f)||s.push(f)};for(const f of r)if(Number.isFinite(f.sequence)&&!a.some(m=>m.sequence===f.sequence)){if(a.push(f),d=f.sequence,f.type==="step_started"){const m=f.content?.expected_subagents??f.content?.expectedSubagents??[],j=Array.isArray(m)?m.map(Wy).filter(Boolean):[],v=wl(f.content?.planner_context??f.content?.plannerContext);if(v!==void 0&&(i=v),c=typeof f.content?.status=="string"?f.content.status:c,j.length>0){const w=Sl({...n,events:a,subagentOrder:s,subagentsByKey:o},j,f.timestamp||Os());o=w.subagentsByKey,s=w.subagentOrder}continue}if(f.type==="subagent_result"){const m=f.content?.stage??f.content?.subagent??f.content?.key;if(m){const v=String(m);p(v);const w=o[v],_=f.content?.payload,P=f.content?.resultKey??f.content?.result_key??w?.resultKey??null;o={...o,[v]:{key:v,status:typeof f.content?.status=="string"?f.content.status:w?.status??"pending",resultKey:P,payload:_&&typeof _=="object"?_:w?.payload??null,revision:typeof f.content?.revision=="number"?f.content.revision:w?.revision,lastUpdated:f.timestamp||Os(),telemetry:Object.keys(f.telemetry||{}).length?f.telemetry:w?.telemetry}}}const j=f.content?.overall_status??f.content?.status;typeof j=="string"&&(c=j);continue}if(f.type==="plan_step_completed"){typeof f.content?.status=="string"&&(c=f.content.status);const m=f.content?.payload;m&&typeof m=="object"&&(u=m);continue}typeof f.content?.status=="string"&&(c=f.content.status)}return a.sort((f,m)=>f.sequence-m.sequence),n={events:a,subagentsByKey:o,subagentOrder:s,plannerContext:i,stepStatus:c,completedPayload:u,lastSequence:d},n},$y=(t,r)=>{switch(r.type){case"reset":{const n=wl(r.plannerContext),a={events:[],subagentsByKey:{},subagentOrder:[],plannerContext:n,stepStatus:void 0,completedPayload:void 0,lastSequence:void 0};return r.expected&&r.expected.length>0?Sl(a,r.expected,Os()):a}case"hydrateExpected":{const n=wl(r.plannerContext),a=Sl(t,r.expected,Os());return n!==void 0?{...a,plannerContext:n}:a}case"append":return Fy(t,r.events);default:return t}},zy=(t,r)=>{const a=(B.defaults.baseURL??"").replace(/\/$/,""),s=`/api/planner/sessions/${encodeURIComponent(t)}/stream?planStepId=${encodeURIComponent(r)}`;return a?`${a}${s}`:s},nd=t=>{if(!t)return null;const r=t.split(/\r?\n/),n={},a=[];for(const s of r)if(s.trim()){if(s.startsWith("id:")){n.id=s.slice(3).trim();continue}if(s.startsWith("event:")){n.event=s.slice(6).trim();continue}if(s.startsWith("data:")){a.push(s.slice(5).trimStart());continue}}if(a.length>0){const s=a.join(`
`);if(s)try{n.data=JSON.parse(s)}catch{n.data=s}}return!n.id&&!n.event&&a.length===0?null:n},sd=t=>{if(!t||typeof t!="object")return null;const r=Number(t.sequence??t.seq??t.id);if(!Number.isFinite(r))return null;const n=String(t.session_id??t.sessionId??""),a=String(t.plan_step_id??t.planStepId??"");if(!a)return null;const s=typeof t.timestamp=="string"?t.timestamp:Os(),o=t.content&&typeof t.content=="object"?t.content:{},i=t.telemetry&&typeof t.telemetry=="object"?t.telemetry:{};return{sessionId:n,planStepId:a,sequence:r,type:String(t.type??""),timestamp:s,content:o,telemetry:i}},ad=t=>{if(!t)return!1;const r=t.trim().toLowerCase();return["success","completed","complete","error","failed","failure","cancelled","timeout","partial_failure","degraded"].includes(r)},By=t=>{const{sessionId:r,planStepId:n,enabled:a=!0,initialCursor:s,expectedSubagents:o,plannerContext:i,stopOnCompletion:c=!0,onStepCompleted:u}=t,d=r!=null?String(r):void 0,p=n!=null?String(n):void 0,[f,m]=l.useReducer($y,Uy),[j,v]=l.useState("idle"),[w,_]=l.useState(null),[P,L]=l.useState(!1),[C,D]=l.useState(null),A=l.useRef(s!=null?String(s):null),b=l.useRef(null),N=l.useRef(null),g=l.useRef(!1),x=l.useRef(0),R=l.useRef(!1),O=l.useRef(!1),ee=l.useCallback(()=>{m({type:"reset",expected:o,plannerContext:i}),A.current=s!=null?String(s):null,L(!1),D(null),R.current=!1,O.current=!1},[o,i,s]);l.useEffect(()=>{ee()},[ee,d,p]),l.useEffect(()=>{(o||i!==void 0)&&m({type:"hydrateExpected",expected:o,plannerContext:i})},[o,i]),l.useEffect(()=>{O.current=P},[P]);const J=()=>{N.current&&(clearTimeout(N.current),N.current=null)},z=l.useCallback(()=>{g.current=!1,J(),b.current?.abort(),b.current=null,v(U=>U==="idle"?U:"closed")},[]);l.useEffect(()=>()=>{g.current=!1,J(),b.current?.abort()},[]);const Z=l.useCallback(()=>{if(!g.current)return;const U=x.current,K=Math.min(1e3*Math.pow(2,U),15e3);x.current=U+1,J(),N.current=setTimeout(()=>{N.current=null,I(!0)},K)},[]),Q=l.useCallback((U,K)=>{if(!R.current&&(R.current=!0,c&&z(),u))try{u(U,K??null)}catch{}},[u,z,c]),X=l.useCallback(U=>{if(!U)return;if(U.id&&(A.current=U.id),U.event==="heartbeat"){D(Os()),P||L(!0);return}if(U.event==="error"){const E=typeof U.data=="string"?U.data:U.data?.message;_(E||"Planner stream reported an error"),v("error");return}if(U.event!=="planner_stream")return;const K=U.data;if(!(!K||typeof K!="object")&&K.type==="event_batch"){const E=Array.isArray(K.events)?K.events.map(sd).filter(Boolean):[];E.length>0&&(m({type:"append",events:E}),P||L(!0))}},[P]),I=l.useCallback(async(U=!1)=>{if(!d||!p||!a)return;b.current&&(b.current.abort(),b.current=null),J(),g.current=!0,x.current=U?x.current:0,v(U?"reconnecting":"connecting"),_(null);const K=new AbortController;b.current=K;const E=zy(d,p),V={Accept:"text/event-stream"},q=localStorage.getItem("sessionToken");q&&(V.Authorization=`Bearer ${q}`);const ue=localStorage.getItem("deviceId");ue&&(V["x-device-id"]=ue);try{const ye=Intl.DateTimeFormat().resolvedOptions().timeZone;ye&&(V["x-timezone"]=ye)}catch{}A.current&&(V["Last-Event-ID"]=A.current);try{if(!O.current)try{const he=await jl.fetchReplay({sessionId:d,planStepId:p,after:A.current,limit:200}),ae=Array.isArray(he?.events)?he.events.map(sd).filter(Boolean):[];he?.next_cursor&&(A.current=String(he.next_cursor)),ae.length>0&&m({type:"append",events:ae}),L(!0),O.current=!0}catch{}const ye=await fetch(E,{method:"GET",headers:V,credentials:"include",signal:K.signal});if(!ye.ok)throw new Error(`Planner stream failed with status ${ye.status}`);const ge=ye.body?.getReader();if(!ge)throw new Error("Planner stream response is missing a readable body");v("open"),x.current=0;const xe=new TextDecoder("utf-8");let me="";for(;g.current;){const{value:he,done:ae}=await ge.read();if(ae)break;me+=xe.decode(he,{stream:!0});let T=me.indexOf(`

`);for(;T!==-1;){const $=me.slice(0,T);me=me.slice(T+2);const ce=nd($);ce&&X(ce),T=me.indexOf(`

`)}}if(me.trim()){const he=nd(me.trim());he&&X(he)}v("closed")}catch(ye){if(K.signal.aborted)return;const ge=ye instanceof Error?ye.message:"Unknown planner stream error";_(ge),v("error")}finally{b.current=null,g.current&&Z()}},[d,p,a,X,Z]);l.useEffect(()=>{if(!d||!p||!a){z();return}return I(!1),()=>{z()}},[d,p,a,I,z]),l.useEffect(()=>{ad(f.stepStatus)&&Q(f.stepStatus,f.completedPayload??null)},[f.stepStatus,f.completedPayload,Q]);const y=l.useCallback(()=>{!d||!p||(z(),I(!1))},[I,z,d,p]),S=l.useMemo(()=>f.subagentOrder.map(U=>f.subagentsByKey[U]).filter(Boolean),[f.subagentOrder,f.subagentsByKey]);return{connectionState:j,error:w,events:f.events,subagents:S,subagentsByKey:f.subagentsByKey,stepStatus:f.stepStatus,plannerContext:f.plannerContext??null,completedPayload:f.completedPayload??null,replayComplete:P,lastHeartbeatAt:C,lastEventId:A.current,isTerminal:ad(f.stepStatus),stop:z,restart:y}},Hy=t=>typeof t=="string"?t.trim().toLowerCase():typeof t=="boolean"?t?"true":"false":t==null?"":String(t).trim().toLowerCase(),Yy=new Set(["1","true","yes","on"]),Vy=()=>{const t=window?.__AI_ENABLE_AGGREGATOR_STREAMING,r=Hy(t);return Yy.has(r)},Gy=({variant:t="drawer",onClose:r,sx:n})=>{const{messages:a,isLoading:s,sendMessage:o,acknowledgeMessages:i,plannerStream:c,sessions:u,isFetchingSessions:d,selectSession:p,startNewChat:f,sessionId:m}=qp(),j=l.useRef(null),v=t==="embedded",w=Vy(),_=u.find(O=>O.id===m)??null,P=u.filter(O=>O.id!==m).slice(0,3),L=By({sessionId:c?.sessionId,planStepId:c?.planStepId,initialCursor:c?.cursor??null,expectedSubagents:c?.expectedSubagents,plannerContext:c?.plannerContext??null,enabled:w&&!!c?.planStepId}),C=w&&!!c?.planStepId;l.useEffect(()=>{j.current?.scrollIntoView({behavior:"smooth"})},[a]),l.useEffect(()=>{v&&i()},[i,v,a.length]);const D=()=>{window.confirm("Start a new chat? Your current conversation summary will remain available in history.")&&f()},A=O=>e.jsxs(G,{variant:"outlined",size:"small",onClick:()=>{p(O.id)},sx:{textTransform:"none",borderRadius:2,borderColor:"divider",px:1.5,py:1,maxWidth:220,display:"flex",flexDirection:"column",alignItems:"flex-start",gap:.5},children:[e.jsx(h,{variant:"body2",sx:{fontWeight:600,maxWidth:"100%",overflow:"hidden",textOverflow:"ellipsis"},children:O.title}),e.jsx(h,{variant:"caption",color:"text.secondary",sx:{maxWidth:"100%",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:O.preview||"No replies yet"})]},O.id),b=()=>{j.current?.scrollIntoView({behavior:"smooth"})},N={width:"100%",display:"flex",flexDirection:"column",borderRadius:v?3:0,overflow:"hidden",bgcolor:"background.paper",boxShadow:v?"0 12px 32px rgba(15, 23, 42, 0.16)":"none",border:"1px solid",borderColor:v?"divider":"transparent",minHeight:v?{xs:320,md:380}:"auto",maxHeight:v?{xs:"60vh",md:520}:"none"},g={px:{xs:2.5,sm:3},py:2.25,display:"flex",alignItems:{xs:"flex-start",sm:"center"},flexDirection:{xs:"column",sm:"row"},gap:{xs:2,sm:3},justifyContent:"space-between",borderBottom:"1px solid",borderColor:"divider",backgroundColor:O=>v?O.palette.background.paper:O.palette.background.default},x={flex:1,overflow:"auto",px:{xs:2.25,sm:3},py:2.5,display:"flex",flexDirection:"column",gap:2,backgroundColor:O=>O.palette.background.default},R=v?Ae:k;return e.jsxs(R,{sx:{...N,...n},children:[e.jsxs(k,{sx:g,children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2.5},children:[e.jsx(Nn,{sx:{bgcolor:"primary.main",color:"common.white",width:48,height:48,boxShadow:"0 10px 24px rgba(33, 150, 243, 0.28)"},children:e.jsx(Al,{fontSize:"small"})}),e.jsxs(k,{children:[e.jsx(h,{variant:"h6",sx:{fontWeight:700},children:"Workspace Copilot"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Ask about anything in your workspace for instant help."}),e.jsxs(ke,{spacing:1.25,sx:{mt:1.5},children:[e.jsxs(ke,{direction:"row",alignItems:"center",spacing:1,children:[e.jsx(h,{variant:"caption",color:"text.secondary",sx:{fontWeight:600,letterSpacing:.4},children:"Current chat"}),e.jsx(De,{label:_?.title||"New conversation",color:"primary",size:"small",sx:{maxWidth:240,"& .MuiChip-label":{overflow:"hidden",textOverflow:"ellipsis"}}}),d&&e.jsx(it,{size:14})]}),e.jsxs(ke,{spacing:1,children:[e.jsxs(ke,{direction:"row",alignItems:"center",spacing:1,children:[e.jsx(h,{variant:"caption",color:"text.secondary",sx:{fontWeight:600,letterSpacing:.4},children:"Recent chats"}),P.length===0&&e.jsx(h,{variant:"caption",color:"text.disabled",children:"You have no previous chats yet."})]}),P.length>0&&e.jsx(ke,{direction:"row",spacing:1,flexWrap:"wrap",useFlexGap:!0,children:P.map(O=>A(O))})]})]})]})]}),e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1.25},children:[e.jsx(Vt,{title:"Jump to latest",children:e.jsx(gt,{onClick:b,size:"small",sx:{bgcolor:"background.paper",border:"1px solid",borderColor:"divider","&:hover":{bgcolor:"grey.50"}},children:e.jsx(Mh,{fontSize:"small"})})}),e.jsx(Vt,{title:"Start a new chat thread",children:e.jsx(G,{variant:"outlined",size:"small",onClick:D,sx:{textTransform:"none",fontWeight:600,px:1.75,borderRadius:999,borderColor:"divider"},children:"New chat"})}),r&&e.jsx(Vt,{title:"Close",children:e.jsx(gt,{onClick:r,size:"small",sx:{bgcolor:"background.paper",border:"1px solid",borderColor:"divider","&:hover":{bgcolor:"grey.50"}},children:e.jsx(Rh,{fontSize:"small"})})})]})]}),e.jsxs(k,{sx:x,children:[C&&e.jsx(Dy,{subagents:L.subagents,connectionState:L.connectionState,stepStatus:L.stepStatus,plannerContext:L.plannerContext,completedPayload:L.completedPayload,replayComplete:L.replayComplete,lastHeartbeatAt:L.lastHeartbeatAt,isTerminal:L.isTerminal}),C&&e.jsx(qy,{sessionId:c?.sessionId,planStepId:c?.planStepId,events:L.events}),a.length===0?e.jsxs(k,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",textAlign:"center",color:"text.secondary",gap:1.5,borderRadius:3,border:"1px dashed",borderColor:"divider",mx:"auto",p:4,maxWidth:320,bgcolor:"background.paper"},children:[e.jsx(h,{variant:"h6",sx:{fontWeight:600},children:"Start a fresh conversation"}),e.jsx(h,{variant:"body2",sx:{color:"text.secondary"},children:"Ask about inventory, customers, orders, or time tracking."})]}):e.jsxs(e.Fragment,{children:[a.map(O=>e.jsx(Yg,{message:O},O.id)),s&&e.jsx(k,{sx:{display:"flex",justifyContent:"flex-start",mb:1},children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1.5,px:2,py:1.25,bgcolor:"background.paper",borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsx(it,{size:16,thickness:5}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Crafting a response"})]})}),e.jsx("div",{ref:j})]})]}),e.jsx(xr,{}),e.jsx(Op,{onSendMessage:o,disabled:s,placeholder:"Ask me anything about your business..."})]})},Qy=({isOpen:t,onClose:r})=>e.jsx(sl,{anchor:"right",open:t,onClose:r,sx:{"& .MuiDrawer-paper":{width:{xs:"100%",sm:400,md:460},maxWidth:"100vw",height:"100%",display:"flex",flexDirection:"column",borderLeft:{sm:"1px solid",xs:"none"},borderColor:"divider",bgcolor:"background.default"}},children:e.jsx(Gy,{onClose:r})}),Xa=async()=>{try{const t=await window?.api?.timeEvents?.pendingCount?.();return t?.success?t.count:0}catch{return 0}},Ky=async(t=200)=>{const r=await window?.api?.timeEvents?.listPending?.(t);return r?.success?r.rows:[]},od=async()=>{const t=await Ky(200);let r=0,n=0;const a=[];for(const s of t)try{const o=JSON.parse(s.payload_json||"{}");switch(s.type){case"attendance_clock_in":await B.post("/api/attendance/clock-in",{profile_id:o.profile_id});break;case"attendance_clock_out":await B.post("/api/attendance/clock-out",{shift_id:o.shift_id});break;case"attendance_update":await B.put(`/api/attendance/${o.shift_id}`,{clock_in:o.clock_in,clock_out:o.clock_out});break;case"time_clock_in":await B.post("/api/time-tracking/time-entries/clock-in",{profile_id:o.profile_id,so_id:o.so_id});break;case"time_clock_out":await B.post(`/api/time-tracking/time-entries/${o.id}/clock-out`);break;default:n++;continue}a.push(s.event_id),r++}catch{n++}return a.length&&await window?.api?.timeEvents?.markSynced?.(a),{synced:r,failed:n}},gs=240,Jy=()=>{const[t,r]=It.useState(!1),n=Kt(),a=cn(),{logout:s,user:o}=Zt(),{isOpen:i,toggleChat:c,closeChat:u,unreadCount:d}=qp(),{unreadConversationCount:p}=Ip(),[f,m]=l.useState(0);l.useEffect(()=>{let A=!0;const b=async()=>{try{const g=await Xa();A&&m(g)}catch{}},N=setInterval(b,15e3);return b(),()=>{A=!1,clearInterval(N)}},[]);const j=()=>{r(!t)},v=()=>{s(),n("/login")},w=A=>"type"in A&&A.type==="header",_=l.useMemo(()=>({text:"Messages",icon:e.jsx(Tu,{}),path:"/messaging",showUnreadDot:p>0}),[p]),P=A=>A,L=l.useMemo(()=>[{type:"header",text:"Dashboard"},{text:"Dashboard",icon:e.jsx(al,{}),path:"/dashboard"},{text:"Tasks",icon:e.jsx(ec,{}),path:"/tasks"},_,{type:"header",text:"Purchasing"},{text:"Purchase Orders",icon:e.jsx(ks,{}),path:"/open-purchase-orders"},{text:"Return Orders",icon:e.jsx(Yo,{}),path:"/return-orders"},{text:"Parts to Order",icon:e.jsx(Fr,{}),path:"/parts-to-order"},{text:"Vendors",icon:e.jsx(Au,{}),path:"/vendors"},{type:"header",text:"Sales"},{text:"Quotes",icon:e.jsx(ol,{}),path:"/quotes"},{text:"Sales Orders",icon:e.jsx(Ps,{}),path:"/open-sales-orders"},{text:"Customers",icon:e.jsx(to,{}),path:"/customers"},{type:"header",text:"Products & Inventory"},{text:"Products",icon:e.jsx(Mu,{}),path:"/products"},{text:"Stock",icon:e.jsx(Fr,{}),path:"/inventory"},{text:"Supply",icon:e.jsx(Fr,{}),path:"/supply"},{type:"header",text:"Time Tracking"},{text:"Attendance",icon:e.jsx(Qn,{}),path:"/attendance"},{text:"Time Tracking",icon:e.jsx(Qn,{}),path:"/time-tracking"},{text:"Time Tracking Reports",icon:e.jsx(Ru,{}),path:"/time-tracking/reports"},{type:"header",text:"Human Resources"},{text:"Employees",icon:e.jsx(Nu,{}),path:"/employees"},{text:"Profile Documents",icon:e.jsx(Nh,{}),path:"/profile-documents"},{text:"Leave Management",icon:e.jsx(Lu,{}),path:"/leave-management"},{text:"Mobile User Access",icon:e.jsx(to,{}),path:"/mobile-user-access"},{type:"header",text:"Settings"},{text:"Business Profile",icon:e.jsx(Rl,{}),path:"/business-profile"},{text:"Accounting",icon:e.jsx(Vo,{}),path:"/qbo-account-mapping"},{text:"Global Variables",icon:e.jsx(Vo,{}),path:"/margin-schedule"},{text:"Email Settings",icon:e.jsx(Go,{}),path:"/email-settings"},{text:"Backup Management",icon:e.jsx(Nl,{}),path:"/backup-management"}],[_]),C=It.useMemo(()=>{if(o?.access_role==="Time Tracking")return[{type:"header",text:"Dashboard"},{text:"Attendance",icon:e.jsx(Qn,{}),path:"/attendance"},{text:"Time Tracking",icon:e.jsx(Qn,{}),path:"/time-tracking"},_,{type:"header",text:"Sales"},{text:"Sales Orders",icon:e.jsx(Ps,{}),path:"/open-sales-orders"}];const A=[{type:"header",text:"Main"},{text:"Dashboard",icon:e.jsx(al,{}),path:"/"},{text:"Tasks",icon:e.jsx(ec,{}),path:"/tasks"},_];return o?.access_role==="Sales and Purchase"?[...A,{type:"header",text:"Sales & Purchase"},{text:"Sales Orders",icon:e.jsx(Ps,{}),path:"/open-sales-orders"},{text:"Purchase Orders",icon:e.jsx(ks,{}),path:"/open-purchase-orders"},{text:"Return Orders",icon:e.jsx(Yo,{}),path:"/return-orders"},{text:"Parts to Order",icon:e.jsx(Fr,{}),path:"/parts-to-order"},{type:"header",text:"Inventory"},{text:"Stock",icon:e.jsx(Fr,{}),path:"/inventory"},{text:"Supply",icon:e.jsx(Fr,{}),path:"/supply"},{type:"header",text:"Settings"},{text:"Email Settings",icon:e.jsx(Go,{}),path:"/email-settings"}]:L},[o,L,_]),D=e.jsxs("div",{children:[e.jsx(Ni,{}),e.jsx(Pr,{children:C.map((A,b)=>{if(w(A))return e.jsx(Lh,{sx:{bgcolor:"inherit",color:"text.secondary",fontWeight:"bold",fontSize:13,textAlign:"left",pl:2},children:A.text},`header-${A.text}-${b}`);const N=A;return e.jsxs(Mr,{onClick:()=>{const g=P(N.path);a.pathname!==g&&n(g),r(!1)},sx:{cursor:"pointer"},children:[e.jsx(Ou,{children:N.showUnreadDot?e.jsx(ii,{color:"error",variant:"dot",overlap:"circular",children:N.icon}):N.icon}),e.jsx(fr,{primary:N.text,primaryTypographyProps:N.showUnreadDot?{fontWeight:600}:void 0})]},N.path||`${N.text}-${b}`)})})]});return e.jsxs(k,{sx:{display:"flex"},children:[e.jsx(qh,{position:"fixed",sx:{width:{sm:`calc(100% - ${gs}px)`},ml:{sm:`${gs}px`}},children:e.jsxs(Ni,{children:[e.jsx(G,{color:"inherit",startIcon:e.jsx(qu,{}),onClick:()=>n(-1),sx:{mr:2,display:{xs:"none",sm:"inline-flex"}},children:"Back"}),e.jsx(gt,{color:"inherit","aria-label":"open drawer",edge:"start",onClick:j,sx:{mr:2,display:{sm:"none"}},children:e.jsx(Uh,{})}),e.jsxs(k,{sx:{marginLeft:"auto",display:"flex",alignItems:"center",gap:2},children:[!!window.__backendUnavailableSince&&e.jsx(Vt,{title:"Backend unavailable; pending events will sync automatically when online.",children:e.jsxs(k,{sx:{bgcolor:"orange",color:"black",px:1.5,py:.5,borderRadius:1,fontSize:12},children:["Offline",f?`  Pending: ${f}`:""]})}),e.jsx(G,{color:"inherit",onClick:v,startIcon:e.jsx(Wh,{}),children:"Logout"})]})]})}),e.jsxs(k,{component:"nav",sx:{width:{sm:gs},flexShrink:{sm:0}},children:[e.jsx(sl,{variant:"temporary",open:t,onClose:j,ModalProps:{keepMounted:!0},sx:{display:{xs:"block",sm:"none"},"& .MuiDrawer-paper":{boxSizing:"border-box",width:gs}},children:D}),e.jsx(sl,{variant:"permanent",sx:{display:{xs:"none",sm:"block"},"& .MuiDrawer-paper":{boxSizing:"border-box",width:gs}},open:!0,children:D})]}),e.jsxs(k,{component:"main",sx:{flexGrow:1,p:3,width:{sm:`calc(100% - ${gs}px)`}},children:[e.jsx(Ni,{}),e.jsx(df,{})]}),e.jsx(Dg,{onClick:c,isOpen:i,unreadCount:d}),e.jsx(Qy,{isOpen:i,onClose:u})]})},Xy=()=>{const t=Kt(),{login:r}=Zt(),[n,a]=l.useState({email:"",password:""}),[s,o]=l.useState(null),[i,c]=l.useState(!1),[u,d]=l.useState(!1);l.useEffect(()=>{const m=localStorage.getItem("rememberedEmail"),j=localStorage.getItem("rememberedPassword");m&&j&&(a({email:m,password:j}),d(!0))},[]);const p=m=>{const{name:j,value:v}=m.target;a(w=>({...w,[j]:v}))},f=async m=>{m.preventDefault(),o(null),c(!0),u?(localStorage.setItem("rememberedEmail",n.email),localStorage.setItem("rememberedPassword",n.password)):(localStorage.removeItem("rememberedEmail"),localStorage.removeItem("rememberedPassword"));try{const j=await B.post("/api/auth/login",n),{sessionToken:v,refreshToken:w,user:_}=j.data;r(v,w,_),_.access_role==="Time Tracking"?t("/time-tracking"):_.access_role==="Quotes"?t("/quotes"):t("/")}catch(j){console.error("Login error:",j);try{const v=localStorage.getItem("user"),w=v?JSON.parse(v):null,_=localStorage.getItem("sessionToken"),P=localStorage.getItem("refreshToken");if(w&&w.access_role==="Time Tracking"&&_&&P){t("/time-tracking");return}}catch{}o(j.response?.data?.message||"Failed to login. Please try again.")}finally{c(!1)}};return e.jsx(at,{component:"main",maxWidth:"xs",children:e.jsx(k,{sx:{marginTop:8,display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsxs(Ae,{elevation:3,sx:{padding:4,display:"flex",flexDirection:"column",alignItems:"center",width:"100%"},children:[e.jsx(h,{component:"h1",variant:"h5",gutterBottom:!0,children:"Sign In"}),s&&e.jsx(We,{severity:"error",sx:{width:"100%",mb:2},children:s}),e.jsxs(k,{component:"form",onSubmit:f,sx:{mt:1,width:"100%"},children:[e.jsx(le,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",autoFocus:!0,value:n.email,onChange:p}),e.jsx(le,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Password",type:"password",id:"password",autoComplete:"current-password",value:n.password,onChange:p}),e.jsx(vn,{control:e.jsx(on,{value:"remember",color:"primary",checked:u,onChange:m=>d(m.target.checked)}),label:"Remember me"}),e.jsx(G,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2},disabled:i,children:i?"Signing in...":"Sign In"}),e.jsx(k,{sx:{textAlign:"center"},children:e.jsx(Fh,{component:rp,to:"/register",variant:"body2",children:"Don't have an account? Register your company"})})]})]})})})},Zy=()=>{const t=Kt(),{login:r}=Zt(),[n,a]=l.useState({companyName:"",adminUsername:"",adminEmail:"",adminPassword:"",confirmPassword:""}),[s,o]=l.useState(null),[i,c]=l.useState(!1),u=p=>{const{name:f,value:m}=p.target;a(j=>({...j,[f]:m}))},d=async p=>{if(p.preventDefault(),o(null),n.adminPassword!==n.confirmPassword){o("Passwords do not match");return}c(!0);try{const f=await B.post("/api/auth/register-company",{company_name:n.companyName,admin_username:n.adminUsername,admin_email:n.adminEmail,admin_password:n.adminPassword}),{sessionToken:m,refreshToken:j,user:v}=f.data;r(m,j,v),t("/dashboard")}catch(f){console.error("Registration error:",f),o(f.response?.data?.message||"Failed to register company. Please try again.")}finally{c(!1)}};return e.jsx(at,{component:"main",maxWidth:"sm",children:e.jsx(k,{sx:{marginTop:8,display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsxs(Ae,{elevation:3,sx:{padding:4,display:"flex",flexDirection:"column",alignItems:"center",width:"100%"},children:[e.jsx(h,{component:"h1",variant:"h5",gutterBottom:!0,children:"Register Your Company"}),s&&e.jsx(We,{severity:"error",sx:{width:"100%",mb:2},children:s}),e.jsxs(k,{component:"form",onSubmit:d,sx:{mt:3,width:"100%"},children:[e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{required:!0,fullWidth:!0,label:"Company Name",name:"companyName",value:n.companyName,onChange:u})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{required:!0,fullWidth:!0,label:"Admin Username",name:"adminUsername",value:n.adminUsername,onChange:u})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{required:!0,fullWidth:!0,label:"Admin Email",name:"adminEmail",type:"email",value:n.adminEmail,onChange:u})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{required:!0,fullWidth:!0,label:"Admin Password",name:"adminPassword",type:"password",value:n.adminPassword,onChange:u})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{required:!0,fullWidth:!0,label:"Confirm Password",name:"confirmPassword",type:"password",value:n.confirmPassword,onChange:u})})]}),e.jsx(G,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2},disabled:i,children:i?"Registering...":"Register Company"})]})]})})})};var ua={},id;function ev(){if(id)return ua;id=1;var t=yt();Object.defineProperty(ua,"__esModule",{value:!0}),ua.default=void 0;var r=t(bt()),n=vt();return ua.default=(0,r.default)((0,n.jsx)("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4z"}),"Refresh"),ua}var tv=ev();const jn=st(tv);var pa={},ld;function rv(){if(ld)return pa;ld=1;var t=yt();Object.defineProperty(pa,"__esModule",{value:!0}),pa.default=void 0;var r=t(bt()),n=vt();return pa.default=(0,r.default)((0,n.jsx)("path",{d:"M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1m0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3m6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1z"}),"AssignmentInd"),pa}var nv=rv();const sv=st(nv);var ha={},cd;function av(){if(cd)return ha;cd=1;var t=yt();Object.defineProperty(ha,"__esModule",{value:!0}),ha.default=void 0;var r=t(bt()),n=vt();return ha.default=(0,r.default)((0,n.jsx)("path",{d:"M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 18H4V8h16z"}),"CalendarToday"),ha}var ov=av();const $p=st(ov);var ma={},dd;function iv(){if(dd)return ma;dd=1;var t=yt();Object.defineProperty(ma,"__esModule",{value:!0}),ma.default=void 0;var r=t(bt()),n=vt();return ma.default=(0,r.default)((0,n.jsx)("path",{d:"M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-6 15h-2v-2h2zm0-4h-2V8h2zm-1-9c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1"}),"AssignmentLate"),ma}var lv=iv();const cv=st(lv);var fa={},ud;function dv(){if(ud)return fa;ud=1;var t=yt();Object.defineProperty(fa,"__esModule",{value:!0}),fa.default=void 0;var r=t(bt()),n=vt();return fa.default=(0,r.default)((0,n.jsx)("path",{d:"M1 21h22L12 2zm12-3h-2v-2h2zm0-4h-2v-4h2z"}),"ReportProblem"),fa}var uv=dv();const pv=st(uv),hv=[{key:"myOpen",label:"My open tasks",icon:e.jsx(sv,{fontSize:"large"}),palette:"info"},{key:"myDueToday",label:"My tasks due today",icon:e.jsx($p,{fontSize:"large"}),palette:"warning"},{key:"myOverdue",label:"My overdue tasks",icon:e.jsx(js,{fontSize:"large"}),palette:"error"},{key:"assignedByMeOverdue",label:"Overdue tasks I assigned",icon:e.jsx(cv,{fontSize:"large"}),palette:"secondary"},{key:"allOverdue",label:"All overdue tasks",icon:e.jsx(pv,{fontSize:"large"}),palette:"error"}],zp=({summary:t,loading:r,onRefresh:n,onViewTasks:a})=>{const s=t?.total??0;return e.jsxs(kt,{sx:{borderRadius:3,overflow:"hidden",position:"relative",boxShadow:"0 24px 60px -32px rgba(15, 23, 42, 0.45)"},children:[e.jsx(k,{sx:{position:"absolute",inset:0,background:"linear-gradient(140deg, rgba(59, 130, 246, 0.12) 0%, rgba(99, 102, 241, 0.08) 45%, rgba(168, 85, 247, 0.05) 100%)",pointerEvents:"none"}}),e.jsxs(Tt,{sx:{position:"relative",p:{xs:3,md:4}},children:[e.jsxs(ke,{direction:{xs:"column",md:"row"},justifyContent:"space-between",alignItems:{xs:"flex-start",md:"center"},spacing:3,children:[e.jsxs(k,{children:[e.jsx(h,{variant:"overline",color:"text.secondary",sx:{letterSpacing:1.2},children:"Team workload snapshot"}),e.jsx(h,{variant:"h4",sx:{fontWeight:600},children:"Task overview"}),e.jsxs(h,{variant:"body1",color:"text.secondary",sx:{mt:.5},children:["Tracking ",e.jsx("strong",{children:s})," task",s===1?"":"s"," across your workspace."]})]}),e.jsxs(ke,{direction:{xs:"column",sm:"row"},spacing:1.5,width:{xs:"100%",sm:"auto"},children:[n&&e.jsx(G,{variant:"outlined",startIcon:e.jsx(jn,{}),onClick:n,disabled:r,sx:{width:{xs:"100%",sm:"auto"}},children:"Refresh"}),a&&e.jsx(G,{variant:"contained",onClick:a,sx:{width:{xs:"100%",sm:"auto"}},children:"View tasks"})]})]}),e.jsx(k,{sx:{mt:4},children:r?e.jsx(k,{display:"flex",justifyContent:"center",py:4,children:e.jsx(it,{})}):t?e.jsx(k,{sx:{display:"grid",gap:2.5,gridTemplateColumns:{xs:"repeat(1, minmax(0, 1fr))",sm:"repeat(2, minmax(0, 1fr))",md:"repeat(3, minmax(0, 1fr))",lg:"repeat(5, minmax(0, 1fr))"}},children:hv.map(o=>e.jsxs(k,{sx:i=>({borderRadius:3,p:3,display:"flex",flexDirection:"column",gap:1,border:`1px solid ${In(i.palette[o.palette].main,.28)}`,background:`linear-gradient(135deg, ${In(i.palette[o.palette].main,.18)} 0%, ${In(i.palette[o.palette].main,.06)} 100%)`,boxShadow:`0 12px 30px -20px ${In(i.palette[o.palette].main,.6)}`,color:i.palette.text.primary}),children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1.25},children:[e.jsx(k,{sx:i=>({display:"inline-flex",alignItems:"center",justifyContent:"center",width:40,height:40,borderRadius:"50%",backgroundColor:In(i.palette[o.palette].main,.2),color:i.palette[o.palette].dark}),children:o.icon}),e.jsx(h,{variant:"subtitle2",color:"text.secondary",children:o.label})]}),e.jsx(h,{variant:"h4",sx:{fontWeight:600},children:t[o.key]??0})]},o.key))}):e.jsx(h,{variant:"body2",color:"text.secondary",children:"Task data is not available yet. Create your first task to populate this overview."})})]})]})},mv=t=>{if(!t)return{};const r={};return t.status&&t.status.length>0&&(r.status=t.status.join(",")),typeof t.assignedTo=="number"&&(r.assignedTo=String(t.assignedTo)),t.dueFrom&&(r.dueFrom=t.dueFrom),t.dueTo&&(r.dueTo=t.dueTo),t.search&&(r.search=t.search.trim()),typeof t.includeCompleted=="boolean"&&(r.includeCompleted=String(t.includeCompleted)),typeof t.includeArchived=="boolean"&&(r.includeArchived=String(t.includeArchived)),r},fv=async t=>(await B.get("/api/tasks",{params:mv(t)})).data.tasks,xv=async t=>(await B.get(`/api/tasks/${t}/overview`)).data,gv=async t=>(await B.post("/api/tasks",t)).data,yv=async(t,r)=>(await B.put(`/api/tasks/${t}`,r)).data,vv=async(t,r)=>(await B.patch(`/api/tasks/${t}/assignments`,{assigneeIds:r})).data,bv=async(t,r)=>(await B.patch(`/api/tasks/${t}/complete`,{completed:r})).data,_v=async(t,r)=>(await B.post(`/api/tasks/${t}/notes`,{note:r})).data,jv=async t=>{await B.delete(`/api/tasks/${t}`)},Cl=async()=>(await B.get("/api/tasks/summary")).data,wv=async()=>(await B.get("/api/tasks/assignees")).data.assignees,Sv={Purchasing:e.jsx(ks,{sx:{color:"primary.main"}}),Sales:e.jsx(Ps,{sx:{color:"primary.main"}}),"Products & Inventory":e.jsx(Fr,{sx:{color:"primary.main"}}),"Time Tracking":e.jsx(Qn,{sx:{color:"primary.main"}}),"Human Resources":e.jsx(to,{sx:{color:"primary.main"}}),Settings:e.jsx(Rl,{sx:{color:"primary.main"}})},pd=()=>{const t=Kt(),r=$h(),{user:n}=Zt(),[a,s]=l.useState(null),[o,i]=l.useState(!1),c=l.useCallback(async()=>{i(!0);try{const p=await Cl();s(p)}catch(p){console.error("Failed to load task summary",p)}finally{i(!1)}},[]);l.useEffect(()=>{c()},[c]),console.log("[LandingPage] user:",n);let d=[{title:"Purchasing",items:[{title:"Purchase Orders",description:"Manage purchase orders",icon:e.jsx(ks,{sx:{fontSize:40,color:"primary.main"}}),path:"/open-purchase-orders"},{title:"Return Orders",description:"Track vendor returns tied to POs",icon:e.jsx(Yo,{sx:{fontSize:40,color:"primary.main"}}),path:"/return-orders"},{title:"Parts to Order",description:"Manage parts ordering",icon:e.jsx(Fr,{sx:{fontSize:40,color:"primary.main"}}),path:"/parts-to-order"},{title:"Vendors",description:"Manage your vendors",icon:e.jsx(Au,{sx:{fontSize:40,color:"primary.main"}}),path:"/vendors"}]},{title:"Sales",items:[{title:"Quotes",description:"Manage and track quotes",icon:e.jsx(ol,{sx:{fontSize:40,color:"primary.main"}}),path:"/quotes"},{title:"Sales Orders",description:"Manage sales orders",icon:e.jsx(Ps,{sx:{fontSize:40,color:"primary.main"}}),path:"/open-sales-orders"},{title:"Customers",description:"Track and manage your customer relationships",icon:e.jsx(to,{sx:{fontSize:40,color:"primary.main"}}),path:"/customers"}]},{title:"Products & Inventory",items:[{title:"Products",description:"Manage your products",icon:e.jsx(Mu,{sx:{fontSize:40,color:"primary.main"}}),path:"/products"},{title:"Stock",description:"Manage your product inventory and stock levels",icon:e.jsx(Fr,{sx:{fontSize:40,color:"primary.main"}}),path:"/inventory"},{title:"Supply",description:"Manage supply and materials",icon:e.jsx(Fr,{sx:{fontSize:40,color:"primary.main"}}),path:"/supply"}]},{title:"Time Tracking",items:[{title:"Attendance",description:"View and manage attendance records",icon:e.jsx(Qn,{sx:{fontSize:40,color:"primary.main"}}),path:"/attendance"},{title:"Time Tracking",description:"Track employee time and project hours",icon:e.jsx(Qn,{sx:{fontSize:40,color:"primary.main"}}),path:"/time-tracking"},{title:"Time Tracking Reports",description:"View and export time tracking reports",icon:e.jsx(Ru,{sx:{fontSize:40,color:"primary.main"}}),path:"/time-tracking/reports"}]},{title:"Human Resources",items:[{title:"Employees",description:"Manage employee accounts and roles",icon:e.jsx(Nu,{sx:{fontSize:40,color:"primary.main"}}),path:"/employees"},{title:"Profile Documents",description:"Manage and track employee document access and read status",icon:e.jsx(ks,{sx:{fontSize:40,color:"primary.main"}}),path:"/profile-documents"},{title:"Leave Management",description:"Manage employee leave requests and approvals",icon:e.jsx(Lu,{sx:{fontSize:40,color:"primary.main"}}),path:"/leave-management"},{title:"Mobile User Access",description:"Manage mobile user access to profiles",icon:e.jsx(to,{sx:{fontSize:40,color:"primary.main"}}),path:"/mobile-user-access"}]},{title:"Settings",items:[{title:"Business Profile",description:"Manage your company information and settings",icon:e.jsx(Rl,{sx:{fontSize:40,color:"primary.main"}}),path:"/business-profile"},{title:"Accounting",description:"Configure QuickBooks account mappings",icon:e.jsx(Vo,{sx:{fontSize:40,color:"primary.main"}}),path:"/qbo-account-mapping"},{title:"Global Variables",description:"Set and manage margin, labour, and overhead rates",icon:e.jsx(Vo,{sx:{fontSize:40,color:"primary.main"}}),path:"/margin-schedule"},{title:"Email Settings",description:"Configure system email settings",icon:e.jsx(Go,{sx:{fontSize:40,color:"primary.main"}}),path:"/email-settings"},{title:"Backup Management",description:"Manage system backups and restores",icon:e.jsx(Nl,{sx:{fontSize:40,color:"primary.main"}}),path:"/backup-management"}]}];return n?.access_role==="Sales and Purchase"&&(d=[{title:"Sales & Purchase",items:[{title:"Sales Orders",description:"Manage sales orders",icon:e.jsx(Ps,{sx:{fontSize:40,color:"primary.main"}}),path:"/open-sales-orders"},{title:"Purchase Orders",description:"Manage purchase orders",icon:e.jsx(ks,{sx:{fontSize:40,color:"primary.main"}}),path:"/open-purchase-orders"},{title:"Return Orders",description:"Track vendor returns tied to POs",icon:e.jsx(Yo,{sx:{fontSize:40,color:"primary.main"}}),path:"/return-orders"},{title:"Parts to Order",description:"View parts that need to be ordered",icon:e.jsx(Fr,{sx:{fontSize:40,color:"primary.main"}}),path:"/parts-to-order"}]},{title:"Inventory",items:[{title:"Stock",description:"Manage your product inventory and stock levels",icon:e.jsx(Fr,{sx:{fontSize:40,color:"primary.main"}}),path:"/inventory"},{title:"Supply",description:"Manage supply and materials",icon:e.jsx(Fr,{sx:{fontSize:40,color:"primary.main"}}),path:"/supply"}]},{title:"Settings",items:[{title:"Email Settings",description:"Configure your email settings",icon:e.jsx(Go,{sx:{fontSize:40,color:"primary.main"}}),path:"/email-settings"}]}]),n?.access_role==="Quotes"&&(d=[{title:"Quotes",items:[{title:"Quotes",description:"Manage and track quotes",icon:e.jsx(ol,{sx:{fontSize:40,color:"primary.main"}}),path:"/quotes"}]}]),console.log("[LandingPage] filteredSections:",d),e.jsxs(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{background:`linear-gradient(90deg, ${r.palette.primary.main} 0%, ${r.palette.secondary.main} 100%)`,borderRadius:3,p:4,mb:6,color:r.palette.primary.contrastText,boxShadow:3,textAlign:"center"},children:[e.jsx(h,{variant:"h3",component:"h1",gutterBottom:!0,sx:{color:"inherit"},children:"Welcome to Aiven"}),e.jsx(h,{variant:"h5",component:"h2",gutterBottom:!0,sx:{color:"inherit",opacity:.85},children:"Your all-in-one business management solution"})]}),e.jsx(k,{sx:{mb:6},children:e.jsx(zp,{summary:a,loading:o,onRefresh:c,onViewTasks:()=>t("/tasks")})}),e.jsx(Ae,{elevation:0,sx:{mb:6,px:{xs:3,md:4},py:{xs:3,md:4},borderRadius:3,border:"1px solid",borderColor:"divider",backgroundColor:"background.paper"},children:e.jsxs(ke,{direction:{xs:"column",sm:"row"},spacing:3,alignItems:"center",children:[e.jsx(Nn,{sx:{bgcolor:"primary.main",width:56,height:56},children:e.jsx(Al,{fontSize:"medium"})}),e.jsxs(k,{sx:{textAlign:{xs:"center",sm:"left"}},children:[e.jsx(h,{variant:"h5",component:"h2",sx:{fontWeight:600},children:"Workspace Copilot"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Need a hand? Click the Copilot bubble in the lower-right corner to open the AI assistant without leaving your work."})]})]})}),d.map((p,f)=>e.jsx(nl,{in:!0,timeout:700+f*200,children:e.jsxs(k,{sx:{mt:6,mb:4,p:3,borderRadius:3,background:r.palette.mode==="light"?r.palette.grey[50]:r.palette.grey[900],boxShadow:1},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(Nn,{sx:{bgcolor:"primary.main",mr:2},children:Sv[p.title]||e.jsx(al,{sx:{color:"primary.main"}})}),e.jsx(h,{variant:"h4",component:"h2",sx:{color:"primary.main",fontWeight:600},children:p.title})]}),e.jsx(M,{container:!0,spacing:4,children:p.items.map((m,j)=>e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(nl,{in:!0,timeout:900+j*150,children:e.jsx(kt,{sx:{height:"100%",display:"flex",flexDirection:"column",borderRadius:2,boxShadow:2,transition:"transform 0.2s, box-shadow 0.2s","&:hover":{transform:"translateY(-6px) scale(1.03)",boxShadow:6,cursor:"pointer"},bgcolor:"background.paper"},onClick:()=>t(m.path),tabIndex:0,role:"button","aria-label":m.title,children:e.jsxs(Tt,{sx:{flexGrow:1,textAlign:"center"},children:[m.icon,e.jsx(h,{gutterBottom:!0,variant:"h5",component:"h2",children:m.title}),e.jsx(h,{children:m.description})]})})})},j))}),f<d.length-1&&e.jsx(xr,{sx:{mt:4,mb:2}})]})},p.title))]})};var xa={},hd;function Cv(){if(hd)return xa;hd=1;var t=yt();Object.defineProperty(xa,"__esModule",{value:!0}),xa.default=void 0;var r=t(bt()),n=vt();return xa.default=(0,r.default)((0,n.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"}),"Delete"),xa}var kv=Cv();const gr=st(kv);var ga={},md;function Pv(){if(md)return ga;md=1;var t=yt();Object.defineProperty(ga,"__esModule",{value:!0}),ga.default=void 0;var r=t(bt()),n=vt();return ga.default=(0,r.default)((0,n.jsx)("path",{d:"M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96M14 13v4h-4v-4H7l5-5 5 5z"}),"CloudUpload"),ga}var Dv=Pv();const io=st(Dv);var ya={},fd;function Ev(){if(fd)return ya;fd=1;var t=yt();Object.defineProperty(ya,"__esModule",{value:!0}),ya.default=void 0;var r=t(bt()),n=vt();return ya.default=(0,r.default)((0,n.jsx)("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"}),"Edit"),ya}var Iv=Ev();const As=st(Iv),An="/assets/default-logo-BbiCiEKs.png",Ar=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t),xd=t=>{if(console.log("getLogoUrl called with:",t),!t)return console.log("No logo URL provided, using default"),An;if(t.startsWith("http://")||t.startsWith("https://"))return console.log("Logo URL is already a full URL:",t),t;if(t.includes("\\")||t.includes(":/")||t.includes(":\\")){const a=t.split(/[\\\/]/).pop()||t;if(console.log("Extracted filename from Windows path:",a),!a||a===t)return console.warn("Could not extract valid filename from Windows path, using default"),An;const{baseURL:s}=Is(),o=`${s.replace(/\/$/,"")}/uploads/${a}`;return console.log("Built final URL from Windows path:",o),o}if(t.startsWith("/")){const a=t.split("/").pop()||t;if(console.log("Extracted filename from Unix path:",a),!a||a===t)return console.warn("Could not extract valid filename from Unix path, using default"),An;const{baseURL:s}=Is(),o=`${s.replace(/\/$/,"")}/uploads/${a}`;return console.log("Built final URL from Unix path:",o),o}if(t.includes("\\")||t.includes(":/")||t.includes(":\\"))return console.warn("Invalid filename format, using default"),An;const{baseURL:r}=Is(),n=`${r.replace(/\/$/,"")}/uploads/${t}`;return console.log("Built final URL from filename:",n),n};Is().baseURL;const Tv=()=>{Kt();const[t,r]=l.useState({id:"",business_name:"",street_address:"",city:"",province:"",country:"",postal_code:"",telephone_number:"",email:"",business_number:"",website:"",logo_url:"",created_at:"",updated_at:""}),[n,a]=l.useState(!1),[s,o]=l.useState(null),[i,c]=l.useState(null),[u,d]=l.useState(!1),p=C=>({id:C.id||"",business_name:C.business_name||"",street_address:C.street_address||"",city:C.city||"",province:C.province||"",country:C.country||"",postal_code:C.postal_code||"",telephone_number:C.telephone_number||"",email:C.email||"",business_number:C.business_number||"",website:C.website||"",logo_url:C.logo_url||"",created_at:C.created_at||"",updated_at:C.updated_at||""});l.useEffect(()=>{f()},[]);const f=async()=>{try{const C=await B.get("/api/business-profile");console.log("Business Profile API Response:",C.data),console.log("Logo URL from API:",C.data.logo_url),r(p(C.data))}catch(C){if(C.response?.status===404){d(!0);return}console.error("Error fetching business profile:",C),H.error("Failed to load business profile")}},m=C=>{const{name:D,value:A}=C.target;r(b=>({...b,[D]:A}))},j=C=>{if(C.target.files&&C.target.files[0]){const D=C.target.files[0];o(D);const A=URL.createObjectURL(D);c(A)}},v=async()=>{if(t.logo_url)try{a(!0),await B.delete("/api/business-profile/logo"),r(C=>({...C,logo_url:""})),H.success("Logo deleted successfully")}catch(C){console.error("Error deleting logo:",C),H.error("Failed to delete logo")}finally{a(!1)}},w=async C=>{C.preventDefault(),a(!0);try{const D=new FormData;Object.entries(t).forEach(([A,b])=>{let N=A;switch(A){case"business_name":N="business_name";break;case"street_address":N="street_address";break;case"telephone_number":N="telephone_number";break;case"business_number":N="business_number";break;case"email":N="email";break;case"website":N="website";break;case"city":N="city";break;case"province":N="province";break;case"country":N="country";break;case"postal_code":N="postal_code";break;case"logo_url":return;case"id":case"created_at":case"updated_at":return}b!=null&&D.append(N,b)}),s&&D.append("logo",s),console.log("Form data being sent:");for(let[A,b]of D.entries())console.log(`${A}:`,b);await B.post("/api/business-profile",D,{headers:{"Content-Type":"multipart/form-data"}}),H.success("Business profile updated successfully"),d(!1),o(null),c(null),f()}catch(D){console.error("Error updating business profile:",D),console.error("Error response:",D.response),console.error("Error message:",D.message),D.response?.status===401?H.error("Authentication failed. Please log in again."):D.response?.status===403?H.error("Access denied. You do not have permission to update the business profile."):D.response?.status===404?H.error("Business profile endpoint not found. Please check your API configuration."):D.response?.status===500?H.error("Server error. Please try again later."):D.code==="NETWORK_ERROR"?H.error("Network error. Please check your connection and try again."):D.message?.includes("timeout")?H.error("Request timed out. Please try again."):H.error(`Failed to update business profile: ${D.response?.data?.error||D.message||"Unknown error"}`)}finally{a(!1)}},_=()=>{d(!1),o(null),c(null),t.id?f():r({id:"",business_name:"",street_address:"",city:"",province:"",country:"",postal_code:"",telephone_number:"",email:"",business_number:"",logo_url:"",created_at:"",updated_at:""})};if(n)return e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(it,{})});const P=()=>{const C=!!t.id;return e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"flex-start",minHeight:"70vh",children:e.jsx(Ae,{sx:{p:{xs:2,md:4},width:"100%",maxWidth:650,borderRadius:4,boxShadow:6,bgcolor:"background.paper"},elevation:6,children:e.jsxs(ke,{spacing:4,children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsx(h,{variant:"h5",fontWeight:700,color:"primary.main",children:C?"Current Business Profile":"Business Profile"}),e.jsx(k,{children:e.jsx(G,{variant:"contained",startIcon:e.jsx(As,{}),onClick:()=>d(!0),sx:{borderRadius:2,fontWeight:600},children:C?"Edit Profile":"Create Profile"})})]}),e.jsx(xr,{sx:{bgcolor:"primary.light",height:3,borderRadius:2}}),C?e.jsxs(e.Fragment,{children:[t.logo_url&&e.jsxs(k,{display:"flex",flexDirection:"column",alignItems:"center",mb:2,children:[e.jsx(h,{variant:"subtitle1",fontWeight:600,color:"primary.dark",gutterBottom:!0,children:"Business Logo"}),e.jsx(kt,{sx:{maxWidth:180,borderRadius:3,boxShadow:3,border:"2px solid",borderColor:"primary.light",p:1,mb:1,bgcolor:"grey.50"},children:e.jsx(tc,{component:"img",image:t.logo_url?xd(t.logo_url):An,onError:D=>D.currentTarget.src=An,alt:"Business Logo",sx:{height:120,objectFit:"contain",borderRadius:2,bgcolor:"white"}})})]}),e.jsxs(M,{container:!0,spacing:3,children:[e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx(h,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Business Name"}),e.jsx(h,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.business_name})]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx(h,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Business Number"}),e.jsx(h,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.business_number})]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx(h,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Address"}),e.jsxs(h,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:[t.street_address,e.jsx("br",{}),t.city,", ",t.province,t.postal_code?`, ${t.postal_code}`:"",e.jsx("br",{}),t.country]})]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx(h,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Email"}),e.jsx(h,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.email})]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx(h,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Telephone"}),e.jsx(h,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.telephone_number})]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx(h,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Website"}),e.jsx(h,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.website?e.jsx("a",{href:t.website.startsWith("http")?t.website:`https://${t.website}`,target:"_blank",rel:"noopener noreferrer",style:{color:"inherit",textDecoration:"underline"},children:t.website}):"Not provided"})]})]})]}):e.jsxs(k,{textAlign:"center",py:4,children:[e.jsx(h,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"No Business Profile Found"}),e.jsx(h,{variant:"body1",color:"text.secondary",sx:{mb:3},children:"Create your business profile to get started. This information will be used in your quotes, invoices, and other business documents."}),e.jsx(G,{variant:"contained",size:"large",startIcon:e.jsx(As,{}),onClick:()=>d(!0),sx:{borderRadius:2,fontWeight:600},children:"Create Business Profile"})]})]})})})},L=()=>e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"flex-start",minHeight:"70vh",children:e.jsx(Ae,{sx:{p:{xs:2,md:4},width:"100%",maxWidth:650,borderRadius:4,boxShadow:6,bgcolor:"background.paper"},elevation:6,component:"form",onSubmit:w,children:e.jsxs(ke,{spacing:4,children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsx(h,{variant:"h5",fontWeight:700,color:"primary.main",children:t.id?"Edit Business Profile":"Create Business Profile"}),e.jsxs(k,{children:[e.jsx(G,{variant:"outlined",onClick:_,sx:{borderRadius:2,fontWeight:600,mr:2},children:"Cancel"}),e.jsx(G,{variant:"contained",type:"submit",disabled:n,sx:{borderRadius:2,fontWeight:600},children:n?e.jsx(it,{size:24}):t.id?"Save Changes":"Create Profile"})]})]}),e.jsx(xr,{sx:{bgcolor:"primary.light",height:3,borderRadius:2}}),e.jsxs(M,{container:!0,spacing:3,children:[e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Business Name",name:"business_name",value:t.business_name,onChange:m,fullWidth:!0,required:!0})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Business Number/GST-HST Registration Number",name:"business_number",value:t.business_number,onChange:m,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Street Address",name:"street_address",value:t.street_address,onChange:m,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"City",name:"city",value:t.city,onChange:m,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Province",name:"province",value:t.province,onChange:m,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Country",name:"country",value:t.country,onChange:m,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Postal Code",name:"postal_code",value:t.postal_code,onChange:m,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Telephone Number",name:"telephone_number",value:t.telephone_number,onChange:m,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Email",name:"email",value:t.email,onChange:m,fullWidth:!0,type:"email"})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Website",name:"website",value:t.website,onChange:m,fullWidth:!0})}),e.jsxs(M,{item:!0,xs:12,children:[e.jsx(h,{variant:"subtitle2",fontWeight:600,gutterBottom:!0,children:"Business Logo"}),t.logo_url&&e.jsxs(k,{display:"flex",flexDirection:"column",alignItems:"center",mb:2,children:[e.jsx(kt,{sx:{maxWidth:180,borderRadius:3,boxShadow:3,border:"2px solid",borderColor:"primary.light",p:1,mb:1,bgcolor:"grey.50"},children:e.jsx(tc,{component:"img",image:t.logo_url?xd(t.logo_url):An,onError:C=>C.currentTarget.src=An,alt:"Business Logo",sx:{height:120,objectFit:"contain",borderRadius:2,bgcolor:"white"}})}),e.jsx(G,{variant:"outlined",color:"error",startIcon:e.jsx(gr,{}),onClick:v,sx:{borderRadius:2,fontWeight:600},children:"Delete Current Logo"})]}),e.jsxs(G,{variant:"contained",component:"label",startIcon:e.jsx(io,{}),sx:{borderRadius:2,fontWeight:600},children:[t.logo_url?"Change Logo":"Upload Logo",e.jsx("input",{type:"file",hidden:!0,onChange:j,accept:"image/*"})]}),i&&e.jsxs(k,{mt:2,display:"flex",flexDirection:"column",alignItems:"center",children:[e.jsx(h,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"New Logo Preview:"}),e.jsx("img",{src:i,alt:"Logo Preview",style:{maxWidth:"100px",maxHeight:"100px"}})]})]})]})]})})});return e.jsx(at,{sx:{mt:4,mb:4},children:u?L():P()})};var va={},gd;function Ov(){if(gd)return va;gd=1;var t=yt();Object.defineProperty(va,"__esModule",{value:!0}),va.default=void 0;var r=t(bt()),n=vt();return va.default=(0,r.default)((0,n.jsx)("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"}),"Search"),va}var Av=Ov();const Br=st(Av);var ba={},yd;function Mv(){if(yd)return ba;yd=1;var t=yt();Object.defineProperty(ba,"__esModule",{value:!0}),ba.default=void 0;var r=t(bt()),n=vt();return ba.default=(0,r.default)((0,n.jsx)("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add"),ba}var Rv=Mv();const Lr=st(Rv);var _a={},vd;function Nv(){if(vd)return _a;vd=1;var t=yt();Object.defineProperty(_a,"__esModule",{value:!0}),_a.default=void 0;var r=t(bt()),n=vt();return _a.default=(0,r.default)((0,n.jsx)("path",{d:"M5 20h14v-2H5zM19 9h-4V3H9v6H5l7 7z"}),"Download"),_a}var Lv=Nv();const yr=st(Lv),bd=async t=>(await B.get(`/api/customers/${t}/contacts`)).data,qv=async(t,r)=>(await B.post(`/api/customers/${t}/contacts/people`,r)).data,Uv=async(t,r,n)=>(await B.put(`/api/customers/${t}/contacts/people/${r}`,n)).data,Wv=async(t,r)=>(await B.delete(`/api/customers/${t}/contacts/people/${r}`)).data,Fv=async(t,r)=>(await B.post(`/api/customers/${t}/contacts/emails`,r)).data,$v=async(t,r,n)=>(await B.put(`/api/customers/${t}/contacts/emails/${r}`,n)).data,zv=async(t,r)=>(await B.delete(`/api/customers/${t}/contacts/emails/${r}`)).data,Bv=async(t,r)=>(await B.post(`/api/customers/${t}/contacts/phones`,r)).data,Hv=async(t,r,n)=>(await B.put(`/api/customers/${t}/contacts/phones/${r}`,n)).data,Yv=async(t,r)=>(await B.delete(`/api/customers/${t}/contacts/phones/${r}`)).data,Vv=async()=>(await B.get("/api/customers")).data,Gv=async t=>(await B.get(`/api/customers/${t}`)).data,Bp=async t=>(await B.post("/api/customers",t)).data,Hp=async(t,r)=>(await B.put(`/api/customers/${t}`,r)).data,Qv=async t=>{await B.delete(`/api/customers/${t}`)};var Wo={exports:{}};/* @license
Papa Parse
v5.5.3
https://github.com/mholt/PapaParse
License: MIT
*/var Kv=Wo.exports,_d;function Jv(){return _d||(_d=1,function(t,r){((n,a)=>{t.exports=a()})(Kv,function n(){var a=typeof self<"u"?self:typeof window<"u"?window:a!==void 0?a:{},s,o=!a.document&&!!a.postMessage,i=a.IS_PAPA_WORKER||!1,c={},u=0,d={};function p(g){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},(function(x){var R=A(x);R.chunkSize=parseInt(R.chunkSize),x.step||x.chunk||(R.chunkSize=null),this._handle=new w(R),(this._handle.streamer=this)._config=R}).call(this,g),this.parseChunk=function(x,R){var O=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&0<O){let J=this._config.newline;J||(ee=this._config.quoteChar||'"',J=this._handle.guessLineEndings(x,ee)),x=[...x.split(J).slice(O)].join(J)}this.isFirstChunk&&N(this._config.beforeFirstChunk)&&(ee=this._config.beforeFirstChunk(x))!==void 0&&(x=ee),this.isFirstChunk=!1,this._halted=!1;var O=this._partialLine+x,ee=(this._partialLine="",this._handle.parse(O,this._baseIndex,!this._finished));if(!this._handle.paused()&&!this._handle.aborted()){if(x=ee.meta.cursor,O=(this._finished||(this._partialLine=O.substring(x-this._baseIndex),this._baseIndex=x),ee&&ee.data&&(this._rowCount+=ee.data.length),this._finished||this._config.preview&&this._rowCount>=this._config.preview),i)a.postMessage({results:ee,workerId:d.WORKER_ID,finished:O});else if(N(this._config.chunk)&&!R){if(this._config.chunk(ee,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);this._completeResults=ee=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(ee.data),this._completeResults.errors=this._completeResults.errors.concat(ee.errors),this._completeResults.meta=ee.meta),this._completed||!O||!N(this._config.complete)||ee&&ee.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),O||ee&&ee.meta.paused||this._nextChunk(),ee}this._halted=!0},this._sendError=function(x){N(this._config.error)?this._config.error(x):i&&this._config.error&&a.postMessage({workerId:d.WORKER_ID,error:x,finished:!1})}}function f(g){var x;(g=g||{}).chunkSize||(g.chunkSize=d.RemoteChunkSize),p.call(this,g),this._nextChunk=o?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(R){this._input=R,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(x=new XMLHttpRequest,this._config.withCredentials&&(x.withCredentials=this._config.withCredentials),o||(x.onload=b(this._chunkLoaded,this),x.onerror=b(this._chunkError,this)),x.open(this._config.downloadRequestBody?"POST":"GET",this._input,!o),this._config.downloadRequestHeaders){var R,O=this._config.downloadRequestHeaders;for(R in O)x.setRequestHeader(R,O[R])}var ee;this._config.chunkSize&&(ee=this._start+this._config.chunkSize-1,x.setRequestHeader("Range","bytes="+this._start+"-"+ee));try{x.send(this._config.downloadRequestBody)}catch(J){this._chunkError(J.message)}o&&x.status===0&&this._chunkError()}},this._chunkLoaded=function(){x.readyState===4&&(x.status<200||400<=x.status?this._chunkError():(this._start+=this._config.chunkSize||x.responseText.length,this._finished=!this._config.chunkSize||this._start>=(R=>(R=R.getResponseHeader("Content-Range"))!==null?parseInt(R.substring(R.lastIndexOf("/")+1)):-1)(x),this.parseChunk(x.responseText)))},this._chunkError=function(R){R=x.statusText||R,this._sendError(new Error(R))}}function m(g){(g=g||{}).chunkSize||(g.chunkSize=d.LocalChunkSize),p.call(this,g);var x,R,O=typeof FileReader<"u";this.stream=function(ee){this._input=ee,R=ee.slice||ee.webkitSlice||ee.mozSlice,O?((x=new FileReader).onload=b(this._chunkLoaded,this),x.onerror=b(this._chunkError,this)):x=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var ee=this._input,J=(this._config.chunkSize&&(J=Math.min(this._start+this._config.chunkSize,this._input.size),ee=R.call(ee,this._start,J)),x.readAsText(ee,this._config.encoding));O||this._chunkLoaded({target:{result:J}})},this._chunkLoaded=function(ee){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(ee.target.result)},this._chunkError=function(){this._sendError(x.error)}}function j(g){var x;p.call(this,g=g||{}),this.stream=function(R){return x=R,this._nextChunk()},this._nextChunk=function(){var R,O;if(!this._finished)return R=this._config.chunkSize,x=R?(O=x.substring(0,R),x.substring(R)):(O=x,""),this._finished=!x,this.parseChunk(O)}}function v(g){p.call(this,g=g||{});var x=[],R=!0,O=!1;this.pause=function(){p.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){p.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(ee){this._input=ee,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){O&&x.length===1&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),x.length?this.parseChunk(x.shift()):R=!0},this._streamData=b(function(ee){try{x.push(typeof ee=="string"?ee:ee.toString(this._config.encoding)),R&&(R=!1,this._checkIsFinished(),this.parseChunk(x.shift()))}catch(J){this._streamError(J)}},this),this._streamError=b(function(ee){this._streamCleanUp(),this._sendError(ee)},this),this._streamEnd=b(function(){this._streamCleanUp(),O=!0,this._streamData("")},this),this._streamCleanUp=b(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function w(g){var x,R,O,ee,J=Math.pow(2,53),z=-J,Z=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,Q=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,X=this,I=0,y=0,S=!1,U=!1,K=[],E={data:[],errors:[],meta:{}};function V(ge){return g.skipEmptyLines==="greedy"?ge.join("").trim()==="":ge.length===1&&ge[0].length===0}function q(){if(E&&O&&(ye("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+d.DefaultDelimiter+"'"),O=!1),g.skipEmptyLines&&(E.data=E.data.filter(function(he){return!V(he)})),ue()){let he=function(ae,T){N(g.transformHeader)&&(ae=g.transformHeader(ae,T)),K.push(ae)};if(E)if(Array.isArray(E.data[0])){for(var ge=0;ue()&&ge<E.data.length;ge++)E.data[ge].forEach(he);E.data.splice(0,1)}else E.data.forEach(he)}function xe(he,ae){for(var T=g.header?{}:[],$=0;$<he.length;$++){var ce=$,re=he[$],re=((Me,Ce)=>(Ye=>(g.dynamicTypingFunction&&g.dynamicTyping[Ye]===void 0&&(g.dynamicTyping[Ye]=g.dynamicTypingFunction(Ye)),(g.dynamicTyping[Ye]||g.dynamicTyping)===!0))(Me)?Ce==="true"||Ce==="TRUE"||Ce!=="false"&&Ce!=="FALSE"&&((Ye=>{if(Z.test(Ye)&&(Ye=parseFloat(Ye),z<Ye&&Ye<J))return 1})(Ce)?parseFloat(Ce):Q.test(Ce)?new Date(Ce):Ce===""?null:Ce):Ce)(ce=g.header?$>=K.length?"__parsed_extra":K[$]:ce,re=g.transform?g.transform(re,ce):re);ce==="__parsed_extra"?(T[ce]=T[ce]||[],T[ce].push(re)):T[ce]=re}return g.header&&($>K.length?ye("FieldMismatch","TooManyFields","Too many fields: expected "+K.length+" fields but parsed "+$,y+ae):$<K.length&&ye("FieldMismatch","TooFewFields","Too few fields: expected "+K.length+" fields but parsed "+$,y+ae)),T}var me;E&&(g.header||g.dynamicTyping||g.transform)&&(me=1,!E.data.length||Array.isArray(E.data[0])?(E.data=E.data.map(xe),me=E.data.length):E.data=xe(E.data,0),g.header&&E.meta&&(E.meta.fields=K),y+=me)}function ue(){return g.header&&K.length===0}function ye(ge,xe,me,he){ge={type:ge,code:xe,message:me},he!==void 0&&(ge.row=he),E.errors.push(ge)}N(g.step)&&(ee=g.step,g.step=function(ge){E=ge,ue()?q():(q(),E.data.length!==0&&(I+=ge.data.length,g.preview&&I>g.preview?R.abort():(E.data=E.data[0],ee(E,X))))}),this.parse=function(ge,xe,me){var he=g.quoteChar||'"',he=(g.newline||(g.newline=this.guessLineEndings(ge,he)),O=!1,g.delimiter?N(g.delimiter)&&(g.delimiter=g.delimiter(ge),E.meta.delimiter=g.delimiter):((he=((ae,T,$,ce,re)=>{var Me,Ce,Ye,Qe;re=re||[",","	","|",";",d.RECORD_SEP,d.UNIT_SEP];for(var lt=0;lt<re.length;lt++){for(var ct,ut=re[lt],Ne=0,tt=0,Be=0,Ct=(Ye=void 0,new P({comments:ce,delimiter:ut,newline:T,preview:10}).parse(ae)),qt=0;qt<Ct.data.length;qt++)$&&V(Ct.data[qt])?Be++:(ct=Ct.data[qt].length,tt+=ct,Ye===void 0?Ye=ct:0<ct&&(Ne+=Math.abs(ct-Ye),Ye=ct));0<Ct.data.length&&(tt/=Ct.data.length-Be),(Ce===void 0||Ne<=Ce)&&(Qe===void 0||Qe<tt)&&1.99<tt&&(Ce=Ne,Me=ut,Qe=tt)}return{successful:!!(g.delimiter=Me),bestDelimiter:Me}})(ge,g.newline,g.skipEmptyLines,g.comments,g.delimitersToGuess)).successful?g.delimiter=he.bestDelimiter:(O=!0,g.delimiter=d.DefaultDelimiter),E.meta.delimiter=g.delimiter),A(g));return g.preview&&g.header&&he.preview++,x=ge,R=new P(he),E=R.parse(x,xe,me),q(),S?{meta:{paused:!0}}:E||{meta:{paused:!1}}},this.paused=function(){return S},this.pause=function(){S=!0,R.abort(),x=N(g.chunk)?"":x.substring(R.getCharIndex())},this.resume=function(){X.streamer._halted?(S=!1,X.streamer.parseChunk(x,!0)):setTimeout(X.resume,3)},this.aborted=function(){return U},this.abort=function(){U=!0,R.abort(),E.meta.aborted=!0,N(g.complete)&&g.complete(E),x=""},this.guessLineEndings=function(ae,he){ae=ae.substring(0,1048576);var he=new RegExp(_(he)+"([^]*?)"+_(he),"gm"),me=(ae=ae.replace(he,"")).split("\r"),he=ae.split(`
`),ae=1<he.length&&he[0].length<me[0].length;if(me.length===1||ae)return`
`;for(var T=0,$=0;$<me.length;$++)me[$][0]===`
`&&T++;return T>=me.length/2?`\r
`:"\r"}}function _(g){return g.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function P(g){var x=(g=g||{}).delimiter,R=g.newline,O=g.comments,ee=g.step,J=g.preview,z=g.fastMode,Z=null,Q=!1,X=g.quoteChar==null?'"':g.quoteChar,I=X;if(g.escapeChar!==void 0&&(I=g.escapeChar),(typeof x!="string"||-1<d.BAD_DELIMITERS.indexOf(x))&&(x=","),O===x)throw new Error("Comment character same as delimiter");O===!0?O="#":(typeof O!="string"||-1<d.BAD_DELIMITERS.indexOf(O))&&(O=!1),R!==`
`&&R!=="\r"&&R!==`\r
`&&(R=`
`);var y=0,S=!1;this.parse=function(U,K,E){if(typeof U!="string")throw new Error("Input must be a string");var V=U.length,q=x.length,ue=R.length,ye=O.length,ge=N(ee),xe=[],me=[],he=[],ae=y=0;if(!U)return Ne();if(z||z!==!1&&U.indexOf(X)===-1){for(var T=U.split(R),$=0;$<T.length;$++){if(he=T[$],y+=he.length,$!==T.length-1)y+=R.length;else if(E)return Ne();if(!O||he.substring(0,ye)!==O){if(ge){if(xe=[],Qe(he.split(x)),tt(),S)return Ne()}else Qe(he.split(x));if(J&&J<=$)return xe=xe.slice(0,J),Ne(!0)}}return Ne()}for(var ce=U.indexOf(x,y),re=U.indexOf(R,y),Me=new RegExp(_(I)+_(X),"g"),Ce=U.indexOf(X,y);;)if(U[y]===X)for(Ce=y,y++;;){if((Ce=U.indexOf(X,Ce+1))===-1)return E||me.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:xe.length,index:y}),ct();if(Ce===V-1)return ct(U.substring(y,Ce).replace(Me,X));if(X===I&&U[Ce+1]===I)Ce++;else if(X===I||Ce===0||U[Ce-1]!==I){ce!==-1&&ce<Ce+1&&(ce=U.indexOf(x,Ce+1));var Ye=lt((re=re!==-1&&re<Ce+1?U.indexOf(R,Ce+1):re)===-1?ce:Math.min(ce,re));if(U.substr(Ce+1+Ye,q)===x){he.push(U.substring(y,Ce).replace(Me,X)),U[y=Ce+1+Ye+q]!==X&&(Ce=U.indexOf(X,y)),ce=U.indexOf(x,y),re=U.indexOf(R,y);break}if(Ye=lt(re),U.substring(Ce+1+Ye,Ce+1+Ye+ue)===R){if(he.push(U.substring(y,Ce).replace(Me,X)),ut(Ce+1+Ye+ue),ce=U.indexOf(x,y),Ce=U.indexOf(X,y),ge&&(tt(),S))return Ne();if(J&&xe.length>=J)return Ne(!0);break}me.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:xe.length,index:y}),Ce++}}else if(O&&he.length===0&&U.substring(y,y+ye)===O){if(re===-1)return Ne();y=re+ue,re=U.indexOf(R,y),ce=U.indexOf(x,y)}else if(ce!==-1&&(ce<re||re===-1))he.push(U.substring(y,ce)),y=ce+q,ce=U.indexOf(x,y);else{if(re===-1)break;if(he.push(U.substring(y,re)),ut(re+ue),ge&&(tt(),S))return Ne();if(J&&xe.length>=J)return Ne(!0)}return ct();function Qe(Be){xe.push(Be),ae=y}function lt(Be){var Ct=0;return Ct=Be!==-1&&(Be=U.substring(Ce+1,Be))&&Be.trim()===""?Be.length:Ct}function ct(Be){return E||(Be===void 0&&(Be=U.substring(y)),he.push(Be),y=V,Qe(he),ge&&tt()),Ne()}function ut(Be){y=Be,Qe(he),he=[],re=U.indexOf(R,y)}function Ne(Be){if(g.header&&!K&&xe.length&&!Q){var Ct=xe[0],qt=Object.create(null),Bt=new Set(Ct);let Ke=!1;for(let Yt=0;Yt<Ct.length;Yt++){let Et=Ct[Yt];if(qt[Et=N(g.transformHeader)?g.transformHeader(Et,Yt):Et]){let zt,cr=qt[Et];for(;zt=Et+"_"+cr,cr++,Bt.has(zt););Bt.add(zt),Ct[Yt]=zt,qt[Et]++,Ke=!0,(Z=Z===null?{}:Z)[zt]=Et}else qt[Et]=1,Ct[Yt]=Et;Bt.add(Et)}Ke&&console.warn("Duplicate headers found and renamed."),Q=!0}return{data:xe,errors:me,meta:{delimiter:x,linebreak:R,aborted:S,truncated:!!Be,cursor:ae+(K||0),renamedHeaders:Z}}}function tt(){ee(Ne()),xe=[],me=[]}},this.abort=function(){S=!0},this.getCharIndex=function(){return y}}function L(g){var x=g.data,R=c[x.workerId],O=!1;if(x.error)R.userError(x.error,x.file);else if(x.results&&x.results.data){var ee={abort:function(){O=!0,C(x.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:D,resume:D};if(N(R.userStep)){for(var J=0;J<x.results.data.length&&(R.userStep({data:x.results.data[J],errors:x.results.errors,meta:x.results.meta},ee),!O);J++);delete x.results}else N(R.userChunk)&&(R.userChunk(x.results,ee,x.file),delete x.results)}x.finished&&!O&&C(x.workerId,x.results)}function C(g,x){var R=c[g];N(R.userComplete)&&R.userComplete(x),R.terminate(),delete c[g]}function D(){throw new Error("Not implemented.")}function A(g){if(typeof g!="object"||g===null)return g;var x,R=Array.isArray(g)?[]:{};for(x in g)R[x]=A(g[x]);return R}function b(g,x){return function(){g.apply(x,arguments)}}function N(g){return typeof g=="function"}return d.parse=function(g,x){var R=(x=x||{}).dynamicTyping||!1;if(N(R)&&(x.dynamicTypingFunction=R,R={}),x.dynamicTyping=R,x.transform=!!N(x.transform)&&x.transform,!x.worker||!d.WORKERS_SUPPORTED)return R=null,d.NODE_STREAM_INPUT,typeof g=="string"?(g=(O=>O.charCodeAt(0)!==65279?O:O.slice(1))(g),R=new(x.download?f:j)(x)):g.readable===!0&&N(g.read)&&N(g.on)?R=new v(x):(a.File&&g instanceof File||g instanceof Object)&&(R=new m(x)),R.stream(g);(R=(()=>{var O;return!!d.WORKERS_SUPPORTED&&(O=(()=>{var ee=a.URL||a.webkitURL||null,J=n.toString();return d.BLOB_URL||(d.BLOB_URL=ee.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",J,")();"],{type:"text/javascript"})))})(),(O=new a.Worker(O)).onmessage=L,O.id=u++,c[O.id]=O)})()).userStep=x.step,R.userChunk=x.chunk,R.userComplete=x.complete,R.userError=x.error,x.step=N(x.step),x.chunk=N(x.chunk),x.complete=N(x.complete),x.error=N(x.error),delete x.worker,R.postMessage({input:g,config:x,workerId:R.id})},d.unparse=function(g,x){var R=!1,O=!0,ee=",",J=`\r
`,z='"',Z=z+z,Q=!1,X=null,I=!1,y=((()=>{if(typeof x=="object"){if(typeof x.delimiter!="string"||d.BAD_DELIMITERS.filter(function(K){return x.delimiter.indexOf(K)!==-1}).length||(ee=x.delimiter),typeof x.quotes!="boolean"&&typeof x.quotes!="function"&&!Array.isArray(x.quotes)||(R=x.quotes),typeof x.skipEmptyLines!="boolean"&&typeof x.skipEmptyLines!="string"||(Q=x.skipEmptyLines),typeof x.newline=="string"&&(J=x.newline),typeof x.quoteChar=="string"&&(z=x.quoteChar),typeof x.header=="boolean"&&(O=x.header),Array.isArray(x.columns)){if(x.columns.length===0)throw new Error("Option columns is empty");X=x.columns}x.escapeChar!==void 0&&(Z=x.escapeChar+z),x.escapeFormulae instanceof RegExp?I=x.escapeFormulae:typeof x.escapeFormulae=="boolean"&&x.escapeFormulae&&(I=/^[=+\-@\t\r].*$/)}})(),new RegExp(_(z),"g"));if(typeof g=="string"&&(g=JSON.parse(g)),Array.isArray(g)){if(!g.length||Array.isArray(g[0]))return S(null,g,Q);if(typeof g[0]=="object")return S(X||Object.keys(g[0]),g,Q)}else if(typeof g=="object")return typeof g.data=="string"&&(g.data=JSON.parse(g.data)),Array.isArray(g.data)&&(g.fields||(g.fields=g.meta&&g.meta.fields||X),g.fields||(g.fields=Array.isArray(g.data[0])?g.fields:typeof g.data[0]=="object"?Object.keys(g.data[0]):[]),Array.isArray(g.data[0])||typeof g.data[0]=="object"||(g.data=[g.data])),S(g.fields||[],g.data||[],Q);throw new Error("Unable to serialize unrecognized input");function S(K,E,V){var q="",ue=(typeof K=="string"&&(K=JSON.parse(K)),typeof E=="string"&&(E=JSON.parse(E)),Array.isArray(K)&&0<K.length),ye=!Array.isArray(E[0]);if(ue&&O){for(var ge=0;ge<K.length;ge++)0<ge&&(q+=ee),q+=U(K[ge],ge);0<E.length&&(q+=J)}for(var xe=0;xe<E.length;xe++){var me=(ue?K:E[xe]).length,he=!1,ae=ue?Object.keys(E[xe]).length===0:E[xe].length===0;if(V&&!ue&&(he=V==="greedy"?E[xe].join("").trim()==="":E[xe].length===1&&E[xe][0].length===0),V==="greedy"&&ue){for(var T=[],$=0;$<me;$++){var ce=ye?K[$]:$;T.push(E[xe][ce])}he=T.join("").trim()===""}if(!he){for(var re=0;re<me;re++){0<re&&!ae&&(q+=ee);var Me=ue&&ye?K[re]:re;q+=U(E[xe][Me],re)}xe<E.length-1&&(!V||0<me&&!ae)&&(q+=J)}}return q}function U(K,E){var V,q;return K==null?"":K.constructor===Date?JSON.stringify(K).slice(1,25):(q=!1,I&&typeof K=="string"&&I.test(K)&&(K="'"+K,q=!0),V=K.toString().replace(y,Z),(q=q||R===!0||typeof R=="function"&&R(K,E)||Array.isArray(R)&&R[E]||((ue,ye)=>{for(var ge=0;ge<ye.length;ge++)if(-1<ue.indexOf(ye[ge]))return!0;return!1})(V,d.BAD_DELIMITERS)||-1<V.indexOf(ee)||V.charAt(0)===" "||V.charAt(V.length-1)===" ")?z+V+z:V)}},d.RECORD_SEP="",d.UNIT_SEP="",d.BYTE_ORDER_MARK="\uFEFF",d.BAD_DELIMITERS=["\r",`
`,'"',d.BYTE_ORDER_MARK],d.WORKERS_SUPPORTED=!o&&!!a.Worker,d.NODE_STREAM_INPUT=1,d.LocalChunkSize=10485760,d.RemoteChunkSize=5242880,d.DefaultDelimiter=",",d.Parser=P,d.ParserHandle=w,d.NetworkStreamer=f,d.FileStreamer=m,d.StringStreamer=j,d.ReadableStreamStreamer=v,a.jQuery&&((s=a.jQuery).fn.parse=function(g){var x=g.config||{},R=[];return this.each(function(J){if(!(s(this).prop("tagName").toUpperCase()==="INPUT"&&s(this).attr("type").toLowerCase()==="file"&&a.FileReader)||!this.files||this.files.length===0)return!0;for(var z=0;z<this.files.length;z++)R.push({file:this.files[z],inputElem:this,instanceConfig:s.extend({},x)})}),O(),this;function O(){if(R.length===0)N(g.complete)&&g.complete();else{var J,z,Z,Q,X=R[0];if(N(g.before)){var I=g.before(X.file,X.inputElem);if(typeof I=="object"){if(I.action==="abort")return J="AbortError",z=X.file,Z=X.inputElem,Q=I.reason,void(N(g.error)&&g.error({name:J},z,Z,Q));if(I.action==="skip")return void ee();typeof I.config=="object"&&(X.instanceConfig=s.extend(X.instanceConfig,I.config))}else if(I==="skip")return void ee()}var y=X.instanceConfig.complete;X.instanceConfig.complete=function(S){N(y)&&y(S,X.file,X.inputElem),ee()},d.parse(X.file,X.instanceConfig)}}function ee(){R.splice(0,1),O()}}),i&&(a.onmessage=function(g){g=g.data,d.WORKER_ID===void 0&&g&&(d.WORKER_ID=g.workerId),typeof g.input=="string"?a.postMessage({workerId:d.WORKER_ID,results:d.parse(g.input,g.config),finished:!0}):(a.File&&g.input instanceof File||g.input instanceof Object)&&(g=d.parse(g.input,g.config))&&a.postMessage({workerId:d.WORKER_ID,results:g,finished:!0})}),(f.prototype=Object.create(p.prototype)).constructor=f,(m.prototype=Object.create(p.prototype)).constructor=m,(j.prototype=Object.create(j.prototype)).constructor=j,(v.prototype=Object.create(p.prototype)).constructor=v,d})}(Wo)),Wo.exports}var Xv=Jv();const Wn=st(Xv),Yp=async()=>{try{const t=await B.get("/api/business-profile");return{city:t.data.city||"",province:t.data.province||"",country:t.data.country||""}}catch(t){return console.error("Error fetching business profile:",t),{city:"",province:"",country:""}}};function wi(t,r){const[n,a]=l.useState(t);return l.useEffect(()=>{const s=setTimeout(()=>{a(t)},r);return()=>{clearTimeout(s)}},[t,r]),n}const jd={customer_id:"",customer_name:"",contact_person:"",email:"",phone_number:"",street_address:"",city:"",province:"",country:"",postal_code:"",website:"",general_notes:""},Si=({open:t,onClose:r,onSave:n,initialCustomer:a,isEditMode:s=!1,loading:o=!1,onUseExisting:i})=>{const[c,u]=l.useState(jd),[d,p]=l.useState(null),[f,m]=l.useState({}),j=wi(c,300),[v,w]=l.useState([]),[_,P]=l.useState(null),[L,C]=l.useState([]),[D,A]=l.useState([]),[b,N]=l.useState([]),[g,x]=l.useState(""),[R,O]=l.useState(""),[ee,J]=l.useState(""),[z,Z]=l.useState(""),Q=async()=>{try{const T=await Yp();u($=>({...$,city:T.city,province:T.province,country:T.country}))}catch(T){console.error("Error autofilling from business profile:",T)}};l.useEffect(()=>{if(t){const T={...jd,...a};u(T),p(null),(async()=>{try{const ce=await B.get("/api/customers");w(ce.data||[])}catch{}})(),!s&&(!a?.city||a.city==="")&&(!a?.province||a.province==="")&&(!a?.country||a.country==="")&&Q();const $=a?.customer_id;s&&$?(async()=>{try{const ce=await bd($);C(ce.people||[]),A(ce.emails||[]),N(ce.phones||[])}catch{}})():(C([]),A([]),N([]))}},[t,a,s]);const X=T=>{const{name:$,value:ce}=T.target;u(re=>({...re,[$]:ce})),f[$]&&m(re=>({...re,[$]:void 0}))},I=()=>c.customer_name.trim()?(p(null),!0):(p("Customer name is required"),!1),y=()=>{I()&&n(c)},S=T=>T.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim().toUpperCase(),U=(T,$)=>{const ce=Math.floor(Math.max(T.length,$.length)/2)-1;if(ce<0)return 0;const re=new Array(T.length).fill(!1),Me=new Array($.length).fill(!1);let Ce=0;for(let Be=0;Be<T.length;Be++){const Ct=Math.max(0,Be-ce),qt=Math.min(Be+ce+1,$.length);for(let Bt=Ct;Bt<qt;Bt++)if(!Me[Bt]&&T[Be]===$[Bt]){re[Be]=!0,Me[Bt]=!0,Ce++;break}}if(Ce===0)return 0;const Ye=[],Qe=[];for(let Be=0;Be<T.length;Be++)re[Be]&&Ye.push(T[Be]);for(let Be=0;Be<$.length;Be++)Me[Be]&&Qe.push($[Be]);let lt=0;for(let Be=0;Be<Ye.length;Be++)Ye[Be]!==Qe[Be]&&lt++;lt=Math.floor(lt/2);const ct=(Ce/T.length+Ce/$.length+(Ce-lt)/Ce)/3;let ut=0;const Ne=4;for(let Be=0;Be<Math.min(Ne,T.length,$.length)&&T[Be]===$[Be];Be++)ut++;return ct+ut*.1*(1-ct)};l.useEffect(()=>{if(!t)return;const T={};j.email&&j.email.trim().length>0&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(j.email.trim())||(T.email="Invalid email format"));let $=null,ce=0;if(j.customer_name&&j.customer_name.trim().length>0){const re=S(j.customer_name),Me=(a?.customer_id??j.customer_id)||"";for(const Ce of v){if(String(Ce.customer_id)===String(Me||""))continue;const Qe=S(Ce.customer_name||""),ct=Qe===re?1:U(Qe,re);ct>ce&&(ce=ct,$=Ce)}ce>=.92&&(T.customer_name="A similar customer already exists")}P(ce>=.92&&$?$:null),m(re=>({...re,...T}))},[j,t]);const K=a?.customer_id,E=async()=>{if(!(!s||!K))try{const T=await bd(K);C(T.people||[]),A(T.emails||[]),N(T.phones||[])}catch{}},V=async()=>{!K||!g.trim()||(await qv(K,{name:g.trim()}),x(""),E())},q=async T=>{K&&(await Uv(K,T,{is_preferred:!0}),E())},ue=async T=>{K&&(await Wv(K,T),E())},ye=async()=>{!K||!R.trim()||(await Fv(K,{email:R.trim()}),O(""),E())},ge=async T=>{K&&(await $v(K,T,{is_preferred:!0}),E())},xe=async T=>{K&&(await zv(K,T),E())},me=async()=>{!K||!ee.trim()||(await Bv(K,{phone:ee.trim(),label:z.trim()||void 0}),J(""),Z(""),E())},he=async T=>{K&&(await Hv(K,T,{is_preferred:!0}),E())},ae=async T=>{K&&(await Yv(K,T),E())};return e.jsxs(mt,{open:t,onClose:r,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:s?"Edit Customer":"Add New Customer"}),e.jsxs(xt,{children:[e.jsxs(M,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"customer_name",label:"Customer Name",value:c.customer_name,onChange:X,fullWidth:!0,required:!0,error:!!f.customer_name,helperText:f.customer_name,autoFocus:!0})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"contact_person",label:"Contact Person",value:c.contact_person,onChange:X,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"email",label:"Email",type:"email",value:c.email,onChange:X,fullWidth:!0,error:!!f.email,helperText:f.email})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"phone_number",label:"Phone Number",value:c.phone_number,onChange:X,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{name:"street_address",label:"Street Address",value:c.street_address,onChange:X,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"city",label:"City",value:c.city,onChange:X,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"province",label:"Province/State",value:c.province,onChange:X,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"country",label:"Country",value:c.country,onChange:X,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"postal_code",label:"Postal Code",value:c.postal_code,onChange:X,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{name:"website",label:"Website",value:c.website,onChange:X,fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{name:"general_notes",label:"General Notes",value:c.general_notes,onChange:X,fullWidth:!0,multiline:!0,minRows:4})}),s&&K&&e.jsx(M,{item:!0,xs:12,children:e.jsxs(k,{sx:{mt:2},children:[e.jsx(h,{variant:"h6",sx:{mb:1},children:"Contacts"}),e.jsxs(M,{container:!0,spacing:2,children:[e.jsxs(M,{item:!0,xs:12,md:4,children:[e.jsx(h,{variant:"subtitle1",sx:{mb:1},children:"People"}),e.jsxs(ke,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(le,{size:"small",label:"Name",value:g,onChange:T=>x(T.target.value),fullWidth:!0}),e.jsx(G,{variant:"outlined",size:"small",onClick:V,children:"Add"})]}),e.jsxs(ke,{spacing:1,children:[L.map(T=>e.jsxs(ke,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(h,{variant:"body2",sx:{flex:1},children:[T.name," ",T.is_preferred?"(Preferred)":""]}),!T.is_preferred&&e.jsx(G,{size:"small",onClick:()=>q(T.id),children:"Set Preferred"}),e.jsx(G,{size:"small",color:"error",onClick:()=>ue(T.id),children:"Remove"})]},T.id)),L.length===0&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"No people yet."})]})]}),e.jsxs(M,{item:!0,xs:12,md:4,children:[e.jsx(h,{variant:"subtitle1",sx:{mb:1},children:"Emails"}),e.jsxs(ke,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(le,{size:"small",label:"Email",value:R,onChange:T=>O(T.target.value),fullWidth:!0}),e.jsx(G,{variant:"outlined",size:"small",onClick:ye,children:"Add"})]}),e.jsxs(ke,{spacing:1,children:[D.map(T=>e.jsxs(ke,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(h,{variant:"body2",sx:{flex:1},children:[T.email," ",T.is_preferred?"(Preferred)":""]}),!T.is_preferred&&e.jsx(G,{size:"small",onClick:()=>ge(T.id),children:"Set Preferred"}),e.jsx(G,{size:"small",color:"error",onClick:()=>xe(T.id),children:"Remove"})]},T.id)),D.length===0&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"No emails yet."})]})]}),e.jsxs(M,{item:!0,xs:12,md:4,children:[e.jsx(h,{variant:"subtitle1",sx:{mb:1},children:"Phones"}),e.jsxs(ke,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(le,{size:"small",label:"Phone",value:ee,onChange:T=>J(T.target.value),fullWidth:!0}),e.jsx(le,{size:"small",label:"Label",value:z,onChange:T=>Z(T.target.value),sx:{width:120}}),e.jsx(G,{variant:"outlined",size:"small",onClick:me,children:"Add"})]}),e.jsxs(ke,{spacing:1,children:[b.map(T=>e.jsxs(ke,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(h,{variant:"body2",sx:{flex:1},children:[T.phone,T.label?` (${T.label})`:""," ",T.is_preferred?"(Preferred)":""]}),!T.is_preferred&&e.jsx(G,{size:"small",onClick:()=>he(T.id),children:"Set Preferred"}),e.jsx(G,{size:"small",color:"error",onClick:()=>ae(T.id),children:"Remove"})]},T.id)),b.length===0&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"No phones yet."})]})]})]})]})})]}),d&&e.jsx("div",{style:{color:"red",marginTop:8},children:d}),_&&e.jsxs("div",{style:{marginTop:12},children:[e.jsxs("div",{style:{color:"#b26a00",marginBottom:8},children:['Looks like "',_.customer_name,'" already exists.']}),typeof i=="function"&&e.jsx(G,{variant:"outlined",size:"small",onClick:()=>{i(_)},children:"Use existing"})]})]}),e.jsxs(_t,{children:[e.jsx(G,{onClick:r,children:"Cancel"}),e.jsx(G,{onClick:y,variant:"contained",disabled:o,children:s?"Save Changes":"Add Customer"})]})]})},Zv=()=>{Kt();const[t,r]=l.useState([]),[n,a]=l.useState(""),[s,o]=l.useState(null),[i,c]=l.useState(null),[u,d]=l.useState(!1),[p,f]=l.useState({pageSize:10,page:0}),[m,j]=l.useState(!1);l.useEffect(()=>{v()},[]);const v=async()=>{try{const A=await Vv();r(A)}catch(A){console.error("Error fetching customers:",A),H.error("Failed to fetch customers")}},w=async A=>{if(window.confirm("Are you sure you want to delete this customer?"))try{await Qv(A),r(b=>b.filter(N=>N.id!==A)),H.success("Customer deleted successfully")}catch(b){console.error("Error deleting customer:",b),H.error("Failed to delete customer")}},_=A=>{o(A),c({...A}),j(!0),d(!0)},P=()=>{d(!1),o(null),c(null)},L=t.filter(A=>A.customer_name.toLowerCase().includes(n.toLowerCase())||A.email?.toLowerCase().includes(n.toLowerCase())||A.phone_number?.toLowerCase().includes(n.toLowerCase())||`${A.street_address}, ${A.city}, ${A.province}, ${A.country}`.toLowerCase().includes(n.toLowerCase())),C=[{field:"customer_name",headerName:"Customer Name",flex:1.5},{field:"contact_person",headerName:"Contact Person",flex:1},{field:"email",headerName:"Email",flex:1.5},{field:"phone_number",headerName:"Phone Number",flex:1},{field:"actions",headerName:"Actions",width:80,sortable:!1,renderCell:A=>e.jsx(gt,{size:"small",color:"error",onClick:b=>{b.stopPropagation(),w(A.row.id)},children:e.jsx(gr,{})})}],D=()=>{const A=L.map(x=>({customer_name:x.customer_name,contact_person:x.contact_person,email:x.email,phone_number:x.phone_number})),b=Wn.unparse(A),N=new Blob([b],{type:"text/csv;charset=utf-8;"}),g=document.createElement("a");if(g.download!==void 0){const x=URL.createObjectURL(N);g.setAttribute("href",x),g.setAttribute("download","customer_list.csv"),g.style.visibility="hidden",document.body.appendChild(g),g.click(),document.body.removeChild(g)}};return e.jsx(at,{maxWidth:"xl",children:e.jsxs(k,{sx:{my:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Customer List"}),e.jsxs(ke,{direction:"row",spacing:2,sx:{mb:2,justifyContent:"flex-end"},children:[e.jsx(G,{variant:"contained",startIcon:e.jsx(Lr,{}),onClick:()=>{c({id:"",customer_id:"",customer_name:"",email:"",phone:"",phone_number:"",address:"",street_address:"",city:"",state:"",province:"",country:"",postal_code:"",contact_person:"",website:"",general_notes:"",created_at:"",updated_at:""}),j(!1),d(!0)},children:"New Customer"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(yr,{}),onClick:D,children:"Export CSV"})]}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(le,{fullWidth:!0,variant:"outlined",placeholder:"Search customers...",value:n,onChange:A=>a(A.target.value),InputProps:{startAdornment:e.jsx(pr,{position:"start",children:e.jsx(Br,{})})},sx:{mb:2}}),e.jsx(Jr,{rows:L,columns:C,pageSizeOptions:[10,25,50],paginationModel:p,onPaginationModelChange:f,getRowId:A=>A.id,loading:!1,disableRowSelectionOnClick:!0,onRowClick:A=>_(A.row),sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})}),e.jsx(Si,{open:u,onClose:P,onSave:async A=>{try{if(m&&i)await Hp(i.id,A),r(b=>b.map(N=>N.id===i.id?{...N,...A}:N)),H.success("Customer updated successfully");else{const b=await Bp(A);r(N=>[...N,b]),H.success("Customer created successfully")}P()}catch(b){console.error("Error saving customer:",b),H.error(m?"Failed to update customer":"Failed to create customer")}},initialCustomer:i||{},isEditMode:m})]})})},eb=()=>{const{id:t}=wn(),r=Kt(),n=t==="new";console.log("Debug - URL id parameter:",t),console.log("Debug - isNewCustomer calculated:",n);const[a,s]=l.useState(!1),[o,i]=l.useState(!1),[c,u]=l.useState(null),[d,p]=l.useState(!1),[f,m]=l.useState({customer_name:"",email:"",phone_number:"",street_address:"",city:"",province:"",country:"",postal_code:"",contact_person:"",website:"",general_notes:""});l.useEffect(()=>{!n&&t?j():n&&p(!0)},[t,n]);const j=async()=>{s(!0);try{if(!t)throw new Error("Customer ID is required");const w=await Gv(t);m(w)}catch(w){console.error("Error fetching customer:",w),u("Failed to load customer data"),H.error("Failed to load customer data")}finally{s(!1)}},v=()=>{r("/customers")};return a?e.jsx(at,{maxWidth:"md",children:e.jsx(k,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh"},children:e.jsx(it,{})})}):e.jsx(at,{maxWidth:"md",children:e.jsxs(k,{sx:{my:4},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",mb:3},children:[e.jsx(G,{startIcon:e.jsx(qu,{}),onClick:v,sx:{mr:2},children:"Back to Customers"}),e.jsx(h,{variant:"h4",component:"h1",children:n?"Add New Customer":"Edit Customer"})]}),c&&e.jsx(We,{severity:"error",sx:{mb:2},children:c}),e.jsx(Si,{open:d,onClose:()=>{p(!1),v()},onSave:async w=>{i(!0);try{n?(await Bp(w),H.success("Customer created successfully")):(await Hp(t,w),H.success("Customer updated successfully")),r("/customers")}catch{H.error("Failed to save customer")}finally{i(!1)}},initialCustomer:n?{}:f,isEditMode:!n,loading:o})]})})},tb=async()=>(await B.get("/api/vendors")).data,wd=async t=>(await B.get(`/api/vendors/${t}/contacts`)).data,rb=async(t,r)=>(await B.post(`/api/vendors/${t}/contacts/people`,r)).data,nb=async(t,r,n)=>(await B.put(`/api/vendors/${t}/contacts/people/${r}`,n)).data,sb=async(t,r)=>(await B.delete(`/api/vendors/${t}/contacts/people/${r}`)).data,ab=async(t,r)=>(await B.post(`/api/vendors/${t}/contacts/emails`,r)).data,ob=async(t,r,n)=>(await B.put(`/api/vendors/${t}/contacts/emails/${r}`,n)).data,ib=async(t,r)=>(await B.delete(`/api/vendors/${t}/contacts/emails/${r}`)).data,lb=async(t,r)=>(await B.post(`/api/vendors/${t}/contacts/phones`,r)).data,cb=async(t,r,n)=>(await B.put(`/api/vendors/${t}/contacts/phones/${r}`,n)).data,db=async(t,r)=>(await B.delete(`/api/vendors/${t}/contacts/phones/${r}`)).data,Sd={vendor_name:"",street_address:"",city:"",province:"",country:"",postal_code:"",contact_person:"",telephone_number:"",email:"",website:""},Vp=({open:t,onClose:r,onSave:n,initialVendor:a,isEditMode:s=!1,loading:o=!1})=>{const[i,c]=l.useState(Sd),[u,d]=l.useState({}),p=wi(i,300),[f,m]=l.useState([]),[j,v]=l.useState([]),[w,_]=l.useState([]),[P,L]=l.useState([]),[C,D]=l.useState(""),[A,b]=l.useState(""),[N,g]=l.useState(""),[x,R]=l.useState("");l.useEffect(()=>{if(t){console.log("UnifiedVendorDialog: Setting vendor with initialVendor:",a);const q={...Sd,...a};c(q),!s&&!a?.city&&!a?.province&&!a?.country&&J(),(async()=>{try{const ye=await B.get("/api/vendors");m(ye.data||[])}catch{}})();const ue=a?.vendor_id;s&&ue?(async()=>{try{const ye=await wd(ue);v(ye.people||[]),_(ye.emails||[]),L(ye.phones||[])}catch{}})():(v([]),_([]),L([]))}},[t,a,s]);const O=q=>{const{name:ue,value:ye}=q.target;c(ge=>({...ge,[ue]:ye})),u[ue]&&d(ge=>({...ge,[ue]:void 0}))},ee=()=>{n(i)};l.useEffect(()=>{if(!t)return;const q={};if(p.email&&p.email.trim().length>0&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p.email.trim())||(q.email="Invalid email format")),p.vendor_name&&p.vendor_name.trim().length>0){const ue=p.vendor_name.trim().toLowerCase();f.some(ge=>(ge.vendor_name||"").trim().toLowerCase()===ue)&&!s&&(q.vendor_name="Vendor name already exists")}d(ue=>({...ue,...q}))},[p,t,s,f]);const J=async()=>{try{const q=await Yp();c(ue=>({...ue,city:q.city,province:q.province,country:q.country})),console.log("Autofilled vendor form with business profile data:",q)}catch(q){console.error("Error autofilling from business profile:",q)}},z=a?.vendor_id,Z=async()=>{if(!(!s||!z))try{const q=await wd(z);v(q.people||[]),_(q.emails||[]),L(q.phones||[])}catch{}},Q=async()=>{!z||!C.trim()||(await rb(z,{name:C.trim()}),D(""),Z())},X=async q=>{z&&(await nb(z,q,{is_preferred:!0}),Z())},I=async q=>{z&&(await sb(z,q),Z())},y=async()=>{!z||!A.trim()||(await ab(z,{email:A.trim()}),b(""),Z())},S=async q=>{z&&(await ob(z,q,{is_preferred:!0}),Z())},U=async q=>{z&&(await ib(z,q),Z())},K=async()=>{!z||!N.trim()||(await lb(z,{phone:N.trim(),label:x.trim()||void 0}),g(""),R(""),Z())},E=async q=>{z&&(await cb(z,q,{is_preferred:!0}),Z())},V=async q=>{z&&(await db(z,q),Z())};return e.jsxs(mt,{open:t,onClose:r,maxWidth:"md",fullWidth:!0,sx:{zIndex:q=>q.zIndex.modal+5},children:[e.jsx(ft,{children:s?"Edit Vendor":"Add New Vendor"}),e.jsx(xt,{sx:{form:{autoComplete:"off"}},children:e.jsxs(M,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"vendor_name",label:"Vendor Name",value:i.vendor_name,onChange:O,fullWidth:!0,required:!0,error:!!u.vendor_name,helperText:u.vendor_name,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"contact_person",label:"Contact Person",value:i.contact_person,onChange:O,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"email",label:"Email",type:"email",value:i.email,onChange:O,fullWidth:!0,error:!!u.email,helperText:u.email,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"telephone_number",label:"Telephone",value:i.telephone_number,onChange:O,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{name:"street_address",label:"Street Address",value:i.street_address,onChange:O,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"city",label:"City",value:i.city,onChange:O,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"province",label:"Province/State",value:i.province,onChange:O,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"country",label:"Country",value:i.country,onChange:O,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{name:"postal_code",label:"Postal Code",value:i.postal_code,onChange:O,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{name:"website",label:"Website",value:i.website,onChange:O,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),s&&z&&e.jsx(M,{item:!0,xs:12,children:e.jsxs(k,{sx:{mt:2},children:[e.jsx(h,{variant:"h6",sx:{mb:1},children:"Contacts"}),e.jsxs(M,{container:!0,spacing:2,children:[e.jsxs(M,{item:!0,xs:12,md:4,children:[e.jsx(h,{variant:"subtitle1",sx:{mb:1},children:"People"}),e.jsxs(ke,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(le,{size:"small",label:"Name",value:C,onChange:q=>D(q.target.value),fullWidth:!0}),e.jsx(G,{variant:"outlined",size:"small",onClick:Q,children:"Add"})]}),e.jsxs(ke,{spacing:1,children:[j.map(q=>e.jsxs(ke,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(h,{variant:"body2",sx:{flex:1},children:[q.name," ",q.is_preferred?"(Preferred)":""]}),!q.is_preferred&&e.jsx(G,{size:"small",onClick:()=>X(q.id),children:"Set Preferred"}),e.jsx(G,{size:"small",color:"error",onClick:()=>I(q.id),children:"Remove"})]},q.id)),j.length===0&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"No people yet."})]})]}),e.jsxs(M,{item:!0,xs:12,md:4,children:[e.jsx(h,{variant:"subtitle1",sx:{mb:1},children:"Emails"}),e.jsxs(ke,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(le,{size:"small",label:"Email",value:A,onChange:q=>b(q.target.value),fullWidth:!0}),e.jsx(G,{variant:"outlined",size:"small",onClick:y,children:"Add"})]}),e.jsxs(ke,{spacing:1,children:[w.map(q=>e.jsxs(ke,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(h,{variant:"body2",sx:{flex:1},children:[q.email," ",q.is_preferred?"(Preferred)":""]}),!q.is_preferred&&e.jsx(G,{size:"small",onClick:()=>S(q.id),children:"Set Preferred"}),e.jsx(G,{size:"small",color:"error",onClick:()=>U(q.id),children:"Remove"})]},q.id)),w.length===0&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"No emails yet."})]})]}),e.jsxs(M,{item:!0,xs:12,md:4,children:[e.jsx(h,{variant:"subtitle1",sx:{mb:1},children:"Phones"}),e.jsxs(ke,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(le,{size:"small",label:"Phone",value:N,onChange:q=>g(q.target.value),fullWidth:!0}),e.jsx(le,{size:"small",label:"Label",value:x,onChange:q=>R(q.target.value),sx:{width:120}}),e.jsx(G,{variant:"outlined",size:"small",onClick:K,children:"Add"})]}),e.jsxs(ke,{spacing:1,children:[P.map(q=>e.jsxs(ke,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(h,{variant:"body2",sx:{flex:1},children:[q.phone,q.label?` (${q.label})`:""," ",q.is_preferred?"(Preferred)":""]}),!q.is_preferred&&e.jsx(G,{size:"small",onClick:()=>E(q.id),children:"Set Preferred"}),e.jsx(G,{size:"small",color:"error",onClick:()=>V(q.id),children:"Remove"})]},q.id)),P.length===0&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"No phones yet."})]})]})]})]})})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:r,children:"Cancel"}),e.jsx(G,{onClick:ee,variant:"contained",disabled:o,children:s?"Save Changes":"Add Vendor"})]})]})},ub=()=>{const[t,r]=l.useState(""),[n,a]=l.useState([]),[s,o]=l.useState(!1),[i,c]=l.useState({page:0,pageSize:10}),[u,d]=l.useState(!1),[p,f]=l.useState(!1),[m,j]=l.useState({}),v=n.filter(A=>(A.vendor_name||"").toLowerCase().includes(t.toLowerCase())||(A.contact_person||"").toLowerCase().includes(t.toLowerCase())||(A.email||"").toLowerCase().includes(t.toLowerCase())),w=[{field:"vendor_name",headerName:"Vendor Name",flex:1.5},{field:"contact_person",headerName:"Contact Person",flex:1},{field:"email",headerName:"Email",flex:1.5},{field:"telephone_number",headerName:"Phone Number",flex:1},{field:"actions",headerName:"Actions",width:100,sortable:!1,renderCell:A=>e.jsx(gt,{size:"small",color:"error",onClick:b=>{b.stopPropagation(),C(A.row.vendor_id)},children:e.jsx(gr,{})})}],_=async()=>{o(!0);try{const b=(await tb()).map(N=>({...N,id:N.vendor_id}));a(b)}catch{H.error("Failed to fetch vendors.")}finally{o(!1)}};l.useEffect(()=>{_()},[]);const P=(A=null)=>{A?(f(!0),j(A)):(f(!1),j({vendor_name:"",street_address:"",city:"",province:"",country:"",contact_person:"",telephone_number:"",email:"",website:"",postal_code:""})),d(!0)},L=()=>{d(!1),j({})},C=async A=>{if(window.confirm("Are you sure you want to delete this vendor?"))try{await B.delete(`/api/vendors/${A}`),H.success("Vendor deleted successfully!"),_()}catch(b){b instanceof kr?H.error(b.response?.data?.error||"Failed to delete vendor."):H.error("An unexpected error occurred while deleting the vendor.")}},D=()=>{const A=Wn.unparse(v),b=new Blob([A],{type:"text/csv;charset=utf-8;"}),N=document.createElement("a");if(N.download!==void 0){const g=URL.createObjectURL(b);N.setAttribute("href",g),N.setAttribute("download","vendor_list.csv"),N.style.visibility="hidden",document.body.appendChild(N),N.click(),document.body.removeChild(N)}};return e.jsxs(at,{maxWidth:"xl",children:[e.jsxs(k,{sx:{my:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Vendor Management"}),e.jsxs(ke,{direction:"row",spacing:2,sx:{mb:2,justifyContent:"flex-end"},children:[e.jsx(G,{variant:"contained",startIcon:e.jsx(Lr,{}),onClick:()=>P(),children:"New Vendor"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(yr,{}),onClick:D,children:"Export CSV"})]}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2,width:"100%"},children:[e.jsx(le,{fullWidth:!0,variant:"outlined",placeholder:"Search vendors...",value:t,onChange:A=>r(A.target.value),InputProps:{startAdornment:e.jsx(pr,{position:"start",children:e.jsx(Br,{})})},sx:{mb:2}}),e.jsx(Jr,{rows:v,columns:w,loading:s,paginationModel:i,onPaginationModelChange:c,pageSizeOptions:[10,25,50],getRowId:A=>A.vendor_id,onRowClick:A=>P(A.row),disableRowSelectionOnClick:!0,sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]}),e.jsx(Vp,{open:u,onClose:L,onSave:async A=>{try{p?(await B.put(`/api/vendors/${m.vendor_id}`,A),H.success("Vendor updated successfully!")):(await B.post("/api/vendors",A),H.success("Vendor added successfully!")),L(),_()}catch(b){b instanceof kr?H.error(b.response?.data?.error||`Failed to ${p?"update":"add"} vendor.`):H.error(`An unexpected error occurred while ${p?"updating":"adding"} the vendor.`)}},initialVendor:m,isEditMode:p})]})},pb=()=>{const{id:t}=wn();return e.jsx(at,{maxWidth:"md",children:e.jsxs(k,{sx:{my:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Vendor Detail Page"}),e.jsxs(Ae,{sx:{p:3},children:[e.jsxs(h,{variant:"h6",children:["Vendor ID: ",t]}),e.jsx(h,{variant:"body1",children:"This is a placeholder for the Vendor Detail Page."})]})]})})},hb=()=>{const{id:t}=wn();return e.jsx(at,{maxWidth:"md",children:e.jsxs(k,{sx:{my:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Product Detail Page"}),e.jsxs(Ae,{sx:{p:3},children:[e.jsxs(h,{variant:"h6",children:["Product ID: ",t]}),e.jsx(h,{variant:"body1",children:"This is a placeholder for the Product Detail Page."})]})]})})};var ja={},Cd;function mb(){if(Cd)return ja;Cd=1;var t=yt();Object.defineProperty(ja,"__esModule",{value:!0}),ja.default=void 0;var r=t(bt()),n=vt();return ja.default=(0,r.default)((0,n.jsx)("path",{d:"M5 20h14v-2H5zm0-10h4v6h6v-6h4l-7-7z"}),"Upload"),ja}var fb=mb();const Gp=st(fb),Qp=async t=>{const r=t?{partType:t}:{};return(await B.get("/api/inventory",{params:r})).data},xb=async()=>Qp("stock"),gb=async()=>Qp("supply"),yb=async t=>(await B.get(`/api/inventory/${encodeURIComponent(t)}`)).data,vb=async t=>(await B.post("/api/inventory/cleanup-enforce",{partType:t,apply:!1})).data,Kp=async(t,r)=>(await B.post("/api/inventory/cleanup-enforce",{partType:t,apply:!0,merges:r})).data,Fo=async t=>(await B.get(`/api/inventory/${encodeURIComponent(t)}/vendors`)).data,Co=async t=>(await B.get(`/api/inventory/part/${t}/vendors`)).data,bb=async(t,r)=>(await B.post(`/api/inventory/${encodeURIComponent(t)}/vendors`,r)).data,_b=async(t,r)=>(await B.post(`/api/inventory/part/${t}/vendors`,r)).data,jb=async(t,r,n)=>(await B.put(`/api/inventory/${encodeURIComponent(t)}/vendors/${r}`,n)).data,wb=async(t,r,n)=>(await B.put(`/api/inventory/part/${t}/vendors/${r}`,n)).data,Sb=async(t,r)=>(await B.delete(`/api/inventory/${encodeURIComponent(t)}/vendors/${r}`)).data,Cb=async(t,r)=>(await B.delete(`/api/inventory/part/${t}/vendors/${r}`)).data,kb=async()=>(await B.get("/api/categories")).data,Pb=async t=>(await B.post("/api/categories",t)).data.category,kd=async(t,r)=>{const n=r?{reassign:"true"}:{};await B.delete(`/api/categories/${t}`,{params:n})},Gi="__ADD_NEW_CATEGORY__",Db=({value:t,onChange:r,label:n="Category",error:a,errorMessage:s,fullWidth:o=!0,disabled:i})=>{const[c,u]=l.useState([]),[d,p]=l.useState(!1),[f,m]=l.useState(!1),[j,v]=l.useState(""),[w,_]=l.useState(""),[P,L]=l.useState(!1),{user:C}=Zt();l.useEffect(()=>{let g=!0;return(async()=>{p(!0);try{const R=await kb();g&&u(R)}catch(R){console.error("CategorySelect: failed to load categories",R),H.error("Failed to load categories")}finally{g&&p(!1)}})(),()=>{g=!1}},[]);const D=l.useMemo(()=>{const g=c.map(x=>x.category_name);return g.some(x=>x.toLowerCase()==="uncategorized")||g.unshift("Uncategorized"),g.sort((x,R)=>x.localeCompare(R))},[c]),A=g=>{const x=g.target.value;if(x===Gi){m(!0);return}r(x)},b=async(g,x)=>{if(x?.preventDefault(),x?.stopPropagation(),g.category_name.toLowerCase()==="uncategorized"){H.warn('Cannot delete the default "Uncategorized" category');return}if(C?.access_role!=="Admin"){H.error("Only Admin users can delete categories");return}if(window.confirm(`Delete category "${g.category_name}"? This cannot be undone.`))try{await kd(g.category_id),u(O=>O.filter(ee=>ee.category_id!==g.category_id)),t&&t.toLowerCase()===g.category_name.toLowerCase()&&r("Uncategorized"),H.success("Category deleted")}catch(O){const ee=O?.response?.data;if(ee?.error==="Cannot delete category"&&ee?.suggestion){if(window.confirm(`${ee.details}

${ee.suggestion}

Would you like to reassign all items to "Uncategorized" and delete the category?`))try{await kd(g.category_id,!0),u(z=>z.filter(Z=>Z.category_id!==g.category_id)),t&&t.toLowerCase()===g.category_name.toLowerCase()&&r("Uncategorized"),H.success(ee.details?`Category deleted. ${ee.details}`:"Category deleted")}catch(z){const Z=z?.response?.data?.error||"Failed to delete category";H.error(Z)}}else{const J=ee?.error||"Failed to delete category";H.error(J)}}},N=async()=>{const g=j.trim();if(!g){H.warn("Please enter a category name");return}if(D.some(x=>x.toLowerCase()===g.toLowerCase())){H.warn("Category already exists");return}L(!0);try{const x=w.trim(),R=await Pb({category_name:g,description:x||void 0});u(O=>[...O,R]),m(!1),v(""),_(""),r(R.category_name),H.success("Category added")}catch(x){console.error("CategorySelect: failed to create category",x),H.error("Failed to add category")}finally{L(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(le,{label:n,value:t,onChange:A,select:!0,fullWidth:o,required:!0,error:!!a,helperText:s,disabled:i||d,children:[c.slice().sort((g,x)=>g.category_name.localeCompare(x.category_name)).map(g=>e.jsxs(et,{value:g.category_name,sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:g.category_name}),C?.access_role==="Admin"&&g.category_name.toLowerCase()!=="uncategorized"&&e.jsx(gt,{"aria-label":`Delete ${g.category_name}`,size:"small",edge:"end",onClick:x=>b(g,x),sx:{ml:2,color:"error.main"},children:e.jsx(gr,{fontSize:"small"})})]},g.category_id)),e.jsx(et,{value:Gi,children:"+ Add new category"},Gi)]}),e.jsxs(mt,{open:f,onClose:()=>m(!1),maxWidth:"xs",fullWidth:!0,children:[e.jsx(ft,{children:"Add New Category"}),e.jsx(xt,{children:e.jsxs(ke,{spacing:2,sx:{mt:1},children:[e.jsx(le,{label:"Category Name",value:j,onChange:g=>v(g.target.value),autoFocus:!0,fullWidth:!0}),e.jsx(le,{label:"Description (optional)",value:w,onChange:g=>_(g.target.value),fullWidth:!0,multiline:!0,minRows:2})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>m(!1),disabled:P,children:"Cancel"}),e.jsx(G,{onClick:N,variant:"contained",disabled:P,children:"Save"})]})]})]})},Qi=["Each","cm","ft","kg","pcs","L"],Eb=["stock","supply","service"],ts=({open:t,onClose:r,onSave:n,initialPart:a,isEditMode:s=!1,title:o})=>{const{user:i}=Zt(),[c,u]=l.useState({part_number:"",part_description:"",unit:Qi[0],last_unit_cost:"",quantity_on_hand:"",reorder_point:"",part_type:"stock",category:"Uncategorized",...a||{}}),[d,p]=l.useState({}),[f,m]=l.useState(!1),j=l.useRef(null);l.useEffect(()=>{t&&(u({part_id:a?.part_id,part_number:a?.part_number||"",part_description:a?.part_description||"",unit:a?.unit||Qi[0],last_unit_cost:a?.last_unit_cost||"",quantity_on_hand:a?.quantity_on_hand||"",reorder_point:a?.reorder_point||"",part_type:a?.part_type||"stock",category:a?.category||"Uncategorized"}),p({}),m(!1))},[t,a?.part_id,a?.part_number]),l.useEffect(()=>{t&&j.current&&setTimeout(()=>j.current?.focus(),100)},[t]);const v=(y,S)=>{y==="part_number"&&(S=S.toUpperCase()),u(y==="part_type"&&(S==="supply"||S==="service")?U=>({...U,[y]:S,quantity_on_hand:"NA"}):U=>({...U,[y]:S})),d[y]&&p(U=>({...U,[y]:void 0}))},w=()=>{const y={};c.part_number.trim()||(y.part_number="Part Number is required"),c.part_number&&/\s/.test(c.part_number)&&(y.part_number="Part Number cannot contain spaces"),c.part_number&&!/^[A-Z0-9()\/-]+$/.test(c.part_number)&&(y.part_number="Only letters/numbers and - / ( ) are allowed");const S=c.part_number;if(S&&S.includes("/")&&((()=>{const V=[];for(let xe=0;xe<S.length;xe++)S[xe]==="/"&&V.push(xe);if(V.length===0)return!0;const q=new Array(S.length).fill(-1);let ue=-1;for(let xe=0;xe<S.length;xe++)S[xe]==="("&&(ue=xe),q[xe]=ue;const ye=new Array(S.length).fill(-1);let ge=-1;for(let xe=S.length-1;xe>=0;xe--)S[xe]===")"&&(ge=xe),ye[xe]=ge;return V.every(xe=>q[xe]!==-1&&ye[xe]!==-1&&q[xe]<xe&&xe<ye[xe])})()||(y.part_number="Fractions must be enclosed in parentheses, e.g., (1/2)")),c.part_description.trim()||(y.part_description="Part Description is required"),c.unit||(y.unit="Unit is required"),c.part_type||(y.part_type="Part Type is required"),["stock","supply","service"].includes(c.part_type)||(y.part_type='Part Type must be either "stock", "supply", or "service"'),(!c.category||c.category.trim()==="")&&(y.category="Category is required"),!(c.part_type==="supply"||c.part_type==="service")){const E=parseFloat(String(c.quantity_on_hand));c.quantity_on_hand!==""&&(isNaN(E)||E<0)&&(y.quantity_on_hand="Quantity on Hand must be a valid number >= 0")}const U=parseFloat(String(c.last_unit_cost));c.last_unit_cost!==""&&isNaN(U)&&(y.last_unit_cost="Last Unit Cost must be a valid number");const K=parseFloat(String(c.reorder_point));return c.reorder_point!==""&&isNaN(K)&&(y.reorder_point="Reorder Point must be a valid number"),p(y),Object.keys(y).length===0},_=async()=>{if(!w()){H.error("Please correct the errors before saving.");return}m(!0);try{const y={...c,part_number:c.part_number.trim().toUpperCase(),part_description:c.part_description.trim(),unit:c.unit.trim(),last_unit_cost:c.last_unit_cost===""?null:parseFloat(String(c.last_unit_cost)),quantity_on_hand:c.part_type==="supply"?"NA":c.quantity_on_hand===""?0:parseFloat(String(c.quantity_on_hand)),reorder_point:c.reorder_point===""?null:parseFloat(String(c.reorder_point)),part_type:c.part_type.trim(),category:c.category.trim()};await n(y),H.success(`Part ${s?"updated":"added"} successfully!`),r()}catch(y){console.error("Error saving part:",y);let S=`Failed to ${s?"update":"add"} part.`;y.response?.data?.error?S=y.response.data.error:y.response?.data?.message&&(S=y.response.data.message),y.response?.status===409||S.includes("Part number already exists")||S.includes("duplicate key value")||S.includes("already exists")?(p(U=>({...U,part_number:"Part number already exists. Please use a unique part number."})),H.error("Part number already exists. Please use a unique part number.")):H.error(S)}finally{m(!1)}},P=()=>{f||r()},L=o||(s?"Edit Part":"Add New Part"),[C,D]=l.useState([]),[A,b]=l.useState([]),[N,g]=l.useState(""),[x,R]=l.useState(""),[O,ee]=l.useState(""),[J,z]=l.useState(!1),Z=!!c.part_id;l.useEffect(()=>{t&&(async()=>{try{const y=await B.get("/api/vendors");b(y.data||[])}catch{}})()},[t]),l.useEffect(()=>{if(!t)return;const y=c.part_id;if(!y){D([]);return}(async()=>{try{const S=await Co(y);D(S||[])}catch{D([])}})()},[t,c.part_id]);const Q=async()=>{const y=String(c.part_number||"").trim().toUpperCase();if(y){if(!N||!x.trim()){H.error("Select a vendor and enter vendor part number");return}try{const S={vendor_id:Number(N),vendor_part_number:x.trim().toUpperCase(),vendor_part_description:O||void 0,preferred:J};if(c.part_id){await _b(c.part_id,S);const U=await Co(c.part_id);D(U||[])}else{await bb(y,S);const U=await Fo(y);D(U||[])}g(""),R(""),ee(""),z(!1),H.success("Vendor mapping added")}catch(S){H.error(S?.response?.data?.error||"Failed to add vendor mapping")}}},X=async y=>{try{if(c.part_id){await wb(c.part_id,y.id,{preferred:!y.preferred});const S=await Co(c.part_id);D(S||[])}else{await jb(c.part_number.toUpperCase(),y.id,{preferred:!y.preferred});const S=await Fo(c.part_number.toUpperCase());D(S||[])}}catch{H.error("Failed to update preferred")}},I=async y=>{if(window.confirm("Remove this vendor mapping?"))try{if(c.part_id){await Cb(c.part_id,y.id);const S=await Co(c.part_id);D(S||[])}else{await Sb(c.part_number.toUpperCase(),y.id);const S=await Fo(c.part_number.toUpperCase());D(S||[])}}catch{H.error("Failed to delete mapping")}};return e.jsxs(mt,{open:t,onClose:P,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:L}),e.jsx(xt,{children:e.jsxs(ke,{spacing:3,sx:{mt:1},children:[e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Part Number",value:c.part_number,onChange:y=>v("part_number",y.target.value),fullWidth:!0,required:!0,error:!!d.part_number,helperText:d.part_number,inputRef:j})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Part Type",value:c.part_type,onChange:y=>v("part_type",y.target.value),select:!0,fullWidth:!0,required:!0,error:!!d.part_type,helperText:d.part_type,children:Eb.map(y=>e.jsx(et,{value:y,children:y.charAt(0).toUpperCase()+y.slice(1)},y))})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(Db,{label:"Category",value:c.category,onChange:y=>v("category",y),error:!!d.category,errorMessage:d.category})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Part Description",value:c.part_description,onChange:y=>v("part_description",y.target.value),fullWidth:!0,required:!0,error:!!d.part_description,helperText:d.part_description,multiline:!0,rows:2})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Unit",value:c.unit,onChange:y=>v("unit",y.target.value),select:!0,fullWidth:!0,required:!0,error:!!d.unit,helperText:d.unit,children:Qi.map(y=>e.jsx(et,{value:y,children:y},y))})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Last Unit Cost",value:c.last_unit_cost,onChange:y=>v("last_unit_cost",y.target.value),type:"number",fullWidth:!0,error:!!d.last_unit_cost,helperText:d.last_unit_cost,inputProps:{step:"0.01",min:"0"}})}),c.part_type!=="supply"&&e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Quantity on Hand",value:c.quantity_on_hand,onChange:y=>v("quantity_on_hand",y.target.value),type:"number",fullWidth:!0,error:!!d.quantity_on_hand,helperText:d.quantity_on_hand,inputProps:{step:"1",min:"0"},disabled:i?.access_role==="Sales and Purchase"})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Reorder Point",value:c.reorder_point,onChange:y=>v("reorder_point",y.target.value),type:"number",fullWidth:!0,error:!!d.reorder_point,helperText:d.reorder_point,inputProps:{step:"1",min:"0"}})})]}),Object.keys(d).length>0&&e.jsx(We,{severity:"error",children:e.jsx(h,{variant:"body2",children:"Please correct the errors above before saving."})}),e.jsxs(k,{children:[e.jsx(h,{variant:"h6",sx:{mb:1},children:"Vendors"}),!Z&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"Save the part first to manage vendor mappings."}),Z&&e.jsxs(e.Fragment,{children:[e.jsxs(M,{container:!0,spacing:1,sx:{mb:1},children:[e.jsx(M,{item:!0,xs:12,sm:3,children:e.jsxs(le,{label:"Vendor",select:!0,value:N,onChange:y=>g(y.target.value===""?"":Number(y.target.value)),fullWidth:!0,SelectProps:{native:!0},children:[e.jsx("option",{value:""}),A.map(y=>e.jsx("option",{value:y.vendor_id,children:y.vendor_name},y.vendor_id))]})}),e.jsx(M,{item:!0,xs:12,sm:3,children:e.jsx(le,{label:"Vendor Part #",value:x,onChange:y=>R(y.target.value),fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Vendor Part Description",value:O,onChange:y=>ee(y.target.value),fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:2,children:e.jsx(G,{variant:"outlined",onClick:()=>z(y=>!y),fullWidth:!0,children:J?"Preferred ":"Preferred"})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(G,{variant:"contained",onClick:Q,children:"Add Vendor Mapping"})})]}),C.length===0?e.jsx(h,{variant:"body2",color:"text.secondary",children:"No vendor mappings yet."}):e.jsxs(M,{container:!0,spacing:1,children:[e.jsx(M,{item:!0,xs:12,children:e.jsxs(M,{container:!0,spacing:1,sx:{fontWeight:600,mb:1},children:[e.jsx(M,{item:!0,xs:12,sm:2.5,children:"Vendor"}),e.jsx(M,{item:!0,xs:12,sm:2.5,children:"Vendor Part #"}),e.jsx(M,{item:!0,xs:12,sm:3,children:"Description"}),e.jsx(M,{item:!0,xs:12,sm:1,children:"Pref"}),e.jsx(M,{item:!0,xs:12,sm:3,children:"Actions"})]})}),C.map(y=>e.jsx(M,{item:!0,xs:12,children:e.jsxs(M,{container:!0,spacing:1,alignItems:"center",sx:{py:1,borderBottom:"1px solid #e0e0e0"},children:[e.jsx(M,{item:!0,xs:12,sm:2.5,children:e.jsx(h,{variant:"body2",noWrap:!0,children:y.vendor_name||y.vendor_id})}),e.jsx(M,{item:!0,xs:12,sm:2.5,children:e.jsx(h,{variant:"body2",noWrap:!0,children:y.vendor_part_number})}),e.jsx(M,{item:!0,xs:12,sm:3,children:e.jsx(h,{variant:"body2",noWrap:!0,children:y.vendor_part_description||""})}),e.jsx(M,{item:!0,xs:12,sm:1,sx:{textAlign:"center"},children:y.preferred?"":""}),e.jsx(M,{item:!0,xs:12,sm:3,children:e.jsxs(ke,{direction:"row",spacing:1,sx:{flexWrap:"wrap"},children:[e.jsx(G,{size:"small",variant:"outlined",onClick:()=>X(y),sx:{minWidth:"fit-content"},children:y.preferred?"Unset":"Set Preferred"}),e.jsx(G,{size:"small",color:"error",variant:"outlined",onClick:()=>I(y),sx:{minWidth:"fit-content"},children:"Remove"})]})})]})},y.id))]})]})]})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:P,disabled:f,children:"Cancel"}),e.jsx(G,{onClick:_,variant:"contained",disabled:f,children:f?"Saving...":s?"Update Part":"Save Part"})]})]})},Ib=()=>{const[t,r]=l.useState(""),[n,a]=l.useState([]),[s,o]=l.useState(!1),[i,c]=l.useState(!1),[u,d]=l.useState(null),[p,f]=l.useState(!1),[m,j]=l.useState(0),[v,w]=l.useState(null),[_,P]=l.useState(!1),L=l.useRef(null),[C,D]=l.useState(!1),[A,b]=l.useState(null),[N,g]=l.useState(!1),[x,R]=l.useState(null),[O,ee]=l.useState(!1),[J,z]=l.useState({page:0,pageSize:10}),{user:Z}=Zt(),Q=async()=>{o(!0);try{const $=await xb();console.log("Raw inventory response:",$),$.length>0&&console.log("Sample inventory item from frontend:",{part_id:$[0].part_id,part_number:$[0].part_number,last_unit_cost:$[0].last_unit_cost,last_unit_cost_type:typeof $[0].last_unit_cost,quantity_on_hand:$[0].quantity_on_hand,quantity_on_hand_type:typeof $[0].quantity_on_hand});const ce=$.map((re,Me)=>({...re,id:re.part_number||Me}));a(ce)}catch($){console.error("Error fetching inventory:",$)}finally{o(!1)}};l.useEffect(()=>{Q();const $=()=>Q();return window.addEventListener("inventory-updated",$),()=>window.removeEventListener("inventory-updated",$)},[]);const X=n.filter($=>$.part_number?.toUpperCase().includes(t.toUpperCase())||$.part_description?.toLowerCase().includes(t.toLowerCase())),I=[{field:"part_number",headerName:"Part #",flex:1,headerAlign:"left",editable:!0},{field:"part_description",headerName:"Part Description",flex:2,headerAlign:"left"},{field:"category",headerName:"Category",flex:1,headerAlign:"left"},{field:"quantity_on_hand",headerName:"Quantity on Hand",flex:1,type:"number",editable:Z?.access_role!=="Sales and Purchase",align:"center",headerAlign:"left"},{field:"unit",headerName:"UOM",flex:.5,headerAlign:"left"},{field:"last_unit_cost",headerName:"Last Unit Cost",flex:1,type:"number",editable:!0,align:"center",headerAlign:"left",valueFormatter:$=>`$${(Number($.value)||0).toFixed(2)}`,valueGetter:$=>Number($.value)||0},{field:"reorder_point",headerName:"Reorder Point",flex:.75,type:"number",editable:!0,align:"center",headerAlign:"left"},{field:"value",headerName:"Value",flex:1,type:"number",valueGetter:$=>{const ce=Number($.row.quantity_on_hand)||0,re=Number($.row.last_unit_cost)||0;return ce*re},valueFormatter:$=>`$${(Number($.value)||0).toFixed(2)}`,headerAlign:"center",align:"center"},{field:"actions",headerName:"Actions",width:100,headerAlign:"left",sortable:!1,renderCell:$=>e.jsx(gt,{size:"small",color:"error",onClick:ce=>{ce.stopPropagation(),y($.row.part_number)},children:e.jsx(gr,{fontSize:"medium",sx:{fontSize:28}})})}].filter(Boolean),y=async $=>{if(window.confirm(`Are you sure you want to delete part ${$}?`))try{console.log(`Deleting part: ${$}`);const ce=await B.delete(`/api/inventory/${encodeURIComponent($)}`);console.log(`Part ${$} deleted successfully:`,ce.data),alert(`Part ${$} deleted successfully!`),Q()}catch(ce){console.error(`Error deleting part ${$}:`,ce),alert(`Error deleting part ${$}. Please check the console.`)}},S=async($,ce)=>{console.log("Attempting to update row:",$);const re={};if($.part_number!==ce.part_number){const Ce=String($.part_number).trim().toUpperCase();if(!Ce)return alert("Part number cannot be empty."),Promise.reject("Invalid part number");re.part_number=Ce}if($.quantity_on_hand!==ce.quantity_on_hand){if(Z?.access_role==="Sales and Purchase")return alert("Sales and Purchase users cannot modify quantity on hand for existing parts."),Promise.reject("Access denied");const Ce=parseFloat(String($.quantity_on_hand));if(isNaN(Ce))return alert("Invalid quantity value. Please enter a valid number."),Promise.reject("Invalid quantity");re.quantity_on_hand=Ce}if($.reorder_point!==ce.reorder_point){const Ce=parseFloat(String($.reorder_point));if(isNaN(Ce))return alert("Invalid reorder point value. Please enter a valid number."),Promise.reject("Invalid reorder point");re.reorder_point=Ce}if($.last_unit_cost!==ce.last_unit_cost){const Ce=parseFloat(String($.last_unit_cost));if(isNaN(Ce))return alert("Invalid last unit cost value. Please enter a valid number."),Promise.reject("Invalid last unit cost");re.last_unit_cost=Ce}if($.category!==ce.category&&(re.category=$.category),Object.keys(re).length===0)return console.log("No fields changed."),$;const Me=ce.part_number;try{console.log(" processRowUpdate: Sending PUT request"),console.log(" URL:",`/api/inventory/${encodeURIComponent(Me)}`),console.log(" Request body:",re),console.log(" Old part number:",ce.part_number),console.log(" New part number:",$.part_number);const Ce=await B.put(`/api/inventory/${encodeURIComponent(Me)}`,re);return console.log(`Inventory updated for part ${Me}:`,Ce.data),alert(`Part ${Me} updated successfully!`),await Q(),Ce.data.updatedItem||$}catch(Ce){return console.error(`Error updating inventory for part ${Me}:`,Ce),Ce instanceof kr&&Ce.response&&Ce.response.data&&Ce.response.data.error?alert(`Error updating inventory: ${Ce.response.data.error}`):alert(`Error updating inventory for part ${Me}. Please check the console.`),Promise.reject(Ce)}},U=()=>{const $=X.map(Ce=>({...Ce,value:(Number(Ce.quantity_on_hand)||0)*(Number(Ce.last_unit_cost)||0)})),ce=Wn.unparse($),re=new Blob([ce],{type:"text/csv;charset=utf-8;"}),Me=document.createElement("a");if(Me.download!==void 0){const Ce=URL.createObjectURL(re);Me.setAttribute("href",Ce),Me.setAttribute("download","inventory_list.csv"),Me.style.visibility="hidden",document.body.appendChild(Me),Me.click()}},K=()=>{d(null),c(!0)},E=async $=>{const ce={...$,part_number:$.part_number.trim().toUpperCase(),part_description:$.part_description.trim(),unit:$.unit.trim(),part_type:$.part_type.trim()};try{if(u){const re={...ce,part_number:ce.part_number};console.log(" Frontend: Sending PUT request"),console.log(" URL:",`/api/inventory/${encodeURIComponent(u.part_number)}`),console.log(" Request body:",re),console.log(" Original part number:",u.part_number),console.log(" New part number:",ce.part_number),await B.put(`/api/inventory/${encodeURIComponent(u.part_number)}`,re)}else await B.post("/api/inventory",ce);Q()}catch(re){throw re}},V=()=>{c(!1),d(null)},q=$=>{d({part_id:$.row.part_id,part_number:$.row.part_number,part_description:$.row.part_description||"",unit:$.row.unit||"Each",last_unit_cost:$.row.last_unit_cost||"",quantity_on_hand:$.row.quantity_on_hand||"",reorder_point:$.row.reorder_point||"",part_type:$.row.part_type||"stock",category:$.row.category||"Uncategorized"}),c(!0)},ue=()=>{L.current?.click()},ye=async $=>{const ce=$.target.files?.[0];if(ce){if(!ce.name.endsWith(".csv")&&ce.type!=="text/csv"){alert("Please select a valid CSV file");return}if(ce.size>5*1024*1024){alert("File size must be less than 5MB");return}await ge(ce)}},ge=async $=>{f(!0),j(0),w(null);const ce=new FormData;ce.append("csvFile",$);try{const re=setInterval(()=>{j(Ce=>Ce>=90?(clearInterval(re),90):Ce+10)},200),Me=await B.post("/api/inventory/upload-csv",ce,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:Ce=>{if(Ce.total){const Ye=Math.round(Ce.loaded*90/Ce.total);j(Ye)}}});clearInterval(re),j(100),w(Me.data),P(!0),setTimeout(()=>{Q()},1e3)}catch(re){console.error("Error uploading CSV:",re),re instanceof kr&&re.response?.data?w({error:"Upload failed",errors:re.response.data.errors||[re.response.data.error||"Unknown error"],warnings:re.response.data.warnings||[]}):w({error:"Upload failed",errors:["An unexpected error occurred during upload"]}),P(!0)}finally{f(!1),j(0),L.current&&(L.current.value="")}},xe=async()=>{try{const $=await B.get("/api/inventory/csv-template",{responseType:"blob"}),ce=window.URL.createObjectURL(new Blob([$.data])),re=document.createElement("a");re.href=ce,re.setAttribute("download","inventory_template.csv"),document.body.appendChild(re),re.click(),re.remove(),window.URL.revokeObjectURL(ce)}catch($){console.error("Error downloading template:",$),alert("Error downloading template")}},me=()=>{P(!1),w(null)},he=async()=>{D(!0);try{const $=[],ce=[],re=Qe=>{const lt=[],ct=[];let ut=String(Qe||"");const Ne=ut,tt=ut.replace(/\s+/g,"");tt!==ut&&lt.push("Removed spaces"),ut=tt;const Be=ut.toUpperCase();Be!==ut&&lt.push("Converted to uppercase"),ut=Be;const Ct=ut.replace(/[^A-Z0-9\/()]/g,"");Ct!==ut&&lt.push("Removed punctuation excluding ( ) /"),ut=Ct;const qt=ut;return ut=ut.replace(/(\d)\/(1\d|\d)/g,(Bt,Ke,Yt,Et,zt)=>{const cr=zt[Et-1]||"",jr=zt[Et+Bt.length]||"";return cr==="("&&jr===")"?Bt:`(${Ke}/${Yt})`}),ut!==qt&&lt.push("Wrapped fractions with parentheses"),ut.includes("/")&&(/^[A-Z]{3,}/.test(ut)||/[A-Z]{3,}$/.test(ut))&&ct.push("Description text detected with fraction"),/\d\.|\.\d/.test(ut)&&ct.push("Decimal detected; consider fraction"),{cleaned:ut,actions:lt,warnings:ct,original:Ne}},Me=n.map(Qe=>{const lt=re(Qe.part_number);return(lt.cleaned!==Qe.part_number||lt.actions.length>0)&&$.push({part_number:Qe.part_number,cleaned_part_number:lt.cleaned,actions:lt.actions}),lt.warnings.length>0&&ce.push({part_number:Qe.part_number,warnings:lt.warnings}),{...Qe,_clean:lt.cleaned}}),Ce={};Me.forEach(Qe=>{Ce[Qe._clean]||(Ce[Qe._clean]=[]),Ce[Qe._clean].push(Qe)});const Ye=Object.entries(Ce).filter(([,Qe])=>Qe.length>1).map(([,Qe])=>{const lt=Qe.map(Ne=>({part_number:Ne.part_number,unit:Ne.unit})),ct=Qe[0].part_number,ut=new Set(Qe.map(Ne=>Ne.unit)).size>1;return{proposedKeep:ct,candidates:lt,unitMismatch:ut}});R({fixes:$,flags:ce,duplicateGroups:Ye}),ee(!0)}catch($){console.error("Error during cleanup preview:",$),alert("Failed to analyze inventory for cleanup.")}finally{D(!1)}},ae=async()=>{if(!x)return;const $=(x.duplicateGroups||[]).map(ce=>({keepPartNumber:ce.proposedKeep,mergePartNumbers:ce.candidates.map(re=>re.part_number).filter(re=>re!==ce.proposedKeep)}));D(!0);try{const ce=await Kp("stock",$);ee(!1),b(ce),g(!0),await Q()}catch(ce){console.error("Error applying cleanup:",ce),alert("Failed to apply cleanup.")}finally{D(!1)}},T=()=>{g(!1),b(null)};return e.jsxs(at,{maxWidth:"xl",sx:{mt:4},children:[e.jsxs(k,{sx:{mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Stock"}),e.jsxs(ke,{direction:"row",spacing:2,children:[e.jsx(G,{variant:"contained",startIcon:e.jsx(Lr,{}),onClick:K,children:"New Part"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(Gp,{}),onClick:ue,children:"Upload CSV"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(yr,{}),onClick:xe,children:"Download Template"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(yr,{}),onClick:U,children:"Export CSV"}),e.jsx(G,{variant:"outlined",color:"warning",onClick:he,disabled:C,startIcon:C?e.jsx(it,{size:20}):e.jsx(gr,{}),children:C?"Cleaning...":"Clean"})]})]}),e.jsx("input",{type:"file",ref:L,onChange:ye,accept:".csv",style:{display:"none"}}),p&&e.jsxs(Ae,{sx:{p:2,mb:2},children:[e.jsx(h,{variant:"body2",gutterBottom:!0,children:"Uploading CSV file..."}),e.jsx(Uu,{variant:"determinate",value:m}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:[m,"% complete"]})]}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(le,{fullWidth:!0,variant:"outlined",placeholder:"Search stock...",value:t,onChange:$=>r($.target.value),InputProps:{startAdornment:e.jsx(pr,{position:"start",children:e.jsx(Br,{})})},sx:{mb:2}}),e.jsx(Jr,{rows:X,columns:I,loading:s,paginationModel:J,onPaginationModelChange:$=>z($),pageSizeOptions:[10,20,50],processRowUpdate:S,getRowId:$=>$.id,onRowClick:($,ce)=>{const re=ce.target;re.closest('.MuiDataGrid-cell[data-field="part_number"]')||re.closest('.MuiDataGrid-cell[data-field="quantity_on_hand"]')||re.closest('.MuiDataGrid-cell[data-field="last_unit_cost"]')||re.closest('.MuiDataGrid-cell[data-field="reorder_point"]')||q($)},sx:{cursor:"pointer","& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]}),e.jsxs(mt,{open:O,onClose:()=>ee(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:"Clean and Enforce Rules (Preview)"}),e.jsx(xt,{children:x?e.jsxs(k,{children:[e.jsx(h,{variant:"h6",children:"Fixes"}),e.jsx(Pr,{dense:!0,children:(x.fixes||[]).slice(0,200).map(($,ce)=>e.jsx(Mr,{button:!0,onClick:()=>{const re=n.find(Me=>Me.part_number===$.part_number);re&&(d({part_id:re.part_id,part_number:re.part_number,part_description:re.part_description||"",unit:re.unit||"Each",last_unit_cost:re.last_unit_cost||"",quantity_on_hand:re.quantity_on_hand||"",reorder_point:re.reorder_point||"",part_type:re.part_type||"stock",category:re.category||"Uncategorized"}),c(!0))},children:e.jsx(fr,{primary:`${$.part_number} -> ${$.cleaned_part_number}`,secondary:($.actions||[]).join(", ")})},ce))}),x.flags&&x.flags.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(h,{variant:"h6",sx:{mt:2},children:"Flags"}),e.jsx(Pr,{dense:!0,children:(x.flags||[]).map(($,ce)=>e.jsx(Mr,{button:!0,onClick:()=>{const re=n.find(Me=>Me.part_number===$.part_number);re&&(d({part_id:re.part_id,part_number:re.part_number,part_description:re.part_description||"",unit:re.unit||"Each",last_unit_cost:re.last_unit_cost||"",quantity_on_hand:re.quantity_on_hand||"",reorder_point:re.reorder_point||"",part_type:re.part_type||"stock",category:re.category||"Uncategorized"}),c(!0))},children:e.jsx(fr,{primary:`${$.part_number}`,secondary:($.warnings||[]).join(", ")})},ce))})]}),e.jsx(h,{variant:"h6",sx:{mt:2},children:"Potential Duplicates"}),e.jsx(Pr,{dense:!0,children:(x.duplicateGroups||[]).map(($,ce)=>e.jsx(Mr,{children:e.jsx(fr,{primary:`Keep ${$.proposedKeep}  merge ${$.candidates.map(re=>re.part_number).filter(re=>re!==$.proposedKeep).join(", ")||"none"}`,secondary:$.unitMismatch?"Unit mismatch detected - will not merge differing units":void 0})},ce))})]}):e.jsx(h,{children:"Loading preview..."})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>ee(!1),children:"Cancel"}),e.jsx(G,{onClick:ae,variant:"contained",disabled:C,children:"Apply"})]})]}),e.jsx(ts,{open:i,onClose:V,onSave:E,initialPart:u||void 0,isEditMode:!!u,title:u?"Edit Inventory Part":"Add New Inventory Part"}),e.jsxs(mt,{open:_,onClose:me,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:v?.error?"Upload Failed":"Upload Completed"}),e.jsx(xt,{children:v&&e.jsxs(k,{children:[v.error?e.jsx(We,{severity:"error",sx:{mb:2},children:v.error}):e.jsx(We,{severity:"success",sx:{mb:2},children:v.message}),v.summary&&e.jsxs(k,{sx:{mb:3},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Summary"}),e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Total: ${v.summary.totalProcessed}`,color:"primary"})}),e.jsx(M,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`New: ${v.summary.newItems}`,color:"success"})}),e.jsx(M,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Updated: ${v.summary.updatedItems}`,color:"info"})}),e.jsx(M,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Vendor Mappings: ${v.summary.vendorMappings||0}`,color:"secondary"})}),e.jsx(M,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Errors: ${v.summary.errors}`,color:"error"})}),e.jsx(M,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Warnings: ${v.summary.warnings}`,color:"warning"})})]})]}),v.errors&&v.errors.length>0&&e.jsxs(k,{sx:{mb:3},children:[e.jsxs(h,{variant:"h6",color:"error",gutterBottom:!0,children:["Errors (",v.errors.length,")"]}),e.jsx(Pr,{dense:!0,children:v.errors.map(($,ce)=>e.jsx(Mr,{children:e.jsx(fr,{primary:$})},ce))})]}),v.warnings&&v.warnings.length>0&&e.jsxs(k,{sx:{mb:3},children:[e.jsxs(h,{variant:"h6",color:"warning.main",gutterBottom:!0,children:["Warnings (",v.warnings.length,")"]}),e.jsx(Pr,{dense:!0,children:v.warnings.map(($,ce)=>e.jsx(Mr,{children:e.jsx(fr,{primary:$})},ce))})]})]})}),e.jsx(_t,{children:e.jsx(G,{onClick:me,variant:"contained",children:"Close"})})]}),e.jsxs(mt,{open:N,onClose:T,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:A?.error?"Cleanup Failed":"Cleanup Completed"}),e.jsx(xt,{children:A&&e.jsxs(k,{children:[A.error?e.jsxs(We,{severity:"error",sx:{mb:2},children:[A.message,A.details&&e.jsxs(h,{variant:"body2",sx:{mt:1},children:["Details: ",A.details]})]}):e.jsx(We,{severity:"success",sx:{mb:2},children:A.message}),A.summary&&e.jsxs(k,{sx:{mb:3},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Summary"}),e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:6,sm:4,children:e.jsx(De,{label:`Total: ${A.summary.totalProcessed}`,color:"primary"})}),e.jsx(M,{item:!0,xs:6,sm:4,children:e.jsx(De,{label:`Updated: ${A.summary.itemsUpdated}`,color:"success"})}),e.jsx(M,{item:!0,xs:6,sm:4,children:e.jsx(De,{label:`Errors: ${A.summary.errors}`,color:"error"})})]})]})]})}),e.jsx(_t,{children:e.jsx(G,{onClick:T,variant:"contained",children:"Close"})})]})]})},Tb=()=>{const[t,r]=l.useState(""),[n,a]=l.useState([]),[s,o]=l.useState(!1),[i,c]=l.useState(!1),[u,d]=l.useState(null),[p,f]=l.useState(!1),[m,j]=l.useState(0),[v,w]=l.useState(null),[_,P]=l.useState(!1),L=l.useRef(null),[C,D]=l.useState({page:0,pageSize:10}),[A,b]=l.useState(!1),[N,g]=l.useState(null),[x,R]=l.useState(!1),[O,ee]=l.useState(null),[J,z]=l.useState(!1),Z=async()=>{o(!0);try{const T=(await gb()).map(($,ce)=>({...$,id:$.part_number||ce}));a(T)}catch(ae){console.error("Error fetching supply inventory:",ae)}finally{o(!1)}};l.useEffect(()=>{Z();const ae=()=>Z();return window.addEventListener("supply-updated",ae),()=>window.removeEventListener("supply-updated",ae)},[]);const Q=n.filter(ae=>ae.part_number?.toUpperCase().includes(t.toUpperCase())||ae.part_description?.toLowerCase().includes(t.toLowerCase())),X=[{field:"part_number",headerName:"Part #",flex:1,headerAlign:"left",editable:!0},{field:"part_description",headerName:"Part Description",flex:2,headerAlign:"left"},{field:"category",headerName:"Category",flex:1,headerAlign:"left"},{field:"unit",headerName:"UOM",flex:.5,headerAlign:"left"},{field:"last_unit_cost",headerName:"Last Unit Cost",flex:1,type:"number",editable:!0,align:"center",headerAlign:"left"},{field:"reorder_point",headerName:"Reorder Point",flex:.75,type:"number",editable:!0,align:"center",headerAlign:"left"},{field:"part_type",headerName:"Type",flex:.5,headerAlign:"left"},{field:"value",headerName:"Value",flex:1,type:"number",valueGetter:ae=>{const T=ae.row.quantity_on_hand==="NA"?0:Number(ae.row.quantity_on_hand)||0,$=Number(ae.row.last_unit_cost)||0;return T*$},valueFormatter:ae=>`$${(Number(ae.value)||0).toFixed(2)}`,headerAlign:"center",align:"center"},{field:"actions",headerName:"Actions",width:100,headerAlign:"left",sortable:!1,renderCell:ae=>e.jsx(gt,{size:"small",color:"error",onClick:T=>{T.stopPropagation(),I(ae.row.part_number)},children:e.jsx(gr,{fontSize:"medium",sx:{fontSize:28}})})}],I=async ae=>{if(window.confirm(`Are you sure you want to delete part ${ae}?`))try{console.log(`Deleting part: ${ae}`);const T=await B.delete(`/api/inventory/${encodeURIComponent(ae)}`);console.log(`Part ${ae} deleted successfully:`,T.data),alert(`Part ${ae} deleted successfully!`),Z()}catch(T){console.error(`Error deleting part ${ae}:`,T),alert(`Error deleting part ${ae}. Please check the console.`)}},y=async(ae,T)=>{console.log("Attempting to update row:",ae);const $={};if(ae.part_number!==T.part_number){const re=String(ae.part_number).trim().toUpperCase();if(!re)return alert("Part number cannot be empty."),Promise.reject("Invalid part number");$.part_number=re}if(ae.reorder_point!==T.reorder_point){const re=parseFloat(String(ae.reorder_point));if(isNaN(re))return alert("Invalid reorder point value. Please enter a valid number."),Promise.reject("Invalid reorder point");$.reorder_point=re}if(ae.last_unit_cost!==T.last_unit_cost){const re=parseFloat(String(ae.last_unit_cost));if(isNaN(re))return alert("Invalid last unit cost value. Please enter a valid number."),Promise.reject("Invalid last unit cost");$.last_unit_cost=re}if(ae.category!==T.category&&($.category=ae.category),Object.keys($).length===0)return console.log("No fields changed."),ae;const ce=$.part_number?T.part_number:ae.part_number;try{const re=await B.put(`/api/inventory/${encodeURIComponent(ce)}`,$);return console.log(`Supply inventory updated for part ${ce}:`,re.data),alert(`Part ${ce} updated successfully!`),await Z(),re.data.updatedItem||ae}catch(re){return console.error(`Error updating supply inventory for part ${ce}:`,re),re instanceof kr&&re.response&&re.response.data&&re.response.data.error?alert(`Error updating inventory: ${re.response.data.error}`):alert(`Error updating inventory for part ${ce}. Please check the console.`),Promise.reject(re)}},S=()=>{const ae=Q.map(re=>({...re,value:(re.quantity_on_hand==="NA"?0:Number(re.quantity_on_hand)||0)*(Number(re.last_unit_cost)||0)})),T=Wn.unparse(ae),$=new Blob([T],{type:"text/csv;charset=utf-8;"}),ce=document.createElement("a");if(ce.download!==void 0){const re=URL.createObjectURL($);ce.setAttribute("href",re),ce.setAttribute("download","supply_list.csv"),ce.style.visibility="hidden",document.body.appendChild(ce),ce.click()}},U=()=>{d({part_number:"",part_description:"",unit:"",last_unit_cost:"",quantity_on_hand:"NA",reorder_point:"",part_type:"supply",category:"Uncategorized"}),c(!0)},K=async()=>{b(!0);try{const ae=await vb("supply");g(ae?.preview||ae),R(!0)}catch(ae){console.error("Error during cleanup preview:",ae),alert("Failed to analyze supply for cleanup.")}finally{b(!1)}},E=async()=>{if(!N)return;const ae=(N.duplicateGroups||[]).map(T=>({keepPartNumber:T.proposedKeep,mergePartNumbers:T.candidates.map($=>$.part_number).filter($=>$!==T.proposedKeep)}));b(!0);try{const T=await Kp("supply",ae);R(!1),ee(T),z(!0),await Z()}catch(T){console.error("Error applying cleanup:",T),alert("Failed to apply cleanup.")}finally{b(!1)}},V=async ae=>{const T={...ae,part_number:ae.part_number.trim().toUpperCase(),part_description:ae.part_description.trim(),unit:ae.unit.trim(),part_type:ae.part_type.trim()};try{if(u){const{part_number:$,...ce}=T;await B.put(`/api/inventory/${encodeURIComponent($)}`,ce)}else await B.post("/api/inventory",T);Z()}catch($){throw $}},q=()=>{c(!1),d(null)},ue=ae=>{d({part_id:ae.row.part_id,part_number:ae.row.part_number,part_description:ae.row.part_description||"",unit:ae.row.unit||"Each",last_unit_cost:ae.row.last_unit_cost||"",quantity_on_hand:ae.row.quantity_on_hand||"",reorder_point:ae.row.reorder_point||"",part_type:ae.row.part_type||"supply",category:ae.row.category||"Uncategorized"}),c(!0)},ye=()=>{L.current?.click()},ge=async ae=>{const T=ae.target.files?.[0];if(T){if(!T.name.endsWith(".csv")&&T.type!=="text/csv"){alert("Please select a valid CSV file");return}if(T.size>5*1024*1024){alert("File size must be less than 5MB");return}await xe(T)}},xe=async ae=>{f(!0),j(0),w(null);const T=new FormData;T.append("csvFile",ae);try{const $=setInterval(()=>{j(re=>re>=90?(clearInterval($),90):re+10)},200),ce=await B.post("/api/inventory/upload-csv",T,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:re=>{if(re.total){const Me=Math.round(re.loaded*90/re.total);j(Me)}}});clearInterval($),j(100),w(ce.data),P(!0),setTimeout(()=>{Z()},1e3)}catch($){console.error("Error uploading CSV:",$),$ instanceof kr&&$.response?.data?w({error:"Upload failed",errors:$.response.data.errors||[$.response.data.error||"Unknown error"],warnings:$.response.data.warnings||[]}):w({error:"Upload failed",errors:["An unexpected error occurred during upload"]}),P(!0)}finally{f(!1),j(0),L.current&&(L.current.value="")}},me=async()=>{try{const ae=await B.get("/api/inventory/csv-template",{responseType:"blob"}),T=window.URL.createObjectURL(new Blob([ae.data])),$=document.createElement("a");$.href=T,$.setAttribute("download","supply_template.csv"),document.body.appendChild($),$.click(),$.remove(),window.URL.revokeObjectURL(T)}catch(ae){console.error("Error downloading template:",ae),alert("Error downloading template")}},he=()=>{P(!1),w(null)};return e.jsxs(at,{maxWidth:"xl",sx:{mt:4},children:[e.jsxs(k,{sx:{mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Supply List"}),e.jsxs(ke,{direction:"row",spacing:2,children:[e.jsx(G,{variant:"contained",startIcon:e.jsx(Lr,{}),onClick:U,children:"New Part"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(Gp,{}),onClick:ye,children:"Upload CSV"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(yr,{}),onClick:me,children:"Download Template"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(yr,{}),onClick:S,children:"Export CSV"}),e.jsx(G,{variant:"outlined",color:"warning",onClick:K,disabled:A,startIcon:e.jsx(gr,{}),children:A?"Cleaning...":"Clean"})]})]}),e.jsx("input",{type:"file",ref:L,onChange:ge,accept:".csv",style:{display:"none"}}),p&&e.jsxs(Ae,{sx:{p:2,mb:2},children:[e.jsx(h,{variant:"body2",gutterBottom:!0,children:"Uploading CSV file..."}),e.jsx(Uu,{variant:"determinate",value:m}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:[m,"% complete"]})]}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(le,{fullWidth:!0,variant:"outlined",placeholder:"Search supply...",value:t,onChange:ae=>r(ae.target.value),InputProps:{startAdornment:e.jsx(pr,{position:"start",children:e.jsx(Br,{})})},sx:{mb:2}}),e.jsx(Jr,{rows:Q,columns:X,loading:s,paginationModel:C,onPaginationModelChange:ae=>D(ae),pageSizeOptions:[10,20,50],processRowUpdate:y,getRowId:ae=>ae.id,onRowClick:(ae,T)=>{const $=T.target;$.closest('.MuiDataGrid-cell[data-field="part_number"]')||$.closest('.MuiDataGrid-cell[data-field="last_unit_cost"]')||$.closest('.MuiDataGrid-cell[data-field="reorder_point"]')||ue(ae)},sx:{cursor:"pointer","& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]}),e.jsx(ts,{open:i,onClose:q,onSave:V,initialPart:u||void 0,isEditMode:!!u,title:u?"Edit Supply Part":"Add New Supply Part"}),e.jsxs(mt,{open:_,onClose:he,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:v?.error?"Upload Failed":"Upload Completed"}),e.jsx(xt,{children:v&&e.jsxs(k,{children:[v.error?e.jsx(We,{severity:"error",sx:{mb:2},children:v.error}):e.jsx(We,{severity:"success",sx:{mb:2},children:v.message}),v.summary&&e.jsxs(k,{sx:{mb:3},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Summary"}),e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Total: ${v.summary.totalProcessed}`,color:"primary"})}),e.jsx(M,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`New: ${v.summary.newItems}`,color:"success"})}),e.jsx(M,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Updated: ${v.summary.updatedItems}`,color:"info"})}),e.jsx(M,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Vendor Mappings: ${v.summary.vendorMappings||0}`,color:"secondary"})}),e.jsx(M,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Errors: ${v.summary.errors}`,color:"error"})}),e.jsx(M,{item:!0,xs:6,sm:2,children:e.jsx(De,{label:`Warnings: ${v.summary.warnings}`,color:"warning"})})]})]}),v.errors&&v.errors.length>0&&e.jsxs(k,{sx:{mb:3},children:[e.jsxs(h,{variant:"h6",color:"error",gutterBottom:!0,children:["Errors (",v.errors.length,")"]}),e.jsx(Pr,{dense:!0,children:v.errors.map((ae,T)=>e.jsx(Mr,{children:e.jsx(fr,{primary:ae})},T))})]}),v.warnings&&v.warnings.length>0&&e.jsxs(k,{sx:{mb:3},children:[e.jsxs(h,{variant:"h6",color:"warning.main",gutterBottom:!0,children:["Warnings (",v.warnings.length,")"]}),e.jsx(Pr,{dense:!0,children:v.warnings.map((ae,T)=>e.jsx(Mr,{children:e.jsx(fr,{primary:ae})},T))})]})]})}),e.jsx(_t,{children:e.jsx(G,{onClick:he,variant:"contained",children:"Close"})})]}),e.jsxs(mt,{open:x,onClose:()=>R(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:"Clean and Enforce Rules (Preview)"}),e.jsx(xt,{children:N?e.jsxs(k,{children:[e.jsx(h,{variant:"h6",children:"Fixes"}),e.jsx(Pr,{dense:!0,children:(N.fixes||[]).slice(0,200).map((ae,T)=>e.jsx(Mr,{children:e.jsx(fr,{primary:`${ae.part_number} -> ${ae.cleaned_part_number}`,secondary:(ae.actions||[]).join(", ")})},T))}),e.jsx(h,{variant:"h6",sx:{mt:2},children:"Potential Duplicates"}),e.jsx(Pr,{dense:!0,children:(N.duplicateGroups||[]).map((ae,T)=>e.jsx(Mr,{children:e.jsx(fr,{primary:`Keep ${ae.proposedKeep}  merge ${ae.candidates.map($=>$.part_number).filter($=>$!==ae.proposedKeep).join(", ")||"none"}`,secondary:ae.unitMismatch?"Unit mismatch detected - will not merge differing units":void 0})},T))})]}):e.jsx(h,{children:"Loading preview..."})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>R(!1),children:"Cancel"}),e.jsx(G,{onClick:E,variant:"contained",disabled:A,children:"Apply"})]})]}),e.jsxs(mt,{open:J,onClose:()=>z(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:"Cleanup Completed"}),e.jsx(xt,{children:O?e.jsxs(k,{children:[e.jsx(We,{severity:"success",sx:{mb:2},children:"Cleanup applied successfully."}),e.jsxs(h,{variant:"body2",children:["Fixes applied: ",O?.applied?.fixesApplied||0]}),e.jsxs(h,{variant:"body2",children:["Fixes skipped: ",O?.applied?.fixesSkipped||0]}),e.jsxs(h,{variant:"body2",children:["Merged groups: ",O?.applied?.mergedGroups||0]}),e.jsxs(h,{variant:"body2",children:["Merged items: ",O?.applied?.mergedItems||0]})]}):e.jsx(h,{children:"Loading..."})}),e.jsx(_t,{children:e.jsx(G,{onClick:()=>z(!1),variant:"contained",children:"Close"})})]})]})};function Rt(t){if(t===null||t===!0||t===!1)return NaN;var r=Number(t);return isNaN(r)?r:r<0?Math.ceil(r):Math.floor(r)}function Ue(t,r){if(r.length<t)throw new TypeError(t+" argument"+(t>1?"s":"")+" required, but only "+r.length+" present")}function qe(t){Ue(1,arguments);var r=Object.prototype.toString.call(t);return t instanceof Date||li(t)==="object"&&r==="[object Date]"?new Date(t.getTime()):typeof t=="number"||r==="[object Number]"?new Date(t):((typeof t=="string"||r==="[object String]")&&typeof console<"u"&&(console.warn("Starting with v2.0.0-beta.1 date-fns doesn't accept strings as date arguments. Please use `parseISO` to parse strings. See: https://github.com/date-fns/date-fns/blob/master/docs/upgradeGuide.md#string-arguments"),console.warn(new Error().stack)),new Date(NaN))}function $o(t,r){Ue(2,arguments);var n=qe(t),a=Rt(r);return isNaN(a)?new Date(NaN):(a&&n.setDate(n.getDate()+a),n)}function zo(t,r){Ue(2,arguments);var n=qe(t),a=Rt(r);if(isNaN(a))return new Date(NaN);if(!a)return n;var s=n.getDate(),o=new Date(n.getTime());o.setMonth(n.getMonth()+a+1,0);var i=o.getDate();return s>=i?o:(n.setFullYear(o.getFullYear(),o.getMonth(),s),n)}function Ci(t,r){Ue(2,arguments);var n=qe(t).getTime(),a=Rt(r);return new Date(n+a)}var Ob=36e5;function Ab(t,r){Ue(2,arguments);var n=Rt(r);return Ci(t,n*Ob)}var Mb={};function Zr(){return Mb}function Zn(t,r){var n,a,s,o,i,c,u,d;Ue(1,arguments);var p=Zr(),f=Rt((n=(a=(s=(o=r?.weekStartsOn)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.weekStartsOn)!==null&&s!==void 0?s:p.weekStartsOn)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.weekStartsOn)!==null&&n!==void 0?n:0);if(!(f>=0&&f<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var m=qe(t),j=m.getDay(),v=(j<f?7:0)+j-f;return m.setDate(m.getDate()-v),m.setHours(0,0,0,0),m}function Ms(t){var r=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()));return r.setUTCFullYear(t.getFullYear()),t.getTime()-r.getTime()}function Rs(t){Ue(1,arguments);var r=qe(t);return r.setHours(0,0,0,0),r}var Rb=864e5;function Nb(t,r){Ue(2,arguments);var n=Rs(t),a=Rs(r),s=n.getTime()-Ms(n),o=a.getTime()-Ms(a);return Math.round((s-o)/Rb)}var Lb=6e4;function qb(t,r){Ue(2,arguments);var n=Rt(r);return Ci(t,n*Lb)}function Ub(t,r){Ue(2,arguments);var n=Rt(r);return Ci(t,n*1e3)}function Wb(t,r){Ue(2,arguments);var n=Rt(r),a=n*7;return $o(t,a)}function Pd(t,r){Ue(2,arguments);var n=Rt(r);return zo(t,n*12)}function Ts(t,r){Ue(2,arguments);var n=qe(t),a=qe(r),s=n.getTime()-a.getTime();return s<0?-1:s>0?1:s}var ki=6e4,Pi=36e5,Fb=1e3;function $b(t,r){Ue(2,arguments);var n=Rs(t),a=Rs(r);return n.getTime()===a.getTime()}function zb(t){return Ue(1,arguments),t instanceof Date||li(t)==="object"&&Object.prototype.toString.call(t)==="[object Date]"}function Jp(t){if(Ue(1,arguments),!zb(t)&&typeof t!="number")return!1;var r=qe(t);return!isNaN(Number(r))}function Bb(t,r){Ue(2,arguments);var n=qe(t),a=qe(r),s=n.getFullYear()-a.getFullYear(),o=n.getMonth()-a.getMonth();return s*12+o}function Hb(t,r){Ue(2,arguments);var n=qe(t),a=qe(r);return n.getFullYear()-a.getFullYear()}function Dd(t,r){var n=t.getFullYear()-r.getFullYear()||t.getMonth()-r.getMonth()||t.getDate()-r.getDate()||t.getHours()-r.getHours()||t.getMinutes()-r.getMinutes()||t.getSeconds()-r.getSeconds()||t.getMilliseconds()-r.getMilliseconds();return n<0?-1:n>0?1:n}function Xp(t,r){Ue(2,arguments);var n=qe(t),a=qe(r),s=Dd(n,a),o=Math.abs(Nb(n,a));n.setDate(n.getDate()-s*o);var i=+(Dd(n,a)===-s),c=s*(o-i);return c===0?0:c}function Di(t,r){return Ue(2,arguments),qe(t).getTime()-qe(r).getTime()}var Ed={ceil:Math.ceil,round:Math.round,floor:Math.floor,trunc:function(r){return r<0?Math.ceil(r):Math.floor(r)}},Yb="trunc";function uo(t){return t?Ed[t]:Ed[Yb]}function Vb(t,r,n){Ue(2,arguments);var a=Di(t,r)/Pi;return uo(void 0)(a)}function Gb(t,r,n){Ue(2,arguments);var a=Di(t,r)/ki;return uo(void 0)(a)}function kl(t){Ue(1,arguments);var r=qe(t);return r.setHours(23,59,59,999),r}function Pl(t){Ue(1,arguments);var r=qe(t),n=r.getMonth();return r.setFullYear(r.getFullYear(),n+1,0),r.setHours(23,59,59,999),r}function Qb(t){Ue(1,arguments);var r=qe(t);return kl(r).getTime()===Pl(r).getTime()}function Zp(t,r){Ue(2,arguments);var n=qe(t),a=qe(r),s=Ts(n,a),o=Math.abs(Bb(n,a)),i;if(o<1)i=0;else{n.getMonth()===1&&n.getDate()>27&&n.setDate(30),n.setMonth(n.getMonth()-s*o);var c=Ts(n,a)===-s;Qb(qe(t))&&o===1&&Ts(t,a)===1&&(c=!1),i=s*(o-Number(c))}return i===0?0:i}function Kb(t,r,n){Ue(2,arguments);var a=Zp(t,r)/3;return uo(void 0)(a)}function Jb(t,r,n){Ue(2,arguments);var a=Di(t,r)/1e3;return uo(void 0)(a)}function Xb(t,r,n){Ue(2,arguments);var a=Xp(t,r)/7;return uo(void 0)(a)}function Zb(t,r){Ue(2,arguments);var n=qe(t),a=qe(r),s=Ts(n,a),o=Math.abs(Hb(n,a));n.setFullYear(1584),a.setFullYear(1584);var i=Ts(n,a)===-s,c=s*(o-Number(i));return c===0?0:c}function e_(t,r){var n;Ue(1,arguments);var a=t||{},s=qe(a.start),o=qe(a.end),i=o.getTime();if(!(s.getTime()<=i))throw new RangeError("Invalid interval");var c=[],u=s;u.setHours(0,0,0,0);var d=Number((n=void 0)!==null&&n!==void 0?n:1);if(d<1||isNaN(d))throw new RangeError("`options.step` must be a number greater than 1");for(;u.getTime()<=i;)c.push(qe(u)),u.setDate(u.getDate()+d),u.setHours(0,0,0,0);return c}function Id(t){Ue(1,arguments);var r=qe(t);return r.setDate(1),r.setHours(0,0,0,0),r}function Ki(t){Ue(1,arguments);var r=qe(t),n=r.getFullYear();return r.setFullYear(n+1,0,0),r.setHours(23,59,59,999),r}function ko(t){Ue(1,arguments);var r=qe(t),n=new Date(0);return n.setFullYear(r.getFullYear(),0,1),n.setHours(0,0,0,0),n}function Ji(t,r){var n,a,s,o,i,c,u,d;Ue(1,arguments);var p=Zr(),f=Rt((n=(a=(s=(o=r?.weekStartsOn)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.weekStartsOn)!==null&&s!==void 0?s:p.weekStartsOn)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.weekStartsOn)!==null&&n!==void 0?n:0);if(!(f>=0&&f<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var m=qe(t),j=m.getDay(),v=(j<f?-7:0)+6-(j-f);return m.setDate(m.getDate()+v),m.setHours(23,59,59,999),m}function eh(t,r){Ue(2,arguments);var n=Rt(r);return Ci(t,-n)}var t_=864e5;function r_(t){Ue(1,arguments);var r=qe(t),n=r.getTime();r.setUTCMonth(0,1),r.setUTCHours(0,0,0,0);var a=r.getTime(),s=n-a;return Math.floor(s/t_)+1}function Ns(t){Ue(1,arguments);var r=1,n=qe(t),a=n.getUTCDay(),s=(a<r?7:0)+a-r;return n.setUTCDate(n.getUTCDate()-s),n.setUTCHours(0,0,0,0),n}function th(t){Ue(1,arguments);var r=qe(t),n=r.getUTCFullYear(),a=new Date(0);a.setUTCFullYear(n+1,0,4),a.setUTCHours(0,0,0,0);var s=Ns(a),o=new Date(0);o.setUTCFullYear(n,0,4),o.setUTCHours(0,0,0,0);var i=Ns(o);return r.getTime()>=s.getTime()?n+1:r.getTime()>=i.getTime()?n:n-1}function n_(t){Ue(1,arguments);var r=th(t),n=new Date(0);n.setUTCFullYear(r,0,4),n.setUTCHours(0,0,0,0);var a=Ns(n);return a}var s_=6048e5;function rh(t){Ue(1,arguments);var r=qe(t),n=Ns(r).getTime()-n_(r).getTime();return Math.round(n/s_)+1}function rs(t,r){var n,a,s,o,i,c,u,d;Ue(1,arguments);var p=Zr(),f=Rt((n=(a=(s=(o=r?.weekStartsOn)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.weekStartsOn)!==null&&s!==void 0?s:p.weekStartsOn)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.weekStartsOn)!==null&&n!==void 0?n:0);if(!(f>=0&&f<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var m=qe(t),j=m.getUTCDay(),v=(j<f?7:0)+j-f;return m.setUTCDate(m.getUTCDate()-v),m.setUTCHours(0,0,0,0),m}function Vl(t,r){var n,a,s,o,i,c,u,d;Ue(1,arguments);var p=qe(t),f=p.getUTCFullYear(),m=Zr(),j=Rt((n=(a=(s=(o=r?.firstWeekContainsDate)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.firstWeekContainsDate)!==null&&s!==void 0?s:m.firstWeekContainsDate)!==null&&a!==void 0?a:(u=m.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.firstWeekContainsDate)!==null&&n!==void 0?n:1);if(!(j>=1&&j<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var v=new Date(0);v.setUTCFullYear(f+1,0,j),v.setUTCHours(0,0,0,0);var w=rs(v,r),_=new Date(0);_.setUTCFullYear(f,0,j),_.setUTCHours(0,0,0,0);var P=rs(_,r);return p.getTime()>=w.getTime()?f+1:p.getTime()>=P.getTime()?f:f-1}function a_(t,r){var n,a,s,o,i,c,u,d;Ue(1,arguments);var p=Zr(),f=Rt((n=(a=(s=(o=r?.firstWeekContainsDate)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.firstWeekContainsDate)!==null&&s!==void 0?s:p.firstWeekContainsDate)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.firstWeekContainsDate)!==null&&n!==void 0?n:1),m=Vl(t,r),j=new Date(0);j.setUTCFullYear(m,0,f),j.setUTCHours(0,0,0,0);var v=rs(j,r);return v}var o_=6048e5;function nh(t,r){Ue(1,arguments);var n=qe(t),a=rs(n,r).getTime()-a_(n,r).getTime();return Math.round(a/o_)+1}function Dt(t,r){for(var n=t<0?"-":"",a=Math.abs(t).toString();a.length<r;)a="0"+a;return n+a}var Dn={y:function(r,n){var a=r.getUTCFullYear(),s=a>0?a:1-a;return Dt(n==="yy"?s%100:s,n.length)},M:function(r,n){var a=r.getUTCMonth();return n==="M"?String(a+1):Dt(a+1,2)},d:function(r,n){return Dt(r.getUTCDate(),n.length)},a:function(r,n){var a=r.getUTCHours()/12>=1?"pm":"am";switch(n){case"a":case"aa":return a.toUpperCase();case"aaa":return a;case"aaaaa":return a[0];case"aaaa":default:return a==="am"?"a.m.":"p.m."}},h:function(r,n){return Dt(r.getUTCHours()%12||12,n.length)},H:function(r,n){return Dt(r.getUTCHours(),n.length)},m:function(r,n){return Dt(r.getUTCMinutes(),n.length)},s:function(r,n){return Dt(r.getUTCSeconds(),n.length)},S:function(r,n){var a=n.length,s=r.getUTCMilliseconds(),o=Math.floor(s*Math.pow(10,a-3));return Dt(o,n.length)}},ys={midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},i_={G:function(r,n,a){var s=r.getUTCFullYear()>0?1:0;switch(n){case"G":case"GG":case"GGG":return a.era(s,{width:"abbreviated"});case"GGGGG":return a.era(s,{width:"narrow"});case"GGGG":default:return a.era(s,{width:"wide"})}},y:function(r,n,a){if(n==="yo"){var s=r.getUTCFullYear(),o=s>0?s:1-s;return a.ordinalNumber(o,{unit:"year"})}return Dn.y(r,n)},Y:function(r,n,a,s){var o=Vl(r,s),i=o>0?o:1-o;if(n==="YY"){var c=i%100;return Dt(c,2)}return n==="Yo"?a.ordinalNumber(i,{unit:"year"}):Dt(i,n.length)},R:function(r,n){var a=th(r);return Dt(a,n.length)},u:function(r,n){var a=r.getUTCFullYear();return Dt(a,n.length)},Q:function(r,n,a){var s=Math.ceil((r.getUTCMonth()+1)/3);switch(n){case"Q":return String(s);case"QQ":return Dt(s,2);case"Qo":return a.ordinalNumber(s,{unit:"quarter"});case"QQQ":return a.quarter(s,{width:"abbreviated",context:"formatting"});case"QQQQQ":return a.quarter(s,{width:"narrow",context:"formatting"});case"QQQQ":default:return a.quarter(s,{width:"wide",context:"formatting"})}},q:function(r,n,a){var s=Math.ceil((r.getUTCMonth()+1)/3);switch(n){case"q":return String(s);case"qq":return Dt(s,2);case"qo":return a.ordinalNumber(s,{unit:"quarter"});case"qqq":return a.quarter(s,{width:"abbreviated",context:"standalone"});case"qqqqq":return a.quarter(s,{width:"narrow",context:"standalone"});case"qqqq":default:return a.quarter(s,{width:"wide",context:"standalone"})}},M:function(r,n,a){var s=r.getUTCMonth();switch(n){case"M":case"MM":return Dn.M(r,n);case"Mo":return a.ordinalNumber(s+1,{unit:"month"});case"MMM":return a.month(s,{width:"abbreviated",context:"formatting"});case"MMMMM":return a.month(s,{width:"narrow",context:"formatting"});case"MMMM":default:return a.month(s,{width:"wide",context:"formatting"})}},L:function(r,n,a){var s=r.getUTCMonth();switch(n){case"L":return String(s+1);case"LL":return Dt(s+1,2);case"Lo":return a.ordinalNumber(s+1,{unit:"month"});case"LLL":return a.month(s,{width:"abbreviated",context:"standalone"});case"LLLLL":return a.month(s,{width:"narrow",context:"standalone"});case"LLLL":default:return a.month(s,{width:"wide",context:"standalone"})}},w:function(r,n,a,s){var o=nh(r,s);return n==="wo"?a.ordinalNumber(o,{unit:"week"}):Dt(o,n.length)},I:function(r,n,a){var s=rh(r);return n==="Io"?a.ordinalNumber(s,{unit:"week"}):Dt(s,n.length)},d:function(r,n,a){return n==="do"?a.ordinalNumber(r.getUTCDate(),{unit:"date"}):Dn.d(r,n)},D:function(r,n,a){var s=r_(r);return n==="Do"?a.ordinalNumber(s,{unit:"dayOfYear"}):Dt(s,n.length)},E:function(r,n,a){var s=r.getUTCDay();switch(n){case"E":case"EE":case"EEE":return a.day(s,{width:"abbreviated",context:"formatting"});case"EEEEE":return a.day(s,{width:"narrow",context:"formatting"});case"EEEEEE":return a.day(s,{width:"short",context:"formatting"});case"EEEE":default:return a.day(s,{width:"wide",context:"formatting"})}},e:function(r,n,a,s){var o=r.getUTCDay(),i=(o-s.weekStartsOn+8)%7||7;switch(n){case"e":return String(i);case"ee":return Dt(i,2);case"eo":return a.ordinalNumber(i,{unit:"day"});case"eee":return a.day(o,{width:"abbreviated",context:"formatting"});case"eeeee":return a.day(o,{width:"narrow",context:"formatting"});case"eeeeee":return a.day(o,{width:"short",context:"formatting"});case"eeee":default:return a.day(o,{width:"wide",context:"formatting"})}},c:function(r,n,a,s){var o=r.getUTCDay(),i=(o-s.weekStartsOn+8)%7||7;switch(n){case"c":return String(i);case"cc":return Dt(i,n.length);case"co":return a.ordinalNumber(i,{unit:"day"});case"ccc":return a.day(o,{width:"abbreviated",context:"standalone"});case"ccccc":return a.day(o,{width:"narrow",context:"standalone"});case"cccccc":return a.day(o,{width:"short",context:"standalone"});case"cccc":default:return a.day(o,{width:"wide",context:"standalone"})}},i:function(r,n,a){var s=r.getUTCDay(),o=s===0?7:s;switch(n){case"i":return String(o);case"ii":return Dt(o,n.length);case"io":return a.ordinalNumber(o,{unit:"day"});case"iii":return a.day(s,{width:"abbreviated",context:"formatting"});case"iiiii":return a.day(s,{width:"narrow",context:"formatting"});case"iiiiii":return a.day(s,{width:"short",context:"formatting"});case"iiii":default:return a.day(s,{width:"wide",context:"formatting"})}},a:function(r,n,a){var s=r.getUTCHours(),o=s/12>=1?"pm":"am";switch(n){case"a":case"aa":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"});case"aaa":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return a.dayPeriod(o,{width:"narrow",context:"formatting"});case"aaaa":default:return a.dayPeriod(o,{width:"wide",context:"formatting"})}},b:function(r,n,a){var s=r.getUTCHours(),o;switch(s===12?o=ys.noon:s===0?o=ys.midnight:o=s/12>=1?"pm":"am",n){case"b":case"bb":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"});case"bbb":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return a.dayPeriod(o,{width:"narrow",context:"formatting"});case"bbbb":default:return a.dayPeriod(o,{width:"wide",context:"formatting"})}},B:function(r,n,a){var s=r.getUTCHours(),o;switch(s>=17?o=ys.evening:s>=12?o=ys.afternoon:s>=4?o=ys.morning:o=ys.night,n){case"B":case"BB":case"BBB":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"});case"BBBBB":return a.dayPeriod(o,{width:"narrow",context:"formatting"});case"BBBB":default:return a.dayPeriod(o,{width:"wide",context:"formatting"})}},h:function(r,n,a){if(n==="ho"){var s=r.getUTCHours()%12;return s===0&&(s=12),a.ordinalNumber(s,{unit:"hour"})}return Dn.h(r,n)},H:function(r,n,a){return n==="Ho"?a.ordinalNumber(r.getUTCHours(),{unit:"hour"}):Dn.H(r,n)},K:function(r,n,a){var s=r.getUTCHours()%12;return n==="Ko"?a.ordinalNumber(s,{unit:"hour"}):Dt(s,n.length)},k:function(r,n,a){var s=r.getUTCHours();return s===0&&(s=24),n==="ko"?a.ordinalNumber(s,{unit:"hour"}):Dt(s,n.length)},m:function(r,n,a){return n==="mo"?a.ordinalNumber(r.getUTCMinutes(),{unit:"minute"}):Dn.m(r,n)},s:function(r,n,a){return n==="so"?a.ordinalNumber(r.getUTCSeconds(),{unit:"second"}):Dn.s(r,n)},S:function(r,n){return Dn.S(r,n)},X:function(r,n,a,s){var o=s._originalDate||r,i=o.getTimezoneOffset();if(i===0)return"Z";switch(n){case"X":return Od(i);case"XXXX":case"XX":return Gn(i);case"XXXXX":case"XXX":default:return Gn(i,":")}},x:function(r,n,a,s){var o=s._originalDate||r,i=o.getTimezoneOffset();switch(n){case"x":return Od(i);case"xxxx":case"xx":return Gn(i);case"xxxxx":case"xxx":default:return Gn(i,":")}},O:function(r,n,a,s){var o=s._originalDate||r,i=o.getTimezoneOffset();switch(n){case"O":case"OO":case"OOO":return"GMT"+Td(i,":");case"OOOO":default:return"GMT"+Gn(i,":")}},z:function(r,n,a,s){var o=s._originalDate||r,i=o.getTimezoneOffset();switch(n){case"z":case"zz":case"zzz":return"GMT"+Td(i,":");case"zzzz":default:return"GMT"+Gn(i,":")}},t:function(r,n,a,s){var o=s._originalDate||r,i=Math.floor(o.getTime()/1e3);return Dt(i,n.length)},T:function(r,n,a,s){var o=s._originalDate||r,i=o.getTime();return Dt(i,n.length)}};function Td(t,r){var n=t>0?"-":"+",a=Math.abs(t),s=Math.floor(a/60),o=a%60;if(o===0)return n+String(s);var i=r;return n+String(s)+i+Dt(o,2)}function Od(t,r){if(t%60===0){var n=t>0?"-":"+";return n+Dt(Math.abs(t)/60,2)}return Gn(t,r)}function Gn(t,r){var n=r||"",a=t>0?"-":"+",s=Math.abs(t),o=Dt(Math.floor(s/60),2),i=Dt(s%60,2);return a+o+n+i}var Ad=function(r,n){switch(r){case"P":return n.date({width:"short"});case"PP":return n.date({width:"medium"});case"PPP":return n.date({width:"long"});case"PPPP":default:return n.date({width:"full"})}},sh=function(r,n){switch(r){case"p":return n.time({width:"short"});case"pp":return n.time({width:"medium"});case"ppp":return n.time({width:"long"});case"pppp":default:return n.time({width:"full"})}},l_=function(r,n){var a=r.match(/(P+)(p+)?/)||[],s=a[1],o=a[2];if(!o)return Ad(r,n);var i;switch(s){case"P":i=n.dateTime({width:"short"});break;case"PP":i=n.dateTime({width:"medium"});break;case"PPP":i=n.dateTime({width:"long"});break;case"PPPP":default:i=n.dateTime({width:"full"});break}return i.replace("{{date}}",Ad(s,n)).replace("{{time}}",sh(o,n))},Dl={p:sh,P:l_},c_=["D","DD"],d_=["YY","YYYY"];function ah(t){return c_.indexOf(t)!==-1}function oh(t){return d_.indexOf(t)!==-1}function ei(t,r,n){if(t==="YYYY")throw new RangeError("Use `yyyy` instead of `YYYY` (in `".concat(r,"`) for formatting years to the input `").concat(n,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"));if(t==="YY")throw new RangeError("Use `yy` instead of `YY` (in `".concat(r,"`) for formatting years to the input `").concat(n,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"));if(t==="D")throw new RangeError("Use `d` instead of `D` (in `".concat(r,"`) for formatting days of the month to the input `").concat(n,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"));if(t==="DD")throw new RangeError("Use `dd` instead of `DD` (in `".concat(r,"`) for formatting days of the month to the input `").concat(n,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"))}var u_={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},p_=function(r,n,a){var s,o=u_[r];return typeof o=="string"?s=o:n===1?s=o.one:s=o.other.replace("{{count}}",n.toString()),a!=null&&a.addSuffix?a.comparison&&a.comparison>0?"in "+s:s+" ago":s};function Xi(t){return function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},n=r.width?String(r.width):t.defaultWidth,a=t.formats[n]||t.formats[t.defaultWidth];return a}}var h_={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},m_={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},f_={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},x_={date:Xi({formats:h_,defaultWidth:"full"}),time:Xi({formats:m_,defaultWidth:"full"}),dateTime:Xi({formats:f_,defaultWidth:"full"})},g_={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},y_=function(r,n,a,s){return g_[r]};function wa(t){return function(r,n){var a=n!=null&&n.context?String(n.context):"standalone",s;if(a==="formatting"&&t.formattingValues){var o=t.defaultFormattingWidth||t.defaultWidth,i=n!=null&&n.width?String(n.width):o;s=t.formattingValues[i]||t.formattingValues[o]}else{var c=t.defaultWidth,u=n!=null&&n.width?String(n.width):t.defaultWidth;s=t.values[u]||t.values[c]}var d=t.argumentCallback?t.argumentCallback(r):r;return s[d]}}var v_={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},b_={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},__={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},j_={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},w_={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},S_={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},C_=function(r,n){var a=Number(r),s=a%100;if(s>20||s<10)switch(s%10){case 1:return a+"st";case 2:return a+"nd";case 3:return a+"rd"}return a+"th"},k_={ordinalNumber:C_,era:wa({values:v_,defaultWidth:"wide"}),quarter:wa({values:b_,defaultWidth:"wide",argumentCallback:function(r){return r-1}}),month:wa({values:__,defaultWidth:"wide"}),day:wa({values:j_,defaultWidth:"wide"}),dayPeriod:wa({values:w_,defaultWidth:"wide",formattingValues:S_,defaultFormattingWidth:"wide"})};function Sa(t){return function(r){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},a=n.width,s=a&&t.matchPatterns[a]||t.matchPatterns[t.defaultMatchWidth],o=r.match(s);if(!o)return null;var i=o[0],c=a&&t.parsePatterns[a]||t.parsePatterns[t.defaultParseWidth],u=Array.isArray(c)?D_(c,function(f){return f.test(i)}):P_(c,function(f){return f.test(i)}),d;d=t.valueCallback?t.valueCallback(u):u,d=n.valueCallback?n.valueCallback(d):d;var p=r.slice(i.length);return{value:d,rest:p}}}function P_(t,r){for(var n in t)if(t.hasOwnProperty(n)&&r(t[n]))return n}function D_(t,r){for(var n=0;n<t.length;n++)if(r(t[n]))return n}function E_(t){return function(r){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},a=r.match(t.matchPattern);if(!a)return null;var s=a[0],o=r.match(t.parsePattern);if(!o)return null;var i=t.valueCallback?t.valueCallback(o[0]):o[0];i=n.valueCallback?n.valueCallback(i):i;var c=r.slice(s.length);return{value:i,rest:c}}}var I_=/^(\d+)(th|st|nd|rd)?/i,T_=/\d+/i,O_={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},A_={any:[/^b/i,/^(a|c)/i]},M_={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},R_={any:[/1/i,/2/i,/3/i,/4/i]},N_={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},L_={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},q_={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},U_={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},W_={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},F_={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},$_={ordinalNumber:E_({matchPattern:I_,parsePattern:T_,valueCallback:function(r){return parseInt(r,10)}}),era:Sa({matchPatterns:O_,defaultMatchWidth:"wide",parsePatterns:A_,defaultParseWidth:"any"}),quarter:Sa({matchPatterns:M_,defaultMatchWidth:"wide",parsePatterns:R_,defaultParseWidth:"any",valueCallback:function(r){return r+1}}),month:Sa({matchPatterns:N_,defaultMatchWidth:"wide",parsePatterns:L_,defaultParseWidth:"any"}),day:Sa({matchPatterns:q_,defaultMatchWidth:"wide",parsePatterns:U_,defaultParseWidth:"any"}),dayPeriod:Sa({matchPatterns:W_,defaultMatchWidth:"any",parsePatterns:F_,defaultParseWidth:"any"})},Ei={code:"en-US",formatDistance:p_,formatLong:x_,formatRelative:y_,localize:k_,match:$_,options:{weekStartsOn:0,firstWeekContainsDate:1}},z_=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,B_=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,H_=/^'([^]*?)'?$/,Y_=/''/g,V_=/[a-zA-Z]/;function Ss(t,r,n){var a,s,o,i,c,u,d,p,f,m,j,v,w,_,P,L,C,D;Ue(2,arguments);var A=String(r),b=Zr(),N=(a=(s=n?.locale)!==null&&s!==void 0?s:b.locale)!==null&&a!==void 0?a:Ei,g=Rt((o=(i=(c=(u=n?.firstWeekContainsDate)!==null&&u!==void 0?u:n==null||(d=n.locale)===null||d===void 0||(p=d.options)===null||p===void 0?void 0:p.firstWeekContainsDate)!==null&&c!==void 0?c:b.firstWeekContainsDate)!==null&&i!==void 0?i:(f=b.locale)===null||f===void 0||(m=f.options)===null||m===void 0?void 0:m.firstWeekContainsDate)!==null&&o!==void 0?o:1);if(!(g>=1&&g<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var x=Rt((j=(v=(w=(_=n?.weekStartsOn)!==null&&_!==void 0?_:n==null||(P=n.locale)===null||P===void 0||(L=P.options)===null||L===void 0?void 0:L.weekStartsOn)!==null&&w!==void 0?w:b.weekStartsOn)!==null&&v!==void 0?v:(C=b.locale)===null||C===void 0||(D=C.options)===null||D===void 0?void 0:D.weekStartsOn)!==null&&j!==void 0?j:0);if(!(x>=0&&x<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");if(!N.localize)throw new RangeError("locale must contain localize property");if(!N.formatLong)throw new RangeError("locale must contain formatLong property");var R=qe(t);if(!Jp(R))throw new RangeError("Invalid time value");var O=Ms(R),ee=eh(R,O),J={firstWeekContainsDate:g,weekStartsOn:x,locale:N,_originalDate:R},z=A.match(B_).map(function(Z){var Q=Z[0];if(Q==="p"||Q==="P"){var X=Dl[Q];return X(Z,N.formatLong)}return Z}).join("").match(z_).map(function(Z){if(Z==="''")return"'";var Q=Z[0];if(Q==="'")return G_(Z);var X=i_[Q];if(X)return!(n!=null&&n.useAdditionalWeekYearTokens)&&oh(Z)&&ei(Z,r,String(t)),!(n!=null&&n.useAdditionalDayOfYearTokens)&&ah(Z)&&ei(Z,r,String(t)),X(ee,Z,N.localize,J);if(Q.match(V_))throw new RangeError("Format string contains an unescaped latin alphabet character `"+Q+"`");return Z}).join("");return z}function G_(t){var r=t.match(H_);return r?r[1].replace(Y_,"'"):t}function Gl(t,r){if(t==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n]);return t}function Q_(t){return Gl({},t)}var Md=1e3*60,ti=60*24,Rd=ti*30,Nd=ti*365;function K_(t,r,n){var a,s,o;Ue(2,arguments);var i=Zr(),c=(a=(s=n?.locale)!==null&&s!==void 0?s:i.locale)!==null&&a!==void 0?a:Ei;if(!c.formatDistance)throw new RangeError("locale must contain localize.formatDistance property");var u=Ts(t,r);if(isNaN(u))throw new RangeError("Invalid time value");var d=Gl(Q_(n),{addSuffix:!!n?.addSuffix,comparison:u}),p,f;u>0?(p=qe(r),f=qe(t)):(p=qe(t),f=qe(r));var m=String((o=n?.roundingMethod)!==null&&o!==void 0?o:"round"),j;if(m==="floor")j=Math.floor;else if(m==="ceil")j=Math.ceil;else if(m==="round")j=Math.round;else throw new RangeError("roundingMethod must be 'floor', 'ceil' or 'round'");var v=f.getTime()-p.getTime(),w=v/Md,_=Ms(f)-Ms(p),P=(v-_)/Md,L=n?.unit,C;if(L?C=String(L):w<1?C="second":w<60?C="minute":w<ti?C="hour":P<Rd?C="day":P<Nd?C="month":C="year",C==="second"){var D=j(v/1e3);return c.formatDistance("xSeconds",D,d)}else if(C==="minute"){var A=j(w);return c.formatDistance("xMinutes",A,d)}else if(C==="hour"){var b=j(w/60);return c.formatDistance("xHours",b,d)}else if(C==="day"){var N=j(P/ti);return c.formatDistance("xDays",N,d)}else if(C==="month"){var g=j(P/Rd);return g===12&&L!=="month"?c.formatDistance("xYears",1,d):c.formatDistance("xMonths",g,d)}else if(C==="year"){var x=j(P/Nd);return c.formatDistance("xYears",x,d)}throw new RangeError("unit must be 'second', 'minute', 'hour', 'day', 'month' or 'year'")}function J_(t,r){return Ue(1,arguments),K_(t,Date.now(),r)}function X_(t,r){var n,a;Ue(1,arguments);var s=qe(t);if(isNaN(s.getTime()))throw new RangeError("Invalid time value");var o=String((n=r?.format)!==null&&n!==void 0?n:"extended"),i=String((a=r?.representation)!==null&&a!==void 0?a:"complete");if(o!=="extended"&&o!=="basic")throw new RangeError("format must be 'extended' or 'basic'");if(i!=="date"&&i!=="time"&&i!=="complete")throw new RangeError("representation must be 'date', 'time', or 'complete'");var c="",u="",d=o==="extended"?"-":"",p=o==="extended"?":":"";if(i!=="time"){var f=Dt(s.getDate(),2),m=Dt(s.getMonth()+1,2),j=Dt(s.getFullYear(),4);c="".concat(j).concat(d).concat(m).concat(d).concat(f)}if(i!=="date"){var v=s.getTimezoneOffset();if(v!==0){var w=Math.abs(v),_=Dt(Math.floor(w/60),2),P=Dt(w%60,2),L=v<0?"+":"-";u="".concat(L).concat(_,":").concat(P)}else u="Z";var C=Dt(s.getHours(),2),D=Dt(s.getMinutes(),2),A=Dt(s.getSeconds(),2),b=c===""?"":"T",N=[C,D,A].join(p);c="".concat(c).concat(b).concat(N).concat(u)}return c}function Z_(t){Ue(1,arguments);var r=qe(t),n=r.getDate();return n}function ih(t){Ue(1,arguments);var r=qe(t),n=r.getFullYear(),a=r.getMonth(),s=new Date(0);return s.setFullYear(n,a+1,0),s.setHours(0,0,0,0),s.getDate()}function ej(t){Ue(1,arguments);var r=qe(t),n=r.getHours();return n}function tj(t){Ue(1,arguments);var r=qe(t),n=r.getMilliseconds();return n}function rj(t){Ue(1,arguments);var r=qe(t),n=r.getMinutes();return n}function nj(t){Ue(1,arguments);var r=qe(t),n=r.getMonth();return n}function sj(t){Ue(1,arguments);var r=qe(t),n=r.getSeconds();return n}function aj(t,r){var n,a,s,o,i,c,u,d;Ue(1,arguments);var p=qe(t),f=p.getFullYear(),m=Zr(),j=Rt((n=(a=(s=(o=r?.firstWeekContainsDate)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.firstWeekContainsDate)!==null&&s!==void 0?s:m.firstWeekContainsDate)!==null&&a!==void 0?a:(u=m.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.firstWeekContainsDate)!==null&&n!==void 0?n:1);if(!(j>=1&&j<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var v=new Date(0);v.setFullYear(f+1,0,j),v.setHours(0,0,0,0);var w=Zn(v,r),_=new Date(0);_.setFullYear(f,0,j),_.setHours(0,0,0,0);var P=Zn(_,r);return p.getTime()>=w.getTime()?f+1:p.getTime()>=P.getTime()?f:f-1}function oj(t,r){var n,a,s,o,i,c,u,d;Ue(1,arguments);var p=Zr(),f=Rt((n=(a=(s=(o=r?.firstWeekContainsDate)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.firstWeekContainsDate)!==null&&s!==void 0?s:p.firstWeekContainsDate)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.firstWeekContainsDate)!==null&&n!==void 0?n:1),m=aj(t,r),j=new Date(0);j.setFullYear(m,0,f),j.setHours(0,0,0,0);var v=Zn(j,r);return v}var ij=6048e5;function lj(t,r){Ue(1,arguments);var n=qe(t),a=Zn(n,r).getTime()-oj(n,r).getTime();return Math.round(a/ij)+1}function cj(t){return Ue(1,arguments),qe(t).getFullYear()}function Zi(t,r){Ue(2,arguments);var n=qe(t),a=qe(r);return n.getTime()>a.getTime()}function Ca(t,r){Ue(2,arguments);var n=qe(t),a=qe(r);return n.getTime()<a.getTime()}function dj(t,r){Ue(2,arguments);var n=qe(t),a=qe(r);return n.getTime()===a.getTime()}function Ld(t,r){(r==null||r>t.length)&&(r=t.length);for(var n=0,a=Array(r);n<r;n++)a[n]=t[n];return a}function uj(t,r){if(t){if(typeof t=="string")return Ld(t,r);var n={}.toString.call(t).slice(8,-1);return n==="Object"&&t.constructor&&(n=t.constructor.name),n==="Map"||n==="Set"?Array.from(t):n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ld(t,r):void 0}}function qd(t,r){var n=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=uj(t))||r){n&&(t=n);var a=0,s=function(){};return{s,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(d){throw d},f:s}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var o,i=!0,c=!1;return{s:function(){n=n.call(t)},n:function(){var d=n.next();return i=d.done,d},e:function(d){c=!0,o=d},f:function(){try{i||n.return==null||n.return()}finally{if(c)throw o}}}}function Nt(t,r){if(typeof r!="function"&&r!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&zh(t,r)}function ri(t){return ri=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(r){return r.__proto__||Object.getPrototypeOf(r)},ri(t)}function lh(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(lh=function(){return!!t})()}function pj(t,r){if(r&&(li(r)=="object"||typeof r=="function"))return r;if(r!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Xe(t)}function Lt(t){var r=lh();return function(){var n,a=ri(t);if(r){var s=ri(this).constructor;n=Reflect.construct(a,arguments,s)}else n=a.apply(this,arguments);return pj(this,n)}}function Ot(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function hj(t,r){for(var n=0;n<r.length;n++){var a=r[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,Wu(a.key),a)}}function At(t,r,n){return r&&hj(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function He(t,r,n){return(r=Wu(r))in t?Object.defineProperty(t,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[r]=n,t}var mj=10,ch=function(){function t(){Ot(this,t),He(this,"priority",void 0),He(this,"subPriority",0)}return At(t,[{key:"validate",value:function(n,a){return!0}}]),t}(),fj=function(t){Nt(n,t);var r=Lt(n);function n(a,s,o,i,c){var u;return Ot(this,n),u=r.call(this),u.value=a,u.validateValue=s,u.setValue=o,u.priority=i,c&&(u.subPriority=c),u}return At(n,[{key:"validate",value:function(s,o){return this.validateValue(s,this.value,o)}},{key:"set",value:function(s,o,i){return this.setValue(s,o,this.value,i)}}]),n}(ch),xj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",mj),He(Xe(a),"subPriority",-1),a}return At(n,[{key:"set",value:function(s,o){if(o.timestampIsSet)return s;var i=new Date(0);return i.setFullYear(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate()),i.setHours(s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds(),s.getUTCMilliseconds()),i}}]),n}(ch),$t=function(){function t(){Ot(this,t),He(this,"incompatibleTokens",void 0),He(this,"priority",void 0),He(this,"subPriority",void 0)}return At(t,[{key:"run",value:function(n,a,s,o){var i=this.parse(n,a,s,o);return i?{setter:new fj(i.value,this.validate,this.set,this.priority,this.subPriority),rest:i.rest}:null}},{key:"validate",value:function(n,a,s){return!0}}]),t}(),gj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",140),He(Xe(a),"incompatibleTokens",["R","u","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"G":case"GG":case"GGG":return i.era(s,{width:"abbreviated"})||i.era(s,{width:"narrow"});case"GGGGG":return i.era(s,{width:"narrow"});case"GGGG":default:return i.era(s,{width:"wide"})||i.era(s,{width:"abbreviated"})||i.era(s,{width:"narrow"})}}},{key:"set",value:function(s,o,i){return o.era=i,s.setUTCFullYear(i,0,1),s.setUTCHours(0,0,0,0),s}}]),n}($t),tr={month:/^(1[0-2]|0?\d)/,date:/^(3[0-1]|[0-2]?\d)/,dayOfYear:/^(36[0-6]|3[0-5]\d|[0-2]?\d?\d)/,week:/^(5[0-3]|[0-4]?\d)/,hour23h:/^(2[0-3]|[0-1]?\d)/,hour24h:/^(2[0-4]|[0-1]?\d)/,hour11h:/^(1[0-1]|0?\d)/,hour12h:/^(1[0-2]|0?\d)/,minute:/^[0-5]?\d/,second:/^[0-5]?\d/,singleDigit:/^\d/,twoDigits:/^\d{1,2}/,threeDigits:/^\d{1,3}/,fourDigits:/^\d{1,4}/,anyDigitsSigned:/^-?\d+/,singleDigitSigned:/^-?\d/,twoDigitsSigned:/^-?\d{1,2}/,threeDigitsSigned:/^-?\d{1,3}/,fourDigitsSigned:/^-?\d{1,4}/},sn={basicOptionalMinutes:/^([+-])(\d{2})(\d{2})?|Z/,basic:/^([+-])(\d{2})(\d{2})|Z/,basicOptionalSeconds:/^([+-])(\d{2})(\d{2})((\d{2}))?|Z/,extended:/^([+-])(\d{2}):(\d{2})|Z/,extendedOptionalSeconds:/^([+-])(\d{2}):(\d{2})(:(\d{2}))?|Z/};function rr(t,r){return t&&{value:r(t.value),rest:t.rest}}function Jt(t,r){var n=r.match(t);return n?{value:parseInt(n[0],10),rest:r.slice(n[0].length)}:null}function an(t,r){var n=r.match(t);if(!n)return null;if(n[0]==="Z")return{value:0,rest:r.slice(1)};var a=n[1]==="+"?1:-1,s=n[2]?parseInt(n[2],10):0,o=n[3]?parseInt(n[3],10):0,i=n[5]?parseInt(n[5],10):0;return{value:a*(s*Pi+o*ki+i*Fb),rest:r.slice(n[0].length)}}function dh(t){return Jt(tr.anyDigitsSigned,t)}function Xt(t,r){switch(t){case 1:return Jt(tr.singleDigit,r);case 2:return Jt(tr.twoDigits,r);case 3:return Jt(tr.threeDigits,r);case 4:return Jt(tr.fourDigits,r);default:return Jt(new RegExp("^\\d{1,"+t+"}"),r)}}function ni(t,r){switch(t){case 1:return Jt(tr.singleDigitSigned,r);case 2:return Jt(tr.twoDigitsSigned,r);case 3:return Jt(tr.threeDigitsSigned,r);case 4:return Jt(tr.fourDigitsSigned,r);default:return Jt(new RegExp("^-?\\d{1,"+t+"}"),r)}}function Ql(t){switch(t){case"morning":return 4;case"evening":return 17;case"pm":case"noon":case"afternoon":return 12;case"am":case"midnight":case"night":default:return 0}}function uh(t,r){var n=r>0,a=n?r:1-r,s;if(a<=50)s=t||100;else{var o=a+50,i=Math.floor(o/100)*100,c=t>=o%100;s=t+i-(c?100:0)}return n?s:1-s}function ph(t){return t%400===0||t%4===0&&t%100!==0}var yj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",130),He(Xe(a),"incompatibleTokens",["Y","R","u","w","I","i","e","c","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){var c=function(d){return{year:d,isTwoDigitYear:o==="yy"}};switch(o){case"y":return rr(Xt(4,s),c);case"yo":return rr(i.ordinalNumber(s,{unit:"year"}),c);default:return rr(Xt(o.length,s),c)}}},{key:"validate",value:function(s,o){return o.isTwoDigitYear||o.year>0}},{key:"set",value:function(s,o,i){var c=s.getUTCFullYear();if(i.isTwoDigitYear){var u=uh(i.year,c);return s.setUTCFullYear(u,0,1),s.setUTCHours(0,0,0,0),s}var d=!("era"in o)||o.era===1?i.year:1-i.year;return s.setUTCFullYear(d,0,1),s.setUTCHours(0,0,0,0),s}}]),n}($t),vj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",130),He(Xe(a),"incompatibleTokens",["y","R","u","Q","q","M","L","I","d","D","i","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){var c=function(d){return{year:d,isTwoDigitYear:o==="YY"}};switch(o){case"Y":return rr(Xt(4,s),c);case"Yo":return rr(i.ordinalNumber(s,{unit:"year"}),c);default:return rr(Xt(o.length,s),c)}}},{key:"validate",value:function(s,o){return o.isTwoDigitYear||o.year>0}},{key:"set",value:function(s,o,i,c){var u=Vl(s,c);if(i.isTwoDigitYear){var d=uh(i.year,u);return s.setUTCFullYear(d,0,c.firstWeekContainsDate),s.setUTCHours(0,0,0,0),rs(s,c)}var p=!("era"in o)||o.era===1?i.year:1-i.year;return s.setUTCFullYear(p,0,c.firstWeekContainsDate),s.setUTCHours(0,0,0,0),rs(s,c)}}]),n}($t),bj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",130),He(Xe(a),"incompatibleTokens",["G","y","Y","u","Q","q","M","L","w","d","D","e","c","t","T"]),a}return At(n,[{key:"parse",value:function(s,o){return ni(o==="R"?4:o.length,s)}},{key:"set",value:function(s,o,i){var c=new Date(0);return c.setUTCFullYear(i,0,4),c.setUTCHours(0,0,0,0),Ns(c)}}]),n}($t),_j=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",130),He(Xe(a),"incompatibleTokens",["G","y","Y","R","w","I","i","e","c","t","T"]),a}return At(n,[{key:"parse",value:function(s,o){return ni(o==="u"?4:o.length,s)}},{key:"set",value:function(s,o,i){return s.setUTCFullYear(i,0,1),s.setUTCHours(0,0,0,0),s}}]),n}($t),jj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",120),He(Xe(a),"incompatibleTokens",["Y","R","q","M","L","w","I","d","D","i","e","c","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"Q":case"QQ":return Xt(o.length,s);case"Qo":return i.ordinalNumber(s,{unit:"quarter"});case"QQQ":return i.quarter(s,{width:"abbreviated",context:"formatting"})||i.quarter(s,{width:"narrow",context:"formatting"});case"QQQQQ":return i.quarter(s,{width:"narrow",context:"formatting"});case"QQQQ":default:return i.quarter(s,{width:"wide",context:"formatting"})||i.quarter(s,{width:"abbreviated",context:"formatting"})||i.quarter(s,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(s,o){return o>=1&&o<=4}},{key:"set",value:function(s,o,i){return s.setUTCMonth((i-1)*3,1),s.setUTCHours(0,0,0,0),s}}]),n}($t),wj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",120),He(Xe(a),"incompatibleTokens",["Y","R","Q","M","L","w","I","d","D","i","e","c","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"q":case"qq":return Xt(o.length,s);case"qo":return i.ordinalNumber(s,{unit:"quarter"});case"qqq":return i.quarter(s,{width:"abbreviated",context:"standalone"})||i.quarter(s,{width:"narrow",context:"standalone"});case"qqqqq":return i.quarter(s,{width:"narrow",context:"standalone"});case"qqqq":default:return i.quarter(s,{width:"wide",context:"standalone"})||i.quarter(s,{width:"abbreviated",context:"standalone"})||i.quarter(s,{width:"narrow",context:"standalone"})}}},{key:"validate",value:function(s,o){return o>=1&&o<=4}},{key:"set",value:function(s,o,i){return s.setUTCMonth((i-1)*3,1),s.setUTCHours(0,0,0,0),s}}]),n}($t),Sj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"incompatibleTokens",["Y","R","q","Q","L","w","I","D","i","e","c","t","T"]),He(Xe(a),"priority",110),a}return At(n,[{key:"parse",value:function(s,o,i){var c=function(d){return d-1};switch(o){case"M":return rr(Jt(tr.month,s),c);case"MM":return rr(Xt(2,s),c);case"Mo":return rr(i.ordinalNumber(s,{unit:"month"}),c);case"MMM":return i.month(s,{width:"abbreviated",context:"formatting"})||i.month(s,{width:"narrow",context:"formatting"});case"MMMMM":return i.month(s,{width:"narrow",context:"formatting"});case"MMMM":default:return i.month(s,{width:"wide",context:"formatting"})||i.month(s,{width:"abbreviated",context:"formatting"})||i.month(s,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(s,o){return o>=0&&o<=11}},{key:"set",value:function(s,o,i){return s.setUTCMonth(i,1),s.setUTCHours(0,0,0,0),s}}]),n}($t),Cj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",110),He(Xe(a),"incompatibleTokens",["Y","R","q","Q","M","w","I","D","i","e","c","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){var c=function(d){return d-1};switch(o){case"L":return rr(Jt(tr.month,s),c);case"LL":return rr(Xt(2,s),c);case"Lo":return rr(i.ordinalNumber(s,{unit:"month"}),c);case"LLL":return i.month(s,{width:"abbreviated",context:"standalone"})||i.month(s,{width:"narrow",context:"standalone"});case"LLLLL":return i.month(s,{width:"narrow",context:"standalone"});case"LLLL":default:return i.month(s,{width:"wide",context:"standalone"})||i.month(s,{width:"abbreviated",context:"standalone"})||i.month(s,{width:"narrow",context:"standalone"})}}},{key:"validate",value:function(s,o){return o>=0&&o<=11}},{key:"set",value:function(s,o,i){return s.setUTCMonth(i,1),s.setUTCHours(0,0,0,0),s}}]),n}($t);function kj(t,r,n){Ue(2,arguments);var a=qe(t),s=Rt(r),o=nh(a,n)-s;return a.setUTCDate(a.getUTCDate()-o*7),a}var Pj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",100),He(Xe(a),"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","i","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"w":return Jt(tr.week,s);case"wo":return i.ordinalNumber(s,{unit:"week"});default:return Xt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=1&&o<=53}},{key:"set",value:function(s,o,i,c){return rs(kj(s,i,c),c)}}]),n}($t);function Dj(t,r){Ue(2,arguments);var n=qe(t),a=Rt(r),s=rh(n)-a;return n.setUTCDate(n.getUTCDate()-s*7),n}var Ej=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",100),He(Xe(a),"incompatibleTokens",["y","Y","u","q","Q","M","L","w","d","D","e","c","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"I":return Jt(tr.week,s);case"Io":return i.ordinalNumber(s,{unit:"week"});default:return Xt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=1&&o<=53}},{key:"set",value:function(s,o,i){return Ns(Dj(s,i))}}]),n}($t),Ij=[31,28,31,30,31,30,31,31,30,31,30,31],Tj=[31,29,31,30,31,30,31,31,30,31,30,31],Oj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",90),He(Xe(a),"subPriority",1),He(Xe(a),"incompatibleTokens",["Y","R","q","Q","w","I","D","i","e","c","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"d":return Jt(tr.date,s);case"do":return i.ordinalNumber(s,{unit:"date"});default:return Xt(o.length,s)}}},{key:"validate",value:function(s,o){var i=s.getUTCFullYear(),c=ph(i),u=s.getUTCMonth();return c?o>=1&&o<=Tj[u]:o>=1&&o<=Ij[u]}},{key:"set",value:function(s,o,i){return s.setUTCDate(i),s.setUTCHours(0,0,0,0),s}}]),n}($t),Aj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",90),He(Xe(a),"subpriority",1),He(Xe(a),"incompatibleTokens",["Y","R","q","Q","M","L","w","I","d","E","i","e","c","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"D":case"DD":return Jt(tr.dayOfYear,s);case"Do":return i.ordinalNumber(s,{unit:"date"});default:return Xt(o.length,s)}}},{key:"validate",value:function(s,o){var i=s.getUTCFullYear(),c=ph(i);return c?o>=1&&o<=366:o>=1&&o<=365}},{key:"set",value:function(s,o,i){return s.setUTCMonth(0,i),s.setUTCHours(0,0,0,0),s}}]),n}($t);function Kl(t,r,n){var a,s,o,i,c,u,d,p;Ue(2,arguments);var f=Zr(),m=Rt((a=(s=(o=(i=n?.weekStartsOn)!==null&&i!==void 0?i:n==null||(c=n.locale)===null||c===void 0||(u=c.options)===null||u===void 0?void 0:u.weekStartsOn)!==null&&o!==void 0?o:f.weekStartsOn)!==null&&s!==void 0?s:(d=f.locale)===null||d===void 0||(p=d.options)===null||p===void 0?void 0:p.weekStartsOn)!==null&&a!==void 0?a:0);if(!(m>=0&&m<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var j=qe(t),v=Rt(r),w=j.getUTCDay(),_=v%7,P=(_+7)%7,L=(P<m?7:0)+v-w;return j.setUTCDate(j.getUTCDate()+L),j}var Mj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",90),He(Xe(a),"incompatibleTokens",["D","i","e","c","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"E":case"EE":case"EEE":return i.day(s,{width:"abbreviated",context:"formatting"})||i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"});case"EEEEE":return i.day(s,{width:"narrow",context:"formatting"});case"EEEEEE":return i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"});case"EEEE":default:return i.day(s,{width:"wide",context:"formatting"})||i.day(s,{width:"abbreviated",context:"formatting"})||i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(s,o){return o>=0&&o<=6}},{key:"set",value:function(s,o,i,c){return s=Kl(s,i,c),s.setUTCHours(0,0,0,0),s}}]),n}($t),Rj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",90),He(Xe(a),"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","E","i","c","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i,c){var u=function(p){var f=Math.floor((p-1)/7)*7;return(p+c.weekStartsOn+6)%7+f};switch(o){case"e":case"ee":return rr(Xt(o.length,s),u);case"eo":return rr(i.ordinalNumber(s,{unit:"day"}),u);case"eee":return i.day(s,{width:"abbreviated",context:"formatting"})||i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"});case"eeeee":return i.day(s,{width:"narrow",context:"formatting"});case"eeeeee":return i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"});case"eeee":default:return i.day(s,{width:"wide",context:"formatting"})||i.day(s,{width:"abbreviated",context:"formatting"})||i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(s,o){return o>=0&&o<=6}},{key:"set",value:function(s,o,i,c){return s=Kl(s,i,c),s.setUTCHours(0,0,0,0),s}}]),n}($t),Nj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",90),He(Xe(a),"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","E","i","e","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i,c){var u=function(p){var f=Math.floor((p-1)/7)*7;return(p+c.weekStartsOn+6)%7+f};switch(o){case"c":case"cc":return rr(Xt(o.length,s),u);case"co":return rr(i.ordinalNumber(s,{unit:"day"}),u);case"ccc":return i.day(s,{width:"abbreviated",context:"standalone"})||i.day(s,{width:"short",context:"standalone"})||i.day(s,{width:"narrow",context:"standalone"});case"ccccc":return i.day(s,{width:"narrow",context:"standalone"});case"cccccc":return i.day(s,{width:"short",context:"standalone"})||i.day(s,{width:"narrow",context:"standalone"});case"cccc":default:return i.day(s,{width:"wide",context:"standalone"})||i.day(s,{width:"abbreviated",context:"standalone"})||i.day(s,{width:"short",context:"standalone"})||i.day(s,{width:"narrow",context:"standalone"})}}},{key:"validate",value:function(s,o){return o>=0&&o<=6}},{key:"set",value:function(s,o,i,c){return s=Kl(s,i,c),s.setUTCHours(0,0,0,0),s}}]),n}($t);function Lj(t,r){Ue(2,arguments);var n=Rt(r);n%7===0&&(n=n-7);var a=1,s=qe(t),o=s.getUTCDay(),i=n%7,c=(i+7)%7,u=(c<a?7:0)+n-o;return s.setUTCDate(s.getUTCDate()+u),s}var qj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",90),He(Xe(a),"incompatibleTokens",["y","Y","u","q","Q","M","L","w","d","D","E","e","c","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){var c=function(d){return d===0?7:d};switch(o){case"i":case"ii":return Xt(o.length,s);case"io":return i.ordinalNumber(s,{unit:"day"});case"iii":return rr(i.day(s,{width:"abbreviated",context:"formatting"})||i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"}),c);case"iiiii":return rr(i.day(s,{width:"narrow",context:"formatting"}),c);case"iiiiii":return rr(i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"}),c);case"iiii":default:return rr(i.day(s,{width:"wide",context:"formatting"})||i.day(s,{width:"abbreviated",context:"formatting"})||i.day(s,{width:"short",context:"formatting"})||i.day(s,{width:"narrow",context:"formatting"}),c)}}},{key:"validate",value:function(s,o){return o>=1&&o<=7}},{key:"set",value:function(s,o,i){return s=Lj(s,i),s.setUTCHours(0,0,0,0),s}}]),n}($t),Uj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",80),He(Xe(a),"incompatibleTokens",["b","B","H","k","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"a":case"aa":case"aaa":return i.dayPeriod(s,{width:"abbreviated",context:"formatting"})||i.dayPeriod(s,{width:"narrow",context:"formatting"});case"aaaaa":return i.dayPeriod(s,{width:"narrow",context:"formatting"});case"aaaa":default:return i.dayPeriod(s,{width:"wide",context:"formatting"})||i.dayPeriod(s,{width:"abbreviated",context:"formatting"})||i.dayPeriod(s,{width:"narrow",context:"formatting"})}}},{key:"set",value:function(s,o,i){return s.setUTCHours(Ql(i),0,0,0),s}}]),n}($t),Wj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",80),He(Xe(a),"incompatibleTokens",["a","B","H","k","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"b":case"bb":case"bbb":return i.dayPeriod(s,{width:"abbreviated",context:"formatting"})||i.dayPeriod(s,{width:"narrow",context:"formatting"});case"bbbbb":return i.dayPeriod(s,{width:"narrow",context:"formatting"});case"bbbb":default:return i.dayPeriod(s,{width:"wide",context:"formatting"})||i.dayPeriod(s,{width:"abbreviated",context:"formatting"})||i.dayPeriod(s,{width:"narrow",context:"formatting"})}}},{key:"set",value:function(s,o,i){return s.setUTCHours(Ql(i),0,0,0),s}}]),n}($t),Fj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",80),He(Xe(a),"incompatibleTokens",["a","b","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"B":case"BB":case"BBB":return i.dayPeriod(s,{width:"abbreviated",context:"formatting"})||i.dayPeriod(s,{width:"narrow",context:"formatting"});case"BBBBB":return i.dayPeriod(s,{width:"narrow",context:"formatting"});case"BBBB":default:return i.dayPeriod(s,{width:"wide",context:"formatting"})||i.dayPeriod(s,{width:"abbreviated",context:"formatting"})||i.dayPeriod(s,{width:"narrow",context:"formatting"})}}},{key:"set",value:function(s,o,i){return s.setUTCHours(Ql(i),0,0,0),s}}]),n}($t),$j=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",70),He(Xe(a),"incompatibleTokens",["H","K","k","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"h":return Jt(tr.hour12h,s);case"ho":return i.ordinalNumber(s,{unit:"hour"});default:return Xt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=1&&o<=12}},{key:"set",value:function(s,o,i){var c=s.getUTCHours()>=12;return c&&i<12?s.setUTCHours(i+12,0,0,0):!c&&i===12?s.setUTCHours(0,0,0,0):s.setUTCHours(i,0,0,0),s}}]),n}($t),zj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",70),He(Xe(a),"incompatibleTokens",["a","b","h","K","k","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"H":return Jt(tr.hour23h,s);case"Ho":return i.ordinalNumber(s,{unit:"hour"});default:return Xt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=0&&o<=23}},{key:"set",value:function(s,o,i){return s.setUTCHours(i,0,0,0),s}}]),n}($t),Bj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",70),He(Xe(a),"incompatibleTokens",["h","H","k","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"K":return Jt(tr.hour11h,s);case"Ko":return i.ordinalNumber(s,{unit:"hour"});default:return Xt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=0&&o<=11}},{key:"set",value:function(s,o,i){var c=s.getUTCHours()>=12;return c&&i<12?s.setUTCHours(i+12,0,0,0):s.setUTCHours(i,0,0,0),s}}]),n}($t),Hj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",70),He(Xe(a),"incompatibleTokens",["a","b","h","H","K","t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"k":return Jt(tr.hour24h,s);case"ko":return i.ordinalNumber(s,{unit:"hour"});default:return Xt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=1&&o<=24}},{key:"set",value:function(s,o,i){var c=i<=24?i%24:i;return s.setUTCHours(c,0,0,0),s}}]),n}($t),Yj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",60),He(Xe(a),"incompatibleTokens",["t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"m":return Jt(tr.minute,s);case"mo":return i.ordinalNumber(s,{unit:"minute"});default:return Xt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=0&&o<=59}},{key:"set",value:function(s,o,i){return s.setUTCMinutes(i,0,0),s}}]),n}($t),Vj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",50),He(Xe(a),"incompatibleTokens",["t","T"]),a}return At(n,[{key:"parse",value:function(s,o,i){switch(o){case"s":return Jt(tr.second,s);case"so":return i.ordinalNumber(s,{unit:"second"});default:return Xt(o.length,s)}}},{key:"validate",value:function(s,o){return o>=0&&o<=59}},{key:"set",value:function(s,o,i){return s.setUTCSeconds(i,0),s}}]),n}($t),Gj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",30),He(Xe(a),"incompatibleTokens",["t","T"]),a}return At(n,[{key:"parse",value:function(s,o){var i=function(u){return Math.floor(u*Math.pow(10,-o.length+3))};return rr(Xt(o.length,s),i)}},{key:"set",value:function(s,o,i){return s.setUTCMilliseconds(i),s}}]),n}($t),Qj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",10),He(Xe(a),"incompatibleTokens",["t","T","x"]),a}return At(n,[{key:"parse",value:function(s,o){switch(o){case"X":return an(sn.basicOptionalMinutes,s);case"XX":return an(sn.basic,s);case"XXXX":return an(sn.basicOptionalSeconds,s);case"XXXXX":return an(sn.extendedOptionalSeconds,s);case"XXX":default:return an(sn.extended,s)}}},{key:"set",value:function(s,o,i){return o.timestampIsSet?s:new Date(s.getTime()-i)}}]),n}($t),Kj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",10),He(Xe(a),"incompatibleTokens",["t","T","X"]),a}return At(n,[{key:"parse",value:function(s,o){switch(o){case"x":return an(sn.basicOptionalMinutes,s);case"xx":return an(sn.basic,s);case"xxxx":return an(sn.basicOptionalSeconds,s);case"xxxxx":return an(sn.extendedOptionalSeconds,s);case"xxx":default:return an(sn.extended,s)}}},{key:"set",value:function(s,o,i){return o.timestampIsSet?s:new Date(s.getTime()-i)}}]),n}($t),Jj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",40),He(Xe(a),"incompatibleTokens","*"),a}return At(n,[{key:"parse",value:function(s){return dh(s)}},{key:"set",value:function(s,o,i){return[new Date(i*1e3),{timestampIsSet:!0}]}}]),n}($t),Xj=function(t){Nt(n,t);var r=Lt(n);function n(){var a;Ot(this,n);for(var s=arguments.length,o=new Array(s),i=0;i<s;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),He(Xe(a),"priority",20),He(Xe(a),"incompatibleTokens","*"),a}return At(n,[{key:"parse",value:function(s){return dh(s)}},{key:"set",value:function(s,o,i){return[new Date(i),{timestampIsSet:!0}]}}]),n}($t),Zj={G:new gj,y:new yj,Y:new vj,R:new bj,u:new _j,Q:new jj,q:new wj,M:new Sj,L:new Cj,w:new Pj,I:new Ej,d:new Oj,D:new Aj,E:new Mj,e:new Rj,c:new Nj,i:new qj,a:new Uj,b:new Wj,B:new Fj,h:new $j,H:new zj,K:new Bj,k:new Hj,m:new Yj,s:new Vj,S:new Gj,X:new Qj,x:new Kj,t:new Jj,T:new Xj},e0=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,t0=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,r0=/^'([^]*?)'?$/,n0=/''/g,s0=/\S/,a0=/[a-zA-Z]/;function o0(t,r,n,a){var s,o,i,c,u,d,p,f,m,j,v,w,_,P,L,C,D,A;Ue(3,arguments);var b=String(t),N=String(r),g=Zr(),x=(s=(o=a?.locale)!==null&&o!==void 0?o:g.locale)!==null&&s!==void 0?s:Ei;if(!x.match)throw new RangeError("locale must contain match property");var R=Rt((i=(c=(u=(d=a?.firstWeekContainsDate)!==null&&d!==void 0?d:a==null||(p=a.locale)===null||p===void 0||(f=p.options)===null||f===void 0?void 0:f.firstWeekContainsDate)!==null&&u!==void 0?u:g.firstWeekContainsDate)!==null&&c!==void 0?c:(m=g.locale)===null||m===void 0||(j=m.options)===null||j===void 0?void 0:j.firstWeekContainsDate)!==null&&i!==void 0?i:1);if(!(R>=1&&R<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var O=Rt((v=(w=(_=(P=a?.weekStartsOn)!==null&&P!==void 0?P:a==null||(L=a.locale)===null||L===void 0||(C=L.options)===null||C===void 0?void 0:C.weekStartsOn)!==null&&_!==void 0?_:g.weekStartsOn)!==null&&w!==void 0?w:(D=g.locale)===null||D===void 0||(A=D.options)===null||A===void 0?void 0:A.weekStartsOn)!==null&&v!==void 0?v:0);if(!(O>=0&&O<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");if(N==="")return b===""?qe(n):new Date(NaN);var ee={firstWeekContainsDate:R,weekStartsOn:O,locale:x},J=[new xj],z=N.match(t0).map(function(ge){var xe=ge[0];if(xe in Dl){var me=Dl[xe];return me(ge,x.formatLong)}return ge}).join("").match(e0),Z=[],Q=qd(z),X;try{var I=function(){var xe=X.value;!(a!=null&&a.useAdditionalWeekYearTokens)&&oh(xe)&&ei(xe,N,t),!(a!=null&&a.useAdditionalDayOfYearTokens)&&ah(xe)&&ei(xe,N,t);var me=xe[0],he=Zj[me];if(he){var ae=he.incompatibleTokens;if(Array.isArray(ae)){var T=Z.find(function(ce){return ae.includes(ce.token)||ce.token===me});if(T)throw new RangeError("The format string mustn't contain `".concat(T.fullToken,"` and `").concat(xe,"` at the same time"))}else if(he.incompatibleTokens==="*"&&Z.length>0)throw new RangeError("The format string mustn't contain `".concat(xe,"` and any other token at the same time"));Z.push({token:me,fullToken:xe});var $=he.run(b,xe,x.match,ee);if(!$)return{v:new Date(NaN)};J.push($.setter),b=$.rest}else{if(me.match(a0))throw new RangeError("Format string contains an unescaped latin alphabet character `"+me+"`");if(xe==="''"?xe="'":me==="'"&&(xe=i0(xe)),b.indexOf(xe)===0)b=b.slice(xe.length);else return{v:new Date(NaN)}}};for(Q.s();!(X=Q.n()).done;){var y=I();if(li(y)==="object")return y.v}}catch(ge){Q.e(ge)}finally{Q.f()}if(b.length>0&&s0.test(b))return new Date(NaN);var S=J.map(function(ge){return ge.priority}).sort(function(ge,xe){return xe-ge}).filter(function(ge,xe,me){return me.indexOf(ge)===xe}).map(function(ge){return J.filter(function(xe){return xe.priority===ge}).sort(function(xe,me){return me.subPriority-xe.subPriority})}).map(function(ge){return ge[0]}),U=qe(n);if(isNaN(U.getTime()))return new Date(NaN);var K=eh(U,Ms(U)),E={},V=qd(S),q;try{for(V.s();!(q=V.n()).done;){var ue=q.value;if(!ue.validate(K,ee))return new Date(NaN);var ye=ue.set(K,E,ee);Array.isArray(ye)?(K=ye[0],Gl(E,ye[1])):K=ye}}catch(ge){V.e(ge)}finally{V.f()}return K}function i0(t){return t.match(r0)[1].replace(n0,"'")}function Ud(t){Ue(1,arguments);var r=qe(t);return r.setMinutes(0,0,0),r}function l0(t,r){Ue(2,arguments);var n=Ud(t),a=Ud(r);return n.getTime()===a.getTime()}function c0(t,r){Ue(2,arguments);var n=qe(t),a=qe(r);return n.getFullYear()===a.getFullYear()&&n.getMonth()===a.getMonth()}function d0(t,r){Ue(2,arguments);var n=qe(t),a=qe(r);return n.getFullYear()===a.getFullYear()}function u0(t,r){Ue(2,arguments);var n=qe(t).getTime(),a=qe(r.start).getTime(),s=qe(r.end).getTime();if(!(a<=s))throw new RangeError("Invalid interval");return n>=a&&n<=s}function p0(t,r){var n;Ue(1,arguments);var a=Rt((n=void 0)!==null&&n!==void 0?n:2);if(a!==2&&a!==1&&a!==0)throw new RangeError("additionalDigits must be 0, 1 or 2");if(!(typeof t=="string"||Object.prototype.toString.call(t)==="[object String]"))return new Date(NaN);var s=x0(t),o;if(s.date){var i=g0(s.date,a);o=y0(i.restDateString,i.year)}if(!o||isNaN(o.getTime()))return new Date(NaN);var c=o.getTime(),u=0,d;if(s.time&&(u=v0(s.time),isNaN(u)))return new Date(NaN);if(s.timezone){if(d=b0(s.timezone),isNaN(d))return new Date(NaN)}else{var p=new Date(c+u),f=new Date(0);return f.setFullYear(p.getUTCFullYear(),p.getUTCMonth(),p.getUTCDate()),f.setHours(p.getUTCHours(),p.getUTCMinutes(),p.getUTCSeconds(),p.getUTCMilliseconds()),f}return new Date(c+u+d)}var Po={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},h0=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,m0=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,f0=/^([+-])(\d{2})(?::?(\d{2}))?$/;function x0(t){var r={},n=t.split(Po.dateTimeDelimiter),a;if(n.length>2)return r;if(/:/.test(n[0])?a=n[0]:(r.date=n[0],a=n[1],Po.timeZoneDelimiter.test(r.date)&&(r.date=t.split(Po.timeZoneDelimiter)[0],a=t.substr(r.date.length,t.length))),a){var s=Po.timezone.exec(a);s?(r.time=a.replace(s[1],""),r.timezone=s[1]):r.time=a}return r}function g0(t,r){var n=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+r)+"})|(\\d{2}|[+-]\\d{"+(2+r)+"})$)"),a=t.match(n);if(!a)return{year:NaN,restDateString:""};var s=a[1]?parseInt(a[1]):null,o=a[2]?parseInt(a[2]):null;return{year:o===null?s:o*100,restDateString:t.slice((a[1]||a[2]).length)}}function y0(t,r){if(r===null)return new Date(NaN);var n=t.match(h0);if(!n)return new Date(NaN);var a=!!n[4],s=ka(n[1]),o=ka(n[2])-1,i=ka(n[3]),c=ka(n[4]),u=ka(n[5])-1;if(a)return C0(r,c,u)?_0(r,c,u):new Date(NaN);var d=new Date(0);return!w0(r,o,i)||!S0(r,s)?new Date(NaN):(d.setUTCFullYear(r,o,Math.max(s,i)),d)}function ka(t){return t?parseInt(t):1}function v0(t){var r=t.match(m0);if(!r)return NaN;var n=el(r[1]),a=el(r[2]),s=el(r[3]);return k0(n,a,s)?n*Pi+a*ki+s*1e3:NaN}function el(t){return t&&parseFloat(t.replace(",","."))||0}function b0(t){if(t==="Z")return 0;var r=t.match(f0);if(!r)return 0;var n=r[1]==="+"?-1:1,a=parseInt(r[2]),s=r[3]&&parseInt(r[3])||0;return P0(a,s)?n*(a*Pi+s*ki):NaN}function _0(t,r,n){var a=new Date(0);a.setUTCFullYear(t,0,4);var s=a.getUTCDay()||7,o=(r-1)*7+n+1-s;return a.setUTCDate(a.getUTCDate()+o),a}var j0=[31,null,31,30,31,30,31,31,30,31,30,31];function hh(t){return t%400===0||t%4===0&&t%100!==0}function w0(t,r,n){return r>=0&&r<=11&&n>=1&&n<=(j0[r]||(hh(t)?29:28))}function S0(t,r){return r>=1&&r<=(hh(t)?366:365)}function C0(t,r,n){return r>=1&&r<=53&&n>=0&&n<=6}function k0(t,r,n){return t===24?r===0&&n===0:n>=0&&n<60&&r>=0&&r<60&&t>=0&&t<25}function P0(t,r){return r>=0&&r<=59}function D0(t,r){Ue(2,arguments);var n=qe(t),a=Rt(r),s=n.getFullYear(),o=n.getDate(),i=new Date(0);i.setFullYear(s,a,15),i.setHours(0,0,0,0);var c=ih(i);return n.setMonth(a,Math.min(o,c)),n}function E0(t,r){Ue(2,arguments);var n=qe(t),a=Rt(r);return n.setDate(a),n}function I0(t,r){Ue(2,arguments);var n=qe(t),a=Rt(r);return n.setHours(a),n}function T0(t,r){Ue(2,arguments);var n=qe(t),a=Rt(r);return n.setMilliseconds(a),n}function O0(t,r){Ue(2,arguments);var n=qe(t),a=Rt(r);return n.setMinutes(a),n}function A0(t,r){Ue(2,arguments);var n=qe(t),a=Rt(r);return n.setSeconds(a),n}function M0(t,r){Ue(2,arguments);var n=qe(t),a=Rt(r);return isNaN(n.getTime())?new Date(NaN):(n.setFullYear(a),n)}const Za=t=>{const r=(t??"").toString().trim().toLowerCase();return r==="approved"?"Approved":r==="rejected"?"Rejected":"Open"},Wd=t=>{const r=Number(t);return isFinite(r)?new Intl.NumberFormat("en-CA",{maximumFractionDigits:0}).format(r):""},R0=()=>{const t=Kt(),[r,n]=l.useState([]),[a,s]=l.useState(""),[o,i]=l.useState("Open"),[c,u]=l.useState({page:0,pageSize:10}),[d,p]=l.useState(null),[f,m]=l.useState(null);l.useEffect(()=>{j()},[]);const j=async()=>{try{const N=((await B.get("/api/quotes")).data||[]).map(g=>({...g,status:Za(g.status)}));n(N)}catch(b){console.error("Error fetching quotes:",b),p("Failed to fetch quotes")}},v=async b=>{if(window.confirm("Are you sure you want to delete this quote?"))try{await B.delete(`/api/quotes/${b}`),m("Quote deleted successfully"),j()}catch{p("Failed to delete quote")}},w=()=>{const b=r.map(O=>({"Quote #":O.quote_number,Customer:O.customer_name,Product:O.product_name,Make:O.vehicle_make||"",Model:O.vehicle_model||"","Est. Price":Wd(O.estimated_cost),"Quote Date":O.quote_date?Ss(new Date(O.quote_date),"MM/dd/yyyy"):"","Valid Until":O.valid_until?Ss(new Date(O.valid_until),"MM/dd/yyyy"):"",Status:O.status})),N=Wn.unparse(b),g=new Blob([N],{type:"text/csv;charset=utf-8;"}),x=document.createElement("a"),R=URL.createObjectURL(g);x.setAttribute("href",R),x.setAttribute("download","quotes.csv"),x.style.visibility="hidden",document.body.appendChild(x),x.click(),document.body.removeChild(x)},_=a.toLowerCase(),P=l.useMemo(()=>{const b=r.filter(N=>N.status===o);return _?b.filter(N=>N.quote_number?.toLowerCase?.().includes(_)||N.customer_name?.toLowerCase?.().includes(_)||N.product_name?.toLowerCase?.().includes(_)||N.vehicle_make?.toLowerCase?.().includes(_)||N.vehicle_model?.toLowerCase?.().includes(_)):b},[r,o,_]),L=b=>{switch(b){case"Approved":return{backgroundColor:"rgba(76, 175, 80, 0.12)",color:"#2e7d32"};case"Rejected":return{backgroundColor:"rgba(244, 67, 54, 0.12)",color:"#c62828"};default:return{backgroundColor:"rgba(33, 150, 243, 0.12)",color:"#1565c0"}}},C=P.map(b=>({...b,id:b.quote_id})),D=[{field:"quote_number",headerName:"Quote #",flex:1.05,minWidth:150,valueFormatter:b=>b.value?String(b.value).replace("QO-",""):""},{field:"customer_name",headerName:"Customer",flex:1.2,minWidth:170},{field:"product_name",headerName:"Product",flex:1.1,minWidth:160},{field:"vehicle_make",headerName:"Make",flex:.9,minWidth:130},{field:"vehicle_model",headerName:"Model",flex:.9,minWidth:130},{field:"estimated_cost",headerName:"Est. Price",type:"number",flex:.8,minWidth:110,headerAlign:"left",align:"left",valueFormatter:b=>Wd(b.value)},{field:"quote_date",headerName:"Quote Date",flex:.95,minWidth:130,valueFormatter:b=>b.value?Ss(new Date(b.value),"yyyy-MM-dd"):""},{field:"valid_until",headerName:"Valid Until",flex:.95,minWidth:130,valueFormatter:b=>b.value?Ss(new Date(b.value),"yyyy-MM-dd"):""},{field:"status",headerName:"Status",flex:.8,minWidth:130,sortable:!1,renderCell:b=>{const N=b.value,g=L(N);return e.jsx(De,{label:N,size:"small",sx:{fontWeight:600,...g}})}},{field:"actions",headerName:"Actions",width:120,flex:0,sortable:!1,filterable:!1,disableColumnMenu:!0,renderCell:b=>e.jsx(k,{sx:{display:"flex",alignItems:"center"},children:e.jsx(Vt,{title:"Delete",children:e.jsx(gt,{size:"small",color:"error",onClick:N=>{N.stopPropagation();const g=b.row.quote_id;v(g)},children:e.jsx(gr,{})})})})}],A=b=>{const N=b.row;t(`/quotes/${N.quote_id}`)};return e.jsxs(at,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{mb:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Quotes"}),e.jsxs(ke,{direction:"row",spacing:2,sx:{mb:2,justifyContent:"flex-end"},children:[e.jsx(G,{variant:"contained",startIcon:e.jsx(Lr,{}),onClick:()=>t("/quotes/new"),children:"New Quote"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(yr,{}),onClick:w,children:"Export CSV"})]})]}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsxs(ke,{direction:"row",spacing:3,sx:{mb:3},children:[e.jsx(le,{label:"Search",value:a,onChange:b=>s(b.target.value),InputProps:{startAdornment:e.jsx(pr,{position:"start",children:e.jsx(Br,{sx:{fontSize:32}})}),sx:{fontSize:22,height:56}},sx:{minWidth:340,maxWidth:400,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"medium",variant:"outlined"}),e.jsx(De,{label:"Open",onClick:()=>i("Open"),color:o==="Open"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),e.jsx(De,{label:"Approved",onClick:()=>i("Approved"),color:o==="Approved"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),e.jsx(De,{label:"Rejected",onClick:()=>i("Rejected"),color:o==="Rejected"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}})]}),e.jsx(Jr,{rows:C,columns:D,paginationModel:c,onPaginationModelChange:u,pageSizeOptions:[10,25,50],getRowId:b=>b.id,onRowClick:A,disableRowSelectionOnClick:!0,hideFooterSelectedRowCount:!0,initialState:{sorting:{sortModel:[{field:"quote_number",sort:"desc"}]}},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224,224,224,1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224,224,224,1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"},cursor:"pointer"}})]})}),e.jsx(bn,{open:!!f,autoHideDuration:6e3,onClose:()=>m(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(We,{onClose:()=>m(null),severity:"success",sx:{width:"100%"},children:f})}),e.jsx(bn,{open:!!d,autoHideDuration:6e3,onClose:()=>p(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(We,{onClose:()=>p(null),severity:"error",sx:{width:"100%"},children:d})})]})};var Pa={},Fd;function N0(){if(Fd)return Pa;Fd=1;var t=yt();Object.defineProperty(Pa,"__esModule",{value:!0}),Pa.default=void 0;var r=t(bt()),n=vt();return Pa.default=(0,r.default)((0,n.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"}),"Save"),Pa}var L0=N0();const as=st(L0);var Da={},$d;function q0(){if($d)return Da;$d=1;var t=yt();Object.defineProperty(Da,"__esModule",{value:!0}),Da.default=void 0;var r=t(bt()),n=vt();return Da.default=(0,r.default)((0,n.jsx)("path",{d:"m18 7-1.41-1.41-6.34 6.34 1.41 1.41zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12zM.41 13.41 6 19l1.41-1.41L1.83 12z"}),"DoneAll"),Da}var U0=q0();const si=st(U0);var Ea={},zd;function W0(){if(zd)return Ea;zd=1;var t=yt();Object.defineProperty(Ea,"__esModule",{value:!0}),Ea.default=void 0;var r=t(bt()),n=vt();return Ea.default=(0,r.default)((0,n.jsx)("path",{d:"M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8"}),"AddCircleOutline"),Ea}var F0=W0();const Rn=st(F0);var Ia={},Bd;function $0(){if(Bd)return Ia;Bd=1;var t=yt();Object.defineProperty(Ia,"__esModule",{value:!0}),Ia.default=void 0;var r=t(bt()),n=vt();return Ia.default=(0,r.default)((0,n.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2M4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12m8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8"}),"Block"),Ia}var z0=$0();const B0=st(z0),mh=({open:t,onClose:r,type:n,recordId:a,defaultTo:s,defaultSubject:o,defaultMessage:i,allowMessageEdit:c=!0})=>{const{user:u}=Zt(),[d,p]=l.useState(s||""),[f,m]=l.useState(o||""),[j,v]=l.useState(i||""),[w,_]=l.useState(""),[P,L]=l.useState(!1),[C,D]=l.useState(""),[A,b]=l.useState([]),[N,g]=l.useState("");l.useEffect(()=>{console.log("EmailModal useEffect: open =",t,"defaultTo =",s,"current to =",d),t&&s&&(console.log("Setting to field to:",s),p(s))},[t,s]),l.useEffect(()=>{t&&x()},[t,n]);const x=async()=>{try{const z=await B.get("/api/email/templates");if(z.data.success){const Z=z.data.templates.filter(X=>X.type===n);b(Z);const Q=Z.find(X=>X.is_default);Q?(g(Q.id),m(Q.subject),v(Q.html_content)):Z.length===0&&(n==="quote"?(m("Quote Information"),v("Please find attached the quote details.")):n==="purchase-order"?(m("Purchase Order Information"),v("Please find attached the purchase order details.")):n==="sales-order"&&(m("Sales Order Information"),v("Please find attached the sales order details.")))}}catch(z){console.error("Error loading templates:",z),n==="quote"?(m("Quote Information"),v("Please find attached the quote details.")):n==="purchase-order"?(m("Purchase Order Information"),v("Please find attached the purchase order details.")):n==="sales-order"&&(m("Sales Order Information"),v("Please find attached the sales order details."))}},R=z=>{if(g(z),z!==""){const Z=A.find(Q=>Q.id===z);Z&&(m(Z.subject),v(Z.html_content))}},O=async()=>{if(n==="custom"){if(!d||!f||!j){D("Please fill in all required fields");return}}else if(!d){D("Please enter a recipient email address");return}L(!0),D("");try{let z="/api/email/send",Z={to:d,subject:f,message:j};n!=="custom"&&a&&(z=`/api/email/${n.replace("-","-")}/${a}`,Z={to:d,...w&&{customMessage:w}});const Q=await B.post(z,Z);Q.data.success?(H.success("Email sent successfully!"),r(),p(""),m(""),v(""),_(""),g("")):D(Q.data.message||"Failed to send email")}catch(z){console.error("Error sending email:",z),D(z.response?.data?.message||"Failed to send email")}finally{L(!1)}},ee=()=>{P||(r(),D(""))},J=()=>{switch(n){case"sales-order":return"Send Sales Order Email";case"purchase-order":return"Send Purchase Order Email";case"quote":return"Send Quote Email";default:return"Send Email"}};return e.jsxs(mt,{open:t,onClose:ee,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:J()}),e.jsx(xt,{children:e.jsxs(k,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[n!=="custom"&&A.length>0&&e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Email Template"}),e.jsxs(Wt,{value:N,onChange:z=>R(z.target.value),label:"Email Template",children:[e.jsx(et,{value:"",children:e.jsx("em",{children:"Use default template"})}),A.map(z=>e.jsx(et,{value:z.id,children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1},children:[z.name,z.is_default&&e.jsx(De,{label:"Default",size:"small",color:"secondary"})]})},z.id))]})]}),e.jsx(le,{label:"To",value:d,onChange:z=>p(z.target.value),fullWidth:!0,required:!0,type:"email"}),n==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(le,{label:"Subject",value:f,onChange:z=>m(z.target.value),fullWidth:!0,required:!0}),e.jsx(le,{label:"Message",value:j,onChange:z=>v(z.target.value),fullWidth:!0,multiline:!0,rows:6,required:!0})]}),n!=="custom"&&c&&e.jsx(le,{label:"Additional Message (Optional)",value:w,onChange:z=>_(z.target.value),fullWidth:!0,multiline:!0,rows:4,helperText:"Add a custom message to include with the email"}),C&&e.jsx(We,{severity:"error",sx:{mt:2},children:C})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:ee,disabled:P,children:"Cancel"}),e.jsx(G,{onClick:O,variant:"contained",disabled:P,startIcon:P?e.jsx(it,{size:20}):void 0,children:P?"Sending...":"Send Email"})]})]})},Hd={product_name:""},Jl=({open:t,onClose:r,onSave:n,initialProduct:a,isEditMode:s=!1,loading:o=!1})=>{const[i,c]=l.useState(Hd),[u,d]=l.useState(null),p=wi(i,300);l.useEffect(()=>{t&&(c({...Hd,...a}),d(null))},[t,a]);const f=v=>{const{name:w,value:_}=v.target;c(P=>({...P,[w]:_}))},m=()=>i.product_name.trim()?(d(null),!0):(d("Product name is required"),!1),j=()=>{m()&&n(i)};return l.useEffect(()=>{},[p,t]),e.jsxs(mt,{open:t,onClose:r,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:s?"Edit Product":"Add New Product"}),e.jsxs(xt,{children:[e.jsx(M,{container:!0,spacing:2,sx:{mt:1},children:e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{name:"product_name",label:"Product Name",value:i.product_name,onChange:f,fullWidth:!0,required:!0,autoFocus:!0})})}),u&&e.jsx("div",{style:{color:"red",marginTop:8},children:u})]}),e.jsxs(_t,{children:[e.jsx(G,{onClick:r,children:"Cancel"}),e.jsx(G,{onClick:j,variant:"contained",disabled:o,children:s?"Save Changes":"Add Product"})]})]})},Ii=({when:t,onSave:r})=>{console.log("[UnsavedChangesGuard] Component rendered with when=",t);const[n,a]=l.useState(!1),[s,o]=l.useState(!1),i=l.useRef(""),c=l.useRef(null),u=l.useRef(!1);l.useEffect(()=>{if(!t)return;i.current=window.location.hash,console.log("[UnsavedChangesGuard] activating interceptors. prevHash=",i.current);const m=L=>L.metaKey||L.ctrlKey||L.shiftKey||L.altKey||L.button!==0,j=L=>{let C=L;for(;C&&C!==document.body;){if(C.tagName==="A")return C;C=C.parentElement}return null},v=L=>{if(!t||n)return;const C=j(L.target);if(!C||m(L))return;const D=C.getAttribute("href")||"";if(!D.startsWith("#"))return;const A=D;if(A!==window.location.hash){if(window.__unsavedGuardAllowNext){console.log("[UnsavedChangesGuard] bypass flag set -> allowing click navigation"),window.__unsavedGuardAllowNext=!1,u.current=!0;return}console.log("[UnsavedChangesGuard] click capture -> intercept anchor to",A),L.preventDefault(),L.stopPropagation(),c.current=A,a(!0)}},w=()=>{if(!t)return;if(window.__unsavedGuardAllowNext){console.log("[UnsavedChangesGuard] bypass flag set -> allowing hashchange"),window.__unsavedGuardAllowNext=!1,u.current=!0,i.current=window.location.hash;return}if(u.current){u.current=!1,i.current=window.location.hash,console.log("[UnsavedChangesGuard] hashchange allowed. prevHash ->",i.current);return}if(n)return;const L=window.location.hash;console.log("[UnsavedChangesGuard] hashchange detected -> attempted",L,"reverting to",i.current),c.current=L,a(!0),setTimeout(()=>{window.location.hash!==i.current&&(window.location.hash=i.current)},0)},_=history.pushState,P=history.replaceState;return history.pushState=function(...L){try{const C=L[2],D=typeof C=="string"?C:C?String(C):"",A=D&&D.includes("#")?D.slice(D.indexOf("#")):D;if(window.__unsavedGuardAllowNext)return console.log("[UnsavedChangesGuard] bypass flag set -> allowing pushState",D),window.__unsavedGuardAllowNext=!1,u.current=!0,_.apply(this,L);if(t&&!u.current){console.log("[UnsavedChangesGuard] pushState intercepted ->",D),c.current=A||null,a(!0);return}}catch{}return _.apply(this,L)},history.replaceState=function(...L){try{const C=L[2],D=typeof C=="string"?C:C?String(C):"",A=D&&D.includes("#")?D.slice(D.indexOf("#")):D;if(window.__unsavedGuardAllowNext)return console.log("[UnsavedChangesGuard] bypass flag set -> allowing replaceState",D),window.__unsavedGuardAllowNext=!1,u.current=!0,P.apply(this,L);if(t&&!u.current){console.log("[UnsavedChangesGuard] replaceState intercepted ->",D),c.current=A||null,a(!0);return}}catch{}return P.apply(this,L)},document.addEventListener("click",v,!0),window.addEventListener("hashchange",w),window.addEventListener("popstate",w),()=>{console.log("[UnsavedChangesGuard] deactivating interceptors"),document.removeEventListener("click",v,!0),window.removeEventListener("hashchange",w),window.removeEventListener("popstate",w),history.pushState=_,history.replaceState=P}},[t,n]),l.useEffect(()=>{console.log("[UnsavedChangesGuard] beforeunload useEffect triggered with when=",t);const m=j=>{t&&(console.log("[UnsavedChangesGuard] beforeunload fired"),j.preventDefault(),j.returnValue="")};return t&&(console.log("[UnsavedChangesGuard] registering beforeunload"),window.addEventListener("beforeunload",m)),()=>{console.log("[UnsavedChangesGuard] removing beforeunload listener"),window.removeEventListener("beforeunload",m)}},[t]);const d=()=>{console.log("[UnsavedChangesGuard] user chose: Stay"),a(!1),c.current=null},p=()=>{console.log("[UnsavedChangesGuard] user chose: Leave -> proceeding to",c.current);const m=c.current;a(!1),m&&(u.current=!0,c.current=null,window.location.hash!==m&&(window.location.hash=m))},f=async()=>{if(console.log("[UnsavedChangesGuard] user chose: Save and leave"),!r){p();return}try{o(!0),await r(),p()}catch(m){console.log("[UnsavedChangesGuard] save failed, staying on page",m),o(!1)}finally{o(!1)}};return e.jsxs(mt,{open:n,onClose:d,maxWidth:"xs",fullWidth:!0,children:[e.jsx(ft,{children:"Unsaved Changes"}),e.jsx(xt,{children:e.jsx(h,{variant:"body2",children:"You have unsaved changes. Would you like to save before leaving this page?"})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:d,children:"Cancel"}),e.jsx(G,{onClick:p,color:"warning",children:"Leave without saving"}),e.jsx(G,{onClick:f,variant:"contained",disabled:s,children:s?"Saving":"Save and leave"})]})]})},gn={"& .MuiOutlinedInput-root":{height:56,borderRadius:1},"& .MuiInputBase-input":{py:1.25,fontSize:16}},Kr={fontSize:18,transform:"translate(14px, 18px) scale(1)","&.MuiInputLabel-shrink":{fontSize:14,transform:"translate(14px, -9px) scale(0.9)"}},Cs=t=>t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim().toUpperCase(),H0=t=>{switch(t){case"Approved":return{backgroundColor:"rgba(76, 175, 80, 0.12)",color:"#2e7d32"};case"Rejected":return{backgroundColor:"rgba(244, 67, 54, 0.12)",color:"#c62828"};default:return{backgroundColor:"rgba(33, 150, 243, 0.12)",color:"#1565c0"}}},Y0=(t,r)=>{const n=Cs(r);return n?t.map(s=>{const o=Cs(s.label);let i=-1;return o.startsWith(n)?i=3:o.split(" ").some(c=>c.startsWith(n))?i=2:o.includes(n)&&(i=1),{opt:s,score:i}}).filter(s=>s.score>=0).sort((s,o)=>o.score-s.score||s.opt.label.localeCompare(o.opt.label)).slice(0,8).map(s=>s.opt):t.slice(0,8)},Yd=()=>{const{id:t}=wn(),r=Kt(),a=!!t&&!(t==="new"),[s,o]=l.useState([]),[i,c]=l.useState([]),[u,d]=l.useState(null),[p,f]=l.useState(null),[m,j]=l.useState(null),[v,w]=l.useState($e()),[_,P]=l.useState($e().add(30,"day")),[L,C]=l.useState(null),[D,A]=l.useState(""),[b,N]=l.useState(""),[g,x]=l.useState(""),[R,O]=l.useState(""),[ee,J]=l.useState(""),[z,Z]=l.useState(""),[Q,X]=l.useState(!1),[I,y]=l.useState(null),[S,U]=l.useState(null),[K,E]=l.useState(!1),[V,q]=l.useState(""),[ue,ye]=l.useState(null),[ge,xe]=l.useState(!1),me=l.useRef(null),[he,ae]=l.useState(!1),[T,$]=l.useState(""),[ce,re]=l.useState(null),[Me,Ce]=l.useState(!1),[Ye,Qe]=l.useState(""),[lt,ct]=l.useState(!1),[ut,Ne]=l.useState(""),[tt,Be]=l.useState(!1),[Ct,qt]=l.useState(""),[Bt,Ke]=l.useState(!1),[Yt,Et]=l.useState(!1),zt=l.useCallback(()=>({customer:p?.id||u?.customer_id||null,product:m?.label||u?.product_name||"",quoteDate:v?.toISOString?.()||u?.quote_date||null,validUntil:_?.toISOString?.()||u?.valid_until||null,estimatedCost:L??u?.estimated_cost??null,productDescription:(D||"").trim(),terms:(b||"").trim(),customerPoNumber:(g||"").trim(),vinNumber:(R||"").trim(),vehicleMake:(ee||"").trim(),vehicleModel:(z||"").trim()}),[p,u,m,v,_,L,D,b,g,R,ee,z]);l.useEffect(()=>{if(Bt&&Ct===""){const Pe=JSON.stringify(zt());qt(Pe),console.log("[QuoteEditor] Initial signature set:",Pe)}},[Bt,Ct,zt]);const cr=l.useMemo(()=>JSON.stringify(zt()),[zt]),jr=!!Ct&&Ct!==cr&&!Yt;l.useEffect(()=>{Ct&&console.log("[QuoteEditor] Signature comparison:",{isDirty:jr,initialSignature:Ct.slice(0,100)+"...",currentSignature:cr.slice(0,100)+"...",signaturesMatch:Ct===cr})},[jr,Ct,cr]),l.useEffect(()=>{_e(),be(),a||Ke(!0)},[]),l.useEffect(()=>{!a||!t||(async()=>{try{const Pe=await B.get(`/api/quotes/${t}`),Ie={...Pe.data,status:Za(Pe.data?.status)};d(Ie),f(null),j({label:Ie.product_name}),w($e(Ie.quote_date)),P($e(Ie.valid_until)),C(Number(Ie.estimated_cost??0)),A(Ie.product_description||""),N(Ie.terms||""),x(Ie.customer_po_number||""),O(Ie.vin_number||""),J(Ie.vehicle_make||""),Z(Ie.vehicle_model||""),q(Ie.customer_name||""),$(Ie.product_name||""),Ke(!0)}catch(Pe){console.error("Failed to load quote:",Pe),y("Failed to load quote")}})()},[t,a]),l.useEffect(()=>{if(u&&s.length>0){const Pe=s.find(Ie=>Ie.id===u.customer_id);Pe&&f(Pe)}},[s,u]),l.useEffect(()=>()=>{ue&&window.clearTimeout(ue),ce&&window.clearTimeout(ce)},[ue,ce]);const _e=async()=>{try{const Ie=((await B.get("/api/customers")).data||[]).map(Le=>({label:Le.customer_name,id:Le.customer_id,email:Le.email}));o(Ie)}catch{y("Failed to load customers")}},be=async()=>{try{const Pe=await B.get("/api/products");c((Pe.data||[]).map(Ie=>({label:Ie.product_name,id:Ie.product_id,description:Ie.product_description})))}catch{y("Failed to load products")}},je=Pe=>{const Ie=Cs(Pe);return s.find(Le=>Cs(Le.label)===Ie)||null},pe=async()=>{if(!p||!m||!v||!_||L==null){y("Please fill in all required fields");return}X(!0),Et(!0);try{const Pe={customer_id:p.id,product_name:m.label.trim(),quote_date:v.format("YYYY-MM-DD"),valid_until:_.format("YYYY-MM-DD"),estimated_cost:Number(L),product_description:D,terms:b,customer_po_number:g,vin_number:R,vehicle_make:ee.trim(),vehicle_model:z.trim(),status:u?.status??"Open"};if(a&&u){const Ie=await B.put(`/api/quotes/${u.quote_id}`,Pe);U("Quote updated successfully");const Le=Ie?.data;d(Le?jt=>jt&&{...jt,...Le,status:Za(Le.status??jt.status)}:jt=>jt&&{...jt,...Pe});const nt=JSON.stringify(zt());qt(nt),console.log("[QuoteEditor] Signature reset after save:",nt.slice(0,100)+"..."),setTimeout(()=>{window.__unsavedGuardAllowNext=!0},100)}else{if(window.__quoteCreateInFlight){console.log("[QuoteEditor] Skipping duplicate create (in flight)");return}window.__quoteCreateInFlight=!0;const Ie=await B.post("/api/quotes",Pe);U("Quote created successfully");const Le=Ie?.data??{},nt=Le.quote_id??Le.quoteId??Le.id??Le?.quote?.quote_id;if(nt){const jt={quote_id:nt,quote_number:Le.quote_number||`Q${nt}`,customer_id:p.id,customer_name:p.label,quote_date:Pe.quote_date,valid_until:Pe.valid_until,product_name:Pe.product_name,product_description:Pe.product_description,estimated_cost:Pe.estimated_cost,status:"Open",terms:Pe.terms,customer_po_number:Pe.customer_po_number,vin_number:Pe.vin_number,vehicle_make:Pe.vehicle_make,vehicle_model:Pe.vehicle_model};d(jt),window.__unsavedGuardAllowNext=!0,r(`/quotes/${nt}`,{replace:!0}),qt(JSON.stringify(zt()));return}}}catch(Pe){const Ie=Pe,Le=Ie.response?.data&&typeof Ie.response.data=="object"&&"message"in Ie.response.data?Ie.response.data.message:"Failed to save quote";y(Le)}finally{X(!1),Et(!1),window.__quoteCreateInFlight=!1}},Ee=async()=>{if(u)try{const Pe=await B.get(`/api/quotes/${u.quote_id}/pdf`,{responseType:"blob"}),Ie=window.URL.createObjectURL(new Blob([Pe.data])),Le=document.createElement("a");Le.href=Ie,Le.setAttribute("download",`Quote_${u.quote_number}.pdf`),document.body.appendChild(Le),Le.click(),Le.parentNode?.removeChild(Le),window.URL.revokeObjectURL(Ie),U("PDF downloaded successfully.")}catch{y("Failed to download PDF. Please try again.")}},Fe=()=>{if(!u?.quote_id){y("Please save the quote before emailing.");return}Be(!0)},ze=async()=>{if(!u?.quote_id){y("Please save the quote before converting.");return}X(!0);try{const Pe=await B.post(`/api/quotes/${u.quote_id}/convert-to-sales-order`);U("Quote converted to sales order successfully!");const Ie=Pe?.data?.quote;d(Ie?nt=>nt&&{...nt,...Ie,status:Za(Ie.status??"Approved")}:nt=>nt&&{...nt,status:"Approved"});const Le=Pe.data.salesOrder?.sales_order_id;setTimeout(Le?()=>{r(`/open-sales-orders/${Le}`)}:()=>{r("/open-sales-orders")},1500)}catch(Pe){const Ie=Pe,Le=Ie.response?.data&&typeof Ie.response.data=="object"&&"message"in Ie.response.data?Ie.response.data.message:"Failed to convert quote to sales order";y(Le)}finally{X(!1)}},Ze=Pe=>{const Ie=V.trim(),Le=Pe.key==="Enter",nt=Pe.key==="Tab",jt=Pe.key==="Escape",er=Pe.key==="ArrowDown"||Pe.key==="ArrowUp";if(jt){E(!1);return}if(!er&&(Le||nt)){if(Le&&Pe.ctrlKey&&Ie){Pe.preventDefault(),xe(!0),Qe(Ie),Ce(!0);return}const Er=je(Ie);if(K||!Ie)return;Pe.preventDefault(),Er?(f(Er),q(Er.label)):(xe(!0),Qe(Ie),Ce(!0))}},ot=Pe=>{if(Pe.key==="Enter"){Pe.preventDefault();const Ie=T.trim();if(!Ie)return;const Le=i.find(nt=>nt.label.toLowerCase()===Ie.toLowerCase());Le?(j(Le),$(Le.label)):(Ne(Ie),ct(!0))}},St=a&&u?`Edit Quote: ${u.quote_number}`:a?"Edit Quote":"New Quote",Ht=u?u.status:"Open",dr=Ht==="Approved",dn=Ht==="Rejected",Sn=async()=>{if(!u?.quote_id){y("Please save the quote before rejecting.");return}if(window.confirm("Are you sure you want to mark this quote as rejected?")){X(!0);try{const Pe=await B.post(`/api/quotes/${u.quote_id}/reject`),Ie=Pe?.data?.quote??Pe?.data;d(Ie?Le=>Le&&{...Le,...Ie,status:Za(Ie.status??"Rejected")}:Le=>Le&&{...Le,status:"Rejected"}),U("Quote marked as rejected.")}catch(Pe){const Ie=Pe,Le=Ie.response?.data&&typeof Ie.response.data=="object"&&"message"in Ie.response.data?Ie.response.data.message:"Failed to reject quote";y(Le)}finally{X(!1)}}};return e.jsxs(_n,{dateAdapter:ss,children:[e.jsx(Ii,{when:jr,onSave:pe}),e.jsxs(at,{maxWidth:"lg",sx:{mt:4,mb:4,px:{xs:2,sm:3}},children:[e.jsxs(k,{sx:{maxWidth:1e3,mx:"auto",mb:3,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(ke,{direction:"row",spacing:1.5,alignItems:"center",children:[e.jsx(h,{variant:"h5",sx:{fontWeight:700},children:St}),a&&u&&e.jsx(De,{label:Ht,sx:{fontWeight:600,...H0(Ht)}})]}),e.jsxs(ke,{direction:"row",spacing:1.25,children:[e.jsx(G,{variant:"contained",color:"primary",startIcon:e.jsx(as,{}),onClick:pe,disabled:Q,children:a?"SAVE CHANGES":"CREATE QUOTE"}),a&&u&&e.jsxs(e.Fragment,{children:[e.jsx(G,{variant:"contained",color:"primary",startIcon:e.jsx(si,{}),onClick:ze,disabled:Q||dr||dn,children:"CONVERT TO SO"}),e.jsx(G,{variant:"contained",color:"error",startIcon:e.jsx(B0,{}),onClick:Sn,disabled:Q||dr||dn,children:"MARK REJECTED"}),e.jsx(G,{variant:"contained",color:"primary",startIcon:e.jsx(yr,{}),onClick:Ee,children:"DOWNLOAD PDF"}),e.jsx(G,{variant:"contained",startIcon:e.jsx(bi,{}),sx:{backgroundColor:"#ff9800","&:hover":{backgroundColor:"#f57c00"}},onClick:Fe,children:"EMAIL QUOTE"})]})]})]}),e.jsx(k,{sx:{maxWidth:1e3,mx:"auto",mt:1.5},children:e.jsx(Ae,{sx:{p:3,backgroundColor:"#fff"},elevation:3,children:e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,md:4,children:e.jsx($r,{open:K,onOpen:()=>E(!0),onClose:()=>E(!1),autoHighlight:!0,options:s,value:p,onChange:(Pe,Ie)=>{if(ge){xe(!1);return}Ie&&Ie.isNew?(Ce(!0),Qe(V),f(null),q("")):f(Ie)},filterOptions:(Pe,Ie)=>{const Le=Y0(Pe,Ie.inputValue||""),nt=!!(Ie.inputValue&&s.some(er=>Cs(er.label)===Cs(Ie.inputValue))),jt=[...Le];return(Ie.inputValue||"").trim()!==""&&!nt&&jt.push({label:`Add "${Ie.inputValue}" as New Customer`,isNew:!0}),Le.length===0&&(Ie.inputValue||"").trim()!==""&&!nt,jt},inputValue:V,onInputChange:(Pe,Ie,Le)=>{if(q(Ie),ue&&window.clearTimeout(ue),Le==="reset")return;if(Ie.trim().length>0){const jt=window.setTimeout(()=>E(!0),180);ye(jt)}else E(!1)},getOptionLabel:Pe=>typeof Pe=="string"?Pe:Pe.label,isOptionEqualToValue:(Pe,Ie)=>Pe.id===Ie?.id,renderOption:(Pe,Ie)=>{const Le=Ie.isNew,{key:nt,...jt}=Pe;return e.jsxs("li",{...jt,style:{display:"flex",alignItems:"center",opacity:Le?.9:1},children:[Le&&e.jsx(Rn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),e.jsx("span",{children:Ie.label})]},nt)},renderInput:Pe=>{const Ie=!!Pe.inputProps?.value,Le=!!p||Ie;return e.jsx(le,{...Pe,label:"Customer",fullWidth:!0,required:!0,onKeyDown:Ze,onBlur:()=>{if(!p){const nt=V.trim();if(nt){const jt=je(nt);jt&&(f(jt),q(jt.label))}}},inputRef:nt=>{me.current=nt},sx:gn,InputLabelProps:{...Pe.InputLabelProps,sx:Kr,shrink:Le}})}})}),e.jsx(M,{item:!0,xs:12,md:4,children:e.jsx(le,{label:"Customer PO #",fullWidth:!0,value:g,onChange:Pe=>x(Pe.target.value),sx:gn,InputLabelProps:{sx:Kr}})}),e.jsx(M,{item:!0,xs:12,md:4,children:e.jsx(le,{label:"Estimated Price",type:"number",value:L??"",onChange:Pe=>C(Pe.target.value===""?null:parseFloat(Pe.target.value)),fullWidth:!0,required:!0,InputProps:{startAdornment:e.jsx(pr,{position:"start",children:"$"})},inputProps:{step:"0.01",onWheel:Pe=>Pe.currentTarget.blur()},sx:gn,InputLabelProps:{sx:Kr}})}),e.jsx(M,{item:!0,xs:12,md:6,children:e.jsx($r,{disablePortal:!0,open:he,onOpen:()=>ae(!0),onClose:()=>ae(!1),autoHighlight:!0,options:i,value:m,onChange:(Pe,Ie)=>{if(Ie&&Ie.isNew){const Le=Ie.inputValue?.toString?.()||T.trim();ct(!0),Ne(Le),j(null),$(""),ae(!1)}else j(Ie),ae(!1)},filterOptions:(Pe,Ie)=>{const Le=Pe.filter(nt=>nt.label.toLowerCase().includes(Ie.inputValue.toLowerCase()));return Ie.inputValue!==""&&!Pe.some(nt=>nt.label.toLowerCase()===Ie.inputValue.toLowerCase())&&Le.push({label:`Add "${Ie.inputValue}"`,isNew:!0,inputValue:Ie.inputValue}),Le},inputValue:T,onInputChange:(Pe,Ie,Le)=>{if($(Ie),Ne(Ie),ce&&window.clearTimeout(ce),Le==="reset")return;if(Ie.trim().length>0){const jt=window.setTimeout(()=>ae(!0),180);re(jt)}else ae(!1)},getOptionLabel:Pe=>typeof Pe=="string"?Pe:Pe.label,isOptionEqualToValue:(Pe,Ie)=>Pe.id===Ie?.id,renderInput:Pe=>{const Ie=!!Pe.inputProps?.value,Le=!!m||Ie;return e.jsx(le,{...Pe,label:"Product",fullWidth:!0,required:!0,onKeyDown:ot,onBlur:()=>{if(!m){const nt=T.trim();if(nt){const jt=i.find(er=>er.label.toLowerCase()===nt.toLowerCase());jt&&(j(jt),$(jt.label))}}},sx:gn,InputLabelProps:{...Pe.InputLabelProps,sx:Kr,shrink:Le}})}})}),e.jsx(M,{item:!0,xs:12,md:6,children:e.jsx(le,{label:"VIN #",fullWidth:!0,value:R,onChange:Pe=>O(Pe.target.value),sx:gn,InputLabelProps:{sx:Kr},error:R.length>0&&R.length!==17,helperText:R.length>0&&R.length!==17?"VIN must be 17 characters":""})}),e.jsx(M,{item:!0,xs:12,md:6,children:e.jsx(le,{label:"Make",fullWidth:!0,value:ee,onChange:Pe=>J(Pe.target.value),sx:gn,InputLabelProps:{sx:Kr}})}),e.jsx(M,{item:!0,xs:12,md:6,children:e.jsx(le,{label:"Model",fullWidth:!0,value:z,onChange:Pe=>Z(Pe.target.value),sx:gn,InputLabelProps:{sx:Kr}})}),e.jsx(M,{item:!0,xs:12,md:6,children:e.jsx(Ln,{label:"Quote Date",value:v,onChange:Pe=>w(Pe),slotProps:{textField:{fullWidth:!0,sx:gn,InputLabelProps:{sx:Kr}}}})}),e.jsx(M,{item:!0,xs:12,md:6,children:e.jsx(Ln,{label:"Valid Until",value:_,onChange:Pe=>P(Pe),slotProps:{textField:{fullWidth:!0,sx:gn,InputLabelProps:{sx:Kr}}}})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Product Description",fullWidth:!0,multiline:!0,minRows:6,value:D,onChange:Pe=>A(Pe.target.value),sx:{"& .MuiOutlinedInput-root":{borderRadius:1},"& .MuiOutlinedInput-input":{fontSize:15}},InputLabelProps:{sx:Kr,shrink:!0}})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Terms and Conditions",fullWidth:!0,multiline:!0,minRows:4,value:b,onChange:Pe=>N(Pe.target.value),sx:{"& .MuiOutlinedInput-root":{borderRadius:1},"& .MuiOutlinedInput-input":{fontSize:15}},InputLabelProps:{sx:Kr,shrink:!0}})})]})})}),e.jsx(mh,{open:tt,onClose:()=>Be(!1),type:"quote",recordId:u?.quote_id,defaultTo:p?.email||"",allowMessageEdit:!0}),e.jsx(Si,{open:Me,onClose:()=>Ce(!1),onSave:async Pe=>{try{const Le=(await B.post("/api/customers",Pe)).data,nt={label:Le.customer_name,id:Le.customer_id,email:Le.email||Pe.email};o(jt=>[...jt,nt]),f(nt),Ce(!1),q(nt.label)}catch{y("Failed to add customer")}},initialCustomer:{customer_name:Ye},isEditMode:!1}),e.jsx(Jl,{open:lt,onClose:()=>ct(!1),onSave:async Pe=>{try{const Ie=await B.post("/api/products",Pe),Le={label:Pe.product_name,id:Ie.data.product_id,description:Pe.product_name};c(nt=>[...nt,Le]),j(Le),$(Le.label),ct(!1),Ne("")}catch{y("Failed to add product.")}},initialProduct:{product_name:ut||T},isEditMode:!1}),e.jsx(bn,{open:!!S,autoHideDuration:6e3,onClose:()=>U(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(We,{onClose:()=>U(null),severity:"success",sx:{width:"100%"},children:S})}),e.jsx(bn,{open:!!I,autoHideDuration:6e3,onClose:()=>y(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(We,{onClose:()=>y(null),severity:"error",sx:{width:"100%"},children:I})})]})]})},V0=({conversations:t,activeConversationId:r,onSelect:n,onStartConversation:a,isLoading:s=!1,unreadConversationIds:o})=>{const[i,c]=l.useState(""),u=l.useMemo(()=>new Set(o??[]),[o]),d=l.useMemo(()=>{const p=i.trim().toLowerCase();return p?t.filter(f=>{const m=f.displayName.toLowerCase(),j=f.participantNames.toLowerCase();return m.includes(p)||j.includes(p)}):t},[t,i]);return e.jsxs(k,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[e.jsxs(ke,{direction:"row",alignItems:"center",justifyContent:"space-between",spacing:2,sx:{mb:2},children:[e.jsx(h,{variant:"h6",component:"h2",children:"Conversations"}),e.jsx(G,{variant:"contained",startIcon:e.jsx(ci,{}),onClick:a,size:"small",children:"New"})]}),e.jsx(le,{fullWidth:!0,size:"small",placeholder:"Search conversations",value:i,onChange:p=>c(p.target.value),sx:{mb:2}}),e.jsx(xr,{}),e.jsx(k,{sx:{flexGrow:1,overflowY:"auto"},children:s?e.jsx(k,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",py:4},children:e.jsx(it,{size:32})}):d.length===0?e.jsx(k,{sx:{textAlign:"center",py:6,px:2},children:e.jsx(h,{variant:"body2",color:"text.secondary",children:i?"No conversations match your search.":"Start a new conversation to begin messaging."})}):e.jsx(Pr,{disablePadding:!0,children:d.map(p=>{const f=p.lastMessage?.content,m=p.lastMessageAt||p.updatedAt||p.createdAt,j=J_(new Date(m),{addSuffix:!0}),v=u.has(p.id);return e.jsxs(It.Fragment,{children:[e.jsxs(Bh,{selected:p.id===r,alignItems:"flex-start",onClick:()=>n(p.id),sx:{py:1.5,"&.Mui-selected":{backgroundColor:"action.selected"},bgcolor:v?"action.hover":void 0,"& .MuiListItemText-secondary":{display:"-webkit-box",overflow:"hidden",WebkitBoxOrient:"vertical",WebkitLineClamp:2}},children:[e.jsx(Hh,{children:e.jsx(Nn,{children:p.displayName.charAt(0).toUpperCase()})}),e.jsx(fr,{primary:e.jsxs(ke,{direction:"row",alignItems:"center",justifyContent:"space-between",spacing:1,children:[e.jsx(h,{variant:"subtitle1",noWrap:!0,sx:{fontWeight:v?600:500},children:p.displayName}),e.jsxs(ke,{direction:"row",alignItems:"center",spacing:1.25,sx:{flexShrink:0},children:[v&&e.jsx(k,{component:"span",sx:{width:8,height:8,borderRadius:"50%",bgcolor:"primary.main"}}),e.jsx(h,{variant:"caption",color:"text.secondary",children:j})]})]}),secondaryTypographyProps:{fontWeight:v?600:void 0},secondary:f||"No messages yet"})]}),e.jsx(xr,{component:"li"})]},p.id)})})})]})};var Ta={},Vd;function G0(){if(Vd)return Ta;Vd=1;var t=yt();Object.defineProperty(Ta,"__esModule",{value:!0}),Ta.default=void 0;var r=t(bt()),n=vt();return Ta.default=(0,r.default)((0,n.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM8 9h8v10H8zm7.5-5-1-1h-5l-1 1H5v2h14V4z"}),"DeleteOutlineOutlined"),Ta}var Q0=G0();const K0=st(Q0),J0=t=>{try{return Ss(new Date(t),"MMM d, yyyy h:mm a")}catch{return t}},X0=({conversation:t,messages:r,currentUserId:n,isLoading:a,isSending:s,onSendMessage:o,onDeleteMessage:i})=>{const c=l.useRef(null);l.useEffect(()=>{const d=c.current;d&&(d.scrollTop=d.scrollHeight)},[r.length,a]);const u=l.useMemo(()=>t?t.otherParticipants.length>0?t.otherParticipants.map(d=>d.username||d.email||"Unknown user").join(", "):t.participantNames:"",[t]);return t?e.jsxs(Ae,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[e.jsxs(k,{sx:{p:2},children:[e.jsx(h,{variant:"h6",component:"h2",children:t.displayName}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:u})]}),e.jsx(xr,{}),e.jsx(k,{ref:c,sx:{flexGrow:1,overflowY:"auto",p:2},children:a?e.jsx(k,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(it,{size:36})}):r.length===0?e.jsx(k,{sx:{textAlign:"center",color:"text.secondary",mt:6},children:e.jsx(h,{variant:"body2",children:"No messages yet. Start the conversation below."})}):e.jsx(ke,{spacing:2,children:r.map(d=>{const p=n!==null&&d.senderId===n,f=!!d.isDeletedForUser,m=p?"flex-end":"flex-start",j=d.error?"error.light":f?"grey.300":p?"primary.main":"grey.100",v=d.error?"error.dark":f?"text.secondary":p?"common.white":"text.primary",w=!f&&!d.error&&!d.pending&&typeof d.id=="number",_=f?p?"You deleted this message":"Message deleted":d.content;return e.jsx(k,{sx:{display:"flex",justifyContent:m},children:e.jsxs(k,{sx:{maxWidth:"75%",display:"flex",flexDirection:"column",gap:.5},children:[e.jsxs(Ae,{elevation:p?3:1,sx:{p:1.5,bgcolor:j,color:v,borderRadius:2,border:d.error?"1px solid":"none",borderColor:d.error?"error.main":void 0,position:"relative"},children:[e.jsxs(ke,{spacing:.5,children:[e.jsx(h,{variant:"caption",sx:{opacity:p?.85:.6},children:d.senderName||(p?"You":"Unknown user")}),e.jsx(h,{variant:"body2",sx:{whiteSpace:"pre-wrap",fontStyle:f?"italic":"normal"},children:_}),e.jsx(h,{variant:"caption",sx:{opacity:p?.85:.6,textAlign:"right"},children:J0(d.createdAt)})]}),w&&e.jsx(Vt,{title:"Delete for me",children:e.jsx(gt,{size:"small",onClick:()=>i(Number(d.id)),sx:{position:"absolute",top:4,right:4,color:p?"common.white":"text.secondary",bgcolor:p?"rgba(255,255,255,0.1)":"transparent","&:hover":{bgcolor:p?"rgba(255,255,255,0.2)":"rgba(0,0,0,0.04)"}},children:e.jsx(K0,{fontSize:"inherit"})})})]}),d.pending&&!d.error&&e.jsx(De,{label:"Sending...",size:"small",color:"default",sx:{alignSelf:p?"flex-end":"flex-start",mt:.5}}),d.error&&e.jsx(h,{variant:"caption",color:"error",sx:{alignSelf:p?"flex-end":"flex-start"},children:"Failed to send. Please try again."})]})},d.id)})})}),e.jsx(xr,{}),e.jsx(Op,{onSendMessage:d=>o(d),disabled:s})]}):e.jsx(Ae,{sx:{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",p:4},children:e.jsx(h,{variant:"body1",color:"text.secondary",align:"center",children:"Select a conversation to view messages or start a new chat."})})},Z0=()=>{const{user:t}=Zt(),r=t?Number(t.id):null,{conversations:n,isLoadingConversations:a,activeConversationId:s,selectConversation:o,messagesByConversation:i,isLoadingMessages:c,sendMessage:u,createConversation:d,loadMessages:p,deleteMessage:f,unreadConversationIds:m}=Ip(),[j,v]=l.useState([]),[w,_]=l.useState(!1),[P,L]=l.useState(!1),[C,D]=l.useState([]),[A,b]=l.useState(""),[N,g]=l.useState(!1),[x,R]=l.useState(!1);l.useEffect(()=>{let S=!0;return(async()=>{try{_(!0);const K=await B.get("/api/employees");if(!S)return;const V=(Array.isArray(K.data)?K.data:[]).map(q=>({id:Number(q.id),username:q.username??null,email:q.email??null,access_role:q.access_role})).filter(q=>q.id!==r).sort((q,ue)=>{const ye=(q.username||q.email||"").toLowerCase(),ge=(ue.username||ue.email||"").toLowerCase();return ye.localeCompare(ge)});v(V)}catch(K){console.error("Failed to load employees",K),H.error("Unable to load team members.")}finally{S&&_(!1)}})(),()=>{S=!1}},[r]);const O=l.useMemo(()=>n.find(S=>S.id===s),[s,n]),ee=s?i[s]??[]:[],J=s?!!c[s]:!1,z=()=>{D([]),b(""),L(!0)},Z=()=>{N||L(!1)},Q=async()=>{if(C.length===0){H.error("Select at least one teammate to start a conversation.");return}const S=C.map(K=>K.id),U=S.length>1?"group":"direct";if(U==="group"&&!A.trim()){H.error("Enter a name for the group conversation.");return}try{g(!0);const K=await d({participantIds:S,title:U==="group"?A.trim():void 0,type:U}),{conversation:E,created:V}=K;H.success(V?"Conversation created successfully.":"Conversation already existed. Opening chat."),L(!1),D([]),b(""),await p(E.id,{force:!0})}catch(K){console.error("Failed to create conversation",K),H.error("Unable to start conversation. Please try again.")}finally{g(!1)}},X=async S=>{if(!s){H.error("Select a conversation before sending a message.");return}try{R(!0),await u(s,S)}catch(U){console.error("Failed to send message",U),H.error("Failed to send message. Please try again.")}finally{R(!1)}},I=async S=>{if(!s){H.error("Select a conversation before deleting a message.");return}try{await f(s,S),H.info("Message deleted for you.")}catch(U){console.error("Failed to delete message",U),H.error("Unable to delete message. Please try again.")}},y=l.useMemo(()=>j,[j]);return e.jsxs(k,{sx:{display:"flex",flexDirection:"column",height:"100%",p:{xs:2,md:3},gap:3},children:[e.jsxs(ke,{spacing:1,children:[e.jsx(h,{variant:"h4",component:"h1",children:"Messaging"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Collaborate with your team using direct messages and group chats."})]}),e.jsxs(Ae,{elevation:0,sx:{flexGrow:1,minHeight:{xs:480,md:540},display:"flex",flexDirection:{xs:"column",md:"row"},borderRadius:3,overflow:"hidden",border:"1px solid",borderColor:"divider",backgroundColor:"background.paper"},children:[e.jsx(k,{sx:{width:{xs:"100%",md:340},flexShrink:0,borderRight:{md:"1px solid",xs:"none"},borderColor:"divider",backgroundColor:"background.default"},children:e.jsx(k,{sx:{height:"100%",p:{xs:2,md:2.5}},children:e.jsx(V0,{conversations:n,activeConversationId:s,onSelect:o,onStartConversation:z,isLoading:a,unreadConversationIds:m})})}),e.jsx(xr,{orientation:"vertical",flexItem:!0,sx:{display:{xs:"none",md:"block"}}}),e.jsx(k,{sx:{flex:1,p:{xs:2,md:2.5},display:"flex",flexDirection:"column",backgroundColor:"background.paper"},children:e.jsx(X0,{conversation:O,messages:ee,currentUserId:r,isLoading:J,isSending:x,onSendMessage:X,onDeleteMessage:I})})]}),e.jsxs(mt,{open:P,onClose:Z,fullWidth:!0,maxWidth:"sm",children:[e.jsx(ft,{children:"Start a Conversation"}),e.jsx(xt,{dividers:!0,children:e.jsxs(ke,{spacing:2,sx:{mt:1},children:[e.jsx($r,{multiple:!0,options:y,value:C,onChange:(S,U)=>D(U),getOptionLabel:S=>S.username||S.email||`User ${S.id}`,renderOption:(S,U)=>l.createElement("li",{...S,key:U.id},e.jsxs(ke,{spacing:.25,children:[e.jsx(h,{variant:"body2",children:U.username||U.email||`User ${U.id}`}),U.email&&e.jsx(h,{variant:"caption",color:"text.secondary",children:U.email})]})),filterSelectedOptions:!0,renderInput:S=>e.jsx(le,{...S,label:"Participants",placeholder:"Select team members",helperText:"Choose one teammate for a direct chat or multiple for a group conversation."}),loading:w,loadingText:"Loading team members..."}),C.length>1&&e.jsx(le,{label:"Group name",value:A,onChange:S=>b(S.target.value),placeholder:"e.g., Operations Leads",inputProps:{maxLength:80}})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:Z,disabled:N,children:"Cancel"}),e.jsx(G,{variant:"contained",onClick:Q,disabled:N||C.length===0||C.length>1&&!A.trim(),children:N?"Creating":"Start"})]})]})]})},ew=async()=>(await B.get("/api/employees")).data,Gd=["Admin","Sales and Purchase","Time Tracking","Mobile Time Tracker"],tw=()=>{const[t,r]=l.useState(""),[n,a]=l.useState(""),[s,o]=l.useState(""),[i,c]=l.useState(""),[u,d]=l.useState("Employee"),[p,f]=l.useState(null),[m,j]=l.useState(null),[v,w]=l.useState([]),[_,P]=l.useState(!0);Kt();const[L,C]=l.useState(null),[D,A]=l.useState(""),[b,N]=l.useState(""),[g,x]=l.useState(""),[R,O]=l.useState(!1);l.useEffect(()=>{ee()},[]);const ee=async()=>{P(!0);try{const I=await ew();w(I)}catch{f("Failed to fetch employees.")}finally{P(!1)}},J=async I=>{if(I.preventDefault(),f(null),j(null),s!==i){f("Passwords do not match");return}try{const y=await B.post("/api/employees",{username:t,email:n,password:s,access_role:u});j(y.data.message),r(""),a(""),o(""),c(""),d("Employee"),ee()}catch(y){y instanceof kr?f(y.response?.data?.message||"Employee registration failed"):f("An unexpected error occurred")}},z=async I=>{if(window.confirm("Are you sure you want to delete this employee?"))try{await B.delete(`/api/employees/${I}`),j("Employee deleted successfully"),ee()}catch(y){console.error("Error deleting employee:",y),y instanceof kr?f(y.response?.data?.message||"Failed to delete employee"):f("An unexpected error occurred")}},Z=I=>{C(I),A(I.username),N(I.access_role),x(""),O(!0)},Q=()=>{O(!1),C(null),f(null),j(null)},X=async()=>{if(L){f(null),j(null);try{const I={username:D,access_role:b};g&&(I.password=g);const y=await B.put(`/api/employees/${L.id}`,I);j(y.data.message||"Employee updated successfully"),ee(),Q()}catch(I){console.error("Error updating employee:",I),I instanceof kr?f(I.response?.data?.message||"Failed to update employee"):f("An unexpected error occurred")}}};return _?e.jsxs(at,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(it,{}),e.jsx(h,{children:"Loading employees..."})]}):e.jsxs(at,{component:"main",maxWidth:"md",children:[e.jsxs(k,{sx:{marginTop:8,display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs(Ae,{elevation:6,sx:{p:4,width:"100%",borderRadius:2,mb:4},children:[e.jsx(h,{component:"h1",variant:"h5",sx:{mb:3,textAlign:"center"},children:"Register New Employee"}),e.jsxs(k,{component:"form",onSubmit:J,noValidate:!0,sx:{mt:1},children:[e.jsx(le,{margin:"normal",required:!0,fullWidth:!0,id:"username",label:"Username",name:"username",autoComplete:"new-username",value:t,onChange:I=>r(I.target.value)}),e.jsx(le,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"new-email",value:n,onChange:I=>a(I.target.value)}),e.jsx(le,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Initial Password",type:"password",id:"password",autoComplete:"new-password",value:s,onChange:I=>o(I.target.value)}),e.jsx(le,{margin:"normal",required:!0,fullWidth:!0,name:"confirmPassword",label:"Confirm Initial Password",type:"password",id:"confirmPassword",autoComplete:"new-password",value:i,onChange:I=>c(I.target.value)}),e.jsxs(Mt,{fullWidth:!0,margin:"normal",children:[e.jsx(Ut,{id:"access-role-label",children:"Access Role"}),e.jsx(Wt,{labelId:"access-role-label",id:"access-role",value:u,label:"Access Role",onChange:I=>d(I.target.value),children:Gd.map(I=>e.jsx(et,{value:I,children:I},I))})]}),e.jsx(G,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2},children:"Register Employee"}),p&&e.jsx(We,{severity:"error",sx:{mt:2},children:p}),m&&e.jsx(We,{severity:"success",sx:{mt:2},children:m})]})]}),e.jsxs(Ae,{elevation:6,sx:{p:4,width:"100%",borderRadius:2},children:[e.jsx(h,{component:"h2",variant:"h5",sx:{mb:3,textAlign:"center"},children:"Existing Employees"}),e.jsx(Pr,{children:v.map(I=>e.jsx(Mr,{secondaryAction:e.jsxs(k,{children:[e.jsx(gt,{edge:"end","aria-label":"edit",onClick:()=>Z(I),sx:{mr:1},children:e.jsx(As,{})}),e.jsx(gt,{edge:"end","aria-label":"delete",onClick:()=>z(I.id),children:e.jsx(gr,{})})]}),children:e.jsx(fr,{primary:I.username,secondary:`Email: ${I.email} | Role: ${I.role} | Access: ${I.access_role}`})},I.id))})]})]}),e.jsxs(mt,{open:R,onClose:Q,children:[e.jsx(ft,{children:"Edit Employee Roles"}),e.jsxs(xt,{children:[L&&e.jsxs(k,{component:"form",noValidate:!0,sx:{mt:1},children:[e.jsx(le,{margin:"normal",fullWidth:!0,id:"edit-username",label:"Username",value:D,onChange:I=>A(I.target.value),variant:"standard"}),e.jsx(le,{margin:"normal",fullWidth:!0,id:"edit-email",label:"Email",value:L.email,InputProps:{readOnly:!0,disableUnderline:!0},variant:"standard"}),e.jsx(le,{margin:"normal",fullWidth:!0,id:"edit-password",label:"New Password (leave blank to keep current)",type:"password",value:g,onChange:I=>x(I.target.value),variant:"standard"}),e.jsxs(Mt,{fullWidth:!0,margin:"normal",children:[e.jsx(Ut,{id:"edit-access-role-label",children:"Access Role"}),e.jsx(Wt,{labelId:"edit-access-role-label",id:"edit-access-role",value:b,label:"Access Role",onChange:I=>N(I.target.value),children:Gd.map(I=>e.jsx(et,{value:I,children:I},I))})]})]}),p&&e.jsx(We,{severity:"error",sx:{mt:2},children:p}),m&&e.jsx(We,{severity:"success",sx:{mt:2},children:m})]}),e.jsxs(_t,{children:[e.jsx(G,{onClick:Q,children:"Cancel"}),e.jsx(G,{onClick:X,variant:"contained",color:"primary",children:"Save Changes"})]})]})]})},rw=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(""),[s,o]=l.useState([]),[i,c]=l.useState(!1),[u,d]=l.useState(!1),[p,f]=l.useState(null),[m,j]=l.useState(""),[v,w]=l.useState(!1),[_,P]=l.useState(!1),[L,C]=l.useState(null),[D,A]=l.useState([]),[b,N]=l.useState([]),[g,x]=l.useState("admin");l.useEffect(()=>{R()},[]),l.useEffect(()=>{g==="admin"?ee():n?O(n):o([])},[n,g]);const R=async()=>{try{const y=await B.get("/api/profile-documents/profiles");r(y.data)}catch(y){console.error("Error fetching profiles:",y),H.error("Failed to fetch profiles")}},O=async y=>{c(!0);try{const S=await B.get(`/api/profile-documents/profile/${y}`);o(S.data)}catch(S){console.error("Error fetching documents:",S),H.error("Failed to fetch documents")}finally{c(!1)}},ee=async()=>{c(!0);try{const S=(await B.get("/api/profile-documents/all")).data.reduce((K,E)=>{const V=E.id;return K[V]||(K[V]={id:E.id,filename:E.filename,original_filename:E.original_filename,file_size:E.file_size,mime_type:E.mime_type,uploaded_by:E.uploaded_by,uploaded_by_name:E.uploaded_by_name,created_at:E.created_at,visible_to_profiles:[],profile_read_status:{},profile_details:[]}),K[V].visible_to_profiles.push(E.profile_id),K[V].profile_read_status[E.profile_id]=E.has_read,K[V].profile_details.push({profile_id:E.profile_id,profile_name:E.profile_name,has_read:E.has_read,read_at:E.read_at}),K},{}),U=Object.values(S);console.log("Grouped documents:",U),o(U)}catch(y){console.error("Error fetching all documents:",y),H.error("Failed to fetch documents")}finally{c(!1)}},J=y=>{const S=y.target.files?.[0];S&&(f(S),m||j(S.name))},z=async()=>{if(!p||b.length===0){H.error("Please select a file and at least one profile");return}w(!0);try{const y=new FormData;y.append("document",p),y.append("customName",m),y.append("visibleToProfiles",JSON.stringify(b)),(await B.post("/api/profile-documents/upload",y,{headers:{"Content-Type":"multipart/form-data"}})).data.success&&(H.success("Document uploaded successfully"),d(!1),f(null),j(""),N([]),g==="admin"?ee():n&&O(n))}catch(y){console.error("Error uploading document:",y),H.error(y.response?.data?.error||"Failed to upload document")}finally{w(!1)}},Z=async y=>{if(window.confirm("Are you sure you want to delete this document?"))try{await B.delete(`/api/profile-documents/${y}`),H.success("Document deleted successfully"),g==="admin"?ee():n&&O(n)}catch(S){console.error("Error deleting document:",S),H.error("Failed to delete document")}},Q=async y=>{C(y),P(!0);try{const S=await B.get(`/api/profile-documents/${y.id}/stats`);A(S.data)}catch(S){console.error("Error fetching document stats:",S),H.error("Failed to fetch document statistics")}},X=y=>{if(y===0)return"0 Bytes";const S=1024,U=["Bytes","KB","MB","GB"],K=Math.floor(Math.log(y)/Math.log(S));return parseFloat((y/Math.pow(S,K)).toFixed(2))+" "+U[K]},I=y=>new Date(y).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return e.jsxs(k,{p:3,children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsx(h,{variant:"h4",component:"h1",children:"Profile Documents Management"}),e.jsxs(k,{display:"flex",gap:2,alignItems:"center",children:[e.jsxs(Mt,{size:"small",sx:{minWidth:120},children:[e.jsx(Ut,{children:"View Mode"}),e.jsxs(Wt,{value:g,onChange:y=>x(y.target.value),label:"View Mode",children:[e.jsx(et,{value:"admin",children:"Admin View"}),e.jsx(et,{value:"profile",children:"Profile View"})]})]}),e.jsx(G,{variant:"contained",startIcon:e.jsx(ci,{}),onClick:()=>d(!0),disabled:g==="profile"&&!n,children:"Upload Document"})]})]}),e.jsxs(M,{container:!0,spacing:3,children:[g==="profile"&&e.jsx(M,{item:!0,xs:12,md:4,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Select Profile"}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Profile"}),e.jsx(Wt,{value:n,onChange:y=>a(y.target.value),label:"Profile",children:t.map(y=>e.jsx(et,{value:y.id,children:y.name},y.id))})]}),n&&e.jsx(k,{mt:2,children:e.jsx(h,{variant:"body2",color:"text.secondary",children:t.find(y=>y.id===n)?.email})})]})})}),e.jsx(M,{item:!0,xs:12,md:g==="profile"?8:12,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsxs(h,{variant:"h6",gutterBottom:!0,children:["Documents",e.jsx(De,{label:`${s.length} documents`,size:"small",sx:{ml:2}})]}),g==="profile"&&!n?e.jsx(We,{severity:"info",children:"Please select a profile to view documents."}):i?e.jsx(k,{display:"flex",justifyContent:"center",p:3,children:e.jsx(it,{})}):s.length===0?e.jsx(We,{severity:"info",children:g==="admin"?"No documents found.":"No documents found for this profile."}):e.jsx(lr,{children:e.jsxs(nr,{size:"small",children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Document Name"}),e.jsx(ne,{align:"center",children:"Size"}),e.jsx(ne,{align:"center",children:"Type"}),g==="admin"?e.jsxs(e.Fragment,{children:[e.jsx(ne,{align:"center",children:"Visible To"}),e.jsx(ne,{align:"center",children:"Read Status"})]}):e.jsx(ne,{align:"center",children:"Read Status"}),e.jsx(ne,{align:"center",children:"Uploaded"}),e.jsx(ne,{align:"center",children:"Actions"})]})}),e.jsx(ar,{children:s.map(y=>e.jsxs(ht,{children:[e.jsxs(ne,{children:[e.jsx(h,{variant:"body2",fontWeight:"medium",children:y.original_filename}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:["by ",y.uploaded_by_name]})]}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",children:X(y.file_size)})}),e.jsx(ne,{align:"center",children:e.jsx(De,{label:y.mime_type.split("/")[1]?.toUpperCase()||"FILE",size:"small",variant:"outlined"})}),g==="admin"?e.jsxs(e.Fragment,{children:[e.jsx(ne,{align:"center",children:e.jsx(k,{display:"flex",flexWrap:"wrap",gap:.5,justifyContent:"center",children:y.profile_details&&y.profile_details.length>0?y.profile_details.map(S=>e.jsx(De,{label:S.profile_name,size:"small",variant:"outlined",color:"primary"},S.profile_id)):y.visible_to_profiles?.map(S=>{const U=t.find(K=>K.id===S);return U?e.jsx(De,{label:U.name,size:"small",variant:"outlined",color:"primary"},S):null})})}),e.jsx(ne,{align:"center",children:e.jsx(k,{display:"flex",flexWrap:"wrap",gap:.5,justifyContent:"center",children:y.profile_details&&y.profile_details.length>0?y.profile_details.map(S=>e.jsx(De,{label:S.has_read?"Read":"Unread",size:"small",color:S.has_read?"success":"default",icon:S.has_read?e.jsx(Ja,{}):e.jsx(ws,{}),title:`${S.profile_name}: ${S.has_read?"Read":"Unread"}`},S.profile_id)):y.visible_to_profiles?.map(S=>{const U=t.find(E=>E.id===S),K=y.profile_read_status?.[S]||!1;return U?e.jsx(De,{label:K?"Read":"Unread",size:"small",color:K?"success":"default",icon:K?e.jsx(Ja,{}):e.jsx(ws,{}),title:`${U.name}: ${K?"Read":"Unread"}`},S):null})})})]}):e.jsx(ne,{align:"center",children:e.jsx(De,{label:y.profile_read_status?.[n]?"Read":"Unread",size:"small",color:y.profile_read_status?.[n]?"success":"default",icon:y.profile_read_status?.[n]?e.jsx(Ja,{}):e.jsx(ws,{})})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",children:I(y.created_at)})}),e.jsxs(ne,{align:"center",children:[e.jsx(gt,{size:"small",onClick:()=>Q(y),title:"View Statistics",children:e.jsx(Yh,{})}),e.jsx(gt,{size:"small",component:"a",href:`/api/profile-documents/file/${y.id}`,target:"_blank",title:"Download",children:e.jsx(Fu,{})}),e.jsx(gt,{size:"small",onClick:()=>Z(y.id),title:"Delete",color:"error",children:e.jsx(qs,{})})]})]},y.id))})]})})]})})})]}),e.jsxs(mt,{open:u,onClose:()=>d(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:"Upload Document"}),e.jsx(xt,{children:e.jsxs(k,{sx:{pt:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Select Profiles"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Choose which profiles can see this document"}),e.jsx(Vh,{children:t.map(y=>e.jsx(vn,{control:e.jsx(on,{checked:b.includes(y.id),onChange:S=>{S.target.checked?N([...b,y.id]):N(b.filter(U=>U!==y.id))}}),label:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",children:y.name}),e.jsx(h,{variant:"caption",color:"text.secondary",children:y.email})]})},y.id))}),e.jsx(le,{fullWidth:!0,label:"Custom Document Name",value:m,onChange:y=>j(y.target.value),sx:{mb:2,mt:2},helperText:"Leave empty to use original filename"}),e.jsxs(k,{sx:{mb:2},children:[e.jsx("input",{type:"file",id:"file-upload",onChange:J,style:{display:"none"},accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif"}),e.jsx("label",{htmlFor:"file-upload",children:e.jsx(G,{variant:"outlined",component:"span",startIcon:e.jsx(Qo,{}),fullWidth:!0,children:p?p.name:"Select File"})})]}),p&&e.jsxs(We,{severity:"info",children:["Selected: ",p.name," (",X(p.size),")"]})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>d(!1),disabled:v,children:"Cancel"}),e.jsx(G,{onClick:z,variant:"contained",disabled:!p||b.length===0||v,startIcon:v?e.jsx(it,{size:20}):e.jsx(Qo,{}),children:v?"Uploading...":"Upload"})]})]}),e.jsxs(mt,{open:_,onClose:()=>P(!1),maxWidth:"md",fullWidth:!0,children:[e.jsxs(ft,{children:["Document Statistics: ",L?.original_filename]}),e.jsx(xt,{children:e.jsxs(k,{sx:{pt:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Profile Read Status"}),e.jsx(h,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"View which profiles can see this document and their read status:"}),L&&e.jsx(lr,{sx:{mt:2},children:e.jsxs(nr,{size:"small",children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Profile"}),e.jsx(ne,{children:"Email"}),e.jsx(ne,{align:"center",children:"Read Status"}),e.jsx(ne,{align:"center",children:"Read At"})]})}),e.jsx(ar,{children:L.visible_to_profiles?.map(y=>{const S=t.find(E=>E.id===y),U=L.profile_read_status?.[y]||!1,K=D.find(E=>E.profile_id===y);return S?e.jsxs(ht,{children:[e.jsx(ne,{children:e.jsx(h,{variant:"body2",fontWeight:"medium",children:S.name})}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",color:"text.secondary",children:S.email})}),e.jsx(ne,{align:"center",children:e.jsx(De,{label:U?"Read":"Unread",size:"small",color:U?"success":"default",icon:U?e.jsx(Ja,{}):e.jsx(ws,{})})}),e.jsx(ne,{align:"center",children:K?e.jsx(h,{variant:"body2",children:I(K.read_at)}):e.jsx(h,{variant:"body2",color:"text.secondary",children:"-"})})]},y):null})})]})})]})}),e.jsx(_t,{children:e.jsx(G,{onClick:()=>P(!1),children:"Close"})})]})]})},nw=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(!0),[s,o]=l.useState(!1),[i,c]=l.useState(!1),[u,d]=l.useState({margin_id:"",cost_lower_bound:"",cost_upper_bound:"",margin_factor:""}),[p,f]=l.useState(null),[m,j]=l.useState({page:0,pageSize:5}),[v,w]=l.useState(""),[_,P]=l.useState(!1),[L,C]=l.useState(""),[D,A]=l.useState(!1),[b,N]=l.useState(""),[g,x]=l.useState(!1),[R,O]=l.useState(""),[ee,J]=l.useState(!1),[z,Z]=l.useState(""),[Q,X]=l.useState(!1),I=async()=>{try{const re=await B.get("/api/margin-schedule");r(re.data.map(Me=>({...Me,id:Me.margin_id}))),a(!1),f(null)}catch(re){console.error("Error fetching margin schedules:",re),f("Failed to load margin schedules"),H.error("Failed to load margin schedules"),a(!1)}},y=async()=>{P(!0);try{const re=await B.get("/api/settings/labour-rate");w(re.data.labour_rate??"")}catch{w("")}finally{P(!1)}},S=async()=>{A(!0);try{const re=await B.get("/api/settings/overhead-rate");C(re.data.overhead_rate??"")}catch{C("")}finally{A(!1)}},U=async()=>{x(!0);try{const re=await B.get("/api/settings/supply-rate");N(re.data.supply_rate??"")}catch{N("")}finally{x(!1)}},K=async()=>{J(!0);try{const re=await B.get("/api/settings/daily-break-start");O(re.data.daily_break_start??"")}catch{O("")}finally{J(!1)}},E=async()=>{X(!0);try{const re=await B.get("/api/settings/daily-break-end");Z(re.data.daily_break_end??"")}catch{Z("")}finally{X(!1)}};l.useEffect(()=>{I(),y(),S(),U(),K(),E()},[]);const V=()=>{c(!1),d({margin_id:"",cost_lower_bound:"",cost_upper_bound:"",margin_factor:""}),o(!0)},q=re=>{c(!0),d({margin_id:re.margin_id,cost_lower_bound:String(re.cost_lower_bound),cost_upper_bound:String(re.cost_upper_bound),margin_factor:String(re.margin_factor)}),o(!0)},ue=async re=>{if(window.confirm("Are you sure you want to delete this margin schedule?"))try{await B.delete(`/api/margin-schedule/${re}`),H.success("Margin schedule deleted successfully"),I()}catch(Me){console.error("Error deleting margin schedule:",Me),H.error("Failed to delete margin schedule")}},ye=()=>{o(!1)},ge=re=>{const{name:Me,value:Ce}=re.target;d(Ye=>({...Ye,[Me]:Ce}))},xe=async re=>{re.preventDefault();try{i?(await B.put(`/api/margin-schedule/${u.margin_id}`,{cost_lower_bound:parseFloat(u.cost_lower_bound),cost_upper_bound:parseFloat(u.cost_upper_bound),margin_factor:parseFloat(u.margin_factor)}),H.success("Margin schedule updated successfully")):(await B.post("/api/margin-schedule",{schedule:[{cost_lower_bound:parseFloat(u.cost_lower_bound),cost_upper_bound:parseFloat(u.cost_upper_bound),margin_factor:parseFloat(u.margin_factor)}]}),H.success("Margin schedule created successfully")),ye(),I()}catch(Me){console.error("Error saving margin schedule:",Me),H.error("Failed to save margin schedule")}},me=async()=>{P(!0);try{await B.put("/api/settings/labour-rate",{labour_rate:Number(v)}),y()}catch{}finally{P(!1)}},he=async()=>{A(!0);try{await B.put("/api/settings/overhead-rate",{overhead_rate:Number(L)}),S()}catch{}finally{A(!1)}},ae=async()=>{x(!0);try{await B.put("/api/settings/supply-rate",{supply_rate:Number(b)}),U(),H.success("Supply rate updated successfully")}catch{H.error("Failed to update supply rate")}finally{x(!1)}},T=async()=>{J(!0);try{await B.put("/api/settings/daily-break-start",{daily_break_start:R}),K(),H.success("Daily break start time updated successfully")}catch{H.error("Failed to update daily break start time")}finally{J(!1)}},$=async()=>{X(!0);try{await B.put("/api/settings/daily-break-end",{daily_break_end:z}),E(),H.success("Daily break end time updated successfully")}catch{H.error("Failed to update daily break end time")}finally{X(!1)}},ce=[{field:"margin_id",headerName:"ID",flex:.5,minWidth:60,headerAlign:"center",align:"center"},{field:"cost_lower_bound",headerName:"Cost Lower Bound",flex:1,minWidth:120,type:"number",headerAlign:"center",align:"center"},{field:"cost_upper_bound",headerName:"Cost Upper Bound",flex:1,minWidth:120,type:"number",headerAlign:"center",align:"center"},{field:"margin_factor",headerName:"Margin Factor",flex:1,minWidth:120,type:"number",headerAlign:"center",align:"center"},{field:"actions",headerName:"Actions",width:80,sortable:!1,headerAlign:"center",align:"center",renderCell:re=>e.jsx(gt,{size:"small",color:"error",onClick:Me=>{Me.stopPropagation(),ue(re.row.margin_id)},children:e.jsx(gr,{})})}];return e.jsxs(at,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Global Variables"}),e.jsxs(ke,{direction:"row",spacing:2,children:[e.jsx(G,{variant:"contained",onClick:V,startIcon:e.jsx(Lr,{}),children:"New Entry"}),e.jsx(G,{variant:"contained",onClick:I,children:"Refresh"})]})]}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsx(k,{sx:{p:2},children:e.jsx(Jr,{rows:t,columns:ce,getRowId:re=>re.id,paginationModel:m,onPaginationModelChange:re=>j(re),pageSizeOptions:[5,10,20],loading:n,disableRowSelectionOnClick:!0,onRowClick:re=>q(re.row),sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"},cursor:"pointer"}})})}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden",mb:3,p:2},children:e.jsxs(k,{sx:{display:"flex",gap:4,alignItems:"flex-start"},children:[e.jsxs(k,{sx:{flex:1},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Labour Hourly Rate"}),e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(le,{label:"Hourly Rate ($)",type:"number",value:v,onChange:re=>w(re.target.value===""?"":Number(re.target.value)),disabled:_,InputProps:{startAdornment:e.jsx(pr,{position:"start",children:"$"})},sx:{maxWidth:200}}),e.jsx(G,{variant:"contained",onClick:me,disabled:_||v==="",children:"Save"})]})]}),e.jsxs(k,{sx:{flex:1},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Overhead Hourly Rate"}),e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(le,{label:"Hourly Rate ($)",type:"number",value:L,onChange:re=>C(re.target.value===""?"":Number(re.target.value)),disabled:D,InputProps:{startAdornment:e.jsx(pr,{position:"start",children:"$"})},sx:{maxWidth:200}}),e.jsx(G,{variant:"contained",onClick:he,disabled:D||L==="",children:"Save"})]})]}),e.jsxs(k,{sx:{flex:1},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Supply Percentage"}),e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(le,{label:"Percentage (%)",type:"number",value:b,onChange:re=>N(re.target.value===""?"":Number(re.target.value)),disabled:g,InputProps:{endAdornment:e.jsx(pr,{position:"end",children:"%"})},sx:{maxWidth:200}}),e.jsx(G,{variant:"contained",onClick:ae,disabled:g||b==="",children:"Save"})]})]}),e.jsxs(k,{sx:{flex:1},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Daily Break Times"}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(le,{label:"Break Start (HH:MM)",type:"time",value:R,onChange:re=>O(re.target.value),disabled:ee,InputLabelProps:{shrink:!0},sx:{maxWidth:200}}),e.jsx(G,{variant:"contained",onClick:T,disabled:ee||R==="",children:"Save Start"}),e.jsx(le,{label:"Break End (HH:MM)",type:"time",value:z,onChange:re=>Z(re.target.value),disabled:Q,InputLabelProps:{shrink:!0},sx:{maxWidth:200}}),e.jsx(G,{variant:"contained",onClick:$,disabled:Q||z==="",children:"Save End"})]})]})]})}),e.jsxs(mt,{open:s,onClose:ye,children:[e.jsx(ft,{children:i?"Edit Margin Entry":"Add New Margin Entry"}),e.jsx(xt,{children:e.jsxs(ke,{spacing:2,mt:1,children:[e.jsx(le,{label:"Cost Lower Bound",name:"cost_lower_bound",value:u.cost_lower_bound,onChange:ge,fullWidth:!0,type:"number"}),e.jsx(le,{label:"Cost Upper Bound",name:"cost_upper_bound",value:u.cost_upper_bound,onChange:ge,fullWidth:!0,type:"number"}),e.jsx(le,{label:"Margin Factor",name:"margin_factor",value:u.margin_factor,onChange:ge,fullWidth:!0,type:"number"})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:ye,children:"Cancel"}),e.jsx(G,{onClick:xe,children:i?"Save Changes":"Add Entry"})]})]})]})};var Oa={},Qd;function sw(){if(Qd)return Oa;Qd=1;var t=yt();Object.defineProperty(Oa,"__esModule",{value:!0}),Oa.default=void 0;var r=t(bt()),n=vt();return Oa.default=(0,r.default)((0,n.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"}),"CheckCircle"),Oa}var aw=sw();const qn=st(aw);var Aa={},Kd;function ow(){if(Kd)return Aa;Kd=1;var t=yt();Object.defineProperty(Aa,"__esModule",{value:!0}),Aa.default=void 0;var r=t(bt()),n=vt();return Aa.default=(0,r.default)((0,n.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-2h2zm0-4h-2V7h2z"}),"Error"),Aa}var iw=ow();const Ti=st(iw);var Ma={},Jd;function lw(){if(Jd)return Ma;Jd=1;var t=yt();Object.defineProperty(Ma,"__esModule",{value:!0}),Ma.default=void 0;var r=t(bt()),n=vt();return Ma.default=(0,r.default)((0,n.jsx)("path",{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2m5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12z"}),"Cancel"),Ma}var cw=lw();const El=st(cw),dw=t=>{if(typeof t=="string"){const r=t.trim().toLowerCase();if(["needed","need","required","pending"].includes(r))return"needed";if(["done","complete","completed","sent"].includes(r))return"done";if(["true","t","yes","y","1","on"].includes(r))return"needed";if(["false","f","no","n","0","off",""].includes(r))return""}return typeof t=="boolean"&&t?"needed":""},uw=()=>{const[t,r]=l.useState(""),[n,a]=l.useState([]),[s,o]=l.useState("open"),[i,c]=l.useState(0),u=Kt(),d=cn(),{user:p}=Zt(),[f,m]=l.useState(!1),[j,v]=l.useState({page:0,pageSize:10}),w=async(b=s)=>{try{const N=p?.access_role==="Sales and Purchase"?"open":b,x=(await B.get("/api/sales-orders",{params:{status:N,_ts:Date.now()}})).data.sort((O,ee)=>{const J=Q=>{const X=Q.match(/\d+/);return X?parseInt(X[0],10):0},z=J(O.sales_order_number);return J(ee.sales_order_number)-z}),R=x.map(O=>({...O,id:O.sales_order_id,subtotal:Number(O.subtotal)||0,total_gst_amount:Number(O.total_gst_amount)||0,total_amount:Number(O.total_amount)||0,invoice_status:dw(O.invoice_status??O.invoice_required)}));if(a(R),b==="open"||b==="all"){const ee=(b==="open"?x:x.filter(J=>J.status==="Open")).reduce((J,z)=>{const Z=parseFloat(z.subtotal)||0;return J+Z},0);c(ee)}else c(0)}catch(N){console.error("Error fetching sales orders:",N),a([]),c(0)}};l.useEffect(()=>{w(s)},[s,p?.access_role]),l.useEffect(()=>{setTimeout(()=>{w(s)},500)},[d.key]),l.useEffect(()=>{const b=()=>w(s),N=()=>{document.visibilityState==="visible"&&w(s)};return window.addEventListener("focus",b),document.addEventListener("visibilitychange",N),()=>{window.removeEventListener("focus",b),document.removeEventListener("visibilitychange",N)}},[s]);const _=async b=>{if(window.confirm("Are you sure you want to delete this Sales Order? This action cannot be undone."))try{await B.delete(`/api/sales-orders/${b}`),H.success("Sales Order deleted successfully!"),w()}catch(N){console.error("Error deleting sales order:",N),H.error("Failed to delete sales order.")}},P=n.filter(b=>b.sales_order_number?.toLowerCase().includes(t.toLowerCase())||b.customer_name?.toLowerCase().includes(t.toLowerCase())||b.product_name?.toLowerCase().includes(t.toLowerCase())||b.product_description?.toLowerCase().includes(t.toLowerCase())),L=[{field:"sales_order_number",headerName:"Sales Order #",flex:1,minWidth:120,valueFormatter:b=>b.value?String(b.value).replace("SO-",""):""},{field:"customer_name",headerName:"Customer",flex:1.3,minWidth:150},{field:"product_name",headerName:"Product Name",flex:1,minWidth:120},{field:"product_description",headerName:"Product Description",flex:1.5,minWidth:150},{field:"subtotal",headerName:"Subtotal",flex:.8,minWidth:100,valueFormatter:b=>b.value!=null&&!isNaN(Number(b.value))?`$${Number(b.value).toFixed(2)}`:"$0.00"},{field:"total_amount",headerName:"Total",flex:.8,minWidth:100,valueFormatter:b=>b.value!=null&&!isNaN(Number(b.value))?`$${Number(b.value).toFixed(2)}`:"$0.00"},{field:"status",headerName:"Status",flex:.8,minWidth:100,renderCell:b=>e.jsx(De,{label:b.value,color:b.value==="Open"?"success":"error",size:"small",variant:"outlined"})},{field:"invoice_status",headerName:"Invoice",flex:.6,minWidth:90,valueFormatter:b=>b.value==="done"?"Done":b.value==="needed"?"Needed":"",renderCell:b=>b.value==="done"?e.jsx(qn,{color:"success",titleAccess:"Invoice done"}):b.value==="needed"?e.jsx(El,{color:"error",titleAccess:"Invoice needed"}):null,sortable:!1},{field:"exported_to_qbo",headerName:"QBO Exported",flex:.8,minWidth:120,renderCell:b=>b.row.exported_to_qbo?e.jsx(qn,{color:"success",titleAccess:"Exported to QuickBooks"}):b.row.qbo_export_status?e.jsx(Ti,{color:"error",titleAccess:`QBO Export Error: ${b.row.qbo_export_status}`}):b.row.status==="Closed"?e.jsx(Yl,{color:"warning",titleAccess:"Not exported to QuickBooks"}):null},{field:"actions",headerName:"Actions",width:100,sortable:!1,renderCell:b=>e.jsx(k,{sx:{display:"flex",gap:.5},children:b.row.status!=="Closed"&&e.jsx(gt,{size:"small",color:"error",onClick:N=>{N.stopPropagation(),_(b.row.sales_order_id)},children:e.jsx(gr,{})})})}],C=()=>{setTimeout(()=>{w()},500)},D=()=>{let b=P;s==="open"?b=P.filter(R=>R.status==="Open"):s==="closed"&&(b=P.filter(R=>R.status==="Closed"));const N=Wn.unparse(b.map(R=>{const O={};return L.forEach(ee=>{if(ee.field!=="actions"){const J=R[ee.field];ee.field==="bill_date"||ee.field==="sales_date"?O[ee.headerName]=J?new Date(J).toLocaleDateString():"":ee.type==="number"?O[ee.headerName]=J!=null&&!isNaN(parseFloat(String(J)))?parseFloat(String(J)).toFixed(2):"":O[ee.headerName]=J!==void 0?String(J):""}}),O})),g=new Blob([N],{type:"text/csv;charset=utf-8;"}),x=document.createElement("a");if(x.download!==void 0){const R=URL.createObjectURL(g);x.setAttribute("href",R),x.setAttribute("download","open_sales_orders.csv"),x.style.visibility="hidden",document.body.appendChild(x),x.click(),document.body.removeChild(x)}},A=b=>{if(console.log("OpenSalesOrdersPage: Row clicked:",b.row),console.log("OpenSalesOrdersPage: User role:",p?.access_role),console.log("OpenSalesOrdersPage: Sales order ID:",b.row.sales_order_id),p?.access_role==="Time Tracking"){const N=`/worker-sales-orders/${b.row.sales_order_id}`;console.log("OpenSalesOrdersPage: Navigating time tracking user to:",N),u(N)}else{const N=`/open-sales-orders/${b.row.sales_order_id}`;console.log("OpenSalesOrdersPage: Navigating regular user to:",N),u(N)}};return p?.access_role==="Time Tracking"?e.jsxs(at,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{mb:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Sales Orders"}),e.jsx(k,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:e.jsx(G,{variant:"outlined",startIcon:e.jsx(jn,{}),onClick:C,children:"Refresh"})})]}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(ke,{direction:"row",spacing:3,sx:{mb:2},children:e.jsx(le,{label:"Search",variant:"outlined",value:t,onChange:b=>r(b.target.value),InputProps:{startAdornment:e.jsx(pr,{position:"start",children:e.jsx(Br,{sx:{fontSize:22}})})},sx:{minWidth:340,maxWidth:400,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"small"})}),e.jsx(Jr,{rows:P,columns:L.filter(b=>b.field!=="actions"),loading:!1,paginationModel:j,onPaginationModelChange:v,pageSizeOptions:[10,25,50],getRowId:b=>b.id,onRowClick:A,disableRowSelectionOnClick:!0,initialState:{sorting:{sortModel:[{field:"sales_order_number",sort:"desc"}]}},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]}):e.jsxs(at,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{mb:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:p?.access_role==="Sales and Purchase"?"Sales Orders (Open Only)":"Sales Orders"}),(s==="open"||s==="all")&&e.jsxs(k,{sx:{mb:2,p:2,bgcolor:"background.paper",borderRadius:1,border:"1px solid",borderColor:"divider"},children:[e.jsxs(h,{variant:"h6",component:"div",sx:{fontWeight:"bold",color:"primary.main"},children:["Work In Process: $",i.toFixed(2)]}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Total subtotal value of all open sales orders"})]}),e.jsx(k,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:e.jsxs(ke,{direction:"row",spacing:2,children:[p?.access_role!=="Time Tracking"&&e.jsx(G,{variant:"contained",startIcon:e.jsx(Lr,{}),onClick:()=>u("/open-sales-orders/new"),children:"New SO"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(yr,{}),onClick:D,children:"Export CSV"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(jn,{}),onClick:C,children:"Refresh"})]})})]}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsxs(ke,{direction:"row",spacing:3,sx:{mb:2},children:[e.jsx(le,{label:"Search",variant:"outlined",value:t,onChange:b=>r(b.target.value),InputProps:{startAdornment:e.jsx(pr,{position:"start",children:e.jsx(Br,{sx:{fontSize:22}})})},sx:{minWidth:340,maxWidth:400,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"small"}),p?.access_role!=="Sales and Purchase"&&e.jsx(De,{label:"All",onClick:()=>o("all"),color:s==="all"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),e.jsx(De,{label:"Open",onClick:()=>o("open"),color:s==="open"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),p?.access_role!=="Sales and Purchase"&&e.jsx(De,{label:"Closed",onClick:()=>o("closed"),color:s==="closed"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}})]}),e.jsx(Jr,{rows:P,columns:L,loading:!1,paginationModel:j,onPaginationModelChange:v,pageSizeOptions:[10,25,50],getRowId:b=>b.id,onRowClick:A,disableRowSelectionOnClick:!0,initialState:{sorting:{sortModel:[{field:"sales_order_number",sort:"desc"}]}},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]})},Do=(t,r)=>{const n=parseFloat(String(t))||0,a=parseFloat(String(r))||0;return Math.round(n*a*100)/100},nn=t=>{const r=parseFloat(String(t));return isNaN(r)?0:r},Eo=["Each","cm","ft","kg","pcs","hr","L"],Vn=5,Xd=t=>{if(typeof t=="string"){const r=t.trim().toLowerCase();if(["needed","need","required","pending"].includes(r))return"needed";if(["done","complete","completed","sent"].includes(r))return"done";if(["true","t","yes","y","1","on"].includes(r))return"needed";if(["false","f","no","n","0","off",""].includes(r))return""}return typeof t=="boolean"&&t?"needed":""},ai=t=>t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim().toUpperCase(),pw=(t,r,n=8)=>{const a=ai(r);if(!a)return t.slice(0,n);const s=t.map(o=>{const i=ai(o.label);let c=-1;return i.startsWith(a)?c=3:i.split(" ").some(u=>u.startsWith(a))?c=2:i.includes(a)&&(c=1),{opt:o,score:c}}).filter(o=>o.score>=0);return s.sort((o,i)=>i.score-o.score||o.opt.label.localeCompare(i.opt.label)),s.slice(0,n).map(o=>o.opt)},hw=()=>{const{id:t}=wn(),r=t==="new",n=!!t&&/^\d+$/.test(t),a=Kt(),{user:s}=Zt(),o=s?.access_role==="Sales and Purchase",[i,c]=l.useState([]),[u,d]=l.useState([]),[p,f]=l.useState([]),[m,j]=l.useState([]),[v,w]=l.useState(null),[_,P]=l.useState(null),[L,C]=l.useState(null),[D,A]=l.useState(null),[b,N]=l.useState(""),[g,x]=l.useState(!1),[R,O]=l.useState(null),[ee,J]=l.useState(!1),z=l.useRef(null),[Z,Q]=l.useState(null),[X,I]=l.useState(""),[y,S]=l.useState(!1),[U,K]=l.useState(null),[E,V]=l.useState($e()),[q,ue]=l.useState(""),[ye,ge]=l.useState(""),[xe,me]=l.useState(""),[he,ae]=l.useState(""),[T,$]=l.useState(""),[ce,re]=l.useState(""),[Me,Ce]=l.useState(""),Ye=l.useCallback((W,F)=>{Ce(F??"")},[]),[Qe,lt]=l.useState(null),[ct,ut]=l.useState(""),[Ne,tt]=l.useState([]);l.useMemo(()=>Ne.map(W=>({part_number:W.part_number,part_description:W.part_description,quantity:nn(W.quantity),unit:W.unit,unit_price:W.unit_price})),[Ne]);const Be=l.useMemo(()=>{if(!Ne||Ne.length===0)return{subtotal:0,total_gst_amount:0,total_amount:0};const W=Ne.reduce((oe,ve)=>{const Oe=ve.line_amount||0;return oe+Oe},0),F=W*.05,se=W+F;return{subtotal:Math.round(W*100)/100,total_gst_amount:Math.round(F*100)/100,total_amount:Math.round(se*100)/100}},[Ne]),Ct=Be.subtotal,qt=Be.total_gst_amount,Bt=Be.total_amount,[Ke,Yt]=l.useState(null),[Et,zt]=l.useState(!r),[cr,jr]=l.useState(null),[_e,be]=l.useState(null),[je,pe]=l.useState([]),[Ee,Fe]=l.useState(""),[ze,Ze]=l.useState(!1),[ot,St]=l.useState(!1),Ht=l.useCallback(W=>JSON.stringify((W||[]).map(F=>({part_number:(F.part_number||"").trim(),part_description:(F.part_description||"").trim(),quantity:nn(F.quantity),unit:(F.unit||"").trim(),unit_price:nn(F.unit_price)})).sort((F,se)=>F.part_number!==se.part_number?F.part_number.localeCompare(se.part_number):F.quantity-se.quantity)),[]),dr=l.useCallback(()=>({customer:D?{id:D.id,label:D.label}:null,product:Z?{id:Z.id,label:Z.label}:null,salesDate:E?E.toISOString():null,terms:(ye||"").trim(),customerPoNumber:(xe||"").trim(),vinNumber:(he||"").trim(),estimatedCost:Qe!=null?Number(Qe):null,vehicleMake:(T||"").trim(),vehicleModel:(ce||"").trim(),invoiceStatus:Me}),[D,Z,E,ye,xe,he,Qe,T,ce,Me]);l.useEffect(()=>{if(ze&&Ee===""){const W=JSON.stringify({header:dr(),lineItems:Ht(Ne)});Fe(W)}},[ze,Ee,dr,Ht,Ne]);const dn=l.useMemo(()=>JSON.stringify({header:dr(),lineItems:Ht(Ne)}),[dr,Ht,Ne]),Sn=!!Ee&&Ee!==dn&&!ot,Pe=!!Ke&&Ke.status?.toLowerCase()==="closed",[Ie,Le]=l.useState([]),[nt,jt]=l.useState([]),[er,Er]=l.useState(null),[un,Gt]=l.useState(null),[vr,qr]=l.useState(null),[$s,pn]=l.useState(null),[hr,mr]=l.useState(null),[os,we]=l.useState(null),[rt,pt]=l.useState(!1),[Qt,ur]=l.useState(null),[Hr,Yr]=l.useState(""),[Ur,Ir]=l.useState(!1),[wr,Tr]=l.useState(null),[Gr,Wr]=l.useState(""),Sr=nt.length>0?8+64*nt.length:0;l.useMemo(()=>JSON.stringify(Ne.map(W=>({part_number:W.part_number,part_description:W.part_description,quantity:W.quantity,unit:W.unit,unit_price:W.unit_price,line_amount:W.line_amount}))),[Ne]);const Cn=(W,F)=>{const se=(Ne[W]?.part_number||"").trim(),oe=F.key==="Enter",ve=F.key==="Tab",Oe=F.key==="Escape",Ve=F.key==="ArrowDown"||F.key==="ArrowUp";if(Oe){Gt(null);return}if(Ve){F.key==="ArrowDown"&&un!==W&&Gt(W);return}if(!(un===W&&(oe||ve))&&(oe||ve)&&se){if(oe&&F.ctrlKey){F.preventDefault(),pn(W),Yr(se.toUpperCase()),ur(W),pt(!0),Gt(null);return}!p.find(Pt=>Pt.part_number.toUpperCase()===se.toUpperCase())&&oe&&(F.preventDefault(),pn(W),Yr(se.toUpperCase()),ur(W),pt(!0),Gt(null))}},is=(W,F)=>{const se=(je[W]?.part_number||"").trim(),oe=F.key==="Enter",ve=F.key==="Tab",Oe=F.key==="Escape",Ve=F.key==="ArrowDown"||F.key==="ArrowUp";if(Oe){mr(null);return}if(Ve){F.key==="ArrowDown"&&hr!==W&&mr(W);return}if(!(hr===W&&(oe||ve))&&(oe||ve)&&se){if(oe&&F.ctrlKey){F.preventDefault(),we(W),Wr(se.toUpperCase()),Tr(W),Ir(!0),mr(null);return}!p.find(Pt=>Pt.part_number.toUpperCase()===se.toUpperCase())&&oe&&(F.preventDefault(),we(W),Wr(se.toUpperCase()),Tr(W),Ir(!0),mr(null))}},Qr=W=>i.find(F=>ai(F.label)===ai(W))||null,[ls,en]=l.useState(!1),[cs,kn]=l.useState(""),[ho,Fn]=l.useState(!1),[zs,$n]=l.useState(""),[ds,zn]=l.useState(!1),[mo,Oi]=l.useState([]),[hn,us]=l.useState(null),[fo,Pn]=l.useState(!1),[Bn,ps]=l.useState(!1),[Hn,mn]=l.useState(null),[xo,hs]=l.useState(null),[go,br]=l.useState(null);l.useEffect(()=>{(async()=>{try{const[W,F,se,oe]=await Promise.all([B.get("/api/customers"),B.get("/api/products"),B.get("/api/inventory"),B.get("/api/margin-schedule")]);c(W.data.map(ve=>({label:ve.customer_name,id:ve.customer_id}))),d(F.data.map(ve=>({label:ve.product_name,id:ve.product_id,description:ve.product_description}))),f(se.data),j(oe.data),r&&Ze(!0)}catch(W){console.error("Prefetch failed",W)}})()},[]),l.useEffect(()=>{(async()=>{try{const[W,F,se]=await Promise.all([B.get("/api/settings/labour-rate").catch(()=>({data:{labour_rate:null}})),B.get("/api/settings/overhead-rate").catch(()=>({data:{overhead_rate:null}})),B.get("/api/settings/supply-rate").catch(()=>({data:{supply_rate:null}}))]);w(W.data.labour_rate??null),P(F.data.overhead_rate??null),C(se.data.supply_rate??null)}catch{}})()},[]),l.useEffect(()=>{if(!t||r||!n){r&&(tt([{part_number:"",part_description:"",quantity:"",unit:Eo[0],unit_price:0,gst:Vn,line_amount:0}]),Ze(!0),ut(""));return}(async()=>{zt(!0),jr(null);try{const F=(await B.get(`/api/sales-orders/${t}`)).data,se=Xd(F.salesOrder?.invoice_status??F.salesOrder?.invoice_required);Yt(F.salesOrder?{...F.salesOrder,invoice_status:se||null}:null),ut(F.salesOrder?.source_quote_number||"");const oe=(F.lineItems||F.salesOrder?.line_items||[]).map(Re=>({part_number:Re.part_number,part_description:Re.part_description,unit:Re.unit,unit_price:Re.unit_price,line_amount:Number(Re.line_amount||0),quantity:Re.part_number==="SUPPLY"?"1":["LABOUR","OVERHEAD"].includes(Re.part_number)?String(Re.quantity_sold||0):String(Re.quantity_sold??Re.quantity??0),gst:Vn,part_id:Re.part_id??void 0}));console.log("[SalesOrderDetail] Raw line items from backend:",F.lineItems),console.log("[SalesOrderDetail] Mapped line items:",oe),tt(oe),Le(oe);const ve=(F.partsToOrder||[]).map(Re=>({sales_order_id:parseInt(t),part_number:Re.part_number,part_description:Re.part_description,quantity_to_order:String(Re.quantity_needed||0),unit:Re.unit||"Each",unit_price:Number(Re.unit_price||0),line_amount:Number(Re.line_amount||0)}));pe(ve),V($e(F.salesOrder?.sales_date)),lt(F.salesOrder?.estimated_cost||0),ue(F.salesOrder?.product_description||""),ge(F.salesOrder?.terms||""),me(F.salesOrder?.customer_po_number||""),ae(F.salesOrder?.vin_number||""),$(F.salesOrder?.vehicle_make||""),re(F.salesOrder?.vehicle_model||""),Ce(se);const Oe=i.find(Re=>Re.id===F.salesOrder?.customer_id)||{label:F.salesOrder?.customer_name||"",id:F.salesOrder?.customer_id};A(Oe?.id?Oe:null);const Ve=u.find(Re=>Re.label===F.salesOrder?.product_name)||{label:F.salesOrder?.product_name||""};Q(Ve?.label?Ve:null)}catch(W){console.error(W),jr(W?.response?.status===404?"Sales order not found. It may have been deleted.":"Failed to load sales order data. Please try again.")}finally{zt(!1),Ze(!0)}})()},[t,r,n]),l.useEffect(()=>{ze&&v!==null&&tt(W=>W.map(F=>F.part_number!=="LABOUR"?F:F.unit_price!==v?{...F,unit_price:v}:F))},[v,ze]),l.useEffect(()=>{ze&&_!==null&&tt(W=>W.map(F=>F.part_number!=="OVERHEAD"?F:F.unit_price!==_?{...F,unit_price:_}:F))},[_,ze]),l.useEffect(()=>{ze&&tt(W=>{const F=W.some(oe=>oe.part_number==="LABOUR"),se=W.some(oe=>oe.part_number==="SUPPLY");if(L&&L>0){if(F&&!se)return[...W,{part_number:"SUPPLY",part_description:"Supply",quantity:r?"":"1",unit:r?"":"Each",unit_price:0,gst:Vn,line_amount:0}];if(!F&&se)return W.filter(oe=>oe.part_number!=="SUPPLY")}else if(se)return W.filter(oe=>oe.part_number!=="SUPPLY");return W})},[L,Ne,ze,r]);const ms=W=>{const F=[...m].sort((se,oe)=>se.cost_lower_bound-oe.cost_lower_bound);for(const se of F){const oe=+se.cost_lower_bound,ve=se.cost_upper_bound==null?null:+se.cost_upper_bound,Oe=+se.margin_factor;if(W>=oe&&(ve===null||W<ve))return Oe}return 1},fn=W=>p.find(F=>F.part_number===W),xn=(W,F)=>{tt(se=>{const oe=[...se];if(!F||F.trim()==="")oe[W]={...oe[W],part_number:"",part_description:"",quantity:"",unit:Eo[0],unit_price:0,line_amount:0};else if(F.toUpperCase()==="LABOUR")oe[W]={...oe[W],part_number:"LABOUR",part_description:"Labour",unit:"hr",unit_price:v??0,line_amount:0};else if(F.toUpperCase()==="OVERHEAD")oe[W]={...oe[W],part_number:"OVERHEAD",part_description:"Overhead",unit:"hr",unit_price:_??0,line_amount:0};else if(F.toUpperCase()==="SUPPLY")oe[W]={...oe[W],part_number:"SUPPLY",part_description:"Supply",unit:r?"":"Each",unit_price:0,line_amount:0};else{const ve=fn(F);if(ve){const Oe=parseFloat(String(ve.last_unit_cost))||0,Ve=ms(Oe);oe[W]={...oe[W],part_number:F,part_description:ve.part_description||"",unit:ve.unit,unit_price:Oe*Ve,line_amount:0}}else oe[W]={...oe[W],part_number:F,part_description:"Part not found",unit_price:0,line_amount:0}}return oe})},Ai=(W,F,se)=>{tt(oe=>{const ve=[...oe],Oe={...ve[W],[F]:se};return parseFloat(se)<=0&&Oe.part_number!=="SUPPLY"?ve.filter((Ve,Re)=>Re!==W):(["LABOUR","OVERHEAD"].includes(Oe.part_number),ve[W]=Oe,ve)})},Bs=()=>{tt(W=>[...W,{part_number:"",part_description:"",quantity:"",unit:Eo[0],unit_price:0,gst:Vn,line_amount:0}])},yo=W=>{tt(F=>F.filter((se,oe)=>oe!==W))},Hs=(W,F)=>{if(["LABOUR","OVERHEAD","SUPPLY"].includes(W.part_number))return null;const se=p.find(Ft=>Ft.part_number.toLowerCase()===W.part_number.toLowerCase());if(!se||se.part_type==="supply")return null;const oe=parseFloat(se.quantity_on_hand)||0;if(r){const Ft=Ne.filter(xs=>xs.part_number.toLowerCase()===W.part_number.toLowerCase()).reduce((xs,tn)=>xs+(parseFloat(String(tn.quantity).replace(/[^\d.-]/g,""))||0),0),Cr=oe-Ft;return{available:Cr<0?Math.floor(Cr):Math.round(Cr),isNegative:Cr<0,currentStock:oe,changeInQuantity:Ft,totalQuantityForPart:Ft,totalOriginalQuantityForPart:0}}const ve=Ne.filter(Ft=>Ft.part_number.toLowerCase()===W.part_number.toLowerCase()).reduce((Ft,Cr)=>Ft+(parseFloat(String(Cr.quantity).replace(/[^\d.-]/g,""))||0),0),Oe=Ie.filter(Ft=>Ft.part_number.toLowerCase()===W.part_number.toLowerCase()).reduce((Ft,Cr)=>Ft+(parseFloat(String(Cr.quantity).replace(/[^\d.-]/g,""))||0),0),Ve=ve-Oe,Re=oe-Ve,Pt=Re<0?Math.floor(Re):Math.round(Re);return{available:Pt,isNegative:Pt<0,currentStock:oe,changeInQuantity:Ve,totalQuantityForPart:ve,totalOriginalQuantityForPart:Oe}},Ys=l.useMemo(()=>Ne.map((W,F)=>Hs(W)),[Ne,p,Ie,r]);l.useEffect(()=>{if(r)return;const W=[];Ne.forEach((F,se)=>{const oe=Hs(F);oe&&oe.available<0&&W.push({lineItemIndex:se,partNumber:F.part_number,partDescription:F.part_description,excessQuantity:Math.abs(oe.available),unit:F.unit})}),jt(W)},[Ne,p,r]);const vo=()=>{if(he&&he.trim()!==""&&he.trim().length!==17)return H.error("VIN must be 17 characters"),!1;if(Ne.filter(oe=>!oe.part_number||oe.part_number.trim()==="").length>0)return H.error("Line items with blank part numbers are not allowed."),!1;const F=Ne.filter(oe=>{if(["LABOUR","OVERHEAD","SUPPLY"].includes(String(oe.part_number).toUpperCase()))return!1;const ve=oe.part_id;if(ve){const Ve=(p||[]).find(Re=>Re.part_id===ve);return Ve?Ve.part_type==="supply":!1}const Oe=(p||[]).find(Ve=>String(Ve.part_number).toUpperCase()===String(oe.part_number).trim().toUpperCase());return!Oe||Oe.part_type==="supply"});if(F.length>0){const oe=F.map(ve=>ve.part_number).join(", ");return H.error(`Invalid or supply parts (not allowed): ${oe}`),!1}return Ne.some((oe,ve)=>{const Oe=Hs(oe);return Oe&&Oe.available<0})?(br("Insufficient inventory for one or more parts."),!1):(br(null),!0)},Yn=W=>{const F=W.reduce((se,oe)=>{const ve=oe.part_number.trim().toLowerCase();if(!se[ve]){const Oe=["LABOUR","OVERHEAD","SUPPLY"].includes(oe.part_number.toUpperCase())?null:(p||[]).find(Ve=>String(Ve.part_number).toUpperCase()===oe.part_number.trim().toUpperCase());se[ve]={part_number:oe.part_number.trim(),part_description:oe.part_description.trim(),unit:oe.unit.trim(),unit_price:oe.unit_price!=null?Number(oe.unit_price):0,line_amount:0,quantity_sold:0,...oe.part_id?{part_id:oe.part_id}:Oe&&Oe.part_id?{part_id:Oe.part_id}:{}}}if(oe.part_number.toUpperCase()==="SUPPLY")se[ve].quantity_sold=1,se[ve].unit="Each",se[ve].unit_price=0,se[ve].line_amount+=Number(oe.line_amount||0);else if(["LABOUR","OVERHEAD"].includes(oe.part_number.toUpperCase())){const Oe=parseFloat(String(oe.quantity).replace(/[^\d.-]/g,""))||0;se[ve].quantity_sold=Oe,se[ve].line_amount=Number(oe.line_amount||0)}else{const Oe=parseFloat(String(oe.quantity).replace(/[^\d.-]/g,""))||0;se[ve].quantity_sold+=Math.round(Oe),se[ve].line_amount+=Oe*(oe.unit_price||0)}return se},{});return Object.values(F)},fs=async()=>{if(!D||!E||!Z){H.error("Please fill in required fields.");return}if(!vo())return;const W={customer_id:D?.id,sales_date:E?E.toISOString():new Date().toISOString(),product_name:Z?.label?.trim(),product_description:q.trim(),terms:ye.trim(),customer_po_number:xe.trim(),vin_number:he.trim(),vehicle_make:T.trim(),vehicle_model:ce.trim(),invoice_status:Me||null,status:r?"Open":Ke?.status||"Open",estimated_cost:Qe!=null?Number(Qe):0,lineItems:Yn(Ne),source_quote_number:ct?.trim()||null};St(!0);try{if(r){if(window.__soCreateInFlight){console.log("[SO] Skipping duplicate create (in flight)");return}window.__soCreateInFlight=!0;const F=await B.post("/api/sales-orders",W);H.success("Sales Order created successfully!"),window.__unsavedGuardAllowNext=!0,a(`/open-sales-orders/${F.data.sales_order_id}`)}else{const F=je.filter(se=>se.part_number&&parseFloat(String(se.quantity_to_order))>0).map(se=>({sales_order_id:Number(t),part_number:se.part_number.trim(),part_description:se.part_description.trim(),quantity_needed:parseFloat(String(se.quantity_to_order))||0,unit:se.unit.trim(),unit_price:se.unit_price,line_amount:se.line_amount}));await B.put(`/api/sales-orders/${t}`,{...W,partsToOrder:F}),be("Sales Order updated successfully!"),setTimeout(()=>{window.__unsavedGuardAllowNext=!0},100),Fe(JSON.stringify({header:{customer:D,product:Z,salesDate:E,terms:ye,customerPoNumber:xe,vinNumber:he,estimatedCost:Qe,vehicleMake:T,vehicleModel:ce,invoiceStatus:Me},lineItems:Ne,quantityToOrderItems:je}));try{const[se,oe]=await Promise.all([B.get(`/api/sales-orders/${t}`),B.get("/api/inventory")]),ve=se.data,Oe=Xd(ve.salesOrder?.invoice_status??ve.salesOrder?.invoice_required);Yt(ve.salesOrder?{...ve.salesOrder,invoice_status:Oe||null}:null),Ce(Oe),ut(ve.salesOrder?.source_quote_number||"");const Ve=(ve.lineItems||ve.salesOrder?.line_items||[]).map(Re=>({part_number:Re.part_number,part_description:Re.part_description,unit:Re.unit,unit_price:Re.unit_price,line_amount:Number(Re.line_amount||0),quantity:Re.part_number==="SUPPLY"?"1":["LABOUR","OVERHEAD"].includes(Re.part_number)?String(Re.quantity_sold||0):String(Re.quantity_sold??Re.quantity??0),gst:Vn,part_id:Re.part_id??void 0}));tt(Ve),Le(Ve),f(oe.data)}catch{}}}catch(F){const se=F?.response?.data?.error||F?.response?.data?.details||F?.response?.data?.message||"Failed to save sales order.";br(se)}finally{St(!1),window.__soCreateInFlight=!1}},Mi=async()=>{if(r||!Ke)return;const W=Ne.filter(F=>!["LABOUR","OVERHEAD","SUPPLY"].includes(F.part_number)&&(parseFloat(String(F.quantity).replace(/[^\d.-]/g,""))||0)===0);if(W.length>0){H.error(`Cannot close: line items with 0 quantity: ${W.map(F=>F.part_number).join(", ")}`);return}if(je.some(F=>parseFloat(String(F.quantity_to_order))>0)){const F=je.filter(se=>parseFloat(String(se.quantity_to_order))>0).map(se=>`${se.part_number} (${se.quantity_to_order})`).join(", ");H.error(`Cannot close: parts still need to be ordered: ${F}`);return}try{await B.put(`/api/sales-orders/${Ke.sales_order_id}`,{customer_id:Ke.customer_id,sales_date:Ke.sales_date,product_name:Z?.label?.trim()||Ke.product_name,product_description:q.trim(),terms:ye.trim(),status:"Closed",estimated_cost:Qe??Ke.estimated_cost,lineItems:Yn(Ne)}),H.success("Sales Order closed successfully!"),Yt(F=>F&&{...F,status:"Closed"})}catch(F){const se=F?.response?.data?.error||F?.response?.data?.details||F?.response?.data?.message||"Failed to close sales order.";br(se)}},Vs=async()=>{if(!(r||!Ke))try{await B.put(`/api/sales-orders/${Ke.sales_order_id}`,{customer_id:Ke.customer_id,sales_date:Ke.sales_date,product_name:Z?.label?.trim()||Ke.product_name,product_description:q.trim(),terms:ye.trim(),status:"Open",estimated_cost:Qe??Ke.estimated_cost,lineItems:Yn(Ne)}),H.success("Sales Order reopened successfully!"),Yt(W=>W&&{...W,status:"Open"}),a(`/open-sales-orders/${Ke.sales_order_id}`)}catch(W){const F=W?.response?.data?.error||W?.response?.data?.details||W?.response?.data?.message||"Failed to reopen sales order.";br(F)}},Y=async()=>{if(r)return await(async()=>(await fs(),!0))(),void 0;if(Ke)try{Ke.status?.toLowerCase()!=="closed"&&await fs();const W=await B.get(`/api/sales-orders/${Ke.sales_order_id}/pdf`,{responseType:"blob"}),F=window.URL.createObjectURL(new Blob([W.data],{type:"application/pdf"})),se=document.createElement("a");se.href=F,se.download=`sales_order_${Ke.sales_order_number}.pdf`,document.body.appendChild(se),se.click(),se.remove(),window.URL.revokeObjectURL(F),H.success(Ke.status?.toLowerCase()==="closed"?"PDF downloaded.":"Saved and downloaded PDF.")}catch(W){const F=W?.response?.data?.error||W?.response?.data?.details||W?.response?.data?.message||"Failed to save or download PDF.";br(F)}},te=async()=>{if(!(r||!Ke)){if(je.some(W=>parseFloat(String(W.quantity_to_order))>0)){const W=je.filter(F=>parseFloat(String(F.quantity_to_order))>0).map(F=>`${F.part_number} (${F.quantity_to_order})`).join(", ");H.error(`Cannot export to QuickBooks: parts to order exist: ${W}`);return}ps(!0),mn(null),hs(null);try{const W=await B.post(`/api/sales-orders/${Ke.sales_order_id}/export-to-qbo`);hs("Sales Order exported to QuickBooks successfully!"),Yt(F=>F&&{...F,exported_to_qbo:!0,qbo_invoice_id:W.data.qbo_invoice_id,qbo_export_date:new Date().toISOString(),qbo_export_status:"Success"}),H.success("Exported to QuickBooks.")}catch(W){const F=W?.response?.data;if(F?.error==="CUSTOMER_NOT_FOUND")if(window.confirm(`Customer '${F.customerName}' does not exist in QuickBooks.
Create it and export the Sales Order?`))try{const oe=await B.post(`/api/sales-orders/${Ke.sales_order_id}/export-to-qbo-with-customer`,{customerData:F.customerData});H.success("Customer created and Sales Order exported."),hs("Customer created and Sales Order exported."),Yt(ve=>ve&&{...ve,exported_to_qbo:!0,qbo_invoice_id:oe.data.qbo_invoice_id,qbo_export_date:new Date().toISOString(),qbo_export_status:"Success"})}catch(oe){const ve=oe?.response?.data?.error||"Failed to create customer and export to QuickBooks.";mn(ve),H.error(ve)}else mn("Export cancelled. Customer must exist in QuickBooks.");else{const se=F?.error||F?.message||"Failed to export to QuickBooks.";mn(se),H.error(se)}}finally{ps(!1)}}},ie=async()=>{Pn(!0);try{const W=await B.get("/api/sales-orders");Oi(W.data)}catch{H.error("Failed to fetch sales orders for import")}finally{Pn(!1)}},fe=()=>{zn(!0),ie()},de=async()=>{if(hn){Pn(!0);try{const W=await B.get(`/api/sales-orders/${hn.sales_order_id}`),oe=(W.data.lineItems||W.data.salesOrder?.line_items||[]).filter(ve=>(ve.part_number||"").toUpperCase()!=="LABOUR").map(ve=>({part_number:ve.part_number,part_description:ve.part_description,quantity:String(r?ve.quantity:ve.quantity_sold??ve.quantity??0),unit:ve.unit,unit_price:ve.unit_price,gst:Vn,line_amount:ve.line_amount,part_id:ve.part_id??void 0}));tt(oe),zn(!1),us(null),H.success("Line items imported!")}catch{H.error("Failed to import line items")}finally{Pn(!1)}}},Te=W=>{const F=b.trim(),se=W.key==="Enter",oe=W.key==="Tab";if(W.key==="Escape"){x(!1);return}if(se||oe){if(se&&W.ctrlKey&&F){W.preventDefault(),J(!0),kn(F),en(!0);return}if(g||!F)return;W.preventDefault();const Oe=Qr(F);Oe?(A(Oe),N(Oe.label)):(J(!0),kn(F),en(!0))}},Je=W=>{if(W.key!=="Enter")return;W.preventDefault();const F=X.trim();if(!F)return;const se=u.find(oe=>oe.label.toLowerCase()===F.toLowerCase());se?(Q(se),I(se.label)):($n(F),Fn(!0))},Ge=()=>{if(!Ke)return null;const W=Ne||[];let F=W.reduce((ve,Oe)=>ve+(Number(Oe.line_amount)||0),0),se=F*.05,oe=F+se;return isNaN(F)&&(F=0),isNaN(se)&&(se=0),isNaN(oe)&&(oe=0),e.jsxs(k,{p:{xs:2,md:4},maxWidth:1e3,mx:"auto",children:[xo&&e.jsx(We,{severity:"success",sx:{mb:2},onClose:()=>hs(null),children:xo}),Hn&&e.jsx(We,{severity:"error",sx:{mb:2},onClose:()=>mn(null),children:Hn}),e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Sales Order Details"}),e.jsx(kt,{variant:"outlined",sx:{mb:3},children:e.jsx(Tt,{children:e.jsxs(M,{container:!0,spacing:{xs:2,md:3},children:[e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Sales Order #:"})," ",Ke.sales_order_number]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Customer:"})," ",Ke.customer_name||"N/A"]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Sales Date:"})," ",Ke.sales_date?new Date(Ke.sales_date).toLocaleDateString():""]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Status:"})," ",Ke.status?.toUpperCase()||"N/A"]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"VIN #:"})," ",Ke.vin_number||"N/A"]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Make:"})," ",Ke.vehicle_make||"N/A"]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Model:"})," ",Ke.vehicle_model||"N/A"]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Invoice:"})," ",Ke.invoice_status==="done"&&e.jsxs(k,{component:"span",sx:{display:"inline-flex",alignItems:"center",gap:.5},children:[e.jsx(qn,{color:"success",fontSize:"small"})," Done"]}),Ke.invoice_status==="needed"&&e.jsxs(k,{component:"span",sx:{display:"inline-flex",alignItems:"center",gap:.5},children:[e.jsx(El,{color:"error",fontSize:"small"})," Needed"]}),!Ke.invoice_status&&""]}),e.jsxs(M,{item:!0,xs:12,children:[e.jsx("b",{children:"Estimated Price:"})," ",Ar(Ke.estimated_cost||0)]}),e.jsxs(M,{item:!0,xs:12,children:[e.jsx("b",{children:"Product Description:"})," ",Ke.product_description||"N/A"]}),e.jsxs(M,{item:!0,xs:12,children:[e.jsx("b",{children:"Terms:"})," ",Ke.terms||"N/A"]}),Ke.exported_to_qbo&&e.jsxs(M,{item:!0,xs:12,children:[e.jsx("b",{children:"QBO Export:"})," Exported",Ke.qbo_invoice_id&&` (Invoice ID: ${Ke.qbo_invoice_id})`,Ke.qbo_export_date&&` on ${new Date(Ke.qbo_export_date).toLocaleDateString()}`]})]})})}),e.jsx(h,{variant:"h5",gutterBottom:!0,children:"Items"}),e.jsx(kt,{variant:"outlined",children:e.jsx(Tt,{children:W.map((ve,Oe)=>e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:6,sm:3,md:2,children:ve.part_number}),e.jsx(M,{item:!0,xs:6,sm:5,md:4,children:ve.part_description}),e.jsx(M,{item:!0,xs:4,sm:2,md:1.5,children:ve.quantity}),e.jsx(M,{item:!0,xs:4,sm:2,md:1.5,children:ve.unit}),e.jsx(M,{item:!0,xs:4,sm:2,md:1.5,children:Ar(ve.unit_price)}),e.jsx(M,{item:!0,xs:4,sm:2,md:1,children:Ar(ve.line_amount)})]},Oe))})}),e.jsxs(k,{mt:4,display:"flex",flexDirection:"column",alignItems:"flex-end",children:[e.jsxs(h,{variant:"h6",children:["Subtotal: ",Ar(F)]}),e.jsxs(h,{variant:"h6",children:["Total GST: ",Ar(se)]}),e.jsxs(h,{variant:"h6",children:["Total Amount: ",Ar(oe)]})]}),e.jsxs(k,{mt:4,display:"flex",justifyContent:{xs:"center",sm:"flex-end"},gap:2,children:[e.jsx(G,{variant:"contained",color:"primary",startIcon:e.jsx(yr,{}),onClick:Y,children:"Download PDF"}),!Ke.exported_to_qbo&&e.jsx(G,{variant:"contained",color:"success",startIcon:e.jsx(io,{}),disabled:Bn,onClick:te,children:Bn?"Exporting...":"Export to QuickBooks"}),s?.access_role!=="Sales and Purchase"&&e.jsx(G,{variant:"contained",color:"primary",onClick:Vs,children:"Reopen SO"})]})]})};return!r&&Et?e.jsxs(at,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(it,{}),e.jsx(h,{children:"Loading sales order..."})]}):!r&&cr?e.jsxs(at,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(We,{severity:"error",sx:{mb:2},children:cr}),e.jsx(G,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Retry"}),e.jsx(G,{variant:"outlined",onClick:()=>a("/open-sales-orders"),children:"Back to Sales Orders"})]}):!r&&Pe&&s?.access_role==="Sales and Purchase"?e.jsxs(at,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(We,{severity:"error",sx:{mb:2},children:"Access Denied: Sales and Purchase users cannot view closed sales orders."}),e.jsx(G,{variant:"outlined",onClick:()=>a("/open-sales-orders"),children:"Back to Sales Orders"})]}):!r&&Pe?Ge():e.jsxs(_n,{dateAdapter:ss,children:[e.jsx(Ii,{when:Sn,onSave:fs}),e.jsxs(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(h,{variant:"h4",component:"h1",children:r?"Create Sales Order":`Edit Sales Order${Ke?.sales_order_number?`: ${Ke.sales_order_number}`:""}`}),e.jsxs(ke,{direction:"row",spacing:1,children:[r&&e.jsx(G,{variant:"outlined",onClick:()=>{A(null),N(""),V($e()),Q(null),I(""),ue(""),ge(""),me(""),ae(""),$(""),re(""),Ce(""),lt(null),tt([{part_number:"",part_description:"",quantity:"",unit:Eo[0],unit_price:0,gst:Vn,line_amount:0}]),br(null)},children:"Reset"}),e.jsx(G,{variant:"contained",startIcon:e.jsx(as,{}),onClick:fs,children:r?"Save Sales Order":"Save Changes"}),!r&&e.jsxs(e.Fragment,{children:[s?.access_role!=="Sales and Purchase"&&e.jsx(G,{variant:"contained",startIcon:e.jsx(si,{}),onClick:Mi,children:"Close SO"}),e.jsx(G,{variant:"contained",startIcon:e.jsx(yr,{}),onClick:Y,children:"Download PDF"})]})]})]}),e.jsx(k,{sx:{mb:2},children:e.jsx(G,{variant:"outlined",color:"secondary",onClick:fe,children:"Import Line Items"})}),e.jsxs(mt,{open:ds,onClose:()=>zn(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:"Import Line Items from Sales Order"}),e.jsx(xt,{children:fo?e.jsx(k,{display:"flex",alignItems:"center",justifyContent:"center",minHeight:120,children:e.jsx(it,{})}):e.jsx($r,{options:mo,getOptionLabel:W=>{if(!W)return"";const F=W.sales_order_number||"",se=W.customer_name||"",oe=W.status||"";return`${F} - ${se}${oe?` (${oe})`:""}`},value:hn,onChange:(W,F)=>us(F),renderInput:W=>e.jsx(le,{...W,label:"Select Sales Order",fullWidth:!0}),isOptionEqualToValue:(W,F)=>W.sales_order_id===F?.sales_order_id})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>zn(!1),children:"Cancel"}),e.jsx(G,{onClick:de,disabled:!hn||fo,variant:"contained",children:"Import"})]})]}),go&&e.jsxs(We,{severity:"warning",sx:{mb:3},onClose:()=>br(null),children:[e.jsx(h,{variant:"body1",sx:{fontWeight:"medium"},children:"Inventory Error"}),e.jsx(h,{variant:"body2",children:go})]}),e.jsx(Ae,{sx:{p:3,mb:3,transform:Sr?`translateY(-${Sr}px)`:"none",transition:"transform 200ms ease"},elevation:3,children:e.jsxs(M,{container:!0,spacing:3,children:[e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx($r,{open:g,onOpen:()=>x(!0),onClose:()=>x(!1),autoHighlight:!0,value:D,onChange:(W,F)=>{if(ee){J(!1);return}F&&F.isNew?(en(!0),kn(b),A(null),N(""),x(!1)):(A(F),x(!1))},inputValue:b,onInputChange:(W,F,se)=>{if(N(F),R&&window.clearTimeout(R),se==="reset")return;if((F||"").trim().length>0){const ve=window.setTimeout(()=>x(!0),200);O(ve)}else x(!1)},options:i,filterOptions:(W,F)=>{const se=pw(W,F.inputValue||""),oe=!!Qr(F.inputValue||""),ve=[...se];return(F.inputValue||"").trim()!==""&&!oe&&ve.push({label:`Add "${F.inputValue}" as New Customer`,isNew:!0}),ve},getOptionLabel:W=>typeof W=="string"?W:W.label,isOptionEqualToValue:(W,F)=>W.id===F.id,renderOption:(W,F)=>{const se=F.isNew,{key:oe,...ve}=W;return e.jsxs("li",{...ve,style:{display:"flex",alignItems:"center",opacity:se?.9:1},children:[se&&e.jsx(Rn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),e.jsx("span",{children:F.label})]},oe)},renderInput:W=>e.jsx(le,{...W,label:"Customer",required:!0,onKeyDown:Te,onBlur:()=>{if(!D){const F=b.trim();if(F){const se=Qr(F);se&&(A(se),N(se.label))}}},inputRef:F=>{z.current=F}})})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Customer PO #",value:xe,onChange:W=>me(W.target.value),fullWidth:!0,placeholder:"Optional"})}),!o&&e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Quoted Price",type:"number",value:Qe??"",onChange:W=>lt(W.target.value?parseFloat(W.target.value):null),fullWidth:!0,InputProps:{startAdornment:e.jsx(pr,{position:"start",children:"$"})},inputProps:{onWheel:W=>W.currentTarget.blur()}})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Source Quote #",value:ct||"",placeholder:"Not converted from a quote",fullWidth:!0,InputProps:{readOnly:!0}})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx($r,{disablePortal:!0,open:y,onOpen:()=>S(!0),onClose:()=>S(!1),autoHighlight:!0,value:Z,onChange:(W,F)=>{if(F&&F.isNew){const se=F.inputValue?.toString?.()||X.trim();Fn(!0),$n(se),Q(null),I(""),S(!1)}else Q(F),S(!1)},inputValue:X,onInputChange:(W,F,se)=>{if(I(F),$n(F),U&&window.clearTimeout(U),se==="reset")return;if((F||"").trim().length>0){const ve=window.setTimeout(()=>S(!0),200);K(ve)}else S(!1)},options:u,filterOptions:(W,F)=>{const se=W.filter(oe=>oe.label.toLowerCase().includes((F.inputValue||"").toLowerCase()));return(F.inputValue||"")!==""&&!W.some(oe=>oe.label.toLowerCase()===(F.inputValue||"").toLowerCase())&&se.push({label:`Add "${F.inputValue}"`,isNew:!0,inputValue:F.inputValue}),se},getOptionLabel:W=>typeof W=="string"?W:W.label,renderInput:W=>e.jsx(le,{...W,label:"Product Name",required:!0,onKeyDown:Je,onBlur:()=>{if(S(!1),!Z){const F=X.trim();if(F){const se=u.find(oe=>oe.label.toLowerCase()===F.toLowerCase());se&&(Q(se),I(se.label))}}}}),disabled:!1})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"VIN #",value:he,onChange:W=>ae(W.target.value),fullWidth:!0,placeholder:"Optional",error:!!(he&&he.trim()!==""&&he.trim().length!==17),helperText:he&&he.trim()!==""&&he.trim().length!==17?"VIN must be 17 characters":""})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Make",value:T,onChange:W=>$(W.target.value),fullWidth:!0,placeholder:"Optional"})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Model",value:ce,onChange:W=>re(W.target.value),fullWidth:!0,placeholder:"Optional"})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsxs(Mt,{component:"fieldset",fullWidth:!0,children:[e.jsx(Gh,{sx:{mb:1},children:"Invoice"}),e.jsxs(Qh,{value:Me||null,exclusive:!0,fullWidth:!0,size:"small",color:"standard","aria-label":"Invoice status",onChange:Ye,sx:{"& .MuiToggleButtonGroup-grouped":{textTransform:"none",flex:1,gap:0},"& .MuiToggleButtonGroup-grouped:not(:first-of-type)":{marginLeft:0},"& .MuiToggleButtonGroup-grouped.Mui-selected":{color:"#fff"},"& .MuiToggleButtonGroup-grouped.Mui-selected.MuiToggleButton-colorError":{bgcolor:W=>W.palette.error.main,"&:hover":{bgcolor:W=>W.palette.error.dark}},"& .MuiToggleButtonGroup-grouped.Mui-selected.MuiToggleButton-colorSuccess":{bgcolor:W=>W.palette.success.main,"&:hover":{bgcolor:W=>W.palette.success.dark}}},children:[e.jsxs(rc,{value:"needed",color:"error",children:[e.jsx(El,{fontSize:"small",sx:{mr:1}}),"Needed"]}),e.jsxs(rc,{value:"done",color:"success",children:[e.jsx(qn,{fontSize:"small",sx:{mr:1}}),"Done"]})]})]})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(Ln,{label:"Sales Date",value:E,onChange:V,sx:{width:"100%"},slotProps:{textField:{required:!0}}})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Product Description",value:q,onChange:W=>ue(W.target.value),fullWidth:!0,multiline:!0,minRows:2,maxRows:6,sx:{mt:1}})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Terms",value:ye,onChange:W=>ge(W.target.value),fullWidth:!0,multiline:!0,minRows:3,maxRows:8,sx:{mt:1},placeholder:"Enter payment/delivery terms, etc."})})]})}),e.jsxs(k,{sx:{position:"relative",zIndex:1e3,transform:Sr?`translateY(-${Sr}px)`:"none",transition:"transform 200ms ease"},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"Line Items"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Each part number can only appear once. Edit existing line items to change quantities."})]}),e.jsxs(k,{sx:{position:"relative",mb:3},children:[!r&&nt.length>0&&e.jsx(k,{sx:{position:"absolute",bottom:"calc(100% + 8px)",left:0,right:0,zIndex:500,display:"flex",flexDirection:"column",gap:1,pointerEvents:"none"},children:nt.map((W,F)=>e.jsx(We,{severity:"warning",sx:{width:"100%",boxShadow:2,pointerEvents:"auto","& .MuiAlert-message":{width:"100%",padding:0}},children:e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",sx:{width:"100%"},children:[e.jsxs(k,{children:[e.jsxs(h,{variant:"body2",fontWeight:"medium",children:["Insufficient stock for ",W.partNumber]}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Excess quantity: ",W.excessQuantity," ",W.unit]})]}),e.jsxs(G,{variant:"contained",size:"small",sx:{whiteSpace:"nowrap"},onClick:()=>Er(W),children:["Transfer ",W.excessQuantity," to Parts to Order"]})]})},`${W.lineItemIndex}-${F}`))}),e.jsxs(mt,{open:!!er,onClose:()=>Er(null),maxWidth:"xs",fullWidth:!0,children:[e.jsx(ft,{children:"Transfer to Parts to Order"}),e.jsx(xt,{children:er&&e.jsxs(h,{variant:"body2",children:["Transfer ",er.excessQuantity," ",er.unit," of ",er.partNumber," to Parts to Order?"]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>Er(null),children:"Cancel"}),e.jsx(G,{variant:"contained",onClick:()=>{if(!er)return;const W=er,F=Ne[W.lineItemIndex],se=W.excessQuantity,oe=p.find(Ve=>Ve.part_number.toLowerCase()===F.part_number.toLowerCase()),ve={sales_order_id:Ke?.sales_order_id||0,part_number:F.part_number,part_description:F.part_description,quantity_to_order:String(se),unit:F.unit,unit_price:oe?.last_unit_cost||0,line_amount:(oe?.last_unit_cost||0)*se};pe(Ve=>[...Ve,ve]);const Oe=Math.max(0,(parseFloat(String(F.quantity).replace(/[^\d.-]/g,""))||0)-se);tt(Ve=>Ve.map((Re,Pt)=>Pt===W.lineItemIndex?{...Re,quantity:String(Oe)}:Re)),jt(Ve=>Ve.filter(Re=>Re.lineItemIndex!==W.lineItemIndex)),Er(null),H.success(`Transferred ${se} ${F.unit} of ${F.part_number} to parts to order`)},children:"Confirm"})]})]}),e.jsxs(Ae,{sx:{p:3,mb:3},elevation:3,children:[e.jsx(M,{container:!0,spacing:2,children:Ne.map((W,F)=>({item:W,originalIndex:F})).sort((W,F)=>{const se=["LABOUR","OVERHEAD","SUPPLY"].includes(W.item.part_number),oe=["LABOUR","OVERHEAD","SUPPLY"].includes(F.item.part_number);return se&&!oe?1:!se&&oe?-1:0}).map(({item:W,originalIndex:F})=>e.jsxs(It.Fragment,{children:[e.jsx(M,{item:!0,xs:12,sm:6,md:2.5,children:e.jsx($r,{open:un===F,onOpen:()=>Gt(F),onClose:()=>Gt(null),autoHighlight:!0,inputValue:W.part_number,onChange:(se,oe)=>{if(typeof oe=="string"){const ve=Ne.findIndex((Oe,Ve)=>Ve!==F&&Oe.part_number.trim().toLowerCase()===oe.trim().toLowerCase());if(ve!==-1){H.error(`Part "${oe}" already exists as line item ${ve+1}. Edit that line item instead.`),tt(Oe=>Oe.map((Ve,Re)=>Re===F?{...Ve,part_number:"",part_description:""}:Ve)),Gt(null);return}xn(F,oe),Gt(null)}else if(oe&&typeof oe=="object"&&"isNew"in oe){const ve=oe.inputValue||"";Yr(String(ve).toUpperCase()),ur(F),pt(!0),Gt(null)}},onInputChange:(se,oe,ve)=>{if(ve==="reset")return;const Oe=(oe||"").trim();if(tt(Ve=>Ve.map((Re,Pt)=>Pt===F?{...Re,part_number:Oe}:Re)),vr&&window.clearTimeout(vr),Oe.length>0){const Ve=window.setTimeout(()=>Gt(F),200);qr(Ve)}else Gt(null)},options:p.filter(se=>se.part_type!=="supply").map(se=>se.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,handleHomeEndKeys:!0,filterOptions:(se,oe)=>{const ve=(oe.inputValue||"").toUpperCase(),Oe=se.filter(Pt=>{const Ft=p.find(Cr=>Cr.part_number===Pt);return Ft?String(Pt).toUpperCase().includes(ve)||String(Ft.part_description||"").toUpperCase().includes(ve):String(Pt).toUpperCase().includes(ve)}),Ve=Oe.some(Pt=>String(Pt).toUpperCase()===ve),Re=[...Oe];return ve&&!Ve&&Re.push({label:`Add "${oe.inputValue}" as New Part`,isNew:!0,inputValue:oe.inputValue}),Re},renderOption:(se,oe)=>{const ve=typeof oe=="object"&&oe.isNew,Oe=typeof oe=="string"?oe:oe.label,{key:Ve,...Re}=se;return e.jsxs("li",{...Re,children:[ve&&e.jsx(Rn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof oe=="string"?e.jsxs(k,{children:[e.jsx(h,{variant:"body2",children:oe}),(()=>{const Pt=p.find(Ft=>Ft.part_number===oe);return Pt?.part_description?e.jsx(h,{variant:"caption",color:"text.secondary",children:Pt.part_description}):null})()]}):Oe]},Ve)},renderInput:se=>e.jsx(le,{...se,label:"Part Number",required:!0,fullWidth:!0,onKeyDown:oe=>Cn(F,oe),onBlur:()=>Gt(null)}),onBlur:()=>{const se=Ne[F]?.part_number?.trim().toUpperCase();if(!se)return;p.find(ve=>ve.part_number===se)?xn(F,se):(ur(F),Yr(se),pt(!0),Gt(null))}})}),e.jsx(M,{item:!0,xs:12,sm:6,md:2.5,children:e.jsx(le,{label:"Part Description",value:W.part_description,fullWidth:!0,required:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Qty",value:W.quantity,onChange:se=>Ai(F,"quantity",se.target.value),type:"number",fullWidth:!0,required:!0,InputProps:{readOnly:["SUPPLY","LABOUR","OVERHEAD"].includes(W.part_number),disabled:["SUPPLY","LABOUR","OVERHEAD"].includes(W.part_number)},inputProps:{step:1,onWheel:se=>se.target.blur()}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Avail",value:(()=>{const se=Ys[F];return se?se.available<0?`${se.available} (Insufficient)`:String(se.available):"N/A"})(),fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:(()=>{const se=Ys[F];return se?se.available>=0?"#e8f5e8":"#ffeaea":"#f5f5f5"})(),"& .MuiInputBase-input":{color:Ys[F]?.isNegative?"#d32f2f":"#2e7d32"}}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Unit",value:W.part_number==="SUPPLY"?"":W.unit,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(M,{item:!0,xs:12,sm:2,md:1.5,children:e.jsx(le,{label:"Unit Cost",value:W.part_number==="LABOUR"?v??0:W.part_number==="OVERHEAD"?_??0:W.part_number==="SUPPLY"?"":W.unit_price,type:"number",fullWidth:!0,InputProps:{readOnly:!0,startAdornment:W.part_number!=="SUPPLY"?e.jsx(pr,{position:"start",children:"$"}):void 0,disabled:["LABOUR","OVERHEAD","SUPPLY"].includes(W.part_number)}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Amount",value:W.line_amount!=null&&!isNaN(Number(W.line_amount))?Number(W.line_amount).toFixed(2):"0.00",InputProps:{readOnly:!0},fullWidth:!0})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1,sx:{display:"flex",alignItems:"center"},children:e.jsx(G,{variant:"outlined",color:"primary",onClick:()=>yo(F),fullWidth:!0,children:"Remove"})})]},F))}),e.jsx(k,{sx:{mt:2},children:e.jsx(G,{variant:"outlined",color:"primary",onClick:Bs,children:"Add Line Item"})})]})]}),e.jsx(Ae,{sx:{p:3,mb:3},elevation:3,children:e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsxs(h,{variant:"subtitle1",children:["Subtotal: ",Ar(Ct)]})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsxs(h,{variant:"subtitle1",children:["Total GST: ",Ar(qt)]})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsxs(h,{variant:"h6",children:["Total Amount: ",Ar(Bt)]})})]})}),!r&&e.jsxs(Ae,{sx:{p:3,mb:3,elevation:3,border:"2px solid #b8860b","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"#b8860b"},"&:hover fieldset":{borderColor:"#b8860b"}}},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Parts to Order"}),e.jsx(h,{variant:"body2",color:"textSecondary",sx:{mb:2},children:"Add parts that need to be ordered for this sales order. These quantities are aggregated across all sales orders."}),e.jsx(M,{container:!0,spacing:2,children:je.map((W,F)=>e.jsxs(It.Fragment,{children:[e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx($r,{open:hr===F,onOpen:()=>mr(F),onClose:()=>mr(null),autoHighlight:!0,value:W.part_number,onChange:(se,oe)=>{if(!oe){pe(ve=>{const Oe=[...ve];return Oe[F]={...Oe[F],part_number:"",part_description:"",unit:"Each",unit_price:0,line_amount:0},Oe});return}if(typeof oe=="string"){const ve=p.find(Oe=>Oe.part_number===oe);if(ve){const Oe=parseFloat(String(ve.last_unit_cost))||0,Ve=ms(Oe),Re=Oe*Ve;pe(Pt=>{const Ft=[...Pt];return Ft[F]={...Ft[F],part_number:ve.part_number,part_description:ve.part_description,unit:ve.unit||"Each",unit_price:Re,line_amount:0},Ft})}else{pe(Ve=>{const Re=[...Ve];return Re[F]={...Re[F],part_number:oe,part_description:"",unit:"Each",unit_price:0,line_amount:0},Re});const Oe=String(oe).toUpperCase();Tr(F),Wr(Oe),Ir(!0)}}else if(oe&&typeof oe=="object"&&"isNew"in oe){const ve=String(oe.inputValue||"").toUpperCase();Tr(F),Wr(ve),Ir(!0)}},onInputChange:(se,oe,ve)=>{if(pe(Ve=>{const Re=[...Ve];return Re[F]={...Re[F],part_number:(oe||"").toUpperCase()},Re}),vr&&window.clearTimeout(vr),ve==="reset")return;if((oe||"").trim().length>0){const Ve=window.setTimeout(()=>mr(F),200);qr(Ve)}else mr(null)},options:p.filter(se=>se.part_type!=="supply").map(se=>se.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,filterOptions:(se,oe)=>{const ve=(oe.inputValue||"").toUpperCase(),Oe=se.filter(Pt=>{const Ft=p.find(Cr=>Cr.part_number===Pt);return Ft?String(Pt).toUpperCase().includes(ve)||String(Ft.part_description||"").toUpperCase().includes(ve):String(Pt).toUpperCase().includes(ve)}),Ve=Oe.some(Pt=>String(Pt).toUpperCase()===ve),Re=[...Oe];return ve&&!Ve&&Re.push({label:`Add "${oe.inputValue}" as New Part`,isNew:!0,inputValue:oe.inputValue}),Re},renderOption:(se,oe)=>{const ve=typeof oe=="object"&&oe.isNew,Oe=typeof oe=="string"?oe:oe.label,{key:Ve,...Re}=se;return e.jsxs("li",{...Re,children:[ve&&e.jsx(Rn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof oe=="string"?e.jsxs(k,{children:[e.jsx(h,{variant:"body2",children:oe}),(()=>{const Pt=p.find(Ft=>Ft.part_number===oe);return Pt?.part_description?e.jsx(h,{variant:"caption",color:"text.secondary",children:Pt.part_description}):null})()]}):Oe]},Ve)},renderInput:se=>e.jsx(le,{...se,label:"Part Number",fullWidth:!0,required:!0,onKeyDown:oe=>is(F,oe),onBlur:()=>mr(null)}),onBlur:()=>{const se=(je[F]?.part_number||"").trim().toUpperCase();if(!se)return;p.find(ve=>ve.part_number===se)||(Tr(F),Wr(se),Ir(!0),mr(null))}})}),e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(le,{label:"Description",value:W.part_description,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#f5f5f5"}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Qty to Order",value:W.quantity_to_order,onChange:se=>{const oe=se.target.value;pe(ve=>{const Oe=[...ve],Ve=parseFloat(oe)||0,Re=Oe[F].unit_price||0;return Oe[F]={...Oe[F],quantity_to_order:oe,line_amount:Ve*Re},Oe})},type:"number",fullWidth:!0,required:!0,inputProps:{step:1,min:0,onWheel:se=>se.target.blur()}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Unit",value:W.unit,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(M,{item:!0,xs:12,sm:1.5,children:e.jsx(le,{label:"Unit Price",value:W.unit_price,type:"number",fullWidth:!0,InputProps:{readOnly:!0,startAdornment:e.jsx(pr,{position:"start",children:"$"})},sx:{backgroundColor:"#f5f5f5"}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Amount",value:W.line_amount,InputProps:{readOnly:!0},fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,sm:1,md:1,sx:{display:"flex",alignItems:"center",gap:2},children:e.jsx(G,{variant:"outlined",onClick:()=>pe(se=>se.filter((oe,ve)=>ve!==F)),sx:{flexShrink:0,borderColor:"#b8860b",color:"#b8860b","&:hover":{borderColor:"#8b6914",backgroundColor:"#fff8dc"}},children:"Remove"})})]},F))}),e.jsx(k,{sx:{mt:2},children:e.jsx(G,{variant:"outlined",color:"primary",onClick:()=>pe(W=>[...W,{sales_order_id:Number(t)||0,part_number:"",part_description:"",quantity_to_order:"",unit:"Each",unit_price:0,line_amount:0}]),children:"Add Parts to Order Item"})})]}),e.jsx(Si,{open:ls,onClose:()=>en(!1),onSave:async W=>{try{const F=await B.post("/api/customers",W),se={label:W.customer_name,id:F.data.customer_id};c(oe=>[...oe,se]),A(se),en(!1),H.success("Customer added successfully!")}catch{H.error("Failed to add customer.")}},initialCustomer:{customer_name:cs},isEditMode:!1}),e.jsx(Jl,{open:ho,onClose:()=>Fn(!1),onSave:async W=>{try{const F=await B.post("/api/products",W),se={label:W.product_name,id:F.data.product_id,description:W.product_name};d(oe=>[...oe,se]),Q(se),I(se.label),Fn(!1),$n(""),H.success("Product added successfully!")}catch{H.error("Failed to add product.")}},initialProduct:{product_name:zs||X},isEditMode:!1}),!r&&e.jsxs(e.Fragment,{children:[Hn&&e.jsx(We,{severity:"error",sx:{mb:2},onClose:()=>mn(null),children:Hn}),e.jsx(bn,{open:!!_e,autoHideDuration:6e3,onClose:()=>be(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(We,{onClose:()=>be(null),severity:"success",sx:{width:"100%"},children:_e})}),!Ke?.exported_to_qbo&&Ke?.status?.toLowerCase()==="closed"&&e.jsxs(k,{display:"flex",justifyContent:"flex-end",gap:2,mb:2,children:[e.jsx(G,{variant:"contained",color:"success",startIcon:e.jsx(io,{}),disabled:Bn,onClick:te,children:Bn?"Exporting...":"Export to QuickBooks"}),s?.access_role!=="Sales and Purchase"&&e.jsx(G,{variant:"outlined",onClick:Vs,children:"Reopen SO"})]})]})]}),e.jsx(ts,{open:rt,onClose:()=>{pt(!1),ur(null),Yr("")},onSave:async W=>{const F=await B.post("/api/inventory",W),se=await B.get("/api/inventory");f(se.data);const oe=F.data.item;Qt!==null&&tt(ve=>{const Oe=[...ve],Ve=parseFloat(String(oe.last_unit_cost))||0,Re=ms(Ve),Pt=Ve*Re;return Oe[Qt]={...Oe[Qt],part_number:oe.part_number,part_description:oe.part_description,unit:oe.unit||Oe[Qt].unit,unit_price:Pt},Oe})},title:"Add New Part",initialPart:{part_number:Hr.toUpperCase(),category:"Uncategorized"}}),e.jsx(ts,{open:Ur,onClose:()=>{Ir(!1),Tr(null),Wr("")},onSave:async W=>{const F=await B.post("/api/inventory",W),se=await B.get("/api/inventory");f(se.data);const oe=F.data.item;wr!==null&&pe(ve=>{const Oe=[...ve],Ve=parseFloat(String(oe.last_unit_cost))||0,Re=ms(Ve),Pt=Ve*Re;return Oe[wr]={...Oe[wr],part_number:oe.part_number,part_description:oe.part_description,unit:oe.unit||"Each",unit_price:Pt},Oe})},title:"Add New Part",initialPart:{part_number:Gr.toUpperCase(),category:"Uncategorized"}})]})},Zd=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(!0),[s,o]=l.useState(""),[i,c]=l.useState("open"),[u,d]=l.useState({page:0,pageSize:10}),p=Kt();cn();const{user:f}=Zt(),m=async()=>{a(!0);try{const L=(await B.get("/api/purchase-history",{params:{status:i,searchTerm:s||void 0}})).data.sort((C,D)=>{const A=g=>{const x=g.match(/\d+/);return x?parseInt(x[0],10):0},b=A(C.purchase_number);return A(D.purchase_number)-b});r(L)}catch(P){console.error("Error fetching purchase orders:",P),r([]),H.error("Failed to fetch purchase orders")}finally{a(!1)}};l.useEffect(()=>{m()},[i,s]);const j=P=>{window.confirm("Are you sure you want to delete this purchase order?")&&v(P)},v=async P=>{try{await B.delete(`/api/purchase-orders/${P}`),H.success("Purchase order deleted successfully"),m()}catch(L){console.error("Error deleting purchase order:",L),H.error("Failed to delete purchase order")}},w=()=>{let P=t;i==="open"?P=t.filter(A=>A.status==="Open"):i==="closed"&&(P=t.filter(A=>A.status==="Closed"));const L=Wn.unparse(P),C=new Blob([L],{type:"text/csv;charset=utf-8;"}),D=document.createElement("a");D.href=URL.createObjectURL(C),D.download=`purchase_orders_${$e().format("YYYY-MM-DD")}.csv`,D.click()},_=[{field:"purchase_number",headerName:"Purchase #",flex:1,minWidth:120,valueFormatter:P=>P.value?String(P.value).replace("PO-",""):""},{field:"vendor_name",headerName:"Vendor",flex:1.3,minWidth:150},{field:"created_at",headerName:"Created On",flex:.9,minWidth:130,valueFormatter:P=>P.value?new Date(P.value).toLocaleDateString():""},{field:"bill_number",headerName:"Bill #",flex:.9,minWidth:100},{field:"subtotal",headerName:"Subtotal",flex:.8,minWidth:100,valueFormatter:P=>P.value!=null&&!isNaN(Number(P.value))?`$${Number(P.value).toFixed(2)}`:"$0.00"},{field:"gst_rate",headerName:"GST Rate (%)",flex:.7,minWidth:80,valueFormatter:P=>P.value!=null&&!isNaN(Number(P.value))?`${Number(P.value).toFixed(2)}%`:"5.00%"},{field:"total_gst_amount",headerName:"GST",flex:.7,minWidth:80,valueFormatter:P=>P.value!=null&&!isNaN(Number(P.value))?`$${Number(P.value).toFixed(2)}`:"$0.00"},{field:"total_amount",headerName:"Total",flex:.8,minWidth:100,valueFormatter:P=>P.value!=null&&!isNaN(Number(P.value))?`$${Number(P.value).toFixed(2)}`:"$0.00"},{field:"status",headerName:"Status",flex:.8,minWidth:100,renderCell:P=>e.jsx(De,{label:P.value,color:P.value==="Open"?"success":"error",size:"small",variant:"outlined"})},{field:"return_summary",headerName:"Returns",flex:.9,minWidth:150,sortable:!1,renderCell:P=>{const L=P.row.return_requested_count??0,C=P.row.return_returned_count??0;return!L&&!C?e.jsx(h,{variant:"body2",color:"text.secondary",children:"None"}):e.jsxs(ke,{direction:"row",spacing:1,children:[L>0&&e.jsx(De,{label:`Requested ${L}`,color:"warning",size:"small",variant:"outlined"}),C>0&&e.jsx(De,{label:`Returned ${C}`,color:"success",size:"small",variant:"outlined"})]})}},{field:"qbo_exported",headerName:"QBO Exported",flex:.8,minWidth:120,renderCell:P=>P.row.exported_to_qbo?e.jsx(qn,{color:"success",titleAccess:"Exported to QuickBooks"}):P.row.qbo_export_status?e.jsx(Ti,{color:"error",titleAccess:`QBO Export Error: ${P.row.qbo_export_status}`}):P.row.status==="Closed"?e.jsx(Yl,{color:"warning",titleAccess:"Not exported to QuickBooks"}):null},{field:"actions",headerName:"Actions",width:100,sortable:!1,renderCell:P=>e.jsx(k,{sx:{display:"flex",gap:.5},children:P.row.status!=="Closed"&&e.jsx(gt,{size:"small",color:"error",onClick:L=>{L.stopPropagation(),j(P.row.purchase_id)},children:e.jsx(gr,{})})})}];return e.jsx(at,{maxWidth:"xl",sx:{mt:4},children:e.jsxs(k,{sx:{mb:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:i==="open"?"Open Purchase Orders":i==="closed"?"Purchase Order History":"All Purchase Orders"}),e.jsxs(ke,{direction:"row",spacing:2,sx:{mb:2,justifyContent:"flex-end"},children:[e.jsx(G,{variant:"contained",startIcon:e.jsx(Lr,{}),onClick:()=>p("/open-purchase-orders/new"),children:"New PO"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(yr,{}),onClick:w,children:"Export CSV"})]}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsxs(ke,{direction:"row",spacing:3,sx:{mb:3},children:[e.jsx(le,{label:"Search",variant:"outlined",value:s,onChange:P=>o(P.target.value),InputProps:{startAdornment:e.jsx(pr,{position:"start",children:e.jsx(Br,{sx:{fontSize:32}})}),sx:{fontSize:22,height:56}},sx:{minWidth:340,maxWidth:400,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"medium"}),e.jsx(De,{label:"All",onClick:()=>c("all"),color:i==="all"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),e.jsx(De,{label:"Open",onClick:()=>c("open"),color:i==="open"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),e.jsx(De,{label:"Closed",onClick:()=>c("closed"),color:i==="closed"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}})]}),e.jsx(Jr,{rows:t,columns:_,loading:n,paginationModel:u,onPaginationModelChange:d,pageSizeOptions:[10,25,50],getRowId:P=>P.purchase_id,disableRowSelectionOnClick:!0,initialState:{sorting:{sortModel:[{field:"purchase_number",sort:"desc"}]}},onRowClick:P=>{const L=P.row.status?.toLowerCase();p(L==="closed"?`/purchase-order/${P.row.purchase_id}`:`/open-purchase-orders/${P.row.purchase_id}`)},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"},cursor:"pointer"}})]})})]})})};var Ra={},eu;function mw(){if(eu)return Ra;eu=1;var t=yt();Object.defineProperty(Ra,"__esModule",{value:!0}),Ra.default=void 0;var r=t(bt()),n=vt();return Ra.default=(0,r.default)((0,n.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"}),"ArrowBack"),Ra}var fw=mw();const po=st(fw),xw=async t=>{const r=new FormData;return r.append("document",t),(await B.post("/api/purchase-orders/ocr/upload",r,{headers:{"Content-Type":"multipart/form-data"}})).data};var Na={},tu;function gw(){if(tu)return Na;tu=1;var t=yt();Object.defineProperty(Na,"__esModule",{value:!0}),Na.default=void 0;var r=t(bt()),n=vt();return Na.default=(0,r.default)((0,n.jsx)("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),Na}var yw=gw();const vw=st(yw);var La={},ru;function bw(){if(ru)return La;ru=1;var t=yt();Object.defineProperty(La,"__esModule",{value:!0}),La.default=void 0;var r=t(bt()),n=vt();return La.default=(0,r.default)((0,n.jsx)("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess"),La}var _w=bw();const jw=st(_w),ww=({open:t,onClose:r,purchaseOrderId:n,onSuccess:a,onAllocationSaved:s})=>{const[o,i]=l.useState(!1),[c,u]=l.useState(!1),[d,p]=l.useState(null),[f,m]=l.useState({}),[j,v]=l.useState({}),[w,_]=l.useState({}),[P,L]=l.useState(new Set),[C,D]=l.useState(new Set),[A,b]=l.useState(""),[N,g]=l.useState([]);l.useEffect(()=>{t&&n&&(p(null),m({}),v({}),_({}),L(new Set),g([]),D(new Set),b(""),x())},[t,n]);const x=async()=>{i(!0);try{const V=(await B.get(`/api/purchase-history/${n}/allocation-suggestions`)).data;console.log("Allocation suggestions data:",V),console.log("Number of suggestions:",V.suggestions?.length),V.suggestions?.forEach((me,he)=>{console.log(`Suggestion ${he}: ${me.part_number} - ${me.allocation_suggestions?.length} sales orders`),me.allocation_suggestions?.forEach((ae,T)=>{console.log(`  Allocation ${T}: SO ${ae.sales_order_number}, current_quantity_needed: ${ae.current_quantity_needed}, is_needed: ${ae.is_needed}`)})});const q=new Set,ue=[];for(const me of V.suggestions||[])try{console.log(`Checking part type for: ${me.part_number}`);const he=await yb(me.part_number);console.log(`Part info for ${me.part_number}:`,he),he.part_type==="supply"?(q.add(me.part_number),console.log(`Filtering out supply part: ${me.part_number}`)):(console.log(`Including stock part: ${me.part_number} (type: ${he.part_type})`),ue.push(me))}catch(he){console.warn(`Could not determine part type for ${me.part_number}, including it:`,he),ue.push(me)}L(q),console.log(`Filtering summary: ${q.size} supply parts filtered out, ${ue.length} stock parts remaining`),console.log("Supply parts filtered:",Array.from(q)),console.log("Stock parts included:",ue.map(me=>me.part_number));const ye={...V,suggestions:ue};p(ye);let ge={},xe={};try{const he=(await B.get(`/api/purchase-history/${n}/allocations`)).data||[],ae={};for(const T of he){const $=String(T.part_number).toUpperCase();ae[$]||(ae[$]={}),ae[$][T.sales_order_id]=Number(T.allocate_qty)||0}ge={},xe={},ue.forEach(T=>{const $=T.part_number,ce=ae[$]||{},re={};T.allocation_suggestions.forEach(Ce=>{const Ye=ce[Ce.sales_order_id];re[Ce.sales_order_id]=typeof Ye=="number"?Ye:Ce.suggested_alloc}),ge[$]=re;const Me=Object.values(re).reduce((Ce,Ye)=>Ce+(Number(Ye)||0),0);xe[$]=Math.max(0,T.quantity_ordered-Me)})}catch{ge={},xe={},ue.forEach(he=>{ge[he.part_number]={},he.allocation_suggestions.forEach(T=>{ge[he.part_number][T.sales_order_id]=T.suggested_alloc});const ae=Object.values(ge[he.part_number]).reduce((T,$)=>T+(Number($)||0),0);xe[he.part_number]=Math.max(0,he.quantity_ordered-ae)})}m(ge),v(xe),D(new Set),g([])}catch(E){console.error("Error fetching allocation suggestions:",E),H.error("Failed to load allocation suggestions")}finally{i(!1)}},R=(E,V,q)=>{if(!d)return{valid:!0};const ue=d.suggestions.find(ce=>ce.part_number===E);if(!ue)return{valid:!0};const ye=ue.allocation_suggestions.find(ce=>ce.sales_order_id===V);if(!ye)return{valid:!0};const ge=ye.current_quantity_needed,xe=ue.quantity_ordered,me=ue.allocation_suggestions.filter(ce=>ce.is_needed).reduce((ce,re)=>ce+re.current_quantity_needed,0),he=xe>=me,ae=S(E),T=f[E]?.[V]||0,$=xe-(ae-T);return q>$?{valid:!1,message:`Cannot allocate more than ${$} units (exceeds ordered quantity)`}:he&&ye.is_needed&&q<ge?{valid:!1,message:`Cannot allocate less than ${ge} units when surplus exists`}:!he&&ye.is_needed&&q<ge?{valid:!0,warning:`Allocating ${q} units but ${ge} units are needed for quantity to order`}:{valid:!0}},O=(E,V,q)=>{const ue=Math.max(0,q),ye=R(E,V,ue);if(!ye.valid){H.error(ye.message);return}ye.warning&&H.warning(ye.warning),m(ge=>{const xe={...ge,[E]:{...ge[E],[V]:ue}};if(d){const me=d.suggestions.find(he=>he.part_number===E);if(me){const he=xe[E]||{},ae=Object.values(he).reduce(($,ce)=>$+ce,0),T=Math.max(0,me.quantity_ordered-ae);v($=>({...$,[E]:T}))}}return xe})},ee=E=>{if(!d)return;const V=d.suggestions.find(he=>he.part_number===E);if(!V)return;const q=V.quantity_ordered,ue=V.allocation_suggestions.filter(he=>he.is_needed).reduce((he,ae)=>he+ae.current_quantity_needed,0),ye=q>=ue,ge=V.allocation_suggestions.filter(he=>he.is_needed).sort((he,ae)=>he.sales_order_number.localeCompare(ae.sales_order_number)),xe={};let me=q;if(ye){for(const he of ge){const ae=he.current_quantity_needed,T=Math.min(ae,me);T>0&&(xe[he.sales_order_id]=T,me-=T)}if(me>0)for(const he of V.allocation_suggestions){if(me<=0)break;const ae=xe[he.sales_order_id]||0,T=Math.min(me,1);xe[he.sales_order_id]=ae+T,me-=T}}else for(const he of ge){if(me<=0)break;const ae=he.current_quantity_needed,T=Math.min(ae,me);T>0&&(xe[he.sales_order_id]=T,me-=T)}m(he=>({...he,[E]:xe})),v(he=>({...he,[E]:me}))},J=()=>{d&&d.suggestions.forEach(E=>{ee(E.part_number)})},z=(E,V)=>{D(q=>{const ue=new Set(q);return V?ue.add(E):ue.delete(E),ue})},Z=E=>{if(!d){D(new Set);return}D(E?new Set(d.suggestions.map(V=>V.part_number)):new Set)},Q=l.useMemo(()=>{if(!d)return[];const E=new Map;return d.suggestions.forEach(V=>{V.allocation_suggestions.forEach(q=>{E.has(q.sales_order_id)||E.set(q.sales_order_id,{id:q.sales_order_id,label:q.sales_order_number,customer:q.customer_name})})}),Array.from(E.values()).sort((V,q)=>V.label.localeCompare(q.label))},[d]),X=()=>{if(!d)return;const E=Array.from(C);if(E.length===0){H.error("Select at least one part to allocate.");return}if(A===""){H.error("Select a sales order to allocate the selected parts.");return}const V={...f},q={...j};E.forEach(ue=>{const ye=d.suggestions.find(me=>me.part_number===ue);if(!ye)return;const ge={};ye.allocation_suggestions.forEach(me=>{ge[me.sales_order_id]=me.sales_order_id===A?ye.quantity_ordered:0}),V[ue]=ge;const xe=Object.values(ge).reduce((me,he)=>me+(Number(he)||0),0);q[ue]=Math.max(0,ye.quantity_ordered-xe)}),m(V),v(q),H.success("Selected parts allocated to the chosen sales order.")},I=()=>{const E=[];return d?(d.suggestions.forEach(V=>{const q=V.part_number,ue=V.quantity_ordered,ye=f[q]||{},ge=Object.values(ye).reduce((he,ae)=>he+ae,0);ge>ue&&E.push(`Total allocation (${ge}) exceeds ordered quantity (${ue}) for part ${q}`);const xe=V.allocation_suggestions.filter(he=>he.is_needed).reduce((he,ae)=>he+ae.current_quantity_needed,0);if(ue>=xe){for(const he of V.allocation_suggestions)if(he.is_needed){const ae=ye[he.sales_order_id]||0,T=he.current_quantity_needed;ae<T&&E.push(`Sales order ${he.sales_order_number} must receive at least ${T} units when surplus exists`)}}}),g(E),E.length===0):!1},y=async()=>{if(I()){u(!0);try{const E=[];for(const[q,ue]of Object.entries(f))for(const[ye,ge]of Object.entries(ue))ge>0&&E.push({sales_order_id:parseInt(ye),part_number:q,allocate_qty:ge});const V=await B.post(`/api/purchase-history/${n}/save-allocations`,{allocations:E,surplusPerPart:j});H.success("Allocations saved successfully"),s&&s(),r()}catch(E){console.error("Error saving allocations:",E);const V=E.response?.data?.error||"Failed to save allocations";H.error(V)}finally{u(!1)}}},S=E=>{const V=f[E]||{};return Object.values(V).reduce((q,ue)=>q+ue,0)},U=E=>{if(!d)return 0;const V=d.suggestions.find(ue=>ue.part_number===E);if(!V)return 0;const q=S(E);return V.quantity_ordered-q},K=E=>{_(V=>({...V,[E]:!V[E]}))};return o?e.jsxs(mt,{open:t,onClose:r,maxWidth:"lg",fullWidth:!0,children:[e.jsx(ft,{children:"Loading Allocation Suggestions..."}),e.jsx(xt,{children:e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"200px",children:e.jsx(it,{})})})]}):e.jsxs(mt,{open:t,onClose:r,maxWidth:"lg",fullWidth:!0,children:[e.jsxs(ft,{children:["Allocate Purchase Order: ",d?.purchase_order_number]}),e.jsxs(xt,{children:[d&&d.suggestions.length>0&&e.jsxs(Ae,{sx:{mb:3,p:2,backgroundColor:"grey.50"},children:[e.jsxs(h,{variant:"h6",gutterBottom:!0,children:["Purchase Order Summary (",d.suggestions.length," parts)"]}),e.jsx(k,{display:"flex",flexWrap:"wrap",gap:1,children:d.suggestions.map((E,V)=>e.jsx(De,{label:`${E.part_number}: ${E.quantity_ordered} ordered`,color:"primary",variant:"outlined",size:"small"},`${E.part_number}-${V}`))})]}),P.size>0&&e.jsxs(We,{severity:"info",sx:{mb:2},children:[e.jsxs(h,{variant:"body2",children:[e.jsx("strong",{children:"Note:"})," ",P.size," supply part",P.size>1?"s":""," ",P.size>1?"have":"has"," been filtered out from allocation. Supply parts are not tracked for inventory allocation."]}),e.jsx(k,{mt:1,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Filtered parts: ",Array.from(P).join(", ")]})})]}),N.length>0&&e.jsxs(We,{severity:"error",sx:{mb:2},children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:"Please correct the following errors:"}),N.map((E,V)=>e.jsxs(h,{variant:"body2",children:[" ",E]},V))]}),d&&d.suggestions.length>0&&e.jsx(Ae,{sx:{mb:3,p:2},variant:"outlined",children:e.jsxs(ke,{direction:{xs:"column",md:"row"},spacing:2,alignItems:{xs:"flex-start",md:"center"},children:[e.jsxs(k,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(vn,{control:e.jsx(on,{checked:C.size===d.suggestions.length&&d.suggestions.length>0,indeterminate:C.size>0&&C.size<d.suggestions.length,onChange:E=>Z(E.target.checked)}),label:"Select all parts"}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:[C.size," selected"]})]}),e.jsxs(Mt,{size:"small",sx:{minWidth:220},children:[e.jsx(Ut,{id:"bulk-sales-order-label",children:"Sales Order"}),e.jsxs(Wt,{labelId:"bulk-sales-order-label",label:"Sales Order",value:A,onChange:E=>b(E.target.value),displayEmpty:!0,children:[e.jsx(et,{value:"",children:e.jsx("em",{children:"Select sales order"})}),Q.map(E=>e.jsxs(et,{value:E.id,children:[E.label,"  ",E.customer]},E.id))]})]}),e.jsx(G,{variant:"contained",onClick:X,disabled:C.size===0||A==="",children:"Allocate selected parts to sales order"})]})}),d?.suggestions.length===0?e.jsx(We,{severity:"info",sx:{mb:2},children:e.jsx(h,{variant:"body1",children:"No parts found in this purchase order to allocate."})}):d?.suggestions.map((E,V)=>e.jsxs(Ae,{sx:{mb:2,p:2},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(k,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(on,{checked:C.has(E.part_number),onChange:q=>z(E.part_number,q.target.checked),inputProps:{"aria-label":`Select part ${E.part_number}`}}),e.jsx(gt,{size:"small",onClick:()=>K(E.part_number),sx:{p:.5},children:w[E.part_number]?e.jsx(jw,{}):e.jsx(vw,{})}),e.jsxs(h,{variant:"h6",children:[E.part_number," - ",E.part_description]})]}),e.jsxs(k,{display:"flex",gap:1,alignItems:"center",children:[e.jsx(De,{label:`Ordered: ${E.quantity_ordered}`,color:"primary",variant:"outlined",size:"small"}),e.jsx(De,{label:`Total Needed: ${E.total_needed}`,color:"secondary",variant:"outlined",size:"small"}),e.jsx(De,{label:`Remaining: ${U(E.part_number)}`,color:U(E.part_number)<0?"error":"default",variant:"outlined",size:"small"}),e.jsx(G,{variant:"outlined",size:"small",onClick:()=>ee(E.part_number),children:"Auto Allocate (FIFO)"})]})]}),e.jsx($u,{in:w[E.part_number],children:e.jsx(k,{mt:2,children:e.jsx(lr,{children:e.jsxs(nr,{size:"small",children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Sales Order"}),e.jsx(ne,{children:"Customer"}),e.jsx(ne,{children:"Date"}),e.jsx(ne,{align:"right",children:"Quantity to Order"}),e.jsx(ne,{align:"right",children:"Allocate Qty"}),e.jsx(ne,{children:"Status"})]})}),e.jsx(ar,{children:E.allocation_suggestions.map(q=>(console.log(`Rendering allocation for SO ${q.sales_order_number}: current_quantity_needed = ${q.current_quantity_needed}, is_needed = ${q.is_needed}`),e.jsxs(ht,{sx:{backgroundColor:q.is_needed?"warning.light":"grey.50","&:hover":{backgroundColor:q.is_needed?"warning.main":"grey.100"},borderLeft:q.is_needed?"4px solid #ff9800":"4px solid transparent"},children:[e.jsx(ne,{children:e.jsx(h,{variant:"body2",fontWeight:"medium",children:q.sales_order_number})}),e.jsx(ne,{children:q.customer_name}),e.jsx(ne,{children:new Date(q.sales_date).toLocaleDateString()}),e.jsx(ne,{align:"right",children:e.jsx(h,{variant:"body2",color:"black",fontWeight:q.is_needed?"bold":"normal",children:q.current_quantity_needed||0})}),e.jsx(ne,{align:"right",children:e.jsx(le,{type:"number",value:f[E.part_number]?.[q.sales_order_id]||0,onChange:ue=>{const ye=parseFloat(ue.target.value)||0;O(E.part_number,q.sales_order_id,ye)},onBlur:ue=>{const ye=parseFloat(ue.target.value)||0,ge=S(E.part_number),xe=f[E.part_number]?.[q.sales_order_id]||0,me=E.quantity_ordered-(ge-xe);ye>me&&O(E.part_number,q.sales_order_id,me)},size:"small",sx:{width:80},inputProps:{min:0,step:1,max:E.quantity_ordered}})}),e.jsx(ne,{children:e.jsx(De,{label:q.is_needed?"Needs Part":"No Need",color:q.is_needed?"warning":"default",size:"small",variant:"outlined"})})]},`${E.part_number}-${q.sales_order_id}`)))})]})})})}),e.jsxs(k,{mt:2,display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(h,{variant:"body2",children:["Total Allocated: ",S(E.part_number)]}),e.jsxs(k,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(h,{variant:"body2",children:"Surplus to Stock:"}),e.jsx(le,{type:"number",value:j[E.part_number]||0,disabled:!0,size:"small",sx:{width:80},inputProps:{min:0,step:1}})]})]})]},`${E.part_number}-${V}`))]}),e.jsxs(_t,{children:[e.jsx(G,{onClick:r,disabled:c,children:"Cancel"}),e.jsx(G,{onClick:J,variant:"outlined",disabled:c,sx:{mr:"auto"},children:"Auto Allocate All (FIFO)"}),e.jsx(G,{onClick:y,variant:"contained",disabled:c||N.length>0,children:c?e.jsx(it,{size:20}):"Save Allocations"})]})]})},Il=(t,r)=>{const n=parseFloat(String(t))||0,a=parseFloat(String(r))||0;return Math.round(n*a*100)/100},Sw=(t,r=5)=>{const n=t.reduce((o,i)=>{const c=Il(i.quantity,i.unit_cost);return o+c},0),a=n*(r/100),s=n+a;return{subtotal:Math.round(n*100)/100,total_gst_amount:Math.round(a*100)/100,total_amount:Math.round(s*100)/100}},Cw=(t,r=!1)=>{const n={};t.part_number?.trim()||(n.part_number="Part Number is required"),t.part_description?.trim()||(n.part_description="Part Description is required");const a=parseFloat(String(t.quantity));if((isNaN(a)||a<=0)&&(n.quantity="Quantity must be greater than 0"),r){const s=parseFloat(String(t.unit_cost));(isNaN(s)||s<=0)&&(n.unit_cost="Unit Cost must be greater than 0")}return n},kw=(t,r,n=!1)=>{const a={};r||(a.vendor="Vendor is required");const s=t.map(i=>Cw(i,n));return s.some(i=>Object.keys(i).length>0)&&(a.lineItems=s),a},vs=t=>{const r=parseFloat(String(t));return isNaN(r)?0:r},yn=["Each","cm","ft","kg","pcs","L"],nu=5,su=()=>{const{id:t}=wn(),r=Kt(),{user:n}=Zt(),a=t==="new";console.log("Is creation mode:",a,"ID:",t);const[s,o]=l.useState(null),[i,c]=l.useState(null),[u,d]=l.useState($e()),[p,f]=l.useState(""),[m,j]=l.useState([]),v=wi(m,300),[w,_]=l.useState([]),[P,L]=l.useState("Open"),[C,D]=l.useState(!1),[A,b]=l.useState(nu),[N,g]=l.useState({}),[x,R]=l.useState(0),[O,ee]=l.useState([]),[J,z]=l.useState(""),Z=l.useRef(null),[Q,X]=l.useState(!1),[I,y]=l.useState(null),[S,U]=l.useState(null),[K,E]=l.useState(!1),[V,q]=l.useState([]),[ue,ye]=l.useState({}),[ge,xe]=l.useState(null),[me,he]=l.useState(null),[ae,T]=l.useState(!1),[$,ce]=l.useState(null),re=l.useRef(null),[Me,Ce]=l.useState(!0),[Ye,Qe]=l.useState(!1),[lt,ct]=l.useState(null),[ut,Ne]=l.useState(""),[tt,Be]=l.useState(void 0),[Ct,qt]=l.useState("manual"),[Bt,Ke]=l.useState([]),[Yt,Et]=l.useState(null),[zt,cr]=l.useState(null),[jr,_e]=l.useState(null),[be,je]=l.useState({}),[pe,Ee]=l.useState({});l.useMemo(()=>Kh(),[]);const[Fe,ze]=l.useState(null),[Ze,ot]=l.useState(!1),[St,Ht]=l.useState(null),[dr,dn]=l.useState(""),[Sn,Pe]=l.useState(!1),[Ie,Le]=l.useState(!1),nt=async()=>{try{console.log("Fetching aggregate quantities...");const Y=new AbortController,te=setTimeout(()=>Y.abort(),1e4),ie=await B.get("/api/sales-orders/parts-to-order/all",{signal:Y.signal});clearTimeout(te);const{aggregatedParts:fe}=ie.data;if(console.log("Full API response:",ie.data),console.log("Aggregated parts response:",fe),fe&&fe.length>0){const de={};fe.forEach(Te=>{const Je=typeof Te.total_quantity_needed=="string"?parseFloat(Te.total_quantity_needed):Te.total_quantity_needed;de[Te.part_number.toUpperCase()]=Je}),console.log("Calculated quantities:",de),g(de),_(Te=>{const Je=Te.map(Ge=>({...Ge,quantity_to_order:de[Ge.part_number]||0}));return console.log("Updated line items with quantities:",Je),Je})}else console.log("No aggregated parts found, clearing quantities"),g({}),_(de=>de.map(Te=>({...Te,quantity_to_order:0})))}catch(Y){console.error("Error fetching aggregate quantities:",Y),Y.name==="AbortError"&&console.error("Request timed out"),g({}),_(te=>te.map(ie=>({...ie,quantity_to_order:0})))}},jt=async()=>{if(console.log("fetchData called. ID:",t),a)try{console.log(" Fetching vendors and inventory for creation mode...");const Y=new AbortController,te=setTimeout(()=>Y.abort(),15e3),[ie,fe]=await Promise.all([B.get("/api/vendors",{signal:Y.signal}),B.get("/api/inventory",{signal:Y.signal})]);clearTimeout(te),console.log(" Vendors and inventory fetched successfully"),console.log("Raw vendors data:",ie.data);const de=ie.data.map(Te=>({label:Te.vendor_name,id:Te.vendor_id,email:Te.email}));console.log("Mapped vendors:",de),ee(de),q(fe.data),_([]);try{await nt()}catch(Te){console.error("Error fetching aggregate quantities:",Te)}Ce(!1),Pe(!0),console.log(" Creation mode initialization complete");return}catch(Y){console.error(" Error fetching vendors/inventory:",Y),Y.name==="AbortError"?ze("Request timed out. Please try again."):ze("Failed to fetch vendors and inventory. Please check your connection and try again."),Ce(!1);return}try{const[Y,te,ie]=await Promise.all([B.get(`/api/purchase-orders/${t}`),B.get("/api/vendors"),B.get("/api/inventory")]),fe=Y.data;if(console.log("Fetched Order Data:",fe),o(fe),fe.vendor_name&&fe.vendor_id){const Ge=te.data.find(W=>W.vendor_id===fe.vendor_id);c({label:fe.vendor_name,id:fe.vendor_id,email:Ge?.email})}else if(fe.vendor_id){const Ge=te.data.find(W=>W.vendor_id===fe.vendor_id);Ge?c({label:Ge.vendor_name,id:Ge.vendor_id,email:Ge.email}):(!i||!i.id)&&c(null)}else(!i||!i.id)&&c(null);d($e(fe.purchase_date)),f(fe.bill_number||""),console.log("Original line items from backend:",fe.lineItems);const de=fe.lineItems.map(Ge=>{const W={...Ge,quantity:String(Ge.quantity||""),unit_cost:String(Ge.unit_cost||""),line_amount:parseFloat(String(Ge.line_amount??Ge.line_total??0)),quantity_to_order:0};return console.log("Mapped line item:",W),W});console.log("Final mapped line items:",de),_(de),j(de);const Te=fe.status==="Closed"?"Closed":"Open";console.log("Setting purchase order status:",Te,"from fetched status:",fe.status),L(Te),D(!1),b(fe.global_gst_rate||nu),console.log("State after setting:",{purchaseOrder:fe,billNumber:fe.bill_number||"",lineItems:fe.lineItems,mappedLineItems:de,subTotal:parseFloat(String(fe.subtotal))||0,totalGSTAmount:parseFloat(String(fe.total_gst_amount))||0,totalAmount:parseFloat(String(fe.total_amount))||0}),console.log("Raw vendors data (edit mode):",te.data);const Je=te.data.map(Ge=>({label:Ge.vendor_name,id:Ge.vendor_id,email:Ge.email}));console.log("Mapped vendors (edit mode):",Je),ee(Je),q(ie.data),await nt(),Ce(!1),Pe(!0)}catch(Y){console.error("Error fetching data:",Y),Y instanceof kr&&Y.response?.data?.message?ze(Y.response.data.message):ze("An unexpected error occurred")}};l.useEffect(()=>{t&&jt()},[t]),l.useEffect(()=>{console.log("lineItems state changed:",w)},[w]),l.useEffect(()=>{j(w)},[w]),l.useEffect(()=>{X(!1),Et(null)},[t]);const er=Y=>Il(vs(Y.quantity),vs(Y.unit_cost)),Er=l.useMemo(()=>v.map(Y=>({part_number:Y.part_number,part_description:Y.part_description,quantity:vs(Y.quantity),unit:Y.unit,unit_cost:vs(Y.unit_cost)})),[v]),un=l.useMemo(()=>Sw(Er,A),[Er,A]),Gt=un.subtotal,vr=un.total_gst_amount,qr=un.total_amount,$s=l.useCallback(Y=>JSON.stringify(Y.map(te=>({part_number:te.part_number.trim(),part_description:te.part_description.trim(),quantity:parseFloat(String(te.quantity)),unit:te.unit.trim(),unit_cost:parseFloat(String(te.unit_cost))})).sort((te,ie)=>te.part_number!==ie.part_number?te.part_number.localeCompare(ie.part_number):te.quantity-ie.quantity)),[]);l.useEffect(()=>{if(!a&&!Me&&s&&dr===""&&Sn){console.log("[PO Detail] Setting initial signature for dirty tracking");const Y=JSON.stringify({vendor:i?{id:i.id,label:i.label}:null,billNumber:p.trim(),date:u?.toISOString(),lineItems:$s(w),pickup_time:s.pickup_time||null,pickup_location:s.pickup_location||null,pickup_contact_person:s.pickup_contact_person||null,pickup_phone:s.pickup_phone||null,pickup_instructions:s.pickup_instructions||null,pickup_notes:s.pickup_notes||null,order_placed:s.order_placed||!1,order_placed_at:s.order_placed_at||null,order_placed_by:s.order_placed_by||null,order_placed_method:s.order_placed_method||null,vendor_confirmation_status:s.vendor_confirmation_status||"pending",vendor_confirmation_notes:s.vendor_confirmation_notes||null,vendor_confirmation_date:s.vendor_confirmation_date||null,pricing_updated:s.pricing_updated||!1,pricing_updated_at:s.pricing_updated_at||null,pricing_updated_by:s.pricing_updated_by||null,pricing_updated_method:s.pricing_updated_method||null,quantity_adjusted:s.quantity_adjusted||!1,quantity_adjusted_at:s.quantity_adjusted_at||null,quantity_adjusted_by:s.quantity_adjusted_by||null,quantity_adjusted_method:s.quantity_adjusted_method||null,original_quantities:s.original_quantities||null,adjusted_quantities:s.adjusted_quantities||null,vendor_pricing_notes:s.vendor_pricing_notes||null});dn(Y)}},[a,Me,s,Sn,dr]);const pn=l.useMemo(()=>JSON.stringify({vendor:i?{id:i.id,label:i.label}:null,billNumber:p.trim(),date:u?.toISOString(),lineItems:$s(w),pickup_time:s?.pickup_time||null,pickup_location:s?.pickup_location||null,pickup_contact_person:s?.pickup_contact_person||null,pickup_phone:s?.pickup_phone||null,pickup_instructions:s?.pickup_instructions||null,pickup_notes:s?.pickup_notes||null,order_placed:s?.order_placed||!1,order_placed_at:s?.order_placed_at||null,order_placed_by:s?.order_placed_by||null,order_placed_method:s?.order_placed_method||null,vendor_confirmation_status:s?.vendor_confirmation_status||"pending",vendor_confirmation_notes:s?.vendor_confirmation_notes||null,vendor_confirmation_date:s?.vendor_confirmation_date||null,pricing_updated:s?.pricing_updated||!1,pricing_updated_at:s?.pricing_updated_at||null,pricing_updated_by:s?.pricing_updated_by||null,pricing_updated_method:s?.pricing_updated_method||null,quantity_adjusted:s?.quantity_adjusted||!1,quantity_adjusted_at:s?.quantity_adjusted_at||null,quantity_adjusted_by:s?.quantity_adjusted_by||null,quantity_adjusted_method:s?.quantity_adjusted_method||null,original_quantities:s?.original_quantities||null,adjusted_quantities:s?.adjusted_quantities||null,vendor_pricing_notes:s?.vendor_pricing_notes||null}),[i,p,u,w,s]),hr=!!dr&&dr!==pn&&!Ie;l.useEffect(()=>{console.log("[PO Detail] isDirty changed:",{isDirty:hr,hasInitialSignature:!!dr,signaturesMatch:dr===pn,initialSignature:dr.slice(0,100)+"...",currentSignature:pn.slice(0,100)+"..."}),console.log("[PO Detail] About to render UnsavedChangesGuard with when=",hr)},[hr,dr,pn]),l.useEffect(()=>{console.log("Aggregate quantities changed:",N),Object.keys(N).length>0&&_(Y=>{const te=Y.map(ie=>{const fe=N[ie.part_number]||N[ie.part_number.toUpperCase()]||N[ie.part_number.toLowerCase()]||0,de=typeof fe=="string"?parseFloat(fe):fe;return{...ie,quantity_to_order:de}});return console.log("Updated line items from aggregate quantities effect:",te),te})},[N]);const mr=(Y,te,ie)=>{_(fe=>{const de=[...fe];if(!de[Y])return console.log("Item at index",Y,"not found in handleLineItemChange"),fe;const Te={...de[Y],[te]:ie};return te==="quantity"&&parseFloat(ie)<=0?de.filter((Je,Ge)=>Ge!==Y):((te==="quantity"||te==="unit_cost")&&(Te.line_amount=er(Te)),de[Y]=Te,de)})},os=()=>{_(Y=>[...Y,{part_number:"",part_description:"",quantity:"",unit:yn[0],unit_cost:"",line_amount:0,quantity_to_order:0}])},we=Y=>{const te=[],ie=[];if(!Y||Y.length===0)return{mapped:te,pending:ie};const fe=de=>de?de.trim().toUpperCase():"";return Y.filter(de=>de.description&&de.description.trim().length>0||de.partNumber&&de.partNumber.trim().length>0).forEach(de=>{const Te=de.quantity??0,Je=de.match?.lastUnitCost??de.unitCost??0,Ge=de.match?.status==="existing"?fe(de.match?.matchedPartNumber||de.partNumber||de.match?.normalizedPartNumber||""):fe(de.match?.suggestedPartNumber||de.partNumber||de.normalizedPartNumber||""),W=de.description||de.match?.partDescription||"",F=de.match?.status==="existing"?de.match?.unit||de.unit||yn[0]:de.unit||yn[0],se=de.match?.status==="existing"&&de.match?.lastUnitCost!=null?String(de.match.lastUnitCost):de.unitCost!=null?String(de.unitCost):"",oe={part_number:Ge,part_description:W,quantity:de.quantity!==null&&de.quantity!==void 0?String(de.quantity):"",unit:F,unit_cost:se,line_amount:Il(Te,Je),quantity_to_order:0},ve=te.length;if(te.push(oe),de.match?.status==="missing"&&Ge){const Oe={part_number:fe(de.match.suggestedPartNumber||Ge),part_description:de.description||"",unit:de.unit||yn[0],last_unit_cost:de.unitCost??"",part_type:"stock",category:"Uncategorized"};ie.push({index:ve,suggestion:Oe})}else if(de.match?.status==="existing"&&de.match.descriptionMatches===!1){const Oe=`Invoice description for part "${de.match.matchedPartNumber||Ge}" differs from inventory. Create a new part using the invoice details?`;if(typeof window<"u"?window.confirm(Oe):!1){const Re={part_number:fe(de.match.suggestedPartNumber||Ge),part_description:de.description||"",unit:de.unit||de.match?.unit||yn[0],last_unit_cost:de.unitCost??de.match?.lastUnitCost??"",part_type:"stock",category:"Uncategorized"};ie.push({index:ve,suggestion:Re})}}}),{mapped:te,pending:ie}},rt=async Y=>{const te=Y.target.files?.[0];if(te){ce(null),T(!0);try{const ie=await xw(te);he(ie),H.success("Gemini analysis completed for the uploaded document. Review the detected values before applying them.")}catch(ie){console.error("Error processing OCR document:",ie);let fe="Failed to analyze the document with AI. Please ensure OCR and Gemini are configured on the server.";ie instanceof kr&&ie.response?.data?.error?fe=ie.response.data.error:ie?.message&&(fe=ie.message),ce(fe),H.error(fe)}finally{T(!1),Y.target&&(Y.target.value="")}}},pt=()=>{if(!me)return;const{normalized:Y}=me.ocr,te=Y.vendorMatch,ie=te?.vendorName||Y.vendorName||"";if(te&&te.status==="existing"&&te.vendorId){const fe=O.find(Je=>Je.id===te.vendorId),de=te.matchedVendorName||ie,Te=te.details?.email||"";if(fe)c(fe),z(fe.label);else{const Je={label:de||ie,id:te.vendorId,email:Te};ee(Ge=>Ge.some(W=>W.id===te.vendorId)?Ge:[...Ge,Je]),c(Je),z(Je.label)}de&&H.info(`Matched invoice vendor to "${de}".`)}else if(te&&te.status==="missing"&&ie){c(null),z(ie);const fe={vendor_name:ie,street_address:te.details?.streetAddress||"",city:te.details?.city||"",province:te.details?.province||"",country:te.details?.country||"",postal_code:te.details?.postalCode||"",contact_person:te.details?.contactPerson||"",telephone_number:te.details?.telephone||"",email:te.details?.email||"",website:te.details?.website||""};fn(fe),(typeof window<"u"?window.confirm(`Vendor "${ie}" was not found. Would you like to add this vendor now?`):!1)?br(!0):H.warn(`Vendor "${ie}" is not in the system. Review the captured details before continuing.`)}else if(ie){const fe=O.find(de=>de.label.toLowerCase()===ie.toLowerCase());fe?(c(fe),z(fe.label)):(c(null),z(ie))}if(Y.billNumber&&f(Y.billNumber),Y.billDate){const fe=$e(Y.billDate);fe.isValid()&&d(fe)}if(typeof Y.gstRate=="number"&&!Number.isNaN(Y.gstRate)&&b(Y.gstRate),Y.lineItems?.length){const{mapped:fe,pending:de}=we(Y.lineItems);fe.length>0&&(_(fe),j(fe)),Ke(de)}else Ke([]);H.success("OCR data applied. Please review the form before saving.")},Qt=async Y=>{const te=Y.toUpperCase();if(!ue[te])try{const ie=await Fo(te);ye(fe=>({...fe,[te]:ie}))}catch{}},ur=(Y,te)=>{const ie=ue[Y.toUpperCase()]||[];if(ie.length===0)return Y;if(te){const Te=ie.filter(Je=>Je.vendor_id===te);if(Te.length>0){const Je=Te.find(W=>W.preferred);if(Je)return Je.vendor_part_number;const Ge=[...Te].sort((W,F)=>(F.usage_count||0)-(W.usage_count||0))[0];if(Ge)return Ge.vendor_part_number}}const fe=ie.find(Te=>Te.preferred);if(fe)return fe.vendor_part_number;const de=[...ie].sort((Te,Je)=>(Je.usage_count||0)-(Te.usage_count||0))[0];return de?de.vendor_part_number:Y};l.useEffect(()=>{i&&_(Y=>Y.map(te=>{const ie=(te.part_number||"").toUpperCase(),fe=ue[ie];if(!fe||fe.length===0)return te;const de=ur(ie,i?.id||null);return{...te,part_number:de}}))},[i,ue]);const Hr=Y=>{_(te=>te.filter((ie,fe)=>fe!==Y))},Yr=Y=>V.find(te=>te.part_number===Y),Ur=(Y,te)=>{console.log("handlePartNumberChange called:",{idx:Y,newValue:te,inventoryItemsLength:V.length}),j(ie=>{const fe=[...ie],de=fe[Y];if(console.log("Current item before change:",de),!de)return console.log("Current item not found, creating default item"),fe[Y]={part_number:"",part_description:"",quantity:"",unit:yn[0],unit_cost:"",line_amount:0,quantity_to_order:0},fe;if(te===null||typeof te=="string"&&te.trim()==="")console.log("Resetting line item to empty values"),!de.part_number&&!de.part_description&&!de.quantity&&!de.unit_cost?fe[Y]={...de,part_number:"",part_description:"",quantity:"",unit:yn[0],unit_cost:"",line_amount:0,quantity_to_order:0}:console.log("Preserving existing data despite empty input value");else if(typeof te!="string"&&te.isNew){console.log("Opening part dialog for new part"),ct(Y);const Te=te.inputValue||"";Ne(Te),Be({part_number:Te.toUpperCase(),category:"Uncategorized"}),qt("manual"),Qe(!0)}else if(typeof te=="string"){const Te=Yr(te);console.log("Found inventory item:",Te);const Je=N[te]||N[te.toUpperCase()]||N[te.toLowerCase()]||0,Ge=typeof Je=="string"?parseFloat(Je):Je;if(console.log(`Quantity to order for ${te}:`,Je,"as number:",Ge),console.log("Available aggregate quantities keys:",Object.keys(N)),console.log("Looking for part:",te,"in aggregate quantities:",N),Te){const W=de.unit_cost,F=!W||W===""||W==="0";fe[Y]={...de,part_number:te,part_description:Te.part_description,unit:Te.unit,unit_cost:F?String(Te.last_unit_cost):W,quantity_to_order:Ge}}else console.log("Inventory item not found, preserving existing data"),fe[Y]={...de,part_number:te,quantity_to_order:Ge}}return fe[Y].line_amount=er(fe[Y]),console.log("Updated item after change:",fe[Y]),fe}),typeof te=="string"&&te.trim()!==""&&nt()},Ir=async(Y,te)=>{if(!Y||Y.trim()==="")return!1;try{return(await B.get("/api/purchase-history/check-bill-number",{params:{bill_number:Y.trim(),exclude_purchase_id:te}})).data.exists}catch(ie){return console.error("Error checking duplicate bill number:",ie),!1}},wr=(Y=!1,te=!1)=>{let ie={};i||(ie.vendor="Vendor is required."),u||(ie.date="Date is required."),Y&&!p.trim()&&(ie.billNumber="Bill Number is required.");const fe=w.map(Te=>({part_number:Te.part_number,part_description:Te.part_description,quantity:vs(Te.quantity),unit:Te.unit,unit_cost:vs(Te.unit_cost)})),de=kw(fe,i,te);return de.lineItems&&w.length>0&&(ie.lineItems=de.lineItems),Ee(ie),ie},Tr=async()=>{const Y=wr(!1,!1);if(Object.keys(Y).length>0){H.error("Please correct the errors before saving.");return}if(!(p&&p.trim()&&await Ir(p,s?.purchase_id)&&!window.confirm(`Warning: Bill number "${p}" already exists in another purchase order. Do you want to proceed anyway?`))){Le(!0);try{if(a){const te={vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:w.map(de=>({part_number:de.part_number.trim(),part_description:de.part_description.trim(),unit:de.unit.trim(),quantity:parseFloat(String(de.quantity)),unit_cost:parseFloat(String(de.unit_cost)),line_amount:parseFloat(String(de.line_amount))})),status:"Open",subtotal:Gt,total_gst_amount:vr,total_amount:qr,global_gst_rate:A,company_id:n?.company_id,created_by:n?.id,pickup_time:s?.pickup_time||null,pickup_location:s?.pickup_location||null,pickup_contact_person:s?.pickup_contact_person||null,pickup_phone:s?.pickup_phone||null,pickup_instructions:s?.pickup_instructions||null,pickup_notes:s?.pickup_notes||null,order_placed:s?.order_placed||!1,order_placed_at:s?.order_placed_at||null,order_placed_by:s?.order_placed_by||null,order_placed_method:s?.order_placed_method||null,vendor_confirmation_status:s?.vendor_confirmation_status||"pending",vendor_confirmation_notes:s?.vendor_confirmation_notes||null,vendor_confirmation_date:s?.vendor_confirmation_date||null,pricing_updated:s?.pricing_updated||!1,pricing_updated_at:s?.pricing_updated_at||null,pricing_updated_by:s?.pricing_updated_by||null,pricing_updated_method:s?.pricing_updated_method||null,quantity_adjusted:s?.quantity_adjusted||!1,quantity_adjusted_at:s?.quantity_adjusted_at||null,quantity_adjusted_by:s?.quantity_adjusted_by||null,quantity_adjusted_method:s?.quantity_adjusted_method||null,original_quantities:s?.original_quantities||null,adjusted_quantities:s?.adjusted_quantities||null,vendor_pricing_notes:s?.vendor_pricing_notes||null};if(console.log("Creating new purchase order:",te),window.__poCreateInFlight){console.log("[PO] Skipping duplicate create (in flight)");return}window.__poCreateInFlight=!0;const ie=await B.post("/api/purchase-orders",te);H.success("Purchase Order created successfully!");const fe=ie.data.purchase_id;window.__unsavedGuardAllowNext=!0,r(`/open-purchase-orders/${fe}`)}else{const te=P==="Closed"&&C,ie={...s,vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:w.map(de=>({...de,part_number:de.part_number.trim(),part_description:de.part_description.trim(),unit:de.unit.trim(),quantity:parseFloat(String(de.quantity)),unit_cost:parseFloat(String(de.unit_cost)),line_amount:parseFloat(String(de.line_amount))})),status:P,subtotal:Gt,total_gst_amount:vr,total_amount:qr,global_gst_rate:A,gst_rate:A,pickup_time:s?.pickup_time||null,pickup_location:s?.pickup_location||null,pickup_contact_person:s?.pickup_contact_person||null,pickup_phone:s?.pickup_phone||null,pickup_instructions:s?.pickup_instructions||null,pickup_notes:s?.pickup_notes||null,order_placed:s?.order_placed||!1,order_placed_at:s?.order_placed_at||null,order_placed_by:s?.order_placed_by||null,order_placed_method:s?.order_placed_method||null,vendor_confirmation_status:s?.vendor_confirmation_status||"pending",vendor_confirmation_notes:s?.vendor_confirmation_notes||null,vendor_confirmation_date:s?.vendor_confirmation_date||null,pricing_updated:s?.pricing_updated||!1,pricing_updated_at:s?.pricing_updated_at||null,pricing_updated_by:s?.pricing_updated_by||null,pricing_updated_method:s?.pricing_updated_method||null,quantity_adjusted:s?.quantity_adjusted||!1,quantity_adjusted_at:s?.quantity_adjusted_at||null,quantity_adjusted_by:s?.quantity_adjusted_by||null,quantity_adjusted_method:s?.quantity_adjusted_method||null,original_quantities:s?.original_quantities||null,adjusted_quantities:s?.adjusted_quantities||null,vendor_pricing_notes:s?.vendor_pricing_notes||null};console.log("Sending to backend (handleSave):",ie);const fe=await B.put(`/api/purchase-orders/${t}`,ie);Ht("Purchase Order updated successfully!"),te&&(await jt(),D(!1)),setTimeout(()=>{window.__unsavedGuardAllowNext=!0},100),te||dn(JSON.stringify({vendor:i,billNumber:p,date:u,lineItems:w,pickup_time:s?.pickup_time,pickup_location:s?.pickup_location,pickup_contact_person:s?.pickup_contact_person,pickup_phone:s?.pickup_phone,pickup_instructions:s?.pickup_instructions,pickup_notes:s?.pickup_notes,order_placed:s?.order_placed,order_placed_at:s?.order_placed_at,order_placed_by:s?.order_placed_by,order_placed_method:s?.order_placed_method,vendor_confirmation_status:s?.vendor_confirmation_status,vendor_confirmation_notes:s?.vendor_confirmation_notes,vendor_confirmation_date:s?.vendor_confirmation_date,pricing_updated:s?.pricing_updated,pricing_updated_at:s?.pricing_updated_at,pricing_updated_by:s?.pricing_updated_by,pricing_updated_method:s?.pricing_updated_method,quantity_adjusted:s?.quantity_adjusted,quantity_adjusted_at:s?.quantity_adjusted_at,quantity_adjusted_by:s?.quantity_adjusted_by,quantity_adjusted_method:s?.quantity_adjusted_method,original_quantities:s?.original_quantities,adjusted_quantities:s?.adjusted_quantities,vendor_pricing_notes:s?.vendor_pricing_notes}))}}catch(te){if(console.error("Error saving Purchase Order:",te),te instanceof kr&&te.response?.data?.error){const ie=te.response.data,fe=ie.details?` (${ie.details})`:"";H.error(`Error saving Purchase Order: ${ie.error}${fe}`)}else H.error("Error saving Purchase Order. Please try again.")}finally{Le(!1),window.__poCreateInFlight=!1}}},Gr=async()=>{if(P==="Closed"&&!(hr&&!window.confirm("Discard your edits to this closed purchase order?")))try{await jt()}finally{D(!1)}},Wr=async()=>{if(!s?.purchase_id){H.error("Purchase order not loaded. Cannot export.");return}if(s.status!=="Closed"){H.error("Only closed purchase orders can be exported to QuickBooks.");return}if(s.exported_to_qbo){H.error("Purchase order has already been exported to QuickBooks.");return}mo(!0);try{const Y=await B.post(`/api/purchase-orders/${s.purchase_id}/export-to-qbo`);H.success("Exported to QuickBooks successfully!"),o(te=>te&&{...te,exported_to_qbo:!0})}catch(Y){const te=Y?.response?.data?.error||"Failed to export to QuickBooks.";H.error(te)}finally{mo(!1)}},Or=async()=>{s?.purchase_id&&await Sr()},Sr=async()=>{if(!s?.purchase_id)return;const Y=wr(!0,!0);if(Object.keys(Y).length>0){Y.lineItems?.some(fe=>fe.unit_cost)?H.error("Unit cost is required for all line items before closing a purchase order."):(ot(!0),H.error("A bill number is required to close the purchase order."));return}if(!(await Ir(p,s.purchase_id)&&!window.confirm(`Warning: Bill number "${p}" already exists in another purchase order. Do you want to proceed with closing this purchase order anyway?`)))try{const ie={...s,vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:w.map(de=>({...de,part_number:de.part_number.trim(),part_description:de.part_description.trim(),unit:de.unit.trim(),quantity:parseFloat(String(de.quantity)),unit_cost:parseFloat(String(de.unit_cost)),line_amount:parseFloat(String(de.line_amount))})),status:"Closed",subtotal:Gt,total_gst_amount:vr,total_amount:qr,global_gst_rate:A,gst_rate:A,pickup_time:s?.pickup_time||null,pickup_location:s?.pickup_location||null,pickup_contact_person:s?.pickup_contact_person||null,pickup_phone:s?.pickup_phone||null,pickup_instructions:s?.pickup_instructions||null,pickup_notes:s?.pickup_notes||null,order_placed:s?.order_placed||!1,order_placed_at:s?.order_placed_at||null,order_placed_by:s?.order_placed_by||null,order_placed_method:s?.order_placed_method||null,vendor_confirmation_status:s?.vendor_confirmation_status||"pending",vendor_confirmation_notes:s?.vendor_confirmation_notes||null,vendor_confirmation_date:s?.vendor_confirmation_date||null,pricing_updated:s?.pricing_updated||!1,pricing_updated_at:s?.pricing_updated_at||null,pricing_updated_by:s?.pricing_updated_by||null,pricing_updated_method:s?.pricing_updated_method||null,quantity_adjusted:s?.quantity_adjusted||!1,quantity_adjusted_at:s?.quantity_adjusted_at||null,quantity_adjusted_by:s?.quantity_adjusted_by||null,quantity_adjusted_method:s?.quantity_adjusted_method||null,original_quantities:s?.original_quantities||null,adjusted_quantities:s?.adjusted_quantities||null,vendor_pricing_notes:s?.vendor_pricing_notes||null},fe=await B.put(`/api/purchase-orders/${s.purchase_id}`,ie);fe.status===200?(console.log("Purchase Order closed:",fe.data),H.success("Purchase Order closed successfully!"),o(de=>de&&{...de,status:"Closed"}),L("Closed"),r(`/open-purchase-orders/${s.purchase_id}`)):H.error("Failed to close purchase order")}catch(ie){if(console.error("Error closing purchase order:",ie),ie instanceof kr&&ie.response?.data?.error){const fe=ie.response.data.error;fe.toLowerCase().includes("negative quantity")||fe.toLowerCase().includes("insufficient inventory")||fe.toLowerCase().includes("inventory constraint")?H.error(`Cannot close: ${fe}`):H.error(`Error closing PO: ${fe}`)}else H.error("Failed to close purchase order. Please try again.")}},Cn=()=>{r(`/open-purchase-orders/${s?.purchase_id}`)},is=()=>{jt(),H.success("Allocation changes saved successfully. Purchase order remains open.")},Qr=async()=>{if(!wr(!1)){H.error("Please correct the errors before proceeding with allocation.");return}try{const Y={...s,vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:w.map(te=>({...te,part_number:te.part_number.trim(),part_description:te.part_description.trim(),unit:te.unit.trim(),quantity:parseFloat(String(te.quantity)),unit_cost:parseFloat(String(te.unit_cost)),line_amount:parseFloat(String(te.line_amount))})),subtotal:Gt,total_gst_amount:vr,total_amount:qr,global_gst_rate:A,gst_rate:A,pickup_time:s?.pickup_time||null,pickup_location:s?.pickup_location||null,pickup_contact_person:s?.pickup_contact_person||null,pickup_phone:s?.pickup_phone||null,pickup_instructions:s?.pickup_instructions||null,pickup_notes:s?.pickup_notes||null,order_placed:s?.order_placed||!1,order_placed_at:s?.order_placed_at||null,order_placed_by:s?.order_placed_by||null,order_placed_method:s?.order_placed_method||null,vendor_confirmation_status:s?.vendor_confirmation_status||"pending",vendor_confirmation_notes:s?.vendor_confirmation_notes||null,vendor_confirmation_date:s?.vendor_confirmation_date||null,pricing_updated:s?.pricing_updated||!1,pricing_updated_at:s?.pricing_updated_at||null,pricing_updated_by:s?.pricing_updated_by||null,pricing_updated_method:s?.pricing_updated_method||null,quantity_adjusted:s?.quantity_adjusted||!1,quantity_adjusted_at:s?.quantity_adjusted_at||null,quantity_adjusted_by:s?.quantity_adjusted_by||null,quantity_adjusted_method:s?.quantity_adjusted_method||null,original_quantities:s?.original_quantities||null,adjusted_quantities:s?.adjusted_quantities||null,vendor_pricing_notes:s?.vendor_pricing_notes||null};await B.put(`/api/purchase-orders/${s.purchase_id}`,Y),o(Y),ho(!0),H.success("Changes saved successfully. Opening allocation modal...")}catch(Y){console.error("Error saving changes before allocation:",Y),Y instanceof kr&&Y.response?.data?.error?H.error(`Error saving changes: ${Y.response.data.error}`):H.error("Failed to save changes before allocation. Please try again.")}},ls=async()=>{if(!s?.purchase_id){H.error("Purchase order not loaded. Cannot download PDF.");return}try{const Y=await B.get(`/api/purchase-orders/${s.purchase_id}/pdf`,{responseType:"blob"}),te=window.URL.createObjectURL(new Blob([Y.data])),ie=document.createElement("a");ie.href=te,ie.download=`purchase_order_${s.purchase_number}.pdf`,document.body.appendChild(ie),ie.click(),ie.remove(),window.URL.revokeObjectURL(te)}catch(Y){console.error("Error downloading PDF:",Y),H.error("Failed to download PDF. Please try again.")}},en=async()=>{await Tr(),!(Object.keys(pe).length>0)&&await ls()},cs=()=>{if(!s)return;const Y=w.map(ie=>ie.quantity),te=prompt(`Enter adjusted quantities (comma-separated, e.g., 50,100,25):
Current quantities: `+Y.join(", ")+`
Note: Adjust based on vendor minimum orders (e.g., sold by 10ft packs)`);if(te)try{const ie=te.split(",").map(fe=>parseFloat(fe.trim()));if(ie.length!==w.length){H.error("Number of quantities must match number of line items");return}_(fe=>fe.map((de,Te)=>({...de,quantity:ie[Te]}))),o(fe=>fe&&{...fe,quantity_adjusted:!0,quantity_adjusted_at:new Date().toISOString(),quantity_adjusted_by:Number(n?.id),quantity_adjusted_method:"manual",original_quantities:Y,adjusted_quantities:ie}),H.success("Quantities adjusted based on vendor confirmation")}catch{H.error("Invalid quantity format. Please use numbers separated by commas.")}},[kn,ho]=l.useState(!1),[Fn,zs]=l.useState(!1),[$n,ds]=l.useState(""),[zn,mo]=l.useState(!1),[Oi,hn]=l.useState(!1),[us,fo]=l.useState([]),[Pn,Bn]=l.useState(!1),[ps,Hn]=l.useState(null),[mn,xo]=l.useState({}),hs=async()=>{if(s?.purchase_id){Bn(!0),Hn(null);try{const Y=await B.get(`/api/purchase-history/${s.purchase_id}/allocations`);fo(Y.data||[]);const te=Array.from(new Set((Y.data||[]).map(ie=>ie.sales_order_id).filter(Boolean)));if(te.length>0)try{const ie=await Promise.all(te.map(de=>B.get(`/api/sales-orders/${de}`))),fe={};ie.forEach((de,Te)=>{const Je=te[Te],Ge=de.data?.salesOrder?.sales_order_number||de.data?.salesOrder?.sales_number||"";Ge&&(fe[Je]=Ge)}),xo(fe)}catch(ie){console.warn("Unable to fetch one or more sales order numbers:",ie)}hn(!0)}catch(Y){console.error("Error fetching allocations:",Y),Hn("Failed to load allocations."),hn(!0)}finally{Bn(!1)}}},[go,br]=l.useState(!1),[ms,fn]=l.useState({}),xn=Y=>Y.normalize("NFD").replace(/[-]/g,"").replace(/[^a-zA-Z0-9\s]/g," ").replace(/\s+/g," ").trim().toUpperCase(),Ai=(Y,te)=>{const ie=xn(te);if(!ie)return Y.slice(0,8);const fe=Y.map(de=>{const Te=xn(de.label);let Je=-1;return Te.startsWith(ie)?Je=3:Te.split(" ").some(Ge=>Ge.startsWith(ie))?Je=2:Te.includes(ie)&&(Je=1),{opt:de,score:Je}}).filter(de=>de.score>=0);return fe.sort((de,Te)=>Te.score-de.score||de.opt.label.localeCompare(Te.opt.label)),fe.slice(0,8).map(de=>de.opt)},Bs=Y=>{const te=xn(Y);return O.find(ie=>xn(ie.label)===te)||null},yo=Y=>{const te=xn(Y),ie=V.find(fe=>xn(fe.part_number)===te);return ie?ie.part_number:null},Hs=Y=>{const te=J.trim(),ie=Y.key==="Enter",fe=Y.key==="Tab",de=Y.key==="Escape",Te=Y.key==="ArrowDown"||Y.key==="ArrowUp";if(de){X(!1);return}if(Te){Y.key==="ArrowDown"&&!Q&&X(!0);return}if(ie||fe){if(ie&&Y.ctrlKey&&te){Y.preventDefault(),E(!0),fn({vendor_name:te}),br(!0),X(!1);return}if(Q){if(ie){const Ge=S;Ge&&Ge.isNew&&(Y.preventDefault(),E(!0),fn({vendor_name:te}),br(!0),X(!1))}return}const Je=Bs(te);if(!te)return;Y.preventDefault(),Je?(c(Je),z(Je.label)):(E(!0),fn({vendor_name:te}),br(!0),X(!1))}},Ys=(Y,te)=>{const ie=(w[Y]?.part_number||"").trim(),fe=te.key==="Enter",de=te.key==="Tab",Te=te.key==="Escape",Je=te.key==="ArrowDown"||te.key==="ArrowUp";if(Te){Et(null);return}if(Je){te.key==="ArrowDown"&&Yt!==Y&&Et(Y);return}if(!(Yt===Y&&(fe||de))&&(fe||de)){if(fe&&te.ctrlKey&&ie){te.preventDefault(),_e(Y),Ne(ie),ct(Y),Be({part_number:ie.toUpperCase(),category:"Uncategorized"}),qt("manual"),Qe(!0),Et(null);return}const Ge=yo(ie);if(!ie)return;te.preventDefault(),Ge?Ur(Y,Ge):(_e(Y),Ne(ie),ct(Y),Be({part_number:ie.toUpperCase(),category:"Uncategorized"}),qt("manual"),Qe(!0),Et(null))}},vo=()=>{Qe(!1),ct(null),Be(void 0),qt("manual"),Ne("")},Yn=Y=>{const te=O.find(ie=>ie.id===Y);return console.log("Getting vendor email for vendor ID:",Y),console.log("Selected vendor:",te),console.log("Vendor email:",te?.email),te?.email||""},fs=async()=>{if(!i?.id){H.error("Please select a vendor first");return}if(a){if(!wr(!1)){H.error("Please correct the errors before sending email.");return}try{const Y={vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:w.map(Te=>({part_number:Te.part_number.trim(),part_description:Te.part_description.trim(),unit:Te.unit.trim(),quantity:parseFloat(String(Te.quantity)),unit_cost:parseFloat(String(Te.unit_cost)),line_amount:parseFloat(String(Te.line_amount))})),status:"Open",subtotal:Gt,total_gst_amount:vr,total_amount:qr,global_gst_rate:A,company_id:n?.company_id,created_by:n?.id,pickup_time:s?.pickup_time||null,pickup_location:s?.pickup_location||null,pickup_contact_person:s?.pickup_contact_person||null,pickup_phone:s?.pickup_phone||null,pickup_instructions:s?.pickup_instructions||null,pickup_notes:s?.pickup_notes||null,order_placed:s?.order_placed||!1,order_placed_at:s?.order_placed_at||null,order_placed_by:s?.order_placed_by||null,order_placed_method:s?.order_placed_method||null,vendor_confirmation_status:s?.vendor_confirmation_status||"pending",vendor_confirmation_notes:s?.vendor_confirmation_notes||null,vendor_confirmation_date:s?.vendor_confirmation_date||null,pricing_updated:s?.pricing_updated||!1,pricing_updated_at:s?.pricing_updated_at||null,pricing_updated_by:s?.pricing_updated_by||null,pricing_updated_method:s?.pricing_updated_method||null,quantity_adjusted:s?.quantity_adjusted||!1,quantity_adjusted_at:s?.quantity_adjusted_at||null,quantity_adjusted_by:s?.quantity_adjusted_by||null,quantity_adjusted_method:s?.quantity_adjusted_method||null,original_quantities:s?.original_quantities||null,adjusted_quantities:s?.adjusted_quantities||null,vendor_pricing_notes:s?.vendor_pricing_notes||null};console.log("Creating new purchase order for email:",Y);const ie=(await B.post("/api/purchase-orders",Y)).data;o(ie);const fe=ie.purchase_id;r(`/open-purchase-orders/${fe}`);const de=Yn(i.id);ds(de),zs(!0),H.success("Purchase Order created and email modal opened!")}catch(Y){console.error("Error creating Purchase Order for email:",Y),Y instanceof kr&&Y.response?.data?.error?H.error(`Error creating Purchase Order: ${Y.response.data.error}`):H.error("Error creating Purchase Order. Please try again.")}}else{const Y=Yn(i.id);console.log("Email button clicked - vendor ID:",i.id),console.log("Retrieved email:",Y),ds(Y),zs(!0)}};l.useEffect(()=>{console.log("Part modal state changed - openPartDialog:",Ye,"partNumberForModal:",ut,"partToAddIndex:",lt)},[Ye,ut,lt]),l.useEffect(()=>{if(!Ye&&Bt.length>0){const[Y,...te]=Bt;Ke(te),ct(Y.index),Ne(Y.suggestion.part_number?String(Y.suggestion.part_number):""),Be({part_number:Y.suggestion.part_number??"",part_description:Y.suggestion.part_description??"",unit:Y.suggestion.unit??yn[0],last_unit_cost:Y.suggestion.last_unit_cost??"",quantity_on_hand:Y.suggestion.quantity_on_hand??"",reorder_point:Y.suggestion.reorder_point??"",part_type:Y.suggestion.part_type??"stock",category:Y.suggestion.category??"Uncategorized"}),qt("ocr"),Qe(!0)}},[Ye,Bt]),l.useEffect(()=>{Ye&&Et(null)},[Ye]),l.useEffect(()=>{if(i?.id){const Y=Yn(i.id);console.log("Vendor changed - updating email:",Y),ds(Y)}else ds("")},[i,O]);const Mi=()=>{if(!s)return null;const Y=w||[];let te=Y.reduce((de,Te)=>de+(Number(Te.line_amount)||0),0),ie=te*(s.global_gst_rate||5)/100,fe=te+ie;return isNaN(te)&&(te=0),isNaN(ie)&&(ie=0),isNaN(fe)&&(fe=0),e.jsxs(k,{p:{xs:2,md:4},maxWidth:1e3,mx:"auto",children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Purchase Order Details"}),e.jsx(kt,{variant:"outlined",sx:{mb:3},children:e.jsx(Tt,{children:e.jsxs(M,{container:!0,spacing:{xs:2,md:3},children:[e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Purchase Order #:"})," ",s.purchase_number]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Vendor:"})," ",s.vendor_name||"N/A"]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Purchase Date:"})," ",s.purchase_date?new Date(s.purchase_date).toLocaleDateString():""]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Created On:"})," ",s.created_at?new Date(s.created_at).toLocaleDateString():"N/A"]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Status:"})," ",s.status?.toUpperCase()||"N/A"]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Bill Number:"})," ",s.bill_number||"N/A"]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"GST Rate:"})," ",(s.global_gst_rate||5).toFixed(2),"%"]}),e.jsxs(M,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"QuickBooks Export:"})," ",s.exported_to_qbo?"Exported":s.qbo_export_status?`Error: ${s.qbo_export_status}`:"Not Exported"]})]})})}),s.return_orders&&e.jsx(k,{mb:3,children:Vs()}),e.jsx(h,{variant:"h5",gutterBottom:!0,children:"Items"}),e.jsx(kt,{variant:"outlined",children:e.jsx(Tt,{children:Y.map((de,Te)=>e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:6,sm:3,md:2,children:de.part_number}),e.jsx(M,{item:!0,xs:6,sm:5,md:4,children:de.part_description}),e.jsx(M,{item:!0,xs:4,sm:2,md:1.5,children:de.quantity}),e.jsx(M,{item:!0,xs:4,sm:2,md:1.5,children:de.unit}),e.jsx(M,{item:!0,xs:4,sm:2,md:1.5,children:Ar(Number(de.unit_cost)||0)}),e.jsx(M,{item:!0,xs:4,sm:2,md:1,children:Ar(Number(de.line_amount)||0)})]},Te))})}),e.jsxs(k,{mt:4,display:"flex",flexDirection:"column",alignItems:"flex-end",children:[e.jsxs(h,{variant:"h6",children:["Subtotal: ",Ar(te)]}),e.jsxs(h,{variant:"h6",children:["Total GST: ",Ar(ie)]}),e.jsxs(h,{variant:"h6",children:["Total Amount: ",Ar(fe)]})]}),e.jsxs(k,{mt:4,display:"flex",justifyContent:{xs:"center",sm:"flex-end"},gap:2,children:[e.jsx(G,{variant:"contained",color:"primary",startIcon:e.jsx(yr,{}),onClick:en,children:"Download PDF"}),!s?.exported_to_qbo&&n?.access_role==="Admin"&&e.jsx(G,{variant:"contained",color:"success",startIcon:e.jsx(io,{}),onClick:Wr,disabled:zn,children:zn?"Exporting...":"Export to QuickBooks"}),(n?.access_role==="Admin"||n?.access_role==="Sales and Purchase")&&e.jsx(G,{variant:"contained",color:"secondary",startIcon:e.jsx(As,{}),onClick:()=>D(!0),children:"Edit"}),e.jsx(G,{variant:"outlined",color:"primary",onClick:hs,children:"View Allocations"})]}),e.jsxs(mt,{open:Oi,onClose:()=>hn(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:"Allocations"}),e.jsxs(xt,{dividers:!0,children:[Pn&&e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",py:4,children:e.jsx(it,{})}),!Pn&&ps&&e.jsx(We,{severity:"error",children:ps}),!Pn&&!ps&&(()=>{if(!us||us.length===0)return e.jsx(h,{variant:"body2",children:"No allocations were saved for this purchase order."});const de=us.reduce((Je,Ge)=>{const W=(Ge.part_number||"").toString();return Je[W]||(Je[W]=[]),Je[W].push(Ge),Je},{}),Te=Object.keys(de).sort();return e.jsx(ke,{spacing:3,children:Te.map(Je=>{const Ge=de[Je],W=Ge.find(se=>se.part_description)?.part_description||"",F=Ge.reduce((se,oe)=>se+(Number(oe.allocate_qty)||0),0);return e.jsxs(k,{children:[e.jsxs(h,{variant:"subtitle1",sx:{fontWeight:"bold"},children:[Je," ",W?`- ${W}`:""]}),e.jsx(lr,{component:Ae,sx:{mt:1},children:e.jsxs(nr,{size:"small",children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Sales Order"}),e.jsx(ne,{children:"Sales Order Number"}),e.jsx(ne,{align:"right",children:"Allocated Qty"})]})}),e.jsxs(ar,{children:[Ge.map(se=>e.jsxs(ht,{children:[e.jsxs(ne,{children:["#",se.sales_order_id]}),e.jsx(ne,{children:mn[se.sales_order_id]?`SO-${mn[se.sales_order_id]}`:"-"}),e.jsx(ne,{align:"right",children:Number(se.allocate_qty||0).toFixed(2)})]},se.allocation_id)),e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontWeight:600},children:"Total"}),e.jsx(ne,{align:"right",sx:{fontWeight:600},children:F.toFixed(2)})]})]})]})})]},Je)})})})()]}),e.jsx(_t,{children:e.jsx(G,{onClick:()=>hn(!1),children:"Close"})})]})]})},Vs=()=>{if(!s)return null;const Y=s.return_orders??[],te=s.return_summary??{};return e.jsxs(Ae,{sx:{p:3},elevation:1,children:[e.jsxs(ke,{direction:{xs:"column",md:"row"},alignItems:{xs:"flex-start",md:"center"},justifyContent:"space-between",spacing:2,children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h6",children:"Return Orders"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"View vendor returns associated with this purchase order."})]}),e.jsxs(ke,{direction:"row",spacing:1,children:[e.jsx(De,{label:`Requested: ${te.requested_count??0}`,color:"warning",variant:"outlined",size:"small"}),e.jsx(De,{label:`Returned: ${te.returned_count??0}`,color:"success",variant:"outlined",size:"small"}),e.jsx(G,{variant:"outlined",onClick:()=>r(`/return-orders/new?purchaseId=${s.purchase_id}`),children:"Create Return"})]})]}),Y.length===0?e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mt:2},children:"No return orders have been logged for this purchase order."}):e.jsx(lr,{component:k,sx:{mt:2},children:e.jsxs(nr,{size:"small",children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Return #"}),e.jsx(ne,{children:"Status"}),e.jsx(ne,{children:"Requested"}),e.jsx(ne,{children:"Returned"}),e.jsx(ne,{align:"right",children:"Total Qty"}),e.jsx(ne,{align:"right",children:"Actions"})]})}),e.jsx(ar,{children:Y.map(ie=>e.jsxs(ht,{hover:!0,children:[e.jsx(ne,{children:ie.return_number}),e.jsx(ne,{children:e.jsx(De,{label:ie.status,size:"small",color:ie.status==="Returned"?"success":"warning",variant:"outlined"})}),e.jsx(ne,{children:ie.requested_at?new Date(ie.requested_at).toLocaleString():""}),e.jsx(ne,{children:ie.returned_at?new Date(ie.returned_at).toLocaleString():""}),e.jsx(ne,{align:"right",children:Number(ie.total_quantity??0).toFixed(2)}),e.jsx(ne,{align:"right",children:e.jsx(G,{size:"small",onClick:()=>r(`/return-orders/${ie.return_id}`),children:"View"})})]},ie.return_id))})]})})]})};return!a&&!s?e.jsx(k,{p:4,children:e.jsx(h,{variant:"h5",children:"Loading Purchase Order..."})}):Me?e.jsx(k,{p:4,children:e.jsx(h,{variant:"h5",children:"Loading..."})}):!a&&P==="Closed"&&!C?Mi():e.jsxs(e.Fragment,{children:[e.jsxs(_n,{dateAdapter:ss,children:[e.jsx(Ii,{when:hr,onSave:Tr}),e.jsxs(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:a?"Create New Purchase Order":`Edit Purchase Order: ${s?.purchase_number}`}),!a&&s&&e.jsxs(e.Fragment,{children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2,mt:1},children:[e.jsx(De,{label:s.order_placed?"Order Placed":"Order Not Placed",color:s.order_placed?"success":"warning",variant:"outlined",size:"small"}),e.jsx(De,{label:`Vendor: ${s.vendor_confirmation_status||"pending"}`,color:s.vendor_confirmation_status==="confirmed"?"success":s.vendor_confirmation_status==="partial"?"warning":s.vendor_confirmation_status==="unavailable"?"error":"default",variant:"outlined",size:"small"}),s.pricing_updated&&e.jsx(De,{label:"Pricing Updated",color:"info",variant:"outlined",size:"small"}),s.quantity_adjusted&&e.jsx(De,{label:"Quantities Adjusted",color:"secondary",variant:"outlined",size:"small"})]}),s.created_at&&e.jsxs(h,{variant:"subtitle1",color:"text.secondary",sx:{mt:1},children:["Created On: ",new Date(s.created_at).toLocaleDateString()]})]})]}),e.jsxs(ke,{direction:"row",spacing:1,children:[e.jsx(G,{variant:"contained",color:"primary",onClick:Tr,startIcon:e.jsx(as,{}),children:a?"Create Purchase Order":P==="Closed"&&C?"Save Closed PO Edits":"Save Changes"}),!a&&P==="Closed"&&C&&e.jsx(G,{variant:"outlined",color:"secondary",onClick:Gr,startIcon:e.jsx(po,{}),children:"Cancel Edit"}),!a&&e.jsxs(e.Fragment,{children:[P!=="Closed"&&e.jsx(G,{variant:"contained",color:"primary",onClick:Or,startIcon:e.jsx(si,{}),children:"Close PO"}),e.jsx(G,{variant:"contained",color:"primary",onClick:en,startIcon:e.jsx(yr,{}),children:"Download PDF"}),e.jsx(G,{variant:"contained",onClick:fs,startIcon:e.jsx(bi,{}),sx:{backgroundColor:"#ff9800","&:hover":{backgroundColor:"#f57c00"}},children:"Email Vendor"})]})]})]}),!a&&s&&e.jsx(k,{sx:{mb:3},children:Vs()}),Ze&&e.jsxs(We,{severity:"warning",sx:{mb:3},onClose:()=>ot(!1),children:[e.jsx(h,{variant:"body1",sx:{fontWeight:"medium"},children:"Bill Number Required"}),e.jsx(h,{variant:"body2",children:"A bill number is required to close this purchase order. Please enter a bill number before closing."})]}),e.jsx(kt,{variant:"outlined",sx:{mb:3},children:e.jsxs(Tt,{children:[e.jsxs(ke,{direction:{xs:"column",sm:"row"},spacing:2,alignItems:{xs:"stretch",sm:"center"},children:[e.jsxs(k,{sx:{flexGrow:1},children:[e.jsx(h,{variant:"h6",children:"Invoice / Packing Slip OCR Prefill"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Upload a vendor invoice or packing slip to extract vendor, bill, and line item details using on-server Tesseract OCR."})]}),e.jsx("input",{type:"file",accept:"image/*,.pdf",hidden:!0,ref:re,onChange:rt}),e.jsx(G,{variant:"contained",color:"secondary",startIcon:e.jsx(io,{}),onClick:()=>re.current?.click(),disabled:ae,children:ae?"Processing":"Upload Document"}),ae&&e.jsx(it,{size:24})]}),$&&e.jsx(We,{severity:"error",sx:{mt:2},children:$}),me&&e.jsxs(k,{sx:{mt:3},children:[e.jsxs(ke,{direction:{xs:"column",md:"row"},spacing:2,alignItems:{xs:"flex-start",md:"center"},children:[e.jsxs(k,{sx:{flexGrow:1},children:[e.jsxs(ke,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(h,{variant:"subtitle1",children:"Detected Fields"}),e.jsx(De,{size:"small",color:me.source==="ai"?"info":"default",variant:me.source==="ai"?"filled":"outlined",label:me.source==="ai"?"Gemini AI analysis":"OCR extraction"})]}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Review the extracted details and apply them to this purchase order."})]}),e.jsx(ke,{direction:"row",spacing:1,children:e.jsx(G,{variant:"contained",color:"primary",onClick:pt,children:"Apply to Form"})})]}),e.jsxs(M,{container:!0,spacing:2,sx:{mt:1},children:[e.jsxs(M,{item:!0,xs:12,md:6,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Vendor"}),e.jsx(h,{variant:"body1",children:me.ocr.normalized.vendorName||"Not detected"}),me.ocr.normalized.vendorAddress&&e.jsx(h,{variant:"body2",color:"text.secondary",children:me.ocr.normalized.vendorAddress})]}),e.jsxs(M,{item:!0,xs:12,md:3,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Bill Number"}),e.jsx(h,{variant:"body1",children:me.ocr.normalized.billNumber||"Not detected"})]}),e.jsxs(M,{item:!0,xs:12,md:3,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Bill Date"}),e.jsx(h,{variant:"body1",children:me.ocr.normalized.billDate||"Not detected"})]})]}),me.ocr.normalized.lineItems.length>0&&e.jsxs(k,{sx:{mt:2},children:[e.jsxs(h,{variant:"body2",color:"text.secondary",sx:{mb:1},children:["Sample of detected line items (",me.ocr.normalized.lineItems.length," total)"]}),e.jsx(Ae,{variant:"outlined",sx:{maxHeight:200,overflowY:"auto",p:1},children:me.ocr.normalized.lineItems.slice(0,5).map((Y,te)=>e.jsxs(k,{sx:{py:.5},children:[e.jsxs(h,{variant:"body2",sx:{fontWeight:500},children:[Y.partNumber?`${Y.partNumber}  `:"",Y.description]}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:["Qty: ",Y.quantity??"n/a"," | Unit Cost: ",Y.unitCost??"n/a"," | Total: ",Y.totalCost??"n/a"]})]},`${Y.rawLine}-${te}`))})]}),(me.ocr.warnings.length>0||me.ocr.notes.length>0)&&e.jsxs(ke,{direction:"row",spacing:1,sx:{mt:2,flexWrap:"wrap"},children:[me.ocr.warnings.map((Y,te)=>e.jsx(De,{label:Y,color:"warning",variant:"outlined",sx:{mr:1,mb:1}},`ocr-warning-${te}`)),me.ocr.notes.map((Y,te)=>e.jsx(De,{label:Y,color:"info",variant:"outlined",sx:{mr:1,mb:1}},`ocr-note-${te}`))]})]})]})}),e.jsx(Ae,{sx:{p:3},children:e.jsxs(M,{container:!0,spacing:3,children:[e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx($r,{disablePortal:!1,open:Q,onOpen:()=>X(!0),onClose:()=>X(!1),autoHighlight:!0,value:i,onChange:(Y,te)=>{if(K){E(!1);return}te&&te.isNew?(br(!0),fn({vendor_name:J}),c(null),z(""),X(!1)):(c(te),X(!1))},filterOptions:(Y,te)=>{const ie=Ai(Y,te.inputValue||""),fe=!!Bs(te.inputValue||""),de=[...ie];return(te.inputValue||"").trim()!==""&&!fe&&de.push({label:`Add "${te.inputValue}" as New Vendor`,isNew:!0}),ie.length===0&&(te.inputValue||"").trim()!==""&&!fe,de},inputValue:J,onInputChange:(Y,te,ie)=>{if(z(te),ie==="reset")return;(te||"").trim()||X(!1)},options:O,getOptionLabel:Y=>typeof Y=="string"?Y:Y.label,isOptionEqualToValue:(Y,te)=>Y.id===te.id,onHighlightChange:(Y,te)=>U(te),ListboxProps:{role:"listbox",style:{maxHeight:320,overflowY:"auto"}},renderOption:(Y,te)=>{const ie=te.isNew,{key:fe,...de}=Y;return e.jsxs("li",{...de,style:{display:"flex",alignItems:"center",opacity:ie?.9:1},children:[ie&&e.jsx(Rn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),e.jsx("span",{children:te.label})]},fe)},renderInput:Y=>e.jsx(le,{...Y,label:"Vendor",error:!!pe.vendor,helperText:pe.vendor,onKeyDown:Hs,onBlur:()=>{if(X(!1),!i){const te=J.trim();if(te){const ie=Bs(te);ie&&(c(ie),z(ie.label))}}},inputRef:te=>{Z.current=te}})})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"Bill Number",value:p,onChange:Y=>{f(Y.target.value),Y.target.value.trim()!==""&&ot(!1)},fullWidth:!0,error:!!pe.billNumber,helperText:pe.billNumber})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"GST Rate (%)",type:"number",value:A,onChange:Y=>b(Number(Y.target.value)),fullWidth:!0,inputProps:{min:0,max:100,step:"0.01",readOnly:P==="Closed"&&!C,onWheel:Y=>Y.currentTarget.blur()},helperText:"Change GST rate if needed (default 5%). This will affect GST and total calculations.",disabled:P==="Closed"&&!C})})]})}),e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:3,mb:2},children:[e.jsx(h,{variant:"h6",children:"Line Items"}),e.jsx(G,{variant:"contained",onClick:Qr,startIcon:e.jsx(si,{}),sx:{backgroundColor:a?"#e0e0e0":"#ff9800",color:"#fff","&:hover":{backgroundColor:a?"#e0e0e0":"#f57c00"},"&.Mui-disabled":{color:"#fff"}},disabled:a,children:"  Allocate Parts"})]}),e.jsxs(Ae,{sx:{p:3,mb:3,mt:0},elevation:3,children:[e.jsx(M,{container:!0,spacing:2,children:w.map((Y,te)=>e.jsxs(It.Fragment,{children:[e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx($r,{disablePortal:!1,open:Yt===te,onOpen:()=>Et(te),onClose:()=>Et(null),autoHighlight:!0,value:Y.part_number,inputValue:be[te]??Y.part_number,onInputChange:(ie,fe,de)=>{if(je(Je=>({...Je,[te]:fe})),de==="reset")return;(fe||"").trim()||Et(null)},onChange:(ie,fe)=>{if(typeof fe=="string"){const de=fe,Te=V.find(W=>W.part_number===de),Je=N[de]||N[de?.toUpperCase?.()||""]||N[de?.toLowerCase?.()||""]||0,Ge=typeof Je=="string"?parseFloat(Je):Je;_(W=>{const F=[...W],se=F[te];if(Te){const oe=se.unit_cost,Oe=String(!oe||oe===""||oe==="0"?Te.last_unit_cost:oe),Ve={...se,part_number:de,part_description:Te.part_description,unit:Te.unit,unit_cost:Oe,quantity_to_order:Ge};if(Ve.line_amount=er(Ve),F[te]=Ve,Qt(Te.part_number),i?.id){const Re=(()=>{const Pt=ue[Te.part_number.toUpperCase()]||[];if(Pt.length===0)return null;const Ft=Pt.filter(tn=>tn.vendor_id===i.id);if(Ft.length>0){const tn=Ft.find(Ri=>Ri.preferred);if(tn)return tn.vendor_part_number;const bo=[...Ft].sort((Ri,kh)=>(kh.usage_count||0)-(Ri.usage_count||0))[0];if(bo)return bo.vendor_part_number}const Cr=Pt.find(tn=>tn.preferred);if(Cr)return Cr.vendor_part_number;const xs=[...Pt].sort((tn,bo)=>(bo.usage_count||0)-(tn.usage_count||0))[0];return xs?xs.vendor_part_number:null})();Re&&(F[te].part_number=Re)}}else F[te]={...se,part_number:de};return F}),Ur(te,de),Et(null),je(W=>({...W,[te]:""}))}else if(fe&&typeof fe=="object"&&"isNew"in fe){const de=fe.inputValue||"";Ne(de),ct(te),Be({part_number:de.toUpperCase(),category:"Uncategorized"}),qt("manual"),Qe(!0),Et(null),je(Te=>({...Te,[te]:""}))}},options:V.map(ie=>ie.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,handleHomeEndKeys:!0,getOptionLabel:ie=>typeof ie=="string"?ie:ie.label,renderOption:(ie,fe)=>{const de=typeof fe=="object"&&fe.isNew,Te=typeof fe=="string"?fe:fe.label,{key:Je,...Ge}=ie;return e.jsxs("li",{...Ge,children:[de&&e.jsx(Rn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof fe=="string"?e.jsxs(k,{children:[e.jsx(h,{variant:"body2",children:fe}),(()=>{const W=V.find(F=>F.part_number===fe);return W?.part_description?e.jsx(h,{variant:"caption",color:"text.secondary",children:W.part_description}):null})()]}):Te]},Je)},filterOptions:(ie,fe)=>{const de=(fe.inputValue||"").toUpperCase(),Te=ie.filter(W=>{const F=V.find(se=>se.part_number===W);return F?String(W).toUpperCase().includes(de)||String(F.part_description||"").toUpperCase().includes(de):String(W).toUpperCase().includes(de)}),Je=Te.some(W=>String(W).toUpperCase()===de),Ge=[...Te];return de&&!Je&&Ge.push({inputValue:fe.inputValue,label:`Add "${fe.inputValue}" as New Part`,isNew:!0}),Ge},ListboxProps:{role:"listbox",style:{maxHeight:320,overflowY:"auto"}},renderInput:ie=>e.jsx(le,{...ie,label:"Part Number",fullWidth:!0,required:!0,error:!!pe.lineItems?.[te]?.part_number,helperText:pe.lineItems?.[te]?.part_number,onKeyDown:fe=>Ys(te,fe),onBlur:()=>{Et(null);const de=(w[te]?.part_number||"").trim();if(!de)return;const Te=yo(de);if(Te){const Je=V.find(F=>F.part_number===Te),Ge=N[Te]||N[Te?.toUpperCase?.()||""]||N[Te?.toLowerCase?.()||""]||0,W=typeof Ge=="string"?parseFloat(Ge):Ge;_(F=>{const se=[...F],oe=se[te];if(Je){const ve=oe.unit_cost,Ve=String(!ve||ve===""||ve==="0"?Je.last_unit_cost:ve),Re={...oe,part_number:Te,part_description:Je.part_description,unit:Je.unit,unit_cost:Ve,quantity_to_order:W};Re.line_amount=er(Re),se[te]=Re}else se[te]={...oe,part_number:Te};return se}),Ur(te,Te)}}})})}),e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(le,{label:"Part Description",value:Y.part_description,InputProps:{readOnly:!0},fullWidth:!0,error:!!pe.lineItems?.[te]?.part_description,helperText:pe.lineItems?.[te]?.part_description})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Qty",value:Y.quantity,onChange:ie=>mr(te,"quantity",ie.target.value),type:"number",fullWidth:!0,required:!0,error:!!pe.lineItems?.[te]?.quantity,helperText:pe.lineItems?.[te]?.quantity,inputProps:{step:"1",onWheel:ie=>ie.currentTarget.blur()}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Unit",value:Y.unit,select:!0,fullWidth:!0,disabled:!0,InputProps:{readOnly:!0},children:yn.map(ie=>e.jsx(et,{value:ie,children:ie},ie))})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Unit Cost",value:Y.unit_cost,onChange:ie=>mr(te,"unit_cost",ie.target.value),type:"number",fullWidth:!0,error:!!pe.lineItems?.[te]?.unit_cost,helperText:pe.lineItems?.[te]?.unit_cost,inputProps:{step:"0.01",onWheel:ie=>ie.currentTarget.blur()}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Amount",value:Y.line_amount!=null&&!isNaN(Number(Y.line_amount))?Number(Y.line_amount).toFixed(2):"0.00",InputProps:{readOnly:!0},fullWidth:!0})}),e.jsxs(M,{item:!0,xs:12,sm:1,md:1,sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(G,{variant:"outlined",color:"primary",onClick:()=>Hr(te),sx:{flexShrink:0},children:"Remove"}),(()=>{const ie=a?"Open":P,fe=ie==="Open"&&typeof Y.quantity_to_order=="number"&&Y.quantity_to_order>0;return console.log(`Rendering Qty to Order for ${Y.part_number}:`,{status:P,isCreationMode:a,effectiveStatus:ie,quantity_to_order:Y.quantity_to_order,type:typeof Y.quantity_to_order,shouldShow:fe}),fe?e.jsx(le,{label:"Qty to Order",value:Y.quantity_to_order,size:"small",InputProps:{readOnly:!0},sx:{backgroundColor:"#fff3cd",minWidth:"120px","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"#ffc107"},"&:hover fieldset":{borderColor:"#ffc107"}}}}):null})()]})]},te))}),e.jsx(k,{sx:{mt:2},children:e.jsx(G,{variant:"outlined",color:"primary",onClick:os,children:"Add Line Item"})})]}),e.jsx(Ae,{sx:{p:3,mb:3},elevation:3,children:e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsxs(h,{variant:"subtitle1",children:["Subtotal: $",Gt!=null&&!isNaN(Number(Gt))?Number(Gt).toFixed(2):"0.00"]})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsxs(h,{variant:"subtitle1",children:["Total GST: $",vr!=null&&!isNaN(Number(vr))?Number(vr).toFixed(2):"0.00"]})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsxs(h,{variant:"h6",children:["Total Amount: $",qr!=null&&!isNaN(Number(qr))?Number(qr).toFixed(2):"0.00"]})})]})}),e.jsx(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:3,mb:2},children:e.jsx(h,{variant:"h6",children:"Pickup Details for Drivers"})}),e.jsx(Ae,{sx:{p:3,mb:3},elevation:3,children:e.jsxs(M,{container:!0,spacing:3,children:[e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Pickup Time",placeholder:"e.g., tomorrow at 2 PM, Friday morning",value:s?.pickup_time||"",onChange:Y=>{s&&o({...s,pickup_time:Y.target.value})},fullWidth:!0,helperText:"When to pick up the order"})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Pickup Location",placeholder:"e.g., 123 Main St, Building A, Loading Dock",value:s?.pickup_location||"",onChange:Y=>{s&&o({...s,pickup_location:Y.target.value})},fullWidth:!0,helperText:"Where to pick up the order"})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Contact Person",placeholder:"e.g., John Smith, Warehouse Manager",value:s?.pickup_contact_person||"",onChange:Y=>{s&&o({...s,pickup_contact_person:Y.target.value})},fullWidth:!0,helperText:"Name of person to contact at pickup location"})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsx(le,{label:"Contact Phone",placeholder:"e.g., (555) 123-4567",value:s?.pickup_phone||"",onChange:Y=>{s&&o({...s,pickup_phone:Y.target.value})},fullWidth:!0,helperText:"Phone number for pickup contact person"})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Pickup Instructions",placeholder:"e.g., Use loading dock on east side, call 15 minutes before arrival, parking available in lot B",value:s?.pickup_instructions||"",onChange:Y=>{s&&o({...s,pickup_instructions:Y.target.value})},fullWidth:!0,multiline:!0,rows:3,helperText:"Special instructions for pickup (parking, loading dock, etc.)"})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Pickup Notes",placeholder:"e.g., After-hours pickup available, bring ID, parts are in warehouse section C",value:s?.pickup_notes||"",onChange:Y=>{s&&o({...s,pickup_notes:Y.target.value})},fullWidth:!0,multiline:!0,rows:2,helperText:"General notes about pickup for drivers"})})]})}),e.jsx(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:3,mb:2},children:e.jsx(h,{variant:"h6",children:"Order Placement Tracking"})}),e.jsx(Ae,{sx:{p:3,mb:3},elevation:3,children:e.jsxs(M,{container:!0,spacing:3,children:[e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx("input",{type:"checkbox",checked:s?.order_placed||!1,onChange:Y=>{s&&o({...s,order_placed:Y.target.checked,order_placed_at:Y.target.checked?new Date().toISOString():void 0,order_placed_by:Y.target.checked?Number(n?.id):void 0,order_placed_method:Y.target.checked?"manual":void 0})},style:{transform:"scale(1.5)"}}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"Order Placed with Vendor"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:s?.order_placed?`Placed on ${new Date(s.order_placed_at||"").toLocaleDateString()}`:"Order not yet placed"})]})]})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsxs(le,{select:!0,label:"Vendor Confirmation Status",value:s?.vendor_confirmation_status||"pending",onChange:Y=>{s&&o({...s,vendor_confirmation_status:Y.target.value,vendor_confirmation_date:Y.target.value!=="pending"?new Date().toISOString():void 0})},fullWidth:!0,helperText:"Current vendor confirmation status",children:[e.jsx(et,{value:"pending",children:"Pending"}),e.jsx(et,{value:"confirmed",children:"Confirmed"}),e.jsx(et,{value:"partial",children:"Partially Available"}),e.jsx(et,{value:"unavailable",children:"Unavailable"})]})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Vendor Confirmation Notes",placeholder:"e.g., Parts available, pricing confirmed, minimum order 10ft packs",value:s?.vendor_confirmation_notes||"",onChange:Y=>{s&&o({...s,vendor_confirmation_notes:Y.target.value})},fullWidth:!0,multiline:!0,rows:2,helperText:"Notes from vendor about order confirmation, availability, and pricing"})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx("input",{type:"checkbox",checked:s?.pricing_updated||!1,onChange:Y=>{s&&o({...s,pricing_updated:Y.target.checked,pricing_updated_at:Y.target.checked?new Date().toISOString():void 0,pricing_updated_by:Y.target.checked?Number(n?.id):void 0,pricing_updated_method:Y.target.checked?"manual":void 0})},style:{transform:"scale(1.5)"}}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"Pricing Updated"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:s?.pricing_updated?`Updated on ${new Date(s.pricing_updated_at||"").toLocaleDateString()}`:"Pricing not yet updated"})]})]})}),e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx("input",{type:"checkbox",checked:s?.quantity_adjusted||!1,onChange:Y=>{s&&o({...s,quantity_adjusted:Y.target.checked,quantity_adjusted_at:Y.target.checked?new Date().toISOString():void 0,quantity_adjusted_by:Y.target.checked?Number(n?.id):void 0,quantity_adjusted_method:Y.target.checked?"manual":void 0})},style:{transform:"scale(1.5)"}}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"Quantities Adjusted"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:s?.quantity_adjusted?`Adjusted on ${new Date(s.quantity_adjusted_at||"").toLocaleDateString()}`:"Quantities not yet adjusted"})]})]})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Vendor Pricing Structure Notes",placeholder:"e.g., Sold by 10ft packs, minimum order 50ft, bulk pricing available over 100ft",value:s?.vendor_pricing_notes||"",onChange:Y=>{s&&o({...s,vendor_pricing_notes:Y.target.value})},fullWidth:!0,multiline:!0,rows:2,helperText:"Notes about vendor pricing structure, minimum orders, and packaging units"})}),e.jsxs(M,{item:!0,xs:12,children:[e.jsx(k,{sx:{display:"flex",justifyContent:"center",mt:2},children:e.jsx(G,{variant:"outlined",color:"primary",onClick:cs,disabled:!s||w.length===0,sx:{minWidth:"200px"},children:"Adjust Quantities (Vendor Confirmation)"})}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{textAlign:"center",mt:1},children:"Use this when vendor confirms different quantities (e.g., sold by 10ft packs)"})]}),(s?.original_quantities||s?.adjusted_quantities)&&e.jsxs(M,{item:!0,xs:12,children:[e.jsx(h,{variant:"subtitle1",sx:{fontWeight:"bold",mb:2},children:"Quantity Adjustments"}),e.jsx(M,{container:!0,spacing:2,children:w.map((Y,te)=>{const ie=s?.original_quantities?.[te]||Y.quantity,fe=s?.adjusted_quantities?.[te]||Y.quantity;return ie!==fe?e.jsx(M,{item:!0,xs:12,sm:6,children:e.jsxs(Ae,{sx:{p:2,backgroundColor:"#f5f5f5"},elevation:1,children:[e.jsx(h,{variant:"body2",sx:{fontWeight:"bold"},children:Y.part_number}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Original: ",ie,"  Adjusted: ",fe]})]})},te):null})})]})]})}),e.jsx(ts,{open:Ye,onClose:vo,onSave:async Y=>{try{const te=await B.post("/api/inventory",Y);console.log("New part added successfully:",te.data);const ie=await B.get("/api/inventory");q(ie.data);const fe=te.data.item;lt!==null&&_(de=>{const Te=[...de];return Te[lt]={...Te[lt],part_number:fe.part_number,part_description:fe.part_description,unit:fe.unit,unit_cost:String(fe.last_unit_cost),quantity:Te[lt].quantity},Te[lt].line_amount=er(Te[lt]),Te}),vo()}catch(te){throw te}},title:Ct==="ocr"?"Add New Part from OCR":"Add New Part",initialPart:tt??{part_number:ut.toUpperCase(),category:"Uncategorized"}}),e.jsx(Vp,{open:go,onClose:()=>{br(!1),fn({})},onSave:async Y=>{try{const ie=(await B.post("/api/vendors",Y)).data.vendor;ee(fe=>[...fe,{label:ie.vendor_name,id:ie.vendor_id,email:ie.email}]),c({label:ie.vendor_name,id:ie.vendor_id,email:ie.email}),!a&&s&&o(fe=>fe&&{...fe,vendor_id:ie.vendor_id,vendor_name:ie.vendor_name}),br(!1),fn({}),H.success("Vendor added successfully!")}catch{H.error("Failed to add vendor.")}},initialVendor:ms,isEditMode:!1}),e.jsx(ww,{open:kn,onClose:()=>ho(!1),purchaseOrderId:s?.purchase_id||0,onSuccess:Cn,onAllocationSaved:is}),e.jsx(mh,{open:Fn,onClose:()=>zs(!1),type:"purchase-order",recordId:s?.purchase_id,defaultTo:$n,allowMessageEdit:!0}),Fn&&e.jsxs("div",{style:{display:"none"},children:["Debug: vendorEmail = ",$n,", vendor = ",JSON.stringify(i)]})]})]}),e.jsx(bn,{open:!!St,autoHideDuration:6e3,onClose:()=>Ht(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(We,{onClose:()=>Ht(null),severity:"success",sx:{width:"100%"},children:St})})]})};var qa={},au;function Pw(){if(au)return qa;au=1;var t=yt();Object.defineProperty(qa,"__esModule",{value:!0}),qa.default=void 0;var r=t(bt()),n=vt();return qa.default=(0,r.default)((0,n.jsx)("path",{d:"m22 9.24-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28z"}),"StarBorder"),qa}var Dw=Pw();const Ew=st(Dw);var Ua={},ou;function Iw(){if(ou)return Ua;ou=1;var t=yt();Object.defineProperty(Ua,"__esModule",{value:!0}),Ua.default=void 0;var r=t(bt()),n=vt();return Ua.default=(0,r.default)((0,n.jsx)("path",{d:"M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"}),"Star"),Ua}var Tw=Iw();const Ow=st(Tw);var Wa={},iu;function Aw(){if(iu)return Wa;iu=1;var t=yt();Object.defineProperty(Wa,"__esModule",{value:!0}),Wa.default=void 0;var r=t(bt()),n=vt();return Wa.default=(0,r.default)((0,n.jsx)("path",{d:"M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3m5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72z"}),"Mic"),Wa}var Mw=Aw();const Rw=st(Mw);var Fa={},lu;function Nw(){if(lu)return Fa;lu=1;var t=yt();Object.defineProperty(Fa,"__esModule",{value:!0}),Fa.default=void 0;var r=t(bt()),n=vt();return Fa.default=(0,r.default)((0,n.jsx)("path",{d:"M6 6h12v12H6z"}),"Stop"),Fa}var Lw=Nw();const qw=st(Lw);class Uw{mediaRecorder=null;audioChunks=[];isRecording=!1;stream=null;async startRecording(){try{this.stream=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});const r={mimeType:"audio/webm;codecs=opus",audioBitsPerSecond:16e3};MediaRecorder.isTypeSupported(r.mimeType)||delete r.mimeType,this.mediaRecorder=new MediaRecorder(this.stream,r),this.audioChunks=[],this.isRecording=!0,this.mediaRecorder.ondataavailable=n=>{n.data.size>0&&this.audioChunks.push(n.data)},this.mediaRecorder.start(1e3)}catch(r){throw console.error("Error starting voice recording:",r),new Error("Failed to start voice recording. Please check microphone permissions.")}}async stopRecording(){return new Promise((r,n)=>{if(!this.mediaRecorder||!this.isRecording){n(new Error("No active recording"));return}this.mediaRecorder.onstop=async()=>{try{this.isRecording=!1;const a=new Blob(this.audioChunks,{type:"audio/wav"}),s=await this.processAudioQuery(a);r(s)}catch(a){n(a)}finally{this.cleanup()}},this.mediaRecorder.stop()})}cleanup(){this.stream&&(this.stream.getTracks().forEach(r=>r.stop()),this.stream=null),this.mediaRecorder=null,this.audioChunks=[],this.isRecording=!1}async processAudioQuery(r){try{if(r.size>1048576)throw new Error(`Audio file too large (${(r.size/1024/1024).toFixed(2)}MB). Please record a shorter message.`);const a=await this.blobToBase64(r);return(await B.post("/api/voice-search/search-parts",{audioData:a,audioFormat:r.type||"audio/webm"})).data}catch(n){throw console.error("Error processing voice query:",n),n instanceof Error?new Error(n.message):new Error("Failed to process voice query. Please try again.")}}blobToBase64(r){return new Promise((n,a)=>{const s=new FileReader;s.onload=()=>{const i=s.result.split(",")[1];n(i)},s.onerror=a,s.readAsDataURL(r)})}async interpretTextQuery(r){try{return(await B.post("/api/voice-search/interpret-query",{query:r})).data}catch(n){return console.error("Error interpreting text query:",n),{query:r,searchInPartNumbers:!0,searchInDescriptions:!0,extractedTerms:[r]}}}isRecordingActive(){return this.isRecording}cancelRecording(){this.isRecording&&(this.mediaRecorder?.stop(),this.cleanup())}}const Ww=new Uw,Fw=({onSearchTerms:t,disabled:r=!1})=>{const[n,a]=l.useState(!1),[s,o]=l.useState(!1),[i,c]=l.useState(""),u=l.useRef(null),d=l.useRef(null),p=()=>{const w=typeof window<"u"&&window.process&&window.process.type;if(typeof window<"u"&&"webkitSpeechRecognition"in window&&!u.current){const _=window.webkitSpeechRecognition||window.SpeechRecognition;u.current=new _,u.current.continuous=!1,u.current.interimResults=!0,u.current.lang="en-US",w&&console.log("Running in Electron environment"),u.current.onresult=P=>{let L="",C="";for(let D=P.resultIndex;D<P.results.length;D++){const A=P.results[D][0].transcript;P.results[D].isFinal?L+=A:C+=A}c(L+C),L.trim()&&j(L.trim())},u.current.onerror=P=>{console.error("Speech recognition error:",P.error),P.error==="network"?(typeof window<"u"&&window.process&&window.process.type?H.error("Voice recognition network error in Electron. Please try again or use text search."):H.error("Voice recognition requires internet connection. Please try again."),a(!1)):P.error==="not-allowed"?(H.error("Microphone access denied. Please allow microphone access."),a(!1)):P.error==="no-speech"?(H.info("No speech detected. Please try again."),a(!1)):P.error==="audio-capture"?(H.error("Audio capture error. Please check your microphone."),a(!1)):P.error==="service-not-allowed"?(H.error("Voice recognition service not allowed. This is common in Electron apps."),a(!1)):(console.error("Speech recognition error:",P.error),H.error(`Voice recognition error: ${P.error}. Please try again.`),a(!1))},u.current.onend=()=>{a(!1),c("")}}},f=()=>{try{if(!(typeof window<"u"&&("webkitSpeechRecognition"in window||"SpeechRecognition"in window))){H.error("Voice recognition not available in this browser.");return}typeof window<"u"&&window.process&&window.process.type&&H.info("Voice recognition in Electron may have limitations. If it doesn't work, please use text search."),p(),u.current&&(a(!0),c(""),u.current.start(),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{n&&m()},8e3))}catch(w){console.error("Error starting voice recognition:",w),H.error("Failed to start voice recognition."),a(!1)}},m=()=>{u.current&&u.current.stop(),a(!1),d.current&&clearTimeout(d.current)},j=async w=>{try{o(!0),c("");const _=await Ww.interpretTextQuery(w);t(_.extractedTerms,{searchInPartNumbers:_.searchInPartNumbers,searchInDescriptions:_.searchInDescriptions}),H.success(`Voice search: "${w}"  ${_.extractedTerms.join(", ")}`)}catch(_){console.error("Error processing voice input:",_),H.error("Failed to process voice input. Please try again.")}finally{o(!1)}},v=()=>{n?m():f()};return e.jsxs(k,{children:[e.jsx(G,{variant:"contained",size:"large",onClick:v,disabled:r||s,startIcon:s?e.jsx(it,{size:20,color:"inherit"}):n?e.jsx(qw,{}):e.jsx(Rw,{}),sx:{backgroundColor:n?"error.main":"primary.main",color:"white","&:hover":{backgroundColor:n?"error.dark":"primary.dark"},minWidth:120,height:48},children:s?"Processing...":n?"Stop":"Voice Search"}),n&&e.jsxs(k,{display:"flex",alignItems:"center",gap:1,mt:1,children:[e.jsx(k,{sx:{width:8,height:8,borderRadius:"50%",backgroundColor:"error.main",animation:"pulse 1s infinite","@keyframes pulse":{"0%":{opacity:1},"50%":{opacity:.3},"100%":{opacity:1}}}}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:["Listening... ",i&&`"${i}"`]})]})]})},$w="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),zw="0123456789".split("");function fh(t,r,n){return`so:${r}:${t}:${n}`}function cu(t,r,n){try{const a=localStorage.getItem(fh(t,r,n));if(!a)return[];const s=JSON.parse(a);return Array.isArray(s)?s:[]}catch{return[]}}function du(t,r,n,a){try{localStorage.setItem(fh(t,r,n),JSON.stringify(a.slice(0,50)))}catch{}}function xh(){return"partFinder:usage:global"}function gh(t,r){return`partFinder:usage:so:${t}:${r}`}function Bw(){try{const t=localStorage.getItem(xh());return t?JSON.parse(t):{}}catch{return{}}}function Hw(t){try{localStorage.setItem(xh(),JSON.stringify(t))}catch{}}function Yw(t,r){try{const n=localStorage.getItem(gh(t,r));return n?JSON.parse(n):{}}catch{return{}}}function Vw(t,r,n){try{localStorage.setItem(gh(t,r),JSON.stringify(n))}catch{}}function Gw(t){const{open:r,onClose:n,onSelect:a,salesOrderId:s,context:o,inventoryItems:i}=t,[c,u]=l.useState(""),[d,p]=l.useState(""),[f,m]=l.useState([]),[j,v]=l.useState([]),[w,_]=l.useState([]),[P,L]=l.useState({}),[C,D]=l.useState({}),[A,b]=l.useState([]),[N,g]=l.useState(null);l.useEffect(()=>{r&&(v(cu("favorites",s,o)),_(cu("recents",s,o)),L(Yw(s,o)),D(Bw()))},[r,s,o]);const x=l.useMemo(()=>{const I=c.toUpperCase(),y=new Set(f.map(K=>K.toUpperCase())),S=new Set(A.map(K=>K.toUpperCase())),U=d.trim().toUpperCase();return i.filter(K=>{const E=(K.part_number||"").toUpperCase(),V=(K.part_description||"").toUpperCase();if(I&&!E.startsWith(I)||U&&!(E.includes(U)||V.includes(U)))return!1;for(const q of y)if(!(E.includes(q)||V.includes(q)))return!1;if(A.length>0&&N){let q=!1;for(const ue of S){if(N.searchInPartNumbers&&E.includes(ue)){q=!0;break}if(N.searchInDescriptions&&V.includes(ue)){q=!0;break}}if(!q)return!1}return!0})},[i,c,f,d,A,N]),R=l.useMemo(()=>{const I={},y=new Set(f.map(ge=>ge.toUpperCase())),S=new Set(j),U=new Set(w),K={SS:"STAINLESS",STAIN:"STAINLESS",STAINLESS:"STAINLESS",AL:"ALUMINUM",ALUM:"ALUMINUM",GALV:"GALVANIZED",GALVANIZED:"GALVANIZED",SQ:"SQUARE",RECT:"RECTANGULAR",TUBE:"TUBING"},E=new Set(["TUBING","PIPE","ANGLE","BAR","FLAT","BEAM","CHANNEL","SHEET","PLATE","ROUND","SQUARE","RECTANGULAR"]),V=ge=>K[ge]||ge,q=(ge,xe)=>{const me=ge.trim();!me||y.has(me)||(I[me]=(I[me]||0)+xe)},ue=ge=>{const[xe,me]=ge.split("/").map(Number);return!xe||!me?null:(xe/me).toFixed(4).replace(/0+$/,"").replace(/\.$/,"")},ye=ge=>{const xe=[];if(!ge)return xe;let me=ge.toUpperCase().replace(/[\s-]+/g,"").replace(//g,"X").replace(/[()]/g,"");const he=me.match(/\d+\/\d+/g)||[];if(me.includes("X")){const ae=me.split("X");ae.length>=2&&ae.length<=4&&(xe.push(ae.slice(0,2).join("X")),xe.push(ae.join("X")))}return he.forEach(ae=>{xe.push(ae);const T=ue(ae);T&&xe.push(T)}),(me.match(/(\d+)GA/g)||[]).forEach(ae=>xe.push(ae)),(me.match(/SCH\s*\d+/g)||[]).forEach(ae=>xe.push(ae.replace(/\s+/g,""))),(me.match(/OD\d+(?:\.\d+)?/g)||[]).forEach(ae=>xe.push(ae)),(me.match(/ID\d+(?:\.\d+)?/g)||[]).forEach(ae=>xe.push(ae)),(me.match(/\d+(?:\.\d+)?/g)||[]).slice(0,3).forEach(ae=>xe.push(ae)),Array.from(new Set(xe))};for(const ge of x){const me=String(ge.part_description||"").toUpperCase().split(/[^A-Z0-9]+/).filter(tt=>tt.length>=2&&!y.has(tt)).map(V),he=P[ge.part_number]?.count||0,ae=C[ge.part_number]?.count||0,T=P[ge.part_number]?.last||0,$=Date.now(),ce=T?($-T)/(1e3*60*60*24):365,re=ce<=7?1:ce<=30?.5:0;let Me=1+he*.5+ae*.25+re;S.has(ge.part_number)&&(Me+=3),U.has(ge.part_number)&&(Me+=1);const Ce=d.trim().toUpperCase(),Ye=(ge.part_number||"").toUpperCase(),Qe=(ge.part_description||"").toUpperCase(),lt=Ce&&(Ye.startsWith(Ce)||Qe.includes(Ce))?.5:0,ct=[];me.forEach(tt=>{E.has(tt)&&ct.push(tt),q(tt,Me*(1+lt+(Ce&&tt.includes(Ce)?.5:0)))});const ut=Array.from(new Set(me));ut.forEach(tt=>ut.forEach(Be=>{tt!==Be&&(E.has(tt)||E.has(Be))&&q(`${tt} ${Be}`,Me*1.2)}));const Ne=ye(Ye);Ne.forEach(tt=>q(tt,Me*1.3)),Ne[0]&&ct.slice(0,2).forEach(tt=>q(`${tt} ${Ne[0]}`,Me*1.5))}return Object.entries(I).sort((ge,xe)=>xe[1]-ge[1]).slice(0,24).map(([ge])=>ge)},[x,f,j,w,P,C,d]),O=x,ee=l.useMemo(()=>O.slice(0,200),[O]),J=I=>{m(y=>y.includes(I)?y.filter(S=>S!==I):[...y,I])},z=()=>{u(""),m([]),b([]),g(null)},Z=I=>j.includes(I),Q=I=>{v(y=>{const S=y.includes(I)?y.filter(U=>U!==I):[I,...y];du("favorites",s,o,S);try{fetch(`/api/part-finder/${s}/favorite`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_number:I,context:o,value:!y.includes(I)})}).catch(()=>{})}catch{}return S})},X=I=>{_(y=>{const S=[I.part_number,...y.filter(U=>U!==I.part_number)].slice(0,20);return du("recents",s,o,S),S}),L(y=>{const S={...y},U=S[I.part_number]||{count:0,last:0};return U.count+=1,U.last=Date.now(),S[I.part_number]=U,Vw(s,o,S),S}),D(y=>{const S={...y},U=S[I.part_number]||{count:0,last:0};return U.count+=1,U.last=Date.now(),S[I.part_number]=U,Hw(S),S}),a(I);try{fetch(`/api/part-finder/${s}/use`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_number:I.part_number,context:o})}).catch(()=>{})}catch{}};return e.jsxs(mt,{open:r,onClose:n,maxWidth:"lg",fullWidth:!0,fullScreen:!1,"aria-labelledby":"part-finder-title",children:[e.jsx(ft,{id:"part-finder-title",children:"Find Part"}),e.jsxs(xt,{dividers:!0,children:[e.jsx(k,{mb:2,children:e.jsxs(k,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[e.jsx(le,{fullWidth:!0,placeholder:"Search by part # or description",value:d,onChange:I=>p(I.target.value),InputProps:{startAdornment:e.jsx(pr,{position:"start",children:e.jsx(Br,{})})}}),e.jsx(Fw,{onSearchTerms:(I,y)=>{b(I),g(y)},disabled:!1})]})}),null,e.jsxs(k,{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mb:2,children:[!!c&&e.jsx(De,{label:`Prefix: ${c}`,color:"primary",onDelete:()=>u(""),sx:{height:40,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:16,fontWeight:600}}}),f.map(I=>e.jsx(De,{label:I,color:"secondary",onDelete:()=>J(I),sx:{height:38,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:15,fontWeight:600}}},I)),A.length>0&&e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(h,{variant:"caption",color:"text.secondary",children:"Voice:"}),A.map(I=>e.jsx(De,{label:I,color:"success",variant:"outlined",size:"small",sx:{height:32,"& .MuiChip-label":{px:1.5,py:.5,fontSize:12}}},I)),N&&e.jsxs(h,{variant:"caption",color:"text.secondary",sx:{ml:1},children:["(",N.searchInPartNumbers?"Part#":"",N.searchInPartNumbers&&N.searchInDescriptions?" + ":"",N.searchInDescriptions?"Desc":"",")"]})]}),(!!c||f.length>0||A.length>0)&&e.jsx(G,{onClick:z,children:"Clear All"})]}),e.jsxs(k,{display:"flex",gap:2,mb:2,flexWrap:"wrap",children:[e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:"Part # Starts With"}),e.jsxs(k,{display:"flex",flexWrap:"wrap",gap:1.5,children:[$w.map(I=>e.jsx(De,{label:I,variant:c.startsWith(I)?"filled":"outlined",onClick:()=>u(I),sx:{height:44,borderRadius:2,"& .MuiChip-label":{px:2.25,py:1.25,fontSize:18,fontWeight:700}}},I)),zw.map(I=>e.jsx(De,{label:I,variant:c.startsWith(I)?"filled":"outlined",onClick:()=>u(I),sx:{height:44,borderRadius:2,"& .MuiChip-label":{px:2.25,py:1.25,fontSize:18,fontWeight:700}}},I))]})]}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:"Description Tokens"}),e.jsx(k,{display:"flex",flexWrap:"wrap",gap:1.5,children:R.map(I=>e.jsx(De,{label:I,clickable:!0,color:f.includes(I)?"secondary":"default",onClick:()=>J(I),sx:{height:40,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:16,fontWeight:600}}},I))})]})]}),e.jsx(xr,{sx:{my:2}}),e.jsxs(k,{mb:2,children:[j.length>0&&e.jsxs(k,{mb:1,children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:"Favorites for this Sales Order"}),e.jsx(k,{display:"flex",flexWrap:"wrap",gap:1.25,children:j.map(I=>{const y=i.find(S=>S.part_number===I);return y?e.jsx(De,{label:`${y.part_number}`,onClick:()=>X(y),title:y.part_description,sx:{height:38,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:15,fontWeight:600}}},I):null})})]}),w.length>0&&e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:"Recents for this Sales Order"}),e.jsx(k,{display:"flex",flexWrap:"wrap",gap:1.25,children:w.map(I=>{const y=i.find(S=>S.part_number===I);return y?e.jsx(De,{variant:"outlined",label:`${y.part_number}`,onClick:()=>X(y),title:y.part_description,sx:{height:38,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:15,fontWeight:600}}},I):null})})]})]}),e.jsxs(M,{container:!0,spacing:2,children:[ee.map(I=>e.jsx(M,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsxs(k,{sx:{border:"1px solid #ddd",borderRadius:1,p:1.5,display:"flex",flexDirection:"column",gap:1,height:"100%"},children:[e.jsxs(k,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(h,{variant:"subtitle1",sx:{fontWeight:700},children:I.part_number}),e.jsx(Vt,{title:Z(I.part_number)?"Remove favorite":"Add favorite",children:e.jsx(gt,{size:"small",onClick:()=>Q(I.part_number),children:Z(I.part_number)?e.jsx(Ow,{color:"warning",fontSize:"small"}):e.jsx(Ew,{fontSize:"small"})})})]}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{minHeight:40},children:I.part_description||""}),e.jsxs(k,{mt:"auto",display:"flex",gap:1,children:[e.jsx(G,{variant:"contained",size:"small",onClick:()=>X(I),children:"Add"}),e.jsx(G,{variant:"outlined",size:"small",onClick:()=>{X(I)},children:"Add & Keep Open"})]})]})},I.part_number)),ee.length===0&&e.jsx(M,{item:!0,xs:12,children:e.jsx(h,{variant:"body2",color:"text.secondary",children:"No parts match the current filters."})})]})]}),e.jsx(_t,{children:e.jsx(G,{onClick:n,children:"Close"})})]})}const uu=["Each","cm","ft","kg","pcs","hr","L"],tl=5,pu=()=>{const{id:t}=wn(),r=Kt(),n=!!t&&/^\d+$/.test(t);console.log("WokerSalesOrderPage: Component rendered with id:",t,"isNumericId:",n),l.useEffect(()=>(console.log("WokerSalesOrderPage: Component mounted"),()=>{console.log("WokerSalesOrderPage: Component unmounted")}),[]);const[a,s]=l.useState(null),[o,i]=l.useState(!0),[c,u]=l.useState(null),[d,p]=l.useState(null),[f,m]=l.useState([]),[j,v]=l.useState([]),[w,_]=l.useState(null),[P,L]=l.useState(null),[C,D]=l.useState([]),[A,b]=l.useState([]),[N,g]=l.useState([]),[x,R]=l.useState([]),O=l.useRef(null),ee=l.useRef(0);l.useLayoutEffect(()=>{const _e=O.current,be=_e?_e.getBoundingClientRect().height:0,je=be-ee.current;je!==0&&(window.scrollBy({top:je,left:0,behavior:"auto"}),ee.current=be)},[N.length]);const[J,z]=l.useState(null),[Z,Q]=l.useState(null),[X,I]=l.useState(null),[y,S]=l.useState(!1),[U,K]=l.useState(null),[E,V]=l.useState(""),[q,ue]=l.useState(!1),[ye,ge]=l.useState(null),[xe,me]=l.useState(""),[he,ae]=l.useState(!1),[T,$]=l.useState("line"),[ce,re]=l.useState(0),Me=_e=>{const be=[...j].sort((je,pe)=>je.cost_lower_bound-pe.cost_lower_bound);for(const je of be){const pe=+je.cost_lower_bound,Ee=je.cost_upper_bound==null?null:+je.cost_upper_bound,Fe=+je.margin_factor;if(_e>=pe&&(Ee===null||_e<Ee))return Fe}return 1},Ce=_e=>f.find(be=>be.part_number===_e),Ye=(_e,be)=>{const je=f.find(St=>St.part_number.toLowerCase()===_e.part_number.toLowerCase());if(!je||je.part_type==="supply")return null;const pe=parseFloat(je.quantity_on_hand)||0,Ee=C.filter(St=>St.part_number.toLowerCase()===_e.part_number.toLowerCase()).reduce((St,Ht)=>St+(parseFloat(String(Ht.quantity).replace(/[^\d.-]/g,""))||0),0),Fe=A.filter(St=>St.part_number.toLowerCase()===_e.part_number.toLowerCase()).reduce((St,Ht)=>St+(parseFloat(String(Ht.quantity).replace(/[^\d.-]/g,""))||0),0),ze=Ee-Fe,Ze=pe-ze,ot=Ze<0?Math.floor(Ze):Math.round(Ze);return{available:ot,isNegative:ot<0,currentStock:pe,changeInQuantity:ze,totalQuantityForPart:Ee,totalOriginalQuantityForPart:Fe}},Qe=(_e,be)=>{const je=C.filter(Ee=>Ee.part_number.toLowerCase()===_e.part_number.toLowerCase());if(je.length<=1)return!0;const pe=Math.max(...je.map((Ee,Fe)=>C.findIndex(ze=>ze.part_number.toLowerCase()===_e.part_number.toLowerCase()&&C.indexOf(ze)===Fe)));return be===pe},lt=l.useMemo(()=>C.map(_e=>({part_number:_e.part_number,part_description:_e.part_description,quantity:nn(_e.quantity),unit:_e.unit,unit_price:nn(_e.unit_price)})),[C]),ct=l.useMemo(()=>lt.reduce((_e,be)=>_e+Do(be.quantity,be.unit_price),0),[lt]),ut=l.useMemo(()=>ct*(tl/100),[ct]);l.useMemo(()=>ct+ut,[ct,ut]);const[Ne,tt]=l.useState("");l.useEffect(()=>{a&&tt(JSON.stringify({lineItems:C,partsToOrder:x}))},[a]);const Be=!!Ne&&Ne!==JSON.stringify({lineItems:C,partsToOrder:x});l.useEffect(()=>{(async()=>{try{const[_e,be,je,pe]=await Promise.all([B.get("/api/inventory"),B.get("/api/margin-schedule"),B.get("/api/settings/labour-rate").catch(()=>({data:{labour_rate:null}})),B.get("/api/settings/overhead-rate").catch(()=>({data:{overhead_rate:null}}))]);m(_e.data),v(be.data),_(je.data.labour_rate??null),L(pe.data.overhead_rate??null)}catch(_e){console.error("Prefetch failed",_e)}})()},[]),l.useEffect(()=>{if(console.log("WokerSalesOrderPage: useEffect triggered with id:",t,"isNumericId:",n),!t||!n){console.log("WokerSalesOrderPage: Invalid ID, setting error"),u("Invalid sales order ID."),i(!1);return}(async()=>{console.log("WokerSalesOrderPage: Fetching sales order data for ID:",t),i(!0),u(null);try{console.log("WokerSalesOrderPage: Making API call to /api/sales-orders/${id}");const _e=await B.get(`/api/sales-orders/${t}`);if(console.log("WokerSalesOrderPage: API response received:",_e),console.log("WokerSalesOrderPage: API response data:",_e.data),!_e.data||!_e.data.salesOrder){console.error("WokerSalesOrderPage: No sales order data in response"),u("Invalid response format from server"),i(!1);return}const be=_e.data.salesOrder;console.log("WokerSalesOrderPage: Parsed sales order:",be),s({sales_order_id:be.sales_order_id,sales_order_number:be.sales_order_number,status:be.status});const je=(_e.data.lineItems||be?.line_items||[]).filter(Ee=>!["LABOUR","OVERHEAD","SUPPLY"].includes(Ee.part_number?.toUpperCase())).map(Ee=>({line_item_id:Ee.line_item_id,part_number:Ee.part_number,part_description:Ee.part_description,unit:Ee.unit,unit_price:Ee.unit_price,line_amount:Ee.line_amount,quantity:String(Ee.quantity_sold??Ee.quantity??0),gst:tl,part_id:Ee.part_id??void 0}));console.log("WokerSalesOrderPage: Loaded line items (filtered):",je),D(je),b(je);const pe=(_e.data.partsToOrder||[]).map(Ee=>({sales_order_id:be.sales_order_id,part_number:Ee.part_number,part_description:Ee.part_description,quantity_to_order:String(Ee.quantity_needed??Ee.quantity_to_order??""),unit:Ee.unit||"Each",unit_price:Number(Ee.unit_price||0),line_amount:Number(Ee.line_amount||0)}));console.log("WokerSalesOrderPage: Loaded parts to order:",pe),R(pe),console.log("WokerSalesOrderPage: Successfully loaded sales order data")}catch(_e){console.error("WokerSalesOrderPage: Error loading sales order:",_e),console.error("WokerSalesOrderPage: Error details:",{message:_e?.message,status:_e?.response?.status,statusText:_e?.response?.statusText,data:_e?.response?.data,url:_e?.config?.url}),u(_e?.response?.status===404?"Sales order not found. It may have been deleted.":"Failed to load sales order data. Please try again.")}finally{i(!1)}})()},[t,n]),l.useEffect(()=>{w!==null&&D(_e=>_e.map(be=>be.part_number==="LABOUR"?{...be,unit_price:w}:be))},[w]),l.useEffect(()=>{P!==null&&D(_e=>_e.map(be=>be.part_number==="OVERHEAD"?{...be,unit_price:P}:be))},[P]),l.useEffect(()=>{const _e=[];C.forEach((be,je)=>{if(Qe(be,je)){const pe=Ye(be);pe&&pe.available<0&&_e.push({lineItemIndex:je,partNumber:be.part_number,partDescription:be.part_description,excessQuantity:Math.abs(pe.available),unit:be.unit})}}),g(_e)},[C,f]);const Ct=(_e,be)=>{D(je=>{const pe=[...je];if(!be||be.trim()==="")pe[_e]={...pe[_e],part_number:"",part_description:"",quantity:"",unit:uu[0],unit_price:0,line_amount:0};else{const ze=Ce(be);if(ze){const Ze=parseFloat(String(ze.last_unit_cost))||0,ot=Me(Ze);pe[_e]={...pe[_e],part_number:be,part_description:ze.part_description||"",unit:ze.unit||"Each",unit_price:Ze*ot}}else pe[_e]={...pe[_e],part_number:be,part_description:"Part not found",unit_price:0}}const Ee=nn(pe[_e].quantity),Fe=nn(pe[_e].unit_price);return pe[_e].line_amount=Do(Ee,Fe),pe})},qt=(_e,be,je)=>{D(pe=>{const Ee=[...pe],Fe={...Ee[_e],[be]:je};if(parseFloat(je)<=0)return Ee.filter((ot,St)=>St!==_e);const ze=nn(Fe.quantity),Ze=nn(Fe.unit_price);return Fe.line_amount=Do(ze,Ze),Ee[_e]=Fe,Ee})},Bt=()=>{D(_e=>[..._e,{part_number:"",part_description:"",quantity:"",unit:uu[0],unit_price:0,gst:tl,line_amount:0}])},Ke=_e=>{D(be=>be.filter((je,pe)=>pe!==_e))},Yt=()=>{if(C.filter(pe=>!pe.part_number||pe.part_number.trim()==="").length>0)return H.error("Line items with blank part numbers are not allowed."),!1;const be=C.filter(pe=>{if(["LABOUR","OVERHEAD","SUPPLY"].includes(String(pe.part_number).toUpperCase()))return!1;const Ee=pe.part_id;if(Ee){const ze=(f||[]).find(Ze=>Ze.part_id===Ee);return ze?ze.part_type==="supply":!1}const Fe=(f||[]).find(ze=>String(ze.part_number).toUpperCase()===String(pe.part_number).trim().toUpperCase());return!Fe||Fe.part_type==="supply"});if(be.length>0){const pe=be.map(Ee=>Ee.part_number).join(", ");return H.error(`Invalid or supply parts (not allowed): ${pe}`),!1}return C.some((pe,Ee)=>{if(!Qe(pe,Ee))return!1;const Fe=Ye(pe);return Fe&&Fe.available<0})?(H.error("Insufficient inventory for one or more parts."),!1):!0},Et=_e=>{const be=_e.reduce((je,pe)=>{const Ee=pe.part_number.trim().toLowerCase();if(!je[Ee]){const ze=["LABOUR","OVERHEAD","SUPPLY"].includes(pe.part_number.toUpperCase())?null:(f||[]).find(Ze=>String(Ze.part_number).toUpperCase()===pe.part_number.trim().toUpperCase());je[Ee]={part_number:pe.part_number.trim(),part_description:pe.part_description.trim(),unit:pe.unit.trim(),unit_price:pe.unit_price!=null?Number(pe.unit_price):0,line_amount:0,quantity_sold:0,...pe.part_id?{part_id:pe.part_id}:ze&&ze.part_id?{part_id:ze.part_id}:{}}}const Fe=parseFloat(String(pe.quantity).replace(/[^\d.-]/g,""))||0;return je[Ee].quantity_sold+=Math.round(Fe),je[Ee].line_amount+=Fe*(pe.unit_price||0),je},{});return Object.values(be)},zt=async()=>{if(a&&Yt())try{const _e={lineItems:Et(C),partsToOrder:x.filter(be=>be.part_number&&parseFloat(String(be.quantity_to_order))>0).map(be=>({sales_order_id:a.sales_order_id,part_number:be.part_number.trim(),part_description:be.part_description.trim(),quantity_needed:parseFloat(String(be.quantity_to_order))||0,unit:be.unit.trim(),unit_price:be.unit_price,line_amount:be.line_amount}))};await B.put(`/api/sales-orders/${a.sales_order_id}`,_e),p("Sales Order updated successfully!"),tt(JSON.stringify({lineItems:C,partsToOrder:x}));try{const be=await B.get("/api/inventory");m(be.data)}catch{}}catch(_e){const be=_e?.response?.data?.error||_e?.response?.data?.details||_e?.response?.data?.message||"Failed to save sales order.";H.error(be)}},cr=(_e,be)=>{const je=(C[_e]?.part_number||"").trim(),pe=be.key==="Enter",Ee=be.key==="Tab",Fe=be.key==="Escape",ze=be.key==="ArrowDown"||be.key==="ArrowUp";if(Fe){z(null);return}if(ze){be.key==="ArrowDown"&&J!==_e&&z(_e);return}if(!(J===_e&&(pe||Ee))&&(pe||Ee)&&je){if(pe&&be.ctrlKey){be.preventDefault(),V(je.toUpperCase()),K(_e),S(!0),z(null);return}!f.find(ot=>ot.part_number.toUpperCase()===je.toUpperCase())&&pe&&(be.preventDefault(),V(je.toUpperCase()),K(_e),S(!0),z(null))}},jr=(_e,be)=>{const je=(x[_e]?.part_number||"").trim(),pe=be.key==="Enter",Ee=be.key==="Tab",Fe=be.key==="Escape",ze=be.key==="ArrowDown"||be.key==="ArrowUp";if(Fe){Q(null);return}if(ze){be.key==="ArrowDown"&&Z!==_e&&Q(_e);return}if(!(Z===_e&&(pe||Ee))&&(pe||Ee)&&je){if(pe&&be.ctrlKey){be.preventDefault(),me(je.toUpperCase()),ge(_e),ue(!0),Q(null);return}!f.find(ot=>ot.part_number.toUpperCase()===je.toUpperCase())&&pe&&(be.preventDefault(),me(je.toUpperCase()),ge(_e),ue(!0),Q(null))}};return o?e.jsxs(at,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(it,{}),e.jsx(h,{children:"Loading sales order..."})]}):c?e.jsxs(at,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(We,{severity:"error",sx:{mb:2},children:c}),e.jsx(G,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Retry"}),e.jsx(G,{variant:"outlined",onClick:()=>r("/open-sales-orders"),children:"Back to Sales Orders"})]}):a?e.jsxs(_n,{dateAdapter:ss,children:[e.jsx(Ii,{when:Be,onSave:zt}),e.jsxs(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{position:"relative",zIndex:1},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(h,{variant:"h5",sx:{fontWeight:700},children:["Edit Lines & Parts to Order  SO ",a.sales_order_number||a.sales_order_id]}),e.jsx(G,{variant:"contained",onClick:zt,children:"Save Changes"})]}),e.jsx(h,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"Line Items"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"You can add multiple line items with the same part number. They will be automatically merged on save."})]}),e.jsx(k,{ref:O,sx:{mb:N.length?2:0,display:N.length?"flex":"none",flexDirection:"column",gap:1},children:N.map((_e,be)=>{const je=C[_e.lineItemIndex];return!je||!Qe(je,_e.lineItemIndex)?null:e.jsx(We,{severity:"warning",sx:{width:"100%",boxShadow:2,"& .MuiAlert-message":{width:"100%",padding:0}},children:e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",sx:{width:"100%"},children:[e.jsxs(k,{sx:{flex:1},children:[e.jsxs(h,{variant:"body2",fontWeight:"medium",children:["Insufficient stock for ",_e.partNumber]}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Excess quantity: ",_e.excessQuantity," ",_e.unit]})]}),e.jsxs(G,{variant:"contained",size:"small",sx:{whiteSpace:"nowrap"},onClick:()=>{const pe=_e.excessQuantity,Ee=f.find(Ze=>Ze.part_number.toLowerCase()===je.part_number.toLowerCase()),Fe={sales_order_id:a.sales_order_id,part_number:je.part_number,part_description:je.part_description,quantity_to_order:String(pe),unit:je.unit,unit_price:Ee?.last_unit_cost||0,line_amount:(Ee?.last_unit_cost||0)*pe};R(Ze=>[...Ze,Fe]);const ze=Math.max(0,(parseFloat(String(je.quantity).replace(/[^\d.-]/g,""))||0)-pe);D(Ze=>Ze.map((ot,St)=>St===_e.lineItemIndex?{...ot,quantity:String(ze)}:ot)),g(Ze=>Ze.filter(ot=>ot.lineItemIndex!==_e.lineItemIndex)),H.success(`Transferred ${pe} ${je.unit} of ${je.part_number} to parts to order`)},children:["Transfer ",_e.excessQuantity," to Parts to Order"]})]})},`${_e.lineItemIndex}-${be}`)})}),e.jsxs(Ae,{sx:{p:3,mb:3},elevation:3,children:[e.jsx(M,{container:!0,spacing:2,children:C.map((_e,be)=>e.jsxs(It.Fragment,{children:[e.jsxs(M,{item:!0,xs:12,sm:6,md:3.5,children:[e.jsx($r,{open:J===be,onOpen:()=>z(be),onClose:()=>z(null),autoHighlight:!0,inputValue:_e.part_number,onChange:(je,pe)=>{if(typeof pe=="string")Ct(be,pe),z(null);else if(pe&&typeof pe=="object"&&"isNew"in pe){const Ee=pe.inputValue||"";V(String(Ee).toUpperCase()),K(be),S(!0),z(null)}},onInputChange:(je,pe,Ee)=>{if(D(ze=>{const Ze=[...ze];return Ze[be]={...Ze[be],part_number:(pe||"").toUpperCase()},Ze}),X&&window.clearTimeout(X),Ee==="reset")return;if((pe||"").trim().length>0){const ze=window.setTimeout(()=>z(be),200);I(ze)}else z(null)},options:f.filter(je=>je.part_type!=="supply").map(je=>je.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,handleHomeEndKeys:!0,filterOptions:(je,pe)=>{const Ee=(pe.inputValue||"").toUpperCase(),Fe=je.filter(ot=>{const St=f.find(Ht=>Ht.part_number===ot);return St?String(ot).toUpperCase().includes(Ee)||String(St.part_description||"").toUpperCase().includes(Ee):String(ot).toUpperCase().includes(Ee)}),ze=Fe.some(ot=>String(ot).toUpperCase()===Ee),Ze=[...Fe];return Ee&&!ze&&Ze.push({label:`Add "${pe.inputValue}" as New Part`,isNew:!0,inputValue:pe.inputValue}),Ze},renderOption:(je,pe)=>{const Ee=typeof pe=="object"&&pe.isNew,Fe=typeof pe=="string"?pe:pe.label,{key:ze,...Ze}=je;return e.jsxs("li",{...Ze,children:[Ee&&e.jsx(Rn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof pe=="string"?e.jsxs(k,{children:[e.jsx(h,{variant:"body2",children:pe}),(()=>{const ot=f.find(St=>St.part_number===pe);return ot?.part_description?e.jsx(h,{variant:"caption",color:"text.secondary",children:ot.part_description}):null})()]}):Fe]},ze)},renderInput:je=>e.jsx(le,{...je,label:"Part Number",required:!0,fullWidth:!0,onKeyDown:pe=>cr(be,pe),onBlur:()=>z(null)}),onBlur:()=>{const je=C[be]?.part_number?.trim().toUpperCase();if(!je)return;f.find(Ee=>Ee.part_number===je)?Ct(be,je):(K(be),V(je),S(!0),z(null))}}),e.jsx(k,{mt:1,children:e.jsx(G,{size:"small",variant:"outlined",onClick:()=>{$("line"),re(be),ae(!0)},children:"Find Part"})})]}),e.jsx(M,{item:!0,xs:12,sm:6,md:3.5,children:e.jsx(le,{label:"Part Description",value:_e.part_description,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1,children:e.jsx(le,{label:"Qty",value:_e.quantity,onChange:je=>qt(be,"quantity",je.target.value),type:"number",fullWidth:!0,required:!0,inputProps:{step:1,onWheel:je=>je.target.blur()}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Avail",value:(()=>{if(!Qe(_e,be))return"N/A";const je=Ye(_e);return je?je.available<0?`${je.available} (Insufficient)`:String(je.available):"N/A"})(),fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:(()=>{if(!Qe(_e,be))return"#f5f5f5";const je=Ye(_e);return je?je.available>=0?"#e8f5e8":"#ffeaea":"#f5f5f5"})(),"& .MuiInputBase-input":{color:Qe(_e,be)?Ye(_e)?.isNegative?"#d32f2f":"#2e7d32":"#666"}}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Unit",value:_e.unit,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1,sx:{display:"flex",alignItems:"stretch"},children:e.jsx(G,{variant:"outlined",color:"primary",onClick:()=>Ke(be),fullWidth:!0,sx:{height:"56px"},children:"Remove"})})]},be))}),e.jsx(k,{sx:{mt:2},children:e.jsx(G,{variant:"outlined",color:"primary",onClick:Bt,children:"Add Line Item"})})]}),e.jsxs(Ae,{sx:{p:3,mb:3,border:"2px solid #b8860b","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"#b8860b"},"&:hover fieldset":{borderColor:"#b8860b"}}},elevation:0,children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Parts to Order"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Add parts that need to be ordered for this sales order. These quantities are aggregated across all sales orders."}),e.jsx(M,{container:!0,spacing:2,children:x.map((_e,be)=>e.jsxs(It.Fragment,{children:[e.jsxs(M,{item:!0,xs:12,sm:6,md:3.5,children:[e.jsx($r,{open:Z===be,onOpen:()=>Q(be),onClose:()=>Q(null),autoHighlight:!0,value:_e.part_number,onChange:(je,pe)=>{if(!pe){R(Ee=>{const Fe=[...Ee];return Fe[be]={...Fe[be],part_number:"",part_description:"",unit:"Each",unit_price:0,line_amount:0},Fe});return}if(typeof pe=="string"){const Ee=f.find(Fe=>Fe.part_number===pe);if(Ee){const Fe=parseFloat(String(Ee.last_unit_cost))||0,ze=Me(Fe),Ze=Fe*ze;R(ot=>{const St=[...ot];return St[be]={...St[be],part_number:Ee.part_number,part_description:Ee.part_description,unit:Ee.unit||"Each",unit_price:Ze,line_amount:0},St})}else{R(ze=>{const Ze=[...ze];return Ze[be]={...Ze[be],part_number:pe,part_description:"",unit:"Each",unit_price:0,line_amount:0},Ze});const Fe=String(pe).toUpperCase();ge(be),me(Fe),ue(!0)}}else if(pe&&typeof pe=="object"&&"isNew"in pe){const Ee=String(pe.inputValue||"").toUpperCase();ge(be),me(Ee),ue(!0)}},onInputChange:(je,pe,Ee)=>{if(R(ze=>{const Ze=[...ze];return Ze[be]={...Ze[be],part_number:(pe||"").toUpperCase()},Ze}),X&&window.clearTimeout(X),Ee==="reset")return;if((pe||"").trim().length>0){const ze=window.setTimeout(()=>Q(be),200);I(ze)}else Q(null)},options:f.filter(je=>je.part_type!=="supply").map(je=>je.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,filterOptions:(je,pe)=>{const Ee=(pe.inputValue||"").toUpperCase(),Fe=je.filter(ot=>{const St=f.find(Ht=>Ht.part_number===ot);return St?String(ot).toUpperCase().includes(Ee)||String(St.part_description||"").toUpperCase().includes(Ee):String(ot).toUpperCase().includes(Ee)}),ze=Fe.some(ot=>String(ot).toUpperCase()===Ee),Ze=[...Fe];return Ee&&!ze&&Ze.push({label:`Add "${pe.inputValue}" as New Part`,isNew:!0,inputValue:pe.inputValue}),Ze},renderOption:(je,pe)=>{const Ee=typeof pe=="object"&&pe.isNew,Fe=typeof pe=="string"?pe:pe.label,{key:ze,...Ze}=je;return e.jsxs("li",{...Ze,children:[Ee&&e.jsx(Rn,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof pe=="string"?e.jsxs(k,{children:[e.jsx(h,{variant:"body2",children:pe}),(()=>{const ot=f.find(St=>St.part_number===pe);return ot?.part_description?e.jsx(h,{variant:"caption",color:"text.secondary",children:ot.part_description}):null})()]}):Fe]},ze)},renderInput:je=>e.jsx(le,{...je,label:"Part Number",fullWidth:!0,required:!0,onKeyDown:pe=>jr(be,pe),onBlur:()=>Q(null)}),onBlur:()=>{const je=(x[be]?.part_number||"").trim().toUpperCase();if(!je)return;f.find(Ee=>Ee.part_number===je)||(ge(be),me(je),ue(!0),Q(null))}}),e.jsx(k,{mt:1,children:e.jsx(G,{size:"small",variant:"outlined",onClick:()=>{$("pto"),re(be),ae(!0)},children:"Find Part"})})]}),e.jsx(M,{item:!0,xs:12,sm:6,md:3.5,children:e.jsx(le,{label:"Description",value:_e.part_description,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#f5f5f5"}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Qty to Order",value:_e.quantity_to_order,onChange:je=>{const pe=je.target.value;R(Ee=>{const Fe=[...Ee],ze=parseFloat(pe)||0,Ze=Fe[be].unit_price||0;return Fe[be]={...Fe[be],quantity_to_order:pe,line_amount:ze*Ze},Fe})},type:"number",fullWidth:!0,required:!0,inputProps:{step:1,min:0,onWheel:je=>je.target.blur()}})}),e.jsx(M,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(le,{label:"Unit",value:_e.unit,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(M,{item:!0,xs:12,sm:1,md:1,sx:{display:"flex",alignItems:"stretch",gap:2},children:e.jsx(G,{variant:"outlined",onClick:()=>R(je=>je.filter((pe,Ee)=>Ee!==be)),sx:{height:"56px",flexShrink:0,borderColor:"#b8860b",color:"#b8860b","&:hover":{borderColor:"#8b6914",backgroundColor:"#fff8dc"}},children:"Remove"})})]},be))}),e.jsx(k,{sx:{mt:2},children:e.jsx(G,{variant:"outlined",color:"primary",onClick:()=>R(_e=>[..._e,{sales_order_id:a.sales_order_id,part_number:"",part_description:"",quantity_to_order:"",unit:"Each",unit_price:0,line_amount:0}]),children:"Add Parts to Order Item"})})]}),e.jsxs(k,{display:"flex",justifyContent:"flex-end",gap:2,children:[e.jsx(G,{variant:"outlined",onClick:()=>r(`/open-sales-orders/${a.sales_order_id}`),children:"Back to SO"}),e.jsx(G,{variant:"contained",onClick:zt,children:"Save Changes"})]}),e.jsx(bn,{open:!!d,autoHideDuration:6e3,onClose:()=>p(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(We,{onClose:()=>p(null),severity:"success",sx:{width:"100%"},children:d})})]}),e.jsx(ts,{open:y,onClose:()=>{S(!1),K(null),V("")},onSave:async _e=>{const be=await B.post("/api/inventory",_e),je=await B.get("/api/inventory");m(je.data);const pe=be.data.item;U!==null&&D(Ee=>{const Fe=[...Ee],ze=parseFloat(String(pe.last_unit_cost))||0,Ze=Me(ze),ot=ze*Ze;Fe[U]={...Fe[U],part_number:pe.part_number,part_description:pe.part_description,unit:pe.unit||Fe[U].unit,unit_price:ot};const St=nn(Fe[U].quantity);return Fe[U].line_amount=Do(St,ot),Fe})},title:"Add New Part",initialPart:{part_number:E.toUpperCase(),category:"Uncategorized"}}),e.jsx(Gw,{open:he,onClose:()=>ae(!1),onSelect:_e=>{if(a)if(T==="line"){const be=ce;D(je=>{const pe=[...je];return pe[be]?(pe[be]={...pe[be],part_number:_e.part_number,part_description:_e.part_description},pe):je})}else{const be=ce;R(je=>{const pe=[...je];return pe[be]?(pe[be]={...pe[be],part_number:_e.part_number,part_description:_e.part_description},pe):je})}},salesOrderId:a?.sales_order_id||0,context:T,inventoryItems:f.map(_e=>({part_number:_e.part_number,part_description:_e.part_description}))}),e.jsx(ts,{open:q,onClose:()=>{ue(!1),ge(null),me("")},onSave:async _e=>{const be=await B.post("/api/inventory",_e),je=await B.get("/api/inventory");m(je.data);const pe=be.data.item;ye!==null&&R(Ee=>{const Fe=[...Ee],ze=parseFloat(String(pe.last_unit_cost))||0,Ze=Me(ze),ot=ze*Ze;Fe[ye]={...Fe[ye],part_number:pe.part_number,part_description:pe.part_description,unit:pe.unit||"Each",unit_price:ot};const St=parseFloat(String(Fe[ye].quantity_to_order))||0;return Fe[ye].line_amount=St*ot,Fe})},title:"Add New Part",initialPart:{part_number:xe.toUpperCase(),category:"Uncategorized"}})]}):null},oi=t=>new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString(),yh=()=>crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,Xl=async()=>{try{const t=await B.get("/api/time-tracking/profiles");return localStorage.setItem("tt_profiles_cache",JSON.stringify(t.data)),t.data}catch{const r=localStorage.getItem("tt_profiles_cache");return r?JSON.parse(r):[]}},Qw=async(t,r)=>(await B.post("/api/time-tracking/profiles",{name:t,email:r})).data,vh=async()=>{try{const t=await B.get("/api/time-tracking/sales-orders");return localStorage.setItem("tt_sales_orders_cache",JSON.stringify(t.data)),t.data}catch{const r=localStorage.getItem("tt_sales_orders_cache");return r?JSON.parse(r):[]}},Kw=async(t,r)=>{const n={date:t};return r&&(n.profile_id=r),(await B.get("/api/time-tracking/time-entries",{params:n})).data},Jw=async(t,r)=>{try{return(await B.post("/api/time-tracking/time-entries/clock-in",{profile_id:t,so_id:r})).data}catch{const a={event_id:yh(),user_id:t,device_id:localStorage.getItem("deviceId")||"unknown-device",type:"time_clock_in",timestamp_utc:oi(new Date),payload_json:JSON.stringify({profile_id:t,so_id:r}),created_at:oi(new Date)};return await window?.api?.timeEvents?.insert?.(a),{id:-Math.floor(Math.random()*1e9),profile_id:t,profile_name:"",sales_order_id:r,sales_order_number:"",clock_in:new Date().toISOString(),clock_out:null,duration:null,unit_price:0,__pending:!0,__pending_event_id:a.event_id}}},Xw=async t=>{try{return(await B.post(`/api/time-tracking/time-entries/${t}/clock-out`)).data}catch{const n={event_id:yh(),device_id:localStorage.getItem("deviceId")||"unknown-device",type:"time_clock_out",timestamp_utc:oi(new Date),payload_json:JSON.stringify({id:t}),created_at:oi(new Date)};return await window?.api?.timeEvents?.insert?.(n),{id:t,clock_out:new Date().toISOString(),__pending:!0,__pending_event_id:n.event_id}}},Zw=async(t,r,n)=>(await B.put(`/api/time-tracking/time-entries/${t}`,{clock_in:r,clock_out:n})).data,eS=async t=>{await B.delete(`/api/time-tracking/time-entries/${t}`)},tS=async(t,r,n,a)=>(await B.post("/api/time-tracking/time-entries/manual",{profile_id:t,sales_order_id:r,clock_in:n,clock_out:a})).data,rS=async(t,r,n,a)=>(await B.get("/api/time-tracking/reports/time-entries",{params:{from:t,to:r,profile:n,so:a}})).data,nS=async(t,r,n,a,s="csv")=>(await B.get("/api/time-tracking/reports/time-entries/export",{params:{from:t,to:r,profile:n,so:a,format:s},responseType:"blob"})).data,sS=async t=>(await B.get("/api/time-tracking/time-entries/open",{params:{profile_id:t}})).data,aS=()=>{const{user:t}=Zt(),[r,n]=l.useState([]),[a,s]=l.useState([]),[o,i]=l.useState([]),[c,u]=l.useState(""),[d,p]=l.useState(""),[f,m]=l.useState(!0),[j,v]=l.useState(null),[w,_]=l.useState(null),P=l.useRef(null),L=g=>{P.current&&window.clearTimeout(P.current),_(g),P.current=window.setTimeout(()=>{_(null),P.current=null},2500)};l.useEffect(()=>()=>{P.current&&window.clearTimeout(P.current)},[]),l.useEffect(()=>{C()},[]),l.useEffect(()=>{c?D():i([])},[c]),l.useEffect(()=>{const g=setInterval(()=>{i(x=>x.map(R=>{if(!R.clock_out){const O=new Date,ee=new Date(R.clock_in),J=(O.getTime()-ee.getTime())/(1e3*60*60);return{...R,duration:J}}return R}))},1e3);return()=>clearInterval(g)},[]);const C=async()=>{try{m(!0);const[g,x]=await Promise.all([Xl(),vh()]);console.log("Sales orders data received:",x),n(g),s(x),v(null)}catch(g){v("Failed to fetch data. Please try again."),console.error("Error fetching data:",g)}finally{m(!1)}},D=async()=>{if(c)try{const[g,x]=await Promise.all([Kw(new Date().toISOString().split("T")[0],c),sS(c)]),R=new Map;[...g,...x].forEach(O=>{R.set(O.id,O)}),i(Array.from(R.values()))}catch(g){v("Failed to fetch time entries. Please try again."),console.error("Error fetching time entries:",g)}},A=async()=>{if(!c||!d){v("Please select both a profile and a sales order");return}if(o.find(x=>x.sales_order_id===d&&!x.clock_out)){v("You are already clocked in for this sales order");return}try{const x=await Jw(c,d);i([x,...o]),u(""),p(""),i([]),v(null),L("Successfully clocked in.")}catch(x){x.response&&x.response.data&&x.response.data.error.includes("attendance")?v("You must clock in for attendance before you can clock in for a sales order."):v("Failed to clock in. Please try again."),console.error("Error clocking in:",x)}},b=async g=>{try{const x=await Xw(g);i(o.map(R=>R.id===g?x:R)),u(""),p(""),i([]),v(null),L("Successfully clocked out.")}catch(x){v("Failed to clock out. Please try again."),console.error("Error clocking out:",x)}},N=c&&o.some(g=>g.profile_id===c&&!g.clock_out);return f?e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(it,{})}):e.jsxs(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Time Tracking"}),j&&e.jsx(We,{severity:"error",sx:{mb:2},children:j}),e.jsxs(mt,{open:!!w,onClose:()=>_(null),PaperProps:{sx:{px:6,py:4,textAlign:"center"}},children:[e.jsx(ft,{sx:{fontSize:"2rem"},children:"Success"}),e.jsx(xt,{children:e.jsx(h,{variant:"h4",component:"p",children:w})})]}),e.jsxs(M,{container:!0,spacing:3,children:[e.jsx(M,{item:!0,xs:12,md:6,children:e.jsxs(Ae,{sx:{p:2},children:[e.jsx(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:e.jsx(h,{variant:"h6",children:"Profile"})}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Select Profile"}),e.jsx(Wt,{value:c,label:"Select Profile",onChange:g=>u(g.target.value),sx:{"& .MuiSelect-select":{fontSize:"1.1rem"}},children:r.map(g=>e.jsx(et,{value:g.id,sx:{fontSize:"1.1rem"},children:g.name},g.id))})]})]})}),c&&e.jsx(M,{item:!0,xs:12,md:6,children:e.jsxs(Ae,{sx:{p:2},children:[e.jsx(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:e.jsx(h,{variant:"h6",children:"Sales Order"})}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Select Sales Order"}),e.jsx(Wt,{value:d,label:"Select Sales Order",onChange:g=>p(g.target.value),sx:{"& .MuiSelect-select":{fontSize:"1.1rem"}},children:a.map(g=>{const x=o.some(R=>R.sales_order_id===g.id&&!R.clock_out);return e.jsxs(et,{value:g.id,disabled:x,sx:{fontSize:"1.1rem"},children:[g.number," - ",g.product_name||"No Product Name",x?" - Already Clocked In":""]},g.id)})})]})]})}),c&&d&&e.jsx(M,{item:!0,xs:12,children:e.jsx(Ae,{sx:{p:2},children:e.jsx(k,{display:"flex",justifyContent:"center",gap:2,children:e.jsx(G,{variant:"contained",sx:{backgroundColor:"green","&:hover":{backgroundColor:"darkgreen"}},onClick:A,disabled:N,children:"Clock In"})})})}),c&&e.jsx(M,{item:!0,xs:12,children:e.jsxs(Ae,{sx:{p:2},children:[e.jsxs(h,{variant:"h6",gutterBottom:!0,children:["Today's Time Entries for ",r.find(g=>g.id===c)?.name]}),e.jsx(lr,{children:e.jsxs(nr,{children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Sales Order"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Clock In"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Clock Out"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Duration"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Actions"})]})}),e.jsx(ar,{children:o.map(g=>e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.1rem"},children:g.sales_order_number}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:new Date(g.clock_in).toLocaleTimeString()}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:g.clock_out?new Date(g.clock_out).toLocaleTimeString():"-"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:g.duration!==null&&g.duration!==void 0&&!isNaN(Number(g.duration))?`${Number(g.duration).toFixed(3)} hrs`:"-"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:!g.clock_out&&e.jsx(G,{variant:"contained",sx:{backgroundColor:"red","&:hover":{backgroundColor:"darkred"}},onClick:()=>b(g.id),children:"Clock Out"})})]},g.id))})]})})]})})]})]})};var Io={exports:{}},hu;function oS(){return hu||(hu=1,function(t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=void 0;var n=function(u,d){switch(u){case"P":return d.date({width:"short"});case"PP":return d.date({width:"medium"});case"PPP":return d.date({width:"long"});case"PPPP":default:return d.date({width:"full"})}},a=function(u,d){switch(u){case"p":return d.time({width:"short"});case"pp":return d.time({width:"medium"});case"ppp":return d.time({width:"long"});case"pppp":default:return d.time({width:"full"})}},s=function(u,d){var p=u.match(/(P+)(p+)?/)||[],f=p[1],m=p[2];if(!m)return n(u,d);var j;switch(f){case"P":j=d.dateTime({width:"short"});break;case"PP":j=d.dateTime({width:"medium"});break;case"PPP":j=d.dateTime({width:"long"});break;case"PPPP":default:j=d.dateTime({width:"full"});break}return j.replace("{{date}}",n(f,d)).replace("{{time}}",a(m,d))},o={p:a,P:s},i=o;r.default=i,t.exports=r.default}(Io,Io.exports)),Io.exports}var iS=oS();const lS=st(iS),cS={y:{sectionType:"year",contentType:"digit",maxLength:4},yy:"year",yyy:{sectionType:"year",contentType:"digit",maxLength:4},yyyy:"year",M:{sectionType:"month",contentType:"digit",maxLength:2},MM:"month",MMMM:{sectionType:"month",contentType:"letter"},MMM:{sectionType:"month",contentType:"letter"},L:{sectionType:"month",contentType:"digit",maxLength:2},LL:"month",LLL:{sectionType:"month",contentType:"letter"},LLLL:{sectionType:"month",contentType:"letter"},d:{sectionType:"day",contentType:"digit",maxLength:2},dd:"day",do:{sectionType:"day",contentType:"digit-with-letter"},E:{sectionType:"weekDay",contentType:"letter"},EE:{sectionType:"weekDay",contentType:"letter"},EEE:{sectionType:"weekDay",contentType:"letter"},EEEE:{sectionType:"weekDay",contentType:"letter"},EEEEE:{sectionType:"weekDay",contentType:"letter"},i:{sectionType:"weekDay",contentType:"digit",maxLength:1},ii:"weekDay",iii:{sectionType:"weekDay",contentType:"letter"},iiii:{sectionType:"weekDay",contentType:"letter"},e:{sectionType:"weekDay",contentType:"digit",maxLength:1},ee:"weekDay",eee:{sectionType:"weekDay",contentType:"letter"},eeee:{sectionType:"weekDay",contentType:"letter"},eeeee:{sectionType:"weekDay",contentType:"letter"},eeeeee:{sectionType:"weekDay",contentType:"letter"},c:{sectionType:"weekDay",contentType:"digit",maxLength:1},cc:"weekDay",ccc:{sectionType:"weekDay",contentType:"letter"},cccc:{sectionType:"weekDay",contentType:"letter"},ccccc:{sectionType:"weekDay",contentType:"letter"},cccccc:{sectionType:"weekDay",contentType:"letter"},a:"meridiem",aa:"meridiem",aaa:"meridiem",H:{sectionType:"hours",contentType:"digit",maxLength:2},HH:"hours",h:{sectionType:"hours",contentType:"digit",maxLength:2},hh:"hours",m:{sectionType:"minutes",contentType:"digit",maxLength:2},mm:"minutes",s:{sectionType:"seconds",contentType:"digit",maxLength:2},ss:"seconds"},dS={year:"yyyy",month:"LLLL",monthShort:"MMM",dayOfMonth:"d",weekday:"EEEE",weekdayShort:"EEEEEE",hours24h:"HH",hours12h:"hh",meridiem:"aa",minutes:"mm",seconds:"ss",fullDate:"PP",fullDateWithWeekday:"PPPP",keyboardDate:"P",shortDate:"MMM d",normalDate:"d MMMM",normalDateWithWeekday:"EEE, MMM d",monthAndYear:"LLLL yyyy",monthAndDate:"MMMM d",fullTime:"p",fullTime12h:"hh:mm aa",fullTime24h:"HH:mm",fullDateTime:"PP p",fullDateTime12h:"PP hh:mm aa",fullDateTime24h:"PP HH:mm",keyboardDateTime:"P p",keyboardDateTime12h:"P hh:mm aa",keyboardDateTime24h:"P HH:mm"};class uS{constructor(r){this.isMUIAdapter=!0,this.isTimezoneCompatible=!1,this.lib="date-fns",this.locale=void 0,this.formats=void 0,this.formatTokenMap=cS,this.escapedCharacters={start:"'",end:"'"},this.longFormatters=void 0,this.date=o=>typeof o>"u"?new Date:o===null?null:new Date(o),this.dateWithTimezone=o=>this.date(o),this.getTimezone=()=>"default",this.setTimezone=o=>o,this.toJsDate=o=>o,this.getCurrentLocaleCode=()=>{var o;return((o=this.locale)==null?void 0:o.code)||"en-US"},this.is12HourCycleInCurrentLocale=()=>this.locale?/a/.test(this.locale.formatLong.time({width:"short"})):!0,this.expandFormat=o=>{const i=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g;return o.match(i).map(c=>{const u=c[0];if(u==="p"||u==="P"){const d=this.longFormatters[u];return d(c,this.locale.formatLong)}return c}).join("")},this.getFormatHelperText=o=>this.expandFormat(o).replace(/(aaa|aa|a)/g,"(a|p)m").toLocaleLowerCase(),this.isNull=o=>o===null,this.formatNumber=o=>o,this.getMeridiemText=o=>o==="am"?"AM":"PM";const{locale:n,formats:a,longFormatters:s}=r;this.locale=n,this.formats=Iu({},dS,a),this.longFormatters=s}}class mu extends uS{constructor({locale:r,formats:n}={}){if(typeof $o!="function")throw new Error(["MUI: The `date-fns` package v3.x is not compatible with this adapter.","Please, install v2.x of the package or use the `AdapterDateFnsV3` instead."].join(`
`));super({locale:r??Ei,formats:n,longFormatters:lS}),this.parseISO=a=>p0(a),this.toISO=a=>X_(a,{format:"extended"}),this.parse=(a,s)=>a===""?null:o0(a,s,new Date,{locale:this.locale}),this.isValid=a=>Jp(this.date(a)),this.format=(a,s)=>this.formatByString(a,this.formats[s]),this.formatByString=(a,s)=>Ss(a,s,{locale:this.locale}),this.getDiff=(a,s,o)=>{switch(o){case"years":return Zb(a,this.date(s));case"quarters":return Kb(a,this.date(s));case"months":return Zp(a,this.date(s));case"weeks":return Xb(a,this.date(s));case"days":return Xp(a,this.date(s));case"hours":return Vb(a,this.date(s));case"minutes":return Gb(a,this.date(s));case"seconds":return Jb(a,this.date(s));default:return Di(a,this.date(s))}},this.isEqual=(a,s)=>a===null&&s===null?!0:dj(a,s),this.isSameYear=(a,s)=>d0(a,s),this.isSameMonth=(a,s)=>c0(a,s),this.isSameDay=(a,s)=>$b(a,s),this.isSameHour=(a,s)=>l0(a,s),this.isAfter=(a,s)=>Zi(a,s),this.isAfterYear=(a,s)=>Zi(a,Ki(s)),this.isAfterDay=(a,s)=>Zi(a,kl(s)),this.isBefore=(a,s)=>Ca(a,s),this.isBeforeYear=(a,s)=>Ca(a,ko(s)),this.isBeforeDay=(a,s)=>Ca(a,Rs(s)),this.isWithinRange=(a,[s,o])=>u0(a,{start:s,end:o}),this.startOfYear=a=>ko(a),this.startOfMonth=a=>Id(a),this.startOfWeek=a=>Zn(a,{locale:this.locale}),this.startOfDay=a=>Rs(a),this.endOfYear=a=>Ki(a),this.endOfMonth=a=>Pl(a),this.endOfWeek=a=>Ji(a,{locale:this.locale}),this.endOfDay=a=>kl(a),this.addYears=(a,s)=>Pd(a,s),this.addMonths=(a,s)=>zo(a,s),this.addWeeks=(a,s)=>Wb(a,s),this.addDays=(a,s)=>$o(a,s),this.addHours=(a,s)=>Ab(a,s),this.addMinutes=(a,s)=>qb(a,s),this.addSeconds=(a,s)=>Ub(a,s),this.getYear=a=>cj(a),this.getMonth=a=>nj(a),this.getDate=a=>Z_(a),this.getHours=a=>ej(a),this.getMinutes=a=>rj(a),this.getSeconds=a=>sj(a),this.getMilliseconds=a=>tj(a),this.setYear=(a,s)=>M0(a,s),this.setMonth=(a,s)=>D0(a,s),this.setDate=(a,s)=>E0(a,s),this.setHours=(a,s)=>I0(a,s),this.setMinutes=(a,s)=>O0(a,s),this.setSeconds=(a,s)=>A0(a,s),this.setMilliseconds=(a,s)=>T0(a,s),this.getDaysInMonth=a=>ih(a),this.getNextMonth=a=>zo(a,1),this.getPreviousMonth=a=>zo(a,-1),this.getMonthArray=a=>{const o=[ko(a)];for(;o.length<12;){const i=o[o.length-1];o.push(this.getNextMonth(i))}return o},this.mergeDateAndTime=(a,s)=>this.setSeconds(this.setMinutes(this.setHours(a,this.getHours(s)),this.getMinutes(s)),this.getSeconds(s)),this.getWeekdays=()=>{const a=new Date;return e_({start:Zn(a,{locale:this.locale}),end:Ji(a,{locale:this.locale})}).map(s=>this.formatByString(s,"EEEEEE"))},this.getWeekArray=a=>{const s=Zn(Id(a),{locale:this.locale}),o=Ji(Pl(a),{locale:this.locale});let i=0,c=s;const u=[];for(;Ca(c,o);){const d=Math.floor(i/7);u[d]=u[d]||[],u[d].push(c),c=$o(c,1),i+=1}return u},this.getWeekNumber=a=>lj(a,{locale:this.locale}),this.getYearRange=(a,s)=>{const o=ko(a),i=Ki(s),c=[];let u=o;for(;Ca(u,i);)c.push(u),u=Pd(u,1);return c}}}const Ls=t=>new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString(),Zl=()=>crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,pS=async t=>(await B.get("/api/attendance",{params:{profile_id:t}})).data,hS=async t=>{try{return(await B.post("/api/attendance/clock-in",{profile_id:t})).data}catch{const n={event_id:Zl(),user_id:t,device_id:localStorage.getItem("deviceId")||"unknown-device",type:"attendance_clock_in",timestamp_utc:Ls(new Date),payload_json:JSON.stringify({profile_id:t}),created_at:Ls(new Date)};return await window?.api?.timeEvents?.insert?.(n),{id:-Math.floor(Math.random()*1e9),profile_id:t,clock_in:new Date().toISOString(),clock_out:null,duration:null,__pending:!0,__pending_event_id:n.event_id}}},mS=async t=>{try{return(await B.post("/api/attendance/clock-out",{shift_id:t})).data}catch{const n={event_id:Zl(),user_id:void 0,device_id:localStorage.getItem("deviceId")||"unknown-device",type:"attendance_clock_out",timestamp_utc:Ls(new Date),payload_json:JSON.stringify({shift_id:t}),created_at:Ls(new Date)};return await window?.api?.timeEvents?.insert?.(n),{id:t,clock_out:new Date().toISOString(),__pending:!0,__pending_event_id:n.event_id}}},fS=async(t,r,n)=>{try{return(await B.post("/api/attendance/manual",{profile_id:t,clock_in:r,clock_out:n})).data}catch(a){throw a}},xS=async(t,r,n)=>{try{return(await B.put(`/api/attendance/${t}`,{clock_in:r,clock_out:n})).data}catch(a){if(a?.response)throw a;const s={event_id:Zl(),device_id:localStorage.getItem("deviceId")||"unknown-device",type:"attendance_update",timestamp_utc:Ls(new Date),payload_json:JSON.stringify({shift_id:t,clock_in:r,clock_out:n}),created_at:Ls(new Date)};return await window?.api?.timeEvents?.insert?.(s),{id:t,clock_in:r,clock_out:n,__pending:!0,__pending_event_id:s.event_id}}},gS=async(t,r,n)=>(await B.get("/api/attendance",{params:{profile_id:t,from:r,to:n}})).data,yS=async t=>{await B.delete(`/api/attendance/${t}`)};function En(t){if(!t)return"";const r=new Date(t),n=r.getTimezoneOffset()*6e4;return new Date(r.getTime()-n).toISOString().slice(0,16)}function bs(t){return t?new Date(t).toISOString():null}function Tl(t){return new Date(t.getFullYear(),t.getMonth(),t.getDate())}function $a(t){const r=Tl(t),n=r.getFullYear(),a=String(r.getMonth()+1).padStart(2,"0"),s=String(r.getDate()).padStart(2,"0");return`${n}-${a}-${s}`}const vS=()=>{const[t,r]=l.useState([]),[n,a]=l.useState([]),[s,o]=l.useState([]),[i,c]=l.useState(""),[u,d]=l.useState(""),p=new Date,f=new Date;f.setDate(p.getDate()-1);const m=new Date;m.setDate(f.getDate()-13);const[j,v]=l.useState(m),[w,_]=l.useState(f),[P,L]=l.useState(!0),[C,D]=l.useState(null),[A,b]=l.useState(null),[N,g]=l.useState(""),[x,R]=l.useState(""),[O,ee]=l.useState(null),[J,z]=l.useState([]),[Z,Q]=l.useState({}),[X,I]=l.useState([]),[y,S]=l.useState(null),[U,K]=l.useState(null),[E,V]=l.useState(""),[q,ue]=l.useState(""),[ye,ge]=l.useState(!1),[xe,me]=l.useState(!0),[he,ae]=l.useState(!1),[T,$]=l.useState(null),[ce,re]=l.useState(""),[Me,Ce]=l.useState(""),[Ye,Qe]=l.useState(""),[lt,ct]=l.useState(!1),[ut,Ne]=l.useState(!1),[tt,Be]=l.useState(""),[Ct,qt]=l.useState(""),[Bt,Ke]=l.useState(""),[Yt,Et]=l.useState(!1),[zt,cr]=l.useState(null),[jr,_e]=l.useState(!1),[be,je]=l.useState(null),[pe,Ee]=l.useState(null),[Fe,ze]=l.useState(!1),[Ze,ot]=l.useState(null);l.useEffect(()=>{St()},[]);const St=async()=>{try{L(!0);const[we,rt]=await Promise.all([Xl(),vh()]);r(we),a(rt),D(null)}catch(we){D("Failed to fetch data. Please try again."),console.error("Error fetching data:",we)}finally{L(!1)}},Ht=async()=>{if(!j||!w){D("Please select a date range");return}try{L(!0);const we=Tl(j),rt=new Date(w.getFullYear(),w.getMonth(),w.getDate()+1),pt=$a(we),Qt=$a(rt);console.log("Requesting shifts for:",pt,Qt);const ur={from_date:pt,to_date:Qt};i&&(ur.profile_id=i),u&&(ur.sales_order_id=u);const Hr=await rS(pt,Qt,i||void 0,u||void 0);if(o(Hr),u)z([]),Q({}),I([]);else{const Ur=(await gS(i||void 0,pt,Qt)).map(Or=>({...Or,id:Number(Or.id),profile_id:Number(Or.profile_id)}));console.log("Fetched shifts:",Ur),z(Ur);const Ir=[];let wr=new Date(we);const Tr=new Date(rt);for(;wr<Tr;){const Sr={date:$a(wr)};i&&(Sr.profile_id=i);const Cn=await B.get("/api/time-tracking/time-entries",{params:Sr});Ir.push(...Cn.data),wr.setDate(wr.getDate()+1)}const Gr={},Wr=[];Ur.forEach(Or=>{const Sr=Number(Or.id);Number.isNaN(Sr)||(Gr[Sr]=[])}),Ir.forEach(Or=>{const Sr=new Date(Or.clock_in).getTime(),Cn=Number(Or.profile_id);let is=!1;for(const Qr of Ur){const ls=Number(Qr.id);if(Number.isNaN(ls))continue;const en=new Date(Qr.clock_in).getTime(),cs=Qr.clock_out?new Date(Qr.clock_out).getTime():null,kn=Number(Qr.profile_id);if(cs&&!Number.isNaN(Cn)&&!Number.isNaN(kn)&&Cn===kn&&Sr>=en&&Sr<cs){Gr[ls].push(Or),is=!0;break}}is||Wr.push(Or)}),Q(Gr),I(Wr)}D(null)}catch(we){D("Failed to generate report. Please try again."),console.error("Error generating report:",we)}finally{L(!1)}},dr=async we=>{if(!j||!w){D("Please select both from and to dates");return}try{const rt=Tl(j),pt=new Date(w.getFullYear(),w.getMonth(),w.getDate()+1),Qt=$a(rt),ur=$a(pt),Hr=await nS(Qt,ur,i||void 0,u||void 0,we),Yr=u?`time-entries-report-so-${u}.${we}`:`time-entries-report.${we}`;bS(Hr,Yr)}catch(rt){D("Failed to export report. Please try again."),console.error("Error exporting report:",rt)}},dn=async()=>{if(A){ee(null),D(null);try{const we=bs(N),rt=bs(x),pt=await Zw(A.id,we,rt);o(s.map(Qt=>Qt.id===A.id?{...Qt,clock_in:pt.clock_in,clock_out:pt.clock_out,duration:pt.duration}:Qt)),ee(null),b(null),D(null)}catch(we){const pt=(we?.response?.data?.message??we?.response?.data?.error)||"Failed to update time entry. Please try again.";ee(pt),D(pt),console.error("Error updating time entry:",we)}}},Sn=we=>{$(we),ae(!0),re(u!==""?u:""),Ce(we.clock_in?En(we.clock_in):""),Qe(we.clock_out?En(we.clock_out):""),D(null)},Pe=()=>{ae(!1),$(null),Ce(""),Qe(""),re(u!==""?u:""),ct(!1)},Ie=async()=>{if(!T||ce===""||!Me||!Ye)return;const we=bs(Me),rt=bs(Ye);if(!(!we||!rt)){ct(!0),D(null);try{await tS(T.profile_id,Number(ce),we,rt),Pe(),await Ht()}catch(pt){const Qt=pt?.response?.data?.message||pt?.response?.data?.error||"Failed to create time entry. Please try again.";D(Qt),console.error("Error creating manual time entry:",pt)}finally{ct(!1)}}},Le=we=>{je(null),D(null),cr(we)},nt=()=>{jr||(cr(null),je(null))},jt=async()=>{if(!zt)return;const we=zt.id;_e(!0),je(null),D(null);try{await eS(we),cr(null),await Ht()}catch(rt){const pt=rt?.response?.data?.message||rt?.response?.data?.error||"Failed to delete time entry.";je(pt),D(pt)}finally{_e(!1)}},er=we=>{ot(null),D(null),Ee(we)},Er=()=>{Fe||(Ee(null),ot(null))},un=async()=>{if(!pe)return;const we=pe.id;ze(!0),ot(null),D(null);try{await yS(we),Ee(null),await Ht()}catch(rt){const pt=rt?.response?.data?.message||rt?.response?.data?.error||"Failed to delete shift.";ot(pt),D(pt)}finally{ze(!1)}};if(l.useEffect(()=>{U&&(V(U.clock_in?En(U.clock_in):""),ue(U.clock_out?En(U.clock_out):""))},[U]),P)return e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(it,{})});const Gt=Me?new Date(Me):null,vr=Ye?new Date(Ye):null,qr=!!(T&&ce!==""&&Gt&&vr&&vr.getTime()>Gt.getTime()),$s=T?T.profile_name||t.find(we=>we.id===T.profile_id)?.name||`Profile ${T.profile_id}`:"",pn=pe?pe.profile_name||t.find(we=>we.id===pe.profile_id)?.name||`Profile ${pe.profile_id}`:"",hr={};J.forEach(we=>{if(we.clock_in&&we.clock_out){const rt=Number(we.id);if(Number.isNaN(rt))return;const pt=Number(we.profile_id);if(Number.isNaN(pt))return;const Qt=new Date(we.clock_in).getTime(),ur=new Date(we.clock_out).getTime(),Hr=Math.max(0,(ur-Qt)/(1e3*60*60)),Yr=Z[rt]||[];let Ur=0;Yr.forEach(Gr=>{const Wr=typeof Gr.duration=="number"?Gr.duration:Number(Gr.duration)||0;Ur+=Wr});const Ir=Math.max(0,Hr-Ur),wr=Math.min(Hr,8),Tr=Math.max(0,Hr-8);hr[pt]||(hr[pt]={hours:0,idle:0,regular:0,overtime:0}),hr[pt].hours+=Hr,hr[pt].idle+=Ir,hr[pt].regular+=wr,hr[pt].overtime+=Tr}});let mr={},os={};return u&&s.forEach(we=>{const rt=we.profile_name||"Unknown",pt=typeof we.duration=="number"?we.duration:Number(we.duration)||0;mr[rt]=(mr[rt]||0)+pt,os[rt]||(os[rt]=[]),os[rt].push({date:we.date,duration:pt})}),e.jsxs(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsx(h,{variant:"h4",gutterBottom:!0,sx:{fontSize:"2.5rem"},children:"Time Tracking Reports"}),C&&e.jsx(We,{severity:"error",sx:{mb:2},children:C}),e.jsxs(M,{container:!0,spacing:3,children:[e.jsx(M,{item:!0,xs:12,children:e.jsxs(Ae,{sx:{p:2},children:[e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,md:2,children:e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{shrink:!0,children:"Profile"}),e.jsxs(Wt,{value:i,label:"Profile",onChange:we=>c(we.target.value),displayEmpty:!0,sx:{"& .MuiSelect-select":{fontSize:"1.2rem"}},children:[e.jsx(et,{value:"",sx:{fontSize:"1.2rem"},children:"All Profiles"}),t.map(we=>e.jsx(et,{value:we.id,sx:{fontSize:"1.1rem"},children:we.name},we.id))]})]})}),e.jsx(M,{item:!0,xs:12,md:2,children:e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{shrink:!0,children:"Sales Order"}),e.jsxs(Wt,{value:u,label:"Sales Order",onChange:we=>d(we.target.value),displayEmpty:!0,sx:{"& .MuiSelect-select":{fontSize:"1.2rem"}},children:[e.jsx(et,{value:"",sx:{fontSize:"1.2rem"},children:"All Sales Orders"}),n.map(we=>e.jsx(et,{value:we.id,sx:{fontSize:"1.1rem"},children:we.number},we.id))]})]})}),e.jsx(M,{item:!0,xs:12,md:2,children:e.jsx(_n,{dateAdapter:mu,children:e.jsx(Ln,{label:"From Date",value:j,onChange:we=>v(we),slotProps:{textField:{fullWidth:!0}}})})}),e.jsx(M,{item:!0,xs:12,md:2,children:e.jsx(_n,{dateAdapter:mu,children:e.jsx(Ln,{label:"To Date",value:w,onChange:we=>_(we),slotProps:{textField:{fullWidth:!0}}})})})]}),e.jsxs(k,{display:"flex",justifyContent:"center",gap:2,mt:2,children:[e.jsx(G,{variant:"contained",color:"secondary",onClick:()=>{Be(i===""?"":i),qt(""),Ke(""),D(null),Ne(!0)},children:"Add Shift"}),e.jsx(G,{variant:"contained",color:"primary",onClick:Ht,children:"Generate Report"}),e.jsx(G,{variant:"outlined",onClick:()=>dr("csv"),children:"Export CSV"}),e.jsx(G,{variant:"outlined",onClick:()=>dr("pdf"),children:"Download PDF"})]})]})}),e.jsx(M,{item:!0,xs:12,children:u?e.jsxs(Ae,{sx:{p:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,sx:{fontSize:"1.5rem"},children:"Time Entries Report for Sales Order"}),e.jsx(k,{mb:2,children:e.jsxs(Ae,{elevation:2,sx:{p:2,background:"#ede9fe",borderLeft:"6px solid #7c3aed"},children:[e.jsx(h,{variant:"h6",color:"#7c3aed",fontWeight:700,sx:{fontSize:"1.5rem"},children:"Total Hours by Profile on Sales Order"}),Object.entries(mr).map(([we,rt])=>e.jsxs(h,{variant:"body1",sx:{ml:2,fontSize:"1.2rem"},children:[" ",we,": ",rt.toFixed(2)," hrs"]},we))]})}),e.jsxs(Ae,{elevation:3,sx:{p:2,mb:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Time Entries for Sales Order"}),e.jsx(lr,{children:e.jsxs(nr,{children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Profile"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Date"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Clock In"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Clock Out"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Duration"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Actions"})]})}),e.jsx(ar,{children:s.map(we=>e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.1rem"},children:we.profile_name}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:new Date(we.date).toLocaleDateString()}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:new Date(we.clock_in).toLocaleTimeString()}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:we.clock_out?new Date(we.clock_out).toLocaleTimeString():"-"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:we.duration!==null&&we.duration!==void 0&&!isNaN(Number(we.duration))?`${Number(we.duration).toFixed(3)} hrs`:"-"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:we.clock_out&&e.jsx(G,{variant:"text",startIcon:e.jsx(di,{}),onClick:()=>{ee(null),D(null),b(we),g(En(we.clock_in)),R(En(we.clock_out))},sx:{ml:1},children:"Edit"})})]},we.id))})]})})]})]}):e.jsxs(Ae,{sx:{p:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,sx:{fontSize:"1.5rem"},children:"Time Entries Report"}),e.jsx(k,{display:"flex",alignItems:"center",mb:2,children:e.jsx(vn,{control:e.jsx(ui,{checked:xe,onChange:we=>me(we.target.checked),color:"primary"}),label:e.jsx(h,{sx:{fontSize:"1.1rem"},children:"Show time entry breakdown"})})}),J.length>0&&e.jsx(k,{mb:2,children:e.jsxs(Ae,{elevation:2,sx:{p:2,background:"#ede9fe",borderLeft:"6px solid #7c3aed"},children:[e.jsx(h,{variant:"h6",color:"#7c3aed",fontWeight:700,children:"Summary of Shift Hours by Profile"}),e.jsx(lr,{component:Ae,sx:{mt:2},children:e.jsxs(nr,{size:"small",children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Profile Name"}),e.jsx(ne,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Total hr"}),e.jsx(ne,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Idle hr"}),e.jsx(ne,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Regular hr"}),e.jsx(ne,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Overtime hr"})]})}),e.jsx(ar,{children:Object.entries(hr).map(([we,rt])=>{const Qt=J.find(ur=>ur.profile_id===Number(we))?.profile_name||t.find(ur=>ur.id===Number(we))?.name||`Profile ${we}`;return e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.2rem"},children:Qt}),e.jsx(ne,{sx:{fontSize:"1.2rem"},children:rt.hours.toFixed(2)}),e.jsx(ne,{sx:{fontSize:"1.2rem"},children:rt.idle.toFixed(2)}),e.jsx(ne,{sx:{fontSize:"1.2rem"},children:rt.regular.toFixed(2)}),e.jsx(ne,{sx:{fontSize:"1.2rem"},children:rt.overtime.toFixed(2)})]},we)})})]})})]})}),J.length===0&&!P&&e.jsx(We,{severity:"info",sx:{mb:2},children:"No shifts found"}),J.map(we=>{const rt=Number(we.id);return Number.isNaN(rt)?null:e.jsx(_S,{shift:we,entries:Z[rt]||[],expanded:y===rt,onExpand:()=>S(y===rt?null:rt),onAddEntry:Sn,setEditEntry:b,setEditClockIn:g,setEditClockOut:R,profiles:t,setEditShift:K,showBreakdown:xe,setEditEntryError:ee,setError:D,onDeleteShift:er,onDeleteEntry:Le},rt)}),X.length>0&&e.jsx(Ae,{elevation:3,sx:{mb:2,borderLeft:"6px solid #a21caf",background:"#f3e8ff"},children:e.jsxs(k,{p:2,children:[e.jsx(h,{variant:"subtitle1",fontWeight:700,color:"#a21caf",sx:{fontSize:"1.2rem"},children:"Unscheduled Entries"}),e.jsx(bh,{entries:X,setEditEntry:b,setEditClockIn:g,setEditClockOut:R,setEditEntryError:ee,setError:D,onDeleteEntry:Le})]})})]})})]}),e.jsxs(mt,{open:he,onClose:Pe,children:[e.jsx(ft,{children:"Add Time Entry"}),e.jsxs(xt,{children:[T&&e.jsx(h,{variant:"body2",sx:{mb:2},children:`Profile: ${$s} | Shift Date: ${new Date(T.clock_in).toLocaleDateString()}`}),e.jsxs(Mt,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Ut,{id:"add-entry-sales-order-label",children:"Sales Order"}),e.jsxs(Wt,{labelId:"add-entry-sales-order-label",value:ce,label:"Sales Order",displayEmpty:!0,onChange:we=>{const rt=we.target.value;re(rt===""?"":Number(rt))},children:[e.jsx(et,{value:"",disabled:!0,children:e.jsx("em",{children:"Select a Sales Order"})}),n.map(we=>e.jsx(et,{value:we.id,children:we.number},we.id))]})]}),e.jsx(le,{label:"Clock In",type:"datetime-local",value:Me,onChange:we=>Ce(we.target.value),fullWidth:!0,sx:{mb:2}}),e.jsx(le,{label:"Clock Out",type:"datetime-local",value:Ye,onChange:we=>Qe(we.target.value),fullWidth:!0})]}),e.jsxs(_t,{children:[e.jsx(G,{onClick:Pe,disabled:lt,children:"Cancel"}),e.jsx(G,{onClick:Ie,variant:"contained",disabled:!qr||lt,children:"Save"})]})]}),e.jsxs(mt,{open:!!A,onClose:()=>{b(null),ee(null)},children:[e.jsx(ft,{children:"Edit Time Entry"}),e.jsxs(xt,{children:[O&&e.jsx(We,{severity:"error",sx:{mb:2},children:O}),e.jsx(le,{label:"Clock In",type:"datetime-local",value:N,onChange:we=>g(we.target.value),fullWidth:!0,sx:{mb:2}}),e.jsx(le,{label:"Clock Out",type:"datetime-local",value:x,onChange:we=>R(we.target.value),fullWidth:!0})]}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>{b(null),ee(null)},children:"Cancel"}),e.jsx(G,{onClick:dn,variant:"contained",startIcon:e.jsx(zu,{}),children:"Save"})]})]}),e.jsxs(mt,{open:!!zt,onClose:nt,children:[e.jsx(ft,{children:"Delete Time Entry"}),e.jsxs(xt,{children:[be&&e.jsx(We,{severity:"error",sx:{mb:2},children:be}),zt&&e.jsxs(h,{variant:"body2",children:["Are you sure you want to delete the entry for sales order ",zt.sales_order_number," on"," ",new Date(zt.clock_in).toLocaleString(),"?"]})]}),e.jsxs(_t,{children:[e.jsx(G,{onClick:nt,disabled:jr,children:"Cancel"}),e.jsx(G,{onClick:jt,variant:"contained",color:"error",disabled:jr,children:"Delete"})]})]}),e.jsxs(mt,{open:ut,onClose:()=>{Yt||Ne(!1)},children:[e.jsx(ft,{children:"Add Shift"}),e.jsxs(xt,{children:[e.jsxs(Mt,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Ut,{id:"add-shift-profile-label",children:"Profile"}),e.jsxs(Wt,{labelId:"add-shift-profile-label",value:tt,label:"Profile",onChange:we=>Be(we.target.value),displayEmpty:!0,renderValue:we=>{if(we==null)return e.jsx("em",{children:"Select Profile"});if(typeof we=="string"&&we==="")return e.jsx("em",{children:"Select Profile"});const rt=t.find(pt=>pt.id===Number(we));return rt?rt.name:String(we)},children:[e.jsx(et,{value:"",children:e.jsx("em",{children:"Select Profile"})}),t.map(we=>e.jsx(et,{value:we.id,children:we.name},we.id))]})]}),e.jsx(le,{label:"Clock In",type:"datetime-local",value:Ct,onChange:we=>qt(we.target.value),fullWidth:!0,sx:{mb:2},InputLabelProps:{shrink:!0}}),e.jsx(le,{label:"Clock Out",type:"datetime-local",value:Bt,onChange:we=>Ke(we.target.value),fullWidth:!0,InputLabelProps:{shrink:!0}})]}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>{Yt||Ne(!1)},children:"Cancel"}),e.jsx(G,{onClick:async()=>{if(tt===""||!Ct||!Bt)return;const we=bs(Ct),rt=bs(Bt);if(!we||!rt){D("Please provide valid shift times.");return}Et(!0);try{await fS(tt,we,rt),Ne(!1),qt(""),Ke(""),D(null),await Ht()}catch(pt){const Qt=pt?.response?.data?.message||pt?.response?.data?.error||"Failed to create shift.";D(Qt)}finally{Et(!1)}},variant:"contained",color:"primary",disabled:Yt||tt===""||!Ct||!Bt,children:"Save"})]})]}),e.jsxs(mt,{open:!!U,onClose:()=>K(null),children:[e.jsx(ft,{children:"Edit Shift"}),e.jsxs(xt,{children:[e.jsx(le,{label:"Clock In",type:"datetime-local",value:E,onChange:we=>V(we.target.value),fullWidth:!0,sx:{mb:2}}),e.jsx(le,{label:"Clock Out",type:"datetime-local",value:q,onChange:we=>ue(we.target.value),fullWidth:!0})]}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>K(null),children:"Cancel"}),e.jsx(G,{onClick:async()=>{if(U){ge(!0);try{await xS(U.id,new Date(E).toISOString(),new Date(q).toISOString()),K(null),ge(!1),await Ht()}catch(we){ge(!1);const rt=we?.response?.data?.message||we?.response?.data?.error||"Failed to update shift.";D(rt)}}},variant:"contained",color:"primary",disabled:ye,children:"Save"})]})]}),e.jsxs(mt,{open:!!pe,onClose:Er,children:[e.jsx(ft,{children:"Delete Shift"}),e.jsxs(xt,{children:[Ze&&e.jsx(We,{severity:"error",sx:{mb:2},children:Ze}),pe&&e.jsxs(h,{variant:"body2",children:["Are you sure you want to delete the shift for ",pn," on"," ",new Date(pe.clock_in).toLocaleString(),"? Any associated time entries must be removed first."]})]}),e.jsxs(_t,{children:[e.jsx(G,{onClick:Er,disabled:Fe,children:"Cancel"}),e.jsx(G,{onClick:un,variant:"contained",color:"error",disabled:Fe,children:"Delete"})]})]})]})};function bS(t,r){const n=window.URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=r,document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(n),document.body.removeChild(a)}function _S({shift:t,entries:r,expanded:n,onExpand:a,onAddEntry:s,setEditEntry:o,setEditClockIn:i,setEditClockOut:c,profiles:u,setEditShift:d,showBreakdown:p,setEditEntryError:f,setError:m,onDeleteShift:j,onDeleteEntry:v}){const w=new Date(t.clock_in),_=t.clock_out?new Date(t.clock_out):null,P=t.duration!==null&&t.duration!==void 0?Number(t.duration):0,L=t.profile_name||u.find(A=>A.id===t.profile_id)?.name||`Profile ${t.profile_id}`;let C=0;r.forEach(A=>{const b=typeof A.duration=="number"?A.duration:Number(A.duration)||0;C+=b});const D=Math.max(0,P-C);return e.jsx(Ae,{elevation:3,sx:{mb:2,borderLeft:"6px solid #7c3aed",background:n?"#f3e8ff":"white"},children:e.jsxs(k,{p:2,children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(h,{variant:"subtitle1",fontWeight:700,color:"#7c3aed",sx:{fontSize:"1.2rem"},children:["Profile: ",L,"  Date: ",w.toLocaleDateString()]}),e.jsxs(k,{display:"flex",gap:1,children:[p&&e.jsx(G,{variant:"contained",color:"primary",size:"small",onClick:a,children:n?"Hide Entries":"Show Entries"}),e.jsx(G,{variant:"outlined",color:"primary",size:"small",onClick:()=>s(t),children:"Add Entry"}),e.jsx(G,{variant:"contained",color:"primary",size:"small",onClick:()=>d(t),children:"Edit Shift"}),e.jsx(G,{variant:"outlined",color:"error",size:"small",onClick:()=>j(t),startIcon:e.jsx(qs,{}),children:"Delete Shift"})]})]}),e.jsxs(h,{variant:"body1",sx:{mt:1,fontSize:"1.1rem"},children:["Shift: ",w.toLocaleTimeString(),"  ",_?_.toLocaleTimeString():"-"," (",P.toFixed(2)," hrs)"]}),p&&e.jsxs(k,{sx:{mt:1,ml:2},children:[r.map((A,b)=>{const N=typeof A.duration=="number"?A.duration:Number(A.duration)||0,g=new Date(A.clock_in),x=A.clock_out?new Date(A.clock_out):null;return e.jsxs(h,{variant:"body2",sx:{fontSize:"1.1rem"},children:[" ",A.sales_order_number,": ",g.toLocaleTimeString(),"  ",x?x.toLocaleTimeString():"-"," (",N.toFixed(3)," hrs)"]},A.id||b)}),D>0&&e.jsxs(h,{variant:"body2",sx:{fontSize:"1.1rem"},children:[" Idle: ",D.toFixed(3)," hrs"]})]}),p&&n&&e.jsx(bh,{entries:r,setEditEntry:o,setEditClockIn:i,setEditClockOut:c,setEditEntryError:f,setError:m,onDeleteEntry:v})]})})}function bh({entries:t,setEditEntry:r,setEditClockIn:n,setEditClockOut:a,setEditEntryError:s,setError:o,onDeleteEntry:i}){return e.jsx(lr,{sx:{mt:1,mb:1},children:e.jsxs(nr,{size:"small",children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Sales Order"}),e.jsx(ne,{children:"Clock In"}),e.jsx(ne,{children:"Clock Out"}),e.jsx(ne,{children:"Duration"}),e.jsx(ne,{children:"Actions"})]})}),e.jsx(ar,{children:t.map(c=>e.jsxs(ht,{children:[e.jsx(ne,{children:c.sales_order_number}),e.jsx(ne,{children:new Date(c.clock_in).toLocaleTimeString()}),e.jsx(ne,{children:c.clock_out?new Date(c.clock_out).toLocaleTimeString():"-"}),e.jsx(ne,{children:c.duration!==null&&c.duration!==void 0&&!isNaN(Number(c.duration))?`${Number(c.duration).toFixed(3)} hrs`:"-"}),e.jsxs(ne,{children:[c.clock_out&&e.jsx(G,{variant:"text",startIcon:e.jsx(di,{}),onClick:()=>{s(null),o(null),r(c),n(En(c.clock_in)),a(En(c.clock_out))},sx:{ml:1},children:"Edit"}),i&&e.jsx(G,{variant:"text",color:"error",startIcon:e.jsx(qs,{}),onClick:()=>i(c),sx:{ml:c.clock_out?1:0},children:"Delete"})]})]},c.id))})]})})}const Vr={submitRequest:async t=>(await B.post("/api/leave-management/request",t)).data,getMyRequests:async()=>(await B.get("/api/leave-management/my-requests")).data,getAllRequests:async()=>(await B.get("/api/leave-management/all-requests")).data,getCalendar:async(t,r)=>{const n={};return t&&(n.start_date=t),r&&(n.end_date=r),(await B.get("/api/leave-management/calendar",{params:n})).data},approveRequest:async(t,r,n,a)=>(await B.post(`/api/leave-management/approve/${t}`,{admin_notes:r,proposed_start_date:n,proposed_end_date:a})).data,denyRequest:async(t,r)=>(await B.post(`/api/leave-management/deny/${t}`,{admin_notes:r})).data,proposeVacationDates:async(t,r,n,a)=>(await B.post(`/api/leave-management/propose/${t}`,{proposed_start_date:r,proposed_end_date:n,admin_notes:a})).data,getProfiles:async()=>(await B.get("/api/leave-management/profiles")).data,getLeaveHistory:async()=>(await B.get("/api/leave-management/history")).data,getVacationSettings:async()=>(await B.get("/api/leave-management/vacation-settings")).data,updateVacationSettings:async t=>(await B.put("/api/leave-management/vacation-settings",{reset_date:t})).data,updateEmployeeVacationDays:async(t,r)=>(await B.put(`/api/leave-management/profiles/${t}/vacation-days`,{total_vacation_days:r})).data,resetAllVacationDays:async()=>(await B.post("/api/leave-management/reset-vacation-days")).data,getLeaveStatistics:async()=>(await B.get("/api/leave-management/statistics")).data},jS=()=>{const{user:t}=Zt(),r=Kt(),[n,a]=l.useState([]),[s,o]=l.useState([]),[i,c]=l.useState(!0),[u,d]=l.useState(null),[p,f]=l.useState(()=>{const y=$e(),S=y.day();return y.subtract(S,"day").startOf("day")}),[m,j]=l.useState({open:!1,requestId:0,action:"approve"}),[v,w]=l.useState(""),[_,P]=l.useState(null),[L,C]=l.useState(null),[D,A]=l.useState(!1),[b,N]=l.useState(!0);l.useEffect(()=>{console.log("LeaveManagementPage - User data:",t),(t?.access_role==="Admin"||t?.access_role==="Time Tracking")&&g()},[t]);const g=async()=>{try{console.log("LeaveManagementPage - Fetching data..."),c(!0);const[y,S]=await Promise.all([Vr.getAllRequests(),Vr.getProfiles()]);console.log("LeaveManagementPage - Data received:",{requestsData:y,profilesData:S}),a(y||[]),o(S||[]),d(null)}catch(y){console.error("LeaveManagementPage - Error fetching data:",y),d(y.response?.data?.message||"Failed to load data. Please try again.")}finally{c(!1)}},x=()=>{const y=[],S=$e();for(let U=0;U<7;U++){const K=p.add(U,"day"),E=K.isSame(S,"day"),V=n.filter(q=>{if(q.status!=="approved")return!1;const ue=$e(q.start_date),ye=$e(q.end_date);return(ue.isSame(K,"day")||ue.isBefore(K))&&(ye.isSame(K,"day")||ye.isAfter(K))}).map(q=>q.profile_name);y.push({date:K,isToday:E,hasTimeOff:V.length>0,timeOffProfiles:V})}return y},R=y=>{f(y==="prev"?S=>S.subtract(7,"day"):S=>S.add(7,"day"))},O=()=>{const y=$e(),S=y.day();f(y.subtract(S,"day").startOf("day"))},ee=()=>{const y=p.add(6,"day");return n.filter(S=>{if(S.status!=="approved")return!1;const U=$e(S.start_date),K=$e(S.end_date);return(U.isSame(y,"day")||U.isBefore(y))&&(K.isSame(p,"day")||K.isAfter(p))}).map(S=>({profileName:S.profile_name,startDate:$e(S.start_date),endDate:$e(S.end_date),requestType:S.request_type,reason:S.reason})).sort((S,U)=>S.startDate.valueOf()-U.startDate.valueOf())},J=()=>{const y=$e(),S=y.startOf("month"),U=y.endOf("month");return n.filter(E=>{if(E.status!=="approved")return!1;const V=$e(E.start_date),q=$e(E.end_date);return(V.isSame(U,"day")||V.isBefore(U))&&(q.isSame(S,"day")||q.isAfter(S))}).map(E=>({profileName:E.profile_name,startDate:$e(E.start_date),endDate:$e(E.end_date),requestType:E.request_type})).sort((E,V)=>E.startDate.valueOf()-V.startDate.valueOf())},z=()=>{const y=J();if(y.length===0)return"No employees on leave this month";const S=new Map;return y.forEach(K=>{S.has(K.profileName)||S.set(K.profileName,[]),S.get(K.profileName).push(K)}),Array.from(S.entries()).map(([K,E])=>{const V=E.map(q=>{const ue=q.startDate.format("MMM D"),ye=q.endDate.format("MMM D");return`${ue}-${ye}`}).join(", ");return`${K}: ${V}`}).slice(0,3).join("  ")},Z=(y,S)=>{j({open:!0,requestId:y,action:S}),w(""),P(null),C(null)},Q=async()=>{A(!0);try{const{requestId:y,action:S}=m;if(S==="approve")await Vr.approveRequest(y,v,_?.format("YYYY-MM-DD"),L?.format("YYYY-MM-DD"));else if(S==="deny")await Vr.denyRequest(y,v);else if(S==="propose"){if(!_||!L){d("Please enter both start and end dates"),A(!1);return}if(L.isBefore(_)){d("End date cannot be before start date"),A(!1);return}await Vr.proposeVacationDates(y,_.format("YYYY-MM-DD"),L.format("YYYY-MM-DD"),v)}j({open:!1,requestId:0,action:"approve"}),await g()}catch(y){d(y.response?.data?.message||"Action failed. Please try again.")}finally{A(!1)}},X=y=>{const U={pending:{color:"warning",label:"Pending"},approved:{color:"success",label:"Approved"},denied:{color:"error",label:"Denied"},modified:{color:"info",label:"Modified"}}[y]||{color:"default",label:y};return e.jsx(De,{label:U.label,color:U.color,size:"small"})},I=y=>({vacation:"Vacation",sick:"Sick Day",personal:"Personal",bereavement:"Bereavement"})[y]||y;return t?t.access_role!=="Admin"&&t.access_role!=="Time Tracking"?e.jsx(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(We,{severity:"error",children:"Access denied. Admin or Time Tracking privileges required to view this page."})}):i?e.jsx(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(it,{})})}):e.jsx(_n,{dateAdapter:ss,children:e.jsxs(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(h,{variant:"h4",component:"h1",children:["Leave Management",t.access_role==="Admin"?" (Admin)":" (View Only)"]}),e.jsxs(k,{display:"flex",gap:2,children:[e.jsx(G,{variant:"outlined",startIcon:e.jsx(il,{}),onClick:()=>r("/leave-history"),children:"View History"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(Ds,{}),onClick:()=>r("/vacation-days-management"),children:"Manage Vacation Days"})]})]}),e.jsx(h,{variant:"body1",color:"text.secondary",paragraph:!0,children:z()}),u&&e.jsx(We,{severity:"error",sx:{mb:2},children:u}),e.jsxs(M,{container:!0,spacing:3,children:[e.jsx(M,{item:!0,xs:12,children:e.jsxs(Ae,{sx:{p:3},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(h,{variant:"h6",children:[e.jsx(Es,{sx:{mr:1,verticalAlign:"middle"}}),"Weekly Leave Schedule"]}),e.jsxs(k,{display:"flex",gap:1,children:[e.jsx(G,{variant:"outlined",size:"small",onClick:()=>R("prev"),startIcon:e.jsx(Jh,{}),children:"Previous Week"}),e.jsx(G,{variant:"outlined",size:"small",onClick:O,startIcon:e.jsx(Xh,{}),children:"Today"}),e.jsx(G,{variant:"outlined",size:"small",onClick:()=>R("next"),endIcon:e.jsx(Zh,{}),children:"Next Week"})]})]}),e.jsxs(h,{variant:"body2",color:"text.secondary",mb:3,children:["Week of ",p.format("MMMM D, YYYY")]}),e.jsx(k,{sx:{overflowX:"auto"},children:e.jsx(lr,{component:Ae,variant:"outlined",children:e.jsxs(nr,{size:"small",children:[e.jsx(sr,{children:e.jsxs(ht,{sx:{backgroundColor:"grey.50"},children:[e.jsx(ne,{sx:{fontWeight:"bold",minWidth:140},children:"Employee Name"}),x().map((y,S)=>e.jsx(ne,{align:"center",sx:{fontWeight:"bold",minWidth:70},children:e.jsxs(k,{children:[e.jsx(h,{variant:"caption",display:"block",sx:{fontWeight:"bold"},children:y.date.format("ddd")}),e.jsx(h,{variant:"body2",children:y.date.format("MMM D")}),y.isToday&&e.jsx(h,{variant:"caption",display:"block",sx:{color:"primary.main",fontWeight:"bold"},children:"Today"})]})},S))]})}),e.jsxs(ar,{children:[ee().map((y,S)=>e.jsxs(ht,{hover:!0,children:[e.jsx(ne,{sx:{fontWeight:"medium"},children:y.profileName}),x().map((U,K)=>{const E=(y.startDate.isSame(U.date,"day")||y.startDate.isBefore(U.date))&&(y.endDate.isSame(U.date,"day")||y.endDate.isAfter(U.date));return e.jsx(ne,{align:"center",sx:{backgroundColor:E?"error.light":"inherit",color:E?"error.dark":"text.primary",fontWeight:E?"medium":"normal"},children:E?e.jsxs(k,{children:[e.jsx(h,{variant:"caption",display:"block",sx:{fontWeight:"bold",textTransform:"capitalize"},children:I(y.requestType)}),y.reason&&e.jsx(Vt,{title:y.reason,children:e.jsx(h,{variant:"caption",sx:{opacity:.75},children:y.reason.length>8?y.reason.substring(0,8)+"...":y.reason})})]}):e.jsx(h,{variant:"body2",color:"text.secondary",children:"-"})},K)})]},S)),ee().length===0&&e.jsx(ht,{children:e.jsx(ne,{colSpan:8,align:"center",sx:{py:4},children:e.jsxs(k,{sx:{textAlign:"center"},children:[e.jsx(Es,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(h,{color:"text.secondary",children:"No employees on leave this week"})]})})})]})]})})})]})}),e.jsx(M,{item:!0,xs:12,children:e.jsxs(Ae,{sx:{p:3},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(h,{variant:"h6",children:[e.jsx(em,{sx:{mr:1,verticalAlign:"middle"}}),"Leave Requests",t.access_role!=="Admin"&&e.jsx(h,{variant:"caption",display:"block",color:"text.secondary",sx:{mt:1},children:"View-only mode. Admin actions are restricted to administrators."})]}),e.jsxs(k,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(h,{variant:"body2",color:"text.secondary",children:"Show:"}),e.jsx(G,{variant:b?"contained":"outlined",size:"small",onClick:()=>N(!0),sx:{minWidth:100},children:"Pending"}),e.jsx(G,{variant:b?"outlined":"contained",size:"small",onClick:()=>N(!1),sx:{minWidth:100},children:"All"})]})]}),e.jsx(lr,{children:e.jsxs(nr,{children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontWeight:"bold"},children:"Employee"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Type"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Dates"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Days"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Status"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Reason"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Admin Notes"}),e.jsx(ne,{sx:{fontWeight:"bold"},children:"Actions"})]})}),e.jsx(ar,{children:(()=>{const y=b?n.filter(S=>S.status==="pending"):n;return y.length===0?e.jsx(ht,{children:e.jsx(ne,{colSpan:8,align:"center",sx:{py:4},children:e.jsx(h,{color:"text.secondary",children:b?"No pending leave requests found":"No leave requests found"})})}):y.map(S=>e.jsxs(ht,{hover:!0,children:[e.jsx(ne,{children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",sx:{fontWeight:"medium"},children:S.profile_name}),e.jsx(h,{variant:"caption",color:"text.secondary",children:S.user_email})]})}),e.jsx(ne,{children:e.jsx(De,{label:I(S.request_type),size:"small",variant:"outlined"})}),e.jsxs(ne,{children:[e.jsx(h,{variant:"body2",children:$e(S.start_date).format("MMM D, YYYY")}),e.jsxs(h,{variant:"body2",children:["to ",$e(S.end_date).format("MMM D, YYYY")]})]}),e.jsx(ne,{children:e.jsxs(h,{variant:"body2",children:[S.total_days," day",S.total_days!==1?"s":""]})}),e.jsx(ne,{children:X(S.status)}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",sx:{maxWidth:200},children:S.reason||"-"})}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",sx:{maxWidth:200},children:S.admin_notes||"-"})}),e.jsx(ne,{children:S.status==="pending"&&t.access_role==="Admin"&&e.jsxs(k,{display:"flex",gap:1,children:[e.jsx(Vt,{title:"Approve Request",children:e.jsx(gt,{color:"success",size:"small",onClick:()=>Z(S.request_id,"approve"),children:e.jsx(Ja,{})})}),e.jsx(Vt,{title:"Deny Request",children:e.jsx(gt,{color:"error",size:"small",onClick:()=>Z(S.request_id,"deny"),children:e.jsx(ws,{})})}),(S.request_type==="vacation"||S.request_type==="personal"||S.request_type==="bereavement")&&e.jsx(Vt,{title:"Propose Dates",children:e.jsx(gt,{color:"info",size:"small",onClick:()=>Z(S.request_id,"propose"),children:e.jsx(Es,{})})})]})})]},S.request_id))})()})]})})]})})]}),e.jsxs(mt,{open:m.open,onClose:()=>j({open:!1,requestId:0,action:"approve"}),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:m.action==="approve"?"Approve Request":m.action==="deny"?"Deny Request":"Propose Dates"}),e.jsx(xt,{children:e.jsxs(k,{sx:{pt:2},children:[(m.action==="propose"||m.action==="approve")&&e.jsx(k,{sx:{mb:3},children:e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:6,children:e.jsx(Ln,{label:m.action==="propose"?"Proposed Start Date":"Proposed Start Date (Optional)",value:_,onChange:y=>P(y),slotProps:{textField:{fullWidth:!0,size:"small"}}})}),e.jsx(M,{item:!0,xs:6,children:e.jsx(Ln,{label:m.action==="propose"?"Proposed End Date":"Proposed End Date (Optional)",value:L,onChange:y=>C(y),minDate:_,disabled:!_,slotProps:{textField:{fullWidth:!0,size:"small"}}})})]})}),e.jsx(le,{fullWidth:!0,multiline:!0,rows:3,label:"Admin Notes",value:v,onChange:y=>w(y.target.value),placeholder:"Add notes about this decision...",variant:"outlined",size:"small"})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>j({open:!1,requestId:0,action:"approve"}),disabled:D,children:"Cancel"}),e.jsx(G,{onClick:Q,disabled:D,variant:"contained",color:m.action==="deny"?"error":"primary",children:D?"Processing...":m.action==="approve"?"Approve":m.action==="deny"?"Deny":"Propose"})]})]})]})}):e.jsx(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:[e.jsx(it,{}),e.jsx(h,{variant:"body2",sx:{ml:2},children:"Loading user data..."})]})})},wS=()=>{const{user:t}=Zt(),[r,n]=l.useState([]),[a,s]=l.useState(null),[o,i]=l.useState(!0),[c,u]=l.useState(null);l.useEffect(()=>{(t?.access_role==="Admin"||t?.access_role==="Time Tracking")&&d()},[t]);const d=async()=>{try{i(!0);const[v,w]=await Promise.all([Vr.getLeaveHistory(),Vr.getLeaveStatistics()]);n(v||[]),s(w),u(null)}catch(v){console.error("Error fetching leave history:",v),u(v.response?.data?.message||"Failed to load leave history. Please try again.")}finally{i(!1)}},p=v=>$e(v+"-01").format("MMMM YYYY"),f=v=>{let w=0;return Object.values(v.months).forEach(_=>{w+=_.total_days}),w},m=()=>{const v=new Set;return r.forEach(w=>{Object.keys(w.months).forEach(_=>v.add(_))}),Array.from(v).sort().reverse()};if(!t)return e.jsx(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:[e.jsx(it,{}),e.jsx(h,{variant:"body2",sx:{ml:2},children:"Loading user data..."})]})});if(t.access_role!=="Admin"&&t.access_role!=="Time Tracking")return e.jsx(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(We,{severity:"error",children:"Access denied. Admin or Time Tracking privileges required to view this page."})});if(o)return e.jsx(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(it,{})})});const j=m();return e.jsxs(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(h,{variant:"h4",component:"h1",gutterBottom:!0,children:[e.jsx(il,{sx:{mr:1,verticalAlign:"middle"}}),"Leave History (Past 12 Months)"]}),e.jsx(h,{variant:"body1",color:"text.secondary",paragraph:!0,children:"View leave history for all employees over the past 12 months"}),c&&e.jsx(We,{severity:"error",sx:{mb:2},children:c}),r.length===0?e.jsxs(Ae,{sx:{p:4,textAlign:"center"},children:[e.jsx(il,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(h,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"No Leave History Found"}),e.jsx(h,{color:"text.secondary",children:"No approved leave requests found in the past 12 months."})]}):e.jsxs(k,{children:[e.jsxs(M,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(M,{item:!0,xs:12,md:4,children:e.jsx(kt,{children:e.jsx(Tt,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Ml,{sx:{fontSize:40,color:"primary.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"div",children:a?.employees_with_leave_this_month||0}),e.jsx(h,{color:"text.secondary",children:"Employees with Leave This Month"})]})]})})})}),e.jsx(M,{item:!0,xs:12,md:4,children:e.jsx(kt,{children:e.jsx(Tt,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Es,{sx:{fontSize:40,color:"success.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"div",children:a?.total_days_this_month||0}),e.jsx(h,{color:"text.secondary",children:"Total Days of Leave This Month"})]})]})})})}),e.jsx(M,{item:!0,xs:12,md:4,children:e.jsx(kt,{children:e.jsx(Tt,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Bu,{sx:{fontSize:40,color:"info.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"div",children:a?.total_days_past_12_months||0}),e.jsx(h,{color:"text.secondary",children:"Total Days of Leave (Past 12 Months)"})]})]})})})})]}),r.map(v=>e.jsxs(tm,{sx:{mb:2},children:[e.jsx(rm,{expandIcon:e.jsx(Hu,{}),children:e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%",children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h6",children:v.profile_name}),e.jsx(h,{variant:"body2",color:"text.secondary",children:v.profile_email})]}),e.jsxs(k,{display:"flex",alignItems:"center",gap:2,children:[e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Total: ",f(v).toFixed(1)," days"]}),e.jsx(De,{label:`${Object.keys(v.months).length} months`,size:"small",variant:"outlined"})]})]})}),e.jsx(nm,{children:e.jsx(lr,{component:Ae,variant:"outlined",children:e.jsxs(nr,{size:"small",children:[e.jsx(sr,{children:e.jsxs(ht,{sx:{backgroundColor:"grey.50"},children:[e.jsx(ne,{sx:{fontWeight:"bold"},children:"Month"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Vacation"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Sick"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Personal"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Bereavement"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Total"})]})}),e.jsx(ar,{children:j.map(w=>{const _=v.months[w];return!_||_.total_days===0?null:e.jsxs(ht,{hover:!0,children:[e.jsx(ne,{sx:{fontWeight:"medium"},children:p(w)}),e.jsx(ne,{align:"center",children:_.vacation_days>0?e.jsx(De,{label:_.vacation_days,size:"small",color:"success",variant:"outlined"}):"-"}),e.jsx(ne,{align:"center",children:_.sick_days>0?e.jsx(De,{label:_.sick_days,size:"small",color:"error",variant:"outlined"}):"-"}),e.jsx(ne,{align:"center",children:_.personal_days>0?e.jsx(De,{label:_.personal_days,size:"small",color:"info",variant:"outlined"}):"-"}),e.jsx(ne,{align:"center",children:_.bereavement_days>0?e.jsx(De,{label:_.bereavement_days,size:"small",color:"warning",variant:"outlined"}):"-"}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",sx:{fontWeight:"bold"},children:_.total_days})})]},w)})})]})})})]},v.profile_id))]})]})},SS=()=>{const{user:t}=Zt(),[r,n]=l.useState([]),[a,s]=l.useState(null),[o,i]=l.useState(!0),[c,u]=l.useState(null),[d,p]=l.useState(null),[f,m]=l.useState(0),[j,v]=l.useState(!1),[w,_]=l.useState(null),[P,L]=l.useState(!1);l.useEffect(()=>{t?.access_role==="Admin"&&C()},[t]);const C=async()=>{try{i(!0);const[J,z]=await Promise.all([Vr.getProfiles(),Vr.getVacationSettings()]);n(J||[]),s(z),u(null)}catch(J){console.error("Error fetching data:",J),u(J.response?.data?.message||"Failed to load data. Please try again.")}finally{i(!1)}},D=J=>{p(J.id),m(J.total_vacation_days||J.vacation_days_available||20)},A=async()=>{if(!d)return;const J=Math.round(f);try{L(!0),await Vr.updateEmployeeVacationDays(d,J),await C(),p(null),m(0)}catch(z){u(z.response?.data?.message||"Failed to update vacation days.")}finally{L(!1)}},b=()=>{p(null),m(0)},N=()=>{_(a?.reset_date?$e(a.reset_date):null),v(!0)},g=async()=>{if(!w){u("Please select a reset date.");return}try{L(!0),await Vr.updateVacationSettings(w.format("YYYY-MM-DD")),await C(),v(!1)}catch(J){u(J.response?.data?.message||"Failed to update settings.")}finally{L(!1)}},x=async()=>{if(window.confirm("This will reset vacation days for ALL employees. Are you sure?"))try{L(!0),await Vr.resetAllVacationDays(),await C()}catch(J){u(J.response?.data?.message||"Failed to reset vacation days.")}finally{L(!1)}};if(!t)return e.jsx(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:[e.jsx(it,{}),e.jsx(h,{variant:"body2",sx:{ml:2},children:"Loading user data..."})]})});if(t.access_role!=="Admin")return e.jsx(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(We,{severity:"error",children:"Access denied. Admin privileges required to view this page."})});if(o)return e.jsx(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(it,{})})});const R=r.length,O=r.reduce((J,z)=>J+(z.total_vacation_days||z.vacation_days_available||20),0),ee=r.reduce((J,z)=>J+Math.round(z.days_used||0),0);return e.jsx(_n,{dateAdapter:ss,children:e.jsxs(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(h,{variant:"h4",component:"h1",children:[e.jsx(Ds,{sx:{mr:1,verticalAlign:"middle"}}),"Vacation Days Management"]}),e.jsxs(k,{display:"flex",gap:2,children:[e.jsx(G,{variant:"outlined",startIcon:e.jsx(Es,{}),onClick:N,children:"Reset Settings"}),e.jsx(G,{variant:"contained",color:"warning",startIcon:e.jsx(Ll,{}),onClick:x,disabled:P,children:"Reset All Days"})]})]}),e.jsx(h,{variant:"body1",color:"text.secondary",paragraph:!0,children:"Manage vacation days allocation for each employee and set the global reset date."}),c&&e.jsx(We,{severity:"error",sx:{mb:2},children:c}),e.jsxs(M,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(M,{item:!0,xs:12,md:3,children:e.jsx(kt,{children:e.jsx(Tt,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Ml,{sx:{fontSize:40,color:"primary.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"div",children:R}),e.jsx(h,{color:"text.secondary",children:"Total Employees"})]})]})})})}),e.jsx(M,{item:!0,xs:12,md:3,children:e.jsx(kt,{children:e.jsx(Tt,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Es,{sx:{fontSize:40,color:"success.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"div",children:O}),e.jsx(h,{color:"text.secondary",children:"Total Days Allocated"})]})]})})})}),e.jsx(M,{item:!0,xs:12,md:3,children:e.jsx(kt,{children:e.jsx(Tt,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Bu,{sx:{fontSize:40,color:"info.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"div",children:ee}),e.jsx(h,{color:"text.secondary",children:"Days Used"})]})]})})})}),e.jsx(M,{item:!0,xs:12,md:3,children:e.jsx(kt,{children:e.jsx(Tt,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Ds,{sx:{fontSize:40,color:"warning.main",mr:2}}),e.jsxs(k,{children:[e.jsx(h,{variant:"h6",component:"div",children:a?.reset_date?$e(a.reset_date).format("MMM D, YYYY"):"Not Set"}),e.jsx(h,{color:"text.secondary",children:"Reset Date"})]})]})})})})]}),e.jsxs(Ae,{sx:{p:3},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Employee Vacation Days"}),e.jsx(lr,{children:e.jsxs(nr,{children:[e.jsx(sr,{children:e.jsxs(ht,{sx:{backgroundColor:"grey.50"},children:[e.jsx(ne,{sx:{fontWeight:"bold"},children:"Employee"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Total Days"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Days Used"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Days Remaining"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Reset Date"}),e.jsx(ne,{align:"center",sx:{fontWeight:"bold"},children:"Actions"})]})}),e.jsx(ar,{children:r.map(J=>e.jsxs(ht,{hover:!0,children:[e.jsx(ne,{children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",sx:{fontWeight:"medium"},children:J.name}),e.jsx(h,{variant:"caption",color:"text.secondary",children:J.email})]})}),e.jsx(ne,{align:"center",children:d===J.id?e.jsx(le,{type:"number",value:f,onChange:z=>m(Math.max(0,parseInt(z.target.value)||0)),size:"small",sx:{width:80},inputProps:{min:0,step:1}}):e.jsx(h,{variant:"body2",sx:{fontWeight:"bold"},children:J.total_vacation_days||J.vacation_days_available||20})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",color:"text.secondary",children:Math.round(J.days_used||0)})}),e.jsx(ne,{align:"center",children:e.jsx(De,{label:Math.round(J.days_remaining||J.vacation_days_available||20),size:"small",color:J.days_remaining&&J.days_remaining<5?"warning":"success",variant:"outlined"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",color:"text.secondary",children:J.reset_date?$e(J.reset_date).format("MMM D, YYYY"):"-"})}),e.jsx(ne,{align:"center",children:d===J.id?e.jsxs(k,{display:"flex",gap:1,children:[e.jsx(Vt,{title:"Save",children:e.jsx(gt,{color:"success",size:"small",onClick:A,disabled:P,children:e.jsx(zu,{})})}),e.jsx(Vt,{title:"Cancel",children:e.jsx(gt,{color:"error",size:"small",onClick:b,disabled:P,children:e.jsx(ws,{})})})]}):e.jsx(Vt,{title:"Edit Vacation Days",children:e.jsx(gt,{color:"primary",size:"small",onClick:()=>D(J),children:e.jsx(di,{})})})})]},J.id))})]})})]}),e.jsxs(mt,{open:j,onClose:()=>v(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(Ds,{sx:{mr:1}}),"Vacation Reset Settings"]})}),e.jsx(xt,{children:e.jsxs(k,{sx:{pt:2},children:[e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Set the date when vacation days will reset for all employees. This date will be the same for everyone and will repeat on the same month and day every year (e.g., January 1st, July 1st, etc.)."}),e.jsx(Ln,{label:"Reset Date",value:w,onChange:J=>_(J),slotProps:{textField:{fullWidth:!0,size:"small"}}}),w&&e.jsxs(We,{severity:"info",sx:{mt:2},children:["Vacation days will reset on ",w.format("MMMM D")," every year for all employees."]})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>v(!1),disabled:P,children:"Cancel"}),e.jsx(G,{onClick:g,disabled:P||!w,variant:"contained",children:P?"Saving...":"Save Settings"})]})]})]})})},CS=async()=>(await B.get("/api/products")).data,kS=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(!1),[s,o]=l.useState(null),[i,c]=l.useState({page:0,pageSize:10}),[u,d]=l.useState(""),[p,f]=l.useState(!1),[m,j]=l.useState(null),[v,w]=l.useState(null);l.useEffect(()=>{_()},[]);const _=async()=>{a(!0),o(null);try{const g=[...await CS()].sort((x,R)=>Number(R.product_id)-Number(x.product_id));r(g)}catch{o("Failed to fetch products"),H.error("Failed to fetch products")}finally{a(!1)}},P=t.filter(N=>{const g=u.toLowerCase();return N.product_name?.toLowerCase().includes(g)||N.product_description?.toLowerCase?.().includes(g)||String(N.product_id??"").toLowerCase().includes(g)}),L=async N=>{if(window.confirm("Are you sure you want to delete this product?"))try{await B.delete(`/api/products/${N}`),r(g=>g.filter(x=>x.product_id!==N)),H.success("Product deleted successfully")}catch{H.error("Failed to delete product")}},C=()=>{const N=P.map(ee=>({"Product ID":ee.product_id,"Product Name":ee.product_name,"Product Description":ee.product_description??""})),g=Wn.unparse(N),x=new Blob([g],{type:"text/csv;charset=utf-8;"}),R=document.createElement("a"),O=URL.createObjectURL(x);R.href=O,R.setAttribute("download","products.csv"),R.style.visibility="hidden",document.body.appendChild(R),R.click(),document.body.removeChild(R),w("Products exported to CSV.")},D=()=>f(!0),A=()=>f(!1),b=[{field:"product_id",headerName:"Product ID",flex:.8,minWidth:110},{field:"product_name",headerName:"Product Name",flex:1.4,minWidth:200},{field:"product_description",headerName:"Product Description",flex:2,minWidth:250,valueGetter:N=>N.row.product_description??""},{field:"actions",headerName:"Actions",width:90,sortable:!1,filterable:!1,disableColumnMenu:!0,renderCell:N=>e.jsx(gt,{size:"small",color:"error",onClick:g=>{g.stopPropagation(),L(N.row.product_id)},children:e.jsx(gr,{})})}];return e.jsxs(at,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{mb:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Product List"}),e.jsx(k,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:e.jsxs(ke,{direction:"row",spacing:2,children:[e.jsx(G,{variant:"contained",startIcon:e.jsx(Lr,{}),onClick:D,children:"New Product"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(yr,{}),onClick:C,children:"Export CSV"})]})})]}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(le,{fullWidth:!0,label:"Search",variant:"outlined",value:u,onChange:N=>d(N.target.value),InputProps:{startAdornment:e.jsx(pr,{position:"start",children:e.jsx(Br,{sx:{fontSize:22}})})},sx:{mb:2,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"small"}),e.jsx(Jr,{rows:P.map(N=>({...N,id:N.product_id})),columns:b,loading:n,paginationModel:i,onPaginationModelChange:c,pageSizeOptions:[10,25,50],getRowId:N=>N.id,disableRowSelectionOnClick:!0,initialState:{sorting:{sortModel:[{field:"product_id",sort:"desc"}]}},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})}),m&&e.jsx(We,{severity:"error",sx:{mt:2},onClose:()=>j(null),children:m}),v&&e.jsx(We,{severity:"success",sx:{mt:2},onClose:()=>w(null),children:v}),s&&e.jsx(h,{color:"error",children:s}),e.jsx(Jl,{open:p,onClose:A,onSave:async N=>{try{await B.post("/api/products",N),H.success("Product added successfully!"),f(!1),_()}catch{H.error("Failed to add product")}},isEditMode:!1})]})},PS=({open:t,onClose:r,onSettingsSaved:n})=>{const[a,s]=l.useState({customBackupDir:"",customRestoreDir:""}),[o,i]=l.useState(!1),[c,u]=l.useState(!1),[d,p]=l.useState(null),[f,m]=l.useState(!1);l.useEffect(()=>{t&&j()},[t]);const j=async()=>{i(!0);try{const C=await B.get("/api/backup/settings");s(C.data)}catch(C){console.error("Error fetching backup settings:",C),H.error("Failed to load backup settings")}finally{i(!1)}},v=async()=>{u(!0);try{await B.post("/api/backup/settings",a),H.success("Backup settings saved successfully!"),n(),r()}catch(C){console.error("Error saving backup settings:",C),H.error("Failed to save backup settings")}finally{u(!1)}},w=C=>{const D=C.target.files?.[0];D&&p(D)},_=async()=>{if(!d){H.error("Please select a backup file to upload");return}m(!0);try{const C=new FormData;C.append("backup",d);const D=await B.post("/api/backup/upload",C,{headers:{"Content-Type":"multipart/form-data"}});H.success("Backup uploaded successfully!"),p(null),n(),r()}catch(C){console.error("Error uploading backup:",C),H.error("Failed to upload backup file")}finally{m(!1)}},P=async()=>{try{if(window.api?.browseDirectory){const C=await window.api.browseDirectory({title:"Select Restore Directory"});C.success&&C.directory&&s(D=>({...D,customRestoreDir:C.directory}))}else H.info("Please enter the restore directory path manually")}catch(C){console.error("Error browsing restore directory:",C),H.error("Failed to browse directory")}},L=async()=>{try{if(window.api?.browseDirectory){const C=await window.api.browseDirectory({title:"Select Backup Directory"});C.success&&C.directory&&s(D=>({...D,customBackupDir:C.directory}))}else H.info("In web version, please enter the backup directory path manually. Example: C:\\MyBackups or /home/user/backups")}catch(C){console.error("Error browsing backup directory:",C),H.error("Failed to browse directory")}};return e.jsxs(mt,{open:t,onClose:r,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ds,{}),"Backup Settings"]})}),e.jsx(xt,{children:o?e.jsx(k,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(it,{})}):e.jsxs(k,{sx:{mt:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Custom Backup Directory"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Set a custom directory where backups will be stored on the server device. Note: Backups are created on the server, not your local device. The directory must be accessible from the server where the application is running."}),e.jsxs(M,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(M,{item:!0,xs:!0,children:e.jsx(le,{fullWidth:!0,label:"Backup Directory Path",value:a.customBackupDir,onChange:C=>s(D=>({...D,customBackupDir:C.target.value})),placeholder:"e.g., C:\\MyBackups or /home/user/backups",helperText:a.customBackupDir?`Backups will be stored in: ${a.customBackupDir}`:"Leave empty to use default backup location (backups folder in server directory)"})}),e.jsx(M,{item:!0,children:e.jsx(Vt,{title:"Browse for backup directory (Desktop app only)",children:e.jsx(gt,{onClick:L,children:e.jsx(nc,{})})})})]}),!a.customBackupDir&&e.jsxs(We,{severity:"info",sx:{mt:1},children:[e.jsx(Li,{children:"Default Backup Location"}),"Backups will be stored in the default location: ",e.jsx("strong",{children:"backups/"})," folder in the server directory. To use a custom location, enter a valid directory path above."]}),a.customBackupDir&&!a.customDirExists&&e.jsxs(We,{severity:"warning",sx:{mt:1},children:[e.jsx(Li,{children:"Directory Not Found"}),"The specified backup directory does not exist: ",e.jsx("strong",{children:a.customBackupDir}),"Backups will fall back to the default location until this directory is created."]}),a.currentBackupDir&&e.jsxs(We,{severity:"success",sx:{mt:1},children:[e.jsx(Li,{children:"Current Backup Location"}),"Backups are currently being stored in: ",e.jsx("strong",{children:a.currentBackupDir})]}),e.jsx(xr,{sx:{my:3}}),e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Custom Restore Directory"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Set a custom directory on the server to look for backup files when restoring. Note: This directory must be accessible from the server."}),e.jsxs(M,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(M,{item:!0,xs:!0,children:e.jsx(le,{fullWidth:!0,label:"Restore Directory Path",value:a.customRestoreDir,onChange:C=>s(D=>({...D,customRestoreDir:C.target.value})),placeholder:"e.g., C:\\ExternalBackups or /home/user/external-backups",helperText:"Leave empty to use default restore location"})}),e.jsx(M,{item:!0,children:e.jsx(Vt,{title:"Browse for restore directory",children:e.jsx(gt,{onClick:P,children:e.jsx(nc,{})})})})]}),e.jsx(xr,{sx:{my:3}}),e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Upload External Backup"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Upload a backup file from your device to restore from"}),e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsxs(G,{variant:"outlined",component:"label",startIcon:e.jsx(Qo,{}),disabled:f,children:["Select Backup File",e.jsx("input",{type:"file",hidden:!0,accept:".zip,.sql,.json",onChange:w})]}),d&&e.jsxs(h,{variant:"body2",children:["Selected: ",d.name]}),d&&e.jsx(G,{variant:"contained",onClick:_,disabled:f,startIcon:f?e.jsx(it,{size:20}):e.jsx(Qo,{}),children:f?"Uploading...":"Upload & Restore"})]}),e.jsx(We,{severity:"info",sx:{mt:2},children:e.jsxs(h,{variant:"body2",children:[e.jsx("strong",{children:"Note:"})," Custom directories must be accessible by the application. Make sure the directories exist and have proper read/write permissions."]})})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:r,children:"Cancel"}),e.jsx(G,{onClick:v,variant:"contained",disabled:c||o,startIcon:c?e.jsx(it,{size:20}):void 0,children:c?"Saving...":"Save Settings"})]})]})},DS=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(null),[s,o]=l.useState(!1),[i,c]=l.useState(!1),[u,d]=l.useState(null),[p,f]=l.useState(null),[m,j]=l.useState(null),[v,w]=l.useState(!1),_=async()=>{o(!0);try{const[x,R]=await Promise.all([B.get("/api/backup/list"),B.get("/api/backup/stats")]);r(x.data.backups),a(R.data)}catch(x){console.error("Error fetching backups:",x),H.error("Failed to fetch backups")}finally{o(!1)}};l.useEffect(()=>{_()},[]);const P=async()=>{c(!0);try{const x=await B.post("/api/backup/create");H.success("Backup created successfully!"),_()}catch(x){console.error("Error creating backup:",x),H.error("Failed to create backup")}finally{c(!1)}},L=async x=>{try{const R=await B.get(`/api/backup/download/${x}`,{responseType:"blob"}),O=window.URL.createObjectURL(new Blob([R.data])),ee=document.createElement("a");ee.href=O,ee.setAttribute("download",x),document.body.appendChild(ee),ee.click(),ee.remove(),window.URL.revokeObjectURL(O),H.success("Backup downloaded successfully!")}catch(R){console.error("Error downloading backup:",R),H.error("Failed to download backup")}},C=async x=>{try{await B.delete(`/api/backup/delete/${x}`),H.success("Backup deleted successfully!"),f(null),_()}catch(R){console.error("Error deleting backup:",R),H.error("Failed to delete backup")}},D=async x=>{d(x.manifest);try{const O=(await B.post(`/api/backup/restore/${x.manifest}`)).data.results,ee=Object.values(O).filter(z=>z==="success").length,J=Object.keys(O).length;ee===J?H.success("Backup restored successfully! Please refresh the page."):H.warning(`Restore completed with ${ee}/${J} components successful`),j(null),d(null)}catch(R){console.error("Error restoring backup:",R),H.error("Failed to restore backup"),d(null)}},A=x=>{if(x===0)return"0 Bytes";const R=1024,O=["Bytes","KB","MB","GB"],ee=Math.floor(Math.log(x)/Math.log(R));return parseFloat((x/Math.pow(R,ee)).toFixed(2))+" "+O[ee]},b=x=>x.replace(/(\d{4}-\d{2}-\d{2})T(\d{2})-(\d{2})-(\d{2})-(\d{3})Z/,"$1T$2:$3:$4.$5Z"),N=x=>new Date(b(x)).toLocaleString(),g=x=>{const R=x.components,O=Object.keys(R).length;return`${Object.values(R).filter(J=>J!==null).length}/${O}`};return e.jsxs(at,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{mb:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Backup Management"}),e.jsx(h,{variant:"body1",color:"text.secondary",gutterBottom:!0,children:"Create, manage, and restore backups of your application data"})]}),n&&e.jsxs(M,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsx(h,{color:"text.secondary",gutterBottom:!0,children:"Total Backups"}),e.jsx(h,{variant:"h4",component:"div",children:n.total_backups})]})})}),e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsx(h,{color:"text.secondary",gutterBottom:!0,children:"Total Size"}),e.jsx(h,{variant:"h4",component:"div",children:A(n.total_size)})]})})})]}),e.jsxs(k,{sx:{mb:3,display:"flex",gap:2,flexWrap:"wrap"},children:[e.jsx(G,{variant:"contained",startIcon:i?e.jsx(it,{size:20}):e.jsx(Nl,{}),onClick:P,disabled:i,children:i?"Creating Backup...":"Create Backup"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(Ll,{}),onClick:_,disabled:s,children:"Refresh"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(Ds,{}),onClick:()=>w(!0),children:"Backup Settings"})]}),e.jsx(We,{severity:"warning",sx:{mb:3},children:e.jsxs(h,{variant:"body2",children:[e.jsx("strong",{children:"Important:"})," Restoring a backup will overwrite your current data. Make sure you have a backup of your current data before proceeding."]})}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden"},children:e.jsx(lr,{children:e.jsxs(nr,{children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Date & Time"}),e.jsx(ne,{children:"Components"}),e.jsx(ne,{children:"Size"}),e.jsx(ne,{children:"System Info"}),e.jsx(ne,{align:"center",children:"Actions"})]})}),e.jsx(ar,{children:s?e.jsx(ht,{children:e.jsx(ne,{colSpan:5,align:"center",children:e.jsx(it,{})})}):t.length===0?e.jsx(ht,{children:e.jsx(ne,{colSpan:5,align:"center",children:e.jsx(h,{variant:"body2",color:"text.secondary",children:"No backups found. Create your first backup to get started."})})}):t.map(x=>e.jsxs(ht,{hover:!0,children:[e.jsx(ne,{children:e.jsx(h,{variant:"body2",children:N(x.timestamp)})}),e.jsxs(ne,{children:[e.jsxs(k,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[x.components.database&&e.jsx(De,{label:"Database",size:"small",color:"primary"}),x.components.uploads&&e.jsx(De,{label:"Uploads",size:"small",color:"secondary"}),x.components.config&&e.jsx(De,{label:"Config",size:"small",color:"default"})]}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:[g(x)," components available"]})]}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",children:A(x.size)})}),e.jsx(ne,{children:e.jsxs(h,{variant:"caption",color:"text.secondary",children:[x.system_info.platform,"  ",x.system_info.arch]})}),e.jsx(ne,{align:"center",children:e.jsxs(k,{sx:{display:"flex",gap:1,justifyContent:"center"},children:[e.jsx(Vt,{title:"Download Backup",children:e.jsx(gt,{size:"small",onClick:()=>L(x.manifest),children:e.jsx(Fu,{})})}),e.jsx(Vt,{title:"Restore Backup",children:e.jsx(gt,{size:"small",color:"primary",onClick:()=>j(x),children:e.jsx(sc,{})})}),e.jsx(Vt,{title:"Delete Backup",children:e.jsx(gt,{size:"small",color:"error",onClick:()=>f(x.manifest),children:e.jsx(qs,{})})})]})})]},x.manifest))})]})})}),e.jsxs(mt,{open:!!p,onClose:()=>f(null),children:[e.jsx(ft,{children:"Delete Backup"}),e.jsx(xt,{children:e.jsx(h,{children:"Are you sure you want to delete this backup? This action cannot be undone."})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>f(null),children:"Cancel"}),e.jsx(G,{onClick:()=>p&&C(p),color:"error",variant:"contained",children:"Delete"})]})]}),e.jsxs(mt,{open:!!m,onClose:()=>j(null),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(sm,{color:"warning"}),"Restore Backup"]})}),e.jsxs(xt,{children:[e.jsx(We,{severity:"warning",sx:{mb:2},children:e.jsxs(h,{variant:"body2",children:[e.jsx("strong",{children:"Warning:"})," This will overwrite your current data with the backup from"," ",m?N(m.timestamp):"","."]})}),e.jsx(h,{variant:"body2",gutterBottom:!0,children:"Backup components:"}),e.jsxs(k,{sx:{display:"flex",gap:1,mb:2},children:[m?.components.database&&e.jsx(De,{label:"Database",size:"small",color:"primary"}),m?.components.uploads&&e.jsx(De,{label:"Uploads",size:"small",color:"secondary"}),m?.components.config&&e.jsx(De,{label:"Config",size:"small",color:"default"})]}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Make sure you have a backup of your current data before proceeding."})]}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>j(null),children:"Cancel"}),e.jsx(G,{onClick:()=>m&&D(m),color:"warning",variant:"contained",disabled:u===m?.manifest,startIcon:u===m?.manifest?e.jsx(it,{size:20}):e.jsx(sc,{}),children:u===m?.manifest?"Restoring...":"Restore"})]})]}),e.jsx(PS,{open:v,onClose:()=>w(!1),onSettingsSaved:_})]})},ES=()=>{const{user:t}=Zt(),[r,n]=l.useState([]),[a,s]=l.useState([]),[o,i]=l.useState(""),[c,u]=l.useState(!0),[d,p]=l.useState(null),[f,m]=l.useState(!1),[j,v]=l.useState({name:"",email:""}),[w,_]=l.useState(!1),[P,L]=l.useState(null),C=l.useRef(null),D=O=>{C.current&&window.clearTimeout(C.current),L(O),C.current=window.setTimeout(()=>{L(null),C.current=null},2500)};l.useEffect(()=>()=>{C.current&&window.clearTimeout(C.current)},[]),l.useEffect(()=>{A()},[]),l.useEffect(()=>{o?b():s([])},[o]);const A=async()=>{try{u(!0);const O=await Xl();n(O),p(null)}catch(O){p("Failed to fetch data. Please try again."),console.error("Error fetching data:",O)}finally{u(!1)}},b=async()=>{if(o)try{const O=await pS(o);s(O);const ee=new Date;ee.setDate(ee.getDate()-1);const J=O.find(z=>!z.clock_out&&new Date(z.clock_in).toDateString()!==new Date().toDateString());_(!!J)}catch(O){p("Failed to fetch shifts. Please try again."),console.error("Error fetching shifts:",O)}},N=async()=>{if(!o){p("Please select a profile");return}if(a.some(O=>!O.clock_out)){p("You are already clocked in. Please clock out first.");return}try{const O=await hS(o);s([O,...a]),p(null),i(""),s([]),D("Successfully clocked in.")}catch(O){p("Failed to clock in. Please try again."),console.error("Error clocking in:",O)}},g=async O=>{try{const ee=await mS(O);s(a.map(J=>J.id===O?ee:J)),p(null),i(""),s([]),D("Successfully clocked out.")}catch(ee){p("Failed to clock out. Please try again."),console.error("Error clocking out:",ee)}},x=async()=>{try{const O=await Qw(j.name,j.email);n([...r,O]),m(!1),v({name:"",email:""}),p(null)}catch(O){p("Failed to create profile. Please try again."),console.error("Error creating profile:",O)}},R=o&&a.some(O=>O.profile_id===o&&!O.clock_out);return c?e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(it,{})}):e.jsxs(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Attendance (Shift Tracking)"}),d&&e.jsx(We,{severity:"error",sx:{mb:2},children:d}),w&&e.jsx(We,{severity:"warning",sx:{mb:2},children:"You have an unclosed shift from a previous day. Please clock out before starting a new shift."}),e.jsxs(mt,{open:!!P,onClose:()=>L(null),PaperProps:{sx:{px:6,py:4,textAlign:"center"}},children:[e.jsx(ft,{sx:{fontSize:"2rem"},children:"Success"}),e.jsx(xt,{children:e.jsx(h,{variant:"h4",component:"p",children:P})})]}),e.jsxs(M,{container:!0,spacing:3,children:[e.jsx(M,{item:!0,xs:12,md:6,children:e.jsxs(Ae,{sx:{p:2},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsx(h,{variant:"h6",children:"Profile"}),t?.access_role!=="Time Tracking"&&e.jsx(G,{startIcon:e.jsx(ci,{}),onClick:()=>m(!0),children:"Add Profile"})]}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Select Profile"}),e.jsx(Wt,{value:o,label:"Select Profile",onChange:O=>i(O.target.value),sx:{"& .MuiSelect-select":{fontSize:"1.1rem"}},renderValue:O=>{const ee=r.find(J=>J.id===O);return ee?ee.name:""},children:r.map(O=>e.jsxs(et,{value:O.id,sx:{fontSize:"1.1rem",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:O.name}),t?.access_role==="Admin"&&e.jsx(gt,{"aria-label":`Delete ${O.name}`,size:"small",edge:"end",onClick:async ee=>{if(ee.preventDefault(),ee.stopPropagation(),!!window.confirm(`Delete profile "${O.name}"? This cannot be undone.`))try{await B.delete(`/api/time-tracking/profiles/${O.id}`),n(z=>z.filter(Z=>Z.id!==O.id)),o===O.id&&i(""),H.success("Profile deleted")}catch(z){const Z=z?.response?.data?.error||"Failed to delete profile";H.error(Z)}},sx:{ml:2,color:"error.main"},children:e.jsx(qs,{fontSize:"small"})})]},O.id))})]})]})}),o&&!R&&e.jsx(M,{item:!0,xs:12,children:e.jsx(Ae,{sx:{p:2},children:e.jsx(k,{display:"flex",justifyContent:"center",gap:2,children:e.jsx(G,{variant:"contained",sx:{backgroundColor:"green","&:hover":{backgroundColor:"darkgreen"}},onClick:N,children:"Clock In"})})})}),o&&e.jsx(M,{item:!0,xs:12,children:e.jsxs(Ae,{sx:{p:2},children:[e.jsx(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:e.jsxs(h,{variant:"h6",gutterBottom:!0,children:["Shift History for ",r.find(O=>O.id===o)?.name]})}),e.jsx(lr,{children:e.jsxs(nr,{children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Clock In"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Clock Out"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Duration"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:"Actions"})]})}),e.jsx(ar,{children:a.map(O=>{const ee=new Date(O.clock_in),J=O.clock_out?new Date(O.clock_out):null,z=O.duration!==null&&O.duration!==void 0?Number(O.duration):null;return e.jsxs(ht,{children:[e.jsx(ne,{sx:{fontSize:"1.1rem"},children:ee.toLocaleString()}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:J?J.toLocaleString():"-"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:z!==null?`${z.toFixed(2)} hrs`:"-"}),e.jsx(ne,{sx:{fontSize:"1.1rem"},children:!O.clock_out&&e.jsx(G,{variant:"contained",sx:{backgroundColor:"red","&:hover":{backgroundColor:"darkred"}},onClick:()=>g(O.id),children:"Clock Out"})})]},O.id)})})]})})]})})]}),e.jsxs(mt,{open:f,onClose:()=>m(!1),children:[e.jsx(ft,{children:"Add Profile"}),e.jsxs(xt,{children:[e.jsx(le,{label:"Name",value:j.name,onChange:O=>v({...j,name:O.target.value}),fullWidth:!0,sx:{mb:2}}),e.jsx(le,{label:"Email",value:j.email,onChange:O=>v({...j,email:O.target.value}),fullWidth:!0})]}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>m(!1),children:"Cancel"}),e.jsx(G,{onClick:x,variant:"contained",children:"Save"})]})]})]})};var za={},fu;function IS(){if(fu)return za;fu=1;var t=yt();Object.defineProperty(za,"__esModule",{value:!0}),za.default=void 0;var r=t(bt()),n=vt();return za.default=(0,r.default)((0,n.jsx)("path",{d:"M4 10h3v7H4zm6.5 0h3v7h-3zM2 19h20v3H2zm15-9h3v7h-3zm-5-9L2 6v2h20V6z"}),"AccountBalance"),za}var TS=IS();const Ol=st(TS),OS=()=>{const t=Kt(),[r,n]=l.useState(!0),[a,s]=l.useState(!1),[o,i]=l.useState([]),[c,u]=l.useState({}),[d,p]=l.useState(null),[f,m]=l.useState(null),[j,v]=l.useState(""),[w,_]=l.useState(""),[P,L]=l.useState(""),[C,D]=l.useState(""),[A,b]=l.useState(""),[N,g]=l.useState(""),[x,R]=l.useState(""),[O,ee]=l.useState(""),[J,z]=l.useState(""),[Z,Q]=l.useState(""),[X,I]=l.useState(""),[y,S]=l.useState(""),[U,K]=l.useState(!1),[E,V]=l.useState(""),[q,ue]=l.useState("");l.useEffect(()=>{ge()},[]);const ye=()=>{const $=`${Is().baseURL}/api/qbo/auth`;window.location.href=$},ge=async()=>{n(!0);try{const T=await B.get("/api/qbo-accounts/test-connection");if(m(T.data),T.data.connected){const $=await B.get("/api/qbo-accounts/accounts");i($.data.accounts),u($.data.accountTypes);const ce=await B.get("/api/qbo-accounts/mapping");ce.data.mapping&&(p(ce.data.mapping),v(ce.data.mapping.qbo_inventory_account_id),_(ce.data.mapping.qbo_gst_account_id),L(ce.data.mapping.qbo_ap_account_id),D(ce.data.mapping.qbo_supply_expense_account_id||""),b(ce.data.mapping.qbo_sales_account_id||""),g(ce.data.mapping.qbo_labour_sales_account_id||""),R(ce.data.mapping.qbo_ar_account_id||""),ee(ce.data.mapping.qbo_cogs_account_id||""),z(ce.data.mapping.qbo_cost_of_labour_account_id||""),Q(ce.data.mapping.qbo_cost_of_materials_account_id||""),I(ce.data.mapping.qbo_labour_expense_reduction_account_id||""),S(ce.data.mapping.qbo_overhead_cogs_account_id||""))}}catch(T){console.error("Error loading QBO data:",T),H.error("Failed to load QuickBooks data")}finally{n(!1)}},xe=async()=>{if(!j||!w||!P){H.error("Please select all required accounts");return}s(!0);try{const T=await B.post("/api/qbo-accounts/mapping",{qbo_inventory_account_id:j,qbo_gst_account_id:w,qbo_ap_account_id:P,qbo_supply_expense_account_id:C,qbo_sales_account_id:A,qbo_labour_sales_account_id:N,qbo_ar_account_id:x,qbo_cogs_account_id:O,qbo_cost_of_labour_account_id:J,qbo_cost_of_materials_account_id:Z,qbo_labour_expense_reduction_account_id:X,qbo_overhead_cogs_account_id:y});p(T.data.mapping),H.success("Account mapping saved successfully")}catch(T){console.error("Error saving mapping:",T),H.error("Failed to save account mapping")}finally{s(!1)}},me=T=>{const $=T.AccountNumber?`#${T.AccountNumber}`:"";return`${T.Name} ${$} (${T.AccountType})`},he=T=>{let $=o.filter(ce=>ce.Classification===T);if(q){const ce=q.toLowerCase();$=$.filter(re=>re.Name.toLowerCase().includes(ce)||re.AccountNumber&&re.AccountNumber.includes(ce)||re.Description&&re.Description.toLowerCase().includes(ce))}return $},ae=()=>e.jsxs(mt,{open:U,onClose:()=>K(!1),maxWidth:"md",fullWidth:!0,children:[e.jsxs(ft,{children:["QuickBooks Accounts - ",E]}),e.jsx(xt,{children:e.jsx(k,{sx:{mt:2},children:c[E]?.map(T=>e.jsx(kt,{sx:{mb:1,p:2},children:e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"flex-start",children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h6",children:T.Name}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Type: ",T.AccountType," | Subtype: ",T.AccountSubType]}),T.AccountNumber&&e.jsxs(h,{variant:"body2",color:"primary",fontWeight:500,children:["Account #: ",T.AccountNumber]}),T.Description&&e.jsx(h,{variant:"body2",color:"text.secondary",children:T.Description})]}),e.jsx(De,{label:T.AccountNumber||"No Number",size:"small",color:T.AccountNumber?"primary":"default",variant:"outlined"})]})},T.Id))})}),e.jsx(_t,{children:e.jsx(G,{onClick:()=>K(!1),children:"Close"})})]});return r?e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(it,{})}):e.jsxs(at,{maxWidth:"lg",sx:{py:4},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(k,{display:"flex",alignItems:"center",children:[e.jsx(G,{startIcon:e.jsx(po,{}),onClick:()=>t("/business-profile"),sx:{mr:2},children:"Back"}),e.jsx(h,{variant:"h4",component:"h1",children:"QuickBooks Account Mapping"})]}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(Ol,{}),onClick:ye,sx:{borderRadius:2,fontWeight:600},children:"Connect to QuickBooks"})]}),f&&e.jsx(kt,{sx:{mb:3},children:e.jsxs(Tt,{children:[e.jsxs(k,{display:"flex",alignItems:"center",gap:2,children:[f.connected?e.jsx(qn,{color:"success"}):e.jsx(Ti,{color:"error"}),e.jsx(h,{variant:"h6",children:f.connected?"Connected to QuickBooks":"Not Connected"})]}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mt:1},children:f.message}),f.connected&&f.realmId&&e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Realm ID: ",f.realmId]})]})}),f?.connected?e.jsxs(e.Fragment,{children:[e.jsx(M,{container:!0,spacing:3,sx:{mb:3},children:Object.entries(c).map(([T,$])=>e.jsx(M,{item:!0,xs:12,sm:6,md:4,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:T}),e.jsx(h,{variant:"h4",color:"primary",children:$.length}),e.jsx(G,{size:"small",onClick:()=>{V(T),K(!0)},sx:{mt:1},children:"View Accounts"})]})})},T))}),e.jsxs(Ae,{sx:{p:3},children:[e.jsx(h,{variant:"h5",gutterBottom:!0,children:"Map QuickBooks Accounts"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Select the QuickBooks accounts that correspond to your business accounts. Different companies use different account names, so choose the accounts that make sense for your business."}),e.jsxs(We,{severity:"info",sx:{mb:3},children:[e.jsxs(h,{variant:"body2",children:[e.jsx("strong",{children:"How this works:"})," Configure your QuickBooks accounts to map to your business transactions. Accounts used by both purchase orders and sales orders are shown at the top."]}),e.jsxs(h,{variant:"body2",sx:{mt:1},children:[e.jsx("strong",{children:"Purchase Orders:"})," Stock items  Inventory Account, Supply items  Supply Expense Account, GST  GST Account, Total  Accounts Payable."]}),e.jsxs(h,{variant:"body2",sx:{mt:1},children:[e.jsx("strong",{children:"Sales Orders:"})," Materials  Sales Account, Labour  Labour Sales Account, GST  GST Account, Total  Accounts Receivable, Costs  COGS Account."]})]}),e.jsx(k,{sx:{mb:3},children:e.jsx(le,{fullWidth:!0,label:"Search accounts by name, number, or description",value:q,onChange:T=>ue(T.target.value),placeholder:"e.g., 1200, Inventory, GST...",size:"small",InputProps:{startAdornment:e.jsx(Br,{sx:{mr:1,color:"text.secondary"}})}})}),e.jsx(h,{variant:"h6",sx:{mt:4,mb:2,color:"primary.main"},children:"Shared Accounts (Purchase Orders & Sales Orders)"}),e.jsxs(M,{container:!0,spacing:3,children:[e.jsxs(M,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"GST/Tax Account"}),e.jsx(Wt,{value:w,onChange:T=>_(T.target.value),label:"GST/Tax Account",children:he("Liability").map(T=>e.jsx(et,{value:T.Id,children:me(T)},T.Id))})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Account for GST/HST/tax tracking (used by both purchase orders and sales orders)"})]}),e.jsxs(M,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Inventory Account"}),e.jsx(Wt,{value:j,onChange:T=>v(T.target.value),label:"Inventory Account",children:he("Asset").map(T=>e.jsx(et,{value:T.Id,children:me(T)},T.Id))})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Account for tracking inventory (stock purchases and sales cost reduction)"})]})]}),e.jsx(h,{variant:"h6",sx:{mt:4,mb:2},children:"Purchase Order Account Mapping"}),e.jsxs(M,{container:!0,spacing:3,children:[e.jsxs(M,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Supply Expense Account"}),e.jsxs(Wt,{value:C,onChange:T=>D(T.target.value),label:"Supply Expense Account",children:[e.jsx(et,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),he("Expense").map(T=>e.jsx(et,{value:T.Id,children:me(T)},T.Id))]})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Account for supply items (e.g., Office Supplies, Tools, etc.) - Optional"})]}),e.jsxs(M,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Accounts Payable"}),e.jsx(Wt,{value:P,onChange:T=>L(T.target.value),label:"Accounts Payable",children:he("Liability").map(T=>e.jsx(et,{value:T.Id,children:me(T)},T.Id))})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:'Account for tracking vendor payables (usually "Accounts Payable")'})]})]}),e.jsx(h,{variant:"h6",sx:{mt:4,mb:2},children:"Sales Order Account Mapping"}),e.jsxs(M,{container:!0,spacing:3,children:[e.jsxs(M,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Sales Account"}),e.jsx(Wt,{value:A,onChange:T=>b(T.target.value),label:"Sales Account",children:he("Revenue").map(T=>e.jsx(et,{value:T.Id,children:me(T)},T.Id))})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Revenue account for sales (e.g., Sales, Revenue, etc.) - Used for invoice creation"})]}),e.jsxs(M,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Accounts Receivable"}),e.jsx(Wt,{value:x,onChange:T=>R(T.target.value),label:"Accounts Receivable",children:he("Asset").map(T=>e.jsx(et,{value:T.Id,children:me(T)},T.Id))})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:'Account for tracking customer receivables (usually "Accounts Receivable") - Used for invoice total amount'})]})]}),e.jsx(h,{variant:"h6",sx:{mt:4,mb:2},children:"Cost Accounts (Journal Entries)"}),e.jsxs(M,{container:!0,spacing:3,children:[e.jsxs(M,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Cost of Materials"}),e.jsxs(Wt,{value:Z,onChange:T=>Q(T.target.value),label:"Cost of Materials",children:[e.jsx(et,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),he("Expense").map(T=>e.jsx(et,{value:T.Id,children:me(T)},T.Id))]})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Expense account for tracking cost of materials sold - Used for COGS journal entries - Optional"})]}),e.jsxs(M,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Cost of Labour"}),e.jsxs(Wt,{value:J,onChange:T=>z(T.target.value),label:"Cost of Labour",children:[e.jsx(et,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),he("Expense").map(T=>e.jsx(et,{value:T.Id,children:me(T)},T.Id))]})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Expense account for tracking cost of labour sold - Used for COGS journal entries - Optional"})]}),e.jsxs(M,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Labour Expense Reduction Account"}),e.jsxs(Wt,{value:X,onChange:T=>I(T.target.value),label:"Labour Expense Reduction Account",children:[e.jsx(et,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),he("Expense").map(T=>e.jsx(et,{value:T.Id,children:me(T)},T.Id))]})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Expense account for reducing labour costs when sold (e.g., Labour Expense, Wages Expense) - Used for COGS journal entries - Optional"})]}),e.jsxs(M,{item:!0,xs:12,md:6,children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Overhead COGS Account"}),e.jsxs(Wt,{value:y,onChange:T=>S(T.target.value),label:"Overhead COGS Account",children:[e.jsx(et,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),he("Expense").map(T=>e.jsx(et,{value:T.Id,children:me(T)},T.Id))]})]}),e.jsx(h,{variant:"caption",color:"text.secondary",children:"Expense account for tracking overhead costs when sold - Used for COGS journal entries - Optional"})]})]}),e.jsx(k,{sx:{mt:3,display:"flex",justifyContent:"center"},children:e.jsx(G,{variant:"outlined",onClick:()=>t("/overhead-management"),sx:{width:"100%",maxWidth:"600px",borderRadius:2,fontWeight:600,py:1.5,fontSize:"1.1rem"},children:"Manage Overhead Settings"})}),e.jsxs(k,{sx:{mt:3,display:"flex",gap:2},children:[e.jsx(G,{variant:"contained",startIcon:e.jsx(as,{}),onClick:xe,disabled:a||!j||!w||!P,children:a?"Saving...":"Save Mapping"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(jn,{}),onClick:ge,disabled:r,children:"Refresh"})]}),d&&e.jsxs(k,{sx:{mt:3,p:2,bgcolor:"grey.50",borderRadius:1},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Current Mapping"}),e.jsx(h,{variant:"subtitle2",color:"primary",sx:{mt:2,mb:1},children:"Shared Accounts (Purchase Orders & Sales Orders)"}),e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["GST/Tax: ",(()=>{const T=o.find($=>$.Id===d.qbo_gst_account_id);return T?`${T.Name}${T.AccountNumber?` (#${T.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(M,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Inventory: ",(()=>{const T=o.find($=>$.Id===d.qbo_inventory_account_id);return T?`${T.Name}${T.AccountNumber?` (#${T.AccountNumber})`:""}`:"Not configured"})()]})})]}),e.jsx(h,{variant:"subtitle2",color:"primary",sx:{mt:2,mb:1},children:"Purchase Order Accounts"}),e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Supply Expense: ",(()=>{const T=o.find($=>$.Id===d.qbo_supply_expense_account_id);return T?`${T.Name}${T.AccountNumber?` (#${T.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(M,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Accounts Payable: ",(()=>{const T=o.find($=>$.Id===d.qbo_ap_account_id);return T?`${T.Name}${T.AccountNumber?` (#${T.AccountNumber})`:""}`:"Not configured"})()]})})]}),e.jsx(h,{variant:"subtitle2",color:"primary",sx:{mt:2,mb:1},children:"Sales Order Accounts"}),e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Sales: ",(()=>{const T=o.find($=>$.Id===d.qbo_sales_account_id);return T?`${T.Name}${T.AccountNumber?` (#${T.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(M,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Accounts Receivable: ",(()=>{const T=o.find($=>$.Id===d.qbo_ar_account_id);return T?`${T.Name}${T.AccountNumber?` (#${T.AccountNumber})`:""}`:"Not configured"})()]})})]}),e.jsx(h,{variant:"subtitle2",color:"primary",sx:{mt:2,mb:1},children:"Cost Accounts"}),e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Cost of Materials: ",(()=>{const T=o.find($=>$.Id===d.qbo_cost_of_materials_account_id);return T?`${T.Name}${T.AccountNumber?` (#${T.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(M,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Cost of Labour: ",(()=>{const T=o.find($=>$.Id===d.qbo_cost_of_labour_account_id);return T?`${T.Name}${T.AccountNumber?` (#${T.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(M,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Labour Expense Reduction: ",(()=>{const T=o.find($=>$.Id===d.qbo_labour_expense_reduction_account_id);return T?`${T.Name}${T.AccountNumber?` (#${T.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(M,{item:!0,xs:12,md:6,children:e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Overhead COGS: ",(()=>{const T=o.find($=>$.Id===d.qbo_overhead_cogs_account_id);return T?`${T.Name}${T.AccountNumber?` (#${T.AccountNumber})`:""}`:"Not configured"})()]})})]})]})]})]}):e.jsx(We,{severity:"warning",sx:{mb:3},children:"Please connect your QuickBooks account first in the Business Profile page."}),ae()]})},AS=()=>{const t=Kt(),[r,n]=l.useState(!0),[a,s]=l.useState(!1),[o,i]=l.useState([]),[c,u]=l.useState({}),[d,p]=l.useState([]),[f,m]=l.useState(null),[j,v]=l.useState(!1),[w,_]=l.useState(""),[P,L]=l.useState(""),[C,D]=l.useState(!1),[A,b]=l.useState(null),[N,g]=l.useState({expense_account_id:"",percentage:"",description:""});l.useEffect(()=>{x()},[]);const x=async()=>{n(!0);try{const[I,y]=await Promise.all([B.get("/api/qbo-accounts/accounts"),B.get("/api/overhead/distribution")]);i(I.data.accounts||[]),u(I.data.accountTypes||{}),p(y.data||[]),m({connected:!0,message:"Connected to QuickBooks"})}catch(I){console.error("Error loading data:",I),m({connected:!1,message:I.response?.data?.error||"Failed to connect to QuickBooks"}),H.error("Failed to load overhead management data")}finally{n(!1)}},R=async()=>{if(!N.expense_account_id||!N.percentage){H.error("Please fill in all required fields");return}const I=parseFloat(N.percentage);if(isNaN(I)||I<=0||I>100){H.error("Percentage must be between 0 and 100");return}const y=d.filter(S=>S.id!==A?.id).reduce((S,U)=>S+U.percentage,0);if(y+I>100){H.error(`Total percentage would exceed 100%. Current total: ${y}%, adding: ${I}%`);return}s(!0);try{A?(await B.put(`/api/overhead/distribution/${A.id}`,{expense_account_id:N.expense_account_id,percentage:I,description:N.description}),H.success("Distribution updated successfully")):(await B.post("/api/overhead/distribution",{expense_account_id:N.expense_account_id,percentage:I,description:N.description}),H.success("Distribution added successfully")),D(!1),b(null),g({expense_account_id:"",percentage:"",description:""}),x()}catch(S){console.error("Error saving distribution:",S),H.error(S.response?.data?.error||"Failed to save distribution")}finally{s(!1)}},O=I=>{b(I),g({expense_account_id:I.expense_account_id,percentage:I.percentage.toString(),description:I.description}),D(!0)},ee=async I=>{if(window.confirm("Are you sure you want to delete this distribution?"))try{await B.delete(`/api/overhead/distribution/${I}`),H.success("Distribution deleted successfully"),x()}catch(y){console.error("Error deleting distribution:",y),H.error(y.response?.data?.error||"Failed to delete distribution")}},J=()=>{b(null),g({expense_account_id:"",percentage:"",description:""}),D(!0)},z=I=>`${I.Name} (${I.AccountType})`,Z=I=>(c[I]||[]).filter(y=>y.Classification===I).map(y=>({label:z(y),value:y.Id,account:y})),Q=()=>e.jsxs(mt,{open:j,onClose:()=>v(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:e.jsxs(k,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(Ol,{}),"QuickBooks Accounts"]})}),e.jsxs(xt,{children:[e.jsx(k,{mb:2,children:e.jsx(le,{fullWidth:!0,label:"Search accounts",value:P,onChange:I=>L(I.target.value),InputProps:{startAdornment:e.jsx(Br,{})}})}),e.jsxs(Mt,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Ut,{children:"Account Type"}),e.jsxs(Wt,{value:w,onChange:I=>_(I.target.value),label:"Account Type",children:[e.jsx(et,{value:"",children:"All Types"}),e.jsx(et,{value:"Asset",children:"Asset"}),e.jsx(et,{value:"Liability",children:"Liability"}),e.jsx(et,{value:"Equity",children:"Equity"}),e.jsx(et,{value:"Revenue",children:"Revenue"}),e.jsx(et,{value:"Expense",children:"Expense"})]})]}),e.jsx(k,{maxHeight:400,overflow:"auto",children:Object.entries(c).map(([I,y])=>{if(w&&I!==w)return null;const S=y.filter(U=>U.Name.toLowerCase().includes(P.toLowerCase())||U.AccountType.toLowerCase().includes(P.toLowerCase()));return S.length===0?null:e.jsxs(k,{mb:3,children:[e.jsxs(h,{variant:"h6",gutterBottom:!0,children:[I," Accounts (",S.length,")"]}),e.jsx(M,{container:!0,spacing:1,children:S.map(U=>e.jsx(M,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(kt,{variant:"outlined",sx:{p:1},children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:U.Name}),e.jsx(h,{variant:"caption",color:"textSecondary",children:U.AccountType}),U.AccountNumber&&e.jsxs(h,{variant:"caption",display:"block",color:"textSecondary",children:["#",U.AccountNumber]})]})},U.Id))})]},I)})})]}),e.jsx(_t,{children:e.jsx(G,{onClick:()=>v(!1),children:"Close"})})]}),X=d.reduce((I,y)=>I+y.percentage,0);return e.jsxs(at,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(gt,{onClick:()=>t(-1),children:e.jsx(po,{})}),e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Overhead Management"})]}),e.jsxs(ke,{direction:"row",spacing:2,children:[e.jsx(G,{variant:"outlined",onClick:()=>v(!0),startIcon:e.jsx(Ol,{}),children:"View QBO Accounts"}),e.jsx(G,{variant:"contained",onClick:J,startIcon:e.jsx(Lr,{}),children:"Add Distribution"}),e.jsx(G,{variant:"outlined",onClick:x,startIcon:e.jsx(jn,{}),children:"Refresh"})]})]}),f&&e.jsx(We,{severity:f.connected?"success":"error",icon:f.connected?e.jsx(qn,{}):e.jsx(Ti,{}),sx:{mb:3},children:f.message}),e.jsxs(Ae,{sx:{p:3,mb:3},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Distribution Summary"}),e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Total Distributions"}),e.jsx(h,{variant:"h4",children:d.length})]})})}),e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Total Percentage"}),e.jsxs(h,{variant:"h4",color:X===100?"success.main":"warning.main",children:[X.toFixed(1),"%"]})]})})}),e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Remaining"}),e.jsxs(h,{variant:"h4",color:X>100?"error.main":"text.primary",children:[(100-X).toFixed(1),"%"]})]})})}),e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Status"}),e.jsx(De,{label:X===100?"Complete":X>100?"Over 100%":"Incomplete",color:X===100?"success":X>100?"error":"warning"})]})})})]})]}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden"},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Expense Distributions"}),r?e.jsx(k,{display:"flex",justifyContent:"center",p:3,children:e.jsx(it,{})}):d.length===0?e.jsx(We,{severity:"info",children:'No expense distributions configured. Click "Add Distribution" to get started.'}):e.jsx(M,{container:!0,spacing:2,children:d.map(I=>{const y=o.find(S=>S.Id===I.expense_account_id);return e.jsx(M,{item:!0,xs:12,sm:6,md:4,children:e.jsx(kt,{children:e.jsx(Tt,{children:e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"flex-start",children:[e.jsxs(k,{flex:1,children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:I.description||y?.Name||"Unknown Account"}),e.jsxs(h,{variant:"body2",color:"textSecondary",gutterBottom:!0,children:[y?.Name," (",y?.AccountType,")"]}),e.jsx(De,{label:`${I.percentage}%`,color:"primary",size:"small"})]}),e.jsxs(k,{children:[e.jsx(gt,{size:"small",onClick:()=>O(I),children:e.jsx(As,{})}),e.jsx(gt,{size:"small",color:"error",onClick:()=>ee(I.id),children:e.jsx(gr,{})})]})]})})})},I.id)})})]})}),e.jsxs(mt,{open:C,onClose:()=>D(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:A?"Edit Distribution":"Add Distribution"}),e.jsx(xt,{children:e.jsxs(ke,{spacing:3,sx:{mt:1},children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Expense Account"}),e.jsx(Wt,{value:N.expense_account_id,onChange:I=>g(y=>({...y,expense_account_id:I.target.value})),label:"Expense Account",children:Z("Expense").map(I=>e.jsx(et,{value:I.value,children:I.label},I.value))})]}),e.jsx(le,{label:"Percentage",type:"number",value:N.percentage,onChange:I=>g(y=>({...y,percentage:I.target.value})),inputProps:{min:0,max:100,step:.01},helperText:`Current total: ${X}%${A?` (excluding this item: ${(X-A.percentage).toFixed(1)}%)`:""}`}),e.jsx(le,{label:"Description (Optional)",value:N.description,onChange:I=>g(y=>({...y,description:I.target.value})),helperText:"A description to help identify this distribution"})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>D(!1),children:"Cancel"}),e.jsx(G,{onClick:R,variant:"contained",disabled:a||!N.expense_account_id||!N.percentage,startIcon:a?e.jsx(it,{size:20}):e.jsx(as,{}),children:a?"Saving...":"Save"})]})]}),Q()]})},MS=()=>{const[t,r]=l.useState(!1),[n,a]=l.useState(!1),[s,o]=l.useState([]),[i,c]=l.useState(new Set),[u,d]=l.useState(new Set),[p,f]=l.useState(!1),[m,j]=l.useState([]),v=Kt();l.useEffect(()=>{w();const x=()=>{console.log(" Parts to order update event received, refreshing data..."),w()};return window.addEventListener("parts-to-order-updated",x),()=>{window.removeEventListener("parts-to-order-updated",x)}},[]);const w=async()=>{r(!0);try{const x=await B.get("/api/sales-orders/parts-to-order/all"),{individualParts:R,aggregatedParts:O}=x.data;if(O&&O.length>0)o(O);else{const ee=_(R);o(ee)}}catch(x){console.error("Error fetching parts to order:",x),H.error("Failed to load parts to order data")}finally{r(!1)}},_=x=>{const R={};return x.forEach(O=>{R[O.part_number]||(R[O.part_number]={part_number:O.part_number,part_description:O.part_description,total_quantity_needed:0,unit:O.unit,unit_price:O.unit_price,total_line_amount:0,sales_orders:[]}),R[O.part_number].total_quantity_needed+=O.quantity_needed,R[O.part_number].total_line_amount+=O.line_amount,R[O.part_number].sales_orders.push(O)}),Object.values(R)},P=x=>{const R=new Set(i);R.has(x)?R.delete(x):R.add(x),c(R)},L=()=>{w()},C=x=>{d(R=>{const O=new Set(R);return O.has(x)?O.delete(x):O.add(x),O})},D=()=>{u.size===s.length?d(new Set):d(new Set(s.map(x=>x.part_number)))},A=()=>{if(u.size===0){H.warning("Please select at least one part to create a purchase order");return}const x=s.filter(R=>u.has(R.part_number));j(x),f(!0)},b=()=>{f(!1),j([])},N=async()=>{if(m.length===0){H.warning("No parts selected for purchase order");return}a(!0);try{const x=await B.post("/api/purchase-orders/auto-create-from-parts-to-order",{parts:m});if(x.data.success)if(H.success(`Purchase order created successfully! PO Number: ${x.data.purchase_order_number}`),x.data.purchase_orders&&x.data.purchase_orders.length===1){const R=x.data.purchase_orders[0].purchase_id;b(),d(new Set),v(`/open-purchase-orders/${R}`)}else b(),d(new Set),w();else H.error(x.data.message||"Failed to create purchase order")}catch(x){console.error("Error creating purchase order:",x),H.error(x.response?.data?.error||"Failed to create purchase order")}finally{a(!1)}},g=async x=>{let R=s;if(x){const O=s.find(ee=>ee.part_number===x);if(!O){H.warning(`Part ${x} not found for purchase order creation.`);return}R=[O]}if(R.length===0){H.warning("No parts to order");return}a(!0);try{const O=await B.post("/api/purchase-orders/auto-create-from-parts-to-order",{parts:R});if(O.data.success)if(H.success(`Purchase order created successfully! PO Number: ${O.data.purchase_order_number}`),O.data.purchase_orders&&O.data.purchase_orders.length===1){const ee=O.data.purchase_orders[0].purchase_id;v(`/open-purchase-orders/${ee}`)}else w();else H.error(O.data.message||"Failed to create purchase order")}catch(O){console.error("Error creating purchase order:",O),H.error(O.response?.data?.error||"Failed to create purchase order")}finally{a(!1)}};return t?e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(it,{})}):e.jsxs(k,{p:3,children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsx(h,{variant:"h3",component:"h1",children:"Parts to Order"}),e.jsxs(k,{display:"flex",gap:2,children:[u.size>0&&e.jsxs(G,{variant:"contained",color:"primary",startIcon:e.jsx(am,{}),onClick:A,disabled:n,children:["Create PO (",u.size,")"]}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(Ll,{}),onClick:L,children:"Refresh"})]})]}),s.length===0?e.jsx(We,{severity:"info",children:"No parts currently need to be ordered."}):e.jsx(lr,{component:Ae,children:e.jsxs(nr,{size:"medium",children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{padding:"checkbox",children:e.jsx(on,{indeterminate:u.size>0&&u.size<s.length,checked:s.length>0&&u.size===s.length,onChange:D})}),e.jsx(ne,{children:e.jsx(h,{variant:"h6",fontWeight:"bold"})}),e.jsx(ne,{children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Part Number"})}),e.jsx(ne,{children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Description"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Quantity to Order"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Unit"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Unit Price"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Total Amount"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"h6",fontWeight:"bold",children:"Actions"})})]})}),e.jsx(ar,{children:s.map(x=>e.jsxs(It.Fragment,{children:[e.jsxs(ht,{children:[e.jsx(ne,{padding:"checkbox",children:e.jsx(on,{checked:u.has(x.part_number),onChange:()=>C(x.part_number)})}),e.jsx(ne,{children:e.jsx(gt,{size:"small",onClick:()=>P(x.part_number),children:i.has(x.part_number)?e.jsx(om,{}):e.jsx(Hu,{})})}),e.jsx(ne,{children:e.jsx(h,{variant:"body1",fontWeight:"medium",fontSize:"1.1rem",children:x.part_number})}),e.jsx(ne,{children:e.jsx(h,{variant:"body1",fontSize:"1.1rem",children:x.part_description})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body1",fontWeight:"medium",fontSize:"1.1rem",children:Number(x.total_quantity_needed)||0})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body1",fontSize:"1.1rem",children:x.unit})}),e.jsx(ne,{align:"center",children:e.jsxs(h,{variant:"body1",fontSize:"1.1rem",children:["$",(Number(x.unit_price)||0).toFixed(2)]})}),e.jsx(ne,{align:"center",children:e.jsxs(h,{variant:"body1",fontSize:"1.1rem",children:["$",(Number(x.total_line_amount)||0).toFixed(2)]})}),e.jsx(ne,{align:"center",children:e.jsx(G,{variant:"contained",color:"primary",size:"medium",startIcon:e.jsx(ac,{}),onClick:()=>g(x.part_number),disabled:n,children:"Create PO"})})]}),e.jsx(ht,{children:e.jsx(ne,{style:{paddingBottom:0,paddingTop:0},colSpan:9,children:e.jsx($u,{in:i.has(x.part_number),timeout:"auto",unmountOnExit:!0,children:e.jsxs(k,{sx:{margin:1},children:[e.jsx(h,{variant:"h5",gutterBottom:!0,component:"div",children:"Sales Orders Requiring This Part"}),e.jsxs(nr,{size:"medium",children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:e.jsx(h,{variant:"subtitle1",fontWeight:"bold",children:"Sales Order"})}),e.jsx(ne,{children:e.jsx(h,{variant:"subtitle1",fontWeight:"bold",children:"Customer"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"subtitle1",fontWeight:"bold",children:"Quantity to Order"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"subtitle1",fontWeight:"bold",children:"Unit Price"})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"subtitle1",fontWeight:"bold",children:"Line Amount"})})]})}),e.jsx(ar,{children:x.sales_orders.map(R=>e.jsxs(ht,{children:[e.jsx(ne,{children:e.jsx(h,{variant:"body1",fontSize:"1rem",children:R.sales_order_number})}),e.jsx(ne,{children:e.jsx(h,{variant:"body1",fontSize:"1rem",children:R.customer_name})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body1",fontSize:"1rem",children:Number(R.quantity_needed)||0})}),e.jsx(ne,{align:"center",children:e.jsxs(h,{variant:"body1",fontSize:"1rem",children:["$",(Number(R.unit_price)||0).toFixed(2)]})}),e.jsx(ne,{align:"center",children:e.jsxs(h,{variant:"body1",fontSize:"1rem",children:["$",(Number(R.line_amount)||0).toFixed(2)]})})]},`${R.sales_order_id}-${R.part_number}`))})]})]})})})})]},x.part_number))})]})}),e.jsxs(mt,{open:p,onClose:b,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:"Create Purchase Order"}),e.jsxs(xt,{children:[e.jsx(h,{variant:"body1",sx:{mb:2},children:"Selected parts for purchase order:"}),e.jsx(lr,{component:Ae,variant:"outlined",children:e.jsxs(nr,{size:"small",children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Part Number"}),e.jsx(ne,{children:"Description"}),e.jsx(ne,{align:"center",children:"Quantity"}),e.jsx(ne,{align:"center",children:"Unit"}),e.jsx(ne,{align:"center",children:"Unit Price"}),e.jsx(ne,{align:"center",children:"Total"})]})}),e.jsx(ar,{children:m.map(x=>e.jsxs(ht,{children:[e.jsx(ne,{children:e.jsx(h,{variant:"body2",fontWeight:"medium",children:x.part_number})}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",children:x.part_description})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",children:Number(x.total_quantity_needed)||0})}),e.jsx(ne,{align:"center",children:e.jsx(h,{variant:"body2",children:x.unit})}),e.jsx(ne,{align:"center",children:e.jsxs(h,{variant:"body2",children:["$",(Number(x.unit_price)||0).toFixed(2)]})}),e.jsx(ne,{align:"center",children:e.jsxs(h,{variant:"body2",fontWeight:"medium",children:["$",(Number(x.total_line_amount)||0).toFixed(2)]})})]},x.part_number))})]})}),e.jsx(k,{sx:{mt:2,p:2,backgroundColor:"grey.50",borderRadius:1},children:e.jsxs(h,{variant:"h6",align:"right",children:["Total Amount: $",m.reduce((x,R)=>x+(Number(R.total_line_amount)||0),0).toFixed(2)]})})]}),e.jsxs(_t,{children:[e.jsx(G,{onClick:b,disabled:n,children:"Cancel"}),e.jsx(G,{onClick:N,variant:"contained",color:"primary",disabled:n,startIcon:n?e.jsx(it,{size:20}):e.jsx(ac,{}),children:n?"Creating...":"Create Purchase Order"})]})]})]})},RS=()=>{const t=Kt(),[r,n]=l.useState(!0),[a,s]=l.useState(!1),[o,i]=l.useState([]),[c,u]=l.useState([]),[d,p]=l.useState([]),[f,m]=l.useState(!1),[j,v]=l.useState(""),[w,_]=l.useState("");l.useEffect(()=>{P()},[]);const P=async()=>{n(!0);try{const[b,N,g]=await Promise.all([B.get("/api/time-tracking/admin/available-users"),B.get("/api/time-tracking/profiles"),B.get("/api/time-tracking/admin/user-profile-access")]);i(b.data||[]),u(N.data||[]),p(g.data||[])}catch(b){console.error("Error loading data:",b),H.error("Failed to load mobile user access data")}finally{n(!1)}},L=async()=>{if(!j||!w){H.error("Please select both a user and a profile");return}s(!0);try{await B.post("/api/time-tracking/admin/user-profile-access",{user_id:j,profile_id:w}),H.success("Profile access granted successfully"),m(!1),v(""),_(""),P()}catch(b){console.error("Error granting access:",b),H.error(b.response?.data?.error||"Failed to grant access")}finally{s(!1)}},C=async b=>{if(window.confirm("Are you sure you want to revoke this profile access?"))try{await B.delete(`/api/time-tracking/admin/user-profile-access/${b}`),H.success("Profile access revoked successfully"),P()}catch(N){console.error("Error revoking access:",N),H.error(N.response?.data?.error||"Failed to revoke access")}},D=d.filter(b=>b.is_active),A=d.filter(b=>!b.is_active);return e.jsxs(at,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(gt,{onClick:()=>t(-1),children:e.jsx(po,{})}),e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Mobile User Access Management"})]}),e.jsxs(ke,{direction:"row",spacing:2,children:[e.jsx(G,{variant:"contained",onClick:()=>m(!0),startIcon:e.jsx(Lr,{}),children:"Grant Access"}),e.jsx(G,{variant:"outlined",onClick:P,startIcon:e.jsx(jn,{}),children:"Refresh"})]})]}),e.jsxs(M,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Mobile Users"}),e.jsx(h,{variant:"h4",children:o.length})]})})}),e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Available Profiles"}),e.jsx(h,{variant:"h4",children:c.length})]})})}),e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Active Access"}),e.jsx(h,{variant:"h4",color:"success.main",children:D.length})]})})}),e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsx(h,{color:"textSecondary",gutterBottom:!0,children:"Revoked Access"}),e.jsx(h,{variant:"h4",color:"text.secondary",children:A.length})]})})})]}),r?e.jsx(k,{display:"flex",justifyContent:"center",p:3,children:e.jsx(it,{})}):e.jsxs(e.Fragment,{children:[e.jsx(Ae,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Active Profile Access"}),D.length===0?e.jsx(We,{severity:"info",children:'No active profile access assignments. Click "Grant Access" to get started.'}):e.jsx(lr,{children:e.jsxs(nr,{children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Mobile User"}),e.jsx(ne,{children:"Profile"}),e.jsx(ne,{children:"Granted By"}),e.jsx(ne,{children:"Granted At"}),e.jsx(ne,{children:"Actions"})]})}),e.jsx(ar,{children:D.map(b=>e.jsxs(ht,{children:[e.jsx(ne,{children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:b.user_email}),e.jsx(De,{label:b.user_role,size:"small",color:"primary",variant:"outlined"})]})}),e.jsx(ne,{children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:b.profile_name}),e.jsx(h,{variant:"caption",color:"textSecondary",children:b.profile_email})]})}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",children:b.granted_by_email||"System"})}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",children:new Date(b.granted_at).toLocaleDateString()})}),e.jsx(ne,{children:e.jsx(gt,{color:"error",onClick:()=>C(b.id),title:"Revoke Access",children:e.jsx(gr,{})})})]},b.id))})]})})]})}),A.length>0&&e.jsx(Ae,{sx:{width:"100%",overflow:"hidden"},children:e.jsxs(k,{sx:{p:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Revoked Profile Access"}),e.jsx(lr,{children:e.jsxs(nr,{children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{children:"Mobile User"}),e.jsx(ne,{children:"Profile"}),e.jsx(ne,{children:"Revoked At"})]})}),e.jsx(ar,{children:A.map(b=>e.jsxs(ht,{children:[e.jsx(ne,{children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:b.user_email}),e.jsx(De,{label:b.user_role,size:"small",color:"default",variant:"outlined"})]})}),e.jsx(ne,{children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:b.profile_name}),e.jsx(h,{variant:"caption",color:"textSecondary",children:b.profile_email})]})}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",children:new Date(b.updated_at).toLocaleDateString()})})]},b.id))})]})})]})})]}),e.jsxs(mt,{open:f,onClose:()=>m(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ft,{children:e.jsxs(k,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(Lr,{}),"Grant Profile Access"]})}),e.jsx(xt,{children:e.jsxs(ke,{spacing:3,sx:{mt:1},children:[e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Mobile User"}),e.jsx(Wt,{value:j,onChange:b=>v(Number(b.target.value)),label:"Mobile User",children:o.map(b=>e.jsx(et,{value:b.id,children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:b.email}),e.jsx(h,{variant:"caption",color:"textSecondary",children:b.access_role})]})},b.id))})]}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Profile"}),e.jsx(Wt,{value:w,onChange:b=>_(Number(b.target.value)),label:"Profile",children:c.map(b=>e.jsx(et,{value:b.id,children:e.jsxs(k,{children:[e.jsx(h,{variant:"body2",fontWeight:"bold",children:b.name}),e.jsx(h,{variant:"caption",color:"textSecondary",children:b.email})]})},b.id))})]})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:()=>m(!1),children:"Cancel"}),e.jsx(G,{onClick:L,variant:"contained",disabled:a||!j||!w,startIcon:a?e.jsx(it,{size:20}):e.jsx(qn,{}),children:a?"Granting...":"Grant Access"})]})]})]})};var Ba={},xu;function NS(){if(xu)return Ba;xu=1;var t=yt();Object.defineProperty(Ba,"__esModule",{value:!0}),Ba.default=void 0;var r=t(bt()),n=vt();return Ba.default=(0,r.default)((0,n.jsx)("path",{d:"M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5c-.49 0-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20zm-6 8h-4v-2h4zm0-4h-4v-2h4z"}),"BugReport"),Ba}var LS=NS();const qS=st(LS);var Ha={},gu;function US(){if(gu)return Ha;gu=1;var t=yt();Object.defineProperty(Ha,"__esModule",{value:!0}),Ha.default=void 0;var r=t(bt()),n=vt();return Ha.default=(0,r.default)((0,n.jsx)("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8zm2 16H8v-2h8zm0-4H8v-2h8zm-3-5V3.5L18.5 9z"}),"Description"),Ha}var WS=US();const FS=st(WS),yu=[{value:"gmail",label:"Gmail",host:"smtp.gmail.com",port:587,secure:!1},{value:"outlook",label:"Outlook/Hotmail",host:"smtp-mail.outlook.com",port:587,secure:!1},{value:"yahoo",label:"Yahoo",host:"smtp.mail.yahoo.com",port:587,secure:!1},{value:"icloud",label:"iCloud",host:"smtp.mail.me.com",port:587,secure:!1},{value:"titan",label:"Titan Email",host:"smtp.titan.email",port:465,secure:!0},{value:"custom",label:"Custom SMTP",host:"",port:587,secure:!1}],$S=()=>{const t=Kt(),[r,n]=l.useState({email_provider:"gmail",email_host:"smtp.gmail.com",email_port:587,email_secure:!1,email_user:"",email_from:""}),[a,s]=l.useState(""),[o,i]=l.useState(!1),[c,u]=l.useState(!1),[d,p]=l.useState(!1),[f,m]=l.useState("unknown");l.useEffect(()=>{j()},[]);const j=async()=>{try{const D=await B.get("/api/email/user-settings");if(D.data.success&&D.data.settings){const A=D.data.settings;n({email_provider:A.email_provider,email_host:A.email_host,email_port:A.email_port,email_secure:A.email_secure,email_user:A.email_user,email_from:A.email_from||A.email_user}),p(!0)}}catch(D){console.error("Error loading user email settings:",D)}},v=async()=>{if(!r.email_host||!r.email_port||!r.email_user){H.error("Please fill in all required fields");return}d&&!a&&H.info("Password field is empty - keeping existing password"),i(!0);try{const D={...r,...a&&{email_pass:a}},A=await B.post("/api/email/user-settings",D);A.data.success?(H.success("Email settings saved successfully!"),p(!0),s(""),m("unknown")):H.error(A.data.message||"Failed to save email settings")}catch(D){console.error("Error saving email settings:",D),H.error(D.response?.data?.message||"Failed to save email settings")}finally{i(!1)}},w=async()=>{if(!d){H.error("Please save your email settings first");return}u(!0);try{const D=await B.post("/api/email/test-user-connection");D.data.success?(m("connected"),H.success("Email connection test successful!")):(m("failed"),H.error(D.data.message||"Email connection test failed"))}catch(D){console.error("Error testing email connection:",D),m("failed"),H.error(D.response?.data?.message||"Email connection test failed")}finally{u(!1)}},_=D=>{const A=yu.find(b=>b.value===D);A&&n(b=>({...b,email_provider:D,email_host:A.host,email_port:A.port,email_secure:A.secure}))},P=(D,A)=>{n(b=>({...b,[D]:A}))},L=()=>{switch(f){case"connected":return"success";case"failed":return"error";default:return"info"}},C=()=>{switch(f){case"connected":return"Connected";case"failed":return"Connection Failed";default:return"Not Tested"}};return e.jsxs(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center",mb:3},children:[e.jsx(bi,{sx:{mr:2,fontSize:32}}),e.jsx(h,{variant:"h4",component:"h1",children:"My Email Settings"})]}),e.jsx(We,{severity:"info",sx:{mb:3},children:"Configure your personal email settings to send emails from your own email account. These settings are private to your account and will be used when you send emails from the system."}),e.jsxs(We,{severity:"warning",sx:{mb:3},children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:e.jsx("strong",{children:"Important for Gmail users:"})}),e.jsxs(h,{variant:"body2",children:[`If you're using Gmail with 2-Factor Authentication, you need to use an "App Password" instead of your regular password.`,e.jsx("br",{})," Go to ",e.jsx("a",{href:"https://myaccount.google.com/apppasswords",target:"_blank",rel:"noopener noreferrer",children:"Google App Passwords"}),e.jsx("br",{}),' Generate an app password for "Mail"',e.jsx("br",{}),' Use that 16-character password in the "App Password" field below']})]}),e.jsxs(M,{container:!0,spacing:3,children:[e.jsx(M,{item:!0,xs:12,md:8,children:e.jsxs(kt,{children:[e.jsxs(Tt,{children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Email Configuration"}),e.jsxs(M,{container:!0,spacing:2,children:[e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{select:!0,label:"Email Provider",value:r.email_provider,onChange:D=>_(D.target.value),fullWidth:!0,helperText:"Select your email provider or choose Custom for other SMTP servers",children:yu.map(D=>e.jsx(et,{value:D.value,children:D.label},D.value))})}),e.jsx(M,{item:!0,xs:12,sm:8,children:e.jsx(le,{label:"SMTP Host",value:r.email_host,onChange:D=>P("email_host",D.target.value),fullWidth:!0,required:!0,disabled:r.email_provider!=="custom"})}),e.jsx(M,{item:!0,xs:12,sm:4,children:e.jsx(le,{label:"SMTP Port",type:"number",value:r.email_port,onChange:D=>P("email_port",parseInt(D.target.value)),fullWidth:!0,required:!0,disabled:r.email_provider!=="custom"})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(vn,{control:e.jsx(ui,{checked:r.email_secure,onChange:D=>P("email_secure",D.target.checked),disabled:r.email_provider!=="custom"}),label:"Use SSL/TLS (usually for port 465)"})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Email Address",type:"email",value:r.email_user,onChange:D=>P("email_user",D.target.value),fullWidth:!0,required:!0,helperText:"Your email address for authentication"})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:d?"Update App Password":"App Password",type:"password",value:a,onChange:D=>s(D.target.value),fullWidth:!0,required:!d,helperText:d?"Leave blank to keep current password, or enter new password to update":"Your email password or app password (for Gmail with 2FA)"})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"From Name (Optional)",value:r.email_from,onChange:D=>P("email_from",D.target.value),fullWidth:!0,helperText:"Display name for outgoing emails (defaults to email address)"})})]})]}),e.jsx(ll,{children:e.jsx(G,{variant:"contained",startIcon:o?e.jsx(it,{size:20}):e.jsx(as,{}),onClick:v,disabled:o,children:o?"Saving...":"Save Settings"})})]})}),e.jsxs(M,{item:!0,xs:12,md:4,children:[e.jsxs(kt,{children:[e.jsxs(Tt,{children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Connection Status"}),e.jsx(We,{severity:L(),sx:{mb:2},children:C()}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Test your email configuration to ensure it works correctly."})]}),e.jsx(ll,{children:e.jsx(G,{variant:"outlined",startIcon:c?e.jsx(it,{size:20}):e.jsx(qS,{}),onClick:w,disabled:c||!d,fullWidth:!0,children:c?"Testing...":"Test Connection"})})]}),e.jsx(kt,{sx:{mt:2},children:e.jsxs(Tt,{children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Setup Instructions"}),e.jsxs(h,{variant:"body2",sx:{mb:1},children:[e.jsx("strong",{children:"Gmail:"})," Use an App Password instead of your regular password."]}),e.jsxs(h,{variant:"body2",sx:{mb:1},children:[e.jsx("strong",{children:"Outlook:"})," Use an App Password for enhanced security."]}),e.jsxs(h,{variant:"body2",children:[e.jsx("strong",{children:"Other providers:"})," Check your email provider's SMTP settings."]})]})}),e.jsx(kt,{sx:{mt:2,border:"2px solid red"},children:e.jsxs(Tt,{children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Quick Actions"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Manage your email templates and customize email content for different types of communications."}),e.jsx(G,{fullWidth:!0,variant:"outlined",onClick:()=>t("/email-templates"),startIcon:e.jsx(FS,{}),sx:{mb:1},color:"primary",children:"Manage Email Templates"})]})})]})]})]})},zS=()=>{const{user:t}=Zt(),[r,n]=l.useState([]),[a,s]=l.useState(!0),[o,i]=l.useState(!1),[c,u]=l.useState(null),[d,p]=l.useState({name:"",type:"purchase_order",subject:"",html_content:"",text_content:"",is_default:!1}),[f,m]=l.useState(""),[j,v]=l.useState("");l.useEffect(()=>{w()},[]);const w=async()=>{try{s(!0);const b=await B.get("/api/email/templates");b.data.success&&n(b.data.templates)}catch(b){console.error("Error loading templates:",b),m("Failed to load email templates")}finally{s(!1)}},_=b=>{b?(u(b),p({name:b.name,type:b.type,subject:b.subject,html_content:b.html_content,text_content:b.text_content||"",is_default:b.is_default})):(u(null),p({name:"",type:"purchase_order",subject:"",html_content:"",text_content:"",is_default:!1})),i(!0)},P=()=>{i(!1),u(null),p({name:"",type:"purchase_order",subject:"",html_content:"",text_content:"",is_default:!1})},L=async()=>{try{c?(await B.put(`/api/email/templates/${c.id}`,d),v("Email template updated successfully")):(await B.post("/api/email/templates",d),v("Email template created successfully")),P(),w()}catch(b){console.error("Error saving template:",b),m(b.response?.data?.message||"Failed to save template")}},C=async b=>{if(window.confirm("Are you sure you want to delete this template?"))try{await B.delete(`/api/email/templates/${b}`),v("Email template deleted successfully"),w()}catch(N){console.error("Error deleting template:",N),m(N.response?.data?.message||"Failed to delete template")}},D=b=>{switch(b){case"purchase_order":return"primary";case"sales_order":return"success";case"quote":return"warning";case"custom":return"info";default:return"default"}},A=b=>{switch(b){case"purchase_order":return"Purchase Order";case"sales_order":return"Sales Order";case"quote":return"Quote";case"custom":return"Custom";default:return b}};return a?e.jsx(at,{maxWidth:"lg",children:e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Loading..."})}):e.jsxs(at,{maxWidth:"lg",children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Email Templates"}),e.jsx(G,{variant:"contained",startIcon:e.jsx(ci,{}),onClick:()=>_(),children:"Create Template"})]}),e.jsx(M,{container:!0,spacing:3,children:r.map(b=>e.jsx(M,{item:!0,xs:12,md:6,lg:4,children:e.jsx(kt,{children:e.jsxs(Tt,{children:[e.jsxs(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:[e.jsx(h,{variant:"h6",component:"div",children:b.name}),e.jsxs(k,{children:[e.jsx(gt,{size:"small",onClick:()=>_(b),color:"primary",children:e.jsx(di,{})}),e.jsx(gt,{size:"small",onClick:()=>C(b.id),color:"error",children:e.jsx(qs,{})})]})]}),e.jsx(De,{label:A(b.type),color:D(b.type),size:"small",sx:{mb:1}}),b.is_default&&e.jsx(De,{label:"Default",color:"secondary",size:"small",sx:{ml:1}}),e.jsxs(h,{variant:"body2",color:"text.secondary",sx:{mt:1},children:[e.jsx("strong",{children:"Subject:"})," ",b.subject]}),e.jsxs(h,{variant:"body2",color:"text.secondary",sx:{mt:1},children:[e.jsx("strong",{children:"Created:"})," ",new Date(b.created_at).toLocaleDateString()]}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:"Updated:"})," ",new Date(b.updated_at).toLocaleDateString()]})]})})},b.id))}),r.length===0&&e.jsxs(k,{sx:{textAlign:"center",mt:4},children:[e.jsx(h,{variant:"h6",color:"text.secondary",children:"No email templates found"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Create your first email template to get started"})]}),e.jsxs(mt,{open:o,onClose:P,maxWidth:"md",fullWidth:!0,children:[e.jsx(ft,{children:c?"Edit Email Template":"Create Email Template"}),e.jsx(xt,{children:e.jsxs(k,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsx(le,{label:"Template Name",value:d.name,onChange:b=>p({...d,name:b.target.value}),fullWidth:!0,required:!0}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{children:"Template Type"}),e.jsxs(Wt,{value:d.type,onChange:b=>p({...d,type:b.target.value}),label:"Template Type",children:[e.jsx(et,{value:"purchase_order",children:"Purchase Order"}),e.jsx(et,{value:"sales_order",children:"Sales Order"}),e.jsx(et,{value:"quote",children:"Quote"}),e.jsx(et,{value:"custom",children:"Custom"})]})]}),e.jsx(le,{label:"Subject",value:d.subject,onChange:b=>p({...d,subject:b.target.value}),fullWidth:!0,required:!0}),e.jsx(le,{label:"HTML Content",value:d.html_content,onChange:b=>p({...d,html_content:b.target.value}),fullWidth:!0,multiline:!0,rows:8,required:!0,helperText:"Use HTML formatting for rich email content"}),e.jsx(le,{label:"Text Content (Optional)",value:d.text_content,onChange:b=>p({...d,text_content:b.target.value}),fullWidth:!0,multiline:!0,rows:4,helperText:"Plain text version for email clients that don't support HTML"}),e.jsx(vn,{control:e.jsx(ui,{checked:d.is_default,onChange:b=>p({...d,is_default:b.target.checked})}),label:"Set as default template for this type"})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:P,children:"Cancel"}),e.jsx(G,{onClick:L,variant:"contained",children:c?"Update":"Create"})]})]}),e.jsx(bn,{open:!!f,autoHideDuration:6e3,onClose:()=>m(""),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(We,{onClose:()=>m(""),severity:"error",sx:{width:"100%"},children:f})}),e.jsx(bn,{open:!!j,autoHideDuration:6e3,onClose:()=>v(""),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(We,{onClose:()=>v(""),severity:"success",sx:{width:"100%"},children:j})})]})};var Bo={exports:{}},BS=Bo.exports,vu;function HS(){return vu||(vu=1,function(t,r){(function(n,a){t.exports=a()})(BS,function(){return function(n,a,s){n=n||{};var o=a.prototype,i={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function c(d,p,f,m){return o.fromToBase(d,p,f,m)}s.en.relativeTime=i,o.fromToBase=function(d,p,f,m,j){for(var v,w,_,P=f.$locale().relativeTime||i,L=n.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],C=L.length,D=0;D<C;D+=1){var A=L[D];A.d&&(v=m?s(d).diff(f,A.d,!0):f.diff(d,A.d,!0));var b=(n.rounding||Math.round)(Math.abs(v));if(_=v>0,b<=A.r||!A.r){b<=1&&D>0&&(A=L[D-1]);var N=P[A.l];j&&(b=j(""+b)),w=typeof N=="string"?N.replace("%d",b):N(b,p,A.l,_);break}}if(p)return w;var g=_?P.future:P.past;return typeof g=="function"?g(w):g.replace("%s",w)},o.to=function(d,p){return c(d,p,this,!0)},o.from=function(d,p){return c(d,p,this)};var u=function(d){return d.$u?s.utc():s()};o.toNow=function(d){return this.to(u(this),d)},o.fromNow=function(d){return this.from(u(this),d)}}})}(Bo)),Bo.exports}var YS=HS();const _h=st(YS);var Ya={},bu;function VS(){if(bu)return Ya;bu=1;var t=yt();Object.defineProperty(Ya,"__esModule",{value:!0}),Ya.default=void 0;var r=t(bt()),n=vt();return Ya.default=(0,r.default)((0,n.jsx)("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"}),"Send"),Ya}var GS=VS();const QS=st(GS),Ho={async fetchMessages(t,r){return(await B.get(`/api/tasks/${t}/messages`,{params:r?{after:r}:void 0})).data},async postMessage(t,r){return(await B.post(`/api/tasks/${t}/messages`,r)).data},async markMessagesRead(t,r){return(await B.post(`/api/tasks/${t}/messages/mark-read`,{lastMessageId:r})).data},async getTaskDetail(t){return(await B.get(`/api/tasks/${t}`)).data}};$e.extend(_h);const jh=t=>[...t].sort((r,n)=>{const a=new Date(r.createdAt).getTime(),s=new Date(n.createdAt).getTime();return a===s?r.id-n.id:a-s}),KS=(t,r)=>{if(!r.length)return{merged:t,appended:[]};const n=new Map;t.forEach(o=>n.set(o.id,o));const a=[];return r.forEach(o=>{n.has(o.id)||a.push(o),n.set(o.id,o)}),{merged:jh(Array.from(n.values())),appended:a}},JS=({taskId:t,pollIntervalMs:r=15e3,onUnreadChange:n,createdByAgent:a})=>{const{user:s}=Zt(),o=l.useMemo(()=>{if(!s?.id)return null;const E=Number(s.id);return Number.isFinite(E)?E:null},[s?.id]),[i,c]=l.useState([]),[u,d]=l.useState(null),[p,f]=l.useState(0),[m,j]=l.useState(!0),[v,w]=l.useState(!1),[_,P]=l.useState(!1),[L,C]=l.useState(""),[D,A]=l.useState(null),[b,N]=l.useState(null),g=l.useRef(null),x=l.useRef(null),R=l.useRef(!0),O=l.useRef(null),ee=l.useCallback(E=>{f(E),n?.(E)},[n]),J=l.useCallback((E=!1)=>{const V=g.current;V&&V.scrollTo({top:V.scrollHeight,behavior:E?"smooth":"auto"})},[]),z=l.useCallback(()=>{const E=g.current;return E?E.scrollHeight-E.scrollTop-E.clientHeight<=120:!0},[]),Z=l.useCallback(async E=>{try{const V=await Ho.markMessagesRead(t,E??void 0);d(V.participant),ee(V.unreadCount)}catch(V){console.warn("Failed to update read state for task chat",V)}},[ee,t]),Q=l.useCallback(E=>{!E.length||R.current||E.filter(V=>V.sender?.userId&&o&&V.sender.userId!==o).forEach(V=>{const q=V.sender?.name||"Task teammate";H.info(`New message from ${q}`)})},[o]),X=l.useCallback((E,V=!1)=>{const q=z();let ue=[],ye=O.current;return c(ge=>{if(V){const he=jh(E);return ue=he,ye=he.length?he[he.length-1].id:null,he}const{merged:xe,appended:me}=KS(ge,E);return ue=me,ye=xe.length?xe[xe.length-1].id:ye,xe}),ye!=null&&(O.current==null||ye>O.current)&&(O.current=ye),ue.length?(Q(ue),q&&setTimeout(()=>J(!0),50)):q&&V&&setTimeout(()=>J(!0),50),{appended:ue,latestId:ye}},[Q,J,z]),I=l.useCallback(async E=>{try{E?.initial?j(!0):N(null);const V=E?.forceFull?void 0:O.current??void 0,q=await Ho.fetchMessages(t,V);d(q.participant),A(q.lastSyncedAt);const{appended:ue,latestId:ye}=X(q.messages,!!E?.initial||E?.forceFull);ee(q.unreadCount),(q.unreadCount>0||ue.length>0)&&ye!=null&&await Z(ye),E?.initial&&(R.current=!1)}catch(V){console.error("Failed to load task messages",V);const q=V?.response?.data?.message||"Unable to load task messages.";N(q),E?.initial&&H.error(q)}finally{E?.initial&&j(!1)}},[X,Z,ee,t]);l.useEffect(()=>(R.current=!0,O.current=null,c([]),d(null),ee(0),I({initial:!0,forceFull:!0}).catch(()=>{}),()=>{x.current&&(clearInterval(x.current),x.current=null)}),[I,ee,t]),l.useEffect(()=>{if(x.current&&clearInterval(x.current),!(r<=0))return x.current=setInterval(()=>{I({forceFull:!1}).catch(()=>{})},r),()=>{x.current&&(clearInterval(x.current),x.current=null)}},[I,r]);const y=l.useCallback(async E=>{if(E.preventDefault(),!!L.trim())try{P(!0);const V=await Ho.postMessage(t,{content:L.trim()});d(V.participant),ee(V.unreadCount),X([V.message]),O.current=V.message.id,C(""),setTimeout(()=>J(!0),50)}catch(V){console.error("Failed to send message",V),H.error(V?.response?.data?.message||"Failed to send message")}finally{P(!1)}},[X,L,ee,J,t]),S=l.useCallback(async()=>{try{w(!0),await I({forceFull:!0})}finally{w(!1)}},[I]),U=l.useMemo(()=>D?`Updated ${$e(D).fromNow()}`:"Not synced yet",[D]),K=E=>{const V=!!(E.metadata&&E.metadata.agent||E.isSystem),q=!V&&o!=null&&E.sender?.userId===o,ue=V?"Workspace Copilot":q?"You":E.sender?.name||"Team member",ye=$e(E.createdAt).format("MMM D, YYYY h:mm A");return e.jsxs(k,{display:"flex",flexDirection:"column",alignItems:q?"flex-end":"flex-start",mb:2,children:[e.jsxs(k,{sx:{maxWidth:"80%",bgcolor:V?"rgba(25, 118, 210, 0.08)":q?"primary.main":"grey.100",color:V?"text.primary":q?"primary.contrastText":"text.primary",px:2,py:1,borderRadius:2,boxShadow:1,border:V?"1px solid":void 0,borderColor:V?"info.light":void 0},children:[V&&e.jsx(De,{label:"Workspace Copilot",size:"small",color:"info",sx:{mb:.5}}),e.jsx(h,{variant:"body2",sx:{whiteSpace:"pre-wrap"},children:E.content})]}),e.jsxs(h,{variant:"caption",color:"text.secondary",sx:{mt:.5},children:[ue,"  ",ye]})]},E.id)};return e.jsxs(Ae,{elevation:2,sx:{display:"flex",flexDirection:"column",height:"100%"},children:[e.jsxs(k,{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1.5,children:[e.jsxs(k,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(h,{variant:"h6",children:"Task chat"}),e.jsx(ii,{color:"secondary",badgeContent:p,invisible:p===0,children:e.jsx(De,{label:"Unread",size:"small",variant:p?"filled":"outlined"})})]}),e.jsxs(k,{display:"flex",alignItems:"center",gap:1,children:[D&&e.jsx(h,{variant:"caption",color:"text.secondary",children:U}),e.jsx(Vt,{title:"Refresh conversation",children:e.jsx("span",{children:e.jsx(gt,{onClick:S,disabled:v||m,size:"small",children:v?e.jsx(it,{size:18}):e.jsx(jn,{fontSize:"small"})})})})]})]}),a&&e.jsx(k,{px:2,pb:1,children:e.jsx(We,{severity:"info",variant:"outlined",sx:{borderRadius:2},children:"Workspace Copilot created this task and will keep the conversation updated."})}),e.jsx(xr,{}),e.jsx(k,{ref:g,flex:1,overflow:"auto",px:2,py:2,children:m?e.jsx(k,{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",children:e.jsx(it,{size:32})}):b?e.jsx(h,{color:"error",variant:"body2",children:b}):i.length===0?e.jsx(k,{textAlign:"center",color:"text.secondary",children:e.jsx(h,{variant:"body2",children:"No messages yet. Start the conversation below."})}):i.map(E=>K(E))}),e.jsx(xr,{}),e.jsxs(k,{component:"form",onSubmit:y,display:"flex",gap:1,px:2,py:1.5,children:[e.jsx(le,{value:L,onChange:E=>C(E.target.value),placeholder:"Write a message",fullWidth:!0,minRows:2,maxRows:4,multiline:!0,disabled:_}),e.jsx(G,{type:"submit",variant:"contained",endIcon:_?e.jsx(it,{color:"inherit",size:18}):e.jsx(QS,{}),disabled:_||L.trim().length===0,children:"Send"})]})]})};$e.extend(_h);const XS=()=>{const{id:t}=wn(),r=l.useMemo(()=>{if(!t)return NaN;const v=Number(t);return Number.isFinite(v)?v:NaN},[t]),[n,a]=l.useState(null),[s,o]=l.useState(!0),[i,c]=l.useState(null),[u,d]=l.useState(0),p=l.useCallback(async()=>{if(!Number.isFinite(r)){c("Invalid task identifier"),o(!1);return}try{o(!0),c(null);const v=await Ho.getTaskDetail(r);a(v)}catch(v){console.error("Failed to load task details",v);const w=v?.response?.data?.message||"Unable to load task details.";c(w),H.error(w)}finally{o(!1)}},[r]);l.useEffect(()=>{p()},[p]);const f=l.useCallback(v=>{d(v)},[]);if(!Number.isFinite(r))return e.jsx(k,{p:3,children:e.jsx(h,{color:"error",children:"Invalid task identifier."})});if(s)return e.jsx(k,{p:3,display:"flex",alignItems:"center",justifyContent:"center",minHeight:"40vh",children:e.jsx(it,{})});if(i)return e.jsx(k,{p:3,children:e.jsx(h,{color:"error",children:i})});if(!n)return null;const{task:m,participants:j}=n;return e.jsxs(k,{p:3,display:"flex",flexDirection:"column",gap:3,children:[e.jsxs(k,{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,justifyContent:"space-between",children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:m.title}),e.jsxs(k,{display:"flex",flexWrap:"wrap",gap:1,alignItems:"center",children:[e.jsx(De,{label:m.status,color:m.status==="completed"?"success":"default"}),e.jsx(De,{label:`Priority: ${m.priority??"N/A"}`,variant:"outlined"}),m.dueDate&&e.jsx(De,{label:`Due ${$e(m.dueDate).format("MMM D, YYYY")}`,color:"warning"}),m.createdByAgent&&e.jsx(De,{label:"Created by Workspace Copilot",color:"info",variant:"outlined"}),u>0&&e.jsx(De,{label:`${u} unread`,color:"secondary"})]})]}),e.jsxs(k,{textAlign:{xs:"left",md:"right"},color:"text.secondary",children:[m.updatedAt&&e.jsxs(h,{variant:"body2",children:["Updated ",$e(m.updatedAt).format("MMM D, YYYY h:mm A")]}),m.createdAt&&e.jsxs(h,{variant:"body2",children:["Created ",$e(m.createdAt).format("MMM D, YYYY h:mm A")]})]})]}),m.description&&e.jsxs(Ae,{variant:"outlined",sx:{p:2},children:[e.jsx(h,{variant:"subtitle1",gutterBottom:!0,children:"Description"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{whiteSpace:"pre-wrap"},children:m.description})]}),e.jsxs(M,{container:!0,spacing:3,alignItems:"stretch",children:[e.jsx(M,{item:!0,xs:12,md:4,children:e.jsxs(Ae,{variant:"outlined",sx:{p:2,height:"100%"},children:[e.jsx(h,{variant:"subtitle1",gutterBottom:!0,children:"Participants"}),j.length===0?e.jsx(h,{variant:"body2",color:"text.secondary",children:"No participants assigned."}):e.jsx(k,{display:"flex",flexDirection:"column",gap:1.5,children:j.map(v=>{const w=(v.name||v.email||"T")[0]?.toUpperCase();return e.jsxs(k,{display:"flex",alignItems:"center",gap:1.5,children:[e.jsx(Nn,{sx:{bgcolor:"primary.main"},children:w}),e.jsxs(k,{flex:1,children:[e.jsx(h,{variant:"body2",children:v.name||"Unnamed user"}),e.jsxs(h,{variant:"caption",color:"text.secondary",display:"block",children:[v.email||"No email","  ",v.role||"Participant"]}),v.lastReadAt&&e.jsxs(h,{variant:"caption",color:"text.secondary",display:"block",children:["Read ",$e(v.lastReadAt).fromNow()]})]})]},v.id)})})]})}),e.jsx(M,{item:!0,xs:12,md:8,children:e.jsx(JS,{taskId:r,onUnreadChange:f,createdByAgent:!!m.createdByAgent})})]})]})},_u=[{value:"pending",label:"Pending"},{value:"in_progress",label:"In Progress"},{value:"completed",label:"Completed"},{value:"archived",label:"Archived"}],ZS=({filters:t,assignees:r,onChange:n,onReset:a})=>{const s=u=>{const d=u.target.value,p=typeof d=="string"?d.split(","):d;n({...t,status:p.filter(Boolean)})},o=u=>{const d=u.target.value;n({...t,assignedTo:d?Number(d):void 0})},i=u=>d=>{n({...t,[u]:d.target.value||void 0})},c=u=>d=>{n({...t,[u]:d.target.checked})};return e.jsx(Ae,{variant:"outlined",sx:{p:{xs:2.5,md:3},borderRadius:3,backgroundColor:"background.paper"},children:e.jsxs(ke,{direction:{xs:"column",lg:"row"},spacing:2,useFlexGap:!0,flexWrap:"wrap",alignItems:{xs:"stretch",lg:"flex-end"},children:[e.jsxs(Mt,{sx:{minWidth:180,flex:"1 1 200px"},size:"small",children:[e.jsx(Ut,{id:"task-status-label",children:"Status"}),e.jsx(Wt,{labelId:"task-status-label",multiple:!0,value:t.status??[],onChange:s,input:e.jsx(Yu,{label:"Status"}),renderValue:u=>u.map(d=>_u.find(p=>p.value===d)?.label??d).join(", "),children:_u.map(u=>e.jsxs(et,{value:u.value,children:[e.jsx(on,{checked:t.status?.includes(u.value)??!1}),e.jsx(fr,{primary:u.label})]},u.value))})]}),e.jsxs(Mt,{sx:{minWidth:180,flex:"1 1 200px"},size:"small",children:[e.jsx(Ut,{id:"task-assigned-label",children:"Assigned to"}),e.jsxs(Wt,{labelId:"task-assigned-label",value:t.assignedTo?String(t.assignedTo):"",label:"Assigned to",onChange:o,children:[e.jsx(et,{value:"",children:e.jsx("em",{children:"All team members"})}),r.map(u=>e.jsx(et,{value:u.id,children:u.username||u.email},u.id))]})]}),e.jsx(le,{label:"Search",size:"small",value:t.search??"",onChange:i("search"),sx:{flex:"1 1 200px"}}),e.jsx(le,{label:"Due from",type:"date",size:"small",value:t.dueFrom?.slice(0,10)??"",onChange:i("dueFrom"),InputLabelProps:{shrink:!0},sx:{flex:"1 1 180px"}}),e.jsx(le,{label:"Due to",type:"date",size:"small",value:t.dueTo?.slice(0,10)??"",onChange:i("dueTo"),InputLabelProps:{shrink:!0},sx:{flex:"1 1 180px"}}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column",gap:1,flex:"1 1 220px"},children:[e.jsx(vn,{control:e.jsx(on,{checked:t.includeCompleted??!1,onChange:c("includeCompleted")}),label:"Show completed"}),e.jsx(vn,{control:e.jsx(on,{checked:t.includeArchived??!1,onChange:c("includeArchived")}),label:"Show archived"})]}),a&&e.jsx(k,{sx:{display:"flex",alignItems:"center"},children:e.jsx(G,{variant:"text",onClick:a,color:"secondary",children:"Reset"})})]})})};var Va={},ju;function e1(){if(ju)return Va;ju=1;var t=yt();Object.defineProperty(Va,"__esModule",{value:!0}),Va.default=void 0;var r=t(bt()),n=vt();return Va.default=(0,r.default)((0,n.jsx)("path",{d:"M3 18h12v-2H3zM3 6v2h18V6zm0 7h18v-2H3z"}),"Notes"),Va}var t1=e1();const wu=st(t1),wh=({completed:t,disabled:r,onToggle:n,label:a})=>{const s=o=>{n(o.target.checked)};return e.jsx(Vt,{title:t?"Mark as incomplete":"Mark as completed",children:e.jsx(vn,{control:e.jsx(ui,{checked:t,onChange:s,disabled:r,color:"success",size:"small"}),label:a??(t?"Completed":"Mark complete")})})},r1={pending:"Pending",in_progress:"In Progress",completed:"Completed",archived:"Archived"},n1={pending:"warning",in_progress:"info",completed:"success",archived:"default"},Sh=t=>t?new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric",year:"numeric"}).format(new Date(t)):"No due date",rl=typeof Intl<"u"&&"RelativeTimeFormat"in Intl?new Intl.RelativeTimeFormat(void 0,{numeric:"auto"}):null,Su=t=>{if(!t)return"Never";const r=new Date(t);if(Number.isNaN(r.getTime())||!rl)return Sh(t);const n=r.getTime()-Date.now(),a=Math.abs(n),s=[["day",1e3*60*60*24],["hour",1e3*60*60],["minute",1e3*60]];for(const[o,i]of s)if(a>=i||o==="minute"){const c=Math.round(n/i);return rl.format(c,o)}return rl.format(0,"minute")},s1=({tasks:t,onSelect:r,onToggleComplete:n,onEdit:a,onDelete:s})=>t.length===0?e.jsxs(k,{textAlign:"center",py:6,color:"text.secondary",sx:{border:"1px dashed",borderColor:"divider",borderRadius:3,backgroundColor:"background.paper"},children:[e.jsx(wu,{sx:{fontSize:48,mb:1}}),e.jsx(h,{variant:"h6",children:"No tasks found"}),e.jsx(h,{variant:"body2",children:"Use the New task button above to create your first assignment."})]}):e.jsx(ke,{spacing:2.5,children:t.map(o=>{const i=o.dueDate?new Date(o.dueDate):null,c=Date.now(),u=!!(i&&i.getTime()<c&&o.status!=="completed"),d=i&&o.status!=="completed"?Math.ceil((i.getTime()-c)/(1e3*60*60*24)):null,p=typeof d=="number"&&d>=0&&d<=3,f=u?"error.main":o.status==="completed"?"success.main":p?"warning.main":"info.main";return e.jsxs(kt,{elevation:0,sx:{position:"relative",borderRadius:3,border:"1px solid",borderColor:"divider",overflow:"hidden",transition:"all 0.2s ease-in-out",backgroundColor:o.createdByAgent?"rgba(25, 118, 210, 0.06)":"background.paper","&:hover":{boxShadow:8,transform:"translateY(-2px)"}},children:[e.jsx(k,{sx:{position:"absolute",top:0,left:0,bottom:0,width:6,bgcolor:f}}),e.jsx(im,{onClick:()=>r(o),sx:{alignSelf:"stretch"},children:e.jsx(k,{sx:{p:{xs:2.5,sm:3}},children:e.jsxs(ke,{spacing:2,children:[e.jsxs(ke,{direction:{xs:"column",md:"row"},spacing:1.5,justifyContent:"space-between",alignItems:{xs:"flex-start",md:"center"},children:[e.jsx(h,{variant:"h6",children:o.title}),e.jsxs(ke,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",useFlexGap:!0,children:[e.jsx(De,{label:r1[o.status],color:n1[o.status],size:"small"}),o.createdByAgent&&e.jsx(De,{label:"AI",size:"small",color:"info",variant:"outlined"}),u&&o.status!=="completed"&&e.jsx(De,{label:"Overdue",color:"error",size:"small",variant:"outlined"}),o.status==="completed"&&e.jsx(De,{label:`Completed ${Su(o.completedAt)}`,color:"success",size:"small",variant:"outlined"})]})]}),o.description&&e.jsx(h,{variant:"body2",color:"text.secondary",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:o.description}),e.jsxs(ke,{direction:{xs:"column",md:"row"},spacing:2,justifyContent:"space-between",alignItems:{xs:"flex-start",md:"center"},children:[e.jsxs(ke,{direction:"row",spacing:1,flexWrap:"wrap",useFlexGap:!0,children:[e.jsx(De,{icon:e.jsx($p,{fontSize:"small"}),label:Sh(o.dueDate),color:u?"error":p?"warning":"default",variant:o.dueDate?"filled":"outlined",size:"small"}),e.jsx(De,{icon:e.jsx(wu,{fontSize:"small"}),label:`${o.noteCount} note${o.noteCount===1?"":"s"}`,size:"small",variant:"outlined"}),e.jsx(De,{icon:e.jsx(Tp,{fontSize:"small"}),label:`Updated ${Su(o.updatedAt)}`,size:"small",variant:"outlined"})]}),o.assignees.length>0?e.jsx(lm,{max:4,sx:{"& .MuiAvatar-root":{width:32,height:32,fontSize:14}},children:o.assignees.map(m=>e.jsx(Vt,{title:m.username||m.email,children:e.jsx(Nn,{children:(m.username||m.email||"?").charAt(0).toUpperCase()})},`${o.id}-assignee-${m.id}`))}):e.jsx(De,{label:"Unassigned",size:"small",variant:"outlined"})]})]})})}),e.jsx(xr,{}),e.jsxs(ll,{sx:{px:{xs:2,sm:3},py:1.5,justifyContent:"space-between",alignItems:"center"},children:[e.jsx(k,{onClick:m=>m.stopPropagation(),sx:{display:"flex",alignItems:"center"},children:e.jsx(wh,{completed:o.status==="completed",onToggle:m=>n(o,m),label:o.status==="completed"?"Completed":"Mark complete"})}),e.jsxs(ke,{direction:"row",spacing:1.5,alignItems:"center",children:[e.jsx(Vt,{title:"Edit task",children:e.jsx(gt,{onClick:m=>{m.stopPropagation(),a(o)},children:e.jsx(As,{})})}),e.jsx(Vt,{title:"Delete task",children:e.jsx(gt,{color:"error",onClick:m=>{m.stopPropagation(),s(o)},children:e.jsx(gr,{})})})]})]})]},o.id)})});var Ga={},Cu;function a1(){if(Cu)return Ga;Cu=1;var t=yt();Object.defineProperty(Ga,"__esModule",{value:!0}),Ga.default=void 0;var r=t(bt()),n=vt();return Ga.default=(0,r.default)((0,n.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close"),Ga}var o1=a1();const i1=st(o1),Qa=t=>t?new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric"}).format(new Date(t)):"Not set",l1=({open:t,task:r,loading:n,onClose:a,onEdit:s,onToggleComplete:o,onAddNote:i})=>{const[c,u]=l.useState(""),[d,p]=l.useState(!1),[f,m]=l.useState(!1);l.useEffect(()=>{t||(u(""),p(!1),m(!1))},[t]);const j=async()=>{if(c.trim()){p(!0);try{await i(c.trim()),u("")}finally{p(!1)}}},v=async w=>{m(!0);try{await o(w)}finally{m(!1)}};return e.jsxs(mt,{open:t,onClose:a,fullWidth:!0,maxWidth:"md",children:[e.jsxs(ft,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(h,{variant:"h6",children:"Task details"}),e.jsx(gt,{onClick:a,children:e.jsx(i1,{})})]}),e.jsx(xt,{dividers:!0,children:n&&!r?e.jsx(h,{variant:"body2",children:"Loading task details"}):r?e.jsxs(ke,{spacing:3,children:[e.jsxs(k,{children:[e.jsxs(ke,{direction:"row",spacing:2,alignItems:"center",flexWrap:"wrap",children:[e.jsx(h,{variant:"h5",children:r.title}),e.jsx(De,{label:r.status.replace("_"," "),color:r.status==="completed"?"success":"default"})]}),r.description&&e.jsx(h,{variant:"body1",sx:{mt:1},color:"text.secondary",children:r.description})]}),e.jsxs(ke,{direction:{xs:"column",sm:"row"},spacing:3,children:[e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",color:"text.secondary",children:"Due date"}),e.jsx(h,{variant:"body1",children:Qa(r.dueDate)})]}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",color:"text.secondary",children:"Last updated"}),e.jsx(h,{variant:"body1",children:Qa(r.updatedAt)})]}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",color:"text.secondary",children:"Completed at"}),e.jsx(h,{variant:"body1",children:Qa(r.completedAt)})]})]}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Assigned team members"}),r.assignees.length===0?e.jsx(h,{variant:"body2",color:"text.secondary",children:"No assignees yet."}):e.jsx(ke,{direction:"row",spacing:1,flexWrap:"wrap",children:r.assignees.map(w=>e.jsx(De,{label:w.username||w.email},w.id))})]}),e.jsx(xr,{}),e.jsxs(ke,{direction:{xs:"column",sm:"row"},spacing:2,alignItems:{xs:"flex-start",sm:"center"},children:[e.jsx(wh,{completed:r.status==="completed",onToggle:v,disabled:f}),e.jsx(G,{variant:"outlined",onClick:s,children:"Edit task"})]}),e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:"Notes"}),r.notes&&r.notes.length>0?e.jsx(Pr,{dense:!0,children:r.notes.map(w=>e.jsx(Mr,{alignItems:"flex-start",disableGutters:!0,children:e.jsx(fr,{primary:w.note,secondary:w.authorName?`${w.authorName}  ${Qa(w.createdAt)}`:Qa(w.createdAt)})},w.id))}):e.jsx(h,{variant:"body2",color:"text.secondary",children:"No notes yet."})]}),e.jsxs(ke,{direction:{xs:"column",sm:"row"},spacing:2,alignItems:{xs:"stretch",sm:"center"},children:[e.jsx(le,{label:"Add a note",fullWidth:!0,value:c,onChange:w=>u(w.target.value),multiline:!0,minRows:2}),e.jsx(G,{variant:"contained",onClick:j,disabled:!c.trim()||d,children:"Add note"})]})]}):e.jsx(h,{variant:"body2",children:"Task not found."})}),e.jsx(_t,{children:e.jsx(G,{onClick:a,children:"Close"})})]})},c1=[{value:"pending",label:"Pending"},{value:"in_progress",label:"In Progress"},{value:"completed",label:"Completed"},{value:"archived",label:"Archived"}],d1=t=>{if(!t)return"";try{const r=new Date(t);return Number.isNaN(r.getTime())?"":r.toISOString().slice(0,10)}catch{return""}},u1=({open:t,mode:r,initialTask:n,assignees:a,submitting:s,onClose:o,onSubmit:i})=>{const[c,u]=l.useState(""),[d,p]=l.useState(""),[f,m]=l.useState(""),[j,v]=l.useState("pending"),[w,_]=l.useState([]),[P,L]=l.useState(""),[C,D]=l.useState({});l.useEffect(()=>{t&&(r==="edit"&&n?(u(n.title),p(n.description??""),m(d1(n.dueDate)),v(n.status),_(n.assignees.map(g=>g.id))):(u(""),p(""),m(""),v("pending"),_([])),L(""),D({}))},[t,r,n]);const A=l.useMemo(()=>[...a].sort((g,x)=>(g.username||g.email||"").localeCompare(x.username||x.email||"")),[a]),b=async()=>{const g=c.trim();if(!g){D({title:"Title is required"});return}const x=d.trim(),R={title:g,description:x.length>0?x:null,dueDate:f?new Date(f).toISOString():null,status:j,assigneeIds:w};r==="create"&&P.trim()&&(R.initialNote=P.trim()),await i(R)},N=r==="create"?"Create task":"Edit task";return e.jsxs(mt,{open:t,onClose:o,fullWidth:!0,maxWidth:"sm",children:[e.jsx(ft,{children:N}),e.jsx(xt,{children:e.jsxs(ke,{spacing:3,sx:{mt:1},children:[e.jsx(le,{label:"Title",value:c,onChange:g=>u(g.target.value),error:!!C.title,helperText:C.title,required:!0,autoFocus:!0}),e.jsx(le,{label:"Description",value:d,onChange:g=>p(g.target.value),multiline:!0,minRows:3}),e.jsx(le,{label:"Due date",type:"date",value:f,onChange:g=>m(g.target.value),InputLabelProps:{shrink:!0}}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{id:"task-status-select",children:"Status"}),e.jsx(Wt,{labelId:"task-status-select",value:j,label:"Status",onChange:g=>v(g.target.value),children:c1.map(g=>e.jsx(et,{value:g.value,children:g.label},g.value))})]}),e.jsxs(Mt,{fullWidth:!0,children:[e.jsx(Ut,{id:"task-assignees-label",children:"Assign to"}),e.jsx(Wt,{labelId:"task-assignees-label",multiple:!0,value:w.map(String),onChange:g=>{const x=g.target.value,R=typeof x=="string"?x.split(","):x;_(R.map(O=>Number(O)).filter(O=>!Number.isNaN(O)))},input:e.jsx(Yu,{label:"Assign to"}),renderValue:g=>{const x=g;return x.length===0?"No assignees":x.map(R=>{const O=A.find(ee=>ee.id===Number(R));return O?.username||O?.email||R}).join(", ")},children:A.map(g=>e.jsx(et,{value:String(g.id),children:e.jsx(fr,{primary:g.username||g.email})},g.id))})]}),r==="create"&&e.jsxs(k,{children:[e.jsx(h,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Initial note (optional)"}),e.jsx(le,{placeholder:"Share context with your team",value:P,onChange:g=>L(g.target.value),fullWidth:!0,multiline:!0,minRows:2})]})]})}),e.jsxs(_t,{children:[e.jsx(G,{onClick:o,disabled:s,children:"Cancel"}),e.jsx(G,{onClick:b,variant:"contained",disabled:s,children:r==="create"?"Create task":"Save changes"})]})]})};var Ka={},ku;function p1(){if(ku)return Ka;ku=1;var t=yt();Object.defineProperty(Ka,"__esModule",{value:!0}),Ka.default=void 0;var r=t(bt()),n=vt();return Ka.default=(0,r.default)((0,n.jsx)("path",{d:"M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2m0 16H5V10h14zM9 14H7v-2h2zm4 0h-2v-2h2zm4 0h-2v-2h2zm-8 4H7v-2h2zm4 0h-2v-2h2zm4 0h-2v-2h2z"}),"CalendarMonth"),Ka}var h1=p1();const m1=st(h1),f1={pending:"Pending",in_progress:"In Progress",completed:"Completed",archived:"Archived"},x1={pending:"warning",in_progress:"info",completed:"success",archived:"default"},g1=({tasks:t,loading:r,onSelectTask:n})=>{const a=l.useMemo(()=>{const m=new Map;return t.forEach(j=>{if(!j.dueDate)return;const v=$e(j.dueDate);if(!v.isValid())return;const w=v.format("YYYY-MM-DD"),_=m.get(w)??[];_.push(j),m.set(w,_)}),m.forEach(j=>{j.sort((v,w)=>{const _=$e(v.dueDate??0).valueOf(),P=$e(w.dueDate??0).valueOf();return _-P})}),m},[t]),s=l.useMemo(()=>{if(a.size===0)return $e();const m=$e().format("YYYY-MM-DD");if(a.has(m))return $e();const j=Array.from(a.keys()).sort()[0];return j?$e(j):$e()},[a]),[o,i]=l.useState(s);l.useEffect(()=>{const m=o.format("YYYY-MM-DD");if(a.size===0||a.has(m))return;const j=$e(),v=j.format("YYYY-MM-DD");if(a.has(v)){i(j);return}const w=Array.from(a.keys()).sort()[0];w&&i($e(w))},[o,a]);const c=o.format("YYYY-MM-DD"),u=a.get(c)??[],d=a.size>0,p=$e(),f=m=>{const j=m.day.format("YYYY-MM-DD"),v=a.get(j)??[],w=v.length>0,_=v.some(P=>P.dueDate&&$e(P.dueDate).isBefore(p)&&P.status!=="completed");return e.jsx(ii,{overlap:"circular",variant:w?"dot":"standard",color:_?"error":"primary",anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(dm,{...m,sx:{...w?{fontWeight:600}:null}})},j)};return e.jsx(kt,{sx:{borderRadius:3,border:"1px solid",borderColor:"divider",boxShadow:"0 24px 60px -36px rgba(15, 23, 42, 0.35)"},children:e.jsxs(Tt,{sx:{p:{xs:3,md:4}},children:[e.jsxs(ke,{direction:"row",spacing:1.5,alignItems:"center",mb:2,children:[e.jsx(m1,{color:"primary"}),e.jsx(h,{variant:"h5",component:"h2",sx:{fontWeight:600},children:"Due date calendar"})]}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Visualize upcoming deadlines and jump directly to the tasks that need your attention."}),e.jsxs(ke,{direction:{xs:"column",lg:"row"},spacing:{xs:3,lg:4},mt:3,alignItems:{xs:"stretch",lg:"flex-start"},children:[e.jsx(cm,{value:o,onChange:m=>m&&i(m),views:["day"],slots:{day:f},sx:{borderRadius:2,border:"1px solid",borderColor:"divider",p:1.5}}),e.jsxs(k,{sx:{flex:1,width:"100%"},children:[e.jsx(h,{variant:"subtitle1",sx:{fontWeight:600},children:o.format("MMMM D, YYYY")}),r?e.jsx(k,{display:"flex",justifyContent:"center",py:4,children:e.jsx(it,{size:28})}):d?u.length===0?e.jsx(k,{sx:{mt:2,p:3,borderRadius:2,border:"1px dashed",borderColor:"divider",textAlign:"center",color:"text.secondary"},children:e.jsx(h,{variant:"body2",children:"No tasks are due on this day. Select another date to explore upcoming work."})}):e.jsx(ke,{spacing:1.5,mt:2,children:u.map(m=>{const j=$e(m.dueDate),v=m.dueDate&&j.isBefore(p)&&m.status!=="completed";return e.jsx(k,{onClick:()=>n?.(m),role:n?"button":void 0,tabIndex:n?0:void 0,onKeyDown:w=>{n&&(w.key==="Enter"||w.key===" ")&&(w.preventDefault(),n(m))},sx:{p:2.25,borderRadius:2,border:"1px solid",borderColor:"divider",backgroundColor:"background.paper",cursor:n?"pointer":"default",transition:"all 0.2s ease-in-out","&:hover":n?{borderColor:"primary.main",boxShadow:3}:void 0},children:e.jsxs(ke,{spacing:1,children:[e.jsx(h,{variant:"subtitle1",sx:{fontWeight:600},children:m.title}),m.description&&e.jsx(h,{variant:"body2",color:"text.secondary",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:m.description}),e.jsxs(ke,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",useFlexGap:!0,children:[e.jsx(De,{label:f1[m.status],color:x1[m.status],size:"small"}),v&&e.jsx(De,{label:"Overdue",color:"error",size:"small",variant:"outlined"}),m.dueDate&&e.jsx(De,{label:`Due ${j.format("MMM D, YYYY")}`,color:"info",size:"small",variant:"outlined"})]})]})},m.id)})}):e.jsx(k,{sx:{mt:2,p:3,borderRadius:2,border:"1px dashed",borderColor:"divider",textAlign:"center",color:"text.secondary"},children:e.jsx(h,{variant:"body2",children:"None of your tasks have due dates yet. Add due dates to see them on the calendar."})})]})]})]})})},Pu=t=>[...t].sort((r,n)=>r-n),y1=(t,r)=>{if(t.length!==r.length)return!1;const n=Pu(t),a=Pu(r);return n.every((s,o)=>s===a[o])},Du={includeCompleted:!1,includeArchived:!1},v1=()=>{const[t,r]=l.useState([]),[n,a]=l.useState(Du),[s,o]=l.useState([]),[i,c]=l.useState(null),[u,d]=l.useState(!0),[p,f]=l.useState(null),[m,j]=l.useState(null),[v,w]=l.useState(!1),[_,P]=l.useState(!1),[L,C]=l.useState(!1),[D,A]=l.useState("create"),[b,N]=l.useState(!1),[g,x]=l.useState(null),R=l.useCallback(async()=>{d(!0),f(null);try{const[V,q]=await Promise.all([fv(n),Cl()]);r(V),c(q)}catch(V){console.error(V),f("Failed to load tasks. Please try again later.")}finally{d(!1)}},[n]),O=l.useCallback(async()=>{try{const V=await Cl();c(V)}catch(V){console.error("Failed to refresh task summary",V)}},[]);l.useEffect(()=>{R()},[R]),l.useEffect(()=>{(async()=>{try{const q=await wv();o(q)}catch(q){console.error(q),H.error("Unable to load team members")}})()},[]);const ee=V=>{a(V)},J=()=>{a(Du)},z=()=>{R()},Z=()=>{A("create"),x(null),C(!0)},Q=V=>{A("edit"),x(V),C(!0)},X=async V=>{P(!0);try{const q=await xv(V.id);j(q),w(!0)}catch(q){console.error(q),H.error("Unable to load task details")}finally{P(!1)}},I=l.useCallback(V=>{r(q=>q.some(ye=>ye.id===V.id)?q.map(ye=>ye.id===V.id?{...ye,...V}:ye):[V,...q])},[]),y=async V=>{try{if(N(!0),D==="create"){const q=await gv({...V,description:V.description??null});H.success("Task created successfully"),C(!1),x(null),I(q)}else if(D==="edit"&&g){const q=await yv(g.id,{title:V.title,description:V.description??null,status:V.status,dueDate:V.dueDate??null}),ue=g.assignees?.map(xe=>xe.id)??[],ge=!y1(ue,V.assigneeIds)?await vv(g.id,V.assigneeIds):{...q,assignees:g.assignees};H.success("Task updated successfully"),C(!1),x(null),I(ge),j(xe=>xe&&xe.id===ge.id?{...xe,...ge,notes:xe.notes}:xe)}await R()}catch(q){console.error(q),H.error("Failed to save task changes")}finally{N(!1)}},S=async(V,q)=>{try{const ue=await bv(V.id,q);I(ue),j(ye=>ye&&ye.id===ue.id?{...ye,...ue,notes:ye.notes}:ye),H.success(q?"Task marked as completed":"Task reopened"),await O()}catch(ue){console.error(ue),H.error("Failed to update task status")}},U=async V=>{if(window.confirm(`Delete task "${V.title}"? This action cannot be undone.`))try{await jv(V.id),r(ue=>ue.filter(ye=>ye.id!==V.id)),m?.id===V.id&&(w(!1),j(null)),H.success("Task deleted"),await R()}catch(ue){console.error(ue),H.error("Failed to delete task")}},K=async V=>{if(m)try{const q=await _v(m.id,V);j(ue=>ue&&{...ue,notes:[q,...ue.notes??[]],noteCount:(ue.noteCount??0)+1,lastNoteAt:q.createdAt}),r(ue=>ue.map(ye=>ye.id===m.id?{...ye,noteCount:ye.noteCount+1,lastNoteAt:q.createdAt}:ye)),H.success("Note added")}catch(q){console.error(q),H.error("Failed to add note")}},E=l.useMemo(()=>n,[n]);return e.jsxs(at,{maxWidth:"lg",sx:{py:4},children:[e.jsxs(ke,{spacing:3,children:[e.jsx(zp,{summary:i,loading:u&&t.length===0,onRefresh:z}),e.jsx(g1,{tasks:t,loading:u&&t.length===0,onSelectTask:X}),e.jsxs(Ae,{sx:{p:{xs:2.5,md:4},borderRadius:3,border:"1px solid",borderColor:"divider",boxShadow:"0 24px 60px -36px rgba(15, 23, 42, 0.45)",background:"linear-gradient(145deg, rgba(15, 118, 110, 0.04) 0%, rgba(30, 64, 175, 0.05) 100%)"},children:[e.jsxs(ke,{direction:{xs:"column",md:"row"},spacing:2,justifyContent:"space-between",alignItems:{xs:"flex-start",md:"center"},children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h4",gutterBottom:!0,children:"Tasks"}),e.jsx(h,{variant:"body2",color:"text.secondary",children:"Manage assignments, due dates, and shared notes for your team."})]}),e.jsxs(ke,{direction:"row",spacing:1,children:[e.jsx(G,{variant:"outlined",startIcon:e.jsx(jn,{}),onClick:z,children:"Refresh"}),e.jsx(G,{variant:"contained",startIcon:e.jsx(Lr,{}),onClick:Z,children:"New task"})]})]}),e.jsx(k,{sx:{mt:3},children:e.jsx(ZS,{filters:E,assignees:s,onChange:ee,onReset:J})}),p&&e.jsx(We,{severity:"error",sx:{mt:2},children:p}),e.jsx(k,{sx:{mt:3},children:u&&t.length===0?e.jsx(k,{display:"flex",justifyContent:"center",py:6,children:e.jsx(it,{})}):e.jsx(s1,{tasks:t,onSelect:X,onToggleComplete:S,onEdit:Q,onDelete:U})})]})]}),e.jsx(l1,{open:v,task:m,loading:_,onClose:()=>w(!1),onEdit:()=>{m&&Q(m)},onToggleComplete:V=>m?S(m,V):Promise.resolve(),onAddNote:K}),e.jsx(u1,{open:L,mode:D,initialTask:g,assignees:s,submitting:b,onClose:()=>C(!1),onSubmit:y})]})},b1=async(t="all")=>(await B.get("/api/return-orders",{params:{status:t}})).data,_1=async t=>(await B.get(`/api/return-orders/${t}`)).data,j1=async t=>(await B.post("/api/return-orders",t)).data,w1=async(t,r)=>{await B.put(`/api/return-orders/${t}`,r)},S1=async t=>(await B.get(`/api/return-orders/by-purchase/${t}`)).data,C1=async(t,r)=>{const a=(await B.get(`/api/return-orders/purchase/${t}/line-items`,{params:r?{excludeReturnId:r}:void 0})).data;return Array.isArray(a)?a:Array.isArray(a?.items)?a.items:Array.isArray(a?.available_items)?a.available_items:[]},Ch=t=>{window.open(`/api/return-orders/${t}/pdf`,"_blank")},k1=[{label:"All",value:"all"},{label:"Return Requested",value:"Requested"},{label:"Returned",value:"Returned"}],P1=()=>{const[t,r]=l.useState("Requested"),[n,a]=l.useState(""),[s,o]=l.useState([]),[i,c]=l.useState(!1),u=Kt(),d=l.useCallback(async()=>{c(!0);try{const m=await b1(t);o(m)}catch(m){console.error("Failed to load return orders",m),o([])}finally{c(!1)}},[t]);l.useEffect(()=>{d()},[d]);const p=l.useMemo(()=>{if(!n)return s;const m=n.toLowerCase();return s.filter(j=>j.return_number?.toLowerCase().includes(m)||j.purchase_number?.toLowerCase().includes(m)||j.vendor_name?.toLowerCase().includes(m))},[s,n]),f=[{field:"return_number",headerName:"Return #",flex:1,minWidth:150,renderCell:m=>e.jsx(h,{color:"primary",sx:{cursor:"pointer"},children:m.value})},{field:"purchase_number",headerName:"Purchase Order",flex:1,minWidth:150,renderCell:m=>e.jsx(h,{color:"primary",sx:{cursor:"pointer"},children:m.value||"-"})},{field:"vendor_name",headerName:"Vendor",flex:1.3,minWidth:160,valueGetter:m=>m.value||"No Vendor"},{field:"status",headerName:"Status",flex:.8,minWidth:130,renderCell:m=>e.jsx(De,{label:m.value,color:m.value==="Returned"?"success":"warning",variant:"outlined",size:"small"})},{field:"requested_at",headerName:"Requested On",flex:.9,minWidth:150,valueFormatter:m=>m.value?$e(m.value).format("YYYY-MM-DD HH:mm"):""},{field:"returned_at",headerName:"Returned On",flex:.9,minWidth:150,valueFormatter:m=>m.value?$e(m.value).format("YYYY-MM-DD HH:mm"):""},{field:"total_quantity",headerName:"Total Qty",flex:.6,minWidth:110,type:"number",valueFormatter:m=>Number(m.value??0).toFixed(2)},{field:"actions",headerName:"Actions",sortable:!1,filterable:!1,width:120,renderCell:m=>e.jsx(ke,{direction:"row",spacing:1,children:e.jsx(G,{size:"small",variant:"outlined",color:"primary",startIcon:e.jsx(yr,{fontSize:"small"}),onClick:j=>{j.stopPropagation(),Ch(Number(m.row.return_id))},children:"PDF"})})}];return e.jsx(at,{maxWidth:"xl",sx:{mt:4},children:e.jsxs(k,{sx:{mb:4},children:[e.jsx(h,{variant:"h4",component:"h1",gutterBottom:!0,children:"Return Orders"}),e.jsxs(ke,{direction:"row",spacing:2,sx:{mb:2,justifyContent:"flex-end"},children:[e.jsx(G,{variant:"contained",startIcon:e.jsx(Lr,{}),onClick:()=>u("/return-orders/new"),children:"New Return Order"}),e.jsx(G,{variant:"outlined",startIcon:e.jsx(jn,{}),onClick:d,disabled:i,children:"Refresh"})]}),e.jsx(Ae,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(k,{sx:{p:2},children:[e.jsxs(ke,{direction:"row",spacing:3,sx:{mb:3},children:[e.jsx(le,{label:"Search",variant:"outlined",value:n,onChange:m=>a(m.target.value),InputProps:{startAdornment:e.jsx(pr,{position:"start",children:e.jsx(Br,{sx:{fontSize:32}})}),sx:{fontSize:22,height:56}},sx:{minWidth:340,maxWidth:400,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"medium"}),k1.map(m=>e.jsx(De,{label:m.label,onClick:()=>r(m.value),color:t===m.value?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}},m.value))]}),e.jsx(Jr,{rows:p,columns:f,loading:i,getRowId:m=>m.return_id,disableRowSelectionOnClick:!0,onRowClick:m=>u(`/return-orders/${m.row.return_id}`),sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224,224,224,1)",cursor:"pointer"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224,224,224,1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"},cursor:"pointer"}})]})})]})})},D1=async t=>{try{return(await B.get("/api/purchase-history",{params:t})).data}catch(r){throw console.error("Error fetching purchase orders:",r),r}};function E1(){const t=cn();return l.useMemo(()=>new URLSearchParams(t.search),[t.search])}const Eu=()=>{const{id:t}=wn(),r=Kt(),n=E1(),a=!t||t==="new",[s,o]=l.useState(!0),[i,c]=l.useState(!1),[u,d]=l.useState([]),[p,f]=l.useState(null),[m,j]=l.useState("Requested"),[v,w]=l.useState(""),[_,P]=l.useState(void 0),[L,C]=l.useState(""),[D,A]=l.useState([]),[b,N]=l.useState(null),[g,x]=l.useState(null),[R,O]=l.useState({}),ee=l.useCallback(async()=>{try{const U=(await D1({status:"all"})).map(K=>({label:`${K.purchase_number}  ${K.vendor_name??"No Vendor"}`,purchase_id:K.purchase_id,purchase_number:K.purchase_number,vendor_name:K.vendor_name}));return d(U),U}catch(S){return console.error("Failed to load purchase orders",S),d([]),[]}},[]),J=l.useCallback(async S=>{try{const U=await S1(S),K=U.filter(V=>V.status==="Requested").length,E=U.filter(V=>V.status==="Returned").length;O(V=>({...V,[S]:{requested:K,returned:E}}))}catch(U){console.warn("Unable to load return summary for purchase",U)}},[]),z=l.useCallback(async(S,U,K)=>{try{const V=(await C1(S,K))?.map(q=>{const ue=U?.find(ye=>ye.purchase_line_item_id===q.line_item_id);return{purchase_line_item_id:q.line_item_id,part_number:q.part_number,part_description:q.part_description,unit:q.unit,quantityPurchased:q.quantity,returnable_quantity:q.returnable_quantity,already_requested:q.already_requested,inputQuantity:ue?String(ue.quantity):"",reason:ue?.reason??"",selected:!!ue}});A(V??[])}catch(E){console.error("Failed to load available return items",E),A([])}},[]);l.useEffect(()=>{(async()=>{const U=await ee(),K=n.get("purchaseId");if(!a&&t){try{const E=await _1(Number(t));N(E),j(E.status),w(E.requested_by??""),P(E.requested_at),C(E.notes??"");const V={label:`${E.purchase_number||""}  ${E.vendor_name||"No Vendor"}`,purchase_id:E.purchase_id,purchase_number:E.purchase_number||"",vendor_name:E.vendor_name||void 0};f(V),await z(E.purchase_id,E.line_items,E.return_id),await J(E.purchase_id)}catch(E){console.error("Failed to load return order detail",E),x("Unable to load return order.")}finally{o(!1)}return}if(K){const E=Number(K);if(Number.isFinite(E)){const q=(U.length?U:u).find(ue=>ue.purchase_id===E);q&&(f(q),await z(E),await J(E))}}o(!1)})()},[z,t,a,ee,J,n]);const Z=async(S,U)=>{f(U),U?(await z(U.purchase_id,b?.line_items,b?.return_id??void 0),await J(U.purchase_id)):A([])},Q=l.useMemo(()=>D.reduce((S,U)=>{if(!U.selected)return S;const K=parseFloat(U.inputQuantity||"0");return S+(Number.isFinite(K)?K:0)},0),[D]),X=l.useMemo(()=>D.some(S=>S.returnable_quantity>0),[D]),I=l.useMemo(()=>D.some(S=>S.selected),[D]),y=async()=>{if(x(null),!p){x("Select a purchase order before saving.");return}const S=D.filter(K=>K.selected).map(K=>({purchase_line_item_id:K.purchase_line_item_id,quantity:parseFloat(K.inputQuantity||"0"),reason:K.reason?.trim()?K.reason.trim():void 0,maxQuantity:K.returnable_quantity,part_number:K.part_number})).filter(K=>Number.isFinite(K.quantity)&&K.quantity>0);if(S.length===0){x("Select at least one part and enter a quantity to return.");return}for(const K of S)if(K.quantity>(K.maxQuantity??0)+1e-6){x(`Return quantity for part ${K.part_number} exceeds the available quantity.`);return}const U={purchase_id:p.purchase_id,status:m,requested_by:v||void 0,requested_at:_,notes:L||void 0,line_items:S.map(({purchase_line_item_id:K,quantity:E,reason:V})=>({purchase_line_item_id:K,quantity:E,reason:V}))};try{if(c(!0),a){const K=await j1(U);H.success(`Return order ${K.return_number} created.`)}else t&&(await w1(Number(t),{status:U.status,requested_by:U.requested_by,requested_at:U.requested_at,notes:U.notes,line_items:U.line_items}),H.success("Return order updated."));r("/return-orders")}catch(K){console.error("Failed to save return order",K);const E=K?.response?.data?.error||"Unable to save return order.";x(E),H.error(E)}finally{c(!1)}};return s?e.jsx(k,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"60vh",children:e.jsx(it,{})}):e.jsx(at,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(ke,{spacing:3,children:[e.jsxs(ke,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(k,{children:[e.jsx(h,{variant:"h4",component:"h1",children:a?"Create Return Order":`Return Order ${b?.return_number??""}`}),p&&e.jsxs(ke,{direction:"row",spacing:1,sx:{mt:1},children:[e.jsx(De,{label:`Purchase: ${p.purchase_number}`,color:"primary",variant:"outlined"}),e.jsx(De,{label:`Vendor: ${p.vendor_name??"No Vendor"}`,variant:"outlined",color:"secondary"}),R[p.purchase_id]&&e.jsx(De,{label:`Returns - Requested: ${R[p.purchase_id].requested}  Completed: ${R[p.purchase_id].returned}`,color:"default",variant:"outlined"})]})]}),e.jsxs(ke,{direction:{xs:"column",sm:"row"},spacing:2,children:[e.jsx(G,{variant:"outlined",startIcon:e.jsx(po,{}),onClick:()=>r("/return-orders"),children:"Back to List"}),!a&&t&&e.jsx(G,{variant:"outlined",startIcon:e.jsx(yr,{}),onClick:()=>Ch(Number(t)),children:"Download"}),e.jsx(G,{variant:"contained",startIcon:e.jsx(as,{}),onClick:y,disabled:i,children:i?"Saving":"Save & Close"})]})]}),g&&e.jsx(We,{severity:"error",children:g}),e.jsx(Ae,{sx:{p:3},elevation:1,children:e.jsxs(M,{container:!0,spacing:3,children:[e.jsx(M,{item:!0,xs:12,md:6,children:e.jsx($r,{options:u,value:p,onChange:Z,getOptionLabel:S=>S.label,renderInput:S=>e.jsx(le,{...S,label:"Purchase Order",placeholder:"Select purchase order"}),disabled:!a&&!!b})}),e.jsx(M,{item:!0,xs:12,md:3,children:e.jsxs(le,{select:!0,SelectProps:{native:!0},label:"Status",value:m,onChange:S=>j(S.target.value),fullWidth:!0,children:[e.jsx("option",{value:"Requested",children:"Requested"}),e.jsx("option",{value:"Returned",children:"Returned"})]})}),e.jsx(M,{item:!0,xs:12,md:3,children:e.jsx(le,{label:"Requested By",value:v,onChange:S=>w(S.target.value),fullWidth:!0})}),e.jsx(M,{item:!0,xs:12,md:6,children:e.jsx(le,{label:"Requested At",type:"datetime-local",fullWidth:!0,value:_?$e(_).format("YYYY-MM-DDTHH:mm"):"",onChange:S=>P(S.target.value?new Date(S.target.value).toISOString():void 0),helperText:"Optional timestamp for when the return was requested"})}),e.jsx(M,{item:!0,xs:12,children:e.jsx(le,{label:"Notes",value:L,onChange:S=>C(S.target.value),multiline:!0,rows:3,fullWidth:!0,placeholder:"Add any notes for the vendor or internal team"})})]})}),e.jsx(Ae,{sx:{p:3},elevation:1,children:e.jsxs(ke,{spacing:2,children:[e.jsxs(ke,{direction:{xs:"column",md:"row"},justifyContent:"space-between",alignItems:{xs:"flex-start",md:"center"},children:[e.jsx(h,{variant:"h6",children:"Return Line Items"}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:["Total Selected Quantity: ",Q.toFixed(2)]})]}),D.length>0&&e.jsx(h,{variant:"body2",color:"text.secondary",children:"Check the boxes to add parts to this return, then adjust the quantity being sent back."}),D.length===0?e.jsx(h,{variant:"body2",color:"text.secondary",children:"Select a purchase order to view parts eligible for return."}):e.jsxs(e.Fragment,{children:[!X&&e.jsx(We,{severity:"info",children:"All parts on this purchase order have already been requested for return."}),e.jsx(lr,{sx:{maxHeight:420},children:e.jsxs(nr,{size:"small",stickyHeader:!0,children:[e.jsx(sr,{children:e.jsxs(ht,{children:[e.jsx(ne,{padding:"checkbox",children:"Select"}),e.jsx(ne,{children:"Part Number"}),e.jsx(ne,{children:"Description"}),e.jsx(ne,{align:"right",children:"Purchased"}),e.jsx(ne,{align:"right",children:"Available"}),e.jsx(ne,{align:"right",children:"Qty to Return"}),e.jsx(ne,{children:"Reason"})]})}),e.jsx(ar,{children:D.map(S=>{const U=S.returnable_quantity<=0&&!S.selected;return e.jsxs(ht,{hover:!0,selected:S.selected,sx:{"&.Mui-selected":{backgroundColor:K=>K.palette.action.hover}},children:[e.jsx(ne,{padding:"checkbox",children:e.jsx(on,{checked:S.selected,onChange:K=>{const E=K.target.checked;A(V=>V.map(q=>{if(q.purchase_line_item_id!==S.purchase_line_item_id)return q;const ue=q.returnable_quantity>0?String(q.returnable_quantity):"";return{...q,selected:E,inputQuantity:E?q.inputQuantity||ue:"",reason:E?q.reason:""}}))},disabled:U,inputProps:{"aria-label":`Select ${S.part_number}`}})}),e.jsxs(ne,{children:[e.jsx(h,{variant:"body2",fontWeight:600,children:S.part_number}),S.unit&&e.jsxs(h,{variant:"caption",color:"text.secondary",display:"block",children:["Unit: ",S.unit]})]}),e.jsx(ne,{children:e.jsx(h,{variant:"body2",children:S.part_description||"-"})}),e.jsx(ne,{align:"right",children:e.jsx(h,{variant:"body2",children:S.quantityPurchased.toFixed(2)})}),e.jsxs(ne,{align:"right",children:[e.jsx(h,{variant:"body2",children:S.returnable_quantity.toFixed(2)}),S.already_requested>0&&e.jsxs(h,{variant:"caption",color:"text.secondary",display:"block",children:["Already requested: ",S.already_requested.toFixed(2)]})]}),e.jsx(ne,{align:"right",sx:{minWidth:140},children:e.jsx(le,{type:"number",size:"small",value:S.inputQuantity,onChange:K=>{const E=K.target.value;A(V=>V.map(q=>{if(q.purchase_line_item_id!==S.purchase_line_item_id)return q;const ue=parseFloat(E),ye=!Number.isNaN(ue)&&ue>0;return{...q,inputQuantity:E,selected:ye?!0:q.selected}}))},inputProps:{min:0,step:.01,max:S.returnable_quantity},fullWidth:!0,disabled:!S.selected})}),e.jsx(ne,{sx:{minWidth:200},children:e.jsx(le,{size:"small",value:S.reason,onChange:K=>{const E=K.target.value;A(V=>V.map(q=>q.purchase_line_item_id===S.purchase_line_item_id?{...q,reason:E}:q))},placeholder:"Optional",fullWidth:!0,disabled:!S.selected,multiline:!0,minRows:1})})]},S.purchase_line_item_id)})})]})})]}),D.length>0&&!I&&X&&e.jsx(We,{severity:"info",children:"Select at least one part to include it in the return order."})]})})]})})},I1=({children:t})=>{const{isAuthenticated:r,user:n}=Zt(),s=cn().pathname;if(!r)return e.jsx(_s,{to:"/login",replace:!0});if(n?.access_role==="Time Tracking"){if(s==="/"||s==="/dashboard")return e.jsx(_s,{to:"/attendance",replace:!0});if(s!=="/time-tracking"&&s!=="/attendance"&&s!=="/messaging"&&!s.startsWith("/open-sales-orders")&&!s.startsWith("/woker-sales-orders"))return e.jsx(_s,{to:"/attendance",replace:!0})}return n?.access_role==="Sales and Purchase"&&!["/","/open-sales-orders","/open-purchase-orders","/purchase-order","/return-orders","/parts-to-order","/inventory","/supply","/email-settings","/tasks","/messaging"].includes(s)&&!s.startsWith("/open-sales-orders/")&&!s.startsWith("/open-purchase-orders/")&&!s.startsWith("/purchase-order/")&&!s.startsWith("/return-orders/")?e.jsx(_s,{to:"/",replace:!0}):n?.access_role==="Quotes"&&s!=="/quotes"&&!s.startsWith("/quotes/")&&s!=="/messaging"?e.jsx(_s,{to:"/quotes",replace:!0}):e.jsx(e.Fragment,{children:t})},T1=()=>e.jsxs(pf,{children:[e.jsx(dt,{path:"/login",element:e.jsx(Xy,{})}),e.jsx(dt,{path:"/register",element:e.jsx(Zy,{})}),e.jsxs(dt,{path:"/",element:e.jsx(I1,{children:e.jsx(Jy,{})}),children:[e.jsx(dt,{index:!0,element:e.jsx(pd,{})}),e.jsx(dt,{path:"dashboard",element:e.jsx(pd,{})}),e.jsx(dt,{path:"business-profile",element:e.jsx(Tv,{})}),e.jsx(dt,{path:"qbo-account-mapping",element:e.jsx(OS,{})}),e.jsx(dt,{path:"customers",element:e.jsx(Zv,{})}),e.jsx(dt,{path:"customers/:id",element:e.jsx(eb,{})}),e.jsx(dt,{path:"products",element:e.jsx(kS,{})}),e.jsx(dt,{path:"products/:id",element:e.jsx(hb,{})}),e.jsx(dt,{path:"purchase-order",element:e.jsx(Zd,{})}),e.jsx(dt,{path:"purchase-order/:id",element:e.jsx(su,{})}),e.jsx(dt,{path:"open-purchase-orders",element:e.jsx(Zd,{})}),e.jsx(dt,{path:"open-purchase-orders/:id",element:e.jsx(su,{})}),e.jsx(dt,{path:"return-orders",element:e.jsx(P1,{})}),e.jsx(dt,{path:"return-orders/new",element:e.jsx(Eu,{})}),e.jsx(dt,{path:"return-orders/:id",element:e.jsx(Eu,{})}),e.jsx(dt,{path:"vendors",element:e.jsx(ub,{})}),e.jsx(dt,{path:"vendors/:id",element:e.jsx(pb,{})}),e.jsx(dt,{path:"inventory",element:e.jsx(Ib,{})}),e.jsx(dt,{path:"supply",element:e.jsx(Tb,{})}),e.jsx(dt,{path:"employees",element:e.jsx(tw,{})}),e.jsx(dt,{path:"profile-documents",element:e.jsx(rw,{})}),e.jsx(dt,{path:"time-tracking",element:e.jsx(aS,{})}),e.jsx(dt,{path:"attendance",element:e.jsx(ES,{})}),e.jsx(dt,{path:"time-tracking/reports",element:e.jsx(vS,{})}),e.jsx(dt,{path:"leave-management",element:e.jsx(jS,{})}),e.jsx(dt,{path:"leave-history",element:e.jsx(wS,{})}),e.jsx(dt,{path:"vacation-days-management",element:e.jsx(SS,{})}),e.jsx(dt,{path:"open-sales-orders",element:e.jsx(uw,{})}),e.jsx(dt,{path:"open-sales-orders/:id",element:e.jsx(hw,{})}),e.jsx(dt,{path:"woker-sales-orders",element:e.jsx(pu,{})}),e.jsx(dt,{path:"woker-sales-orders/:id",element:e.jsx(pu,{})}),e.jsx(dt,{path:"quotes",element:e.jsx(R0,{})}),e.jsx(dt,{path:"quotes/new",element:e.jsx(Yd,{})}),e.jsx(dt,{path:"quotes/:id",element:e.jsx(Yd,{})}),e.jsx(dt,{path:"margin-schedule",element:e.jsx(nw,{})}),e.jsx(dt,{path:"overhead-management",element:e.jsx(AS,{})}),e.jsx(dt,{path:"parts-to-order",element:e.jsx(MS,{})}),e.jsx(dt,{path:"tasks",element:e.jsx(v1,{})}),e.jsx(dt,{path:"backup-management",element:e.jsx(DS,{})}),e.jsx(dt,{path:"mobile-user-access",element:e.jsx(RS,{})}),e.jsx(dt,{path:"email-settings",element:e.jsx($S,{})}),e.jsx(dt,{path:"email-templates",element:e.jsx(zS,{})}),e.jsx(dt,{path:"tasks/:id",element:e.jsx(XS,{})}),e.jsx(dt,{path:"messaging",element:e.jsx(Z0,{})})]}),e.jsx(dt,{path:"*",element:e.jsx(_s,{to:"/",replace:!0})})]}),O1=()=>{const[t,r]=l.useState(0);return l.useEffect(()=>{window.__triggerSync=async()=>{try{await Xa()>0&&!window.__backendUnavailableSince&&(await od(),r(await Xa()))}catch{}};let n=!0;const a=async()=>{try{const o=await Xa();if(n&&r(o),!window.__backendUnavailableSince&&o>0){await od();const i=await Xa();n&&r(i)}}catch{}},s=setInterval(a,15e3);return a(),()=>{n=!1,clearInterval(s)}},[]),e.jsxs(um,{theme:sg,children:[e.jsx(pm,{}),e.jsx(tg,{children:e.jsx(ng,{children:e.jsxs(_n,{dateAdapter:ss,children:[e.jsx(vf,{children:e.jsx(T1,{})}),e.jsx(sy,{position:"top-right",autoClose:3e3,newestOnTop:!1,closeOnClick:!0,pauseOnFocusLoss:!0,draggable:!0,pauseOnHover:!0,theme:"colored"})]})})})]})};gm.createRoot(document.getElementById("root")).render(e.jsx(O1,{}));
