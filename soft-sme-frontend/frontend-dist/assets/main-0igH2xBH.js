import{r as l,R as Cd,j as e,c as kd,b as Pd,_ as Yc,F as Ed,B as Dd,C as Td,a as q,A as ni,d as Od,P as qe,T as f,e as ki,f as ie,I as ot,S as Id,D as si,g as K,h as Ad,i as it,k as Sn,l as ft,m as vn,n as ai,o as zn,p as Hn,q as hr,E as Fa,s as Uo,L as wr,t as Md,u as Sr,v as Rd,w as Cr,x as Nd,y as Vc,M as Ld,z as ar,G as qd,H as oi,J as Gc,K as ii,N as Qs,O as Qc,Q as Jc,U as Kc,V as Ud,W as Pi,X as $a,Y as Ei,Z as Qe,$ as Re,a0 as ra,a1 as Ba,a2 as Wd,a3 as T,a4 as Fd,a5 as rl,a6 as mt,a7 as wt,a8 as $d,a9 as At,aa as Mt,ab as tn,ac as tt,ad as nl,ae as lt,af as ct,ag as ut,ah as dt,ai as Xt,aj as Mr,ak as ze,al as Xc,am as Le,an as so,ao as Bd,ap as Ue,aq as Zc,ar as zr,as as Dt,at as Tt,au as Ot,av as Hr,aw as kr,ax as on,ay as Di,az as Kt,aA as Yt,aB as Vt,aC as rt,aD as re,aE as Gt,aF as zs,aG as $n,aH as zd,aI as eu,aJ as ao,aK as Hd,aL as za,aM as tu,aN as Yd,aO as oo,aP as Ti,aQ as ru,aR as li,aS as Yn,aT as Vn,aU as Vd,aV as Gd,aW as Qd,aX as Jd,aY as nu,aZ as Kd,a_ as Xd,a$ as su,b0 as Zd,b1 as Oi,b2 as sl,b3 as Wo,b4 as al,b5 as ep,b6 as tp,b7 as rp,b8 as ol,b9 as il,ba as np,bb as sp}from"./mui-N8tEc-Cl.js";import{a as ap,g as vt,b as op}from"./vendor-kq2j8kjo.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function s(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(n){if(n.ep)return;n.ep=!0;const o=s(n);fetch(n.href,o)}})();var ya={},ll;function ip(){if(ll)return ya;ll=1;var t=ap();return ya.createRoot=t.createRoot,ya.hydrateRoot=t.hydrateRoot,ya}var lp=ip();const cp=vt(lp);/**
 * @remix-run/router v1.23.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Js(){return Js=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var s=arguments[r];for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(t[a]=s[a])}return t},Js.apply(this,arguments)}var rn;(function(t){t.Pop="POP",t.Push="PUSH",t.Replace="REPLACE"})(rn||(rn={}));const cl="popstate";function up(t){t===void 0&&(t={});function r(n,o){let{pathname:i="/",search:c="",hash:u=""}=En(n.location.hash.substr(1));return!i.startsWith("/")&&!i.startsWith(".")&&(i="/"+i),ci("",{pathname:i,search:c,hash:u},o.state&&o.state.usr||null,o.state&&o.state.key||"default")}function s(n,o){let i=n.document.querySelector("base"),c="";if(i&&i.getAttribute("href")){let u=n.location.href,d=u.indexOf("#");c=d===-1?u:u.slice(0,d)}return c+"#"+(typeof o=="string"?o:Ha(o))}function a(n,o){Ii(n.pathname.charAt(0)==="/","relative pathnames are not supported in hash history.push("+JSON.stringify(o)+")")}return pp(r,s,a,t)}function Bt(t,r){if(t===!1||t===null||typeof t>"u")throw new Error(r)}function Ii(t,r){if(!t){typeof console<"u"&&console.warn(r);try{throw new Error(r)}catch{}}}function dp(){return Math.random().toString(36).substr(2,8)}function ul(t,r){return{usr:t.state,key:t.key,idx:r}}function ci(t,r,s,a){return s===void 0&&(s=null),Js({pathname:typeof t=="string"?t:t.pathname,search:"",hash:""},typeof r=="string"?En(r):r,{state:s,key:r&&r.key||a||dp()})}function Ha(t){let{pathname:r="/",search:s="",hash:a=""}=t;return s&&s!=="?"&&(r+=s.charAt(0)==="?"?s:"?"+s),a&&a!=="#"&&(r+=a.charAt(0)==="#"?a:"#"+a),r}function En(t){let r={};if(t){let s=t.indexOf("#");s>=0&&(r.hash=t.substr(s),t=t.substr(0,s));let a=t.indexOf("?");a>=0&&(r.search=t.substr(a),t=t.substr(0,a)),t&&(r.pathname=t)}return r}function pp(t,r,s,a){a===void 0&&(a={});let{window:n=document.defaultView,v5Compat:o=!1}=a,i=n.history,c=rn.Pop,u=null,d=p();d==null&&(d=0,i.replaceState(Js({},i.state,{idx:d}),""));function p(){return(i.state||{idx:null}).idx}function y(){c=rn.Pop;let b=p(),I=b==null?null:b-d;d=b,u&&u({action:c,location:E.location,delta:I})}function w(b,I){c=rn.Push;let U=ci(E.location,b,I);s&&s(U,b),d=p()+1;let S=ul(U,d),j=E.createHref(U);try{i.pushState(S,"",j)}catch(N){if(N instanceof DOMException&&N.name==="DataCloneError")throw N;n.location.assign(j)}o&&u&&u({action:c,location:E.location,delta:1})}function O(b,I){c=rn.Replace;let U=ci(E.location,b,I);s&&s(U,b),d=p();let S=ul(U,d),j=E.createHref(U);i.replaceState(S,"",j),o&&u&&u({action:c,location:E.location,delta:0})}function _(b){let I=n.location.origin!=="null"?n.location.origin:n.location.href,U=typeof b=="string"?b:Ha(b);return U=U.replace(/ $/,"%20"),Bt(I,"No window.location.(origin|href) available to create URL for href: "+U),new URL(U,I)}let E={get action(){return c},get location(){return t(n,i)},listen(b){if(u)throw new Error("A history only accepts one active listener");return n.addEventListener(cl,y),u=b,()=>{n.removeEventListener(cl,y),u=null}},createHref(b){return r(n,b)},createURL:_,encodeLocation(b){let I=_(b);return{pathname:I.pathname,search:I.search,hash:I.hash}},push:w,replace:O,go(b){return i.go(b)}};return E}var dl;(function(t){t.data="data",t.deferred="deferred",t.redirect="redirect",t.error="error"})(dl||(dl={}));function hp(t,r,s){return s===void 0&&(s="/"),mp(t,r,s)}function mp(t,r,s,a){let n=typeof r=="string"?En(r):r,o=Ai(n.pathname||"/",s);if(o==null)return null;let i=au(t);fp(i);let c=null;for(let u=0;c==null&&u<i.length;++u){let d=Pp(o);c=Sp(i[u],d)}return c}function au(t,r,s,a){r===void 0&&(r=[]),s===void 0&&(s=[]),a===void 0&&(a="");let n=(o,i,c)=>{let u={relativePath:c===void 0?o.path||"":c,caseSensitive:o.caseSensitive===!0,childrenIndex:i,route:o};u.relativePath.startsWith("/")&&(Bt(u.relativePath.startsWith(a),'Absolute route path "'+u.relativePath+'" nested under path '+('"'+a+'" is not valid. An absolute child route path ')+"must start with the combined path of all its parent routes."),u.relativePath=u.relativePath.slice(a.length));let d=sn([a,u.relativePath]),p=s.concat(u);o.children&&o.children.length>0&&(Bt(o.index!==!0,"Index routes must not have child routes. Please remove "+('all child routes from route path "'+d+'".')),au(o.children,r,p,d)),!(o.path==null&&!o.index)&&r.push({path:d,score:jp(d,o.index),routesMeta:p})};return t.forEach((o,i)=>{var c;if(o.path===""||!((c=o.path)!=null&&c.includes("?")))n(o,i);else for(let u of ou(o.path))n(o,i,u)}),r}function ou(t){let r=t.split("/");if(r.length===0)return[];let[s,...a]=r,n=s.endsWith("?"),o=s.replace(/\?$/,"");if(a.length===0)return n?[o,""]:[o];let i=ou(a.join("/")),c=[];return c.push(...i.map(u=>u===""?o:[o,u].join("/"))),n&&c.push(...i),c.map(u=>t.startsWith("/")&&u===""?"/":u)}function fp(t){t.sort((r,s)=>r.score!==s.score?s.score-r.score:wp(r.routesMeta.map(a=>a.childrenIndex),s.routesMeta.map(a=>a.childrenIndex)))}const gp=/^:[\w-]+$/,xp=3,yp=2,vp=1,_p=10,bp=-2,pl=t=>t==="*";function jp(t,r){let s=t.split("/"),a=s.length;return s.some(pl)&&(a+=bp),r&&(a+=yp),s.filter(n=>!pl(n)).reduce((n,o)=>n+(gp.test(o)?xp:o===""?vp:_p),a)}function wp(t,r){return t.length===r.length&&t.slice(0,-1).every((a,n)=>a===r[n])?t[t.length-1]-r[r.length-1]:0}function Sp(t,r,s){let{routesMeta:a}=t,n={},o="/",i=[];for(let c=0;c<a.length;++c){let u=a[c],d=c===a.length-1,p=o==="/"?r:r.slice(o.length)||"/",y=Cp({path:u.relativePath,caseSensitive:u.caseSensitive,end:d},p),w=u.route;if(!y)return null;Object.assign(n,y.params),i.push({params:n,pathname:sn([o,y.pathname]),pathnameBase:Op(sn([o,y.pathnameBase])),route:w}),y.pathnameBase!=="/"&&(o=sn([o,y.pathnameBase]))}return i}function Cp(t,r){typeof t=="string"&&(t={path:t,caseSensitive:!1,end:!0});let[s,a]=kp(t.path,t.caseSensitive,t.end),n=r.match(s);if(!n)return null;let o=n[0],i=o.replace(/(.)\/+$/,"$1"),c=n.slice(1);return{params:a.reduce((d,p,y)=>{let{paramName:w,isOptional:O}=p;if(w==="*"){let E=c[y]||"";i=o.slice(0,o.length-E.length).replace(/(.)\/+$/,"$1")}const _=c[y];return O&&!_?d[w]=void 0:d[w]=(_||"").replace(/%2F/g,"/"),d},{}),pathname:o,pathnameBase:i,pattern:t}}function kp(t,r,s){r===void 0&&(r=!1),s===void 0&&(s=!0),Ii(t==="*"||!t.endsWith("*")||t.endsWith("/*"),'Route path "'+t+'" will be treated as if it were '+('"'+t.replace(/\*$/,"/*")+'" because the `*` character must ')+"always follow a `/` in the pattern. To get rid of this warning, "+('please change the route path to "'+t.replace(/\*$/,"/*")+'".'));let a=[],n="^"+t.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(i,c,u)=>(a.push({paramName:c,isOptional:u!=null}),u?"/?([^\\/]+)?":"/([^\\/]+)"));return t.endsWith("*")?(a.push({paramName:"*"}),n+=t==="*"||t==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):s?n+="\\/*$":t!==""&&t!=="/"&&(n+="(?:(?=\\/|$))"),[new RegExp(n,r?void 0:"i"),a]}function Pp(t){try{return t.split("/").map(r=>decodeURIComponent(r).replace(/\//g,"%2F")).join("/")}catch(r){return Ii(!1,'The URL path "'+t+'" could not be decoded because it is is a malformed URL segment. This is probably due to a bad percent '+("encoding ("+r+").")),t}}function Ai(t,r){if(r==="/")return t;if(!t.toLowerCase().startsWith(r.toLowerCase()))return null;let s=r.endsWith("/")?r.length-1:r.length,a=t.charAt(s);return a&&a!=="/"?null:t.slice(s)||"/"}function Ep(t,r){r===void 0&&(r="/");let{pathname:s,search:a="",hash:n=""}=typeof t=="string"?En(t):t;return{pathname:s?s.startsWith("/")?s:Dp(s,r):r,search:Ip(a),hash:Ap(n)}}function Dp(t,r){let s=r.replace(/\/+$/,"").split("/");return t.split("/").forEach(n=>{n===".."?s.length>1&&s.pop():n!=="."&&s.push(n)}),s.length>1?s.join("/"):"/"}function Fo(t,r,s,a){return"Cannot include a '"+t+"' character in a manually specified "+("`to."+r+"` field ["+JSON.stringify(a)+"].  Please separate it out to the ")+("`to."+s+"` field. Alternatively you may provide the full path as ")+'a string in <Link to="..."> and the router will parse it for you.'}function Tp(t){return t.filter((r,s)=>s===0||r.route.path&&r.route.path.length>0)}function Mi(t,r){let s=Tp(t);return r?s.map((a,n)=>n===s.length-1?a.pathname:a.pathnameBase):s.map(a=>a.pathnameBase)}function Ri(t,r,s,a){a===void 0&&(a=!1);let n;typeof t=="string"?n=En(t):(n=Js({},t),Bt(!n.pathname||!n.pathname.includes("?"),Fo("?","pathname","search",n)),Bt(!n.pathname||!n.pathname.includes("#"),Fo("#","pathname","hash",n)),Bt(!n.search||!n.search.includes("#"),Fo("#","search","hash",n)));let o=t===""||n.pathname==="",i=o?"/":n.pathname,c;if(i==null)c=s;else{let y=r.length-1;if(!a&&i.startsWith("..")){let w=i.split("/");for(;w[0]==="..";)w.shift(),y-=1;n.pathname=w.join("/")}c=y>=0?r[y]:"/"}let u=Ep(n,c),d=i&&i!=="/"&&i.endsWith("/"),p=(o||i===".")&&s.endsWith("/");return!u.pathname.endsWith("/")&&(d||p)&&(u.pathname+="/"),u}const sn=t=>t.join("/").replace(/\/\/+/g,"/"),Op=t=>t.replace(/\/+$/,"").replace(/^\/*/,"/"),Ip=t=>!t||t==="?"?"":t.startsWith("?")?t:"?"+t,Ap=t=>!t||t==="#"?"":t.startsWith("#")?t:"#"+t;function Mp(t){return t!=null&&typeof t.status=="number"&&typeof t.statusText=="string"&&typeof t.internal=="boolean"&&"data"in t}const iu=["post","put","patch","delete"];new Set(iu);const Rp=["get",...iu];new Set(Rp);/**
 * React Router v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Ks(){return Ks=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var s=arguments[r];for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(t[a]=s[a])}return t},Ks.apply(this,arguments)}const Ni=l.createContext(null),Np=l.createContext(null),ln=l.createContext(null),io=l.createContext(null),Rr=l.createContext({outlet:null,matches:[],isDataRoute:!1}),lu=l.createContext(null);function Lp(t,r){let{relative:s}=r===void 0?{}:r;Xn()||Bt(!1);let{basename:a,navigator:n}=l.useContext(ln),{hash:o,pathname:i,search:c}=uu(t,{relative:s}),u=i;return a!=="/"&&(u=i==="/"?a:sn([a,i])),n.createHref({pathname:u,search:c,hash:o})}function Xn(){return l.useContext(io)!=null}function cn(){return Xn()||Bt(!1),l.useContext(io).location}function cu(t){l.useContext(ln).static||l.useLayoutEffect(t)}function qt(){let{isDataRoute:t}=l.useContext(Rr);return t?Xp():qp()}function qp(){Xn()||Bt(!1);let t=l.useContext(Ni),{basename:r,future:s,navigator:a}=l.useContext(ln),{matches:n}=l.useContext(Rr),{pathname:o}=cn(),i=JSON.stringify(Mi(n,s.v7_relativeSplatPath)),c=l.useRef(!1);return cu(()=>{c.current=!0}),l.useCallback(function(d,p){if(p===void 0&&(p={}),!c.current)return;if(typeof d=="number"){a.go(d);return}let y=Ri(d,JSON.parse(i),o,p.relative==="path");t==null&&r!=="/"&&(y.pathname=y.pathname==="/"?r:sn([r,y.pathname])),(p.replace?a.replace:a.push)(y,p.state,p)},[r,a,i,o,t])}const Up=l.createContext(null);function Wp(t){let r=l.useContext(Rr).outlet;return r&&l.createElement(Up.Provider,{value:t},r)}function Dn(){let{matches:t}=l.useContext(Rr),r=t[t.length-1];return r?r.params:{}}function uu(t,r){let{relative:s}=r===void 0?{}:r,{future:a}=l.useContext(ln),{matches:n}=l.useContext(Rr),{pathname:o}=cn(),i=JSON.stringify(Mi(n,a.v7_relativeSplatPath));return l.useMemo(()=>Ri(t,JSON.parse(i),o,s==="path"),[t,i,o,s])}function Fp(t,r){return $p(t,r)}function $p(t,r,s,a){Xn()||Bt(!1);let{navigator:n}=l.useContext(ln),{matches:o}=l.useContext(Rr),i=o[o.length-1],c=i?i.params:{};i&&i.pathname;let u=i?i.pathnameBase:"/";i&&i.route;let d=cn(),p;if(r){var y;let b=typeof r=="string"?En(r):r;u==="/"||(y=b.pathname)!=null&&y.startsWith(u)||Bt(!1),p=b}else p=d;let w=p.pathname||"/",O=w;if(u!=="/"){let b=u.replace(/^\//,"").split("/");O="/"+w.replace(/^\//,"").split("/").slice(b.length).join("/")}let _=hp(t,{pathname:O}),E=Vp(_&&_.map(b=>Object.assign({},b,{params:Object.assign({},c,b.params),pathname:sn([u,n.encodeLocation?n.encodeLocation(b.pathname).pathname:b.pathname]),pathnameBase:b.pathnameBase==="/"?u:sn([u,n.encodeLocation?n.encodeLocation(b.pathnameBase).pathname:b.pathnameBase])})),o,s,a);return r&&E?l.createElement(io.Provider,{value:{location:Ks({pathname:"/",search:"",hash:"",state:null,key:"default"},p),navigationType:rn.Pop}},E):E}function Bp(){let t=Kp(),r=Mp(t)?t.status+" "+t.statusText:t instanceof Error?t.message:JSON.stringify(t),s=t instanceof Error?t.stack:null,n={padding:"0.5rem",backgroundColor:"rgba(200,200,200, 0.5)"};return l.createElement(l.Fragment,null,l.createElement("h2",null,"Unexpected Application Error!"),l.createElement("h3",{style:{fontStyle:"italic"}},r),s?l.createElement("pre",{style:n},s):null,null)}const zp=l.createElement(Bp,null);class Hp extends l.Component{constructor(r){super(r),this.state={location:r.location,revalidation:r.revalidation,error:r.error}}static getDerivedStateFromError(r){return{error:r}}static getDerivedStateFromProps(r,s){return s.location!==r.location||s.revalidation!=="idle"&&r.revalidation==="idle"?{error:r.error,location:r.location,revalidation:r.revalidation}:{error:r.error!==void 0?r.error:s.error,location:s.location,revalidation:r.revalidation||s.revalidation}}componentDidCatch(r,s){console.error("React Router caught the following error during render",r,s)}render(){return this.state.error!==void 0?l.createElement(Rr.Provider,{value:this.props.routeContext},l.createElement(lu.Provider,{value:this.state.error,children:this.props.component})):this.props.children}}function Yp(t){let{routeContext:r,match:s,children:a}=t,n=l.useContext(Ni);return n&&n.static&&n.staticContext&&(s.route.errorElement||s.route.ErrorBoundary)&&(n.staticContext._deepestRenderedBoundaryId=s.route.id),l.createElement(Rr.Provider,{value:r},a)}function Vp(t,r,s,a){var n;if(r===void 0&&(r=[]),s===void 0&&(s=null),a===void 0&&(a=null),t==null){var o;if(!s)return null;if(s.errors)t=s.matches;else if((o=a)!=null&&o.v7_partialHydration&&r.length===0&&!s.initialized&&s.matches.length>0)t=s.matches;else return null}let i=t,c=(n=s)==null?void 0:n.errors;if(c!=null){let p=i.findIndex(y=>y.route.id&&c?.[y.route.id]!==void 0);p>=0||Bt(!1),i=i.slice(0,Math.min(i.length,p+1))}let u=!1,d=-1;if(s&&a&&a.v7_partialHydration)for(let p=0;p<i.length;p++){let y=i[p];if((y.route.HydrateFallback||y.route.hydrateFallbackElement)&&(d=p),y.route.id){let{loaderData:w,errors:O}=s,_=y.route.loader&&w[y.route.id]===void 0&&(!O||O[y.route.id]===void 0);if(y.route.lazy||_){u=!0,d>=0?i=i.slice(0,d+1):i=[i[0]];break}}}return i.reduceRight((p,y,w)=>{let O,_=!1,E=null,b=null;s&&(O=c&&y.route.id?c[y.route.id]:void 0,E=y.route.errorElement||zp,u&&(d<0&&w===0?(Zp("route-fallback"),_=!0,b=null):d===w&&(_=!0,b=y.route.hydrateFallbackElement||null)));let I=r.concat(i.slice(0,w+1)),U=()=>{let S;return O?S=E:_?S=b:y.route.Component?S=l.createElement(y.route.Component,null):y.route.element?S=y.route.element:S=p,l.createElement(Yp,{match:y,routeContext:{outlet:p,matches:I,isDataRoute:s!=null},children:S})};return s&&(y.route.ErrorBoundary||y.route.errorElement||w===0)?l.createElement(Hp,{location:s.location,revalidation:s.revalidation,component:E,error:O,children:U(),routeContext:{outlet:null,matches:I,isDataRoute:!0}}):U()},null)}var du=function(t){return t.UseBlocker="useBlocker",t.UseRevalidator="useRevalidator",t.UseNavigateStable="useNavigate",t}(du||{}),pu=function(t){return t.UseBlocker="useBlocker",t.UseLoaderData="useLoaderData",t.UseActionData="useActionData",t.UseRouteError="useRouteError",t.UseNavigation="useNavigation",t.UseRouteLoaderData="useRouteLoaderData",t.UseMatches="useMatches",t.UseRevalidator="useRevalidator",t.UseNavigateStable="useNavigate",t.UseRouteId="useRouteId",t}(pu||{});function Gp(t){let r=l.useContext(Ni);return r||Bt(!1),r}function Qp(t){let r=l.useContext(Np);return r||Bt(!1),r}function Jp(t){let r=l.useContext(Rr);return r||Bt(!1),r}function hu(t){let r=Jp(),s=r.matches[r.matches.length-1];return s.route.id||Bt(!1),s.route.id}function Kp(){var t;let r=l.useContext(lu),s=Qp(),a=hu();return r!==void 0?r:(t=s.errors)==null?void 0:t[a]}function Xp(){let{router:t}=Gp(du.UseNavigateStable),r=hu(pu.UseNavigateStable),s=l.useRef(!1);return cu(()=>{s.current=!0}),l.useCallback(function(n,o){o===void 0&&(o={}),s.current&&(typeof n=="number"?t.navigate(n):t.navigate(n,Ks({fromRouteId:r},o)))},[t,r])}const hl={};function Zp(t,r,s){hl[t]||(hl[t]=!0)}function eh(t,r){t?.v7_startTransition,t?.v7_relativeSplatPath}function Fn(t){let{to:r,replace:s,state:a,relative:n}=t;Xn()||Bt(!1);let{future:o,static:i}=l.useContext(ln),{matches:c}=l.useContext(Rr),{pathname:u}=cn(),d=qt(),p=Ri(r,Mi(c,o.v7_relativeSplatPath),u,n==="path"),y=JSON.stringify(p);return l.useEffect(()=>d(JSON.parse(y),{replace:s,state:a,relative:n}),[d,y,n,s,a]),null}function th(t){return Wp(t.context)}function nt(t){Bt(!1)}function rh(t){let{basename:r="/",children:s=null,location:a,navigationType:n=rn.Pop,navigator:o,static:i=!1,future:c}=t;Xn()&&Bt(!1);let u=r.replace(/^\/*/,"/"),d=l.useMemo(()=>({basename:u,navigator:o,static:i,future:Ks({v7_relativeSplatPath:!1},c)}),[u,c,o,i]);typeof a=="string"&&(a=En(a));let{pathname:p="/",search:y="",hash:w="",state:O=null,key:_="default"}=a,E=l.useMemo(()=>{let b=Ai(p,u);return b==null?null:{location:{pathname:b,search:y,hash:w,state:O,key:_},navigationType:n}},[u,p,y,w,O,_,n]);return E==null?null:l.createElement(ln.Provider,{value:d},l.createElement(io.Provider,{children:s,value:E}))}function nh(t){let{children:r,location:s}=t;return Fp(ui(r),s)}new Promise(()=>{});function ui(t,r){r===void 0&&(r=[]);let s=[];return l.Children.forEach(t,(a,n)=>{if(!l.isValidElement(a))return;let o=[...r,n];if(a.type===l.Fragment){s.push.apply(s,ui(a.props.children,o));return}a.type!==nt&&Bt(!1),!a.props.index||!a.props.children||Bt(!1);let i={id:a.props.id||o.join("-"),caseSensitive:a.props.caseSensitive,element:a.props.element,Component:a.props.Component,index:a.props.index,path:a.props.path,loader:a.props.loader,action:a.props.action,errorElement:a.props.errorElement,ErrorBoundary:a.props.ErrorBoundary,hasErrorBoundary:a.props.ErrorBoundary!=null||a.props.errorElement!=null,shouldRevalidate:a.props.shouldRevalidate,handle:a.props.handle,lazy:a.props.lazy};a.props.children&&(i.children=ui(a.props.children,o)),s.push(i)}),s}/**
 * React Router DOM v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function di(){return di=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var s=arguments[r];for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(t[a]=s[a])}return t},di.apply(this,arguments)}function sh(t,r){if(t==null)return{};var s={},a=Object.keys(t),n,o;for(o=0;o<a.length;o++)n=a[o],!(r.indexOf(n)>=0)&&(s[n]=t[n]);return s}function ah(t){return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}function oh(t,r){return t.button===0&&(!r||r==="_self")&&!ah(t)}const ih=["onClick","relative","reloadDocument","replace","state","target","to","preventScrollReset","viewTransition"],lh="6";try{window.__reactRouterVersion=lh}catch{}const ch="startTransition",ml=Cd[ch];function uh(t){let{basename:r,children:s,future:a,window:n}=t,o=l.useRef();o.current==null&&(o.current=up({window:n,v5Compat:!0}));let i=o.current,[c,u]=l.useState({action:i.action,location:i.location}),{v7_startTransition:d}=a||{},p=l.useCallback(y=>{d&&ml?ml(()=>u(y)):u(y)},[u,d]);return l.useLayoutEffect(()=>i.listen(p),[i,p]),l.useEffect(()=>eh(a),[a]),l.createElement(rh,{basename:r,children:s,location:c.location,navigationType:c.action,navigator:i,future:a})}const dh=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u",ph=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,hh=l.forwardRef(function(r,s){let{onClick:a,relative:n,reloadDocument:o,replace:i,state:c,target:u,to:d,preventScrollReset:p,viewTransition:y}=r,w=sh(r,ih),{basename:O}=l.useContext(ln),_,E=!1;if(typeof d=="string"&&ph.test(d)&&(_=d,dh))try{let S=new URL(window.location.href),j=d.startsWith("//")?new URL(S.protocol+d):new URL(d),N=Ai(j.pathname,O);j.origin===S.origin&&N!=null?d=N+j.search+j.hash:E=!0}catch{}let b=Lp(d,{relative:n}),I=mh(d,{replace:i,state:c,target:u,preventScrollReset:p,relative:n,viewTransition:y});function U(S){a&&a(S),S.defaultPrevented||I(S)}return l.createElement("a",di({},w,{href:_||b,onClick:E||o?a:U,ref:s,target:u}))});var fl;(function(t){t.UseScrollRestoration="useScrollRestoration",t.UseSubmit="useSubmit",t.UseSubmitFetcher="useSubmitFetcher",t.UseFetcher="useFetcher",t.useViewTransitionState="useViewTransitionState"})(fl||(fl={}));var gl;(function(t){t.UseFetcher="useFetcher",t.UseFetchers="useFetchers",t.UseScrollRestoration="useScrollRestoration"})(gl||(gl={}));function mh(t,r){let{target:s,replace:a,state:n,preventScrollReset:o,relative:i,viewTransition:c}=r===void 0?{}:r,u=qt(),d=cn(),p=uu(t,{relative:i});return l.useCallback(y=>{if(oh(y,s)){y.preventDefault();let w=a!==void 0?a:Ha(d)===Ha(p);u(t,{replace:w,state:n,preventScrollReset:o,relative:i,viewTransition:c})}},[d,u,p,a,n,s,t,o,i,c])}function mu(t,r){return function(){return t.apply(r,arguments)}}const{toString:fh}=Object.prototype,{getPrototypeOf:Li}=Object,{iterator:lo,toStringTag:fu}=Symbol,co=(t=>r=>{const s=fh.call(r);return t[s]||(t[s]=s.slice(8,-1).toLowerCase())})(Object.create(null)),Pr=t=>(t=t.toLowerCase(),r=>co(r)===t),uo=t=>r=>typeof r===t,{isArray:Zn}=Array,Xs=uo("undefined");function gh(t){return t!==null&&!Xs(t)&&t.constructor!==null&&!Xs(t.constructor)&&cr(t.constructor.isBuffer)&&t.constructor.isBuffer(t)}const gu=Pr("ArrayBuffer");function xh(t){let r;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?r=ArrayBuffer.isView(t):r=t&&t.buffer&&gu(t.buffer),r}const yh=uo("string"),cr=uo("function"),xu=uo("number"),po=t=>t!==null&&typeof t=="object",vh=t=>t===!0||t===!1,Ea=t=>{if(co(t)!=="object")return!1;const r=Li(t);return(r===null||r===Object.prototype||Object.getPrototypeOf(r)===null)&&!(fu in t)&&!(lo in t)},_h=Pr("Date"),bh=Pr("File"),jh=Pr("Blob"),wh=Pr("FileList"),Sh=t=>po(t)&&cr(t.pipe),Ch=t=>{let r;return t&&(typeof FormData=="function"&&t instanceof FormData||cr(t.append)&&((r=co(t))==="formdata"||r==="object"&&cr(t.toString)&&t.toString()==="[object FormData]"))},kh=Pr("URLSearchParams"),[Ph,Eh,Dh,Th]=["ReadableStream","Request","Response","Headers"].map(Pr),Oh=t=>t.trim?t.trim():t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function na(t,r,{allOwnKeys:s=!1}={}){if(t===null||typeof t>"u")return;let a,n;if(typeof t!="object"&&(t=[t]),Zn(t))for(a=0,n=t.length;a<n;a++)r.call(null,t[a],a,t);else{const o=s?Object.getOwnPropertyNames(t):Object.keys(t),i=o.length;let c;for(a=0;a<i;a++)c=o[a],r.call(null,t[c],c,t)}}function yu(t,r){r=r.toLowerCase();const s=Object.keys(t);let a=s.length,n;for(;a-- >0;)if(n=s[a],r===n.toLowerCase())return n;return null}const _n=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,vu=t=>!Xs(t)&&t!==_n;function pi(){const{caseless:t}=vu(this)&&this||{},r={},s=(a,n)=>{const o=t&&yu(r,n)||n;Ea(r[o])&&Ea(a)?r[o]=pi(r[o],a):Ea(a)?r[o]=pi({},a):Zn(a)?r[o]=a.slice():r[o]=a};for(let a=0,n=arguments.length;a<n;a++)arguments[a]&&na(arguments[a],s);return r}const Ih=(t,r,s,{allOwnKeys:a}={})=>(na(r,(n,o)=>{s&&cr(n)?t[o]=mu(n,s):t[o]=n},{allOwnKeys:a}),t),Ah=t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),Mh=(t,r,s,a)=>{t.prototype=Object.create(r.prototype,a),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:r.prototype}),s&&Object.assign(t.prototype,s)},Rh=(t,r,s,a)=>{let n,o,i;const c={};if(r=r||{},t==null)return r;do{for(n=Object.getOwnPropertyNames(t),o=n.length;o-- >0;)i=n[o],(!a||a(i,t,r))&&!c[i]&&(r[i]=t[i],c[i]=!0);t=s!==!1&&Li(t)}while(t&&(!s||s(t,r))&&t!==Object.prototype);return r},Nh=(t,r,s)=>{t=String(t),(s===void 0||s>t.length)&&(s=t.length),s-=r.length;const a=t.indexOf(r,s);return a!==-1&&a===s},Lh=t=>{if(!t)return null;if(Zn(t))return t;let r=t.length;if(!xu(r))return null;const s=new Array(r);for(;r-- >0;)s[r]=t[r];return s},qh=(t=>r=>t&&r instanceof t)(typeof Uint8Array<"u"&&Li(Uint8Array)),Uh=(t,r)=>{const a=(t&&t[lo]).call(t);let n;for(;(n=a.next())&&!n.done;){const o=n.value;r.call(t,o[0],o[1])}},Wh=(t,r)=>{let s;const a=[];for(;(s=t.exec(r))!==null;)a.push(s);return a},Fh=Pr("HTMLFormElement"),$h=t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(s,a,n){return a.toUpperCase()+n}),xl=(({hasOwnProperty:t})=>(r,s)=>t.call(r,s))(Object.prototype),Bh=Pr("RegExp"),_u=(t,r)=>{const s=Object.getOwnPropertyDescriptors(t),a={};na(s,(n,o)=>{let i;(i=r(n,o,t))!==!1&&(a[o]=i||n)}),Object.defineProperties(t,a)},zh=t=>{_u(t,(r,s)=>{if(cr(t)&&["arguments","caller","callee"].indexOf(s)!==-1)return!1;const a=t[s];if(cr(a)){if(r.enumerable=!1,"writable"in r){r.writable=!1;return}r.set||(r.set=()=>{throw Error("Can not rewrite read-only method '"+s+"'")})}})},Hh=(t,r)=>{const s={},a=n=>{n.forEach(o=>{s[o]=!0})};return Zn(t)?a(t):a(String(t).split(r)),s},Yh=()=>{},Vh=(t,r)=>t!=null&&Number.isFinite(t=+t)?t:r;function Gh(t){return!!(t&&cr(t.append)&&t[fu]==="FormData"&&t[lo])}const Qh=t=>{const r=new Array(10),s=(a,n)=>{if(po(a)){if(r.indexOf(a)>=0)return;if(!("toJSON"in a)){r[n]=a;const o=Zn(a)?[]:{};return na(a,(i,c)=>{const u=s(i,n+1);!Xs(u)&&(o[c]=u)}),r[n]=void 0,o}}return a};return s(t,0)},Jh=Pr("AsyncFunction"),Kh=t=>t&&(po(t)||cr(t))&&cr(t.then)&&cr(t.catch),bu=((t,r)=>t?setImmediate:r?((s,a)=>(_n.addEventListener("message",({source:n,data:o})=>{n===_n&&o===s&&a.length&&a.shift()()},!1),n=>{a.push(n),_n.postMessage(s,"*")}))(`axios@${Math.random()}`,[]):s=>setTimeout(s))(typeof setImmediate=="function",cr(_n.postMessage)),Xh=typeof queueMicrotask<"u"?queueMicrotask.bind(_n):typeof process<"u"&&process.nextTick||bu,Zh=t=>t!=null&&cr(t[lo]),ve={isArray:Zn,isArrayBuffer:gu,isBuffer:gh,isFormData:Ch,isArrayBufferView:xh,isString:yh,isNumber:xu,isBoolean:vh,isObject:po,isPlainObject:Ea,isReadableStream:Ph,isRequest:Eh,isResponse:Dh,isHeaders:Th,isUndefined:Xs,isDate:_h,isFile:bh,isBlob:jh,isRegExp:Bh,isFunction:cr,isStream:Sh,isURLSearchParams:kh,isTypedArray:qh,isFileList:wh,forEach:na,merge:pi,extend:Ih,trim:Oh,stripBOM:Ah,inherits:Mh,toFlatObject:Rh,kindOf:co,kindOfTest:Pr,endsWith:Nh,toArray:Lh,forEachEntry:Uh,matchAll:Wh,isHTMLForm:Fh,hasOwnProperty:xl,hasOwnProp:xl,reduceDescriptors:_u,freezeMethods:zh,toObjectSet:Hh,toCamelCase:$h,noop:Yh,toFiniteNumber:Vh,findKey:yu,global:_n,isContextDefined:vu,isSpecCompliantForm:Gh,toJSONObject:Qh,isAsyncFn:Jh,isThenable:Kh,setImmediate:bu,asap:Xh,isIterable:Zh};function st(t,r,s,a,n){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",r&&(this.code=r),s&&(this.config=s),a&&(this.request=a),n&&(this.response=n,this.status=n.status?n.status:null)}ve.inherits(st,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:ve.toJSONObject(this.config),code:this.code,status:this.status}}});const ju=st.prototype,wu={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{wu[t]={value:t}});Object.defineProperties(st,wu);Object.defineProperty(ju,"isAxiosError",{value:!0});st.from=(t,r,s,a,n,o)=>{const i=Object.create(ju);return ve.toFlatObject(t,i,function(u){return u!==Error.prototype},c=>c!=="isAxiosError"),st.call(i,t.message,r,s,a,n),i.cause=t,i.name=t.name,o&&Object.assign(i,o),i};const em=null;function hi(t){return ve.isPlainObject(t)||ve.isArray(t)}function Su(t){return ve.endsWith(t,"[]")?t.slice(0,-2):t}function yl(t,r,s){return t?t.concat(r).map(function(n,o){return n=Su(n),!s&&o?"["+n+"]":n}).join(s?".":""):r}function tm(t){return ve.isArray(t)&&!t.some(hi)}const rm=ve.toFlatObject(ve,{},null,function(r){return/^is[A-Z]/.test(r)});function ho(t,r,s){if(!ve.isObject(t))throw new TypeError("target must be an object");r=r||new FormData,s=ve.toFlatObject(s,{metaTokens:!0,dots:!1,indexes:!1},!1,function(E,b){return!ve.isUndefined(b[E])});const a=s.metaTokens,n=s.visitor||p,o=s.dots,i=s.indexes,u=(s.Blob||typeof Blob<"u"&&Blob)&&ve.isSpecCompliantForm(r);if(!ve.isFunction(n))throw new TypeError("visitor must be a function");function d(_){if(_===null)return"";if(ve.isDate(_))return _.toISOString();if(ve.isBoolean(_))return _.toString();if(!u&&ve.isBlob(_))throw new st("Blob is not supported. Use a Buffer instead.");return ve.isArrayBuffer(_)||ve.isTypedArray(_)?u&&typeof Blob=="function"?new Blob([_]):Buffer.from(_):_}function p(_,E,b){let I=_;if(_&&!b&&typeof _=="object"){if(ve.endsWith(E,"{}"))E=a?E:E.slice(0,-2),_=JSON.stringify(_);else if(ve.isArray(_)&&tm(_)||(ve.isFileList(_)||ve.endsWith(E,"[]"))&&(I=ve.toArray(_)))return E=Su(E),I.forEach(function(S,j){!(ve.isUndefined(S)||S===null)&&r.append(i===!0?yl([E],j,o):i===null?E:E+"[]",d(S))}),!1}return hi(_)?!0:(r.append(yl(b,E,o),d(_)),!1)}const y=[],w=Object.assign(rm,{defaultVisitor:p,convertValue:d,isVisitable:hi});function O(_,E){if(!ve.isUndefined(_)){if(y.indexOf(_)!==-1)throw Error("Circular reference detected in "+E.join("."));y.push(_),ve.forEach(_,function(I,U){(!(ve.isUndefined(I)||I===null)&&n.call(r,I,ve.isString(U)?U.trim():U,E,w))===!0&&O(I,E?E.concat(U):[U])}),y.pop()}}if(!ve.isObject(t))throw new TypeError("data must be an object");return O(t),r}function vl(t){const r={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(a){return r[a]})}function qi(t,r){this._pairs=[],t&&ho(t,this,r)}const Cu=qi.prototype;Cu.append=function(r,s){this._pairs.push([r,s])};Cu.toString=function(r){const s=r?function(a){return r.call(this,a,vl)}:vl;return this._pairs.map(function(n){return s(n[0])+"="+s(n[1])},"").join("&")};function nm(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function ku(t,r,s){if(!r)return t;const a=s&&s.encode||nm;ve.isFunction(s)&&(s={serialize:s});const n=s&&s.serialize;let o;if(n?o=n(r,s):o=ve.isURLSearchParams(r)?r.toString():new qi(r,s).toString(a),o){const i=t.indexOf("#");i!==-1&&(t=t.slice(0,i)),t+=(t.indexOf("?")===-1?"?":"&")+o}return t}class _l{constructor(){this.handlers=[]}use(r,s,a){return this.handlers.push({fulfilled:r,rejected:s,synchronous:a?a.synchronous:!1,runWhen:a?a.runWhen:null}),this.handlers.length-1}eject(r){this.handlers[r]&&(this.handlers[r]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(r){ve.forEach(this.handlers,function(a){a!==null&&r(a)})}}const Pu={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},sm=typeof URLSearchParams<"u"?URLSearchParams:qi,am=typeof FormData<"u"?FormData:null,om=typeof Blob<"u"?Blob:null,im={isBrowser:!0,classes:{URLSearchParams:sm,FormData:am,Blob:om},protocols:["http","https","file","blob","url","data"]},Ui=typeof window<"u"&&typeof document<"u",mi=typeof navigator=="object"&&navigator||void 0,lm=Ui&&(!mi||["ReactNative","NativeScript","NS"].indexOf(mi.product)<0),cm=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",um=Ui&&window.location.href||"http://localhost",dm=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:Ui,hasStandardBrowserEnv:lm,hasStandardBrowserWebWorkerEnv:cm,navigator:mi,origin:um},Symbol.toStringTag,{value:"Module"})),er={...dm,...im};function pm(t,r){return ho(t,new er.classes.URLSearchParams,Object.assign({visitor:function(s,a,n,o){return er.isNode&&ve.isBuffer(s)?(this.append(a,s.toString("base64")),!1):o.defaultVisitor.apply(this,arguments)}},r))}function hm(t){return ve.matchAll(/\w+|\[(\w*)]/g,t).map(r=>r[0]==="[]"?"":r[1]||r[0])}function mm(t){const r={},s=Object.keys(t);let a;const n=s.length;let o;for(a=0;a<n;a++)o=s[a],r[o]=t[o];return r}function Eu(t){function r(s,a,n,o){let i=s[o++];if(i==="__proto__")return!0;const c=Number.isFinite(+i),u=o>=s.length;return i=!i&&ve.isArray(n)?n.length:i,u?(ve.hasOwnProp(n,i)?n[i]=[n[i],a]:n[i]=a,!c):((!n[i]||!ve.isObject(n[i]))&&(n[i]=[]),r(s,a,n[i],o)&&ve.isArray(n[i])&&(n[i]=mm(n[i])),!c)}if(ve.isFormData(t)&&ve.isFunction(t.entries)){const s={};return ve.forEachEntry(t,(a,n)=>{r(hm(a),n,s,0)}),s}return null}function fm(t,r,s){if(ve.isString(t))try{return(r||JSON.parse)(t),ve.trim(t)}catch(a){if(a.name!=="SyntaxError")throw a}return(s||JSON.stringify)(t)}const sa={transitional:Pu,adapter:["xhr","http","fetch"],transformRequest:[function(r,s){const a=s.getContentType()||"",n=a.indexOf("application/json")>-1,o=ve.isObject(r);if(o&&ve.isHTMLForm(r)&&(r=new FormData(r)),ve.isFormData(r))return n?JSON.stringify(Eu(r)):r;if(ve.isArrayBuffer(r)||ve.isBuffer(r)||ve.isStream(r)||ve.isFile(r)||ve.isBlob(r)||ve.isReadableStream(r))return r;if(ve.isArrayBufferView(r))return r.buffer;if(ve.isURLSearchParams(r))return s.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),r.toString();let c;if(o){if(a.indexOf("application/x-www-form-urlencoded")>-1)return pm(r,this.formSerializer).toString();if((c=ve.isFileList(r))||a.indexOf("multipart/form-data")>-1){const u=this.env&&this.env.FormData;return ho(c?{"files[]":r}:r,u&&new u,this.formSerializer)}}return o||n?(s.setContentType("application/json",!1),fm(r)):r}],transformResponse:[function(r){const s=this.transitional||sa.transitional,a=s&&s.forcedJSONParsing,n=this.responseType==="json";if(ve.isResponse(r)||ve.isReadableStream(r))return r;if(r&&ve.isString(r)&&(a&&!this.responseType||n)){const i=!(s&&s.silentJSONParsing)&&n;try{return JSON.parse(r)}catch(c){if(i)throw c.name==="SyntaxError"?st.from(c,st.ERR_BAD_RESPONSE,this,null,this.response):c}}return r}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:er.classes.FormData,Blob:er.classes.Blob},validateStatus:function(r){return r>=200&&r<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};ve.forEach(["delete","get","head","post","put","patch"],t=>{sa.headers[t]={}});const gm=ve.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),xm=t=>{const r={};let s,a,n;return t&&t.split(`
`).forEach(function(i){n=i.indexOf(":"),s=i.substring(0,n).trim().toLowerCase(),a=i.substring(n+1).trim(),!(!s||r[s]&&gm[s])&&(s==="set-cookie"?r[s]?r[s].push(a):r[s]=[a]:r[s]=r[s]?r[s]+", "+a:a)}),r},bl=Symbol("internals");function hs(t){return t&&String(t).trim().toLowerCase()}function Da(t){return t===!1||t==null?t:ve.isArray(t)?t.map(Da):String(t)}function ym(t){const r=Object.create(null),s=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let a;for(;a=s.exec(t);)r[a[1]]=a[2];return r}const vm=t=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(t.trim());function $o(t,r,s,a,n){if(ve.isFunction(a))return a.call(this,r,s);if(n&&(r=s),!!ve.isString(r)){if(ve.isString(a))return r.indexOf(a)!==-1;if(ve.isRegExp(a))return a.test(r)}}function _m(t){return t.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(r,s,a)=>s.toUpperCase()+a)}function bm(t,r){const s=ve.toCamelCase(" "+r);["get","set","has"].forEach(a=>{Object.defineProperty(t,a+s,{value:function(n,o,i){return this[a].call(this,r,n,o,i)},configurable:!0})})}let ur=class{constructor(r){r&&this.set(r)}set(r,s,a){const n=this;function o(c,u,d){const p=hs(u);if(!p)throw new Error("header name must be a non-empty string");const y=ve.findKey(n,p);(!y||n[y]===void 0||d===!0||d===void 0&&n[y]!==!1)&&(n[y||u]=Da(c))}const i=(c,u)=>ve.forEach(c,(d,p)=>o(d,p,u));if(ve.isPlainObject(r)||r instanceof this.constructor)i(r,s);else if(ve.isString(r)&&(r=r.trim())&&!vm(r))i(xm(r),s);else if(ve.isObject(r)&&ve.isIterable(r)){let c={},u,d;for(const p of r){if(!ve.isArray(p))throw TypeError("Object iterator must return a key-value pair");c[d=p[0]]=(u=c[d])?ve.isArray(u)?[...u,p[1]]:[u,p[1]]:p[1]}i(c,s)}else r!=null&&o(s,r,a);return this}get(r,s){if(r=hs(r),r){const a=ve.findKey(this,r);if(a){const n=this[a];if(!s)return n;if(s===!0)return ym(n);if(ve.isFunction(s))return s.call(this,n,a);if(ve.isRegExp(s))return s.exec(n);throw new TypeError("parser must be boolean|regexp|function")}}}has(r,s){if(r=hs(r),r){const a=ve.findKey(this,r);return!!(a&&this[a]!==void 0&&(!s||$o(this,this[a],a,s)))}return!1}delete(r,s){const a=this;let n=!1;function o(i){if(i=hs(i),i){const c=ve.findKey(a,i);c&&(!s||$o(a,a[c],c,s))&&(delete a[c],n=!0)}}return ve.isArray(r)?r.forEach(o):o(r),n}clear(r){const s=Object.keys(this);let a=s.length,n=!1;for(;a--;){const o=s[a];(!r||$o(this,this[o],o,r,!0))&&(delete this[o],n=!0)}return n}normalize(r){const s=this,a={};return ve.forEach(this,(n,o)=>{const i=ve.findKey(a,o);if(i){s[i]=Da(n),delete s[o];return}const c=r?_m(o):String(o).trim();c!==o&&delete s[o],s[c]=Da(n),a[c]=!0}),this}concat(...r){return this.constructor.concat(this,...r)}toJSON(r){const s=Object.create(null);return ve.forEach(this,(a,n)=>{a!=null&&a!==!1&&(s[n]=r&&ve.isArray(a)?a.join(", "):a)}),s}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([r,s])=>r+": "+s).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(r){return r instanceof this?r:new this(r)}static concat(r,...s){const a=new this(r);return s.forEach(n=>a.set(n)),a}static accessor(r){const a=(this[bl]=this[bl]={accessors:{}}).accessors,n=this.prototype;function o(i){const c=hs(i);a[c]||(bm(n,i),a[c]=!0)}return ve.isArray(r)?r.forEach(o):o(r),this}};ur.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);ve.reduceDescriptors(ur.prototype,({value:t},r)=>{let s=r[0].toUpperCase()+r.slice(1);return{get:()=>t,set(a){this[s]=a}}});ve.freezeMethods(ur);function Bo(t,r){const s=this||sa,a=r||s,n=ur.from(a.headers);let o=a.data;return ve.forEach(t,function(c){o=c.call(s,o,n.normalize(),r?r.status:void 0)}),n.normalize(),o}function Du(t){return!!(t&&t.__CANCEL__)}function es(t,r,s){st.call(this,t??"canceled",st.ERR_CANCELED,r,s),this.name="CanceledError"}ve.inherits(es,st,{__CANCEL__:!0});function Tu(t,r,s){const a=s.config.validateStatus;!s.status||!a||a(s.status)?t(s):r(new st("Request failed with status code "+s.status,[st.ERR_BAD_REQUEST,st.ERR_BAD_RESPONSE][Math.floor(s.status/100)-4],s.config,s.request,s))}function jm(t){const r=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return r&&r[1]||""}function wm(t,r){t=t||10;const s=new Array(t),a=new Array(t);let n=0,o=0,i;return r=r!==void 0?r:1e3,function(u){const d=Date.now(),p=a[o];i||(i=d),s[n]=u,a[n]=d;let y=o,w=0;for(;y!==n;)w+=s[y++],y=y%t;if(n=(n+1)%t,n===o&&(o=(o+1)%t),d-i<r)return;const O=p&&d-p;return O?Math.round(w*1e3/O):void 0}}function Sm(t,r){let s=0,a=1e3/r,n,o;const i=(d,p=Date.now())=>{s=p,n=null,o&&(clearTimeout(o),o=null),t.apply(null,d)};return[(...d)=>{const p=Date.now(),y=p-s;y>=a?i(d,p):(n=d,o||(o=setTimeout(()=>{o=null,i(n)},a-y)))},()=>n&&i(n)]}const Ya=(t,r,s=3)=>{let a=0;const n=wm(50,250);return Sm(o=>{const i=o.loaded,c=o.lengthComputable?o.total:void 0,u=i-a,d=n(u),p=i<=c;a=i;const y={loaded:i,total:c,progress:c?i/c:void 0,bytes:u,rate:d||void 0,estimated:d&&c&&p?(c-i)/d:void 0,event:o,lengthComputable:c!=null,[r?"download":"upload"]:!0};t(y)},s)},jl=(t,r)=>{const s=t!=null;return[a=>r[0]({lengthComputable:s,total:t,loaded:a}),r[1]]},wl=t=>(...r)=>ve.asap(()=>t(...r)),Cm=er.hasStandardBrowserEnv?((t,r)=>s=>(s=new URL(s,er.origin),t.protocol===s.protocol&&t.host===s.host&&(r||t.port===s.port)))(new URL(er.origin),er.navigator&&/(msie|trident)/i.test(er.navigator.userAgent)):()=>!0,km=er.hasStandardBrowserEnv?{write(t,r,s,a,n,o){const i=[t+"="+encodeURIComponent(r)];ve.isNumber(s)&&i.push("expires="+new Date(s).toGMTString()),ve.isString(a)&&i.push("path="+a),ve.isString(n)&&i.push("domain="+n),o===!0&&i.push("secure"),document.cookie=i.join("; ")},read(t){const r=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return r?decodeURIComponent(r[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function Pm(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)}function Em(t,r){return r?t.replace(/\/?\/$/,"")+"/"+r.replace(/^\/+/,""):t}function Ou(t,r,s){let a=!Pm(r);return t&&(a||s==!1)?Em(t,r):r}const Sl=t=>t instanceof ur?{...t}:t;function Cn(t,r){r=r||{};const s={};function a(d,p,y,w){return ve.isPlainObject(d)&&ve.isPlainObject(p)?ve.merge.call({caseless:w},d,p):ve.isPlainObject(p)?ve.merge({},p):ve.isArray(p)?p.slice():p}function n(d,p,y,w){if(ve.isUndefined(p)){if(!ve.isUndefined(d))return a(void 0,d,y,w)}else return a(d,p,y,w)}function o(d,p){if(!ve.isUndefined(p))return a(void 0,p)}function i(d,p){if(ve.isUndefined(p)){if(!ve.isUndefined(d))return a(void 0,d)}else return a(void 0,p)}function c(d,p,y){if(y in r)return a(d,p);if(y in t)return a(void 0,d)}const u={url:o,method:o,data:o,baseURL:i,transformRequest:i,transformResponse:i,paramsSerializer:i,timeout:i,timeoutMessage:i,withCredentials:i,withXSRFToken:i,adapter:i,responseType:i,xsrfCookieName:i,xsrfHeaderName:i,onUploadProgress:i,onDownloadProgress:i,decompress:i,maxContentLength:i,maxBodyLength:i,beforeRedirect:i,transport:i,httpAgent:i,httpsAgent:i,cancelToken:i,socketPath:i,responseEncoding:i,validateStatus:c,headers:(d,p,y)=>n(Sl(d),Sl(p),y,!0)};return ve.forEach(Object.keys(Object.assign({},t,r)),function(p){const y=u[p]||n,w=y(t[p],r[p],p);ve.isUndefined(w)&&y!==c||(s[p]=w)}),s}const Iu=t=>{const r=Cn({},t);let{data:s,withXSRFToken:a,xsrfHeaderName:n,xsrfCookieName:o,headers:i,auth:c}=r;r.headers=i=ur.from(i),r.url=ku(Ou(r.baseURL,r.url,r.allowAbsoluteUrls),t.params,t.paramsSerializer),c&&i.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):"")));let u;if(ve.isFormData(s)){if(er.hasStandardBrowserEnv||er.hasStandardBrowserWebWorkerEnv)i.setContentType(void 0);else if((u=i.getContentType())!==!1){const[d,...p]=u?u.split(";").map(y=>y.trim()).filter(Boolean):[];i.setContentType([d||"multipart/form-data",...p].join("; "))}}if(er.hasStandardBrowserEnv&&(a&&ve.isFunction(a)&&(a=a(r)),a||a!==!1&&Cm(r.url))){const d=n&&o&&km.read(o);d&&i.set(n,d)}return r},Dm=typeof XMLHttpRequest<"u",Tm=Dm&&function(t){return new Promise(function(s,a){const n=Iu(t);let o=n.data;const i=ur.from(n.headers).normalize();let{responseType:c,onUploadProgress:u,onDownloadProgress:d}=n,p,y,w,O,_;function E(){O&&O(),_&&_(),n.cancelToken&&n.cancelToken.unsubscribe(p),n.signal&&n.signal.removeEventListener("abort",p)}let b=new XMLHttpRequest;b.open(n.method.toUpperCase(),n.url,!0),b.timeout=n.timeout;function I(){if(!b)return;const S=ur.from("getAllResponseHeaders"in b&&b.getAllResponseHeaders()),N={data:!c||c==="text"||c==="json"?b.responseText:b.response,status:b.status,statusText:b.statusText,headers:S,config:t,request:b};Tu(function(M){s(M),E()},function(M){a(M),E()},N),b=null}"onloadend"in b?b.onloadend=I:b.onreadystatechange=function(){!b||b.readyState!==4||b.status===0&&!(b.responseURL&&b.responseURL.indexOf("file:")===0)||setTimeout(I)},b.onabort=function(){b&&(a(new st("Request aborted",st.ECONNABORTED,t,b)),b=null)},b.onerror=function(){a(new st("Network Error",st.ERR_NETWORK,t,b)),b=null},b.ontimeout=function(){let j=n.timeout?"timeout of "+n.timeout+"ms exceeded":"timeout exceeded";const N=n.transitional||Pu;n.timeoutErrorMessage&&(j=n.timeoutErrorMessage),a(new st(j,N.clarifyTimeoutError?st.ETIMEDOUT:st.ECONNABORTED,t,b)),b=null},o===void 0&&i.setContentType(null),"setRequestHeader"in b&&ve.forEach(i.toJSON(),function(j,N){b.setRequestHeader(N,j)}),ve.isUndefined(n.withCredentials)||(b.withCredentials=!!n.withCredentials),c&&c!=="json"&&(b.responseType=n.responseType),d&&([w,_]=Ya(d,!0),b.addEventListener("progress",w)),u&&b.upload&&([y,O]=Ya(u),b.upload.addEventListener("progress",y),b.upload.addEventListener("loadend",O)),(n.cancelToken||n.signal)&&(p=S=>{b&&(a(!S||S.type?new es(null,t,b):S),b.abort(),b=null)},n.cancelToken&&n.cancelToken.subscribe(p),n.signal&&(n.signal.aborted?p():n.signal.addEventListener("abort",p)));const U=jm(n.url);if(U&&er.protocols.indexOf(U)===-1){a(new st("Unsupported protocol "+U+":",st.ERR_BAD_REQUEST,t));return}b.send(o||null)})},Om=(t,r)=>{const{length:s}=t=t?t.filter(Boolean):[];if(r||s){let a=new AbortController,n;const o=function(d){if(!n){n=!0,c();const p=d instanceof Error?d:this.reason;a.abort(p instanceof st?p:new es(p instanceof Error?p.message:p))}};let i=r&&setTimeout(()=>{i=null,o(new st(`timeout ${r} of ms exceeded`,st.ETIMEDOUT))},r);const c=()=>{t&&(i&&clearTimeout(i),i=null,t.forEach(d=>{d.unsubscribe?d.unsubscribe(o):d.removeEventListener("abort",o)}),t=null)};t.forEach(d=>d.addEventListener("abort",o));const{signal:u}=a;return u.unsubscribe=()=>ve.asap(c),u}},Im=function*(t,r){let s=t.byteLength;if(s<r){yield t;return}let a=0,n;for(;a<s;)n=a+r,yield t.slice(a,n),a=n},Am=async function*(t,r){for await(const s of Mm(t))yield*Im(s,r)},Mm=async function*(t){if(t[Symbol.asyncIterator]){yield*t;return}const r=t.getReader();try{for(;;){const{done:s,value:a}=await r.read();if(s)break;yield a}}finally{await r.cancel()}},Cl=(t,r,s,a)=>{const n=Am(t,r);let o=0,i,c=u=>{i||(i=!0,a&&a(u))};return new ReadableStream({async pull(u){try{const{done:d,value:p}=await n.next();if(d){c(),u.close();return}let y=p.byteLength;if(s){let w=o+=y;s(w)}u.enqueue(new Uint8Array(p))}catch(d){throw c(d),d}},cancel(u){return c(u),n.return()}},{highWaterMark:2})},mo=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",Au=mo&&typeof ReadableStream=="function",Rm=mo&&(typeof TextEncoder=="function"?(t=>r=>t.encode(r))(new TextEncoder):async t=>new Uint8Array(await new Response(t).arrayBuffer())),Mu=(t,...r)=>{try{return!!t(...r)}catch{return!1}},Nm=Au&&Mu(()=>{let t=!1;const r=new Request(er.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!r}),kl=64*1024,fi=Au&&Mu(()=>ve.isReadableStream(new Response("").body)),Va={stream:fi&&(t=>t.body)};mo&&(t=>{["text","arrayBuffer","blob","formData","stream"].forEach(r=>{!Va[r]&&(Va[r]=ve.isFunction(t[r])?s=>s[r]():(s,a)=>{throw new st(`Response type '${r}' is not supported`,st.ERR_NOT_SUPPORT,a)})})})(new Response);const Lm=async t=>{if(t==null)return 0;if(ve.isBlob(t))return t.size;if(ve.isSpecCompliantForm(t))return(await new Request(er.origin,{method:"POST",body:t}).arrayBuffer()).byteLength;if(ve.isArrayBufferView(t)||ve.isArrayBuffer(t))return t.byteLength;if(ve.isURLSearchParams(t)&&(t=t+""),ve.isString(t))return(await Rm(t)).byteLength},qm=async(t,r)=>{const s=ve.toFiniteNumber(t.getContentLength());return s??Lm(r)},Um=mo&&(async t=>{let{url:r,method:s,data:a,signal:n,cancelToken:o,timeout:i,onDownloadProgress:c,onUploadProgress:u,responseType:d,headers:p,withCredentials:y="same-origin",fetchOptions:w}=Iu(t);d=d?(d+"").toLowerCase():"text";let O=Om([n,o&&o.toAbortSignal()],i),_;const E=O&&O.unsubscribe&&(()=>{O.unsubscribe()});let b;try{if(u&&Nm&&s!=="get"&&s!=="head"&&(b=await qm(p,a))!==0){let N=new Request(r,{method:"POST",body:a,duplex:"half"}),k;if(ve.isFormData(a)&&(k=N.headers.get("content-type"))&&p.setContentType(k),N.body){const[M,v]=jl(b,Ya(wl(u)));a=Cl(N.body,kl,M,v)}}ve.isString(y)||(y=y?"include":"omit");const I="credentials"in Request.prototype;_=new Request(r,{...w,signal:O,method:s.toUpperCase(),headers:p.normalize().toJSON(),body:a,duplex:"half",credentials:I?y:void 0});let U=await fetch(_,w);const S=fi&&(d==="stream"||d==="response");if(fi&&(c||S&&E)){const N={};["status","statusText","headers"].forEach(g=>{N[g]=U[g]});const k=ve.toFiniteNumber(U.headers.get("content-length")),[M,v]=c&&jl(k,Ya(wl(c),!0))||[];U=new Response(Cl(U.body,kl,M,()=>{v&&v(),E&&E()}),N)}d=d||"text";let j=await Va[ve.findKey(Va,d)||"text"](U,t);return!S&&E&&E(),await new Promise((N,k)=>{Tu(N,k,{data:j,headers:ur.from(U.headers),status:U.status,statusText:U.statusText,config:t,request:_})})}catch(I){throw E&&E(),I&&I.name==="TypeError"&&/Load failed|fetch/i.test(I.message)?Object.assign(new st("Network Error",st.ERR_NETWORK,t,_),{cause:I.cause||I}):st.from(I,I&&I.code,t,_)}}),gi={http:em,xhr:Tm,fetch:Um};ve.forEach(gi,(t,r)=>{if(t){try{Object.defineProperty(t,"name",{value:r})}catch{}Object.defineProperty(t,"adapterName",{value:r})}});const Pl=t=>`- ${t}`,Wm=t=>ve.isFunction(t)||t===null||t===!1,Ru={getAdapter:t=>{t=ve.isArray(t)?t:[t];const{length:r}=t;let s,a;const n={};for(let o=0;o<r;o++){s=t[o];let i;if(a=s,!Wm(s)&&(a=gi[(i=String(s)).toLowerCase()],a===void 0))throw new st(`Unknown adapter '${i}'`);if(a)break;n[i||"#"+o]=a}if(!a){const o=Object.entries(n).map(([c,u])=>`adapter ${c} `+(u===!1?"is not supported by the environment":"is not available in the build"));let i=r?o.length>1?`since :
`+o.map(Pl).join(`
`):" "+Pl(o[0]):"as no adapter specified";throw new st("There is no suitable adapter to dispatch the request "+i,"ERR_NOT_SUPPORT")}return a},adapters:gi};function zo(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new es(null,t)}function El(t){return zo(t),t.headers=ur.from(t.headers),t.data=Bo.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),Ru.getAdapter(t.adapter||sa.adapter)(t).then(function(a){return zo(t),a.data=Bo.call(t,t.transformResponse,a),a.headers=ur.from(a.headers),a},function(a){return Du(a)||(zo(t),a&&a.response&&(a.response.data=Bo.call(t,t.transformResponse,a.response),a.response.headers=ur.from(a.response.headers))),Promise.reject(a)})}const Nu="1.10.0",fo={};["object","boolean","number","function","string","symbol"].forEach((t,r)=>{fo[t]=function(a){return typeof a===t||"a"+(r<1?"n ":" ")+t}});const Dl={};fo.transitional=function(r,s,a){function n(o,i){return"[Axios v"+Nu+"] Transitional option '"+o+"'"+i+(a?". "+a:"")}return(o,i,c)=>{if(r===!1)throw new st(n(i," has been removed"+(s?" in "+s:"")),st.ERR_DEPRECATED);return s&&!Dl[i]&&(Dl[i]=!0,console.warn(n(i," has been deprecated since v"+s+" and will be removed in the near future"))),r?r(o,i,c):!0}};fo.spelling=function(r){return(s,a)=>(console.warn(`${a} is likely a misspelling of ${r}`),!0)};function Fm(t,r,s){if(typeof t!="object")throw new st("options must be an object",st.ERR_BAD_OPTION_VALUE);const a=Object.keys(t);let n=a.length;for(;n-- >0;){const o=a[n],i=r[o];if(i){const c=t[o],u=c===void 0||i(c,o,t);if(u!==!0)throw new st("option "+o+" must be "+u,st.ERR_BAD_OPTION_VALUE);continue}if(s!==!0)throw new st("Unknown option "+o,st.ERR_BAD_OPTION)}}const Ta={assertOptions:Fm,validators:fo},Tr=Ta.validators;let bn=class{constructor(r){this.defaults=r||{},this.interceptors={request:new _l,response:new _l}}async request(r,s){try{return await this._request(r,s)}catch(a){if(a instanceof Error){let n={};Error.captureStackTrace?Error.captureStackTrace(n):n=new Error;const o=n.stack?n.stack.replace(/^.+\n/,""):"";try{a.stack?o&&!String(a.stack).endsWith(o.replace(/^.+\n.+\n/,""))&&(a.stack+=`
`+o):a.stack=o}catch{}}throw a}}_request(r,s){typeof r=="string"?(s=s||{},s.url=r):s=r||{},s=Cn(this.defaults,s);const{transitional:a,paramsSerializer:n,headers:o}=s;a!==void 0&&Ta.assertOptions(a,{silentJSONParsing:Tr.transitional(Tr.boolean),forcedJSONParsing:Tr.transitional(Tr.boolean),clarifyTimeoutError:Tr.transitional(Tr.boolean)},!1),n!=null&&(ve.isFunction(n)?s.paramsSerializer={serialize:n}:Ta.assertOptions(n,{encode:Tr.function,serialize:Tr.function},!0)),s.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?s.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:s.allowAbsoluteUrls=!0),Ta.assertOptions(s,{baseUrl:Tr.spelling("baseURL"),withXsrfToken:Tr.spelling("withXSRFToken")},!0),s.method=(s.method||this.defaults.method||"get").toLowerCase();let i=o&&ve.merge(o.common,o[s.method]);o&&ve.forEach(["delete","get","head","post","put","patch","common"],_=>{delete o[_]}),s.headers=ur.concat(i,o);const c=[];let u=!0;this.interceptors.request.forEach(function(E){typeof E.runWhen=="function"&&E.runWhen(s)===!1||(u=u&&E.synchronous,c.unshift(E.fulfilled,E.rejected))});const d=[];this.interceptors.response.forEach(function(E){d.push(E.fulfilled,E.rejected)});let p,y=0,w;if(!u){const _=[El.bind(this),void 0];for(_.unshift.apply(_,c),_.push.apply(_,d),w=_.length,p=Promise.resolve(s);y<w;)p=p.then(_[y++],_[y++]);return p}w=c.length;let O=s;for(y=0;y<w;){const _=c[y++],E=c[y++];try{O=_(O)}catch(b){E.call(this,b);break}}try{p=El.call(this,O)}catch(_){return Promise.reject(_)}for(y=0,w=d.length;y<w;)p=p.then(d[y++],d[y++]);return p}getUri(r){r=Cn(this.defaults,r);const s=Ou(r.baseURL,r.url,r.allowAbsoluteUrls);return ku(s,r.params,r.paramsSerializer)}};ve.forEach(["delete","get","head","options"],function(r){bn.prototype[r]=function(s,a){return this.request(Cn(a||{},{method:r,url:s,data:(a||{}).data}))}});ve.forEach(["post","put","patch"],function(r){function s(a){return function(o,i,c){return this.request(Cn(c||{},{method:r,headers:a?{"Content-Type":"multipart/form-data"}:{},url:o,data:i}))}}bn.prototype[r]=s(),bn.prototype[r+"Form"]=s(!0)});let $m=class Lu{constructor(r){if(typeof r!="function")throw new TypeError("executor must be a function.");let s;this.promise=new Promise(function(o){s=o});const a=this;this.promise.then(n=>{if(!a._listeners)return;let o=a._listeners.length;for(;o-- >0;)a._listeners[o](n);a._listeners=null}),this.promise.then=n=>{let o;const i=new Promise(c=>{a.subscribe(c),o=c}).then(n);return i.cancel=function(){a.unsubscribe(o)},i},r(function(o,i,c){a.reason||(a.reason=new es(o,i,c),s(a.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(r){if(this.reason){r(this.reason);return}this._listeners?this._listeners.push(r):this._listeners=[r]}unsubscribe(r){if(!this._listeners)return;const s=this._listeners.indexOf(r);s!==-1&&this._listeners.splice(s,1)}toAbortSignal(){const r=new AbortController,s=a=>{r.abort(a)};return this.subscribe(s),r.signal.unsubscribe=()=>this.unsubscribe(s),r.signal}static source(){let r;return{token:new Lu(function(n){r=n}),cancel:r}}};function Bm(t){return function(s){return t.apply(null,s)}}function zm(t){return ve.isObject(t)&&t.isAxiosError===!0}const xi={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(xi).forEach(([t,r])=>{xi[r]=t});function qu(t){const r=new bn(t),s=mu(bn.prototype.request,r);return ve.extend(s,bn.prototype,r,{allOwnKeys:!0}),ve.extend(s,r,null,{allOwnKeys:!0}),s.create=function(n){return qu(Cn(t,n))},s}const zt=qu(sa);zt.Axios=bn;zt.CanceledError=es;zt.CancelToken=$m;zt.isCancel=Du;zt.VERSION=Nu;zt.toFormData=ho;zt.AxiosError=st;zt.Cancel=zt.CanceledError;zt.all=function(r){return Promise.all(r)};zt.spread=Bm;zt.isAxiosError=zm;zt.mergeConfig=Cn;zt.AxiosHeaders=ur;zt.formToJSON=t=>Eu(ve.isHTMLForm(t)?new FormData(t):t);zt.getAdapter=Ru.getAdapter;zt.HttpStatusCode=xi;zt.default=zt;const{Axios:Zb,AxiosError:nr,CanceledError:ej,isCancel:tj,CancelToken:rj,VERSION:nj,all:sj,Cancel:aj,isAxiosError:oj,spread:ij,toFormData:lj,AxiosHeaders:cj,HttpStatusCode:uj,formToJSON:dj,getAdapter:pj,mergeConfig:hj}=zt,yi=typeof window<"u"&&!!window.electronAPI;function Tl(t){return t.includes("localhost")&&t.startsWith("https://")?t.replace("https://","http://"):t}console.log("API baseURL:","http://localhost:5000");console.log("Is Electron:",yi);const Hm={cloudflare:{baseURL:"http://localhost:5000",timeout:12e4}};function Gn(){return console.log("Environment variables:",{VITE_API_BASE_URL:"http://localhost:5000",VITE_CLOUDFLARE_URL:"http://localhost:5000",MODE:"production",NODE_ENV:"production",isElectron:yi}),yi?(console.log("Running in Electron - checking environment variables"),"http://localhost:5000".includes("localhost")?(console.log("Using VITE_API_BASE_URL for Electron"),{baseURL:Tl("http://localhost:5000"),timeout:12e4}):(console.log("Using cloudflare config for Electron"),{baseURL:"http://localhost:5000",timeout:12e4})):"http://localhost:5000".includes("localhost")?(console.log("Using development config with VITE_API_BASE_URL"),{baseURL:Tl("http://localhost:5000"),timeout:12e4}):(console.log("Using cloudflare config"),Hm.cloudflare)}const Ol=Gn(),$=zt.create({baseURL:Ol.baseURL,timeout:Ol.timeout,withCredentials:!0});$.interceptors.request.use(t=>{const r=localStorage.getItem("sessionToken");r&&(t.headers.Authorization=`Bearer ${r}`);const s=localStorage.getItem("deviceId");return s&&(t.headers["x-device-id"]=s),t},t=>Promise.reject(t));$.interceptors.response.use(t=>{try{window.__backendUnavailableSince=void 0;const r=window.__triggerSync;typeof r=="function"&&setTimeout(()=>{try{r()}catch{}},0)}catch{}return t},async t=>{try{const s=t?.response?.status,a=!t.response&&(t.code==="ECONNABORTED"||t.message?.includes("Network Error"));(typeof s=="number"&&s>=500||a)&&(window.__backendUnavailableSince=window.__backendUnavailableSince||Date.now())}catch{}const r=t.config;if(t.response?.status===401&&!r._retry){r._retry=!0;const s=localStorage.getItem("refreshToken");if(s)try{const a=await $.post("/api/auth/refresh",{refreshToken:s}),{sessionToken:n,refreshToken:o}=a.data;return localStorage.setItem("sessionToken",n),localStorage.setItem("refreshToken",o),$.defaults.headers.common.Authorization=`Bearer ${n}`,$(r)}catch(a){return localStorage.removeItem("sessionToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),window.location.href="/login",Promise.reject(a)}else localStorage.removeItem("sessionToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),window.location.href="/login"}return Promise.reject(t)});const Uu=l.createContext(void 0),Ym=({children:t})=>{const[r,s]=l.useState(null),[a,n]=l.useState(!1),[o,i]=l.useState("");l.useEffect(()=>{let O=localStorage.getItem("deviceId");O||(O=crypto.randomUUID(),localStorage.setItem("deviceId",O)),i(O)},[]),l.useEffect(()=>{const O=localStorage.getItem("sessionToken"),_=localStorage.getItem("refreshToken"),E=localStorage.getItem("user");if(O&&_&&E)try{const b=JSON.parse(E);s(b),n(!0),$.defaults.headers.common.Authorization=`Bearer ${O}`,$.defaults.headers.common["x-device-id"]=o}catch(b){console.error("Error parsing user data:",b),u()}},[o]);const c=(O,_,E)=>{localStorage.setItem("sessionToken",O),localStorage.setItem("refreshToken",_),localStorage.setItem("user",JSON.stringify(E)),s(E),n(!0)},u=()=>{localStorage.removeItem("sessionToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),s(null),n(!1)},d=async()=>{try{await $.post("/api/auth/logout-all"),u()}catch(O){console.error("Error logging out from all devices:",O),u()}},p=async()=>{try{const O=localStorage.getItem("refreshToken");if(!O)return!1;const _=await $.post("/api/auth/refresh",{refreshToken:O}),{sessionToken:E,refreshToken:b}=_.data;return localStorage.setItem("sessionToken",E),localStorage.setItem("refreshToken",b),!0}catch(O){return console.error("Error refreshing session:",O),u(),!1}},y=async()=>{try{return(await $.get("/api/auth/sessions")).data}catch(O){return console.error("Error fetching user sessions:",O),[]}},w=async O=>{try{return await $.delete(`/api/auth/sessions/${O}`),!0}catch(_){return console.error("Error deactivating session:",_),!1}};return e.jsx(Uu.Provider,{value:{user:r,isAuthenticated:a,login:c,logout:u,logoutFromAllDevices:d,refreshSession:p,getUserSessions:y,deactivateSession:w,currentDeviceId:o},children:t})},Qt=()=>{const t=l.useContext(Uu);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t},Vm=kd({palette:{primary:{main:"#7c3aed"},secondary:{main:"#ffd600"}},typography:{h4:{fontSize:"1.5rem",fontWeight:600},h6:{fontSize:"1.2rem",fontWeight:500}}});var Oa={exports:{}},Gm=Oa.exports,Il;function Qm(){return Il||(Il=1,function(t,r){(function(s,a){t.exports=a()})(Gm,function(){var s=1e3,a=6e4,n=36e5,o="millisecond",i="second",c="minute",u="hour",d="day",p="week",y="month",w="quarter",O="year",_="date",E="Invalid Date",b=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,I=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,U={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(ee){var W=["th","st","nd","rd"],Z=ee%100;return"["+ee+(W[(Z-20)%10]||W[Z]||W[0])+"]"}},S=function(ee,W,Z){var J=String(ee);return!J||J.length>=W?ee:""+Array(W+1-J.length).join(Z)+ee},j={s:S,z:function(ee){var W=-ee.utcOffset(),Z=Math.abs(W),J=Math.floor(Z/60),P=Z%60;return(W<=0?"+":"-")+S(J,2,"0")+":"+S(P,2,"0")},m:function ee(W,Z){if(W.date()<Z.date())return-ee(Z,W);var J=12*(Z.year()-W.year())+(Z.month()-W.month()),P=W.clone().add(J,y),m=Z-P<0,A=W.clone().add(J+(m?-1:1),y);return+(-(J+(Z-P)/(m?P-A:A-P))||0)},a:function(ee){return ee<0?Math.ceil(ee)||0:Math.floor(ee)},p:function(ee){return{M:y,y:O,w:p,d,D:_,h:u,m:c,s:i,ms:o,Q:w}[ee]||String(ee||"").toLowerCase().replace(/s$/,"")},u:function(ee){return ee===void 0}},N="en",k={};k[N]=U;var M="$isDayjsObject",v=function(ee){return ee instanceof ne||!(!ee||!ee[M])},g=function ee(W,Z,J){var P;if(!W)return N;if(typeof W=="string"){var m=W.toLowerCase();k[m]&&(P=m),Z&&(k[m]=Z,P=m);var A=W.split("-");if(!P&&A.length>1)return ee(A[0])}else{var G=W.name;k[G]=W,P=G}return!J&&P&&(N=P),P||!J&&N},L=function(ee,W){if(v(ee))return ee.clone();var Z=typeof W=="object"?W:{};return Z.date=ee,Z.args=arguments,new ne(Z)},z=j;z.l=g,z.i=v,z.w=function(ee,W){return L(ee,{locale:W.$L,utc:W.$u,x:W.$x,$offset:W.$offset})};var ne=function(){function ee(Z){this.$L=g(Z.locale,null,!0),this.parse(Z),this.$x=this.$x||Z.x||{},this[M]=!0}var W=ee.prototype;return W.parse=function(Z){this.$d=function(J){var P=J.date,m=J.utc;if(P===null)return new Date(NaN);if(z.u(P))return new Date;if(P instanceof Date)return new Date(P);if(typeof P=="string"&&!/Z$/i.test(P)){var A=P.match(b);if(A){var G=A[2]-1||0,X=(A[7]||"0").substring(0,3);return m?new Date(Date.UTC(A[1],G,A[3]||1,A[4]||0,A[5]||0,A[6]||0,X)):new Date(A[1],G,A[3]||1,A[4]||0,A[5]||0,A[6]||0,X)}}return new Date(P)}(Z),this.init()},W.init=function(){var Z=this.$d;this.$y=Z.getFullYear(),this.$M=Z.getMonth(),this.$D=Z.getDate(),this.$W=Z.getDay(),this.$H=Z.getHours(),this.$m=Z.getMinutes(),this.$s=Z.getSeconds(),this.$ms=Z.getMilliseconds()},W.$utils=function(){return z},W.isValid=function(){return this.$d.toString()!==E},W.isSame=function(Z,J){var P=L(Z);return this.startOf(J)<=P&&P<=this.endOf(J)},W.isAfter=function(Z,J){return L(Z)<this.startOf(J)},W.isBefore=function(Z,J){return this.endOf(J)<L(Z)},W.$g=function(Z,J,P){return z.u(Z)?this[J]:this.set(P,Z)},W.unix=function(){return Math.floor(this.valueOf()/1e3)},W.valueOf=function(){return this.$d.getTime()},W.startOf=function(Z,J){var P=this,m=!!z.u(J)||J,A=z.p(Z),G=function(me,be){var je=z.w(P.$u?Date.UTC(P.$y,be,me):new Date(P.$y,be,me),P);return m?je:je.endOf(d)},X=function(me,be){return z.w(P.toDate()[me].apply(P.toDate("s"),(m?[0,0,0,0]:[23,59,59,999]).slice(be)),P)},Y=this.$W,fe=this.$M,se=this.$D,ke="set"+(this.$u?"UTC":"");switch(A){case O:return m?G(1,0):G(31,11);case y:return m?G(1,fe):G(0,fe+1);case p:var Pe=this.$locale().weekStart||0,ge=(Y<Pe?Y+7:Y)-Pe;return G(m?se-ge:se+(6-ge),fe);case d:case _:return X(ke+"Hours",0);case u:return X(ke+"Minutes",1);case c:return X(ke+"Seconds",2);case i:return X(ke+"Milliseconds",3);default:return this.clone()}},W.endOf=function(Z){return this.startOf(Z,!1)},W.$set=function(Z,J){var P,m=z.p(Z),A="set"+(this.$u?"UTC":""),G=(P={},P[d]=A+"Date",P[_]=A+"Date",P[y]=A+"Month",P[O]=A+"FullYear",P[u]=A+"Hours",P[c]=A+"Minutes",P[i]=A+"Seconds",P[o]=A+"Milliseconds",P)[m],X=m===d?this.$D+(J-this.$W):J;if(m===y||m===O){var Y=this.clone().set(_,1);Y.$d[G](X),Y.init(),this.$d=Y.set(_,Math.min(this.$D,Y.daysInMonth())).$d}else G&&this.$d[G](X);return this.init(),this},W.set=function(Z,J){return this.clone().$set(Z,J)},W.get=function(Z){return this[z.p(Z)]()},W.add=function(Z,J){var P,m=this;Z=Number(Z);var A=z.p(J),G=function(fe){var se=L(m);return z.w(se.date(se.date()+Math.round(fe*Z)),m)};if(A===y)return this.set(y,this.$M+Z);if(A===O)return this.set(O,this.$y+Z);if(A===d)return G(1);if(A===p)return G(7);var X=(P={},P[c]=a,P[u]=n,P[i]=s,P)[A]||1,Y=this.$d.getTime()+Z*X;return z.w(Y,this)},W.subtract=function(Z,J){return this.add(-1*Z,J)},W.format=function(Z){var J=this,P=this.$locale();if(!this.isValid())return P.invalidDate||E;var m=Z||"YYYY-MM-DDTHH:mm:ssZ",A=z.z(this),G=this.$H,X=this.$m,Y=this.$M,fe=P.weekdays,se=P.months,ke=P.meridiem,Pe=function(be,je,oe,D){return be&&(be[je]||be(J,m))||oe[je].slice(0,D)},ge=function(be){return z.s(G%12||12,be,"0")},me=ke||function(be,je,oe){var D=be<12?"AM":"PM";return oe?D.toLowerCase():D};return m.replace(I,function(be,je){return je||function(oe){switch(oe){case"YY":return String(J.$y).slice(-2);case"YYYY":return z.s(J.$y,4,"0");case"M":return Y+1;case"MM":return z.s(Y+1,2,"0");case"MMM":return Pe(P.monthsShort,Y,se,3);case"MMMM":return Pe(se,Y);case"D":return J.$D;case"DD":return z.s(J.$D,2,"0");case"d":return String(J.$W);case"dd":return Pe(P.weekdaysMin,J.$W,fe,2);case"ddd":return Pe(P.weekdaysShort,J.$W,fe,3);case"dddd":return fe[J.$W];case"H":return String(G);case"HH":return z.s(G,2,"0");case"h":return ge(1);case"hh":return ge(2);case"a":return me(G,X,!0);case"A":return me(G,X,!1);case"m":return String(X);case"mm":return z.s(X,2,"0");case"s":return String(J.$s);case"ss":return z.s(J.$s,2,"0");case"SSS":return z.s(J.$ms,3,"0");case"Z":return A}return null}(be)||A.replace(":","")})},W.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},W.diff=function(Z,J,P){var m,A=this,G=z.p(J),X=L(Z),Y=(X.utcOffset()-this.utcOffset())*a,fe=this-X,se=function(){return z.m(A,X)};switch(G){case O:m=se()/12;break;case y:m=se();break;case w:m=se()/3;break;case p:m=(fe-Y)/6048e5;break;case d:m=(fe-Y)/864e5;break;case u:m=fe/n;break;case c:m=fe/a;break;case i:m=fe/s;break;default:m=fe}return P?m:z.a(m)},W.daysInMonth=function(){return this.endOf(y).$D},W.$locale=function(){return k[this.$L]},W.locale=function(Z,J){if(!Z)return this.$L;var P=this.clone(),m=g(Z,J,!0);return m&&(P.$L=m),P},W.clone=function(){return z.w(this.$d,this)},W.toDate=function(){return new Date(this.valueOf())},W.toJSON=function(){return this.isValid()?this.toISOString():null},W.toISOString=function(){return this.$d.toISOString()},W.toString=function(){return this.$d.toUTCString()},ee}(),ae=ne.prototype;return L.prototype=ae,[["$ms",o],["$s",i],["$m",c],["$H",u],["$W",d],["$M",y],["$y",O],["$D",_]].forEach(function(ee){ae[ee[1]]=function(W){return this.$g(W,ee[0],ee[1])}}),L.extend=function(ee,W){return ee.$i||(ee(W,ne,L),ee.$i=!0),L},L.locale=g,L.isDayjs=v,L.unix=function(ee){return L(1e3*ee)},L.en=k[N],L.Ls=k,L.p={},L})}(Oa)),Oa.exports}var Jm=Qm();const Ze=vt(Jm);var Ia={exports:{}},Km=Ia.exports,Al;function Xm(){return Al||(Al=1,function(t,r){(function(s,a){t.exports=a()})(Km,function(){var s="week",a="year";return function(n,o,i){var c=o.prototype;c.week=function(u){if(u===void 0&&(u=null),u!==null)return this.add(7*(u-this.week()),"day");var d=this.$locale().yearStart||1;if(this.month()===11&&this.date()>25){var p=i(this).startOf(a).add(1,a).date(d),y=i(this).endOf(s);if(p.isBefore(y))return 1}var w=i(this).startOf(a).date(d).startOf(s).subtract(1,"millisecond"),O=this.diff(w,s,!0);return O<0?i(this).startOf("week").week():Math.ceil(O)},c.weeks=function(u){return u===void 0&&(u=null),this.week(u)}}})}(Ia)),Ia.exports}var Zm=Xm();const ef=vt(Zm);var Aa={exports:{}},tf=Aa.exports,Ml;function rf(){return Ml||(Ml=1,function(t,r){(function(s,a){t.exports=a()})(tf,function(){var s={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},a=/(\[[^[]*\])|([-_:/.,()\s]+)|(A|a|Q|YYYY|YY?|ww?|MM?M?M?|Do|DD?|hh?|HH?|mm?|ss?|S{1,3}|z|ZZ?)/g,n=/\d/,o=/\d\d/,i=/\d\d?/,c=/\d*[^-_:/,()\s\d]+/,u={},d=function(b){return(b=+b)+(b>68?1900:2e3)},p=function(b){return function(I){this[b]=+I}},y=[/[+-]\d\d:?(\d\d)?|Z/,function(b){(this.zone||(this.zone={})).offset=function(I){if(!I||I==="Z")return 0;var U=I.match(/([+-]|\d\d)/g),S=60*U[1]+(+U[2]||0);return S===0?0:U[0]==="+"?-S:S}(b)}],w=function(b){var I=u[b];return I&&(I.indexOf?I:I.s.concat(I.f))},O=function(b,I){var U,S=u.meridiem;if(S){for(var j=1;j<=24;j+=1)if(b.indexOf(S(j,0,I))>-1){U=j>12;break}}else U=b===(I?"pm":"PM");return U},_={A:[c,function(b){this.afternoon=O(b,!1)}],a:[c,function(b){this.afternoon=O(b,!0)}],Q:[n,function(b){this.month=3*(b-1)+1}],S:[n,function(b){this.milliseconds=100*+b}],SS:[o,function(b){this.milliseconds=10*+b}],SSS:[/\d{3}/,function(b){this.milliseconds=+b}],s:[i,p("seconds")],ss:[i,p("seconds")],m:[i,p("minutes")],mm:[i,p("minutes")],H:[i,p("hours")],h:[i,p("hours")],HH:[i,p("hours")],hh:[i,p("hours")],D:[i,p("day")],DD:[o,p("day")],Do:[c,function(b){var I=u.ordinal,U=b.match(/\d+/);if(this.day=U[0],I)for(var S=1;S<=31;S+=1)I(S).replace(/\[|\]/g,"")===b&&(this.day=S)}],w:[i,p("week")],ww:[o,p("week")],M:[i,p("month")],MM:[o,p("month")],MMM:[c,function(b){var I=w("months"),U=(w("monthsShort")||I.map(function(S){return S.slice(0,3)})).indexOf(b)+1;if(U<1)throw new Error;this.month=U%12||U}],MMMM:[c,function(b){var I=w("months").indexOf(b)+1;if(I<1)throw new Error;this.month=I%12||I}],Y:[/[+-]?\d+/,p("year")],YY:[o,function(b){this.year=d(b)}],YYYY:[/\d{4}/,p("year")],Z:y,ZZ:y};function E(b){var I,U;I=b,U=u&&u.formats;for(var S=(b=I.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(L,z,ne){var ae=ne&&ne.toUpperCase();return z||U[ne]||s[ne]||U[ae].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(ee,W,Z){return W||Z.slice(1)})})).match(a),j=S.length,N=0;N<j;N+=1){var k=S[N],M=_[k],v=M&&M[0],g=M&&M[1];S[N]=g?{regex:v,parser:g}:k.replace(/^\[|\]$/g,"")}return function(L){for(var z={},ne=0,ae=0;ne<j;ne+=1){var ee=S[ne];if(typeof ee=="string")ae+=ee.length;else{var W=ee.regex,Z=ee.parser,J=L.slice(ae),P=W.exec(J)[0];Z.call(z,P),L=L.replace(P,"")}}return function(m){var A=m.afternoon;if(A!==void 0){var G=m.hours;A?G<12&&(m.hours+=12):G===12&&(m.hours=0),delete m.afternoon}}(z),z}}return function(b,I,U){U.p.customParseFormat=!0,b&&b.parseTwoDigitYear&&(d=b.parseTwoDigitYear);var S=I.prototype,j=S.parse;S.parse=function(N){var k=N.date,M=N.utc,v=N.args;this.$u=M;var g=v[1];if(typeof g=="string"){var L=v[2]===!0,z=v[3]===!0,ne=L||z,ae=v[2];z&&(ae=v[2]),u=this.$locale(),!L&&ae&&(u=U.Ls[ae]),this.$d=function(J,P,m,A){try{if(["x","X"].indexOf(P)>-1)return new Date((P==="X"?1e3:1)*J);var G=E(P)(J),X=G.year,Y=G.month,fe=G.day,se=G.hours,ke=G.minutes,Pe=G.seconds,ge=G.milliseconds,me=G.zone,be=G.week,je=new Date,oe=fe||(X||Y?1:je.getDate()),D=X||je.getFullYear(),F=0;X&&!Y||(F=Y>0?Y-1:je.getMonth());var te,B=se||0,Ee=ke||0,Se=Pe||0,$e=ge||0;return me?new Date(Date.UTC(D,F,oe,B,Ee,Se,$e+60*me.offset*1e3)):m?new Date(Date.UTC(D,F,oe,B,Ee,Se,$e)):(te=new Date(D,F,oe,B,Ee,Se,$e),be&&(te=A(te).week(be).toDate()),te)}catch{return new Date("")}}(k,g,M,U),this.init(),ae&&ae!==!0&&(this.$L=this.locale(ae).$L),ne&&k!=this.format(g)&&(this.$d=new Date("")),u={}}else if(g instanceof Array)for(var ee=g.length,W=1;W<=ee;W+=1){v[1]=g[W-1];var Z=U.apply(this,v);if(Z.isValid()){this.$d=Z.$d,this.$L=Z.$L,this.init();break}W===ee&&(this.$d=new Date(""))}else j.call(this,N)}}})}(Aa)),Aa.exports}var nf=rf();const sf=vt(nf);var Ma={exports:{}},af=Ma.exports,Rl;function of(){return Rl||(Rl=1,function(t,r){(function(s,a){t.exports=a()})(af,function(){var s={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"};return function(a,n,o){var i=n.prototype,c=i.format;o.en.formats=s,i.format=function(u){u===void 0&&(u="YYYY-MM-DDTHH:mm:ssZ");var d=this.$locale().formats,p=function(y,w){return y.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(O,_,E){var b=E&&E.toUpperCase();return _||w[E]||s[E]||w[b].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(I,U,S){return U||S.slice(1)})})}(u,d===void 0?{}:d);return c.call(this,p)}}})}(Ma)),Ma.exports}var lf=of();const cf=vt(lf);var Ra={exports:{}},uf=Ra.exports,Nl;function df(){return Nl||(Nl=1,function(t,r){(function(s,a){t.exports=a()})(uf,function(){return function(s,a,n){a.prototype.isBetween=function(o,i,c,u){var d=n(o),p=n(i),y=(u=u||"()")[0]==="(",w=u[1]===")";return(y?this.isAfter(d,c):!this.isBefore(d,c))&&(w?this.isBefore(p,c):!this.isAfter(p,c))||(y?this.isBefore(d,c):!this.isAfter(d,c))&&(w?this.isAfter(p,c):!this.isBefore(p,c))}}})}(Ra)),Ra.exports}var pf=df();const hf=vt(pf);Ze.extend(sf);Ze.extend(cf);Ze.extend(hf);const mf=Pd(["Your locale has not been found.","Either the locale key is not a supported one. Locales supported by dayjs are available here: https://github.com/iamkun/dayjs/tree/dev/src/locale","Or you forget to import the locale from 'dayjs/locale/{localeUsed}'","fallback on English locale"]),ff={YY:"year",YYYY:{sectionType:"year",contentType:"digit",maxLength:4},M:{sectionType:"month",contentType:"digit",maxLength:2},MM:"month",MMM:{sectionType:"month",contentType:"letter"},MMMM:{sectionType:"month",contentType:"letter"},D:{sectionType:"day",contentType:"digit",maxLength:2},DD:"day",Do:{sectionType:"day",contentType:"digit-with-letter"},d:{sectionType:"weekDay",contentType:"digit",maxLength:2},dd:{sectionType:"weekDay",contentType:"letter"},ddd:{sectionType:"weekDay",contentType:"letter"},dddd:{sectionType:"weekDay",contentType:"letter"},A:"meridiem",a:"meridiem",H:{sectionType:"hours",contentType:"digit",maxLength:2},HH:"hours",h:{sectionType:"hours",contentType:"digit",maxLength:2},hh:"hours",m:{sectionType:"minutes",contentType:"digit",maxLength:2},mm:"minutes",s:{sectionType:"seconds",contentType:"digit",maxLength:2},ss:"seconds"},gf={year:"YYYY",month:"MMMM",monthShort:"MMM",dayOfMonth:"D",weekday:"dddd",weekdayShort:"dd",hours24h:"HH",hours12h:"hh",meridiem:"A",minutes:"mm",seconds:"ss",fullDate:"ll",fullDateWithWeekday:"dddd, LL",keyboardDate:"L",shortDate:"MMM D",normalDate:"D MMMM",normalDateWithWeekday:"ddd, MMM D",monthAndYear:"MMMM YYYY",monthAndDate:"MMMM D",fullTime:"LT",fullTime12h:"hh:mm A",fullTime24h:"HH:mm",fullDateTime:"lll",fullDateTime12h:"ll hh:mm A",fullDateTime24h:"ll HH:mm",keyboardDateTime:"L LT",keyboardDateTime12h:"L hh:mm A",keyboardDateTime24h:"L HH:mm"},Ho=["Missing UTC plugin","To be able to use UTC or timezones, you have to enable the `utc` plugin","Find more information on https://mui.com/x/react-date-pickers/timezone/#day-js-and-utc"].join(`
`),Ll=["Missing timezone plugin","To be able to use timezones, you have to enable both the `utc` and the `timezone` plugin","Find more information on https://mui.com/x/react-date-pickers/timezone/#day-js-and-timezone"].join(`
`),xf=(t,r)=>r?(...s)=>t(...s).locale(r):t;class Tn{constructor({locale:r,formats:s,instance:a}={}){var n;this.isMUIAdapter=!0,this.isTimezoneCompatible=!0,this.lib="dayjs",this.rawDayJsInstance=void 0,this.dayjs=void 0,this.locale=void 0,this.formats=void 0,this.escapedCharacters={start:"[",end:"]"},this.formatTokenMap=ff,this.setLocaleToValue=o=>{const i=this.getCurrentLocaleCode();return i===o.locale()?o:o.locale(i)},this.hasUTCPlugin=()=>typeof Ze.utc<"u",this.hasTimezonePlugin=()=>typeof Ze.tz<"u",this.isSame=(o,i,c)=>{const u=this.setTimezone(i,this.getTimezone(o));return o.format(c)===u.format(c)},this.cleanTimezone=o=>{switch(o){case"default":return;case"system":return Ze.tz.guess();default:return o}},this.createSystemDate=o=>{if(this.rawDayJsInstance)return this.rawDayJsInstance(o);if(this.hasUTCPlugin()&&this.hasTimezonePlugin()){const i=Ze.tz.guess();return i!=="UTC"?Ze.tz(o,i):Ze(o)}return Ze(o)},this.createUTCDate=o=>{if(!this.hasUTCPlugin())throw new Error(Ho);return Ze.utc(o)},this.createTZDate=(o,i)=>{if(!this.hasUTCPlugin())throw new Error(Ho);if(!this.hasTimezonePlugin())throw new Error(Ll);const c=o!==void 0&&!o.endsWith("Z");return Ze(o).tz(this.cleanTimezone(i),c)},this.getLocaleFormats=()=>{const o=Ze.Ls,i=this.locale||"en";let c=o[i];return c===void 0&&(mf(),c=o.en),c.formats},this.adjustOffset=o=>{if(!this.hasTimezonePlugin())return o;const i=this.getTimezone(o);if(i!=="UTC"){var c,u;const d=o.tz(this.cleanTimezone(i),!0);if(((c=d.$offset)!=null?c:0)===((u=o.$offset)!=null?u:0))return o;o.$offset=d.$offset}return o},this.date=o=>o===null?null:this.dayjs(o),this.dateWithTimezone=(o,i)=>{if(o===null)return null;let c;return i==="UTC"?c=this.createUTCDate(o):i==="system"||i==="default"&&!this.hasTimezonePlugin()?c=this.createSystemDate(o):c=this.createTZDate(o,i),this.locale===void 0?c:c.locale(this.locale)},this.getTimezone=o=>{if(this.hasTimezonePlugin()){var i;const c=(i=o.$x)==null?void 0:i.$timezone;if(c)return c}return this.hasUTCPlugin()&&o.isUTC()?"UTC":"system"},this.setTimezone=(o,i)=>{if(this.getTimezone(o)===i)return o;if(i==="UTC"){if(!this.hasUTCPlugin())throw new Error(Ho);return o.utc()}if(i==="system")return o.local();if(!this.hasTimezonePlugin()){if(i==="default")return o;throw new Error(Ll)}return Ze.tz(o,this.cleanTimezone(i))},this.toJsDate=o=>o.toDate(),this.parseISO=o=>this.dayjs(o),this.toISO=o=>o.toISOString(),this.parse=(o,i)=>o===""?null:this.dayjs(o,i,this.locale,!0),this.getCurrentLocaleCode=()=>this.locale||"en",this.is12HourCycleInCurrentLocale=()=>/A|a/.test(this.getLocaleFormats().LT||""),this.expandFormat=o=>{const i=this.getLocaleFormats(),c=u=>u.replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,(d,p,y)=>p||y.slice(1));return o.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,(u,d,p)=>{const y=p&&p.toUpperCase();return d||i[p]||c(i[y])})},this.getFormatHelperText=o=>this.expandFormat(o).replace(/a/gi,"(a|p)m").toLocaleLowerCase(),this.isNull=o=>o===null,this.isValid=o=>this.dayjs(o).isValid(),this.format=(o,i)=>this.formatByString(o,this.formats[i]),this.formatByString=(o,i)=>this.dayjs(o).format(i),this.formatNumber=o=>o,this.getDiff=(o,i,c)=>o.diff(i,c),this.isEqual=(o,i)=>o===null&&i===null?!0:this.dayjs(o).toDate().getTime()===this.dayjs(i).toDate().getTime(),this.isSameYear=(o,i)=>this.isSame(o,i,"YYYY"),this.isSameMonth=(o,i)=>this.isSame(o,i,"YYYY-MM"),this.isSameDay=(o,i)=>this.isSame(o,i,"YYYY-MM-DD"),this.isSameHour=(o,i)=>o.isSame(i,"hour"),this.isAfter=(o,i)=>o>i,this.isAfterYear=(o,i)=>this.hasUTCPlugin()?!this.isSameYear(o,i)&&o.utc()>i.utc():o.isAfter(i,"year"),this.isAfterDay=(o,i)=>this.hasUTCPlugin()?!this.isSameDay(o,i)&&o.utc()>i.utc():o.isAfter(i,"day"),this.isBefore=(o,i)=>o<i,this.isBeforeYear=(o,i)=>this.hasUTCPlugin()?!this.isSameYear(o,i)&&o.utc()<i.utc():o.isBefore(i,"year"),this.isBeforeDay=(o,i)=>this.hasUTCPlugin()?!this.isSameDay(o,i)&&o.utc()<i.utc():o.isBefore(i,"day"),this.isWithinRange=(o,[i,c])=>o>=i&&o<=c,this.startOfYear=o=>this.adjustOffset(o.startOf("year")),this.startOfMonth=o=>this.adjustOffset(o.startOf("month")),this.startOfWeek=o=>this.adjustOffset(o.startOf("week")),this.startOfDay=o=>this.adjustOffset(o.startOf("day")),this.endOfYear=o=>this.adjustOffset(o.endOf("year")),this.endOfMonth=o=>this.adjustOffset(o.endOf("month")),this.endOfWeek=o=>this.adjustOffset(o.endOf("week")),this.endOfDay=o=>this.adjustOffset(o.endOf("day")),this.addYears=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"year"):o.add(i,"year")),this.addMonths=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"month"):o.add(i,"month")),this.addWeeks=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"week"):o.add(i,"week")),this.addDays=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"day"):o.add(i,"day")),this.addHours=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"hour"):o.add(i,"hour")),this.addMinutes=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"minute"):o.add(i,"minute")),this.addSeconds=(o,i)=>this.adjustOffset(i<0?o.subtract(Math.abs(i),"second"):o.add(i,"second")),this.getYear=o=>o.year(),this.getMonth=o=>o.month(),this.getDate=o=>o.date(),this.getHours=o=>o.hour(),this.getMinutes=o=>o.minute(),this.getSeconds=o=>o.second(),this.getMilliseconds=o=>o.millisecond(),this.setYear=(o,i)=>this.adjustOffset(o.set("year",i)),this.setMonth=(o,i)=>this.adjustOffset(o.set("month",i)),this.setDate=(o,i)=>this.adjustOffset(o.set("date",i)),this.setHours=(o,i)=>this.adjustOffset(o.set("hour",i)),this.setMinutes=(o,i)=>this.adjustOffset(o.set("minute",i)),this.setSeconds=(o,i)=>this.adjustOffset(o.set("second",i)),this.setMilliseconds=(o,i)=>this.adjustOffset(o.set("millisecond",i)),this.getDaysInMonth=o=>o.daysInMonth(),this.getNextMonth=o=>this.addMonths(o,1),this.getPreviousMonth=o=>this.addMonths(o,-1),this.getMonthArray=o=>{const c=[o.startOf("year")];for(;c.length<12;){const u=c[c.length-1];c.push(this.addMonths(u,1))}return c},this.mergeDateAndTime=(o,i)=>o.hour(i.hour()).minute(i.minute()).second(i.second()),this.getWeekdays=()=>{const o=this.dayjs().startOf("week");return[0,1,2,3,4,5,6].map(i=>this.formatByString(this.addDays(o,i),"dd"))},this.getWeekArray=o=>{const i=this.setLocaleToValue(o),c=i.startOf("month").startOf("week"),u=i.endOf("month").endOf("week");let d=0,p=c;const y=[];for(;p<u;){const w=Math.floor(d/7);y[w]=y[w]||[],y[w].push(p),p=this.addDays(p,1),d+=1}return y},this.getWeekNumber=o=>o.week(),this.getYearRange=(o,i)=>{const c=o.startOf("year"),u=i.endOf("year"),d=[];let p=c;for(;p<u;)d.push(p),p=this.addYears(p,1);return d},this.getMeridiemText=o=>o==="am"?"AM":"PM",this.rawDayJsInstance=a,this.dayjs=xf((n=this.rawDayJsInstance)!=null?n:Ze,r),this.locale=r,this.formats=Yc({},gf,s),Ze.extend(ef)}}const yf=({onClick:t,isOpen:r,unreadCount:s=0})=>e.jsx(Ed,{color:"primary","aria-label":"chat",onClick:t,sx:{position:"fixed",bottom:24,right:24,zIndex:1e3,boxShadow:3,"&:hover":{transform:"scale(1.1)",transition:"transform 0.2s ease-in-out"}},children:e.jsx(Dd,{badgeContent:s,color:"error",children:e.jsx(Td,{})})}),vf=({message:t})=>{const r=t.sender==="user";return e.jsxs(q,{sx:{display:"flex",justifyContent:r?"flex-end":"flex-start",mb:2,gap:1},children:[!r&&e.jsx(ni,{sx:{bgcolor:"primary.main",width:32,height:32},children:e.jsx(Od,{fontSize:"small"})}),e.jsxs(qe,{elevation:1,sx:{maxWidth:"70%",p:2,bgcolor:r?"primary.main":"grey.100",color:r?"white":"text.primary",borderRadius:2,wordWrap:"break-word"},children:[e.jsx(f,{variant:"body2",sx:{whiteSpace:"pre-wrap"},children:t.text}),e.jsx(f,{variant:"caption",sx:{display:"block",mt:.5,opacity:.7,textAlign:r?"right":"left"},children:t.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),r&&e.jsx(ni,{sx:{bgcolor:"secondary.main",width:32,height:32},children:e.jsx(ki,{fontSize:"small"})})]})},_f=({onSendMessage:t,disabled:r=!1,placeholder:s="Type your message..."})=>{const[a,n]=l.useState(""),o=()=>{a.trim()&&!r&&(t(a.trim()),n(""))},i=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),o())};return e.jsx(qe,{elevation:2,sx:{p:2,borderTop:1,borderColor:"divider"},children:e.jsxs(q,{sx:{display:"flex",gap:1,alignItems:"flex-end"},children:[e.jsx(ie,{fullWidth:!0,multiline:!0,maxRows:4,value:a,onChange:c=>n(c.target.value),onKeyPress:i,placeholder:s,disabled:r,variant:"outlined",size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}}),e.jsx(ot,{color:"primary",onClick:o,disabled:!a.trim()||r,sx:{bgcolor:"primary.main",color:"white","&:hover":{bgcolor:"primary.dark"},"&.Mui-disabled":{bgcolor:"grey.300",color:"grey.500"}},children:e.jsx(Id,{})})]})})},ql={async testConnection(){try{const t=await $.get("/api/ai-assistant/health");return console.log("AI Assistant Health Check:",t.data),t.data.success&&t.data.data.status==="healthy"}catch(t){return console.error("AI Assistant Health Check Error:",t),!1}},async sendMessage(t,r){try{console.log("Sending message to AI assistant:",t);const s={message:t};r&&(s.conversationId=r);const a=await $.post("/api/ai-assistant/chat",s);if(console.log("AI Assistant Response:",a.data),a.data.success)return a.data.data;throw new Error(a.data.message||"Failed to get response from AI assistant")}catch(s){return console.error("Error calling AI assistant API:",s),{response:this.getFallbackResponse(t),sources:["fallback"],confidence:.5,toolUsed:"fallback",timestamp:new Date().toISOString()}}},async getConversationHistory(t){try{const r=await $.get(`/api/ai-assistant/conversation/${t}`);return r.data.success?r.data.data.messages:[]}catch(r){return console.error("Error getting conversation history:",r),[]}},async clearConversation(t){try{return(await $.delete(`/api/ai-assistant/conversation/${t}`)).data.success}catch(r){return console.error("Error clearing conversation:",r),!1}},async getStatistics(){try{const t=await $.get("/api/ai-assistant/stats");return t.data.success?t.data.data:{}}catch(t){return console.error("Error getting AI assistant statistics:",t),{}}},getFallbackResponse(t){const r=t.toLowerCase();return r.includes("hello")||r.includes("hi")?"Hello! I'm your AI assistant for the NeuraTask business management system. How can I help you today?":r.includes("inventory")||r.includes("stock")?"I can help you with inventory management. You can check your current stock levels, add new items, or track inventory movements in the Inventory section. Navigate to 'Stock' in the sidebar to manage your inventory.":r.includes("customer")||r.includes("client")?"For customer management, you can view and manage your customer database in the Customers section. You can add new customers, view their details, and track their orders. Find this in the 'Customers' section of the sidebar.":r.includes("purchase")||r.includes("order")?"Purchase orders can be managed in the Purchase Orders section. You can create new orders, track existing ones, and manage vendor relationships. Look for 'Purchase Orders' in the sidebar under the Purchasing section.":r.includes("sales")||r.includes("quote")?"Sales and quotes are handled in the Sales Orders and Quotes sections. You can create quotes, convert them to orders, and track your sales pipeline. These are available in the 'Sales' section of the sidebar.":r.includes("time")||r.includes("tracking")?"Time tracking features are available in the Time Tracking section. You can log hours, view reports, and manage employee attendance. Find this under 'Employees & Time Tracking' in the sidebar.":r.includes("help")||r.includes("support")?"I'm here to help! You can ask me about any aspect of the NeuraTask system - inventory, customers, orders, time tracking, or general navigation. What would you like to know?":"I'm here to help you with the NeuraTask business management system. You can ask me about inventory, customers, purchase orders, sales, time tracking, or any other features. How can I assist you?"}},Yo="chat_messages",Wu=()=>{const[t,r]=l.useState([]),[s,a]=l.useState(!1),[n,o]=l.useState(!1);l.useEffect(()=>{const w=localStorage.getItem(Yo);if(w)try{const _=JSON.parse(w).map(E=>({...E,timestamp:new Date(E.timestamp)}));r(_)}catch(O){console.error("Error loading chat messages:",O)}},[]),l.useEffect(()=>{localStorage.setItem(Yo,JSON.stringify(t))},[t]);const i=l.useCallback(w=>{r(O=>[...O,w])},[]),c=l.useCallback(async w=>{const O={id:Date.now().toString(),text:w,sender:"user",timestamp:new Date};i(O),a(!0);try{const _=await ql.sendMessage(w);console.log("AI Response in useChat:",_),console.log("AI Response type:",typeof _),console.log("AI Response keys:",Object.keys(_));const E={id:(Date.now()+1).toString(),text:_.response||"No response received",sender:"ai",timestamp:new Date};i(E)}catch(_){console.error("Error sending message:",_);const E={id:(Date.now()+1).toString(),text:"Sorry, I encountered an error. Please try again.",sender:"ai",timestamp:new Date};i(E)}finally{a(!1)}},[i]),u=l.useCallback(()=>{r([]),localStorage.removeItem(Yo)},[]),d=l.useCallback(()=>{o(w=>!w)},[]),p=l.useCallback(()=>{o(!1)},[]),y=l.useCallback(async()=>{o(!0);const w=await ql.testConnection();console.log("API Connection Test:",w?"SUCCESS":"FAILED")},[]);return{messages:t,isLoading:s,isOpen:n,sendMessage:c,clearMessages:u,toggleChat:d,closeChat:p,openChat:y}},bf=({isOpen:t,onClose:r})=>{const{messages:s,isLoading:a,sendMessage:n,clearMessages:o}=Wu(),i=l.useRef(null);l.useEffect(()=>{i.current?.scrollIntoView({behavior:"smooth"})},[s]);const c=()=>{window.confirm("Are you sure you want to clear all messages?")&&o()};return e.jsxs(si,{anchor:"right",open:t,onClose:r,sx:{"& .MuiDrawer-paper":{width:{xs:"100%",sm:400},maxWidth:"100vw",height:"100%",display:"flex",flexDirection:"column"}},children:[e.jsxs(q,{sx:{p:2,borderBottom:1,borderColor:"divider",display:"flex",alignItems:"center",justifyContent:"space-between",bgcolor:"primary.main",color:"white"},children:[e.jsx(f,{variant:"h6",sx:{fontWeight:"bold"},children:"AI Assistant"}),e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(K,{variant:"outlined",size:"small",onClick:c,sx:{color:"white",borderColor:"white","&:hover":{borderColor:"white",bgcolor:"rgba(255, 255, 255, 0.1)"},textTransform:"none",fontSize:"0.75rem",px:1,py:.5},children:"Clear Chat"}),e.jsx(ot,{color:"inherit",onClick:r,size:"small",children:e.jsx(Ad,{})})]})]}),e.jsx(q,{sx:{flex:1,overflow:"auto",p:2,display:"flex",flexDirection:"column",gap:1},children:s.length===0?e.jsxs(q,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",textAlign:"center",color:"text.secondary"},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Welcome to AI Assistant"}),e.jsxs(f,{variant:"body2",children:["I'm here to help you with your business management tasks.",e.jsx("br",{}),"Ask me anything about inventory, customers, orders, or time tracking!"]})]}):e.jsxs(e.Fragment,{children:[s.map(u=>e.jsx(vf,{message:u},u.id)),a&&e.jsx(q,{sx:{display:"flex",justifyContent:"flex-start",mb:2,gap:1},children:e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:1,p:2,bgcolor:"grey.100",borderRadius:2},children:[e.jsx(it,{size:16}),e.jsx(f,{variant:"body2",color:"text.secondary",children:"AI is typing..."})]})}),e.jsx("div",{ref:i})]})}),e.jsx(Sn,{}),e.jsx(_f,{onSendMessage:n,disabled:a,placeholder:"Ask me anything about your business..."})]})},Hs=async()=>{try{const t=await window?.api?.timeEvents?.pendingCount?.();return t?.success?t.count:0}catch{return 0}},jf=async(t=200)=>{const r=await window?.api?.timeEvents?.listPending?.(t);return r?.success?r.rows:[]},Ul=async()=>{const t=await jf(200);let r=0,s=0;const a=[];for(const n of t)try{const o=JSON.parse(n.payload_json||"{}");switch(n.type){case"attendance_clock_in":await $.post("/api/attendance/clock-in",{profile_id:o.profile_id});break;case"attendance_clock_out":await $.post("/api/attendance/clock-out",{shift_id:o.shift_id});break;case"attendance_update":await $.put(`/api/attendance/${o.shift_id}`,{clock_in:o.clock_in,clock_out:o.clock_out});break;case"time_clock_in":await $.post("/api/time-tracking/time-entries/clock-in",{profile_id:o.profile_id,so_id:o.so_id});break;case"time_clock_out":await $.post(`/api/time-tracking/time-entries/${o.id}/clock-out`);break;default:s++;continue}a.push(n.event_id),r++}catch{s++}return a.length&&await window?.api?.timeEvents?.markSynced?.(a),{synced:r,failed:s}},Ln=240,wf=()=>{const[t,r]=ft.useState(!1),s=qt(),{logout:a,user:n}=Qt(),{isOpen:o,toggleChat:i,closeChat:c}=Wu(),[u,d]=l.useState(0);l.useEffect(()=>{let E=!0;const b=async()=>{try{const U=await Hs();E&&d(U)}catch{}},I=setInterval(b,15e3);return b(),()=>{E=!1,clearInterval(I)}},[]);const p=()=>{r(!t)},y=()=>{a(),s("/login")},w=[{type:"header",text:"Dashboard"},{text:"Dashboard",icon:e.jsx(oi,{}),path:"/dashboard"},{type:"header",text:"Purchasing"},{text:"Purchase Orders",icon:e.jsx(Hn,{}),path:"/open-purchase-orders"},{text:"Parts to Order",icon:e.jsx(hr,{}),path:"/parts-to-order"},{text:"Vendors",icon:e.jsx(Gc,{}),path:"/vendors"},{type:"header",text:"Sales"},{text:"Quotes",icon:e.jsx(ii,{}),path:"/quotes"},{text:"Sales Orders",icon:e.jsx(zn,{}),path:"/open-sales-orders"},{text:"Customers",icon:e.jsx(Qs,{}),path:"/customers"},{type:"header",text:"Products & Inventory"},{text:"Products",icon:e.jsx(Qc,{}),path:"/products"},{text:"Stock",icon:e.jsx(hr,{}),path:"/inventory"},{text:"Supply",icon:e.jsx(hr,{}),path:"/supply"},{type:"header",text:"Time Tracking"},{text:"Attendance",icon:e.jsx(vn,{}),path:"/attendance"},{text:"Time Tracking",icon:e.jsx(vn,{}),path:"/time-tracking"},{text:"Time Tracking Reports",icon:e.jsx(Jc,{}),path:"/time-tracking/reports"},{type:"header",text:"Human Resources"},{text:"Employees",icon:e.jsx(Kc,{}),path:"/employees"},{text:"Profile Documents",icon:e.jsx(Ud,{}),path:"/profile-documents"},{text:"Leave Management",icon:e.jsx(ai,{}),path:"/leave-management"},{text:"Mobile User Access",icon:e.jsx(Qs,{}),path:"/mobile-user-access"},{type:"header",text:"Settings"},{text:"Business Profile",icon:e.jsx(Pi,{}),path:"/business-profile"},{text:"Accounting",icon:e.jsx($a,{}),path:"/qbo-account-mapping"},{text:"Global Variables",icon:e.jsx($a,{}),path:"/margin-schedule"},{text:"Email Settings",icon:e.jsx(Fa,{}),path:"/email-settings"},{text:"Backup Management",icon:e.jsx(Ei,{}),path:"/backup-management"}],O=ft.useMemo(()=>{if(n?.access_role==="Time Tracking")return[{type:"header",text:"Time Tracking"},{text:"Attendance",icon:e.jsx(vn,{}),path:"/attendance"},{text:"Time Tracking",icon:e.jsx(vn,{}),path:"/time-tracking"},{type:"header",text:"Human Resources"},{text:"Leave Management",icon:e.jsx(ai,{}),path:"/leave-management"},{type:"header",text:"Sales"},{text:"Sales Orders",icon:e.jsx(zn,{}),path:"/open-sales-orders"}];const E=[{type:"header",text:"Main"},{text:"Dashboard",icon:e.jsx(oi,{}),path:"/"}];return n?.access_role==="Sales and Purchase"?[...E,{type:"header",text:"Sales & Purchase"},{text:"Sales Orders",icon:e.jsx(zn,{}),path:"/open-sales-orders"},{text:"Purchase Orders",icon:e.jsx(Hn,{}),path:"/open-purchase-orders"},{text:"Parts to Order",icon:e.jsx(hr,{}),path:"/parts-to-order"},{type:"header",text:"Inventory"},{text:"Stock",icon:e.jsx(hr,{}),path:"/inventory"},{text:"Supply",icon:e.jsx(hr,{}),path:"/supply"},{type:"header",text:"Settings"},{text:"Email Settings",icon:e.jsx(Fa,{}),path:"/email-settings"}]:w},[n,w]),_=e.jsxs("div",{children:[e.jsx(Uo,{}),e.jsx(wr,{children:O.map((E,b)=>E.type==="header"?e.jsx(Md,{sx:{bgcolor:"inherit",color:"text.secondary",fontWeight:"bold",fontSize:13,textAlign:"left",pl:2},children:E.text},`header-${E.text}-${b}`):e.jsxs(Sr,{onClick:()=>{s(E.path),r(!1)},sx:{cursor:"pointer"},children:[e.jsx(Rd,{children:E.icon}),e.jsx(Cr,{primary:E.text})]},E.path||`${E.text}-${b}`))})]});return e.jsxs(q,{sx:{display:"flex"},children:[e.jsx(Nd,{position:"fixed",sx:{width:{sm:`calc(100% - ${Ln}px)`},ml:{sm:`${Ln}px`}},children:e.jsxs(Uo,{children:[e.jsx(K,{color:"inherit",startIcon:e.jsx(Vc,{}),onClick:()=>s(-1),sx:{mr:2,display:{xs:"none",sm:"inline-flex"}},children:"Back"}),e.jsx(ot,{color:"inherit","aria-label":"open drawer",edge:"start",onClick:p,sx:{mr:2,display:{sm:"none"}},children:e.jsx(Ld,{})}),e.jsxs(q,{sx:{marginLeft:"auto",display:"flex",alignItems:"center",gap:2},children:[!!window.__backendUnavailableSince&&e.jsx(ar,{title:"Backend unavailable; pending events will sync automatically when online.",children:e.jsxs(q,{sx:{bgcolor:"orange",color:"black",px:1.5,py:.5,borderRadius:1,fontSize:12},children:["Offline",u?` • Pending: ${u}`:""]})}),e.jsx(K,{color:"inherit",onClick:y,startIcon:e.jsx(qd,{}),children:"Logout"})]})]})}),e.jsxs(q,{component:"nav",sx:{width:{sm:Ln},flexShrink:{sm:0}},children:[e.jsx(si,{variant:"temporary",open:t,onClose:p,ModalProps:{keepMounted:!0},sx:{display:{xs:"block",sm:"none"},"& .MuiDrawer-paper":{boxSizing:"border-box",width:Ln}},children:_}),e.jsx(si,{variant:"permanent",sx:{display:{xs:"none",sm:"block"},"& .MuiDrawer-paper":{boxSizing:"border-box",width:Ln}},open:!0,children:_})]}),e.jsxs(q,{component:"main",sx:{flexGrow:1,p:3,width:{sm:`calc(100% - ${Ln}px)`}},children:[e.jsx(Uo,{}),e.jsx(th,{})]}),e.jsx(yf,{onClick:i,isOpen:o}),e.jsx(bf,{isOpen:o,onClose:c})]})},Sf=()=>{const t=qt(),{login:r}=Qt(),[s,a]=l.useState({email:"",password:""}),[n,o]=l.useState(null),[i,c]=l.useState(!1),[u,d]=l.useState(!1);l.useEffect(()=>{const w=localStorage.getItem("rememberedEmail"),O=localStorage.getItem("rememberedPassword");w&&O&&(a({email:w,password:O}),d(!0))},[]);const p=w=>{const{name:O,value:_}=w.target;a(E=>({...E,[O]:_}))},y=async w=>{w.preventDefault(),o(null),c(!0),u?(localStorage.setItem("rememberedEmail",s.email),localStorage.setItem("rememberedPassword",s.password)):(localStorage.removeItem("rememberedEmail"),localStorage.removeItem("rememberedPassword"));try{const O=await $.post("/api/auth/login",s),{sessionToken:_,refreshToken:E,user:b}=O.data;r(_,E,b),b.access_role==="Time Tracking"?t("/time-tracking"):b.access_role==="Quotes"?t("/quotes"):t("/")}catch(O){console.error("Login error:",O);try{const _=localStorage.getItem("user"),E=_?JSON.parse(_):null,b=localStorage.getItem("sessionToken"),I=localStorage.getItem("refreshToken");if(E&&E.access_role==="Time Tracking"&&b&&I){t("/time-tracking");return}}catch{}o(O.response?.data?.message||"Failed to login. Please try again.")}finally{c(!1)}};return e.jsx(Qe,{component:"main",maxWidth:"xs",children:e.jsx(q,{sx:{marginTop:8,display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsxs(qe,{elevation:3,sx:{padding:4,display:"flex",flexDirection:"column",alignItems:"center",width:"100%"},children:[e.jsx(f,{component:"h1",variant:"h5",gutterBottom:!0,children:"Sign In"}),n&&e.jsx(Re,{severity:"error",sx:{width:"100%",mb:2},children:n}),e.jsxs(q,{component:"form",onSubmit:y,sx:{mt:1,width:"100%"},children:[e.jsx(ie,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",autoFocus:!0,value:s.email,onChange:p}),e.jsx(ie,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Password",type:"password",id:"password",autoComplete:"current-password",value:s.password,onChange:p}),e.jsx(ra,{control:e.jsx(Ba,{value:"remember",color:"primary",checked:u,onChange:w=>d(w.target.checked)}),label:"Remember me"}),e.jsx(K,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2},disabled:i,children:i?"Signing in...":"Sign In"}),e.jsx(q,{sx:{textAlign:"center"},children:e.jsx(Wd,{component:hh,to:"/register",variant:"body2",children:"Don't have an account? Register your company"})})]})]})})})},Cf=()=>{const t=qt(),{login:r}=Qt(),[s,a]=l.useState({companyName:"",adminUsername:"",adminEmail:"",adminPassword:"",confirmPassword:""}),[n,o]=l.useState(null),[i,c]=l.useState(!1),u=p=>{const{name:y,value:w}=p.target;a(O=>({...O,[y]:w}))},d=async p=>{if(p.preventDefault(),o(null),s.adminPassword!==s.confirmPassword){o("Passwords do not match");return}c(!0);try{const y=await $.post("/api/auth/register-company",{company_name:s.companyName,admin_username:s.adminUsername,admin_email:s.adminEmail,admin_password:s.adminPassword}),{sessionToken:w,refreshToken:O,user:_}=y.data;r(w,O,_),t("/dashboard")}catch(y){console.error("Registration error:",y),o(y.response?.data?.message||"Failed to register company. Please try again.")}finally{c(!1)}};return e.jsx(Qe,{component:"main",maxWidth:"sm",children:e.jsx(q,{sx:{marginTop:8,display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsxs(qe,{elevation:3,sx:{padding:4,display:"flex",flexDirection:"column",alignItems:"center",width:"100%"},children:[e.jsx(f,{component:"h1",variant:"h5",gutterBottom:!0,children:"Register Your Company"}),n&&e.jsx(Re,{severity:"error",sx:{width:"100%",mb:2},children:n}),e.jsxs(q,{component:"form",onSubmit:d,sx:{mt:3,width:"100%"},children:[e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{required:!0,fullWidth:!0,label:"Company Name",name:"companyName",value:s.companyName,onChange:u})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{required:!0,fullWidth:!0,label:"Admin Username",name:"adminUsername",value:s.adminUsername,onChange:u})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{required:!0,fullWidth:!0,label:"Admin Email",name:"adminEmail",type:"email",value:s.adminEmail,onChange:u})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{required:!0,fullWidth:!0,label:"Admin Password",name:"adminPassword",type:"password",value:s.adminPassword,onChange:u})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{required:!0,fullWidth:!0,label:"Confirm Password",name:"confirmPassword",type:"password",value:s.confirmPassword,onChange:u})})]}),e.jsx(K,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2},disabled:i,children:i?"Registering...":"Register Company"})]})]})})})},kf={Purchasing:e.jsx(Hn,{sx:{color:"primary.main"}}),Sales:e.jsx(zn,{sx:{color:"primary.main"}}),"Products & Inventory":e.jsx(hr,{sx:{color:"primary.main"}}),"Time Tracking":e.jsx(vn,{sx:{color:"primary.main"}}),"Human Resources":e.jsx(Qs,{sx:{color:"primary.main"}}),Settings:e.jsx(Pi,{sx:{color:"primary.main"}})},Wl=()=>{const t=qt(),r=Fd(),{user:s}=Qt();console.log("[LandingPage] user:",s);let n=[{title:"Purchasing",items:[{title:"Purchase Orders",description:"Manage purchase orders",icon:e.jsx(Hn,{sx:{fontSize:40,color:"primary.main"}}),path:"/open-purchase-orders"},{title:"Parts to Order",description:"Manage parts ordering",icon:e.jsx(hr,{sx:{fontSize:40,color:"primary.main"}}),path:"/parts-to-order"},{title:"Vendors",description:"Manage your vendors",icon:e.jsx(Gc,{sx:{fontSize:40,color:"primary.main"}}),path:"/vendors"}]},{title:"Sales",items:[{title:"Quotes",description:"Manage and track quotes",icon:e.jsx(ii,{sx:{fontSize:40,color:"primary.main"}}),path:"/quotes"},{title:"Sales Orders",description:"Manage sales orders",icon:e.jsx(zn,{sx:{fontSize:40,color:"primary.main"}}),path:"/open-sales-orders"},{title:"Customers",description:"Track and manage your customer relationships",icon:e.jsx(Qs,{sx:{fontSize:40,color:"primary.main"}}),path:"/customers"}]},{title:"Products & Inventory",items:[{title:"Products",description:"Manage your products",icon:e.jsx(Qc,{sx:{fontSize:40,color:"primary.main"}}),path:"/products"},{title:"Stock",description:"Manage your product inventory and stock levels",icon:e.jsx(hr,{sx:{fontSize:40,color:"primary.main"}}),path:"/inventory"},{title:"Supply",description:"Manage supply and materials",icon:e.jsx(hr,{sx:{fontSize:40,color:"primary.main"}}),path:"/supply"}]},{title:"Time Tracking",items:[{title:"Attendance",description:"View and manage attendance records",icon:e.jsx(vn,{sx:{fontSize:40,color:"primary.main"}}),path:"/attendance"},{title:"Time Tracking",description:"Track employee time and project hours",icon:e.jsx(vn,{sx:{fontSize:40,color:"primary.main"}}),path:"/time-tracking"},{title:"Time Tracking Reports",description:"View and export time tracking reports",icon:e.jsx(Jc,{sx:{fontSize:40,color:"primary.main"}}),path:"/time-tracking/reports"}]},{title:"Human Resources",items:[{title:"Employees",description:"Manage employee accounts and roles",icon:e.jsx(Kc,{sx:{fontSize:40,color:"primary.main"}}),path:"/employees"},{title:"Profile Documents",description:"Manage and track employee document access and read status",icon:e.jsx(Hn,{sx:{fontSize:40,color:"primary.main"}}),path:"/profile-documents"},{title:"Leave Management",description:"Manage employee leave requests and approvals",icon:e.jsx(ai,{sx:{fontSize:40,color:"primary.main"}}),path:"/leave-management"},{title:"Mobile User Access",description:"Manage mobile user access to profiles",icon:e.jsx(Qs,{sx:{fontSize:40,color:"primary.main"}}),path:"/mobile-user-access"}]},{title:"Settings",items:[{title:"Business Profile",description:"Manage your company information and settings",icon:e.jsx(Pi,{sx:{fontSize:40,color:"primary.main"}}),path:"/business-profile"},{title:"Accounting",description:"Configure QuickBooks account mappings",icon:e.jsx($a,{sx:{fontSize:40,color:"primary.main"}}),path:"/qbo-account-mapping"},{title:"Global Variables",description:"Set and manage margin, labour, and overhead rates",icon:e.jsx($a,{sx:{fontSize:40,color:"primary.main"}}),path:"/margin-schedule"},{title:"Email Settings",description:"Configure system email settings",icon:e.jsx(Fa,{sx:{fontSize:40,color:"primary.main"}}),path:"/email-settings"},{title:"Backup Management",description:"Manage system backups and restores",icon:e.jsx(Ei,{sx:{fontSize:40,color:"primary.main"}}),path:"/backup-management"}]}];return s?.access_role==="Sales and Purchase"&&(n=[{title:"Sales & Purchase",items:[{title:"Sales Orders",description:"Manage sales orders",icon:e.jsx(zn,{sx:{fontSize:40,color:"primary.main"}}),path:"/open-sales-orders"},{title:"Purchase Orders",description:"Manage purchase orders",icon:e.jsx(Hn,{sx:{fontSize:40,color:"primary.main"}}),path:"/open-purchase-orders"},{title:"Parts to Order",description:"View parts that need to be ordered",icon:e.jsx(hr,{sx:{fontSize:40,color:"primary.main"}}),path:"/parts-to-order"}]},{title:"Inventory",items:[{title:"Stock",description:"Manage your product inventory and stock levels",icon:e.jsx(hr,{sx:{fontSize:40,color:"primary.main"}}),path:"/inventory"},{title:"Supply",description:"Manage supply and materials",icon:e.jsx(hr,{sx:{fontSize:40,color:"primary.main"}}),path:"/supply"}]},{title:"Settings",items:[{title:"Email Settings",description:"Configure your email settings",icon:e.jsx(Fa,{sx:{fontSize:40,color:"primary.main"}}),path:"/email-settings"}]}]),s?.access_role==="Quotes"&&(n=[{title:"Quotes",items:[{title:"Quotes",description:"Manage and track quotes",icon:e.jsx(ii,{sx:{fontSize:40,color:"primary.main"}}),path:"/quotes"}]}]),console.log("[LandingPage] filteredSections:",n),e.jsxs(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(q,{sx:{background:`linear-gradient(90deg, ${r.palette.primary.main} 0%, ${r.palette.secondary.main} 100%)`,borderRadius:3,p:4,mb:6,color:r.palette.primary.contrastText,boxShadow:3,textAlign:"center"},children:[e.jsx(f,{variant:"h3",component:"h1",gutterBottom:!0,sx:{color:"inherit"},children:"Welcome to NeuraTask"}),e.jsx(f,{variant:"h5",component:"h2",gutterBottom:!0,sx:{color:"inherit",opacity:.85},children:"Your all-in-one business management solution"})]}),n.map((o,i)=>e.jsx(rl,{in:!0,timeout:700+i*200,children:e.jsxs(q,{sx:{mt:6,mb:4,p:3,borderRadius:3,background:r.palette.mode==="light"?r.palette.grey[50]:r.palette.grey[900],boxShadow:1},children:[e.jsxs(q,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(ni,{sx:{bgcolor:"primary.main",mr:2},children:kf[o.title]||e.jsx(oi,{sx:{color:"primary.main"}})}),e.jsx(f,{variant:"h4",component:"h2",sx:{color:"primary.main",fontWeight:600},children:o.title})]}),e.jsx(T,{container:!0,spacing:4,children:o.items.map((c,u)=>e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(rl,{in:!0,timeout:900+u*150,children:e.jsx(mt,{sx:{height:"100%",display:"flex",flexDirection:"column",borderRadius:2,boxShadow:2,transition:"transform 0.2s, box-shadow 0.2s","&:hover":{transform:"translateY(-6px) scale(1.03)",boxShadow:6,cursor:"pointer"},bgcolor:"background.paper"},onClick:()=>t(c.path),tabIndex:0,role:"button","aria-label":c.title,children:e.jsxs(wt,{sx:{flexGrow:1,textAlign:"center"},children:[c.icon,e.jsx(f,{gutterBottom:!0,variant:"h5",component:"h2",children:c.title}),e.jsx(f,{children:c.description})]})})})},u))}),i<n.length-1&&e.jsx(Sn,{sx:{mt:4,mb:2}})]})},o.title))]})};var ms={},Vo={};const Pf=op($d);var Fl;function Rt(){return Fl||(Fl=1,function(t){"use client";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return r.createSvgIcon}});var r=Pf}(Vo)),Vo}var $l;function Ef(){if($l)return ms;$l=1;var t=At();Object.defineProperty(ms,"__esModule",{value:!0}),ms.default=void 0;var r=t(Rt()),s=Mt();return ms.default=(0,r.default)((0,s.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"}),"Delete"),ms}var Df=Ef();const tr=vt(Df);var fs={},Bl;function Tf(){if(Bl)return fs;Bl=1;var t=At();Object.defineProperty(fs,"__esModule",{value:!0}),fs.default=void 0;var r=t(Rt()),s=Mt();return fs.default=(0,r.default)((0,s.jsx)("path",{d:"M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96M14 13v4h-4v-4H7l5-5 5 5z"}),"CloudUpload"),fs}var Of=Tf();const Ga=vt(Of);var gs={},zl;function If(){if(zl)return gs;zl=1;var t=At();Object.defineProperty(gs,"__esModule",{value:!0}),gs.default=void 0;var r=t(Rt()),s=Mt();return gs.default=(0,r.default)((0,s.jsx)("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"}),"Edit"),gs}var Af=If();const Qa=vt(Af),Zs=t=>typeof t=="number"&&!isNaN(t),jn=t=>typeof t=="string",mr=t=>typeof t=="function",Na=t=>jn(t)||mr(t)?t:null,vi=t=>l.isValidElement(t)||jn(t)||mr(t)||Zs(t);function Mf(t,r,s){s===void 0&&(s=300);const{scrollHeight:a,style:n}=t;requestAnimationFrame(()=>{n.minHeight="initial",n.height=a+"px",n.transition=`all ${s}ms`,requestAnimationFrame(()=>{n.height="0",n.padding="0",n.margin="0",setTimeout(r,s)})})}function go(t){let{enter:r,exit:s,appendPosition:a=!1,collapse:n=!0,collapseDuration:o=300}=t;return function(i){let{children:c,position:u,preventExitTransition:d,done:p,nodeRef:y,isIn:w,playToast:O}=i;const _=a?`${r}--${u}`:r,E=a?`${s}--${u}`:s,b=l.useRef(0);return l.useLayoutEffect(()=>{const I=y.current,U=_.split(" "),S=j=>{j.target===y.current&&(O(),I.removeEventListener("animationend",S),I.removeEventListener("animationcancel",S),b.current===0&&j.type!=="animationcancel"&&I.classList.remove(...U))};I.classList.add(...U),I.addEventListener("animationend",S),I.addEventListener("animationcancel",S)},[]),l.useEffect(()=>{const I=y.current,U=()=>{I.removeEventListener("animationend",U),n?Mf(I,p,o):p()};w||(d?U():(b.current=1,I.className+=` ${E}`,I.addEventListener("animationend",U)))},[w]),ft.createElement(ft.Fragment,null,c)}}function Hl(t,r){return t!=null?{content:t.content,containerId:t.props.containerId,id:t.props.toastId,theme:t.props.theme,type:t.props.type,data:t.props.data||{},isLoading:t.props.isLoading,icon:t.props.icon,status:r}:{}}const sr=new Map;let ea=[];const _i=new Set,Rf=t=>_i.forEach(r=>r(t)),Fu=()=>sr.size>0;function $u(t,r){var s;if(r)return!((s=sr.get(r))==null||!s.isToastActive(t));let a=!1;return sr.forEach(n=>{n.isToastActive(t)&&(a=!0)}),a}function Bu(t,r){vi(t)&&(Fu()||ea.push({content:t,options:r}),sr.forEach(s=>{s.buildToast(t,r)}))}function Yl(t,r){sr.forEach(s=>{r!=null&&r!=null&&r.containerId?r?.containerId===s.id&&s.toggle(t,r?.id):s.toggle(t,r?.id)})}function Nf(t){const{subscribe:r,getSnapshot:s,setProps:a}=l.useRef(function(o){const i=o.containerId||1;return{subscribe(c){const u=function(p,y,w){let O=1,_=0,E=[],b=[],I=[],U=y;const S=new Map,j=new Set,N=()=>{I=Array.from(S.values()),j.forEach(v=>v())},k=v=>{b=v==null?[]:b.filter(g=>g!==v),N()},M=v=>{const{toastId:g,onOpen:L,updateId:z,children:ne}=v.props,ae=z==null;v.staleId&&S.delete(v.staleId),S.set(g,v),b=[...b,v.props.toastId].filter(ee=>ee!==v.staleId),N(),w(Hl(v,ae?"added":"updated")),ae&&mr(L)&&L(l.isValidElement(ne)&&ne.props)};return{id:p,props:U,observe:v=>(j.add(v),()=>j.delete(v)),toggle:(v,g)=>{S.forEach(L=>{g!=null&&g!==L.props.toastId||mr(L.toggle)&&L.toggle(v)})},removeToast:k,toasts:S,clearQueue:()=>{_-=E.length,E=[]},buildToast:(v,g)=>{if((X=>{let{containerId:Y,toastId:fe,updateId:se}=X;const ke=Y?Y!==p:p!==1,Pe=S.has(fe)&&se==null;return ke||Pe})(g))return;const{toastId:L,updateId:z,data:ne,staleId:ae,delay:ee}=g,W=()=>{k(L)},Z=z==null;Z&&_++;const J={...U,style:U.toastStyle,key:O++,...Object.fromEntries(Object.entries(g).filter(X=>{let[Y,fe]=X;return fe!=null})),toastId:L,updateId:z,data:ne,closeToast:W,isIn:!1,className:Na(g.className||U.toastClassName),bodyClassName:Na(g.bodyClassName||U.bodyClassName),progressClassName:Na(g.progressClassName||U.progressClassName),autoClose:!g.isLoading&&(P=g.autoClose,m=U.autoClose,P===!1||Zs(P)&&P>0?P:m),deleteToast(){const X=S.get(L),{onClose:Y,children:fe}=X.props;mr(Y)&&Y(l.isValidElement(fe)&&fe.props),w(Hl(X,"removed")),S.delete(L),_--,_<0&&(_=0),E.length>0?M(E.shift()):N()}};var P,m;J.closeButton=U.closeButton,g.closeButton===!1||vi(g.closeButton)?J.closeButton=g.closeButton:g.closeButton===!0&&(J.closeButton=!vi(U.closeButton)||U.closeButton);let A=v;l.isValidElement(v)&&!jn(v.type)?A=l.cloneElement(v,{closeToast:W,toastProps:J,data:ne}):mr(v)&&(A=v({closeToast:W,toastProps:J,data:ne}));const G={content:A,props:J,staleId:ae};U.limit&&U.limit>0&&_>U.limit&&Z?E.push(G):Zs(ee)?setTimeout(()=>{M(G)},ee):M(G)},setProps(v){U=v},setToggle:(v,g)=>{S.get(v).toggle=g},isToastActive:v=>b.some(g=>g===v),getSnapshot:()=>I}}(i,o,Rf);sr.set(i,u);const d=u.observe(c);return ea.forEach(p=>Bu(p.content,p.options)),ea=[],()=>{d(),sr.delete(i)}},setProps(c){var u;(u=sr.get(i))==null||u.setProps(c)},getSnapshot(){var c;return(c=sr.get(i))==null?void 0:c.getSnapshot()}}}(t)).current;a(t);const n=l.useSyncExternalStore(r,s,s);return{getToastToRender:function(o){if(!n)return[];const i=new Map;return t.newestOnTop&&n.reverse(),n.forEach(c=>{const{position:u}=c.props;i.has(u)||i.set(u,[]),i.get(u).push(c)}),Array.from(i,c=>o(c[0],c[1]))},isToastActive:$u,count:n?.length}}function Lf(t){const[r,s]=l.useState(!1),[a,n]=l.useState(!1),o=l.useRef(null),i=l.useRef({start:0,delta:0,removalDistance:0,canCloseOnClick:!0,canDrag:!1,didMove:!1}).current,{autoClose:c,pauseOnHover:u,closeToast:d,onClick:p,closeOnClick:y}=t;var w,O;function _(){s(!0)}function E(){s(!1)}function b(S){const j=o.current;i.canDrag&&j&&(i.didMove=!0,r&&E(),i.delta=t.draggableDirection==="x"?S.clientX-i.start:S.clientY-i.start,i.start!==S.clientX&&(i.canCloseOnClick=!1),j.style.transform=`translate3d(${t.draggableDirection==="x"?`${i.delta}px, var(--y)`:`0, calc(${i.delta}px + var(--y))`},0)`,j.style.opacity=""+(1-Math.abs(i.delta/i.removalDistance)))}function I(){document.removeEventListener("pointermove",b),document.removeEventListener("pointerup",I);const S=o.current;if(i.canDrag&&i.didMove&&S){if(i.canDrag=!1,Math.abs(i.delta)>i.removalDistance)return n(!0),t.closeToast(),void t.collapseAll();S.style.transition="transform 0.2s, opacity 0.2s",S.style.removeProperty("transform"),S.style.removeProperty("opacity")}}(O=sr.get((w={id:t.toastId,containerId:t.containerId,fn:s}).containerId||1))==null||O.setToggle(w.id,w.fn),l.useEffect(()=>{if(t.pauseOnFocusLoss)return document.hasFocus()||E(),window.addEventListener("focus",_),window.addEventListener("blur",E),()=>{window.removeEventListener("focus",_),window.removeEventListener("blur",E)}},[t.pauseOnFocusLoss]);const U={onPointerDown:function(S){if(t.draggable===!0||t.draggable===S.pointerType){i.didMove=!1,document.addEventListener("pointermove",b),document.addEventListener("pointerup",I);const j=o.current;i.canCloseOnClick=!0,i.canDrag=!0,j.style.transition="none",t.draggableDirection==="x"?(i.start=S.clientX,i.removalDistance=j.offsetWidth*(t.draggablePercent/100)):(i.start=S.clientY,i.removalDistance=j.offsetHeight*(t.draggablePercent===80?1.5*t.draggablePercent:t.draggablePercent)/100)}},onPointerUp:function(S){const{top:j,bottom:N,left:k,right:M}=o.current.getBoundingClientRect();S.nativeEvent.type!=="touchend"&&t.pauseOnHover&&S.clientX>=k&&S.clientX<=M&&S.clientY>=j&&S.clientY<=N?E():_()}};return c&&u&&(U.onMouseEnter=E,t.stacked||(U.onMouseLeave=_)),y&&(U.onClick=S=>{p&&p(S),i.canCloseOnClick&&d()}),{playToast:_,pauseToast:E,isRunning:r,preventExitTransition:a,toastRef:o,eventHandlers:U}}function qf(t){let{delay:r,isRunning:s,closeToast:a,type:n="default",hide:o,className:i,style:c,controlledProgress:u,progress:d,rtl:p,isIn:y,theme:w}=t;const O=o||u&&d===0,_={...c,animationDuration:`${r}ms`,animationPlayState:s?"running":"paused"};u&&(_.transform=`scaleX(${d})`);const E=tn("Toastify__progress-bar",u?"Toastify__progress-bar--controlled":"Toastify__progress-bar--animated",`Toastify__progress-bar-theme--${w}`,`Toastify__progress-bar--${n}`,{"Toastify__progress-bar--rtl":p}),b=mr(i)?i({rtl:p,type:n,defaultClassName:E}):tn(E,i),I={[u&&d>=1?"onTransitionEnd":"onAnimationEnd"]:u&&d<1?null:()=>{y&&a()}};return ft.createElement("div",{className:"Toastify__progress-bar--wrp","data-hidden":O},ft.createElement("div",{className:`Toastify__progress-bar--bg Toastify__progress-bar-theme--${w} Toastify__progress-bar--${n}`}),ft.createElement("div",{role:"progressbar","aria-hidden":O?"true":"false","aria-label":"notification timer",className:b,style:_,...I}))}let Uf=1;const zu=()=>""+Uf++;function Wf(t){return t&&(jn(t.toastId)||Zs(t.toastId))?t.toastId:zu()}function Vs(t,r){return Bu(t,r),r.toastId}function Ja(t,r){return{...r,type:r&&r.type||t,toastId:Wf(r)}}function va(t){return(r,s)=>Vs(r,Ja(t,s))}function H(t,r){return Vs(t,Ja("default",r))}H.loading=(t,r)=>Vs(t,Ja("default",{isLoading:!0,autoClose:!1,closeOnClick:!1,closeButton:!1,draggable:!1,...r})),H.promise=function(t,r,s){let a,{pending:n,error:o,success:i}=r;n&&(a=jn(n)?H.loading(n,s):H.loading(n.render,{...s,...n}));const c={isLoading:null,autoClose:null,closeOnClick:null,closeButton:null,draggable:null},u=(p,y,w)=>{if(y==null)return void H.dismiss(a);const O={type:p,...c,...s,data:w},_=jn(y)?{render:y}:y;return a?H.update(a,{...O,..._}):H(_.render,{...O,..._}),w},d=mr(t)?t():t;return d.then(p=>u("success",i,p)).catch(p=>u("error",o,p)),d},H.success=va("success"),H.info=va("info"),H.error=va("error"),H.warning=va("warning"),H.warn=H.warning,H.dark=(t,r)=>Vs(t,Ja("default",{theme:"dark",...r})),H.dismiss=function(t){(function(r){var s;if(Fu()){if(r==null||jn(s=r)||Zs(s))sr.forEach(a=>{a.removeToast(r)});else if(r&&("containerId"in r||"id"in r)){const a=sr.get(r.containerId);a?a.removeToast(r.id):sr.forEach(n=>{n.removeToast(r.id)})}}else ea=ea.filter(a=>r!=null&&a.options.toastId!==r)})(t)},H.clearWaitingQueue=function(t){t===void 0&&(t={}),sr.forEach(r=>{!r.props.limit||t.containerId&&r.id!==t.containerId||r.clearQueue()})},H.isActive=$u,H.update=function(t,r){r===void 0&&(r={});const s=((a,n)=>{var o;let{containerId:i}=n;return(o=sr.get(i||1))==null?void 0:o.toasts.get(a)})(t,r);if(s){const{props:a,content:n}=s,o={delay:100,...a,...r,toastId:r.toastId||t,updateId:zu()};o.toastId!==t&&(o.staleId=t);const i=o.render||n;delete o.render,Vs(i,o)}},H.done=t=>{H.update(t,{progress:1})},H.onChange=function(t){return _i.add(t),()=>{_i.delete(t)}},H.play=t=>Yl(!0,t),H.pause=t=>Yl(!1,t);const Ff=typeof window<"u"?l.useLayoutEffect:l.useEffect,_a=t=>{let{theme:r,type:s,isLoading:a,...n}=t;return ft.createElement("svg",{viewBox:"0 0 24 24",width:"100%",height:"100%",fill:r==="colored"?"currentColor":`var(--toastify-icon-color-${s})`,...n})},Go={info:function(t){return ft.createElement(_a,{...t},ft.createElement("path",{d:"M12 0a12 12 0 1012 12A12.013 12.013 0 0012 0zm.25 5a1.5 1.5 0 11-1.5 1.5 1.5 1.5 0 011.5-1.5zm2.25 13.5h-4a1 1 0 010-2h.75a.25.25 0 00.25-.25v-4.5a.25.25 0 00-.25-.25h-.75a1 1 0 010-2h1a2 2 0 012 2v4.75a.25.25 0 00.25.25h.75a1 1 0 110 2z"}))},warning:function(t){return ft.createElement(_a,{...t},ft.createElement("path",{d:"M23.32 17.191L15.438 2.184C14.728.833 13.416 0 11.996 0c-1.42 0-2.733.833-3.443 2.184L.533 17.448a4.744 4.744 0 000 4.368C1.243 23.167 2.555 24 3.975 24h16.05C22.22 24 24 22.044 24 19.632c0-.904-.251-1.746-.68-2.44zm-9.622 1.46c0 1.033-.724 1.823-1.698 1.823s-1.698-.79-1.698-1.822v-.043c0-1.028.724-1.822 1.698-1.822s1.698.79 1.698 1.822v.043zm.039-12.285l-.84 8.06c-.057.581-.408.943-.897.943-.49 0-.84-.367-.896-.942l-.84-8.065c-.057-.624.25-1.095.779-1.095h1.91c.528.005.84.476.784 1.1z"}))},success:function(t){return ft.createElement(_a,{...t},ft.createElement("path",{d:"M12 0a12 12 0 1012 12A12.014 12.014 0 0012 0zm6.927 8.2l-6.845 9.289a1.011 1.011 0 01-1.43.188l-4.888-3.908a1 1 0 111.25-1.562l4.076 3.261 6.227-8.451a1 1 0 111.61 1.183z"}))},error:function(t){return ft.createElement(_a,{...t},ft.createElement("path",{d:"M11.983 0a12.206 12.206 0 00-8.51 3.653A11.8 11.8 0 000 12.207 11.779 11.779 0 0011.8 24h.214A12.111 12.111 0 0024 11.791 11.766 11.766 0 0011.983 0zM10.5 16.542a1.476 1.476 0 011.449-1.53h.027a1.527 1.527 0 011.523 1.47 1.475 1.475 0 01-1.449 1.53h-.027a1.529 1.529 0 01-1.523-1.47zM11 12.5v-6a1 1 0 012 0v6a1 1 0 11-2 0z"}))},spinner:function(){return ft.createElement("div",{className:"Toastify__spinner"})}},$f=t=>{const{isRunning:r,preventExitTransition:s,toastRef:a,eventHandlers:n,playToast:o}=Lf(t),{closeButton:i,children:c,autoClose:u,onClick:d,type:p,hideProgressBar:y,closeToast:w,transition:O,position:_,className:E,style:b,bodyClassName:I,bodyStyle:U,progressClassName:S,progressStyle:j,updateId:N,role:k,progress:M,rtl:v,toastId:g,deleteToast:L,isIn:z,isLoading:ne,closeOnClick:ae,theme:ee}=t,W=tn("Toastify__toast",`Toastify__toast-theme--${ee}`,`Toastify__toast--${p}`,{"Toastify__toast--rtl":v},{"Toastify__toast--close-on-click":ae}),Z=mr(E)?E({rtl:v,position:_,type:p,defaultClassName:W}):tn(W,E),J=function(G){let{theme:X,type:Y,isLoading:fe,icon:se}=G,ke=null;const Pe={theme:X,type:Y};return se===!1||(mr(se)?ke=se({...Pe,isLoading:fe}):l.isValidElement(se)?ke=l.cloneElement(se,Pe):fe?ke=Go.spinner():(ge=>ge in Go)(Y)&&(ke=Go[Y](Pe))),ke}(t),P=!!M||!u,m={closeToast:w,type:p,theme:ee};let A=null;return i===!1||(A=mr(i)?i(m):l.isValidElement(i)?l.cloneElement(i,m):function(G){let{closeToast:X,theme:Y,ariaLabel:fe="close"}=G;return ft.createElement("button",{className:`Toastify__close-button Toastify__close-button--${Y}`,type:"button",onClick:se=>{se.stopPropagation(),X(se)},"aria-label":fe},ft.createElement("svg",{"aria-hidden":"true",viewBox:"0 0 14 16"},ft.createElement("path",{fillRule:"evenodd",d:"M7.71 8.23l3.75 3.75-1.48 1.48-3.75-3.75-3.75 3.75L1 11.98l3.75-3.75L1 4.48 2.48 3l3.75 3.75L9.98 3l1.48 1.48-3.75 3.75z"})))}(m)),ft.createElement(O,{isIn:z,done:L,position:_,preventExitTransition:s,nodeRef:a,playToast:o},ft.createElement("div",{id:g,onClick:d,"data-in":z,className:Z,...n,style:b,ref:a},ft.createElement("div",{...z&&{role:k},className:mr(I)?I({type:p}):tn("Toastify__toast-body",I),style:U},J!=null&&ft.createElement("div",{className:tn("Toastify__toast-icon",{"Toastify--animate-icon Toastify__zoom-enter":!ne})},J),ft.createElement("div",null,c)),A,ft.createElement(qf,{...N&&!P?{key:`pb-${N}`}:{},rtl:v,theme:ee,delay:u,isRunning:r,isIn:z,closeToast:w,hide:y,type:p,style:j,className:S,controlledProgress:P,progress:M||0})))},xo=function(t,r){return r===void 0&&(r=!1),{enter:`Toastify--animate Toastify__${t}-enter`,exit:`Toastify--animate Toastify__${t}-exit`,appendPosition:r}},Bf=go(xo("bounce",!0));go(xo("slide",!0));go(xo("zoom"));go(xo("flip"));const zf={position:"top-right",transition:Bf,autoClose:5e3,closeButton:!0,pauseOnHover:!0,pauseOnFocusLoss:!0,draggable:"touch",draggablePercent:80,draggableDirection:"x",role:"alert",theme:"light"};function Hf(t){let r={...zf,...t};const s=t.stacked,[a,n]=l.useState(!0),o=l.useRef(null),{getToastToRender:i,isToastActive:c,count:u}=Nf(r),{className:d,style:p,rtl:y,containerId:w}=r;function O(E){const b=tn("Toastify__toast-container",`Toastify__toast-container--${E}`,{"Toastify__toast-container--rtl":y});return mr(d)?d({position:E,rtl:y,defaultClassName:b}):tn(b,Na(d))}function _(){s&&(n(!0),H.play())}return Ff(()=>{if(s){var E;const b=o.current.querySelectorAll('[data-in="true"]'),I=12,U=(E=r.position)==null?void 0:E.includes("top");let S=0,j=0;Array.from(b).reverse().forEach((N,k)=>{const M=N;M.classList.add("Toastify__toast--stacked"),k>0&&(M.dataset.collapsed=`${a}`),M.dataset.pos||(M.dataset.pos=U?"top":"bot");const v=S*(a?.2:1)+(a?0:I*k);M.style.setProperty("--y",`${U?v:-1*v}px`),M.style.setProperty("--g",`${I}`),M.style.setProperty("--s",""+(1-(a?j:0))),S+=M.offsetHeight,j+=.025})}},[a,u,s]),ft.createElement("div",{ref:o,className:"Toastify",id:w,onMouseEnter:()=>{s&&(n(!1),H.pause())},onMouseLeave:_},i((E,b)=>{const I=b.length?{...p}:{...p,pointerEvents:"none"};return ft.createElement("div",{className:O(E),style:I,key:`container-${E}`},b.map(U=>{let{content:S,props:j}=U;return ft.createElement($f,{...j,stacked:s,collapseAll:_,isIn:c(j.toastId,j.containerId),style:j.style,key:`toast-${j.key}`},S)}))}))}const nn="/assets/default-logo-BbiCiEKs.png",lr=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t),Vl=t=>{if(console.log("getLogoUrl called with:",t),!t)return console.log("No logo URL provided, using default"),nn;if(t.startsWith("http://")||t.startsWith("https://"))return console.log("Logo URL is already a full URL:",t),t;if(t.includes("\\")||t.includes(":/")||t.includes(":\\")){const a=t.split(/[\\\/]/).pop()||t;if(console.log("Extracted filename from Windows path:",a),!a||a===t)return console.warn("Could not extract valid filename from Windows path, using default"),nn;const{baseURL:n}=Gn(),o=`${n.replace(/\/$/,"")}/uploads/${a}`;return console.log("Built final URL from Windows path:",o),o}if(t.startsWith("/")){const a=t.split("/").pop()||t;if(console.log("Extracted filename from Unix path:",a),!a||a===t)return console.warn("Could not extract valid filename from Unix path, using default"),nn;const{baseURL:n}=Gn(),o=`${n.replace(/\/$/,"")}/uploads/${a}`;return console.log("Built final URL from Unix path:",o),o}if(t.includes("\\")||t.includes(":/")||t.includes(":\\"))return console.warn("Invalid filename format, using default"),nn;const{baseURL:r}=Gn(),s=`${r.replace(/\/$/,"")}/uploads/${t}`;return console.log("Built final URL from filename:",s),s};Gn().baseURL;const Yf=()=>{qt();const[t,r]=l.useState({id:"",business_name:"",street_address:"",city:"",province:"",country:"",postal_code:"",telephone_number:"",email:"",business_number:"",website:"",logo_url:"",created_at:"",updated_at:""}),[s,a]=l.useState(!1),[n,o]=l.useState(null),[i,c]=l.useState(null),[u,d]=l.useState(!1),p=S=>({id:S.id||"",business_name:S.business_name||"",street_address:S.street_address||"",city:S.city||"",province:S.province||"",country:S.country||"",postal_code:S.postal_code||"",telephone_number:S.telephone_number||"",email:S.email||"",business_number:S.business_number||"",website:S.website||"",logo_url:S.logo_url||"",created_at:S.created_at||"",updated_at:S.updated_at||""});l.useEffect(()=>{y()},[]);const y=async()=>{try{const S=await $.get("/api/business-profile");console.log("Business Profile API Response:",S.data),console.log("Logo URL from API:",S.data.logo_url),r(p(S.data))}catch(S){if(S.response?.status===404){d(!0);return}console.error("Error fetching business profile:",S),H.error("Failed to load business profile")}},w=S=>{const{name:j,value:N}=S.target;r(k=>({...k,[j]:N}))},O=S=>{if(S.target.files&&S.target.files[0]){const j=S.target.files[0];o(j);const N=URL.createObjectURL(j);c(N)}},_=async()=>{if(t.logo_url)try{a(!0),await $.delete("/api/business-profile/logo"),r(S=>({...S,logo_url:""})),H.success("Logo deleted successfully")}catch(S){console.error("Error deleting logo:",S),H.error("Failed to delete logo")}finally{a(!1)}},E=async S=>{S.preventDefault(),a(!0);try{const j=new FormData;Object.entries(t).forEach(([N,k])=>{let M=N;switch(N){case"business_name":M="business_name";break;case"street_address":M="street_address";break;case"telephone_number":M="telephone_number";break;case"business_number":M="business_number";break;case"email":M="email";break;case"website":M="website";break;case"city":M="city";break;case"province":M="province";break;case"country":M="country";break;case"postal_code":M="postal_code";break;case"logo_url":return;case"id":case"created_at":case"updated_at":return}k!=null&&j.append(M,k)}),n&&j.append("logo",n),console.log("Form data being sent:");for(let[N,k]of j.entries())console.log(`${N}:`,k);await $.post("/api/business-profile",j,{headers:{"Content-Type":"multipart/form-data"}}),H.success("Business profile updated successfully"),d(!1),o(null),c(null),y()}catch(j){console.error("Error updating business profile:",j),console.error("Error response:",j.response),console.error("Error message:",j.message),j.response?.status===401?H.error("Authentication failed. Please log in again."):j.response?.status===403?H.error("Access denied. You do not have permission to update the business profile."):j.response?.status===404?H.error("Business profile endpoint not found. Please check your API configuration."):j.response?.status===500?H.error("Server error. Please try again later."):j.code==="NETWORK_ERROR"?H.error("Network error. Please check your connection and try again."):j.message?.includes("timeout")?H.error("Request timed out. Please try again."):H.error(`Failed to update business profile: ${j.response?.data?.error||j.message||"Unknown error"}`)}finally{a(!1)}},b=()=>{d(!1),o(null),c(null),t.id?y():r({id:"",business_name:"",street_address:"",city:"",province:"",country:"",postal_code:"",telephone_number:"",email:"",business_number:"",logo_url:"",created_at:"",updated_at:""})};if(s)return e.jsx(q,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(it,{})});const I=()=>{const S=!!t.id;return e.jsx(q,{display:"flex",justifyContent:"center",alignItems:"flex-start",minHeight:"70vh",children:e.jsx(qe,{sx:{p:{xs:2,md:4},width:"100%",maxWidth:650,borderRadius:4,boxShadow:6,bgcolor:"background.paper"},elevation:6,children:e.jsxs(tt,{spacing:4,children:[e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsx(f,{variant:"h5",fontWeight:700,color:"primary.main",children:S?"Current Business Profile":"Business Profile"}),e.jsx(q,{children:e.jsx(K,{variant:"contained",startIcon:e.jsx(Qa,{}),onClick:()=>d(!0),sx:{borderRadius:2,fontWeight:600},children:S?"Edit Profile":"Create Profile"})})]}),e.jsx(Sn,{sx:{bgcolor:"primary.light",height:3,borderRadius:2}}),S?e.jsxs(e.Fragment,{children:[t.logo_url&&e.jsxs(q,{display:"flex",flexDirection:"column",alignItems:"center",mb:2,children:[e.jsx(f,{variant:"subtitle1",fontWeight:600,color:"primary.dark",gutterBottom:!0,children:"Business Logo"}),e.jsx(mt,{sx:{maxWidth:180,borderRadius:3,boxShadow:3,border:"2px solid",borderColor:"primary.light",p:1,mb:1,bgcolor:"grey.50"},children:e.jsx(nl,{component:"img",image:t.logo_url?Vl(t.logo_url):nn,onError:j=>j.currentTarget.src=nn,alt:"Business Logo",sx:{height:120,objectFit:"contain",borderRadius:2,bgcolor:"white"}})})]}),e.jsxs(T,{container:!0,spacing:3,children:[e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx(f,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Business Name"}),e.jsx(f,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.business_name})]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx(f,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Business Number"}),e.jsx(f,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.business_number})]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx(f,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Address"}),e.jsxs(f,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:[t.street_address,e.jsx("br",{}),t.city,", ",t.province,t.postal_code?`, ${t.postal_code}`:"",e.jsx("br",{}),t.country]})]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx(f,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Email"}),e.jsx(f,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.email})]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx(f,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Telephone"}),e.jsx(f,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.telephone_number})]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx(f,{variant:"subtitle2",color:"primary",fontWeight:600,gutterBottom:!0,sx:{fontSize:"1rem"},children:"Website"}),e.jsx(f,{variant:"body1",fontWeight:500,mb:2,sx:{fontSize:"1.1rem"},children:t.website?e.jsx("a",{href:t.website.startsWith("http")?t.website:`https://${t.website}`,target:"_blank",rel:"noopener noreferrer",style:{color:"inherit",textDecoration:"underline"},children:t.website}):"Not provided"})]})]})]}):e.jsxs(q,{textAlign:"center",py:4,children:[e.jsx(f,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"No Business Profile Found"}),e.jsx(f,{variant:"body1",color:"text.secondary",sx:{mb:3},children:"Create your business profile to get started. This information will be used in your quotes, invoices, and other business documents."}),e.jsx(K,{variant:"contained",size:"large",startIcon:e.jsx(Qa,{}),onClick:()=>d(!0),sx:{borderRadius:2,fontWeight:600},children:"Create Business Profile"})]})]})})})},U=()=>e.jsx(q,{display:"flex",justifyContent:"center",alignItems:"flex-start",minHeight:"70vh",children:e.jsx(qe,{sx:{p:{xs:2,md:4},width:"100%",maxWidth:650,borderRadius:4,boxShadow:6,bgcolor:"background.paper"},elevation:6,component:"form",onSubmit:E,children:e.jsxs(tt,{spacing:4,children:[e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsx(f,{variant:"h5",fontWeight:700,color:"primary.main",children:t.id?"Edit Business Profile":"Create Business Profile"}),e.jsxs(q,{children:[e.jsx(K,{variant:"outlined",onClick:b,sx:{borderRadius:2,fontWeight:600,mr:2},children:"Cancel"}),e.jsx(K,{variant:"contained",type:"submit",disabled:s,sx:{borderRadius:2,fontWeight:600},children:s?e.jsx(it,{size:24}):t.id?"Save Changes":"Create Profile"})]})]}),e.jsx(Sn,{sx:{bgcolor:"primary.light",height:3,borderRadius:2}}),e.jsxs(T,{container:!0,spacing:3,children:[e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"Business Name",name:"business_name",value:t.business_name,onChange:w,fullWidth:!0,required:!0})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"Business Number/GST-HST Registration Number",name:"business_number",value:t.business_number,onChange:w,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"Street Address",name:"street_address",value:t.street_address,onChange:w,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"City",name:"city",value:t.city,onChange:w,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"Province",name:"province",value:t.province,onChange:w,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"Country",name:"country",value:t.country,onChange:w,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"Postal Code",name:"postal_code",value:t.postal_code,onChange:w,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"Telephone Number",name:"telephone_number",value:t.telephone_number,onChange:w,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"Email",name:"email",value:t.email,onChange:w,fullWidth:!0,type:"email"})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"Website",name:"website",value:t.website,onChange:w,fullWidth:!0})}),e.jsxs(T,{item:!0,xs:12,children:[e.jsx(f,{variant:"subtitle2",fontWeight:600,gutterBottom:!0,children:"Business Logo"}),t.logo_url&&e.jsxs(q,{display:"flex",flexDirection:"column",alignItems:"center",mb:2,children:[e.jsx(mt,{sx:{maxWidth:180,borderRadius:3,boxShadow:3,border:"2px solid",borderColor:"primary.light",p:1,mb:1,bgcolor:"grey.50"},children:e.jsx(nl,{component:"img",image:t.logo_url?Vl(t.logo_url):nn,onError:S=>S.currentTarget.src=nn,alt:"Business Logo",sx:{height:120,objectFit:"contain",borderRadius:2,bgcolor:"white"}})}),e.jsx(K,{variant:"outlined",color:"error",startIcon:e.jsx(tr,{}),onClick:_,sx:{borderRadius:2,fontWeight:600},children:"Delete Current Logo"})]}),e.jsxs(K,{variant:"contained",component:"label",startIcon:e.jsx(Ga,{}),sx:{borderRadius:2,fontWeight:600},children:[t.logo_url?"Change Logo":"Upload Logo",e.jsx("input",{type:"file",hidden:!0,onChange:O,accept:"image/*"})]}),i&&e.jsxs(q,{mt:2,display:"flex",flexDirection:"column",alignItems:"center",children:[e.jsx(f,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"New Logo Preview:"}),e.jsx("img",{src:i,alt:"Logo Preview",style:{maxWidth:"100px",maxHeight:"100px"}})]})]})]})]})})});return e.jsx(Qe,{sx:{mt:4,mb:4},children:u?U():I()})};var xs={},Gl;function Vf(){if(Gl)return xs;Gl=1;var t=At();Object.defineProperty(xs,"__esModule",{value:!0}),xs.default=void 0;var r=t(Rt()),s=Mt();return xs.default=(0,r.default)((0,s.jsx)("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"}),"Search"),xs}var Gf=Vf();const yr=vt(Gf);var ys={},Ql;function Qf(){if(Ql)return ys;Ql=1;var t=At();Object.defineProperty(ys,"__esModule",{value:!0}),ys.default=void 0;var r=t(Rt()),s=Mt();return ys.default=(0,r.default)((0,s.jsx)("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add"),ys}var Jf=Qf();const vr=vt(Jf);var vs={},Jl;function Kf(){if(Jl)return vs;Jl=1;var t=At();Object.defineProperty(vs,"__esModule",{value:!0}),vs.default=void 0;var r=t(Rt()),s=Mt();return vs.default=(0,r.default)((0,s.jsx)("path",{d:"M5 20h14v-2H5zM19 9h-4V3H9v6H5l7 7z"}),"Download"),vs}var Xf=Kf();const or=vt(Xf),Kl=async t=>(await $.get(`/api/customers/${t}/contacts`)).data,Zf=async(t,r)=>(await $.post(`/api/customers/${t}/contacts/people`,r)).data,eg=async(t,r,s)=>(await $.put(`/api/customers/${t}/contacts/people/${r}`,s)).data,tg=async(t,r)=>(await $.delete(`/api/customers/${t}/contacts/people/${r}`)).data,rg=async(t,r)=>(await $.post(`/api/customers/${t}/contacts/emails`,r)).data,ng=async(t,r,s)=>(await $.put(`/api/customers/${t}/contacts/emails/${r}`,s)).data,sg=async(t,r)=>(await $.delete(`/api/customers/${t}/contacts/emails/${r}`)).data,ag=async(t,r)=>(await $.post(`/api/customers/${t}/contacts/phones`,r)).data,og=async(t,r,s)=>(await $.put(`/api/customers/${t}/contacts/phones/${r}`,s)).data,ig=async(t,r)=>(await $.delete(`/api/customers/${t}/contacts/phones/${r}`)).data,lg=async()=>(await $.get("/api/customers")).data,cg=async t=>(await $.get(`/api/customers/${t}`)).data,Hu=async t=>(await $.post("/api/customers",t)).data,Yu=async(t,r)=>(await $.put(`/api/customers/${t}`,r)).data,ug=async t=>{await $.delete(`/api/customers/${t}`)};var La={exports:{}};/* @license
Papa Parse
v5.5.3
https://github.com/mholt/PapaParse
License: MIT
*/var dg=La.exports,Xl;function pg(){return Xl||(Xl=1,function(t,r){((s,a)=>{t.exports=a()})(dg,function s(){var a=typeof self<"u"?self:typeof window<"u"?window:a!==void 0?a:{},n,o=!a.document&&!!a.postMessage,i=a.IS_PAPA_WORKER||!1,c={},u=0,d={};function p(v){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},(function(g){var L=N(g);L.chunkSize=parseInt(L.chunkSize),g.step||g.chunk||(L.chunkSize=null),this._handle=new E(L),(this._handle.streamer=this)._config=L}).call(this,v),this.parseChunk=function(g,L){var z=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&0<z){let ae=this._config.newline;ae||(ne=this._config.quoteChar||'"',ae=this._handle.guessLineEndings(g,ne)),g=[...g.split(ae).slice(z)].join(ae)}this.isFirstChunk&&M(this._config.beforeFirstChunk)&&(ne=this._config.beforeFirstChunk(g))!==void 0&&(g=ne),this.isFirstChunk=!1,this._halted=!1;var z=this._partialLine+g,ne=(this._partialLine="",this._handle.parse(z,this._baseIndex,!this._finished));if(!this._handle.paused()&&!this._handle.aborted()){if(g=ne.meta.cursor,z=(this._finished||(this._partialLine=z.substring(g-this._baseIndex),this._baseIndex=g),ne&&ne.data&&(this._rowCount+=ne.data.length),this._finished||this._config.preview&&this._rowCount>=this._config.preview),i)a.postMessage({results:ne,workerId:d.WORKER_ID,finished:z});else if(M(this._config.chunk)&&!L){if(this._config.chunk(ne,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);this._completeResults=ne=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(ne.data),this._completeResults.errors=this._completeResults.errors.concat(ne.errors),this._completeResults.meta=ne.meta),this._completed||!z||!M(this._config.complete)||ne&&ne.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),z||ne&&ne.meta.paused||this._nextChunk(),ne}this._halted=!0},this._sendError=function(g){M(this._config.error)?this._config.error(g):i&&this._config.error&&a.postMessage({workerId:d.WORKER_ID,error:g,finished:!1})}}function y(v){var g;(v=v||{}).chunkSize||(v.chunkSize=d.RemoteChunkSize),p.call(this,v),this._nextChunk=o?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(L){this._input=L,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(g=new XMLHttpRequest,this._config.withCredentials&&(g.withCredentials=this._config.withCredentials),o||(g.onload=k(this._chunkLoaded,this),g.onerror=k(this._chunkError,this)),g.open(this._config.downloadRequestBody?"POST":"GET",this._input,!o),this._config.downloadRequestHeaders){var L,z=this._config.downloadRequestHeaders;for(L in z)g.setRequestHeader(L,z[L])}var ne;this._config.chunkSize&&(ne=this._start+this._config.chunkSize-1,g.setRequestHeader("Range","bytes="+this._start+"-"+ne));try{g.send(this._config.downloadRequestBody)}catch(ae){this._chunkError(ae.message)}o&&g.status===0&&this._chunkError()}},this._chunkLoaded=function(){g.readyState===4&&(g.status<200||400<=g.status?this._chunkError():(this._start+=this._config.chunkSize||g.responseText.length,this._finished=!this._config.chunkSize||this._start>=(L=>(L=L.getResponseHeader("Content-Range"))!==null?parseInt(L.substring(L.lastIndexOf("/")+1)):-1)(g),this.parseChunk(g.responseText)))},this._chunkError=function(L){L=g.statusText||L,this._sendError(new Error(L))}}function w(v){(v=v||{}).chunkSize||(v.chunkSize=d.LocalChunkSize),p.call(this,v);var g,L,z=typeof FileReader<"u";this.stream=function(ne){this._input=ne,L=ne.slice||ne.webkitSlice||ne.mozSlice,z?((g=new FileReader).onload=k(this._chunkLoaded,this),g.onerror=k(this._chunkError,this)):g=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var ne=this._input,ae=(this._config.chunkSize&&(ae=Math.min(this._start+this._config.chunkSize,this._input.size),ne=L.call(ne,this._start,ae)),g.readAsText(ne,this._config.encoding));z||this._chunkLoaded({target:{result:ae}})},this._chunkLoaded=function(ne){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(ne.target.result)},this._chunkError=function(){this._sendError(g.error)}}function O(v){var g;p.call(this,v=v||{}),this.stream=function(L){return g=L,this._nextChunk()},this._nextChunk=function(){var L,z;if(!this._finished)return L=this._config.chunkSize,g=L?(z=g.substring(0,L),g.substring(L)):(z=g,""),this._finished=!g,this.parseChunk(z)}}function _(v){p.call(this,v=v||{});var g=[],L=!0,z=!1;this.pause=function(){p.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){p.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(ne){this._input=ne,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){z&&g.length===1&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),g.length?this.parseChunk(g.shift()):L=!0},this._streamData=k(function(ne){try{g.push(typeof ne=="string"?ne:ne.toString(this._config.encoding)),L&&(L=!1,this._checkIsFinished(),this.parseChunk(g.shift()))}catch(ae){this._streamError(ae)}},this),this._streamError=k(function(ne){this._streamCleanUp(),this._sendError(ne)},this),this._streamEnd=k(function(){this._streamCleanUp(),z=!0,this._streamData("")},this),this._streamCleanUp=k(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function E(v){var g,L,z,ne,ae=Math.pow(2,53),ee=-ae,W=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,Z=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,J=this,P=0,m=0,A=!1,G=!1,X=[],Y={data:[],errors:[],meta:{}};function fe(ge){return v.skipEmptyLines==="greedy"?ge.join("").trim()==="":ge.length===1&&ge[0].length===0}function se(){if(Y&&z&&(Pe("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+d.DefaultDelimiter+"'"),z=!1),v.skipEmptyLines&&(Y.data=Y.data.filter(function(je){return!fe(je)})),ke()){let je=function(oe,D){M(v.transformHeader)&&(oe=v.transformHeader(oe,D)),X.push(oe)};if(Y)if(Array.isArray(Y.data[0])){for(var ge=0;ke()&&ge<Y.data.length;ge++)Y.data[ge].forEach(je);Y.data.splice(0,1)}else Y.data.forEach(je)}function me(je,oe){for(var D=v.header?{}:[],F=0;F<je.length;F++){var te=F,B=je[F],B=((Ee,Se)=>($e=>(v.dynamicTypingFunction&&v.dynamicTyping[$e]===void 0&&(v.dynamicTyping[$e]=v.dynamicTypingFunction($e)),(v.dynamicTyping[$e]||v.dynamicTyping)===!0))(Ee)?Se==="true"||Se==="TRUE"||Se!=="false"&&Se!=="FALSE"&&(($e=>{if(W.test($e)&&($e=parseFloat($e),ee<$e&&$e<ae))return 1})(Se)?parseFloat(Se):Z.test(Se)?new Date(Se):Se===""?null:Se):Se)(te=v.header?F>=X.length?"__parsed_extra":X[F]:te,B=v.transform?v.transform(B,te):B);te==="__parsed_extra"?(D[te]=D[te]||[],D[te].push(B)):D[te]=B}return v.header&&(F>X.length?Pe("FieldMismatch","TooManyFields","Too many fields: expected "+X.length+" fields but parsed "+F,m+oe):F<X.length&&Pe("FieldMismatch","TooFewFields","Too few fields: expected "+X.length+" fields but parsed "+F,m+oe)),D}var be;Y&&(v.header||v.dynamicTyping||v.transform)&&(be=1,!Y.data.length||Array.isArray(Y.data[0])?(Y.data=Y.data.map(me),be=Y.data.length):Y.data=me(Y.data,0),v.header&&Y.meta&&(Y.meta.fields=X),m+=be)}function ke(){return v.header&&X.length===0}function Pe(ge,me,be,je){ge={type:ge,code:me,message:be},je!==void 0&&(ge.row=je),Y.errors.push(ge)}M(v.step)&&(ne=v.step,v.step=function(ge){Y=ge,ke()?se():(se(),Y.data.length!==0&&(P+=ge.data.length,v.preview&&P>v.preview?L.abort():(Y.data=Y.data[0],ne(Y,J))))}),this.parse=function(ge,me,be){var je=v.quoteChar||'"',je=(v.newline||(v.newline=this.guessLineEndings(ge,je)),z=!1,v.delimiter?M(v.delimiter)&&(v.delimiter=v.delimiter(ge),Y.meta.delimiter=v.delimiter):((je=((oe,D,F,te,B)=>{var Ee,Se,$e,He;B=B||[",","	","|",";",d.RECORD_SEP,d.UNIT_SEP];for(var De=0;De<B.length;De++){for(var et,Ve=B[De],Be=0,Ke=0,We=0,pt=($e=void 0,new I({comments:te,delimiter:Ve,newline:D,preview:10}).parse(oe)),kt=0;kt<pt.data.length;kt++)F&&fe(pt.data[kt])?We++:(et=pt.data[kt].length,Ke+=et,$e===void 0?$e=et:0<et&&(Be+=Math.abs(et-$e),$e=et));0<pt.data.length&&(Ke/=pt.data.length-We),(Se===void 0||Be<=Se)&&(He===void 0||He<Ke)&&1.99<Ke&&(Se=Be,Ee=Ve,He=Ke)}return{successful:!!(v.delimiter=Ee),bestDelimiter:Ee}})(ge,v.newline,v.skipEmptyLines,v.comments,v.delimitersToGuess)).successful?v.delimiter=je.bestDelimiter:(z=!0,v.delimiter=d.DefaultDelimiter),Y.meta.delimiter=v.delimiter),N(v));return v.preview&&v.header&&je.preview++,g=ge,L=new I(je),Y=L.parse(g,me,be),se(),A?{meta:{paused:!0}}:Y||{meta:{paused:!1}}},this.paused=function(){return A},this.pause=function(){A=!0,L.abort(),g=M(v.chunk)?"":g.substring(L.getCharIndex())},this.resume=function(){J.streamer._halted?(A=!1,J.streamer.parseChunk(g,!0)):setTimeout(J.resume,3)},this.aborted=function(){return G},this.abort=function(){G=!0,L.abort(),Y.meta.aborted=!0,M(v.complete)&&v.complete(Y),g=""},this.guessLineEndings=function(oe,je){oe=oe.substring(0,1048576);var je=new RegExp(b(je)+"([^]*?)"+b(je),"gm"),be=(oe=oe.replace(je,"")).split("\r"),je=oe.split(`
`),oe=1<je.length&&je[0].length<be[0].length;if(be.length===1||oe)return`
`;for(var D=0,F=0;F<be.length;F++)be[F][0]===`
`&&D++;return D>=be.length/2?`\r
`:"\r"}}function b(v){return v.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function I(v){var g=(v=v||{}).delimiter,L=v.newline,z=v.comments,ne=v.step,ae=v.preview,ee=v.fastMode,W=null,Z=!1,J=v.quoteChar==null?'"':v.quoteChar,P=J;if(v.escapeChar!==void 0&&(P=v.escapeChar),(typeof g!="string"||-1<d.BAD_DELIMITERS.indexOf(g))&&(g=","),z===g)throw new Error("Comment character same as delimiter");z===!0?z="#":(typeof z!="string"||-1<d.BAD_DELIMITERS.indexOf(z))&&(z=!1),L!==`
`&&L!=="\r"&&L!==`\r
`&&(L=`
`);var m=0,A=!1;this.parse=function(G,X,Y){if(typeof G!="string")throw new Error("Input must be a string");var fe=G.length,se=g.length,ke=L.length,Pe=z.length,ge=M(ne),me=[],be=[],je=[],oe=m=0;if(!G)return Be();if(ee||ee!==!1&&G.indexOf(J)===-1){for(var D=G.split(L),F=0;F<D.length;F++){if(je=D[F],m+=je.length,F!==D.length-1)m+=L.length;else if(Y)return Be();if(!z||je.substring(0,Pe)!==z){if(ge){if(me=[],He(je.split(g)),Ke(),A)return Be()}else He(je.split(g));if(ae&&ae<=F)return me=me.slice(0,ae),Be(!0)}}return Be()}for(var te=G.indexOf(g,m),B=G.indexOf(L,m),Ee=new RegExp(b(P)+b(J),"g"),Se=G.indexOf(J,m);;)if(G[m]===J)for(Se=m,m++;;){if((Se=G.indexOf(J,Se+1))===-1)return Y||be.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:me.length,index:m}),et();if(Se===fe-1)return et(G.substring(m,Se).replace(Ee,J));if(J===P&&G[Se+1]===P)Se++;else if(J===P||Se===0||G[Se-1]!==P){te!==-1&&te<Se+1&&(te=G.indexOf(g,Se+1));var $e=De((B=B!==-1&&B<Se+1?G.indexOf(L,Se+1):B)===-1?te:Math.min(te,B));if(G.substr(Se+1+$e,se)===g){je.push(G.substring(m,Se).replace(Ee,J)),G[m=Se+1+$e+se]!==J&&(Se=G.indexOf(J,m)),te=G.indexOf(g,m),B=G.indexOf(L,m);break}if($e=De(B),G.substring(Se+1+$e,Se+1+$e+ke)===L){if(je.push(G.substring(m,Se).replace(Ee,J)),Ve(Se+1+$e+ke),te=G.indexOf(g,m),Se=G.indexOf(J,m),ge&&(Ke(),A))return Be();if(ae&&me.length>=ae)return Be(!0);break}be.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:me.length,index:m}),Se++}}else if(z&&je.length===0&&G.substring(m,m+Pe)===z){if(B===-1)return Be();m=B+ke,B=G.indexOf(L,m),te=G.indexOf(g,m)}else if(te!==-1&&(te<B||B===-1))je.push(G.substring(m,te)),m=te+se,te=G.indexOf(g,m);else{if(B===-1)break;if(je.push(G.substring(m,B)),Ve(B+ke),ge&&(Ke(),A))return Be();if(ae&&me.length>=ae)return Be(!0)}return et();function He(We){me.push(We),oe=m}function De(We){var pt=0;return pt=We!==-1&&(We=G.substring(Se+1,We))&&We.trim()===""?We.length:pt}function et(We){return Y||(We===void 0&&(We=G.substring(m)),je.push(We),m=fe,He(je),ge&&Ke()),Be()}function Ve(We){m=We,He(je),je=[],B=G.indexOf(L,m)}function Be(We){if(v.header&&!X&&me.length&&!Z){var pt=me[0],kt=Object.create(null),at=new Set(pt);let Ct=!1;for(let Et=0;Et<pt.length;Et++){let jt=pt[Et];if(kt[jt=M(v.transformHeader)?v.transformHeader(jt,Et):jt]){let Pt,Wt=kt[jt];for(;Pt=jt+"_"+Wt,Wt++,at.has(Pt););at.add(Pt),pt[Et]=Pt,kt[jt]++,Ct=!0,(W=W===null?{}:W)[Pt]=jt}else kt[jt]=1,pt[Et]=jt;at.add(jt)}Ct&&console.warn("Duplicate headers found and renamed."),Z=!0}return{data:me,errors:be,meta:{delimiter:g,linebreak:L,aborted:A,truncated:!!We,cursor:oe+(X||0),renamedHeaders:W}}}function Ke(){ne(Be()),me=[],be=[]}},this.abort=function(){A=!0},this.getCharIndex=function(){return m}}function U(v){var g=v.data,L=c[g.workerId],z=!1;if(g.error)L.userError(g.error,g.file);else if(g.results&&g.results.data){var ne={abort:function(){z=!0,S(g.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:j,resume:j};if(M(L.userStep)){for(var ae=0;ae<g.results.data.length&&(L.userStep({data:g.results.data[ae],errors:g.results.errors,meta:g.results.meta},ne),!z);ae++);delete g.results}else M(L.userChunk)&&(L.userChunk(g.results,ne,g.file),delete g.results)}g.finished&&!z&&S(g.workerId,g.results)}function S(v,g){var L=c[v];M(L.userComplete)&&L.userComplete(g),L.terminate(),delete c[v]}function j(){throw new Error("Not implemented.")}function N(v){if(typeof v!="object"||v===null)return v;var g,L=Array.isArray(v)?[]:{};for(g in v)L[g]=N(v[g]);return L}function k(v,g){return function(){v.apply(g,arguments)}}function M(v){return typeof v=="function"}return d.parse=function(v,g){var L=(g=g||{}).dynamicTyping||!1;if(M(L)&&(g.dynamicTypingFunction=L,L={}),g.dynamicTyping=L,g.transform=!!M(g.transform)&&g.transform,!g.worker||!d.WORKERS_SUPPORTED)return L=null,d.NODE_STREAM_INPUT,typeof v=="string"?(v=(z=>z.charCodeAt(0)!==65279?z:z.slice(1))(v),L=new(g.download?y:O)(g)):v.readable===!0&&M(v.read)&&M(v.on)?L=new _(g):(a.File&&v instanceof File||v instanceof Object)&&(L=new w(g)),L.stream(v);(L=(()=>{var z;return!!d.WORKERS_SUPPORTED&&(z=(()=>{var ne=a.URL||a.webkitURL||null,ae=s.toString();return d.BLOB_URL||(d.BLOB_URL=ne.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",ae,")();"],{type:"text/javascript"})))})(),(z=new a.Worker(z)).onmessage=U,z.id=u++,c[z.id]=z)})()).userStep=g.step,L.userChunk=g.chunk,L.userComplete=g.complete,L.userError=g.error,g.step=M(g.step),g.chunk=M(g.chunk),g.complete=M(g.complete),g.error=M(g.error),delete g.worker,L.postMessage({input:v,config:g,workerId:L.id})},d.unparse=function(v,g){var L=!1,z=!0,ne=",",ae=`\r
`,ee='"',W=ee+ee,Z=!1,J=null,P=!1,m=((()=>{if(typeof g=="object"){if(typeof g.delimiter!="string"||d.BAD_DELIMITERS.filter(function(X){return g.delimiter.indexOf(X)!==-1}).length||(ne=g.delimiter),typeof g.quotes!="boolean"&&typeof g.quotes!="function"&&!Array.isArray(g.quotes)||(L=g.quotes),typeof g.skipEmptyLines!="boolean"&&typeof g.skipEmptyLines!="string"||(Z=g.skipEmptyLines),typeof g.newline=="string"&&(ae=g.newline),typeof g.quoteChar=="string"&&(ee=g.quoteChar),typeof g.header=="boolean"&&(z=g.header),Array.isArray(g.columns)){if(g.columns.length===0)throw new Error("Option columns is empty");J=g.columns}g.escapeChar!==void 0&&(W=g.escapeChar+ee),g.escapeFormulae instanceof RegExp?P=g.escapeFormulae:typeof g.escapeFormulae=="boolean"&&g.escapeFormulae&&(P=/^[=+\-@\t\r].*$/)}})(),new RegExp(b(ee),"g"));if(typeof v=="string"&&(v=JSON.parse(v)),Array.isArray(v)){if(!v.length||Array.isArray(v[0]))return A(null,v,Z);if(typeof v[0]=="object")return A(J||Object.keys(v[0]),v,Z)}else if(typeof v=="object")return typeof v.data=="string"&&(v.data=JSON.parse(v.data)),Array.isArray(v.data)&&(v.fields||(v.fields=v.meta&&v.meta.fields||J),v.fields||(v.fields=Array.isArray(v.data[0])?v.fields:typeof v.data[0]=="object"?Object.keys(v.data[0]):[]),Array.isArray(v.data[0])||typeof v.data[0]=="object"||(v.data=[v.data])),A(v.fields||[],v.data||[],Z);throw new Error("Unable to serialize unrecognized input");function A(X,Y,fe){var se="",ke=(typeof X=="string"&&(X=JSON.parse(X)),typeof Y=="string"&&(Y=JSON.parse(Y)),Array.isArray(X)&&0<X.length),Pe=!Array.isArray(Y[0]);if(ke&&z){for(var ge=0;ge<X.length;ge++)0<ge&&(se+=ne),se+=G(X[ge],ge);0<Y.length&&(se+=ae)}for(var me=0;me<Y.length;me++){var be=(ke?X:Y[me]).length,je=!1,oe=ke?Object.keys(Y[me]).length===0:Y[me].length===0;if(fe&&!ke&&(je=fe==="greedy"?Y[me].join("").trim()==="":Y[me].length===1&&Y[me][0].length===0),fe==="greedy"&&ke){for(var D=[],F=0;F<be;F++){var te=Pe?X[F]:F;D.push(Y[me][te])}je=D.join("").trim()===""}if(!je){for(var B=0;B<be;B++){0<B&&!oe&&(se+=ne);var Ee=ke&&Pe?X[B]:B;se+=G(Y[me][Ee],B)}me<Y.length-1&&(!fe||0<be&&!oe)&&(se+=ae)}}return se}function G(X,Y){var fe,se;return X==null?"":X.constructor===Date?JSON.stringify(X).slice(1,25):(se=!1,P&&typeof X=="string"&&P.test(X)&&(X="'"+X,se=!0),fe=X.toString().replace(m,W),(se=se||L===!0||typeof L=="function"&&L(X,Y)||Array.isArray(L)&&L[Y]||((ke,Pe)=>{for(var ge=0;ge<Pe.length;ge++)if(-1<ke.indexOf(Pe[ge]))return!0;return!1})(fe,d.BAD_DELIMITERS)||-1<fe.indexOf(ne)||fe.charAt(0)===" "||fe.charAt(fe.length-1)===" ")?ee+fe+ee:fe)}},d.RECORD_SEP="",d.UNIT_SEP="",d.BYTE_ORDER_MARK="\uFEFF",d.BAD_DELIMITERS=["\r",`
`,'"',d.BYTE_ORDER_MARK],d.WORKERS_SUPPORTED=!o&&!!a.Worker,d.NODE_STREAM_INPUT=1,d.LocalChunkSize=10485760,d.RemoteChunkSize=5242880,d.DefaultDelimiter=",",d.Parser=I,d.ParserHandle=E,d.NetworkStreamer=y,d.FileStreamer=w,d.StringStreamer=O,d.ReadableStreamStreamer=_,a.jQuery&&((n=a.jQuery).fn.parse=function(v){var g=v.config||{},L=[];return this.each(function(ae){if(!(n(this).prop("tagName").toUpperCase()==="INPUT"&&n(this).attr("type").toLowerCase()==="file"&&a.FileReader)||!this.files||this.files.length===0)return!0;for(var ee=0;ee<this.files.length;ee++)L.push({file:this.files[ee],inputElem:this,instanceConfig:n.extend({},g)})}),z(),this;function z(){if(L.length===0)M(v.complete)&&v.complete();else{var ae,ee,W,Z,J=L[0];if(M(v.before)){var P=v.before(J.file,J.inputElem);if(typeof P=="object"){if(P.action==="abort")return ae="AbortError",ee=J.file,W=J.inputElem,Z=P.reason,void(M(v.error)&&v.error({name:ae},ee,W,Z));if(P.action==="skip")return void ne();typeof P.config=="object"&&(J.instanceConfig=n.extend(J.instanceConfig,P.config))}else if(P==="skip")return void ne()}var m=J.instanceConfig.complete;J.instanceConfig.complete=function(A){M(m)&&m(A,J.file,J.inputElem),ne()},d.parse(J.file,J.instanceConfig)}}function ne(){L.splice(0,1),z()}}),i&&(a.onmessage=function(v){v=v.data,d.WORKER_ID===void 0&&v&&(d.WORKER_ID=v.workerId),typeof v.input=="string"?a.postMessage({workerId:d.WORKER_ID,results:d.parse(v.input,v.config),finished:!0}):(a.File&&v.input instanceof File||v.input instanceof Object)&&(v=d.parse(v.input,v.config))&&a.postMessage({workerId:d.WORKER_ID,results:v,finished:!0})}),(y.prototype=Object.create(p.prototype)).constructor=y,(w.prototype=Object.create(p.prototype)).constructor=w,(O.prototype=Object.create(O.prototype)).constructor=O,(_.prototype=Object.create(p.prototype)).constructor=_,d})}(La)),La.exports}var hg=pg();const un=vt(hg),Vu=async()=>{try{const t=await $.get("/api/business-profile");return{city:t.data.city||"",province:t.data.province||"",country:t.data.country||""}}catch(t){return console.error("Error fetching business profile:",t),{city:"",province:"",country:""}}};function yo(t,r){const[s,a]=l.useState(t);return l.useEffect(()=>{const n=setTimeout(()=>{a(t)},r);return()=>{clearTimeout(n)}},[t,r]),s}const Zl={customer_id:"",customer_name:"",contact_person:"",email:"",phone_number:"",street_address:"",city:"",province:"",country:"",postal_code:"",website:""},vo=({open:t,onClose:r,onSave:s,initialCustomer:a,isEditMode:n=!1,loading:o=!1,onUseExisting:i})=>{const[c,u]=l.useState(Zl),[d,p]=l.useState(null),[y,w]=l.useState({}),O=yo(c,300),[_,E]=l.useState([]),[b,I]=l.useState(null),[U,S]=l.useState([]),[j,N]=l.useState([]),[k,M]=l.useState([]),[v,g]=l.useState(""),[L,z]=l.useState(""),[ne,ae]=l.useState(""),[ee,W]=l.useState(""),Z=async()=>{try{const D=await Vu();u(F=>({...F,city:D.city,province:D.province,country:D.country}))}catch(D){console.error("Error autofilling from business profile:",D)}};l.useEffect(()=>{if(t){const D={...Zl,...a};u(D),p(null),(async()=>{try{const te=await $.get("/api/customers");E(te.data||[])}catch{}})(),!n&&(!a?.city||a.city==="")&&(!a?.province||a.province==="")&&(!a?.country||a.country==="")&&Z();const F=a?.customer_id;n&&F?(async()=>{try{const te=await Kl(F);S(te.people||[]),N(te.emails||[]),M(te.phones||[])}catch{}})():(S([]),N([]),M([]))}},[t,a,n]);const J=D=>{const{name:F,value:te}=D.target;u(B=>({...B,[F]:te})),y[F]&&w(B=>({...B,[F]:void 0}))},P=()=>c.customer_name.trim()?(p(null),!0):(p("Customer name is required"),!1),m=()=>{P()&&s(c)},A=D=>D.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim().toUpperCase(),G=(D,F)=>{const te=Math.floor(Math.max(D.length,F.length)/2)-1;if(te<0)return 0;const B=new Array(D.length).fill(!1),Ee=new Array(F.length).fill(!1);let Se=0;for(let We=0;We<D.length;We++){const pt=Math.max(0,We-te),kt=Math.min(We+te+1,F.length);for(let at=pt;at<kt;at++)if(!Ee[at]&&D[We]===F[at]){B[We]=!0,Ee[at]=!0,Se++;break}}if(Se===0)return 0;const $e=[],He=[];for(let We=0;We<D.length;We++)B[We]&&$e.push(D[We]);for(let We=0;We<F.length;We++)Ee[We]&&He.push(F[We]);let De=0;for(let We=0;We<$e.length;We++)$e[We]!==He[We]&&De++;De=Math.floor(De/2);const et=(Se/D.length+Se/F.length+(Se-De)/Se)/3;let Ve=0;const Be=4;for(let We=0;We<Math.min(Be,D.length,F.length)&&D[We]===F[We];We++)Ve++;return et+Ve*.1*(1-et)};l.useEffect(()=>{if(!t)return;const D={};O.email&&O.email.trim().length>0&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(O.email.trim())||(D.email="Invalid email format"));let F=null,te=0;if(O.customer_name&&O.customer_name.trim().length>0){const B=A(O.customer_name),Ee=(a?.customer_id??O.customer_id)||"";for(const Se of _){if(String(Se.customer_id)===String(Ee||""))continue;const He=A(Se.customer_name||""),et=He===B?1:G(He,B);et>te&&(te=et,F=Se)}te>=.92&&(D.customer_name="A similar customer already exists")}I(te>=.92&&F?F:null),w(B=>({...B,...D}))},[O,t]);const X=a?.customer_id,Y=async()=>{if(!(!n||!X))try{const D=await Kl(X);S(D.people||[]),N(D.emails||[]),M(D.phones||[])}catch{}},fe=async()=>{!X||!v.trim()||(await Zf(X,{name:v.trim()}),g(""),Y())},se=async D=>{X&&(await eg(X,D,{is_preferred:!0}),Y())},ke=async D=>{X&&(await tg(X,D),Y())},Pe=async()=>{!X||!L.trim()||(await rg(X,{email:L.trim()}),z(""),Y())},ge=async D=>{X&&(await ng(X,D,{is_preferred:!0}),Y())},me=async D=>{X&&(await sg(X,D),Y())},be=async()=>{!X||!ne.trim()||(await ag(X,{phone:ne.trim(),label:ee.trim()||void 0}),ae(""),W(""),Y())},je=async D=>{X&&(await og(X,D,{is_preferred:!0}),Y())},oe=async D=>{X&&(await ig(X,D),Y())};return e.jsxs(lt,{open:t,onClose:r,maxWidth:"md",fullWidth:!0,children:[e.jsx(ct,{children:n?"Edit Customer":"Add New Customer"}),e.jsxs(ut,{children:[e.jsxs(T,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"customer_name",label:"Customer Name",value:c.customer_name,onChange:J,fullWidth:!0,required:!0,error:!!y.customer_name,helperText:y.customer_name,autoFocus:!0})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"contact_person",label:"Contact Person",value:c.contact_person,onChange:J,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"email",label:"Email",type:"email",value:c.email,onChange:J,fullWidth:!0,error:!!y.email,helperText:y.email})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"phone_number",label:"Phone Number",value:c.phone_number,onChange:J,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{name:"street_address",label:"Street Address",value:c.street_address,onChange:J,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"city",label:"City",value:c.city,onChange:J,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"province",label:"Province/State",value:c.province,onChange:J,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"country",label:"Country",value:c.country,onChange:J,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"postal_code",label:"Postal Code",value:c.postal_code,onChange:J,fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{name:"website",label:"Website",value:c.website,onChange:J,fullWidth:!0})}),n&&X&&e.jsx(T,{item:!0,xs:12,children:e.jsxs(q,{sx:{mt:2},children:[e.jsx(f,{variant:"h6",sx:{mb:1},children:"Contacts"}),e.jsxs(T,{container:!0,spacing:2,children:[e.jsxs(T,{item:!0,xs:12,md:4,children:[e.jsx(f,{variant:"subtitle1",sx:{mb:1},children:"People"}),e.jsxs(tt,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(ie,{size:"small",label:"Name",value:v,onChange:D=>g(D.target.value),fullWidth:!0}),e.jsx(K,{variant:"outlined",size:"small",onClick:fe,children:"Add"})]}),e.jsxs(tt,{spacing:1,children:[U.map(D=>e.jsxs(tt,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(f,{variant:"body2",sx:{flex:1},children:[D.name," ",D.is_preferred?"(Preferred)":""]}),!D.is_preferred&&e.jsx(K,{size:"small",onClick:()=>se(D.id),children:"Set Preferred"}),e.jsx(K,{size:"small",color:"error",onClick:()=>ke(D.id),children:"Remove"})]},D.id)),U.length===0&&e.jsx(f,{variant:"body2",color:"text.secondary",children:"No people yet."})]})]}),e.jsxs(T,{item:!0,xs:12,md:4,children:[e.jsx(f,{variant:"subtitle1",sx:{mb:1},children:"Emails"}),e.jsxs(tt,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(ie,{size:"small",label:"Email",value:L,onChange:D=>z(D.target.value),fullWidth:!0}),e.jsx(K,{variant:"outlined",size:"small",onClick:Pe,children:"Add"})]}),e.jsxs(tt,{spacing:1,children:[j.map(D=>e.jsxs(tt,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(f,{variant:"body2",sx:{flex:1},children:[D.email," ",D.is_preferred?"(Preferred)":""]}),!D.is_preferred&&e.jsx(K,{size:"small",onClick:()=>ge(D.id),children:"Set Preferred"}),e.jsx(K,{size:"small",color:"error",onClick:()=>me(D.id),children:"Remove"})]},D.id)),j.length===0&&e.jsx(f,{variant:"body2",color:"text.secondary",children:"No emails yet."})]})]}),e.jsxs(T,{item:!0,xs:12,md:4,children:[e.jsx(f,{variant:"subtitle1",sx:{mb:1},children:"Phones"}),e.jsxs(tt,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(ie,{size:"small",label:"Phone",value:ne,onChange:D=>ae(D.target.value),fullWidth:!0}),e.jsx(ie,{size:"small",label:"Label",value:ee,onChange:D=>W(D.target.value),sx:{width:120}}),e.jsx(K,{variant:"outlined",size:"small",onClick:be,children:"Add"})]}),e.jsxs(tt,{spacing:1,children:[k.map(D=>e.jsxs(tt,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(f,{variant:"body2",sx:{flex:1},children:[D.phone,D.label?` (${D.label})`:""," ",D.is_preferred?"(Preferred)":""]}),!D.is_preferred&&e.jsx(K,{size:"small",onClick:()=>je(D.id),children:"Set Preferred"}),e.jsx(K,{size:"small",color:"error",onClick:()=>oe(D.id),children:"Remove"})]},D.id)),k.length===0&&e.jsx(f,{variant:"body2",color:"text.secondary",children:"No phones yet."})]})]})]})]})})]}),d&&e.jsx("div",{style:{color:"red",marginTop:8},children:d}),b&&e.jsxs("div",{style:{marginTop:12},children:[e.jsxs("div",{style:{color:"#b26a00",marginBottom:8},children:['Looks like "',b.customer_name,'" already exists.']}),typeof i=="function"&&e.jsx(K,{variant:"outlined",size:"small",onClick:()=>{i(b)},children:"Use existing"})]})]}),e.jsxs(dt,{children:[e.jsx(K,{onClick:r,children:"Cancel"}),e.jsx(K,{onClick:m,variant:"contained",disabled:o,children:n?"Save Changes":"Add Customer"})]})]})},mg=()=>{qt();const[t,r]=l.useState([]),[s,a]=l.useState(""),[n,o]=l.useState(null),[i,c]=l.useState(null),[u,d]=l.useState(!1),[p,y]=l.useState({pageSize:10,page:0}),[w,O]=l.useState(!1);l.useEffect(()=>{_()},[]);const _=async()=>{try{const N=await lg();r(N)}catch(N){console.error("Error fetching customers:",N),H.error("Failed to fetch customers")}},E=async N=>{if(window.confirm("Are you sure you want to delete this customer?"))try{await ug(N),r(k=>k.filter(M=>M.id!==N)),H.success("Customer deleted successfully")}catch(k){console.error("Error deleting customer:",k),H.error("Failed to delete customer")}},b=N=>{o(N),c({...N}),O(!0),d(!0)},I=()=>{d(!1),o(null),c(null)},U=t.filter(N=>N.customer_name.toLowerCase().includes(s.toLowerCase())||N.email?.toLowerCase().includes(s.toLowerCase())||N.phone_number?.toLowerCase().includes(s.toLowerCase())||`${N.street_address}, ${N.city}, ${N.province}, ${N.country}`.toLowerCase().includes(s.toLowerCase())),S=[{field:"customer_name",headerName:"Customer Name",flex:1.5},{field:"contact_person",headerName:"Contact Person",flex:1},{field:"email",headerName:"Email",flex:1.5},{field:"phone_number",headerName:"Phone Number",flex:1},{field:"actions",headerName:"Actions",width:80,sortable:!1,renderCell:N=>e.jsx(ot,{size:"small",color:"error",onClick:k=>{k.stopPropagation(),E(N.row.id)},children:e.jsx(tr,{})})}],j=()=>{const N=U.map(g=>({customer_name:g.customer_name,contact_person:g.contact_person,email:g.email,phone_number:g.phone_number})),k=un.unparse(N),M=new Blob([k],{type:"text/csv;charset=utf-8;"}),v=document.createElement("a");if(v.download!==void 0){const g=URL.createObjectURL(M);v.setAttribute("href",g),v.setAttribute("download","customer_list.csv"),v.style.visibility="hidden",document.body.appendChild(v),v.click(),document.body.removeChild(v)}};return e.jsx(Qe,{maxWidth:"xl",children:e.jsxs(q,{sx:{my:4},children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:"Customer List"}),e.jsxs(tt,{direction:"row",spacing:2,sx:{mb:2,justifyContent:"flex-end"},children:[e.jsx(K,{variant:"contained",startIcon:e.jsx(vr,{}),onClick:()=>{c({id:"",customer_id:"",customer_name:"",email:"",phone:"",phone_number:"",address:"",street_address:"",city:"",state:"",province:"",country:"",postal_code:"",contact_person:"",website:"",created_at:"",updated_at:""}),O(!1),d(!0)},children:"New Customer"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(or,{}),onClick:j,children:"Export CSV"})]}),e.jsx(qe,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(q,{sx:{p:2},children:[e.jsx(ie,{fullWidth:!0,variant:"outlined",placeholder:"Search customers...",value:s,onChange:N=>a(N.target.value),InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:e.jsx(yr,{})})},sx:{mb:2}}),e.jsx(Mr,{rows:U,columns:S,pageSizeOptions:[10,25,50],paginationModel:p,onPaginationModelChange:y,getRowId:N=>N.id,loading:!1,disableRowSelectionOnClick:!0,onRowClick:N=>b(N.row),sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})}),e.jsx(vo,{open:u,onClose:I,onSave:async N=>{try{if(w&&i)await Yu(i.id,N),r(k=>k.map(M=>M.id===i.id?{...M,...N}:M)),H.success("Customer updated successfully");else{const k=await Hu(N);r(M=>[...M,k]),H.success("Customer created successfully")}I()}catch(k){console.error("Error saving customer:",k),H.error(w?"Failed to update customer":"Failed to create customer")}},initialCustomer:i||{},isEditMode:w})]})})},fg=()=>{const{id:t}=Dn(),r=qt(),s=t==="new";console.log("Debug - URL id parameter:",t),console.log("Debug - isNewCustomer calculated:",s);const[a,n]=l.useState(!1),[o,i]=l.useState(!1),[c,u]=l.useState(null),[d,p]=l.useState(!1),[y,w]=l.useState({customer_name:"",email:"",phone_number:"",street_address:"",city:"",province:"",country:"",postal_code:"",contact_person:"",website:""});l.useEffect(()=>{!s&&t?O():s&&p(!0)},[t,s]);const O=async()=>{n(!0);try{if(!t)throw new Error("Customer ID is required");const E=await cg(t);w(E)}catch(E){console.error("Error fetching customer:",E),u("Failed to load customer data"),H.error("Failed to load customer data")}finally{n(!1)}},_=()=>{r("/customers")};return a?e.jsx(Qe,{maxWidth:"md",children:e.jsx(q,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh"},children:e.jsx(it,{})})}):e.jsx(Qe,{maxWidth:"md",children:e.jsxs(q,{sx:{my:4},children:[e.jsxs(q,{sx:{display:"flex",alignItems:"center",mb:3},children:[e.jsx(K,{startIcon:e.jsx(Vc,{}),onClick:_,sx:{mr:2},children:"Back to Customers"}),e.jsx(f,{variant:"h4",component:"h1",children:s?"Add New Customer":"Edit Customer"})]}),c&&e.jsx(Re,{severity:"error",sx:{mb:2},children:c}),e.jsx(vo,{open:d,onClose:()=>{p(!1),_()},onSave:async E=>{i(!0);try{s?(await Hu(E),H.success("Customer created successfully")):(await Yu(t,E),H.success("Customer updated successfully")),r("/customers")}catch{H.error("Failed to save customer")}finally{i(!1)}},initialCustomer:s?{}:y,isEditMode:!s,loading:o})]})})},gg=async()=>(await $.get("/api/vendors")).data,ec=async t=>(await $.get(`/api/vendors/${t}/contacts`)).data,xg=async(t,r)=>(await $.post(`/api/vendors/${t}/contacts/people`,r)).data,yg=async(t,r,s)=>(await $.put(`/api/vendors/${t}/contacts/people/${r}`,s)).data,vg=async(t,r)=>(await $.delete(`/api/vendors/${t}/contacts/people/${r}`)).data,_g=async(t,r)=>(await $.post(`/api/vendors/${t}/contacts/emails`,r)).data,bg=async(t,r,s)=>(await $.put(`/api/vendors/${t}/contacts/emails/${r}`,s)).data,jg=async(t,r)=>(await $.delete(`/api/vendors/${t}/contacts/emails/${r}`)).data,wg=async(t,r)=>(await $.post(`/api/vendors/${t}/contacts/phones`,r)).data,Sg=async(t,r,s)=>(await $.put(`/api/vendors/${t}/contacts/phones/${r}`,s)).data,Cg=async(t,r)=>(await $.delete(`/api/vendors/${t}/contacts/phones/${r}`)).data,tc={vendor_name:"",street_address:"",city:"",province:"",country:"",postal_code:"",contact_person:"",telephone_number:"",email:"",website:""},Gu=({open:t,onClose:r,onSave:s,initialVendor:a,isEditMode:n=!1,loading:o=!1})=>{const[i,c]=l.useState(tc),[u,d]=l.useState({}),p=yo(i,300),[y,w]=l.useState([]),[O,_]=l.useState([]),[E,b]=l.useState([]),[I,U]=l.useState([]),[S,j]=l.useState(""),[N,k]=l.useState(""),[M,v]=l.useState(""),[g,L]=l.useState("");l.useEffect(()=>{if(t){console.log("UnifiedVendorDialog: Setting vendor with initialVendor:",a);const se={...tc,...a};c(se),!n&&!a?.city&&!a?.province&&!a?.country&&ae(),(async()=>{try{const Pe=await $.get("/api/vendors");w(Pe.data||[])}catch{}})();const ke=a?.vendor_id;n&&ke?(async()=>{try{const Pe=await ec(ke);_(Pe.people||[]),b(Pe.emails||[]),U(Pe.phones||[])}catch{}})():(_([]),b([]),U([]))}},[t,a,n]);const z=se=>{const{name:ke,value:Pe}=se.target;c(ge=>({...ge,[ke]:Pe})),u[ke]&&d(ge=>({...ge,[ke]:void 0}))},ne=()=>{s(i)};l.useEffect(()=>{if(!t)return;const se={};if(p.email&&p.email.trim().length>0&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p.email.trim())||(se.email="Invalid email format")),p.vendor_name&&p.vendor_name.trim().length>0){const ke=p.vendor_name.trim().toLowerCase();y.some(ge=>(ge.vendor_name||"").trim().toLowerCase()===ke)&&!n&&(se.vendor_name="Vendor name already exists")}d(ke=>({...ke,...se}))},[p,t,n,y]);const ae=async()=>{try{const se=await Vu();c(ke=>({...ke,city:se.city,province:se.province,country:se.country})),console.log("Autofilled vendor form with business profile data:",se)}catch(se){console.error("Error autofilling from business profile:",se)}},ee=a?.vendor_id,W=async()=>{if(!(!n||!ee))try{const se=await ec(ee);_(se.people||[]),b(se.emails||[]),U(se.phones||[])}catch{}},Z=async()=>{!ee||!S.trim()||(await xg(ee,{name:S.trim()}),j(""),W())},J=async se=>{ee&&(await yg(ee,se,{is_preferred:!0}),W())},P=async se=>{ee&&(await vg(ee,se),W())},m=async()=>{!ee||!N.trim()||(await _g(ee,{email:N.trim()}),k(""),W())},A=async se=>{ee&&(await bg(ee,se,{is_preferred:!0}),W())},G=async se=>{ee&&(await jg(ee,se),W())},X=async()=>{!ee||!M.trim()||(await wg(ee,{phone:M.trim(),label:g.trim()||void 0}),v(""),L(""),W())},Y=async se=>{ee&&(await Sg(ee,se,{is_preferred:!0}),W())},fe=async se=>{ee&&(await Cg(ee,se),W())};return e.jsxs(lt,{open:t,onClose:r,maxWidth:"md",fullWidth:!0,sx:{zIndex:se=>se.zIndex.modal+5},children:[e.jsx(ct,{children:n?"Edit Vendor":"Add New Vendor"}),e.jsx(ut,{sx:{form:{autoComplete:"off"}},children:e.jsxs(T,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"vendor_name",label:"Vendor Name",value:i.vendor_name,onChange:z,fullWidth:!0,required:!0,error:!!u.vendor_name,helperText:u.vendor_name,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"contact_person",label:"Contact Person",value:i.contact_person,onChange:z,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"email",label:"Email",type:"email",value:i.email,onChange:z,fullWidth:!0,error:!!u.email,helperText:u.email,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"telephone_number",label:"Telephone",value:i.telephone_number,onChange:z,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{name:"street_address",label:"Street Address",value:i.street_address,onChange:z,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"city",label:"City",value:i.city,onChange:z,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"province",label:"Province/State",value:i.province,onChange:z,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"country",label:"Country",value:i.country,onChange:z,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{name:"postal_code",label:"Postal Code",value:i.postal_code,onChange:z,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{name:"website",label:"Website",value:i.website,onChange:z,fullWidth:!0,autoComplete:"new-password",inputProps:{autoComplete:"new-password"}})}),n&&ee&&e.jsx(T,{item:!0,xs:12,children:e.jsxs(q,{sx:{mt:2},children:[e.jsx(f,{variant:"h6",sx:{mb:1},children:"Contacts"}),e.jsxs(T,{container:!0,spacing:2,children:[e.jsxs(T,{item:!0,xs:12,md:4,children:[e.jsx(f,{variant:"subtitle1",sx:{mb:1},children:"People"}),e.jsxs(tt,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(ie,{size:"small",label:"Name",value:S,onChange:se=>j(se.target.value),fullWidth:!0}),e.jsx(K,{variant:"outlined",size:"small",onClick:Z,children:"Add"})]}),e.jsxs(tt,{spacing:1,children:[O.map(se=>e.jsxs(tt,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(f,{variant:"body2",sx:{flex:1},children:[se.name," ",se.is_preferred?"(Preferred)":""]}),!se.is_preferred&&e.jsx(K,{size:"small",onClick:()=>J(se.id),children:"Set Preferred"}),e.jsx(K,{size:"small",color:"error",onClick:()=>P(se.id),children:"Remove"})]},se.id)),O.length===0&&e.jsx(f,{variant:"body2",color:"text.secondary",children:"No people yet."})]})]}),e.jsxs(T,{item:!0,xs:12,md:4,children:[e.jsx(f,{variant:"subtitle1",sx:{mb:1},children:"Emails"}),e.jsxs(tt,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(ie,{size:"small",label:"Email",value:N,onChange:se=>k(se.target.value),fullWidth:!0}),e.jsx(K,{variant:"outlined",size:"small",onClick:m,children:"Add"})]}),e.jsxs(tt,{spacing:1,children:[E.map(se=>e.jsxs(tt,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(f,{variant:"body2",sx:{flex:1},children:[se.email," ",se.is_preferred?"(Preferred)":""]}),!se.is_preferred&&e.jsx(K,{size:"small",onClick:()=>A(se.id),children:"Set Preferred"}),e.jsx(K,{size:"small",color:"error",onClick:()=>G(se.id),children:"Remove"})]},se.id)),E.length===0&&e.jsx(f,{variant:"body2",color:"text.secondary",children:"No emails yet."})]})]}),e.jsxs(T,{item:!0,xs:12,md:4,children:[e.jsx(f,{variant:"subtitle1",sx:{mb:1},children:"Phones"}),e.jsxs(tt,{direction:"row",spacing:1,sx:{mb:1},children:[e.jsx(ie,{size:"small",label:"Phone",value:M,onChange:se=>v(se.target.value),fullWidth:!0}),e.jsx(ie,{size:"small",label:"Label",value:g,onChange:se=>L(se.target.value),sx:{width:120}}),e.jsx(K,{variant:"outlined",size:"small",onClick:X,children:"Add"})]}),e.jsxs(tt,{spacing:1,children:[I.map(se=>e.jsxs(tt,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(f,{variant:"body2",sx:{flex:1},children:[se.phone,se.label?` (${se.label})`:""," ",se.is_preferred?"(Preferred)":""]}),!se.is_preferred&&e.jsx(K,{size:"small",onClick:()=>Y(se.id),children:"Set Preferred"}),e.jsx(K,{size:"small",color:"error",onClick:()=>fe(se.id),children:"Remove"})]},se.id)),I.length===0&&e.jsx(f,{variant:"body2",color:"text.secondary",children:"No phones yet."})]})]})]})]})})]})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:r,children:"Cancel"}),e.jsx(K,{onClick:ne,variant:"contained",disabled:o,children:n?"Save Changes":"Add Vendor"})]})]})},kg=()=>{const[t,r]=l.useState(""),[s,a]=l.useState([]),[n,o]=l.useState(!1),[i,c]=l.useState({page:0,pageSize:10}),[u,d]=l.useState(!1),[p,y]=l.useState(!1),[w,O]=l.useState({}),_=s.filter(N=>(N.vendor_name||"").toLowerCase().includes(t.toLowerCase())||(N.contact_person||"").toLowerCase().includes(t.toLowerCase())||(N.email||"").toLowerCase().includes(t.toLowerCase())),E=[{field:"vendor_name",headerName:"Vendor Name",flex:1.5},{field:"contact_person",headerName:"Contact Person",flex:1},{field:"email",headerName:"Email",flex:1.5},{field:"telephone_number",headerName:"Phone Number",flex:1},{field:"actions",headerName:"Actions",width:100,sortable:!1,renderCell:N=>e.jsx(ot,{size:"small",color:"error",onClick:k=>{k.stopPropagation(),S(N.row.vendor_id)},children:e.jsx(tr,{})})}],b=async()=>{o(!0);try{const k=(await gg()).map(M=>({...M,id:M.vendor_id}));a(k)}catch{H.error("Failed to fetch vendors.")}finally{o(!1)}};l.useEffect(()=>{b()},[]);const I=(N=null)=>{N?(y(!0),O(N)):(y(!1),O({vendor_name:"",street_address:"",city:"",province:"",country:"",contact_person:"",telephone_number:"",email:"",website:"",postal_code:""})),d(!0)},U=()=>{d(!1),O({})},S=async N=>{if(window.confirm("Are you sure you want to delete this vendor?"))try{await $.delete(`/api/vendors/${N}`),H.success("Vendor deleted successfully!"),b()}catch(k){k instanceof nr?H.error(k.response?.data?.error||"Failed to delete vendor."):H.error("An unexpected error occurred while deleting the vendor.")}},j=()=>{const N=un.unparse(_),k=new Blob([N],{type:"text/csv;charset=utf-8;"}),M=document.createElement("a");if(M.download!==void 0){const v=URL.createObjectURL(k);M.setAttribute("href",v),M.setAttribute("download","vendor_list.csv"),M.style.visibility="hidden",document.body.appendChild(M),M.click(),document.body.removeChild(M)}};return e.jsxs(Qe,{maxWidth:"xl",children:[e.jsxs(q,{sx:{my:4},children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:"Vendor Management"}),e.jsxs(tt,{direction:"row",spacing:2,sx:{mb:2,justifyContent:"flex-end"},children:[e.jsx(K,{variant:"contained",startIcon:e.jsx(vr,{}),onClick:()=>I(),children:"New Vendor"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(or,{}),onClick:j,children:"Export CSV"})]}),e.jsx(qe,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(q,{sx:{p:2,width:"100%"},children:[e.jsx(ie,{fullWidth:!0,variant:"outlined",placeholder:"Search vendors...",value:t,onChange:N=>r(N.target.value),InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:e.jsx(yr,{})})},sx:{mb:2}}),e.jsx(Mr,{rows:_,columns:E,loading:n,paginationModel:i,onPaginationModelChange:c,pageSizeOptions:[10,25,50],getRowId:N=>N.vendor_id,onRowClick:N=>I(N.row),disableRowSelectionOnClick:!0,sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]}),e.jsx(Gu,{open:u,onClose:U,onSave:async N=>{try{p?(await $.put(`/api/vendors/${w.vendor_id}`,N),H.success("Vendor updated successfully!")):(await $.post("/api/vendors",N),H.success("Vendor added successfully!")),U(),b()}catch(k){k instanceof nr?H.error(k.response?.data?.error||`Failed to ${p?"update":"add"} vendor.`):H.error(`An unexpected error occurred while ${p?"updating":"adding"} the vendor.`)}},initialVendor:w,isEditMode:p})]})},Pg=()=>{const{id:t}=Dn();return e.jsx(Qe,{maxWidth:"md",children:e.jsxs(q,{sx:{my:4},children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:"Vendor Detail Page"}),e.jsxs(qe,{sx:{p:3},children:[e.jsxs(f,{variant:"h6",children:["Vendor ID: ",t]}),e.jsx(f,{variant:"body1",children:"This is a placeholder for the Vendor Detail Page."})]})]})})},Eg=()=>{const{id:t}=Dn();return e.jsx(Qe,{maxWidth:"md",children:e.jsxs(q,{sx:{my:4},children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:"Product Detail Page"}),e.jsxs(qe,{sx:{p:3},children:[e.jsxs(f,{variant:"h6",children:["Product ID: ",t]}),e.jsx(f,{variant:"body1",children:"This is a placeholder for the Product Detail Page."})]})]})})};var _s={},rc;function Dg(){if(rc)return _s;rc=1;var t=At();Object.defineProperty(_s,"__esModule",{value:!0}),_s.default=void 0;var r=t(Rt()),s=Mt();return _s.default=(0,r.default)((0,s.jsx)("path",{d:"M5 20h14v-2H5zm0-10h4v6h6v-6h4l-7-7z"}),"Upload"),_s}var Tg=Dg();const Qu=vt(Tg),Ju=async t=>{const r=t?{partType:t}:{};return(await $.get("/api/inventory",{params:r})).data},Og=async()=>Ju("stock"),Ig=async()=>Ju("supply"),Ag=async t=>(await $.get(`/api/inventory/${encodeURIComponent(t)}`)).data,Mg=async t=>(await $.post("/api/inventory/cleanup-enforce",{partType:t,apply:!1})).data,Ku=async(t,r)=>(await $.post("/api/inventory/cleanup-enforce",{partType:t,apply:!0,merges:r})).data,qa=async t=>(await $.get(`/api/inventory/${encodeURIComponent(t)}/vendors`)).data,ba=async t=>(await $.get(`/api/inventory/part/${t}/vendors`)).data,Rg=async(t,r)=>(await $.post(`/api/inventory/${encodeURIComponent(t)}/vendors`,r)).data,Ng=async(t,r)=>(await $.post(`/api/inventory/part/${t}/vendors`,r)).data,Lg=async(t,r,s)=>(await $.put(`/api/inventory/${encodeURIComponent(t)}/vendors/${r}`,s)).data,qg=async(t,r,s)=>(await $.put(`/api/inventory/part/${t}/vendors/${r}`,s)).data,Ug=async(t,r)=>(await $.delete(`/api/inventory/${encodeURIComponent(t)}/vendors/${r}`)).data,Wg=async(t,r)=>(await $.delete(`/api/inventory/part/${t}/vendors/${r}`)).data,Fg=async()=>(await $.get("/api/categories")).data,$g=async t=>(await $.post("/api/categories",t)).data.category,nc=async(t,r)=>{const s=r?{reassign:"true"}:{};await $.delete(`/api/categories/${t}`,{params:s})},Qo="__ADD_NEW_CATEGORY__",Bg=({value:t,onChange:r,label:s="Category",error:a,errorMessage:n,fullWidth:o=!0,disabled:i})=>{const[c,u]=l.useState([]),[d,p]=l.useState(!1),[y,w]=l.useState(!1),[O,_]=l.useState(""),[E,b]=l.useState(""),[I,U]=l.useState(!1),{user:S}=Qt();l.useEffect(()=>{let v=!0;return(async()=>{p(!0);try{const L=await Fg();v&&u(L)}catch(L){console.error("CategorySelect: failed to load categories",L),H.error("Failed to load categories")}finally{v&&p(!1)}})(),()=>{v=!1}},[]);const j=l.useMemo(()=>{const v=c.map(g=>g.category_name);return v.some(g=>g.toLowerCase()==="uncategorized")||v.unshift("Uncategorized"),v.sort((g,L)=>g.localeCompare(L))},[c]),N=v=>{const g=v.target.value;if(g===Qo){w(!0);return}r(g)},k=async(v,g)=>{if(g?.preventDefault(),g?.stopPropagation(),v.category_name.toLowerCase()==="uncategorized"){H.warn('Cannot delete the default "Uncategorized" category');return}if(S?.access_role!=="Admin"){H.error("Only Admin users can delete categories");return}if(window.confirm(`Delete category "${v.category_name}"? This cannot be undone.`))try{await nc(v.category_id),u(z=>z.filter(ne=>ne.category_id!==v.category_id)),t&&t.toLowerCase()===v.category_name.toLowerCase()&&r("Uncategorized"),H.success("Category deleted")}catch(z){const ne=z?.response?.data;if(ne?.error==="Cannot delete category"&&ne?.suggestion){if(window.confirm(`${ne.details}

${ne.suggestion}

Would you like to reassign all items to "Uncategorized" and delete the category?`))try{await nc(v.category_id,!0),u(ee=>ee.filter(W=>W.category_id!==v.category_id)),t&&t.toLowerCase()===v.category_name.toLowerCase()&&r("Uncategorized"),H.success(ne.details?`Category deleted. ${ne.details}`:"Category deleted")}catch(ee){const W=ee?.response?.data?.error||"Failed to delete category";H.error(W)}}else{const ae=ne?.error||"Failed to delete category";H.error(ae)}}},M=async()=>{const v=O.trim();if(!v){H.warn("Please enter a category name");return}if(j.some(g=>g.toLowerCase()===v.toLowerCase())){H.warn("Category already exists");return}U(!0);try{const g=E.trim(),L=await $g({category_name:v,description:g||void 0});u(z=>[...z,L]),w(!1),_(""),b(""),r(L.category_name),H.success("Category added")}catch(g){console.error("CategorySelect: failed to create category",g),H.error("Failed to add category")}finally{U(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(ie,{label:s,value:t,onChange:N,select:!0,fullWidth:o,required:!0,error:!!a,helperText:n,disabled:i||d,children:[c.slice().sort((v,g)=>v.category_name.localeCompare(g.category_name)).map(v=>e.jsxs(ze,{value:v.category_name,sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:v.category_name}),S?.access_role==="Admin"&&v.category_name.toLowerCase()!=="uncategorized"&&e.jsx(ot,{"aria-label":`Delete ${v.category_name}`,size:"small",edge:"end",onClick:g=>k(v,g),sx:{ml:2,color:"error.main"},children:e.jsx(tr,{fontSize:"small"})})]},v.category_id)),e.jsx(ze,{value:Qo,children:"+ Add new category…"},Qo)]}),e.jsxs(lt,{open:y,onClose:()=>w(!1),maxWidth:"xs",fullWidth:!0,children:[e.jsx(ct,{children:"Add New Category"}),e.jsx(ut,{children:e.jsxs(tt,{spacing:2,sx:{mt:1},children:[e.jsx(ie,{label:"Category Name",value:O,onChange:v=>_(v.target.value),autoFocus:!0,fullWidth:!0}),e.jsx(ie,{label:"Description (optional)",value:E,onChange:v=>b(v.target.value),fullWidth:!0,multiline:!0,minRows:2})]})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>w(!1),disabled:I,children:"Cancel"}),e.jsx(K,{onClick:M,variant:"contained",disabled:I,children:"Save"})]})]})]})},Jo=["Each","cm","ft","kg","pcs","L"],zg=["stock","supply"],kn=({open:t,onClose:r,onSave:s,initialPart:a,isEditMode:n=!1,title:o})=>{const{user:i}=Qt(),[c,u]=l.useState({part_number:"",part_description:"",unit:Jo[0],last_unit_cost:"",quantity_on_hand:"",reorder_point:"",part_type:"stock",category:"Uncategorized",...a||{}}),[d,p]=l.useState({}),[y,w]=l.useState(!1),O=l.useRef(null);l.useEffect(()=>{t&&(u({part_id:a?.part_id,part_number:a?.part_number||"",part_description:a?.part_description||"",unit:a?.unit||Jo[0],last_unit_cost:a?.last_unit_cost||"",quantity_on_hand:a?.quantity_on_hand||"",reorder_point:a?.reorder_point||"",part_type:a?.part_type||"stock",category:a?.category||"Uncategorized"}),p({}),w(!1))},[t,a?.part_id,a?.part_number]),l.useEffect(()=>{t&&O.current&&setTimeout(()=>O.current?.focus(),100)},[t]);const _=(m,A)=>{m==="part_number"&&(A=A.toUpperCase()),u(m==="part_type"&&A==="supply"?G=>({...G,[m]:A,quantity_on_hand:"NA"}):G=>({...G,[m]:A})),d[m]&&p(G=>({...G,[m]:void 0}))},E=()=>{const m={};c.part_number.trim()||(m.part_number="Part Number is required"),c.part_number&&/\s/.test(c.part_number)&&(m.part_number="Part Number cannot contain spaces"),c.part_number&&!/^[A-Z0-9()\/-]+$/.test(c.part_number)&&(m.part_number="Only letters/numbers and - / ( ) are allowed");const A=c.part_number;if(A&&A.includes("/")&&((()=>{const fe=[];for(let me=0;me<A.length;me++)A[me]==="/"&&fe.push(me);if(fe.length===0)return!0;const se=new Array(A.length).fill(-1);let ke=-1;for(let me=0;me<A.length;me++)A[me]==="("&&(ke=me),se[me]=ke;const Pe=new Array(A.length).fill(-1);let ge=-1;for(let me=A.length-1;me>=0;me--)A[me]===")"&&(ge=me),Pe[me]=ge;return fe.every(me=>se[me]!==-1&&Pe[me]!==-1&&se[me]<me&&me<Pe[me])})()||(m.part_number="Fractions must be enclosed in parentheses, e.g., (1/2)")),c.part_description.trim()||(m.part_description="Part Description is required"),c.unit||(m.unit="Unit is required"),c.part_type||(m.part_type="Part Type is required"),["stock","supply"].includes(c.part_type)||(m.part_type='Part Type must be either "stock" or "supply"'),(!c.category||c.category.trim()==="")&&(m.category="Category is required"),c.part_type!=="supply"){const Y=parseFloat(String(c.quantity_on_hand));c.quantity_on_hand!==""&&(isNaN(Y)||Y<0)&&(m.quantity_on_hand="Quantity on Hand must be a valid number >= 0")}const G=parseFloat(String(c.last_unit_cost));c.last_unit_cost!==""&&isNaN(G)&&(m.last_unit_cost="Last Unit Cost must be a valid number");const X=parseFloat(String(c.reorder_point));return c.reorder_point!==""&&isNaN(X)&&(m.reorder_point="Reorder Point must be a valid number"),p(m),Object.keys(m).length===0},b=async()=>{if(!E()){H.error("Please correct the errors before saving.");return}w(!0);try{const m={...c,part_number:c.part_number.trim().toUpperCase(),part_description:c.part_description.trim(),unit:c.unit.trim(),last_unit_cost:c.last_unit_cost===""?null:parseFloat(String(c.last_unit_cost)),quantity_on_hand:c.part_type==="supply"?"NA":c.quantity_on_hand===""?0:parseFloat(String(c.quantity_on_hand)),reorder_point:c.reorder_point===""?null:parseFloat(String(c.reorder_point)),part_type:c.part_type.trim(),category:c.category.trim()};await s(m),H.success(`Part ${n?"updated":"added"} successfully!`),r()}catch(m){console.error("Error saving part:",m);let A=`Failed to ${n?"update":"add"} part.`;m.response?.data?.error?A=m.response.data.error:m.response?.data?.message&&(A=m.response.data.message),m.response?.status===409||A.includes("Part number already exists")||A.includes("duplicate key value")||A.includes("already exists")?(p(G=>({...G,part_number:"Part number already exists. Please use a unique part number."})),H.error("Part number already exists. Please use a unique part number.")):H.error(A)}finally{w(!1)}},I=()=>{y||r()},U=o||(n?"Edit Part":"Add New Part"),[S,j]=l.useState([]),[N,k]=l.useState([]),[M,v]=l.useState(""),[g,L]=l.useState(""),[z,ne]=l.useState(""),[ae,ee]=l.useState(!1),W=!!c.part_id;l.useEffect(()=>{t&&(async()=>{try{const m=await $.get("/api/vendors");k(m.data||[])}catch{}})()},[t]),l.useEffect(()=>{if(!t)return;const m=c.part_id;if(!m){j([]);return}(async()=>{try{const A=await ba(m);j(A||[])}catch{j([])}})()},[t,c.part_id]);const Z=async()=>{const m=String(c.part_number||"").trim().toUpperCase();if(m){if(!M||!g.trim()){H.error("Select a vendor and enter vendor part number");return}try{const A={vendor_id:Number(M),vendor_part_number:g.trim().toUpperCase(),vendor_part_description:z||void 0,preferred:ae};if(c.part_id){await Ng(c.part_id,A);const G=await ba(c.part_id);j(G||[])}else{await Rg(m,A);const G=await qa(m);j(G||[])}v(""),L(""),ne(""),ee(!1),H.success("Vendor mapping added")}catch(A){H.error(A?.response?.data?.error||"Failed to add vendor mapping")}}},J=async m=>{try{if(c.part_id){await qg(c.part_id,m.id,{preferred:!m.preferred});const A=await ba(c.part_id);j(A||[])}else{await Lg(c.part_number.toUpperCase(),m.id,{preferred:!m.preferred});const A=await qa(c.part_number.toUpperCase());j(A||[])}}catch{H.error("Failed to update preferred")}},P=async m=>{if(window.confirm("Remove this vendor mapping?"))try{if(c.part_id){await Wg(c.part_id,m.id);const A=await ba(c.part_id);j(A||[])}else{await Ug(c.part_number.toUpperCase(),m.id);const A=await qa(c.part_number.toUpperCase());j(A||[])}}catch{H.error("Failed to delete mapping")}};return e.jsxs(lt,{open:t,onClose:I,maxWidth:"md",fullWidth:!0,children:[e.jsx(ct,{children:U}),e.jsx(ut,{children:e.jsxs(tt,{spacing:3,sx:{mt:1},children:[e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"Part Number",value:c.part_number,onChange:m=>_("part_number",m.target.value),fullWidth:!0,required:!0,error:!!d.part_number,helperText:d.part_number,inputRef:O})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"Part Type",value:c.part_type,onChange:m=>_("part_type",m.target.value),select:!0,fullWidth:!0,required:!0,error:!!d.part_type,helperText:d.part_type,children:zg.map(m=>e.jsx(ze,{value:m,children:m.charAt(0).toUpperCase()+m.slice(1)},m))})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(Bg,{label:"Category",value:c.category,onChange:m=>_("category",m),error:!!d.category,errorMessage:d.category})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"Part Description",value:c.part_description,onChange:m=>_("part_description",m.target.value),fullWidth:!0,required:!0,error:!!d.part_description,helperText:d.part_description,multiline:!0,rows:2})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{label:"Unit",value:c.unit,onChange:m=>_("unit",m.target.value),select:!0,fullWidth:!0,required:!0,error:!!d.unit,helperText:d.unit,children:Jo.map(m=>e.jsx(ze,{value:m,children:m},m))})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{label:"Last Unit Cost",value:c.last_unit_cost,onChange:m=>_("last_unit_cost",m.target.value),type:"number",fullWidth:!0,error:!!d.last_unit_cost,helperText:d.last_unit_cost,inputProps:{step:"0.01",min:"0"}})}),c.part_type!=="supply"&&e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{label:"Quantity on Hand",value:c.quantity_on_hand,onChange:m=>_("quantity_on_hand",m.target.value),type:"number",fullWidth:!0,error:!!d.quantity_on_hand,helperText:d.quantity_on_hand,inputProps:{step:"1",min:"0"},disabled:i?.access_role==="Sales and Purchase"})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"Reorder Point",value:c.reorder_point,onChange:m=>_("reorder_point",m.target.value),type:"number",fullWidth:!0,error:!!d.reorder_point,helperText:d.reorder_point,inputProps:{step:"1",min:"0"}})})]}),Object.keys(d).length>0&&e.jsx(Re,{severity:"error",children:e.jsx(f,{variant:"body2",children:"Please correct the errors above before saving."})}),e.jsxs(q,{children:[e.jsx(f,{variant:"h6",sx:{mb:1},children:"Vendors"}),!W&&e.jsx(f,{variant:"body2",color:"text.secondary",children:"Save the part first to manage vendor mappings."}),W&&e.jsxs(e.Fragment,{children:[e.jsxs(T,{container:!0,spacing:1,sx:{mb:1},children:[e.jsx(T,{item:!0,xs:12,sm:3,children:e.jsxs(ie,{label:"Vendor",select:!0,value:M,onChange:m=>v(m.target.value===""?"":Number(m.target.value)),fullWidth:!0,SelectProps:{native:!0},children:[e.jsx("option",{value:""}),N.map(m=>e.jsx("option",{value:m.vendor_id,children:m.vendor_name},m.vendor_id))]})}),e.jsx(T,{item:!0,xs:12,sm:3,children:e.jsx(ie,{label:"Vendor Part #",value:g,onChange:m=>L(m.target.value),fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{label:"Vendor Part Description",value:z,onChange:m=>ne(m.target.value),fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:2,children:e.jsx(K,{variant:"outlined",onClick:()=>ee(m=>!m),fullWidth:!0,children:ae?"Preferred ✓":"Preferred"})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(K,{variant:"contained",onClick:Z,children:"Add Vendor Mapping"})})]}),S.length===0?e.jsx(f,{variant:"body2",color:"text.secondary",children:"No vendor mappings yet."}):e.jsxs(T,{container:!0,spacing:1,children:[e.jsx(T,{item:!0,xs:12,children:e.jsxs(T,{container:!0,spacing:1,sx:{fontWeight:600,mb:1},children:[e.jsx(T,{item:!0,xs:12,sm:2.5,children:"Vendor"}),e.jsx(T,{item:!0,xs:12,sm:2.5,children:"Vendor Part #"}),e.jsx(T,{item:!0,xs:12,sm:3,children:"Description"}),e.jsx(T,{item:!0,xs:12,sm:1,children:"Pref"}),e.jsx(T,{item:!0,xs:12,sm:3,children:"Actions"})]})}),S.map(m=>e.jsx(T,{item:!0,xs:12,children:e.jsxs(T,{container:!0,spacing:1,alignItems:"center",sx:{py:1,borderBottom:"1px solid #e0e0e0"},children:[e.jsx(T,{item:!0,xs:12,sm:2.5,children:e.jsx(f,{variant:"body2",noWrap:!0,children:m.vendor_name||m.vendor_id})}),e.jsx(T,{item:!0,xs:12,sm:2.5,children:e.jsx(f,{variant:"body2",noWrap:!0,children:m.vendor_part_number})}),e.jsx(T,{item:!0,xs:12,sm:3,children:e.jsx(f,{variant:"body2",noWrap:!0,children:m.vendor_part_description||""})}),e.jsx(T,{item:!0,xs:12,sm:1,sx:{textAlign:"center"},children:m.preferred?"✓":""}),e.jsx(T,{item:!0,xs:12,sm:3,children:e.jsxs(tt,{direction:"row",spacing:1,sx:{flexWrap:"wrap"},children:[e.jsx(K,{size:"small",variant:"outlined",onClick:()=>J(m),sx:{minWidth:"fit-content"},children:m.preferred?"Unset":"Set Preferred"}),e.jsx(K,{size:"small",color:"error",variant:"outlined",onClick:()=>P(m),sx:{minWidth:"fit-content"},children:"Remove"})]})})]})},m.id))]})]})]})]})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:I,disabled:y,children:"Cancel"}),e.jsx(K,{onClick:b,variant:"contained",disabled:y,children:y?"Saving...":n?"Update Part":"Save Part"})]})]})},Hg=()=>{const[t,r]=l.useState(""),[s,a]=l.useState([]),[n,o]=l.useState(!1),[i,c]=l.useState(!1),[u,d]=l.useState(null),[p,y]=l.useState(!1),[w,O]=l.useState(0),[_,E]=l.useState(null),[b,I]=l.useState(!1),U=l.useRef(null),[S,j]=l.useState(!1),[N,k]=l.useState(null),[M,v]=l.useState(!1),[g,L]=l.useState(null),[z,ne]=l.useState(!1),[ae,ee]=l.useState({page:0,pageSize:10}),{user:W}=Qt(),Z=async()=>{o(!0);try{const F=await Og();console.log("Raw inventory response:",F),F.length>0&&console.log("Sample inventory item from frontend:",{part_id:F[0].part_id,part_number:F[0].part_number,last_unit_cost:F[0].last_unit_cost,last_unit_cost_type:typeof F[0].last_unit_cost,quantity_on_hand:F[0].quantity_on_hand,quantity_on_hand_type:typeof F[0].quantity_on_hand});const te=F.map((B,Ee)=>({...B,id:B.part_number||Ee}));a(te)}catch(F){console.error("Error fetching inventory:",F)}finally{o(!1)}};l.useEffect(()=>{Z();const F=()=>Z();return window.addEventListener("inventory-updated",F),()=>window.removeEventListener("inventory-updated",F)},[]);const J=s.filter(F=>F.part_number?.toUpperCase().includes(t.toUpperCase())||F.part_description?.toLowerCase().includes(t.toLowerCase())),P=[{field:"part_number",headerName:"Part #",flex:1,headerAlign:"left",editable:!0},{field:"part_description",headerName:"Part Description",flex:2,headerAlign:"left"},{field:"category",headerName:"Category",flex:1,headerAlign:"left"},{field:"quantity_on_hand",headerName:"Quantity on Hand",flex:1,type:"number",editable:W?.access_role!=="Sales and Purchase",align:"center",headerAlign:"left"},{field:"unit",headerName:"UOM",flex:.5,headerAlign:"left"},{field:"last_unit_cost",headerName:"Last Unit Cost",flex:1,type:"number",editable:!0,align:"center",headerAlign:"left",valueFormatter:F=>`$${(Number(F.value)||0).toFixed(2)}`,valueGetter:F=>Number(F.value)||0},{field:"reorder_point",headerName:"Reorder Point",flex:.75,type:"number",editable:!0,align:"center",headerAlign:"left"},{field:"value",headerName:"Value",flex:1,type:"number",valueGetter:F=>{const te=Number(F.row.quantity_on_hand)||0,B=Number(F.row.last_unit_cost)||0;return te*B},valueFormatter:F=>`$${(Number(F.value)||0).toFixed(2)}`,headerAlign:"center",align:"center"},{field:"actions",headerName:"Actions",width:100,headerAlign:"left",sortable:!1,renderCell:F=>e.jsx(ot,{size:"small",color:"error",onClick:te=>{te.stopPropagation(),m(F.row.part_number)},children:e.jsx(tr,{fontSize:"medium",sx:{fontSize:28}})})}].filter(Boolean),m=async F=>{if(window.confirm(`Are you sure you want to delete part ${F}?`))try{console.log(`Deleting part: ${F}`);const te=await $.delete(`/api/inventory/${encodeURIComponent(F)}`);console.log(`Part ${F} deleted successfully:`,te.data),alert(`Part ${F} deleted successfully!`),Z()}catch(te){console.error(`Error deleting part ${F}:`,te),alert(`Error deleting part ${F}. Please check the console.`)}},A=async(F,te)=>{console.log("Attempting to update row:",F);const B={};if(F.part_number!==te.part_number){const Se=String(F.part_number).trim().toUpperCase();if(!Se)return alert("Part number cannot be empty."),Promise.reject("Invalid part number");B.part_number=Se}if(F.quantity_on_hand!==te.quantity_on_hand){if(W?.access_role==="Sales and Purchase")return alert("Sales and Purchase users cannot modify quantity on hand for existing parts."),Promise.reject("Access denied");const Se=parseFloat(String(F.quantity_on_hand));if(isNaN(Se))return alert("Invalid quantity value. Please enter a valid number."),Promise.reject("Invalid quantity");B.quantity_on_hand=Se}if(F.reorder_point!==te.reorder_point){const Se=parseFloat(String(F.reorder_point));if(isNaN(Se))return alert("Invalid reorder point value. Please enter a valid number."),Promise.reject("Invalid reorder point");B.reorder_point=Se}if(F.last_unit_cost!==te.last_unit_cost){const Se=parseFloat(String(F.last_unit_cost));if(isNaN(Se))return alert("Invalid last unit cost value. Please enter a valid number."),Promise.reject("Invalid last unit cost");B.last_unit_cost=Se}if(F.category!==te.category&&(B.category=F.category),Object.keys(B).length===0)return console.log("No fields changed."),F;const Ee=te.part_number;try{console.log("🔍 processRowUpdate: Sending PUT request"),console.log("📋 URL:",`/api/inventory/${encodeURIComponent(Ee)}`),console.log("📋 Request body:",B),console.log("📋 Old part number:",te.part_number),console.log("📋 New part number:",F.part_number);const Se=await $.put(`/api/inventory/${encodeURIComponent(Ee)}`,B);return console.log(`Inventory updated for part ${Ee}:`,Se.data),alert(`Part ${Ee} updated successfully!`),await Z(),Se.data.updatedItem||F}catch(Se){return console.error(`Error updating inventory for part ${Ee}:`,Se),Se instanceof nr&&Se.response&&Se.response.data&&Se.response.data.error?alert(`Error updating inventory: ${Se.response.data.error}`):alert(`Error updating inventory for part ${Ee}. Please check the console.`),Promise.reject(Se)}},G=()=>{const F=J.map(Se=>({...Se,value:(Number(Se.quantity_on_hand)||0)*(Number(Se.last_unit_cost)||0)})),te=un.unparse(F),B=new Blob([te],{type:"text/csv;charset=utf-8;"}),Ee=document.createElement("a");if(Ee.download!==void 0){const Se=URL.createObjectURL(B);Ee.setAttribute("href",Se),Ee.setAttribute("download","inventory_list.csv"),Ee.style.visibility="hidden",document.body.appendChild(Ee),Ee.click()}},X=()=>{d(null),c(!0)},Y=async F=>{const te={...F,part_number:F.part_number.trim().toUpperCase(),part_description:F.part_description.trim(),unit:F.unit.trim(),part_type:F.part_type.trim()};try{if(u){const B={...te,part_number:te.part_number};console.log("🔍 Frontend: Sending PUT request"),console.log("📋 URL:",`/api/inventory/${encodeURIComponent(u.part_number)}`),console.log("📋 Request body:",B),console.log("📋 Original part number:",u.part_number),console.log("📋 New part number:",te.part_number),await $.put(`/api/inventory/${encodeURIComponent(u.part_number)}`,B)}else await $.post("/api/inventory",te);Z()}catch(B){throw B}},fe=()=>{c(!1),d(null)},se=F=>{d({part_id:F.row.part_id,part_number:F.row.part_number,part_description:F.row.part_description||"",unit:F.row.unit||"Each",last_unit_cost:F.row.last_unit_cost||"",quantity_on_hand:F.row.quantity_on_hand||"",reorder_point:F.row.reorder_point||"",part_type:F.row.part_type||"stock",category:F.row.category||"Uncategorized"}),c(!0)},ke=()=>{U.current?.click()},Pe=async F=>{const te=F.target.files?.[0];if(te){if(!te.name.endsWith(".csv")&&te.type!=="text/csv"){alert("Please select a valid CSV file");return}if(te.size>5*1024*1024){alert("File size must be less than 5MB");return}await ge(te)}},ge=async F=>{y(!0),O(0),E(null);const te=new FormData;te.append("csvFile",F);try{const B=setInterval(()=>{O(Se=>Se>=90?(clearInterval(B),90):Se+10)},200),Ee=await $.post("/api/inventory/upload-csv",te,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:Se=>{if(Se.total){const $e=Math.round(Se.loaded*90/Se.total);O($e)}}});clearInterval(B),O(100),E(Ee.data),I(!0),setTimeout(()=>{Z()},1e3)}catch(B){console.error("Error uploading CSV:",B),B instanceof nr&&B.response?.data?E({error:"Upload failed",errors:B.response.data.errors||[B.response.data.error||"Unknown error"],warnings:B.response.data.warnings||[]}):E({error:"Upload failed",errors:["An unexpected error occurred during upload"]}),I(!0)}finally{y(!1),O(0),U.current&&(U.current.value="")}},me=async()=>{try{const F=await $.get("/api/inventory/csv-template",{responseType:"blob"}),te=window.URL.createObjectURL(new Blob([F.data])),B=document.createElement("a");B.href=te,B.setAttribute("download","inventory_template.csv"),document.body.appendChild(B),B.click(),B.remove(),window.URL.revokeObjectURL(te)}catch(F){console.error("Error downloading template:",F),alert("Error downloading template")}},be=()=>{I(!1),E(null)},je=async()=>{j(!0);try{const F=[],te=[],B=He=>{const De=[],et=[];let Ve=String(He||"");const Be=Ve,Ke=Ve.replace(/\s+/g,"");Ke!==Ve&&De.push("Removed spaces"),Ve=Ke;const We=Ve.toUpperCase();We!==Ve&&De.push("Converted to uppercase"),Ve=We;const pt=Ve.replace(/[^A-Z0-9\/()]/g,"");pt!==Ve&&De.push("Removed punctuation excluding ( ) /"),Ve=pt;const kt=Ve;return Ve=Ve.replace(/(\d)\/(1\d|\d)/g,(at,Ct,Et,jt,Pt)=>{const Wt=Pt[jt-1]||"",ir=Pt[jt+at.length]||"";return Wt==="("&&ir===")"?at:`(${Ct}/${Et})`}),Ve!==kt&&De.push("Wrapped fractions with parentheses"),Ve.includes("/")&&(/^[A-Z]{3,}/.test(Ve)||/[A-Z]{3,}$/.test(Ve))&&et.push("Description text detected with fraction"),/\d\.|\.\d/.test(Ve)&&et.push("Decimal detected; consider fraction"),{cleaned:Ve,actions:De,warnings:et,original:Be}},Ee=s.map(He=>{const De=B(He.part_number);return(De.cleaned!==He.part_number||De.actions.length>0)&&F.push({part_number:He.part_number,cleaned_part_number:De.cleaned,actions:De.actions}),De.warnings.length>0&&te.push({part_number:He.part_number,warnings:De.warnings}),{...He,_clean:De.cleaned}}),Se={};Ee.forEach(He=>{Se[He._clean]||(Se[He._clean]=[]),Se[He._clean].push(He)});const $e=Object.entries(Se).filter(([,He])=>He.length>1).map(([,He])=>{const De=He.map(Be=>({part_number:Be.part_number,unit:Be.unit})),et=He[0].part_number,Ve=new Set(He.map(Be=>Be.unit)).size>1;return{proposedKeep:et,candidates:De,unitMismatch:Ve}});L({fixes:F,flags:te,duplicateGroups:$e}),ne(!0)}catch(F){console.error("Error during cleanup preview:",F),alert("Failed to analyze inventory for cleanup.")}finally{j(!1)}},oe=async()=>{if(!g)return;const F=(g.duplicateGroups||[]).map(te=>({keepPartNumber:te.proposedKeep,mergePartNumbers:te.candidates.map(B=>B.part_number).filter(B=>B!==te.proposedKeep)}));j(!0);try{const te=await Ku("stock",F);ne(!1),k(te),v(!0),await Z()}catch(te){console.error("Error applying cleanup:",te),alert("Failed to apply cleanup.")}finally{j(!1)}},D=()=>{v(!1),k(null)};return e.jsxs(Qe,{maxWidth:"xl",sx:{mt:4},children:[e.jsxs(q,{sx:{mb:4},children:[e.jsxs(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:"Stock"}),e.jsxs(tt,{direction:"row",spacing:2,children:[e.jsx(K,{variant:"contained",startIcon:e.jsx(vr,{}),onClick:X,children:"New Part"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(Qu,{}),onClick:ke,children:"Upload CSV"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(or,{}),onClick:me,children:"Download Template"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(or,{}),onClick:G,children:"Export CSV"}),e.jsx(K,{variant:"outlined",color:"warning",onClick:je,disabled:S,startIcon:S?e.jsx(it,{size:20}):e.jsx(tr,{}),children:S?"Cleaning...":"Clean"})]})]}),e.jsx("input",{type:"file",ref:U,onChange:Pe,accept:".csv",style:{display:"none"}}),p&&e.jsxs(qe,{sx:{p:2,mb:2},children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:"Uploading CSV file..."}),e.jsx(Xc,{variant:"determinate",value:w}),e.jsxs(f,{variant:"caption",color:"text.secondary",children:[w,"% complete"]})]}),e.jsx(qe,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(q,{sx:{p:2},children:[e.jsx(ie,{fullWidth:!0,variant:"outlined",placeholder:"Search stock...",value:t,onChange:F=>r(F.target.value),InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:e.jsx(yr,{})})},sx:{mb:2}}),e.jsx(Mr,{rows:J,columns:P,loading:n,paginationModel:ae,onPaginationModelChange:F=>ee(F),pageSizeOptions:[10,20,50],processRowUpdate:A,getRowId:F=>F.id,onRowClick:(F,te)=>{const B=te.target;B.closest('.MuiDataGrid-cell[data-field="part_number"]')||B.closest('.MuiDataGrid-cell[data-field="quantity_on_hand"]')||B.closest('.MuiDataGrid-cell[data-field="last_unit_cost"]')||B.closest('.MuiDataGrid-cell[data-field="reorder_point"]')||se(F)},sx:{cursor:"pointer","& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]}),e.jsxs(lt,{open:z,onClose:()=>ne(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ct,{children:"Clean and Enforce Rules (Preview)"}),e.jsx(ut,{children:g?e.jsxs(q,{children:[e.jsx(f,{variant:"h6",children:"Fixes"}),e.jsx(wr,{dense:!0,children:(g.fixes||[]).slice(0,200).map((F,te)=>e.jsx(Sr,{button:!0,onClick:()=>{const B=s.find(Ee=>Ee.part_number===F.part_number);B&&(d({part_id:B.part_id,part_number:B.part_number,part_description:B.part_description||"",unit:B.unit||"Each",last_unit_cost:B.last_unit_cost||"",quantity_on_hand:B.quantity_on_hand||"",reorder_point:B.reorder_point||"",part_type:B.part_type||"stock",category:B.category||"Uncategorized"}),c(!0))},children:e.jsx(Cr,{primary:`${F.part_number} -> ${F.cleaned_part_number}`,secondary:(F.actions||[]).join(", ")})},te))}),g.flags&&g.flags.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(f,{variant:"h6",sx:{mt:2},children:"Flags"}),e.jsx(wr,{dense:!0,children:(g.flags||[]).map((F,te)=>e.jsx(Sr,{button:!0,onClick:()=>{const B=s.find(Ee=>Ee.part_number===F.part_number);B&&(d({part_id:B.part_id,part_number:B.part_number,part_description:B.part_description||"",unit:B.unit||"Each",last_unit_cost:B.last_unit_cost||"",quantity_on_hand:B.quantity_on_hand||"",reorder_point:B.reorder_point||"",part_type:B.part_type||"stock",category:B.category||"Uncategorized"}),c(!0))},children:e.jsx(Cr,{primary:`${F.part_number}`,secondary:(F.warnings||[]).join(", ")})},te))})]}),e.jsx(f,{variant:"h6",sx:{mt:2},children:"Potential Duplicates"}),e.jsx(wr,{dense:!0,children:(g.duplicateGroups||[]).map((F,te)=>e.jsx(Sr,{children:e.jsx(Cr,{primary:`Keep ${F.proposedKeep} → merge ${F.candidates.map(B=>B.part_number).filter(B=>B!==F.proposedKeep).join(", ")||"none"}`,secondary:F.unitMismatch?"Unit mismatch detected - will not merge differing units":void 0})},te))})]}):e.jsx(f,{children:"Loading preview..."})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>ne(!1),children:"Cancel"}),e.jsx(K,{onClick:oe,variant:"contained",disabled:S,children:"Apply"})]})]}),e.jsx(kn,{open:i,onClose:fe,onSave:Y,initialPart:u||void 0,isEditMode:!!u,title:u?"Edit Inventory Part":"Add New Inventory Part"}),e.jsxs(lt,{open:b,onClose:be,maxWidth:"md",fullWidth:!0,children:[e.jsx(ct,{children:_?.error?"Upload Failed":"Upload Completed"}),e.jsx(ut,{children:_&&e.jsxs(q,{children:[_.error?e.jsx(Re,{severity:"error",sx:{mb:2},children:_.error}):e.jsx(Re,{severity:"success",sx:{mb:2},children:_.message}),_.summary&&e.jsxs(q,{sx:{mb:3},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Summary"}),e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:6,sm:2,children:e.jsx(Le,{label:`Total: ${_.summary.totalProcessed}`,color:"primary"})}),e.jsx(T,{item:!0,xs:6,sm:2,children:e.jsx(Le,{label:`New: ${_.summary.newItems}`,color:"success"})}),e.jsx(T,{item:!0,xs:6,sm:2,children:e.jsx(Le,{label:`Updated: ${_.summary.updatedItems}`,color:"info"})}),e.jsx(T,{item:!0,xs:6,sm:2,children:e.jsx(Le,{label:`Vendor Mappings: ${_.summary.vendorMappings||0}`,color:"secondary"})}),e.jsx(T,{item:!0,xs:6,sm:2,children:e.jsx(Le,{label:`Errors: ${_.summary.errors}`,color:"error"})}),e.jsx(T,{item:!0,xs:6,sm:2,children:e.jsx(Le,{label:`Warnings: ${_.summary.warnings}`,color:"warning"})})]})]}),_.errors&&_.errors.length>0&&e.jsxs(q,{sx:{mb:3},children:[e.jsxs(f,{variant:"h6",color:"error",gutterBottom:!0,children:["Errors (",_.errors.length,")"]}),e.jsx(wr,{dense:!0,children:_.errors.map((F,te)=>e.jsx(Sr,{children:e.jsx(Cr,{primary:F})},te))})]}),_.warnings&&_.warnings.length>0&&e.jsxs(q,{sx:{mb:3},children:[e.jsxs(f,{variant:"h6",color:"warning.main",gutterBottom:!0,children:["Warnings (",_.warnings.length,")"]}),e.jsx(wr,{dense:!0,children:_.warnings.map((F,te)=>e.jsx(Sr,{children:e.jsx(Cr,{primary:F})},te))})]})]})}),e.jsx(dt,{children:e.jsx(K,{onClick:be,variant:"contained",children:"Close"})})]}),e.jsxs(lt,{open:M,onClose:D,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ct,{children:N?.error?"Cleanup Failed":"Cleanup Completed"}),e.jsx(ut,{children:N&&e.jsxs(q,{children:[N.error?e.jsxs(Re,{severity:"error",sx:{mb:2},children:[N.message,N.details&&e.jsxs(f,{variant:"body2",sx:{mt:1},children:["Details: ",N.details]})]}):e.jsx(Re,{severity:"success",sx:{mb:2},children:N.message}),N.summary&&e.jsxs(q,{sx:{mb:3},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Summary"}),e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:6,sm:4,children:e.jsx(Le,{label:`Total: ${N.summary.totalProcessed}`,color:"primary"})}),e.jsx(T,{item:!0,xs:6,sm:4,children:e.jsx(Le,{label:`Updated: ${N.summary.itemsUpdated}`,color:"success"})}),e.jsx(T,{item:!0,xs:6,sm:4,children:e.jsx(Le,{label:`Errors: ${N.summary.errors}`,color:"error"})})]})]})]})}),e.jsx(dt,{children:e.jsx(K,{onClick:D,variant:"contained",children:"Close"})})]})]})},Yg=()=>{const[t,r]=l.useState(""),[s,a]=l.useState([]),[n,o]=l.useState(!1),[i,c]=l.useState(!1),[u,d]=l.useState(null),[p,y]=l.useState(!1),[w,O]=l.useState(0),[_,E]=l.useState(null),[b,I]=l.useState(!1),U=l.useRef(null),[S,j]=l.useState({page:0,pageSize:10}),[N,k]=l.useState(!1),[M,v]=l.useState(null),[g,L]=l.useState(!1),[z,ne]=l.useState(null),[ae,ee]=l.useState(!1),W=async()=>{o(!0);try{const D=(await Ig()).map((F,te)=>({...F,id:F.part_number||te}));a(D)}catch(oe){console.error("Error fetching supply inventory:",oe)}finally{o(!1)}};l.useEffect(()=>{W();const oe=()=>W();return window.addEventListener("supply-updated",oe),()=>window.removeEventListener("supply-updated",oe)},[]);const Z=s.filter(oe=>oe.part_number?.toUpperCase().includes(t.toUpperCase())||oe.part_description?.toLowerCase().includes(t.toLowerCase())),J=[{field:"part_number",headerName:"Part #",flex:1,headerAlign:"left",editable:!0},{field:"part_description",headerName:"Part Description",flex:2,headerAlign:"left"},{field:"category",headerName:"Category",flex:1,headerAlign:"left"},{field:"unit",headerName:"UOM",flex:.5,headerAlign:"left"},{field:"last_unit_cost",headerName:"Last Unit Cost",flex:1,type:"number",editable:!0,align:"center",headerAlign:"left"},{field:"reorder_point",headerName:"Reorder Point",flex:.75,type:"number",editable:!0,align:"center",headerAlign:"left"},{field:"part_type",headerName:"Type",flex:.5,headerAlign:"left"},{field:"value",headerName:"Value",flex:1,type:"number",valueGetter:oe=>{const D=oe.row.quantity_on_hand==="NA"?0:Number(oe.row.quantity_on_hand)||0,F=Number(oe.row.last_unit_cost)||0;return D*F},valueFormatter:oe=>`$${(Number(oe.value)||0).toFixed(2)}`,headerAlign:"center",align:"center"},{field:"actions",headerName:"Actions",width:100,headerAlign:"left",sortable:!1,renderCell:oe=>e.jsx(ot,{size:"small",color:"error",onClick:D=>{D.stopPropagation(),P(oe.row.part_number)},children:e.jsx(tr,{fontSize:"medium",sx:{fontSize:28}})})}],P=async oe=>{if(window.confirm(`Are you sure you want to delete part ${oe}?`))try{console.log(`Deleting part: ${oe}`);const D=await $.delete(`/api/inventory/${encodeURIComponent(oe)}`);console.log(`Part ${oe} deleted successfully:`,D.data),alert(`Part ${oe} deleted successfully!`),W()}catch(D){console.error(`Error deleting part ${oe}:`,D),alert(`Error deleting part ${oe}. Please check the console.`)}},m=async(oe,D)=>{console.log("Attempting to update row:",oe);const F={};if(oe.part_number!==D.part_number){const B=String(oe.part_number).trim().toUpperCase();if(!B)return alert("Part number cannot be empty."),Promise.reject("Invalid part number");F.part_number=B}if(oe.reorder_point!==D.reorder_point){const B=parseFloat(String(oe.reorder_point));if(isNaN(B))return alert("Invalid reorder point value. Please enter a valid number."),Promise.reject("Invalid reorder point");F.reorder_point=B}if(oe.last_unit_cost!==D.last_unit_cost){const B=parseFloat(String(oe.last_unit_cost));if(isNaN(B))return alert("Invalid last unit cost value. Please enter a valid number."),Promise.reject("Invalid last unit cost");F.last_unit_cost=B}if(oe.category!==D.category&&(F.category=oe.category),Object.keys(F).length===0)return console.log("No fields changed."),oe;const te=F.part_number?D.part_number:oe.part_number;try{const B=await $.put(`/api/inventory/${encodeURIComponent(te)}`,F);return console.log(`Supply inventory updated for part ${te}:`,B.data),alert(`Part ${te} updated successfully!`),await W(),B.data.updatedItem||oe}catch(B){return console.error(`Error updating supply inventory for part ${te}:`,B),B instanceof nr&&B.response&&B.response.data&&B.response.data.error?alert(`Error updating inventory: ${B.response.data.error}`):alert(`Error updating inventory for part ${te}. Please check the console.`),Promise.reject(B)}},A=()=>{const oe=Z.map(B=>({...B,value:(B.quantity_on_hand==="NA"?0:Number(B.quantity_on_hand)||0)*(Number(B.last_unit_cost)||0)})),D=un.unparse(oe),F=new Blob([D],{type:"text/csv;charset=utf-8;"}),te=document.createElement("a");if(te.download!==void 0){const B=URL.createObjectURL(F);te.setAttribute("href",B),te.setAttribute("download","supply_list.csv"),te.style.visibility="hidden",document.body.appendChild(te),te.click()}},G=()=>{d({part_number:"",part_description:"",unit:"",last_unit_cost:"",quantity_on_hand:"NA",reorder_point:"",part_type:"supply",category:"Uncategorized"}),c(!0)},X=async()=>{k(!0);try{const oe=await Mg("supply");v(oe?.preview||oe),L(!0)}catch(oe){console.error("Error during cleanup preview:",oe),alert("Failed to analyze supply for cleanup.")}finally{k(!1)}},Y=async()=>{if(!M)return;const oe=(M.duplicateGroups||[]).map(D=>({keepPartNumber:D.proposedKeep,mergePartNumbers:D.candidates.map(F=>F.part_number).filter(F=>F!==D.proposedKeep)}));k(!0);try{const D=await Ku("supply",oe);L(!1),ne(D),ee(!0),await W()}catch(D){console.error("Error applying cleanup:",D),alert("Failed to apply cleanup.")}finally{k(!1)}},fe=async oe=>{const D={...oe,part_number:oe.part_number.trim().toUpperCase(),part_description:oe.part_description.trim(),unit:oe.unit.trim(),part_type:oe.part_type.trim()};try{if(u){const{part_number:F,...te}=D;await $.put(`/api/inventory/${encodeURIComponent(F)}`,te)}else await $.post("/api/inventory",D);W()}catch(F){throw F}},se=()=>{c(!1),d(null)},ke=oe=>{d({part_id:oe.row.part_id,part_number:oe.row.part_number,part_description:oe.row.part_description||"",unit:oe.row.unit||"Each",last_unit_cost:oe.row.last_unit_cost||"",quantity_on_hand:oe.row.quantity_on_hand||"",reorder_point:oe.row.reorder_point||"",part_type:oe.row.part_type||"supply",category:oe.row.category||"Uncategorized"}),c(!0)},Pe=()=>{U.current?.click()},ge=async oe=>{const D=oe.target.files?.[0];if(D){if(!D.name.endsWith(".csv")&&D.type!=="text/csv"){alert("Please select a valid CSV file");return}if(D.size>5*1024*1024){alert("File size must be less than 5MB");return}await me(D)}},me=async oe=>{y(!0),O(0),E(null);const D=new FormData;D.append("csvFile",oe);try{const F=setInterval(()=>{O(B=>B>=90?(clearInterval(F),90):B+10)},200),te=await $.post("/api/inventory/upload-csv",D,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:B=>{if(B.total){const Ee=Math.round(B.loaded*90/B.total);O(Ee)}}});clearInterval(F),O(100),E(te.data),I(!0),setTimeout(()=>{W()},1e3)}catch(F){console.error("Error uploading CSV:",F),F instanceof nr&&F.response?.data?E({error:"Upload failed",errors:F.response.data.errors||[F.response.data.error||"Unknown error"],warnings:F.response.data.warnings||[]}):E({error:"Upload failed",errors:["An unexpected error occurred during upload"]}),I(!0)}finally{y(!1),O(0),U.current&&(U.current.value="")}},be=async()=>{try{const oe=await $.get("/api/inventory/csv-template",{responseType:"blob"}),D=window.URL.createObjectURL(new Blob([oe.data])),F=document.createElement("a");F.href=D,F.setAttribute("download","supply_template.csv"),document.body.appendChild(F),F.click(),F.remove(),window.URL.revokeObjectURL(D)}catch(oe){console.error("Error downloading template:",oe),alert("Error downloading template")}},je=()=>{I(!1),E(null)};return e.jsxs(Qe,{maxWidth:"xl",sx:{mt:4},children:[e.jsxs(q,{sx:{mb:4},children:[e.jsxs(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:"Supply List"}),e.jsxs(tt,{direction:"row",spacing:2,children:[e.jsx(K,{variant:"contained",startIcon:e.jsx(vr,{}),onClick:G,children:"New Part"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(Qu,{}),onClick:Pe,children:"Upload CSV"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(or,{}),onClick:be,children:"Download Template"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(or,{}),onClick:A,children:"Export CSV"}),e.jsx(K,{variant:"outlined",color:"warning",onClick:X,disabled:N,startIcon:e.jsx(tr,{}),children:N?"Cleaning...":"Clean"})]})]}),e.jsx("input",{type:"file",ref:U,onChange:ge,accept:".csv",style:{display:"none"}}),p&&e.jsxs(qe,{sx:{p:2,mb:2},children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:"Uploading CSV file..."}),e.jsx(Xc,{variant:"determinate",value:w}),e.jsxs(f,{variant:"caption",color:"text.secondary",children:[w,"% complete"]})]}),e.jsx(qe,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(q,{sx:{p:2},children:[e.jsx(ie,{fullWidth:!0,variant:"outlined",placeholder:"Search supply...",value:t,onChange:oe=>r(oe.target.value),InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:e.jsx(yr,{})})},sx:{mb:2}}),e.jsx(Mr,{rows:Z,columns:J,loading:n,paginationModel:S,onPaginationModelChange:oe=>j(oe),pageSizeOptions:[10,20,50],processRowUpdate:m,getRowId:oe=>oe.id,onRowClick:(oe,D)=>{const F=D.target;F.closest('.MuiDataGrid-cell[data-field="part_number"]')||F.closest('.MuiDataGrid-cell[data-field="last_unit_cost"]')||F.closest('.MuiDataGrid-cell[data-field="reorder_point"]')||ke(oe)},sx:{cursor:"pointer","& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]}),e.jsx(kn,{open:i,onClose:se,onSave:fe,initialPart:u||void 0,isEditMode:!!u,title:u?"Edit Supply Part":"Add New Supply Part"}),e.jsxs(lt,{open:b,onClose:je,maxWidth:"md",fullWidth:!0,children:[e.jsx(ct,{children:_?.error?"Upload Failed":"Upload Completed"}),e.jsx(ut,{children:_&&e.jsxs(q,{children:[_.error?e.jsx(Re,{severity:"error",sx:{mb:2},children:_.error}):e.jsx(Re,{severity:"success",sx:{mb:2},children:_.message}),_.summary&&e.jsxs(q,{sx:{mb:3},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Summary"}),e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:6,sm:2,children:e.jsx(Le,{label:`Total: ${_.summary.totalProcessed}`,color:"primary"})}),e.jsx(T,{item:!0,xs:6,sm:2,children:e.jsx(Le,{label:`New: ${_.summary.newItems}`,color:"success"})}),e.jsx(T,{item:!0,xs:6,sm:2,children:e.jsx(Le,{label:`Updated: ${_.summary.updatedItems}`,color:"info"})}),e.jsx(T,{item:!0,xs:6,sm:2,children:e.jsx(Le,{label:`Vendor Mappings: ${_.summary.vendorMappings||0}`,color:"secondary"})}),e.jsx(T,{item:!0,xs:6,sm:2,children:e.jsx(Le,{label:`Errors: ${_.summary.errors}`,color:"error"})}),e.jsx(T,{item:!0,xs:6,sm:2,children:e.jsx(Le,{label:`Warnings: ${_.summary.warnings}`,color:"warning"})})]})]}),_.errors&&_.errors.length>0&&e.jsxs(q,{sx:{mb:3},children:[e.jsxs(f,{variant:"h6",color:"error",gutterBottom:!0,children:["Errors (",_.errors.length,")"]}),e.jsx(wr,{dense:!0,children:_.errors.map((oe,D)=>e.jsx(Sr,{children:e.jsx(Cr,{primary:oe})},D))})]}),_.warnings&&_.warnings.length>0&&e.jsxs(q,{sx:{mb:3},children:[e.jsxs(f,{variant:"h6",color:"warning.main",gutterBottom:!0,children:["Warnings (",_.warnings.length,")"]}),e.jsx(wr,{dense:!0,children:_.warnings.map((oe,D)=>e.jsx(Sr,{children:e.jsx(Cr,{primary:oe})},D))})]})]})}),e.jsx(dt,{children:e.jsx(K,{onClick:je,variant:"contained",children:"Close"})})]}),e.jsxs(lt,{open:g,onClose:()=>L(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ct,{children:"Clean and Enforce Rules (Preview)"}),e.jsx(ut,{children:M?e.jsxs(q,{children:[e.jsx(f,{variant:"h6",children:"Fixes"}),e.jsx(wr,{dense:!0,children:(M.fixes||[]).slice(0,200).map((oe,D)=>e.jsx(Sr,{children:e.jsx(Cr,{primary:`${oe.part_number} -> ${oe.cleaned_part_number}`,secondary:(oe.actions||[]).join(", ")})},D))}),e.jsx(f,{variant:"h6",sx:{mt:2},children:"Potential Duplicates"}),e.jsx(wr,{dense:!0,children:(M.duplicateGroups||[]).map((oe,D)=>e.jsx(Sr,{children:e.jsx(Cr,{primary:`Keep ${oe.proposedKeep} → merge ${oe.candidates.map(F=>F.part_number).filter(F=>F!==oe.proposedKeep).join(", ")||"none"}`,secondary:oe.unitMismatch?"Unit mismatch detected - will not merge differing units":void 0})},D))})]}):e.jsx(f,{children:"Loading preview..."})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>L(!1),children:"Cancel"}),e.jsx(K,{onClick:Y,variant:"contained",disabled:N,children:"Apply"})]})]}),e.jsxs(lt,{open:ae,onClose:()=>ee(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ct,{children:"Cleanup Completed"}),e.jsx(ut,{children:z?e.jsxs(q,{children:[e.jsx(Re,{severity:"success",sx:{mb:2},children:"Cleanup applied successfully."}),e.jsxs(f,{variant:"body2",children:["Fixes applied: ",z?.applied?.fixesApplied||0]}),e.jsxs(f,{variant:"body2",children:["Fixes skipped: ",z?.applied?.fixesSkipped||0]}),e.jsxs(f,{variant:"body2",children:["Merged groups: ",z?.applied?.mergedGroups||0]}),e.jsxs(f,{variant:"body2",children:["Merged items: ",z?.applied?.mergedItems||0]})]}):e.jsx(f,{children:"Loading..."})}),e.jsx(dt,{children:e.jsx(K,{onClick:()=>ee(!1),variant:"contained",children:"Close"})})]})]})};function yt(t){if(t===null||t===!0||t===!1)return NaN;var r=Number(t);return isNaN(r)?r:r<0?Math.ceil(r):Math.floor(r)}function Ae(t,r){if(r.length<t)throw new TypeError(t+" argument"+(t>1?"s":"")+" required, but only "+r.length+" present")}function Me(t){Ae(1,arguments);var r=Object.prototype.toString.call(t);return t instanceof Date||so(t)==="object"&&r==="[object Date]"?new Date(t.getTime()):typeof t=="number"||r==="[object Number]"?new Date(t):((typeof t=="string"||r==="[object String]")&&typeof console<"u"&&(console.warn("Starting with v2.0.0-beta.1 date-fns doesn't accept strings as date arguments. Please use `parseISO` to parse strings. See: https://github.com/date-fns/date-fns/blob/master/docs/upgradeGuide.md#string-arguments"),console.warn(new Error().stack)),new Date(NaN))}function Ua(t,r){Ae(2,arguments);var s=Me(t),a=yt(r);return isNaN(a)?new Date(NaN):(a&&s.setDate(s.getDate()+a),s)}function Wa(t,r){Ae(2,arguments);var s=Me(t),a=yt(r);if(isNaN(a))return new Date(NaN);if(!a)return s;var n=s.getDate(),o=new Date(s.getTime());o.setMonth(s.getMonth()+a+1,0);var i=o.getDate();return n>=i?o:(s.setFullYear(o.getFullYear(),o.getMonth(),n),s)}function _o(t,r){Ae(2,arguments);var s=Me(t).getTime(),a=yt(r);return new Date(s+a)}var Vg=36e5;function Gg(t,r){Ae(2,arguments);var s=yt(r);return _o(t,s*Vg)}var Qg={};function Nr(){return Qg}function wn(t,r){var s,a,n,o,i,c,u,d;Ae(1,arguments);var p=Nr(),y=yt((s=(a=(n=(o=r?.weekStartsOn)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.weekStartsOn)!==null&&n!==void 0?n:p.weekStartsOn)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.weekStartsOn)!==null&&s!==void 0?s:0);if(!(y>=0&&y<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var w=Me(t),O=w.getDay(),_=(O<y?7:0)+O-y;return w.setDate(w.getDate()-_),w.setHours(0,0,0,0),w}function Ka(t){var r=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()));return r.setUTCFullYear(t.getFullYear()),t.getTime()-r.getTime()}function Qn(t){Ae(1,arguments);var r=Me(t);return r.setHours(0,0,0,0),r}var Jg=864e5;function Kg(t,r){Ae(2,arguments);var s=Qn(t),a=Qn(r),n=s.getTime()-Ka(s),o=a.getTime()-Ka(a);return Math.round((n-o)/Jg)}var Xg=6e4;function Zg(t,r){Ae(2,arguments);var s=yt(r);return _o(t,s*Xg)}function ex(t,r){Ae(2,arguments);var s=yt(r);return _o(t,s*1e3)}function tx(t,r){Ae(2,arguments);var s=yt(r),a=s*7;return Ua(t,a)}function sc(t,r){Ae(2,arguments);var s=yt(r);return Wa(t,s*12)}function Gs(t,r){Ae(2,arguments);var s=Me(t),a=Me(r),n=s.getTime()-a.getTime();return n<0?-1:n>0?1:n}var bo=6e4,jo=36e5,rx=1e3;function nx(t,r){Ae(2,arguments);var s=Qn(t),a=Qn(r);return s.getTime()===a.getTime()}function sx(t){return Ae(1,arguments),t instanceof Date||so(t)==="object"&&Object.prototype.toString.call(t)==="[object Date]"}function Xu(t){if(Ae(1,arguments),!sx(t)&&typeof t!="number")return!1;var r=Me(t);return!isNaN(Number(r))}function ax(t,r){Ae(2,arguments);var s=Me(t),a=Me(r),n=s.getFullYear()-a.getFullYear(),o=s.getMonth()-a.getMonth();return n*12+o}function ox(t,r){Ae(2,arguments);var s=Me(t),a=Me(r);return s.getFullYear()-a.getFullYear()}function ac(t,r){var s=t.getFullYear()-r.getFullYear()||t.getMonth()-r.getMonth()||t.getDate()-r.getDate()||t.getHours()-r.getHours()||t.getMinutes()-r.getMinutes()||t.getSeconds()-r.getSeconds()||t.getMilliseconds()-r.getMilliseconds();return s<0?-1:s>0?1:s}function Zu(t,r){Ae(2,arguments);var s=Me(t),a=Me(r),n=ac(s,a),o=Math.abs(Kg(s,a));s.setDate(s.getDate()-n*o);var i=+(ac(s,a)===-n),c=n*(o-i);return c===0?0:c}function wo(t,r){return Ae(2,arguments),Me(t).getTime()-Me(r).getTime()}var oc={ceil:Math.ceil,round:Math.round,floor:Math.floor,trunc:function(r){return r<0?Math.ceil(r):Math.floor(r)}},ix="trunc";function aa(t){return t?oc[t]:oc[ix]}function lx(t,r,s){Ae(2,arguments);var a=wo(t,r)/jo;return aa(void 0)(a)}function cx(t,r,s){Ae(2,arguments);var a=wo(t,r)/bo;return aa(void 0)(a)}function bi(t){Ae(1,arguments);var r=Me(t);return r.setHours(23,59,59,999),r}function ji(t){Ae(1,arguments);var r=Me(t),s=r.getMonth();return r.setFullYear(r.getFullYear(),s+1,0),r.setHours(23,59,59,999),r}function ux(t){Ae(1,arguments);var r=Me(t);return bi(r).getTime()===ji(r).getTime()}function ed(t,r){Ae(2,arguments);var s=Me(t),a=Me(r),n=Gs(s,a),o=Math.abs(ax(s,a)),i;if(o<1)i=0;else{s.getMonth()===1&&s.getDate()>27&&s.setDate(30),s.setMonth(s.getMonth()-n*o);var c=Gs(s,a)===-n;ux(Me(t))&&o===1&&Gs(t,a)===1&&(c=!1),i=n*(o-Number(c))}return i===0?0:i}function dx(t,r,s){Ae(2,arguments);var a=ed(t,r)/3;return aa(void 0)(a)}function px(t,r,s){Ae(2,arguments);var a=wo(t,r)/1e3;return aa(void 0)(a)}function hx(t,r,s){Ae(2,arguments);var a=Zu(t,r)/7;return aa(void 0)(a)}function mx(t,r){Ae(2,arguments);var s=Me(t),a=Me(r),n=Gs(s,a),o=Math.abs(ox(s,a));s.setFullYear(1584),a.setFullYear(1584);var i=Gs(s,a)===-n,c=n*(o-Number(i));return c===0?0:c}function fx(t,r){var s;Ae(1,arguments);var a=t||{},n=Me(a.start),o=Me(a.end),i=o.getTime();if(!(n.getTime()<=i))throw new RangeError("Invalid interval");var c=[],u=n;u.setHours(0,0,0,0);var d=Number((s=void 0)!==null&&s!==void 0?s:1);if(d<1||isNaN(d))throw new RangeError("`options.step` must be a number greater than 1");for(;u.getTime()<=i;)c.push(Me(u)),u.setDate(u.getDate()+d),u.setHours(0,0,0,0);return c}function ic(t){Ae(1,arguments);var r=Me(t);return r.setDate(1),r.setHours(0,0,0,0),r}function Ko(t){Ae(1,arguments);var r=Me(t),s=r.getFullYear();return r.setFullYear(s+1,0,0),r.setHours(23,59,59,999),r}function ja(t){Ae(1,arguments);var r=Me(t),s=new Date(0);return s.setFullYear(r.getFullYear(),0,1),s.setHours(0,0,0,0),s}function Xo(t,r){var s,a,n,o,i,c,u,d;Ae(1,arguments);var p=Nr(),y=yt((s=(a=(n=(o=r?.weekStartsOn)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.weekStartsOn)!==null&&n!==void 0?n:p.weekStartsOn)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.weekStartsOn)!==null&&s!==void 0?s:0);if(!(y>=0&&y<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var w=Me(t),O=w.getDay(),_=(O<y?-7:0)+6-(O-y);return w.setDate(w.getDate()+_),w.setHours(23,59,59,999),w}function td(t,r){Ae(2,arguments);var s=yt(r);return _o(t,-s)}var gx=864e5;function xx(t){Ae(1,arguments);var r=Me(t),s=r.getTime();r.setUTCMonth(0,1),r.setUTCHours(0,0,0,0);var a=r.getTime(),n=s-a;return Math.floor(n/gx)+1}function Jn(t){Ae(1,arguments);var r=1,s=Me(t),a=s.getUTCDay(),n=(a<r?7:0)+a-r;return s.setUTCDate(s.getUTCDate()-n),s.setUTCHours(0,0,0,0),s}function rd(t){Ae(1,arguments);var r=Me(t),s=r.getUTCFullYear(),a=new Date(0);a.setUTCFullYear(s+1,0,4),a.setUTCHours(0,0,0,0);var n=Jn(a),o=new Date(0);o.setUTCFullYear(s,0,4),o.setUTCHours(0,0,0,0);var i=Jn(o);return r.getTime()>=n.getTime()?s+1:r.getTime()>=i.getTime()?s:s-1}function yx(t){Ae(1,arguments);var r=rd(t),s=new Date(0);s.setUTCFullYear(r,0,4),s.setUTCHours(0,0,0,0);var a=Jn(s);return a}var vx=6048e5;function nd(t){Ae(1,arguments);var r=Me(t),s=Jn(r).getTime()-yx(r).getTime();return Math.round(s/vx)+1}function Pn(t,r){var s,a,n,o,i,c,u,d;Ae(1,arguments);var p=Nr(),y=yt((s=(a=(n=(o=r?.weekStartsOn)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.weekStartsOn)!==null&&n!==void 0?n:p.weekStartsOn)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.weekStartsOn)!==null&&s!==void 0?s:0);if(!(y>=0&&y<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var w=Me(t),O=w.getUTCDay(),_=(O<y?7:0)+O-y;return w.setUTCDate(w.getUTCDate()-_),w.setUTCHours(0,0,0,0),w}function Wi(t,r){var s,a,n,o,i,c,u,d;Ae(1,arguments);var p=Me(t),y=p.getUTCFullYear(),w=Nr(),O=yt((s=(a=(n=(o=r?.firstWeekContainsDate)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.firstWeekContainsDate)!==null&&n!==void 0?n:w.firstWeekContainsDate)!==null&&a!==void 0?a:(u=w.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.firstWeekContainsDate)!==null&&s!==void 0?s:1);if(!(O>=1&&O<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var _=new Date(0);_.setUTCFullYear(y+1,0,O),_.setUTCHours(0,0,0,0);var E=Pn(_,r),b=new Date(0);b.setUTCFullYear(y,0,O),b.setUTCHours(0,0,0,0);var I=Pn(b,r);return p.getTime()>=E.getTime()?y+1:p.getTime()>=I.getTime()?y:y-1}function _x(t,r){var s,a,n,o,i,c,u,d;Ae(1,arguments);var p=Nr(),y=yt((s=(a=(n=(o=r?.firstWeekContainsDate)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.firstWeekContainsDate)!==null&&n!==void 0?n:p.firstWeekContainsDate)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.firstWeekContainsDate)!==null&&s!==void 0?s:1),w=Wi(t,r),O=new Date(0);O.setUTCFullYear(w,0,y),O.setUTCHours(0,0,0,0);var _=Pn(O,r);return _}var bx=6048e5;function sd(t,r){Ae(1,arguments);var s=Me(t),a=Pn(s,r).getTime()-_x(s,r).getTime();return Math.round(a/bx)+1}function ht(t,r){for(var s=t<0?"-":"",a=Math.abs(t).toString();a.length<r;)a="0"+a;return s+a}var Zr={y:function(r,s){var a=r.getUTCFullYear(),n=a>0?a:1-a;return ht(s==="yy"?n%100:n,s.length)},M:function(r,s){var a=r.getUTCMonth();return s==="M"?String(a+1):ht(a+1,2)},d:function(r,s){return ht(r.getUTCDate(),s.length)},a:function(r,s){var a=r.getUTCHours()/12>=1?"pm":"am";switch(s){case"a":case"aa":return a.toUpperCase();case"aaa":return a;case"aaaaa":return a[0];case"aaaa":default:return a==="am"?"a.m.":"p.m."}},h:function(r,s){return ht(r.getUTCHours()%12||12,s.length)},H:function(r,s){return ht(r.getUTCHours(),s.length)},m:function(r,s){return ht(r.getUTCMinutes(),s.length)},s:function(r,s){return ht(r.getUTCSeconds(),s.length)},S:function(r,s){var a=s.length,n=r.getUTCMilliseconds(),o=Math.floor(n*Math.pow(10,a-3));return ht(o,s.length)}},qn={midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},jx={G:function(r,s,a){var n=r.getUTCFullYear()>0?1:0;switch(s){case"G":case"GG":case"GGG":return a.era(n,{width:"abbreviated"});case"GGGGG":return a.era(n,{width:"narrow"});case"GGGG":default:return a.era(n,{width:"wide"})}},y:function(r,s,a){if(s==="yo"){var n=r.getUTCFullYear(),o=n>0?n:1-n;return a.ordinalNumber(o,{unit:"year"})}return Zr.y(r,s)},Y:function(r,s,a,n){var o=Wi(r,n),i=o>0?o:1-o;if(s==="YY"){var c=i%100;return ht(c,2)}return s==="Yo"?a.ordinalNumber(i,{unit:"year"}):ht(i,s.length)},R:function(r,s){var a=rd(r);return ht(a,s.length)},u:function(r,s){var a=r.getUTCFullYear();return ht(a,s.length)},Q:function(r,s,a){var n=Math.ceil((r.getUTCMonth()+1)/3);switch(s){case"Q":return String(n);case"QQ":return ht(n,2);case"Qo":return a.ordinalNumber(n,{unit:"quarter"});case"QQQ":return a.quarter(n,{width:"abbreviated",context:"formatting"});case"QQQQQ":return a.quarter(n,{width:"narrow",context:"formatting"});case"QQQQ":default:return a.quarter(n,{width:"wide",context:"formatting"})}},q:function(r,s,a){var n=Math.ceil((r.getUTCMonth()+1)/3);switch(s){case"q":return String(n);case"qq":return ht(n,2);case"qo":return a.ordinalNumber(n,{unit:"quarter"});case"qqq":return a.quarter(n,{width:"abbreviated",context:"standalone"});case"qqqqq":return a.quarter(n,{width:"narrow",context:"standalone"});case"qqqq":default:return a.quarter(n,{width:"wide",context:"standalone"})}},M:function(r,s,a){var n=r.getUTCMonth();switch(s){case"M":case"MM":return Zr.M(r,s);case"Mo":return a.ordinalNumber(n+1,{unit:"month"});case"MMM":return a.month(n,{width:"abbreviated",context:"formatting"});case"MMMMM":return a.month(n,{width:"narrow",context:"formatting"});case"MMMM":default:return a.month(n,{width:"wide",context:"formatting"})}},L:function(r,s,a){var n=r.getUTCMonth();switch(s){case"L":return String(n+1);case"LL":return ht(n+1,2);case"Lo":return a.ordinalNumber(n+1,{unit:"month"});case"LLL":return a.month(n,{width:"abbreviated",context:"standalone"});case"LLLLL":return a.month(n,{width:"narrow",context:"standalone"});case"LLLL":default:return a.month(n,{width:"wide",context:"standalone"})}},w:function(r,s,a,n){var o=sd(r,n);return s==="wo"?a.ordinalNumber(o,{unit:"week"}):ht(o,s.length)},I:function(r,s,a){var n=nd(r);return s==="Io"?a.ordinalNumber(n,{unit:"week"}):ht(n,s.length)},d:function(r,s,a){return s==="do"?a.ordinalNumber(r.getUTCDate(),{unit:"date"}):Zr.d(r,s)},D:function(r,s,a){var n=xx(r);return s==="Do"?a.ordinalNumber(n,{unit:"dayOfYear"}):ht(n,s.length)},E:function(r,s,a){var n=r.getUTCDay();switch(s){case"E":case"EE":case"EEE":return a.day(n,{width:"abbreviated",context:"formatting"});case"EEEEE":return a.day(n,{width:"narrow",context:"formatting"});case"EEEEEE":return a.day(n,{width:"short",context:"formatting"});case"EEEE":default:return a.day(n,{width:"wide",context:"formatting"})}},e:function(r,s,a,n){var o=r.getUTCDay(),i=(o-n.weekStartsOn+8)%7||7;switch(s){case"e":return String(i);case"ee":return ht(i,2);case"eo":return a.ordinalNumber(i,{unit:"day"});case"eee":return a.day(o,{width:"abbreviated",context:"formatting"});case"eeeee":return a.day(o,{width:"narrow",context:"formatting"});case"eeeeee":return a.day(o,{width:"short",context:"formatting"});case"eeee":default:return a.day(o,{width:"wide",context:"formatting"})}},c:function(r,s,a,n){var o=r.getUTCDay(),i=(o-n.weekStartsOn+8)%7||7;switch(s){case"c":return String(i);case"cc":return ht(i,s.length);case"co":return a.ordinalNumber(i,{unit:"day"});case"ccc":return a.day(o,{width:"abbreviated",context:"standalone"});case"ccccc":return a.day(o,{width:"narrow",context:"standalone"});case"cccccc":return a.day(o,{width:"short",context:"standalone"});case"cccc":default:return a.day(o,{width:"wide",context:"standalone"})}},i:function(r,s,a){var n=r.getUTCDay(),o=n===0?7:n;switch(s){case"i":return String(o);case"ii":return ht(o,s.length);case"io":return a.ordinalNumber(o,{unit:"day"});case"iii":return a.day(n,{width:"abbreviated",context:"formatting"});case"iiiii":return a.day(n,{width:"narrow",context:"formatting"});case"iiiiii":return a.day(n,{width:"short",context:"formatting"});case"iiii":default:return a.day(n,{width:"wide",context:"formatting"})}},a:function(r,s,a){var n=r.getUTCHours(),o=n/12>=1?"pm":"am";switch(s){case"a":case"aa":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"});case"aaa":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return a.dayPeriod(o,{width:"narrow",context:"formatting"});case"aaaa":default:return a.dayPeriod(o,{width:"wide",context:"formatting"})}},b:function(r,s,a){var n=r.getUTCHours(),o;switch(n===12?o=qn.noon:n===0?o=qn.midnight:o=n/12>=1?"pm":"am",s){case"b":case"bb":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"});case"bbb":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return a.dayPeriod(o,{width:"narrow",context:"formatting"});case"bbbb":default:return a.dayPeriod(o,{width:"wide",context:"formatting"})}},B:function(r,s,a){var n=r.getUTCHours(),o;switch(n>=17?o=qn.evening:n>=12?o=qn.afternoon:n>=4?o=qn.morning:o=qn.night,s){case"B":case"BB":case"BBB":return a.dayPeriod(o,{width:"abbreviated",context:"formatting"});case"BBBBB":return a.dayPeriod(o,{width:"narrow",context:"formatting"});case"BBBB":default:return a.dayPeriod(o,{width:"wide",context:"formatting"})}},h:function(r,s,a){if(s==="ho"){var n=r.getUTCHours()%12;return n===0&&(n=12),a.ordinalNumber(n,{unit:"hour"})}return Zr.h(r,s)},H:function(r,s,a){return s==="Ho"?a.ordinalNumber(r.getUTCHours(),{unit:"hour"}):Zr.H(r,s)},K:function(r,s,a){var n=r.getUTCHours()%12;return s==="Ko"?a.ordinalNumber(n,{unit:"hour"}):ht(n,s.length)},k:function(r,s,a){var n=r.getUTCHours();return n===0&&(n=24),s==="ko"?a.ordinalNumber(n,{unit:"hour"}):ht(n,s.length)},m:function(r,s,a){return s==="mo"?a.ordinalNumber(r.getUTCMinutes(),{unit:"minute"}):Zr.m(r,s)},s:function(r,s,a){return s==="so"?a.ordinalNumber(r.getUTCSeconds(),{unit:"second"}):Zr.s(r,s)},S:function(r,s){return Zr.S(r,s)},X:function(r,s,a,n){var o=n._originalDate||r,i=o.getTimezoneOffset();if(i===0)return"Z";switch(s){case"X":return cc(i);case"XXXX":case"XX":return yn(i);case"XXXXX":case"XXX":default:return yn(i,":")}},x:function(r,s,a,n){var o=n._originalDate||r,i=o.getTimezoneOffset();switch(s){case"x":return cc(i);case"xxxx":case"xx":return yn(i);case"xxxxx":case"xxx":default:return yn(i,":")}},O:function(r,s,a,n){var o=n._originalDate||r,i=o.getTimezoneOffset();switch(s){case"O":case"OO":case"OOO":return"GMT"+lc(i,":");case"OOOO":default:return"GMT"+yn(i,":")}},z:function(r,s,a,n){var o=n._originalDate||r,i=o.getTimezoneOffset();switch(s){case"z":case"zz":case"zzz":return"GMT"+lc(i,":");case"zzzz":default:return"GMT"+yn(i,":")}},t:function(r,s,a,n){var o=n._originalDate||r,i=Math.floor(o.getTime()/1e3);return ht(i,s.length)},T:function(r,s,a,n){var o=n._originalDate||r,i=o.getTime();return ht(i,s.length)}};function lc(t,r){var s=t>0?"-":"+",a=Math.abs(t),n=Math.floor(a/60),o=a%60;if(o===0)return s+String(n);var i=r;return s+String(n)+i+ht(o,2)}function cc(t,r){if(t%60===0){var s=t>0?"-":"+";return s+ht(Math.abs(t)/60,2)}return yn(t,r)}function yn(t,r){var s=r||"",a=t>0?"-":"+",n=Math.abs(t),o=ht(Math.floor(n/60),2),i=ht(n%60,2);return a+o+s+i}var uc=function(r,s){switch(r){case"P":return s.date({width:"short"});case"PP":return s.date({width:"medium"});case"PPP":return s.date({width:"long"});case"PPPP":default:return s.date({width:"full"})}},ad=function(r,s){switch(r){case"p":return s.time({width:"short"});case"pp":return s.time({width:"medium"});case"ppp":return s.time({width:"long"});case"pppp":default:return s.time({width:"full"})}},wx=function(r,s){var a=r.match(/(P+)(p+)?/)||[],n=a[1],o=a[2];if(!o)return uc(r,s);var i;switch(n){case"P":i=s.dateTime({width:"short"});break;case"PP":i=s.dateTime({width:"medium"});break;case"PPP":i=s.dateTime({width:"long"});break;case"PPPP":default:i=s.dateTime({width:"full"});break}return i.replace("{{date}}",uc(n,s)).replace("{{time}}",ad(o,s))},wi={p:ad,P:wx},Sx=["D","DD"],Cx=["YY","YYYY"];function od(t){return Sx.indexOf(t)!==-1}function id(t){return Cx.indexOf(t)!==-1}function Xa(t,r,s){if(t==="YYYY")throw new RangeError("Use `yyyy` instead of `YYYY` (in `".concat(r,"`) for formatting years to the input `").concat(s,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"));if(t==="YY")throw new RangeError("Use `yy` instead of `YY` (in `".concat(r,"`) for formatting years to the input `").concat(s,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"));if(t==="D")throw new RangeError("Use `d` instead of `D` (in `".concat(r,"`) for formatting days of the month to the input `").concat(s,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"));if(t==="DD")throw new RangeError("Use `dd` instead of `DD` (in `".concat(r,"`) for formatting days of the month to the input `").concat(s,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"))}var kx={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},Px=function(r,s,a){var n,o=kx[r];return typeof o=="string"?n=o:s===1?n=o.one:n=o.other.replace("{{count}}",s.toString()),a!=null&&a.addSuffix?a.comparison&&a.comparison>0?"in "+n:n+" ago":n};function Zo(t){return function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},s=r.width?String(r.width):t.defaultWidth,a=t.formats[s]||t.formats[t.defaultWidth];return a}}var Ex={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},Dx={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},Tx={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},Ox={date:Zo({formats:Ex,defaultWidth:"full"}),time:Zo({formats:Dx,defaultWidth:"full"}),dateTime:Zo({formats:Tx,defaultWidth:"full"})},Ix={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},Ax=function(r,s,a,n){return Ix[r]};function bs(t){return function(r,s){var a=s!=null&&s.context?String(s.context):"standalone",n;if(a==="formatting"&&t.formattingValues){var o=t.defaultFormattingWidth||t.defaultWidth,i=s!=null&&s.width?String(s.width):o;n=t.formattingValues[i]||t.formattingValues[o]}else{var c=t.defaultWidth,u=s!=null&&s.width?String(s.width):t.defaultWidth;n=t.values[u]||t.values[c]}var d=t.argumentCallback?t.argumentCallback(r):r;return n[d]}}var Mx={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},Rx={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},Nx={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},Lx={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},qx={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},Ux={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},Wx=function(r,s){var a=Number(r),n=a%100;if(n>20||n<10)switch(n%10){case 1:return a+"st";case 2:return a+"nd";case 3:return a+"rd"}return a+"th"},Fx={ordinalNumber:Wx,era:bs({values:Mx,defaultWidth:"wide"}),quarter:bs({values:Rx,defaultWidth:"wide",argumentCallback:function(r){return r-1}}),month:bs({values:Nx,defaultWidth:"wide"}),day:bs({values:Lx,defaultWidth:"wide"}),dayPeriod:bs({values:qx,defaultWidth:"wide",formattingValues:Ux,defaultFormattingWidth:"wide"})};function js(t){return function(r){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},a=s.width,n=a&&t.matchPatterns[a]||t.matchPatterns[t.defaultMatchWidth],o=r.match(n);if(!o)return null;var i=o[0],c=a&&t.parsePatterns[a]||t.parsePatterns[t.defaultParseWidth],u=Array.isArray(c)?Bx(c,function(y){return y.test(i)}):$x(c,function(y){return y.test(i)}),d;d=t.valueCallback?t.valueCallback(u):u,d=s.valueCallback?s.valueCallback(d):d;var p=r.slice(i.length);return{value:d,rest:p}}}function $x(t,r){for(var s in t)if(t.hasOwnProperty(s)&&r(t[s]))return s}function Bx(t,r){for(var s=0;s<t.length;s++)if(r(t[s]))return s}function zx(t){return function(r){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},a=r.match(t.matchPattern);if(!a)return null;var n=a[0],o=r.match(t.parsePattern);if(!o)return null;var i=t.valueCallback?t.valueCallback(o[0]):o[0];i=s.valueCallback?s.valueCallback(i):i;var c=r.slice(n.length);return{value:i,rest:c}}}var Hx=/^(\d+)(th|st|nd|rd)?/i,Yx=/\d+/i,Vx={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},Gx={any:[/^b/i,/^(a|c)/i]},Qx={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},Jx={any:[/1/i,/2/i,/3/i,/4/i]},Kx={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},Xx={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},Zx={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},ey={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},ty={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},ry={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},ny={ordinalNumber:zx({matchPattern:Hx,parsePattern:Yx,valueCallback:function(r){return parseInt(r,10)}}),era:js({matchPatterns:Vx,defaultMatchWidth:"wide",parsePatterns:Gx,defaultParseWidth:"any"}),quarter:js({matchPatterns:Qx,defaultMatchWidth:"wide",parsePatterns:Jx,defaultParseWidth:"any",valueCallback:function(r){return r+1}}),month:js({matchPatterns:Kx,defaultMatchWidth:"wide",parsePatterns:Xx,defaultParseWidth:"any"}),day:js({matchPatterns:Zx,defaultMatchWidth:"wide",parsePatterns:ey,defaultParseWidth:"any"}),dayPeriod:js({matchPatterns:ty,defaultMatchWidth:"any",parsePatterns:ry,defaultParseWidth:"any"})},Fi={code:"en-US",formatDistance:Px,formatLong:Ox,formatRelative:Ax,localize:Fx,match:ny,options:{weekStartsOn:0,firstWeekContainsDate:1}},sy=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,ay=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,oy=/^'([^]*?)'?$/,iy=/''/g,ly=/[a-zA-Z]/;function Ys(t,r,s){var a,n,o,i,c,u,d,p,y,w,O,_,E,b,I,U,S,j;Ae(2,arguments);var N=String(r),k=Nr(),M=(a=(n=s?.locale)!==null&&n!==void 0?n:k.locale)!==null&&a!==void 0?a:Fi,v=yt((o=(i=(c=(u=s?.firstWeekContainsDate)!==null&&u!==void 0?u:s==null||(d=s.locale)===null||d===void 0||(p=d.options)===null||p===void 0?void 0:p.firstWeekContainsDate)!==null&&c!==void 0?c:k.firstWeekContainsDate)!==null&&i!==void 0?i:(y=k.locale)===null||y===void 0||(w=y.options)===null||w===void 0?void 0:w.firstWeekContainsDate)!==null&&o!==void 0?o:1);if(!(v>=1&&v<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var g=yt((O=(_=(E=(b=s?.weekStartsOn)!==null&&b!==void 0?b:s==null||(I=s.locale)===null||I===void 0||(U=I.options)===null||U===void 0?void 0:U.weekStartsOn)!==null&&E!==void 0?E:k.weekStartsOn)!==null&&_!==void 0?_:(S=k.locale)===null||S===void 0||(j=S.options)===null||j===void 0?void 0:j.weekStartsOn)!==null&&O!==void 0?O:0);if(!(g>=0&&g<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");if(!M.localize)throw new RangeError("locale must contain localize property");if(!M.formatLong)throw new RangeError("locale must contain formatLong property");var L=Me(t);if(!Xu(L))throw new RangeError("Invalid time value");var z=Ka(L),ne=td(L,z),ae={firstWeekContainsDate:v,weekStartsOn:g,locale:M,_originalDate:L},ee=N.match(ay).map(function(W){var Z=W[0];if(Z==="p"||Z==="P"){var J=wi[Z];return J(W,M.formatLong)}return W}).join("").match(sy).map(function(W){if(W==="''")return"'";var Z=W[0];if(Z==="'")return cy(W);var J=jx[Z];if(J)return!(s!=null&&s.useAdditionalWeekYearTokens)&&id(W)&&Xa(W,r,String(t)),!(s!=null&&s.useAdditionalDayOfYearTokens)&&od(W)&&Xa(W,r,String(t)),J(ne,W,M.localize,ae);if(Z.match(ly))throw new RangeError("Format string contains an unescaped latin alphabet character `"+Z+"`");return W}).join("");return ee}function cy(t){var r=t.match(oy);return r?r[1].replace(iy,"'"):t}function uy(t,r){if(t==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=r[s]);return t}function dy(t,r){var s,a;Ae(1,arguments);var n=Me(t);if(isNaN(n.getTime()))throw new RangeError("Invalid time value");var o=String((s=r?.format)!==null&&s!==void 0?s:"extended"),i=String((a=r?.representation)!==null&&a!==void 0?a:"complete");if(o!=="extended"&&o!=="basic")throw new RangeError("format must be 'extended' or 'basic'");if(i!=="date"&&i!=="time"&&i!=="complete")throw new RangeError("representation must be 'date', 'time', or 'complete'");var c="",u="",d=o==="extended"?"-":"",p=o==="extended"?":":"";if(i!=="time"){var y=ht(n.getDate(),2),w=ht(n.getMonth()+1,2),O=ht(n.getFullYear(),4);c="".concat(O).concat(d).concat(w).concat(d).concat(y)}if(i!=="date"){var _=n.getTimezoneOffset();if(_!==0){var E=Math.abs(_),b=ht(Math.floor(E/60),2),I=ht(E%60,2),U=_<0?"+":"-";u="".concat(U).concat(b,":").concat(I)}else u="Z";var S=ht(n.getHours(),2),j=ht(n.getMinutes(),2),N=ht(n.getSeconds(),2),k=c===""?"":"T",M=[S,j,N].join(p);c="".concat(c).concat(k).concat(M).concat(u)}return c}function py(t){Ae(1,arguments);var r=Me(t),s=r.getDate();return s}function ld(t){Ae(1,arguments);var r=Me(t),s=r.getFullYear(),a=r.getMonth(),n=new Date(0);return n.setFullYear(s,a+1,0),n.setHours(0,0,0,0),n.getDate()}function hy(t){Ae(1,arguments);var r=Me(t),s=r.getHours();return s}function my(t){Ae(1,arguments);var r=Me(t),s=r.getMilliseconds();return s}function fy(t){Ae(1,arguments);var r=Me(t),s=r.getMinutes();return s}function gy(t){Ae(1,arguments);var r=Me(t),s=r.getMonth();return s}function xy(t){Ae(1,arguments);var r=Me(t),s=r.getSeconds();return s}function yy(t,r){var s,a,n,o,i,c,u,d;Ae(1,arguments);var p=Me(t),y=p.getFullYear(),w=Nr(),O=yt((s=(a=(n=(o=r?.firstWeekContainsDate)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.firstWeekContainsDate)!==null&&n!==void 0?n:w.firstWeekContainsDate)!==null&&a!==void 0?a:(u=w.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.firstWeekContainsDate)!==null&&s!==void 0?s:1);if(!(O>=1&&O<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var _=new Date(0);_.setFullYear(y+1,0,O),_.setHours(0,0,0,0);var E=wn(_,r),b=new Date(0);b.setFullYear(y,0,O),b.setHours(0,0,0,0);var I=wn(b,r);return p.getTime()>=E.getTime()?y+1:p.getTime()>=I.getTime()?y:y-1}function vy(t,r){var s,a,n,o,i,c,u,d;Ae(1,arguments);var p=Nr(),y=yt((s=(a=(n=(o=r?.firstWeekContainsDate)!==null&&o!==void 0?o:r==null||(i=r.locale)===null||i===void 0||(c=i.options)===null||c===void 0?void 0:c.firstWeekContainsDate)!==null&&n!==void 0?n:p.firstWeekContainsDate)!==null&&a!==void 0?a:(u=p.locale)===null||u===void 0||(d=u.options)===null||d===void 0?void 0:d.firstWeekContainsDate)!==null&&s!==void 0?s:1),w=yy(t,r),O=new Date(0);O.setFullYear(w,0,y),O.setHours(0,0,0,0);var _=wn(O,r);return _}var _y=6048e5;function by(t,r){Ae(1,arguments);var s=Me(t),a=wn(s,r).getTime()-vy(s,r).getTime();return Math.round(a/_y)+1}function jy(t){return Ae(1,arguments),Me(t).getFullYear()}function ei(t,r){Ae(2,arguments);var s=Me(t),a=Me(r);return s.getTime()>a.getTime()}function ws(t,r){Ae(2,arguments);var s=Me(t),a=Me(r);return s.getTime()<a.getTime()}function wy(t,r){Ae(2,arguments);var s=Me(t),a=Me(r);return s.getTime()===a.getTime()}function dc(t,r){(r==null||r>t.length)&&(r=t.length);for(var s=0,a=Array(r);s<r;s++)a[s]=t[s];return a}function Sy(t,r){if(t){if(typeof t=="string")return dc(t,r);var s={}.toString.call(t).slice(8,-1);return s==="Object"&&t.constructor&&(s=t.constructor.name),s==="Map"||s==="Set"?Array.from(t):s==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s)?dc(t,r):void 0}}function pc(t,r){var s=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!s){if(Array.isArray(t)||(s=Sy(t))||r){s&&(t=s);var a=0,n=function(){};return{s:n,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(d){throw d},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var o,i=!0,c=!1;return{s:function(){s=s.call(t)},n:function(){var d=s.next();return i=d.done,d},e:function(d){c=!0,o=d},f:function(){try{i||s.return==null||s.return()}finally{if(c)throw o}}}}function _t(t,r){if(typeof r!="function"&&r!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&Bd(t,r)}function Za(t){return Za=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(r){return r.__proto__||Object.getPrototypeOf(r)},Za(t)}function cd(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(cd=function(){return!!t})()}function Cy(t,r){if(r&&(so(r)=="object"||typeof r=="function"))return r;if(r!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Ue(t)}function bt(t){var r=cd();return function(){var s,a=Za(t);if(r){var n=Za(this).constructor;s=Reflect.construct(a,arguments,n)}else s=a.apply(this,arguments);return Cy(this,s)}}function gt(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function ky(t,r){for(var s=0;s<r.length;s++){var a=r[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,Zc(a.key),a)}}function xt(t,r,s){return r&&ky(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function Ne(t,r,s){return(r=Zc(r))in t?Object.defineProperty(t,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[r]=s,t}var Py=10,ud=function(){function t(){gt(this,t),Ne(this,"priority",void 0),Ne(this,"subPriority",0)}return xt(t,[{key:"validate",value:function(s,a){return!0}}]),t}(),Ey=function(t){_t(s,t);var r=bt(s);function s(a,n,o,i,c){var u;return gt(this,s),u=r.call(this),u.value=a,u.validateValue=n,u.setValue=o,u.priority=i,c&&(u.subPriority=c),u}return xt(s,[{key:"validate",value:function(n,o){return this.validateValue(n,this.value,o)}},{key:"set",value:function(n,o,i){return this.setValue(n,o,this.value,i)}}]),s}(ud),Dy=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",Py),Ne(Ue(a),"subPriority",-1),a}return xt(s,[{key:"set",value:function(n,o){if(o.timestampIsSet)return n;var i=new Date(0);return i.setFullYear(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()),i.setHours(n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds(),n.getUTCMilliseconds()),i}}]),s}(ud),St=function(){function t(){gt(this,t),Ne(this,"incompatibleTokens",void 0),Ne(this,"priority",void 0),Ne(this,"subPriority",void 0)}return xt(t,[{key:"run",value:function(s,a,n,o){var i=this.parse(s,a,n,o);return i?{setter:new Ey(i.value,this.validate,this.set,this.priority,this.subPriority),rest:i.rest}:null}},{key:"validate",value:function(s,a,n){return!0}}]),t}(),Ty=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",140),Ne(Ue(a),"incompatibleTokens",["R","u","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"G":case"GG":case"GGG":return i.era(n,{width:"abbreviated"})||i.era(n,{width:"narrow"});case"GGGGG":return i.era(n,{width:"narrow"});case"GGGG":default:return i.era(n,{width:"wide"})||i.era(n,{width:"abbreviated"})||i.era(n,{width:"narrow"})}}},{key:"set",value:function(n,o,i){return o.era=i,n.setUTCFullYear(i,0,1),n.setUTCHours(0,0,0,0),n}}]),s}(St),Ft={month:/^(1[0-2]|0?\d)/,date:/^(3[0-1]|[0-2]?\d)/,dayOfYear:/^(36[0-6]|3[0-5]\d|[0-2]?\d?\d)/,week:/^(5[0-3]|[0-4]?\d)/,hour23h:/^(2[0-3]|[0-1]?\d)/,hour24h:/^(2[0-4]|[0-1]?\d)/,hour11h:/^(1[0-1]|0?\d)/,hour12h:/^(1[0-2]|0?\d)/,minute:/^[0-5]?\d/,second:/^[0-5]?\d/,singleDigit:/^\d/,twoDigits:/^\d{1,2}/,threeDigits:/^\d{1,3}/,fourDigits:/^\d{1,4}/,anyDigitsSigned:/^-?\d+/,singleDigitSigned:/^-?\d/,twoDigitsSigned:/^-?\d{1,2}/,threeDigitsSigned:/^-?\d{1,3}/,fourDigitsSigned:/^-?\d{1,4}/},Ir={basicOptionalMinutes:/^([+-])(\d{2})(\d{2})?|Z/,basic:/^([+-])(\d{2})(\d{2})|Z/,basicOptionalSeconds:/^([+-])(\d{2})(\d{2})((\d{2}))?|Z/,extended:/^([+-])(\d{2}):(\d{2})|Z/,extendedOptionalSeconds:/^([+-])(\d{2}):(\d{2})(:(\d{2}))?|Z/};function $t(t,r){return t&&{value:r(t.value),rest:t.rest}}function Lt(t,r){var s=r.match(t);return s?{value:parseInt(s[0],10),rest:r.slice(s[0].length)}:null}function Ar(t,r){var s=r.match(t);if(!s)return null;if(s[0]==="Z")return{value:0,rest:r.slice(1)};var a=s[1]==="+"?1:-1,n=s[2]?parseInt(s[2],10):0,o=s[3]?parseInt(s[3],10):0,i=s[5]?parseInt(s[5],10):0;return{value:a*(n*jo+o*bo+i*rx),rest:r.slice(s[0].length)}}function dd(t){return Lt(Ft.anyDigitsSigned,t)}function Ut(t,r){switch(t){case 1:return Lt(Ft.singleDigit,r);case 2:return Lt(Ft.twoDigits,r);case 3:return Lt(Ft.threeDigits,r);case 4:return Lt(Ft.fourDigits,r);default:return Lt(new RegExp("^\\d{1,"+t+"}"),r)}}function eo(t,r){switch(t){case 1:return Lt(Ft.singleDigitSigned,r);case 2:return Lt(Ft.twoDigitsSigned,r);case 3:return Lt(Ft.threeDigitsSigned,r);case 4:return Lt(Ft.fourDigitsSigned,r);default:return Lt(new RegExp("^-?\\d{1,"+t+"}"),r)}}function $i(t){switch(t){case"morning":return 4;case"evening":return 17;case"pm":case"noon":case"afternoon":return 12;case"am":case"midnight":case"night":default:return 0}}function pd(t,r){var s=r>0,a=s?r:1-r,n;if(a<=50)n=t||100;else{var o=a+50,i=Math.floor(o/100)*100,c=t>=o%100;n=t+i-(c?100:0)}return s?n:1-n}function hd(t){return t%400===0||t%4===0&&t%100!==0}var Oy=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",130),Ne(Ue(a),"incompatibleTokens",["Y","R","u","w","I","i","e","c","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){var c=function(d){return{year:d,isTwoDigitYear:o==="yy"}};switch(o){case"y":return $t(Ut(4,n),c);case"yo":return $t(i.ordinalNumber(n,{unit:"year"}),c);default:return $t(Ut(o.length,n),c)}}},{key:"validate",value:function(n,o){return o.isTwoDigitYear||o.year>0}},{key:"set",value:function(n,o,i){var c=n.getUTCFullYear();if(i.isTwoDigitYear){var u=pd(i.year,c);return n.setUTCFullYear(u,0,1),n.setUTCHours(0,0,0,0),n}var d=!("era"in o)||o.era===1?i.year:1-i.year;return n.setUTCFullYear(d,0,1),n.setUTCHours(0,0,0,0),n}}]),s}(St),Iy=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",130),Ne(Ue(a),"incompatibleTokens",["y","R","u","Q","q","M","L","I","d","D","i","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){var c=function(d){return{year:d,isTwoDigitYear:o==="YY"}};switch(o){case"Y":return $t(Ut(4,n),c);case"Yo":return $t(i.ordinalNumber(n,{unit:"year"}),c);default:return $t(Ut(o.length,n),c)}}},{key:"validate",value:function(n,o){return o.isTwoDigitYear||o.year>0}},{key:"set",value:function(n,o,i,c){var u=Wi(n,c);if(i.isTwoDigitYear){var d=pd(i.year,u);return n.setUTCFullYear(d,0,c.firstWeekContainsDate),n.setUTCHours(0,0,0,0),Pn(n,c)}var p=!("era"in o)||o.era===1?i.year:1-i.year;return n.setUTCFullYear(p,0,c.firstWeekContainsDate),n.setUTCHours(0,0,0,0),Pn(n,c)}}]),s}(St),Ay=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",130),Ne(Ue(a),"incompatibleTokens",["G","y","Y","u","Q","q","M","L","w","d","D","e","c","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o){return eo(o==="R"?4:o.length,n)}},{key:"set",value:function(n,o,i){var c=new Date(0);return c.setUTCFullYear(i,0,4),c.setUTCHours(0,0,0,0),Jn(c)}}]),s}(St),My=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",130),Ne(Ue(a),"incompatibleTokens",["G","y","Y","R","w","I","i","e","c","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o){return eo(o==="u"?4:o.length,n)}},{key:"set",value:function(n,o,i){return n.setUTCFullYear(i,0,1),n.setUTCHours(0,0,0,0),n}}]),s}(St),Ry=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",120),Ne(Ue(a),"incompatibleTokens",["Y","R","q","M","L","w","I","d","D","i","e","c","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"Q":case"QQ":return Ut(o.length,n);case"Qo":return i.ordinalNumber(n,{unit:"quarter"});case"QQQ":return i.quarter(n,{width:"abbreviated",context:"formatting"})||i.quarter(n,{width:"narrow",context:"formatting"});case"QQQQQ":return i.quarter(n,{width:"narrow",context:"formatting"});case"QQQQ":default:return i.quarter(n,{width:"wide",context:"formatting"})||i.quarter(n,{width:"abbreviated",context:"formatting"})||i.quarter(n,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(n,o){return o>=1&&o<=4}},{key:"set",value:function(n,o,i){return n.setUTCMonth((i-1)*3,1),n.setUTCHours(0,0,0,0),n}}]),s}(St),Ny=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",120),Ne(Ue(a),"incompatibleTokens",["Y","R","Q","M","L","w","I","d","D","i","e","c","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"q":case"qq":return Ut(o.length,n);case"qo":return i.ordinalNumber(n,{unit:"quarter"});case"qqq":return i.quarter(n,{width:"abbreviated",context:"standalone"})||i.quarter(n,{width:"narrow",context:"standalone"});case"qqqqq":return i.quarter(n,{width:"narrow",context:"standalone"});case"qqqq":default:return i.quarter(n,{width:"wide",context:"standalone"})||i.quarter(n,{width:"abbreviated",context:"standalone"})||i.quarter(n,{width:"narrow",context:"standalone"})}}},{key:"validate",value:function(n,o){return o>=1&&o<=4}},{key:"set",value:function(n,o,i){return n.setUTCMonth((i-1)*3,1),n.setUTCHours(0,0,0,0),n}}]),s}(St),Ly=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"incompatibleTokens",["Y","R","q","Q","L","w","I","D","i","e","c","t","T"]),Ne(Ue(a),"priority",110),a}return xt(s,[{key:"parse",value:function(n,o,i){var c=function(d){return d-1};switch(o){case"M":return $t(Lt(Ft.month,n),c);case"MM":return $t(Ut(2,n),c);case"Mo":return $t(i.ordinalNumber(n,{unit:"month"}),c);case"MMM":return i.month(n,{width:"abbreviated",context:"formatting"})||i.month(n,{width:"narrow",context:"formatting"});case"MMMMM":return i.month(n,{width:"narrow",context:"formatting"});case"MMMM":default:return i.month(n,{width:"wide",context:"formatting"})||i.month(n,{width:"abbreviated",context:"formatting"})||i.month(n,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(n,o){return o>=0&&o<=11}},{key:"set",value:function(n,o,i){return n.setUTCMonth(i,1),n.setUTCHours(0,0,0,0),n}}]),s}(St),qy=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",110),Ne(Ue(a),"incompatibleTokens",["Y","R","q","Q","M","w","I","D","i","e","c","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){var c=function(d){return d-1};switch(o){case"L":return $t(Lt(Ft.month,n),c);case"LL":return $t(Ut(2,n),c);case"Lo":return $t(i.ordinalNumber(n,{unit:"month"}),c);case"LLL":return i.month(n,{width:"abbreviated",context:"standalone"})||i.month(n,{width:"narrow",context:"standalone"});case"LLLLL":return i.month(n,{width:"narrow",context:"standalone"});case"LLLL":default:return i.month(n,{width:"wide",context:"standalone"})||i.month(n,{width:"abbreviated",context:"standalone"})||i.month(n,{width:"narrow",context:"standalone"})}}},{key:"validate",value:function(n,o){return o>=0&&o<=11}},{key:"set",value:function(n,o,i){return n.setUTCMonth(i,1),n.setUTCHours(0,0,0,0),n}}]),s}(St);function Uy(t,r,s){Ae(2,arguments);var a=Me(t),n=yt(r),o=sd(a,s)-n;return a.setUTCDate(a.getUTCDate()-o*7),a}var Wy=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",100),Ne(Ue(a),"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","i","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"w":return Lt(Ft.week,n);case"wo":return i.ordinalNumber(n,{unit:"week"});default:return Ut(o.length,n)}}},{key:"validate",value:function(n,o){return o>=1&&o<=53}},{key:"set",value:function(n,o,i,c){return Pn(Uy(n,i,c),c)}}]),s}(St);function Fy(t,r){Ae(2,arguments);var s=Me(t),a=yt(r),n=nd(s)-a;return s.setUTCDate(s.getUTCDate()-n*7),s}var $y=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",100),Ne(Ue(a),"incompatibleTokens",["y","Y","u","q","Q","M","L","w","d","D","e","c","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"I":return Lt(Ft.week,n);case"Io":return i.ordinalNumber(n,{unit:"week"});default:return Ut(o.length,n)}}},{key:"validate",value:function(n,o){return o>=1&&o<=53}},{key:"set",value:function(n,o,i){return Jn(Fy(n,i))}}]),s}(St),By=[31,28,31,30,31,30,31,31,30,31,30,31],zy=[31,29,31,30,31,30,31,31,30,31,30,31],Hy=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",90),Ne(Ue(a),"subPriority",1),Ne(Ue(a),"incompatibleTokens",["Y","R","q","Q","w","I","D","i","e","c","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"d":return Lt(Ft.date,n);case"do":return i.ordinalNumber(n,{unit:"date"});default:return Ut(o.length,n)}}},{key:"validate",value:function(n,o){var i=n.getUTCFullYear(),c=hd(i),u=n.getUTCMonth();return c?o>=1&&o<=zy[u]:o>=1&&o<=By[u]}},{key:"set",value:function(n,o,i){return n.setUTCDate(i),n.setUTCHours(0,0,0,0),n}}]),s}(St),Yy=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",90),Ne(Ue(a),"subpriority",1),Ne(Ue(a),"incompatibleTokens",["Y","R","q","Q","M","L","w","I","d","E","i","e","c","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"D":case"DD":return Lt(Ft.dayOfYear,n);case"Do":return i.ordinalNumber(n,{unit:"date"});default:return Ut(o.length,n)}}},{key:"validate",value:function(n,o){var i=n.getUTCFullYear(),c=hd(i);return c?o>=1&&o<=366:o>=1&&o<=365}},{key:"set",value:function(n,o,i){return n.setUTCMonth(0,i),n.setUTCHours(0,0,0,0),n}}]),s}(St);function Bi(t,r,s){var a,n,o,i,c,u,d,p;Ae(2,arguments);var y=Nr(),w=yt((a=(n=(o=(i=s?.weekStartsOn)!==null&&i!==void 0?i:s==null||(c=s.locale)===null||c===void 0||(u=c.options)===null||u===void 0?void 0:u.weekStartsOn)!==null&&o!==void 0?o:y.weekStartsOn)!==null&&n!==void 0?n:(d=y.locale)===null||d===void 0||(p=d.options)===null||p===void 0?void 0:p.weekStartsOn)!==null&&a!==void 0?a:0);if(!(w>=0&&w<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var O=Me(t),_=yt(r),E=O.getUTCDay(),b=_%7,I=(b+7)%7,U=(I<w?7:0)+_-E;return O.setUTCDate(O.getUTCDate()+U),O}var Vy=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",90),Ne(Ue(a),"incompatibleTokens",["D","i","e","c","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"E":case"EE":case"EEE":return i.day(n,{width:"abbreviated",context:"formatting"})||i.day(n,{width:"short",context:"formatting"})||i.day(n,{width:"narrow",context:"formatting"});case"EEEEE":return i.day(n,{width:"narrow",context:"formatting"});case"EEEEEE":return i.day(n,{width:"short",context:"formatting"})||i.day(n,{width:"narrow",context:"formatting"});case"EEEE":default:return i.day(n,{width:"wide",context:"formatting"})||i.day(n,{width:"abbreviated",context:"formatting"})||i.day(n,{width:"short",context:"formatting"})||i.day(n,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(n,o){return o>=0&&o<=6}},{key:"set",value:function(n,o,i,c){return n=Bi(n,i,c),n.setUTCHours(0,0,0,0),n}}]),s}(St),Gy=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",90),Ne(Ue(a),"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","E","i","c","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i,c){var u=function(p){var y=Math.floor((p-1)/7)*7;return(p+c.weekStartsOn+6)%7+y};switch(o){case"e":case"ee":return $t(Ut(o.length,n),u);case"eo":return $t(i.ordinalNumber(n,{unit:"day"}),u);case"eee":return i.day(n,{width:"abbreviated",context:"formatting"})||i.day(n,{width:"short",context:"formatting"})||i.day(n,{width:"narrow",context:"formatting"});case"eeeee":return i.day(n,{width:"narrow",context:"formatting"});case"eeeeee":return i.day(n,{width:"short",context:"formatting"})||i.day(n,{width:"narrow",context:"formatting"});case"eeee":default:return i.day(n,{width:"wide",context:"formatting"})||i.day(n,{width:"abbreviated",context:"formatting"})||i.day(n,{width:"short",context:"formatting"})||i.day(n,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(n,o){return o>=0&&o<=6}},{key:"set",value:function(n,o,i,c){return n=Bi(n,i,c),n.setUTCHours(0,0,0,0),n}}]),s}(St),Qy=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",90),Ne(Ue(a),"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","E","i","e","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i,c){var u=function(p){var y=Math.floor((p-1)/7)*7;return(p+c.weekStartsOn+6)%7+y};switch(o){case"c":case"cc":return $t(Ut(o.length,n),u);case"co":return $t(i.ordinalNumber(n,{unit:"day"}),u);case"ccc":return i.day(n,{width:"abbreviated",context:"standalone"})||i.day(n,{width:"short",context:"standalone"})||i.day(n,{width:"narrow",context:"standalone"});case"ccccc":return i.day(n,{width:"narrow",context:"standalone"});case"cccccc":return i.day(n,{width:"short",context:"standalone"})||i.day(n,{width:"narrow",context:"standalone"});case"cccc":default:return i.day(n,{width:"wide",context:"standalone"})||i.day(n,{width:"abbreviated",context:"standalone"})||i.day(n,{width:"short",context:"standalone"})||i.day(n,{width:"narrow",context:"standalone"})}}},{key:"validate",value:function(n,o){return o>=0&&o<=6}},{key:"set",value:function(n,o,i,c){return n=Bi(n,i,c),n.setUTCHours(0,0,0,0),n}}]),s}(St);function Jy(t,r){Ae(2,arguments);var s=yt(r);s%7===0&&(s=s-7);var a=1,n=Me(t),o=n.getUTCDay(),i=s%7,c=(i+7)%7,u=(c<a?7:0)+s-o;return n.setUTCDate(n.getUTCDate()+u),n}var Ky=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",90),Ne(Ue(a),"incompatibleTokens",["y","Y","u","q","Q","M","L","w","d","D","E","e","c","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){var c=function(d){return d===0?7:d};switch(o){case"i":case"ii":return Ut(o.length,n);case"io":return i.ordinalNumber(n,{unit:"day"});case"iii":return $t(i.day(n,{width:"abbreviated",context:"formatting"})||i.day(n,{width:"short",context:"formatting"})||i.day(n,{width:"narrow",context:"formatting"}),c);case"iiiii":return $t(i.day(n,{width:"narrow",context:"formatting"}),c);case"iiiiii":return $t(i.day(n,{width:"short",context:"formatting"})||i.day(n,{width:"narrow",context:"formatting"}),c);case"iiii":default:return $t(i.day(n,{width:"wide",context:"formatting"})||i.day(n,{width:"abbreviated",context:"formatting"})||i.day(n,{width:"short",context:"formatting"})||i.day(n,{width:"narrow",context:"formatting"}),c)}}},{key:"validate",value:function(n,o){return o>=1&&o<=7}},{key:"set",value:function(n,o,i){return n=Jy(n,i),n.setUTCHours(0,0,0,0),n}}]),s}(St),Xy=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",80),Ne(Ue(a),"incompatibleTokens",["b","B","H","k","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"a":case"aa":case"aaa":return i.dayPeriod(n,{width:"abbreviated",context:"formatting"})||i.dayPeriod(n,{width:"narrow",context:"formatting"});case"aaaaa":return i.dayPeriod(n,{width:"narrow",context:"formatting"});case"aaaa":default:return i.dayPeriod(n,{width:"wide",context:"formatting"})||i.dayPeriod(n,{width:"abbreviated",context:"formatting"})||i.dayPeriod(n,{width:"narrow",context:"formatting"})}}},{key:"set",value:function(n,o,i){return n.setUTCHours($i(i),0,0,0),n}}]),s}(St),Zy=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",80),Ne(Ue(a),"incompatibleTokens",["a","B","H","k","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"b":case"bb":case"bbb":return i.dayPeriod(n,{width:"abbreviated",context:"formatting"})||i.dayPeriod(n,{width:"narrow",context:"formatting"});case"bbbbb":return i.dayPeriod(n,{width:"narrow",context:"formatting"});case"bbbb":default:return i.dayPeriod(n,{width:"wide",context:"formatting"})||i.dayPeriod(n,{width:"abbreviated",context:"formatting"})||i.dayPeriod(n,{width:"narrow",context:"formatting"})}}},{key:"set",value:function(n,o,i){return n.setUTCHours($i(i),0,0,0),n}}]),s}(St),ev=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",80),Ne(Ue(a),"incompatibleTokens",["a","b","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"B":case"BB":case"BBB":return i.dayPeriod(n,{width:"abbreviated",context:"formatting"})||i.dayPeriod(n,{width:"narrow",context:"formatting"});case"BBBBB":return i.dayPeriod(n,{width:"narrow",context:"formatting"});case"BBBB":default:return i.dayPeriod(n,{width:"wide",context:"formatting"})||i.dayPeriod(n,{width:"abbreviated",context:"formatting"})||i.dayPeriod(n,{width:"narrow",context:"formatting"})}}},{key:"set",value:function(n,o,i){return n.setUTCHours($i(i),0,0,0),n}}]),s}(St),tv=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",70),Ne(Ue(a),"incompatibleTokens",["H","K","k","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"h":return Lt(Ft.hour12h,n);case"ho":return i.ordinalNumber(n,{unit:"hour"});default:return Ut(o.length,n)}}},{key:"validate",value:function(n,o){return o>=1&&o<=12}},{key:"set",value:function(n,o,i){var c=n.getUTCHours()>=12;return c&&i<12?n.setUTCHours(i+12,0,0,0):!c&&i===12?n.setUTCHours(0,0,0,0):n.setUTCHours(i,0,0,0),n}}]),s}(St),rv=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",70),Ne(Ue(a),"incompatibleTokens",["a","b","h","K","k","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"H":return Lt(Ft.hour23h,n);case"Ho":return i.ordinalNumber(n,{unit:"hour"});default:return Ut(o.length,n)}}},{key:"validate",value:function(n,o){return o>=0&&o<=23}},{key:"set",value:function(n,o,i){return n.setUTCHours(i,0,0,0),n}}]),s}(St),nv=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",70),Ne(Ue(a),"incompatibleTokens",["h","H","k","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"K":return Lt(Ft.hour11h,n);case"Ko":return i.ordinalNumber(n,{unit:"hour"});default:return Ut(o.length,n)}}},{key:"validate",value:function(n,o){return o>=0&&o<=11}},{key:"set",value:function(n,o,i){var c=n.getUTCHours()>=12;return c&&i<12?n.setUTCHours(i+12,0,0,0):n.setUTCHours(i,0,0,0),n}}]),s}(St),sv=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",70),Ne(Ue(a),"incompatibleTokens",["a","b","h","H","K","t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"k":return Lt(Ft.hour24h,n);case"ko":return i.ordinalNumber(n,{unit:"hour"});default:return Ut(o.length,n)}}},{key:"validate",value:function(n,o){return o>=1&&o<=24}},{key:"set",value:function(n,o,i){var c=i<=24?i%24:i;return n.setUTCHours(c,0,0,0),n}}]),s}(St),av=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",60),Ne(Ue(a),"incompatibleTokens",["t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"m":return Lt(Ft.minute,n);case"mo":return i.ordinalNumber(n,{unit:"minute"});default:return Ut(o.length,n)}}},{key:"validate",value:function(n,o){return o>=0&&o<=59}},{key:"set",value:function(n,o,i){return n.setUTCMinutes(i,0,0),n}}]),s}(St),ov=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",50),Ne(Ue(a),"incompatibleTokens",["t","T"]),a}return xt(s,[{key:"parse",value:function(n,o,i){switch(o){case"s":return Lt(Ft.second,n);case"so":return i.ordinalNumber(n,{unit:"second"});default:return Ut(o.length,n)}}},{key:"validate",value:function(n,o){return o>=0&&o<=59}},{key:"set",value:function(n,o,i){return n.setUTCSeconds(i,0),n}}]),s}(St),iv=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",30),Ne(Ue(a),"incompatibleTokens",["t","T"]),a}return xt(s,[{key:"parse",value:function(n,o){var i=function(u){return Math.floor(u*Math.pow(10,-o.length+3))};return $t(Ut(o.length,n),i)}},{key:"set",value:function(n,o,i){return n.setUTCMilliseconds(i),n}}]),s}(St),lv=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",10),Ne(Ue(a),"incompatibleTokens",["t","T","x"]),a}return xt(s,[{key:"parse",value:function(n,o){switch(o){case"X":return Ar(Ir.basicOptionalMinutes,n);case"XX":return Ar(Ir.basic,n);case"XXXX":return Ar(Ir.basicOptionalSeconds,n);case"XXXXX":return Ar(Ir.extendedOptionalSeconds,n);case"XXX":default:return Ar(Ir.extended,n)}}},{key:"set",value:function(n,o,i){return o.timestampIsSet?n:new Date(n.getTime()-i)}}]),s}(St),cv=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",10),Ne(Ue(a),"incompatibleTokens",["t","T","X"]),a}return xt(s,[{key:"parse",value:function(n,o){switch(o){case"x":return Ar(Ir.basicOptionalMinutes,n);case"xx":return Ar(Ir.basic,n);case"xxxx":return Ar(Ir.basicOptionalSeconds,n);case"xxxxx":return Ar(Ir.extendedOptionalSeconds,n);case"xxx":default:return Ar(Ir.extended,n)}}},{key:"set",value:function(n,o,i){return o.timestampIsSet?n:new Date(n.getTime()-i)}}]),s}(St),uv=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",40),Ne(Ue(a),"incompatibleTokens","*"),a}return xt(s,[{key:"parse",value:function(n){return dd(n)}},{key:"set",value:function(n,o,i){return[new Date(i*1e3),{timestampIsSet:!0}]}}]),s}(St),dv=function(t){_t(s,t);var r=bt(s);function s(){var a;gt(this,s);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return a=r.call.apply(r,[this].concat(o)),Ne(Ue(a),"priority",20),Ne(Ue(a),"incompatibleTokens","*"),a}return xt(s,[{key:"parse",value:function(n){return dd(n)}},{key:"set",value:function(n,o,i){return[new Date(i),{timestampIsSet:!0}]}}]),s}(St),pv={G:new Ty,y:new Oy,Y:new Iy,R:new Ay,u:new My,Q:new Ry,q:new Ny,M:new Ly,L:new qy,w:new Wy,I:new $y,d:new Hy,D:new Yy,E:new Vy,e:new Gy,c:new Qy,i:new Ky,a:new Xy,b:new Zy,B:new ev,h:new tv,H:new rv,K:new nv,k:new sv,m:new av,s:new ov,S:new iv,X:new lv,x:new cv,t:new uv,T:new dv},hv=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,mv=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,fv=/^'([^]*?)'?$/,gv=/''/g,xv=/\S/,yv=/[a-zA-Z]/;function vv(t,r,s,a){var n,o,i,c,u,d,p,y,w,O,_,E,b,I,U,S,j,N;Ae(3,arguments);var k=String(t),M=String(r),v=Nr(),g=(n=(o=a?.locale)!==null&&o!==void 0?o:v.locale)!==null&&n!==void 0?n:Fi;if(!g.match)throw new RangeError("locale must contain match property");var L=yt((i=(c=(u=(d=a?.firstWeekContainsDate)!==null&&d!==void 0?d:a==null||(p=a.locale)===null||p===void 0||(y=p.options)===null||y===void 0?void 0:y.firstWeekContainsDate)!==null&&u!==void 0?u:v.firstWeekContainsDate)!==null&&c!==void 0?c:(w=v.locale)===null||w===void 0||(O=w.options)===null||O===void 0?void 0:O.firstWeekContainsDate)!==null&&i!==void 0?i:1);if(!(L>=1&&L<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var z=yt((_=(E=(b=(I=a?.weekStartsOn)!==null&&I!==void 0?I:a==null||(U=a.locale)===null||U===void 0||(S=U.options)===null||S===void 0?void 0:S.weekStartsOn)!==null&&b!==void 0?b:v.weekStartsOn)!==null&&E!==void 0?E:(j=v.locale)===null||j===void 0||(N=j.options)===null||N===void 0?void 0:N.weekStartsOn)!==null&&_!==void 0?_:0);if(!(z>=0&&z<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");if(M==="")return k===""?Me(s):new Date(NaN);var ne={firstWeekContainsDate:L,weekStartsOn:z,locale:g},ae=[new Dy],ee=M.match(mv).map(function(ge){var me=ge[0];if(me in wi){var be=wi[me];return be(ge,g.formatLong)}return ge}).join("").match(hv),W=[],Z=pc(ee),J;try{var P=function(){var me=J.value;!(a!=null&&a.useAdditionalWeekYearTokens)&&id(me)&&Xa(me,M,t),!(a!=null&&a.useAdditionalDayOfYearTokens)&&od(me)&&Xa(me,M,t);var be=me[0],je=pv[be];if(je){var oe=je.incompatibleTokens;if(Array.isArray(oe)){var D=W.find(function(te){return oe.includes(te.token)||te.token===be});if(D)throw new RangeError("The format string mustn't contain `".concat(D.fullToken,"` and `").concat(me,"` at the same time"))}else if(je.incompatibleTokens==="*"&&W.length>0)throw new RangeError("The format string mustn't contain `".concat(me,"` and any other token at the same time"));W.push({token:be,fullToken:me});var F=je.run(k,me,g.match,ne);if(!F)return{v:new Date(NaN)};ae.push(F.setter),k=F.rest}else{if(be.match(yv))throw new RangeError("Format string contains an unescaped latin alphabet character `"+be+"`");if(me==="''"?me="'":be==="'"&&(me=_v(me)),k.indexOf(me)===0)k=k.slice(me.length);else return{v:new Date(NaN)}}};for(Z.s();!(J=Z.n()).done;){var m=P();if(so(m)==="object")return m.v}}catch(ge){Z.e(ge)}finally{Z.f()}if(k.length>0&&xv.test(k))return new Date(NaN);var A=ae.map(function(ge){return ge.priority}).sort(function(ge,me){return me-ge}).filter(function(ge,me,be){return be.indexOf(ge)===me}).map(function(ge){return ae.filter(function(me){return me.priority===ge}).sort(function(me,be){return be.subPriority-me.subPriority})}).map(function(ge){return ge[0]}),G=Me(s);if(isNaN(G.getTime()))return new Date(NaN);var X=td(G,Ka(G)),Y={},fe=pc(A),se;try{for(fe.s();!(se=fe.n()).done;){var ke=se.value;if(!ke.validate(X,ne))return new Date(NaN);var Pe=ke.set(X,Y,ne);Array.isArray(Pe)?(X=Pe[0],uy(Y,Pe[1])):X=Pe}}catch(ge){fe.e(ge)}finally{fe.f()}return X}function _v(t){return t.match(fv)[1].replace(gv,"'")}function hc(t){Ae(1,arguments);var r=Me(t);return r.setMinutes(0,0,0),r}function bv(t,r){Ae(2,arguments);var s=hc(t),a=hc(r);return s.getTime()===a.getTime()}function jv(t,r){Ae(2,arguments);var s=Me(t),a=Me(r);return s.getFullYear()===a.getFullYear()&&s.getMonth()===a.getMonth()}function wv(t,r){Ae(2,arguments);var s=Me(t),a=Me(r);return s.getFullYear()===a.getFullYear()}function Sv(t,r){Ae(2,arguments);var s=Me(t).getTime(),a=Me(r.start).getTime(),n=Me(r.end).getTime();if(!(a<=n))throw new RangeError("Invalid interval");return s>=a&&s<=n}function Cv(t,r){var s;Ae(1,arguments);var a=yt((s=void 0)!==null&&s!==void 0?s:2);if(a!==2&&a!==1&&a!==0)throw new RangeError("additionalDigits must be 0, 1 or 2");if(!(typeof t=="string"||Object.prototype.toString.call(t)==="[object String]"))return new Date(NaN);var n=Dv(t),o;if(n.date){var i=Tv(n.date,a);o=Ov(i.restDateString,i.year)}if(!o||isNaN(o.getTime()))return new Date(NaN);var c=o.getTime(),u=0,d;if(n.time&&(u=Iv(n.time),isNaN(u)))return new Date(NaN);if(n.timezone){if(d=Av(n.timezone),isNaN(d))return new Date(NaN)}else{var p=new Date(c+u),y=new Date(0);return y.setFullYear(p.getUTCFullYear(),p.getUTCMonth(),p.getUTCDate()),y.setHours(p.getUTCHours(),p.getUTCMinutes(),p.getUTCSeconds(),p.getUTCMilliseconds()),y}return new Date(c+u+d)}var wa={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},kv=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,Pv=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,Ev=/^([+-])(\d{2})(?::?(\d{2}))?$/;function Dv(t){var r={},s=t.split(wa.dateTimeDelimiter),a;if(s.length>2)return r;if(/:/.test(s[0])?a=s[0]:(r.date=s[0],a=s[1],wa.timeZoneDelimiter.test(r.date)&&(r.date=t.split(wa.timeZoneDelimiter)[0],a=t.substr(r.date.length,t.length))),a){var n=wa.timezone.exec(a);n?(r.time=a.replace(n[1],""),r.timezone=n[1]):r.time=a}return r}function Tv(t,r){var s=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+r)+"})|(\\d{2}|[+-]\\d{"+(2+r)+"})$)"),a=t.match(s);if(!a)return{year:NaN,restDateString:""};var n=a[1]?parseInt(a[1]):null,o=a[2]?parseInt(a[2]):null;return{year:o===null?n:o*100,restDateString:t.slice((a[1]||a[2]).length)}}function Ov(t,r){if(r===null)return new Date(NaN);var s=t.match(kv);if(!s)return new Date(NaN);var a=!!s[4],n=Ss(s[1]),o=Ss(s[2])-1,i=Ss(s[3]),c=Ss(s[4]),u=Ss(s[5])-1;if(a)return qv(r,c,u)?Mv(r,c,u):new Date(NaN);var d=new Date(0);return!Nv(r,o,i)||!Lv(r,n)?new Date(NaN):(d.setUTCFullYear(r,o,Math.max(n,i)),d)}function Ss(t){return t?parseInt(t):1}function Iv(t){var r=t.match(Pv);if(!r)return NaN;var s=ti(r[1]),a=ti(r[2]),n=ti(r[3]);return Uv(s,a,n)?s*jo+a*bo+n*1e3:NaN}function ti(t){return t&&parseFloat(t.replace(",","."))||0}function Av(t){if(t==="Z")return 0;var r=t.match(Ev);if(!r)return 0;var s=r[1]==="+"?-1:1,a=parseInt(r[2]),n=r[3]&&parseInt(r[3])||0;return Wv(a,n)?s*(a*jo+n*bo):NaN}function Mv(t,r,s){var a=new Date(0);a.setUTCFullYear(t,0,4);var n=a.getUTCDay()||7,o=(r-1)*7+s+1-n;return a.setUTCDate(a.getUTCDate()+o),a}var Rv=[31,null,31,30,31,30,31,31,30,31,30,31];function md(t){return t%400===0||t%4===0&&t%100!==0}function Nv(t,r,s){return r>=0&&r<=11&&s>=1&&s<=(Rv[r]||(md(t)?29:28))}function Lv(t,r){return r>=1&&r<=(md(t)?366:365)}function qv(t,r,s){return r>=1&&r<=53&&s>=0&&s<=6}function Uv(t,r,s){return t===24?r===0&&s===0:s>=0&&s<60&&r>=0&&r<60&&t>=0&&t<25}function Wv(t,r){return r>=0&&r<=59}function Fv(t,r){Ae(2,arguments);var s=Me(t),a=yt(r),n=s.getFullYear(),o=s.getDate(),i=new Date(0);i.setFullYear(n,a,15),i.setHours(0,0,0,0);var c=ld(i);return s.setMonth(a,Math.min(o,c)),s}function $v(t,r){Ae(2,arguments);var s=Me(t),a=yt(r);return s.setDate(a),s}function Bv(t,r){Ae(2,arguments);var s=Me(t),a=yt(r);return s.setHours(a),s}function zv(t,r){Ae(2,arguments);var s=Me(t),a=yt(r);return s.setMilliseconds(a),s}function Hv(t,r){Ae(2,arguments);var s=Me(t),a=yt(r);return s.setMinutes(a),s}function Yv(t,r){Ae(2,arguments);var s=Me(t),a=yt(r);return s.setSeconds(a),s}function Vv(t,r){Ae(2,arguments);var s=Me(t),a=yt(r);return isNaN(s.getTime())?new Date(NaN):(s.setFullYear(a),s)}const mc=t=>{const r=Number(t);return isFinite(r)?new Intl.NumberFormat("en-CA",{maximumFractionDigits:0}).format(r):""},Gv=()=>{const t=qt(),[r,s]=l.useState([]),[a,n]=l.useState(""),[o,i]=l.useState({page:0,pageSize:10}),[c,u]=l.useState(null),[d,p]=l.useState(null);l.useEffect(()=>{y()},[]);const y=async()=>{try{const U=await $.get("/api/quotes");s(U.data||[])}catch(U){console.error("Error fetching quotes:",U),u("Failed to fetch quotes")}},w=async U=>{if(window.confirm("Are you sure you want to delete this quote?"))try{await $.delete(`/api/quotes/${U}`),p("Quote deleted successfully"),y()}catch{u("Failed to delete quote")}},O=()=>{const U=r.map(M=>({"Quote #":M.quote_number,Customer:M.customer_name,Product:M.product_name,"Est. Price":mc(M.estimated_cost),"Quote Date":M.quote_date?Ys(new Date(M.quote_date),"MM/dd/yyyy"):"","Valid Until":M.valid_until?Ys(new Date(M.valid_until),"MM/dd/yyyy"):"",Status:M.status})),S=un.unparse(U),j=new Blob([S],{type:"text/csv;charset=utf-8;"}),N=document.createElement("a"),k=URL.createObjectURL(j);N.setAttribute("href",k),N.setAttribute("download","quotes.csv"),N.style.visibility="hidden",document.body.appendChild(N),N.click(),document.body.removeChild(N)},E=l.useMemo(()=>r.filter(U=>U.quote_number?.toLowerCase?.().includes(a.toLowerCase())||U.customer_name?.toLowerCase?.().includes(a.toLowerCase())||U.product_name?.toLowerCase?.().includes(a.toLowerCase())),[r,a]).map(U=>({...U,id:U.quote_id})),b=[{field:"quote_number",headerName:"Quote #",flex:1.05,minWidth:150,valueFormatter:U=>U.value?String(U.value).replace("QO-",""):""},{field:"customer_name",headerName:"Customer",flex:1.2,minWidth:170},{field:"product_name",headerName:"Product",flex:1.1,minWidth:160},{field:"estimated_cost",headerName:"Est. Price",type:"number",flex:.8,minWidth:110,headerAlign:"left",align:"left",valueFormatter:U=>mc(U.value)},{field:"quote_date",headerName:"Quote Date",flex:.95,minWidth:130,valueFormatter:U=>U.value?Ys(new Date(U.value),"yyyy-MM-dd"):""},{field:"valid_until",headerName:"Valid Until",flex:.95,minWidth:130,valueFormatter:U=>U.value?Ys(new Date(U.value),"yyyy-MM-dd"):""},{field:"actions",headerName:"Actions",width:120,flex:0,sortable:!1,filterable:!1,disableColumnMenu:!0,renderCell:U=>e.jsx(q,{sx:{display:"flex",alignItems:"center"},children:e.jsx(ar,{title:"Delete",children:e.jsx(ot,{size:"small",color:"error",onClick:S=>{S.stopPropagation();const j=U.row.quote_id;w(j)},children:e.jsx(tr,{})})})})}],I=U=>{const S=U.row;t(`/quotes/${S.quote_id}`)};return e.jsxs(Qe,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(f,{variant:"h4",component:"h1",sx:{fontWeight:"bold",color:"text.primary"},children:"Quotes"}),e.jsxs(tt,{direction:"row",spacing:2,children:[e.jsx(K,{variant:"contained",color:"primary",startIcon:e.jsx(vr,{}),onClick:()=>t("/quotes/new"),children:"NEW QUOTE"}),e.jsx(K,{variant:"outlined",color:"primary",startIcon:e.jsx(or,{}),onClick:O,children:"EXPORT CSV"})]})]}),e.jsx(qe,{sx:{width:"100%",overflow:"hidden",mb:3,border:"1px solid",borderColor:"divider",borderRadius:1},elevation:0,children:e.jsxs(q,{sx:{p:2},children:[e.jsx(ie,{fullWidth:!0,label:"Search",value:a,onChange:U=>n(U.target.value),InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:e.jsx(yr,{sx:{fontSize:22}})})},sx:{mb:2,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"small"}),e.jsx(Mr,{rows:E,columns:b,paginationModel:o,onPaginationModelChange:i,pageSizeOptions:[10,25,50],getRowId:U=>U.id,onRowClick:I,disableRowSelectionOnClick:!0,disableColumnMenu:!0,hideFooterSelectedRowCount:!0,initialState:{sorting:{sortModel:[{field:"quote_number",sort:"desc"}]}},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224,224,224,1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224,224,224,1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"},"& .MuiDataGrid-columnSeparator":{display:"none"}}})]})}),e.jsx(zr,{open:!!d,autoHideDuration:6e3,onClose:()=>p(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Re,{onClose:()=>p(null),severity:"success",sx:{width:"100%"},children:d})}),e.jsx(zr,{open:!!c,autoHideDuration:6e3,onClose:()=>u(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Re,{onClose:()=>u(null),severity:"error",sx:{width:"100%"},children:c})})]})};var Cs={},fc;function Qv(){if(fc)return Cs;fc=1;var t=At();Object.defineProperty(Cs,"__esModule",{value:!0}),Cs.default=void 0;var r=t(Rt()),s=Mt();return Cs.default=(0,r.default)((0,s.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"}),"Save"),Cs}var Jv=Qv();const ts=vt(Jv);var ks={},gc;function Kv(){if(gc)return ks;gc=1;var t=At();Object.defineProperty(ks,"__esModule",{value:!0}),ks.default=void 0;var r=t(Rt()),s=Mt();return ks.default=(0,r.default)((0,s.jsx)("path",{d:"m18 7-1.41-1.41-6.34 6.34 1.41 1.41zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12zM.41 13.41 6 19l1.41-1.41L1.83 12z"}),"DoneAll"),ks}var Xv=Kv();const to=vt(Xv);var Ps={},xc;function Zv(){if(xc)return Ps;xc=1;var t=At();Object.defineProperty(Ps,"__esModule",{value:!0}),Ps.default=void 0;var r=t(Rt()),s=Mt();return Ps.default=(0,r.default)((0,s.jsx)("path",{d:"M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2m0 4-8 5-8-5V6l8 5 8-5z"}),"Email"),Ps}var e_=Zv();const zi=vt(e_);var Es={},yc;function t_(){if(yc)return Es;yc=1;var t=At();Object.defineProperty(Es,"__esModule",{value:!0}),Es.default=void 0;var r=t(Rt()),s=Mt();return Es.default=(0,r.default)((0,s.jsx)("path",{d:"M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8"}),"AddCircleOutline"),Es}var r_=t_();const an=vt(r_),fd=({open:t,onClose:r,type:s,recordId:a,defaultTo:n,defaultSubject:o,defaultMessage:i,allowMessageEdit:c=!0})=>{const{user:u}=Qt(),[d,p]=l.useState(n||""),[y,w]=l.useState(o||""),[O,_]=l.useState(i||""),[E,b]=l.useState(""),[I,U]=l.useState(!1),[S,j]=l.useState(""),[N,k]=l.useState([]),[M,v]=l.useState("");l.useEffect(()=>{console.log("EmailModal useEffect: open =",t,"defaultTo =",n,"current to =",d),t&&n&&(console.log("Setting to field to:",n),p(n))},[t,n]),l.useEffect(()=>{t&&g()},[t,s]);const g=async()=>{try{const ee=await $.get("/api/email/templates");if(ee.data.success){const W=ee.data.templates.filter(J=>J.type===s);k(W);const Z=W.find(J=>J.is_default);Z?(v(Z.id),w(Z.subject),_(Z.html_content)):W.length===0&&(s==="quote"?(w("Quote Information"),_("Please find attached the quote details.")):s==="purchase-order"?(w("Purchase Order Information"),_("Please find attached the purchase order details.")):s==="sales-order"&&(w("Sales Order Information"),_("Please find attached the sales order details.")))}}catch(ee){console.error("Error loading templates:",ee),s==="quote"?(w("Quote Information"),_("Please find attached the quote details.")):s==="purchase-order"?(w("Purchase Order Information"),_("Please find attached the purchase order details.")):s==="sales-order"&&(w("Sales Order Information"),_("Please find attached the sales order details."))}},L=ee=>{if(v(ee),ee!==""){const W=N.find(Z=>Z.id===ee);W&&(w(W.subject),_(W.html_content))}},z=async()=>{if(s==="custom"){if(!d||!y||!O){j("Please fill in all required fields");return}}else if(!d){j("Please enter a recipient email address");return}U(!0),j("");try{let ee="/api/email/send",W={to:d,subject:y,message:O};s!=="custom"&&a&&(ee=`/api/email/${s.replace("-","-")}/${a}`,W={to:d,...E&&{customMessage:E}});const Z=await $.post(ee,W);Z.data.success?(H.success("Email sent successfully!"),r(),p(""),w(""),_(""),b(""),v("")):j(Z.data.message||"Failed to send email")}catch(ee){console.error("Error sending email:",ee),j(ee.response?.data?.message||"Failed to send email")}finally{U(!1)}},ne=()=>{I||(r(),j(""))},ae=()=>{switch(s){case"sales-order":return"Send Sales Order Email";case"purchase-order":return"Send Purchase Order Email";case"quote":return"Send Quote Email";default:return"Send Email"}};return e.jsxs(lt,{open:t,onClose:ne,maxWidth:"md",fullWidth:!0,children:[e.jsx(ct,{children:ae()}),e.jsx(ut,{children:e.jsxs(q,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[s!=="custom"&&N.length>0&&e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Email Template"}),e.jsxs(Ot,{value:M,onChange:ee=>L(ee.target.value),label:"Email Template",children:[e.jsx(ze,{value:"",children:e.jsx("em",{children:"Use default template"})}),N.map(ee=>e.jsx(ze,{value:ee.id,children:e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:1},children:[ee.name,ee.is_default&&e.jsx(Le,{label:"Default",size:"small",color:"secondary"})]})},ee.id))]})]}),e.jsx(ie,{label:"To",value:d,onChange:ee=>p(ee.target.value),fullWidth:!0,required:!0,type:"email"}),s==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(ie,{label:"Subject",value:y,onChange:ee=>w(ee.target.value),fullWidth:!0,required:!0}),e.jsx(ie,{label:"Message",value:O,onChange:ee=>_(ee.target.value),fullWidth:!0,multiline:!0,rows:6,required:!0})]}),s!=="custom"&&c&&e.jsx(ie,{label:"Additional Message (Optional)",value:E,onChange:ee=>b(ee.target.value),fullWidth:!0,multiline:!0,rows:4,helperText:"Add a custom message to include with the email"}),S&&e.jsx(Re,{severity:"error",sx:{mt:2},children:S})]})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:ne,disabled:I,children:"Cancel"}),e.jsx(K,{onClick:z,variant:"contained",disabled:I,startIcon:I?e.jsx(it,{size:20}):void 0,children:I?"Sending...":"Send Email"})]})]})},vc={product_name:""},Hi=({open:t,onClose:r,onSave:s,initialProduct:a,isEditMode:n=!1,loading:o=!1})=>{const[i,c]=l.useState(vc),[u,d]=l.useState(null),p=yo(i,300);l.useEffect(()=>{t&&(c({...vc,...a}),d(null))},[t,a]);const y=_=>{const{name:E,value:b}=_.target;c(I=>({...I,[E]:b}))},w=()=>i.product_name.trim()?(d(null),!0):(d("Product name is required"),!1),O=()=>{w()&&s(i)};return l.useEffect(()=>{},[p,t]),e.jsxs(lt,{open:t,onClose:r,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ct,{children:n?"Edit Product":"Add New Product"}),e.jsxs(ut,{children:[e.jsx(T,{container:!0,spacing:2,sx:{mt:1},children:e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{name:"product_name",label:"Product Name",value:i.product_name,onChange:y,fullWidth:!0,required:!0,autoFocus:!0})})}),u&&e.jsx("div",{style:{color:"red",marginTop:8},children:u})]}),e.jsxs(dt,{children:[e.jsx(K,{onClick:r,children:"Cancel"}),e.jsx(K,{onClick:O,variant:"contained",disabled:o,children:n?"Save Changes":"Add Product"})]})]})},So=({when:t,onSave:r})=>{console.log("[UnsavedChangesGuard] Component rendered with when=",t);const[s,a]=l.useState(!1),[n,o]=l.useState(!1),i=l.useRef(""),c=l.useRef(null),u=l.useRef(!1);l.useEffect(()=>{if(!t)return;i.current=window.location.hash,console.log("[UnsavedChangesGuard] activating interceptors. prevHash=",i.current);const w=U=>U.metaKey||U.ctrlKey||U.shiftKey||U.altKey||U.button!==0,O=U=>{let S=U;for(;S&&S!==document.body;){if(S.tagName==="A")return S;S=S.parentElement}return null},_=U=>{if(!t||s)return;const S=O(U.target);if(!S||w(U))return;const j=S.getAttribute("href")||"";if(!j.startsWith("#"))return;const N=j;if(N!==window.location.hash){if(window.__unsavedGuardAllowNext){console.log("[UnsavedChangesGuard] bypass flag set -> allowing click navigation"),window.__unsavedGuardAllowNext=!1,u.current=!0;return}console.log("[UnsavedChangesGuard] click capture -> intercept anchor to",N),U.preventDefault(),U.stopPropagation(),c.current=N,a(!0)}},E=()=>{if(!t)return;if(window.__unsavedGuardAllowNext){console.log("[UnsavedChangesGuard] bypass flag set -> allowing hashchange"),window.__unsavedGuardAllowNext=!1,u.current=!0,i.current=window.location.hash;return}if(u.current){u.current=!1,i.current=window.location.hash,console.log("[UnsavedChangesGuard] hashchange allowed. prevHash ->",i.current);return}if(s)return;const U=window.location.hash;console.log("[UnsavedChangesGuard] hashchange detected -> attempted",U,"reverting to",i.current),c.current=U,a(!0),setTimeout(()=>{window.location.hash!==i.current&&(window.location.hash=i.current)},0)},b=history.pushState,I=history.replaceState;return history.pushState=function(...U){try{const S=U[2],j=typeof S=="string"?S:S?String(S):"",N=j&&j.includes("#")?j.slice(j.indexOf("#")):j;if(window.__unsavedGuardAllowNext)return console.log("[UnsavedChangesGuard] bypass flag set -> allowing pushState",j),window.__unsavedGuardAllowNext=!1,u.current=!0,b.apply(this,U);if(t&&!u.current){console.log("[UnsavedChangesGuard] pushState intercepted ->",j),c.current=N||null,a(!0);return}}catch{}return b.apply(this,U)},history.replaceState=function(...U){try{const S=U[2],j=typeof S=="string"?S:S?String(S):"",N=j&&j.includes("#")?j.slice(j.indexOf("#")):j;if(window.__unsavedGuardAllowNext)return console.log("[UnsavedChangesGuard] bypass flag set -> allowing replaceState",j),window.__unsavedGuardAllowNext=!1,u.current=!0,I.apply(this,U);if(t&&!u.current){console.log("[UnsavedChangesGuard] replaceState intercepted ->",j),c.current=N||null,a(!0);return}}catch{}return I.apply(this,U)},document.addEventListener("click",_,!0),window.addEventListener("hashchange",E),window.addEventListener("popstate",E),()=>{console.log("[UnsavedChangesGuard] deactivating interceptors"),document.removeEventListener("click",_,!0),window.removeEventListener("hashchange",E),window.removeEventListener("popstate",E),history.pushState=b,history.replaceState=I}},[t,s]),l.useEffect(()=>{console.log("[UnsavedChangesGuard] beforeunload useEffect triggered with when=",t);const w=O=>{t&&(console.log("[UnsavedChangesGuard] beforeunload fired"),O.preventDefault(),O.returnValue="")};return t&&(console.log("[UnsavedChangesGuard] registering beforeunload"),window.addEventListener("beforeunload",w)),()=>{console.log("[UnsavedChangesGuard] removing beforeunload listener"),window.removeEventListener("beforeunload",w)}},[t]);const d=()=>{console.log("[UnsavedChangesGuard] user chose: Stay"),a(!1),c.current=null},p=()=>{console.log("[UnsavedChangesGuard] user chose: Leave -> proceeding to",c.current);const w=c.current;a(!1),w&&(u.current=!0,c.current=null,window.location.hash!==w&&(window.location.hash=w))},y=async()=>{if(console.log("[UnsavedChangesGuard] user chose: Save and leave"),!r){p();return}try{o(!0),await r(),p()}catch(w){console.log("[UnsavedChangesGuard] save failed, staying on page",w),o(!1)}finally{o(!1)}};return e.jsxs(lt,{open:s,onClose:d,maxWidth:"xs",fullWidth:!0,children:[e.jsx(ct,{children:"Unsaved Changes"}),e.jsx(ut,{children:e.jsx(f,{variant:"body2",children:"You have unsaved changes. Would you like to save before leaving this page?"})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:d,children:"Cancel"}),e.jsx(K,{onClick:p,color:"warning",children:"Leave without saving"}),e.jsx(K,{onClick:y,variant:"contained",disabled:n,children:n?"Saving…":"Save and leave"})]})]})},gn={"& .MuiOutlinedInput-root":{height:56,borderRadius:1},"& .MuiInputBase-input":{py:1.25,fontSize:16}},Br={fontSize:18,transform:"translate(14px, 18px) scale(1)","&.MuiInputLabel-shrink":{fontSize:14,transform:"translate(14px, -9px) scale(0.9)"}},Bn=t=>t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim().toUpperCase(),n_=(t,r)=>{const s=Bn(r);return s?t.map(n=>{const o=Bn(n.label);let i=-1;return o.startsWith(s)?i=3:o.split(" ").some(c=>c.startsWith(s))?i=2:o.includes(s)&&(i=1),{opt:n,score:i}}).filter(n=>n.score>=0).sort((n,o)=>o.score-n.score||n.opt.label.localeCompare(o.opt.label)).slice(0,8).map(n=>n.opt):t.slice(0,8)},_c=()=>{const{id:t}=Dn(),r=qt(),a=!!t&&!(t==="new"),[n,o]=l.useState([]),[i,c]=l.useState([]),[u,d]=l.useState(null),[p,y]=l.useState(null),[w,O]=l.useState(null),[_,E]=l.useState(Ze()),[b,I]=l.useState(Ze().add(30,"day")),[U,S]=l.useState(null),[j,N]=l.useState(""),[k,M]=l.useState(""),[v,g]=l.useState(""),[L,z]=l.useState(""),[ne,ae]=l.useState(!1),[ee,W]=l.useState(null),[Z,J]=l.useState(null),[P,m]=l.useState(!1),[A,G]=l.useState(""),[X,Y]=l.useState(null),[fe,se]=l.useState(!1),ke=l.useRef(null),[Pe,ge]=l.useState(!1),[me,be]=l.useState(""),[je,oe]=l.useState(null),[D,F]=l.useState(!1),[te,B]=l.useState(""),[Ee,Se]=l.useState(!1),[$e,He]=l.useState(""),[De,et]=l.useState(!1),[Ve,Be]=l.useState(""),[Ke,We]=l.useState(!1),[pt,kt]=l.useState(!1),at=l.useCallback(()=>({customer:p?.id||u?.customer_id||null,product:w?.label||u?.product_name||"",quoteDate:_?.toISOString?.()||u?.quote_date||null,validUntil:b?.toISOString?.()||u?.valid_until||null,estimatedCost:U??u?.estimated_cost??null,productDescription:(j||"").trim(),terms:(k||"").trim(),customerPoNumber:(v||"").trim(),vinNumber:(L||"").trim()}),[p,u,w,_,b,U,j,k,v,L]);l.useEffect(()=>{if(Ke&&Ve===""){const le=JSON.stringify(at());Be(le),console.log("[QuoteEditor] Initial signature set:",le)}},[Ke,Ve,at]);const Ct=l.useMemo(()=>JSON.stringify(at()),[at]),Et=!!Ve&&Ve!==Ct&&!pt;l.useEffect(()=>{Ve&&console.log("[QuoteEditor] Signature comparison:",{isDirty:Et,initialSignature:Ve.slice(0,100)+"...",currentSignature:Ct.slice(0,100)+"...",signaturesMatch:Ve===Ct})},[Et,Ve,Ct]),l.useEffect(()=>{jt(),Pt(),a||We(!0)},[]),l.useEffect(()=>{!a||!t||(async()=>{try{const ce=(await $.get(`/api/quotes/${t}`)).data;d(ce),y(null),O({label:ce.product_name}),E(Ze(ce.quote_date)),I(Ze(ce.valid_until)),S(Number(ce.estimated_cost??0)),N(ce.product_description||""),M(ce.terms||""),g(ce.customer_po_number||""),z(ce.vin_number||""),G(ce.customer_name||""),be(ce.product_name||""),We(!0)}catch(le){console.error("Failed to load quote:",le),W("Failed to load quote")}})()},[t,a]),l.useEffect(()=>{if(u&&n.length>0){const le=n.find(ce=>ce.id===u.customer_id);le&&y(le)}},[n,u]),l.useEffect(()=>()=>{X&&window.clearTimeout(X),je&&window.clearTimeout(je)},[X,je]);const jt=async()=>{try{const ce=((await $.get("/api/customers")).data||[]).map(we=>({label:we.customer_name,id:we.customer_id,email:we.email}));o(ce)}catch{W("Failed to load customers")}},Pt=async()=>{try{const le=await $.get("/api/products");c((le.data||[]).map(ce=>({label:ce.product_name,id:ce.product_id,description:ce.product_description})))}catch{W("Failed to load products")}},Wt=le=>{const ce=Bn(le);return n.find(we=>Bn(we.label)===ce)||null},ir=async()=>{if(!p||!w||!_||!b||U==null){W("Please fill in all required fields");return}ae(!0),kt(!0);try{const le={customer_id:p.id,product_name:w.label.trim(),quote_date:_.format("YYYY-MM-DD"),valid_until:b.format("YYYY-MM-DD"),estimated_cost:Number(U),product_description:j,terms:k,customer_po_number:v,vin_number:L};if(a&&u){await $.put(`/api/quotes/${u.quote_id}`,le),J("Quote updated successfully");const ce=JSON.stringify(at());Be(ce),console.log("[QuoteEditor] Signature reset after save:",ce.slice(0,100)+"..."),setTimeout(()=>{window.__unsavedGuardAllowNext=!0},100)}else{if(window.__quoteCreateInFlight){console.log("[QuoteEditor] Skipping duplicate create (in flight)");return}window.__quoteCreateInFlight=!0;const ce=await $.post("/api/quotes",le);J("Quote created successfully");const we=ce?.data??{},Oe=we.quote_id??we.quoteId??we.id??we?.quote?.quote_id;if(Oe){const Xe={quote_id:Oe,quote_number:we.quote_number||`Q${Oe}`,customer_id:p.id,customer_name:p.label,quote_date:le.quote_date,valid_until:le.valid_until,product_name:le.product_name,product_description:le.product_description,estimated_cost:le.estimated_cost,status:"Open",terms:le.terms,customer_po_number:le.customer_po_number,vin_number:le.vin_number};d(Xe),window.__unsavedGuardAllowNext=!0,r(`/quotes/${Oe}`,{replace:!0}),Be(JSON.stringify(at()));return}}}catch(le){const ce=le,we=ce.response?.data&&typeof ce.response.data=="object"&&"message"in ce.response.data?ce.response.data.message:"Failed to save quote";W(we)}finally{ae(!1),kt(!1),window.__quoteCreateInFlight=!1}},ye=async()=>{if(u)try{const le=await $.get(`/api/quotes/${u.quote_id}/pdf`,{responseType:"blob"}),ce=window.URL.createObjectURL(new Blob([le.data])),we=document.createElement("a");we.href=ce,we.setAttribute("download",`Quote_${u.quote_number}.pdf`),document.body.appendChild(we),we.click(),we.parentNode?.removeChild(we),window.URL.revokeObjectURL(ce),J("PDF downloaded successfully.")}catch{W("Failed to download PDF. Please try again.")}},de=()=>{if(!u?.quote_id){W("Please save the quote before emailing.");return}et(!0)},_e=async()=>{if(!u?.quote_id){W("Please save the quote before converting.");return}ae(!0);try{const le=await $.post(`/api/quotes/${u.quote_id}/convert-to-sales-order`);J("Quote converted to sales order successfully!");const ce=le.data.salesOrder?.sales_order_id;setTimeout(ce?()=>{r(`/open-sales-orders/${ce}`)}:()=>{r("/open-sales-orders")},1500)}catch(le){const ce=le,we=ce.response?.data&&typeof ce.response.data=="object"&&"message"in ce.response.data?ce.response.data.message:"Failed to convert quote to sales order";W(we)}finally{ae(!1)}},ue=le=>{const ce=A.trim(),we=le.key==="Enter",Oe=le.key==="Tab",Xe=le.key==="Escape",xe=le.key==="ArrowDown"||le.key==="ArrowUp";if(Xe){m(!1);return}if(!xe&&(we||Oe)){if(we&&le.ctrlKey&&ce){le.preventDefault(),se(!0),B(ce),F(!0);return}const Fe=Wt(ce);if(P||!ce)return;le.preventDefault(),Fe?(y(Fe),G(Fe.label)):(se(!0),B(ce),F(!0))}},Ce=le=>{if(le.key==="Enter"){le.preventDefault();const ce=me.trim();if(!ce)return;const we=i.find(Oe=>Oe.label.toLowerCase()===ce.toLowerCase());we?(O(we),be(we.label)):(He(ce),Se(!0))}},Ie=a&&u?`Edit Quote: ${u.quote_number}`:a?"Edit Quote":"New Quote";return e.jsxs(Hr,{dateAdapter:Tn,children:[e.jsx(So,{when:Et,onSave:ir}),e.jsxs(Qe,{maxWidth:"lg",sx:{mt:4,mb:4,px:{xs:2,sm:3}},children:[e.jsxs(q,{sx:{maxWidth:1e3,mx:"auto",mb:3,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(f,{variant:"h5",sx:{fontWeight:700},children:Ie}),e.jsxs(tt,{direction:"row",spacing:1.25,children:[e.jsx(K,{variant:"contained",color:"primary",startIcon:e.jsx(ts,{}),onClick:ir,disabled:ne,children:a?"SAVE CHANGES":"CREATE QUOTE"}),a&&u&&e.jsxs(e.Fragment,{children:[e.jsx(K,{variant:"contained",color:"primary",startIcon:e.jsx(to,{}),onClick:_e,disabled:ne,children:"CONVERT TO SO"}),e.jsx(K,{variant:"contained",color:"primary",startIcon:e.jsx(or,{}),onClick:ye,children:"DOWNLOAD PDF"}),e.jsx(K,{variant:"contained",startIcon:e.jsx(zi,{}),sx:{backgroundColor:"#ff9800","&:hover":{backgroundColor:"#f57c00"}},onClick:de,children:"EMAIL QUOTE"})]})]})]}),e.jsx(q,{sx:{maxWidth:1e3,mx:"auto",mt:1.5},children:e.jsx(qe,{sx:{p:3,backgroundColor:"#fff"},elevation:3,children:e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:12,md:4,children:e.jsx(kr,{open:P,onOpen:()=>m(!0),onClose:()=>m(!1),autoHighlight:!0,options:n,value:p,onChange:(le,ce)=>{if(fe){se(!1);return}ce&&ce.isNew?(F(!0),B(A),y(null),G("")):y(ce)},filterOptions:(le,ce)=>{const we=n_(le,ce.inputValue||""),Oe=!!(ce.inputValue&&n.some(xe=>Bn(xe.label)===Bn(ce.inputValue))),Xe=[...we];return(ce.inputValue||"").trim()!==""&&!Oe&&Xe.push({label:`Add "${ce.inputValue}" as New Customer`,isNew:!0}),we.length===0&&(ce.inputValue||"").trim()!==""&&!Oe,Xe},inputValue:A,onInputChange:(le,ce,we)=>{if(G(ce),X&&window.clearTimeout(X),we==="reset")return;if(ce.trim().length>0){const Xe=window.setTimeout(()=>m(!0),180);Y(Xe)}else m(!1)},getOptionLabel:le=>typeof le=="string"?le:le.label,isOptionEqualToValue:(le,ce)=>le.id===ce?.id,renderOption:(le,ce)=>{const we=ce.isNew,{key:Oe,...Xe}=le;return e.jsxs("li",{...Xe,style:{display:"flex",alignItems:"center",opacity:we?.9:1},children:[we&&e.jsx(an,{fontSize:"small",style:{marginRight:8,color:"#666"}}),e.jsx("span",{children:ce.label})]},Oe)},renderInput:le=>{const ce=!!le.inputProps?.value,we=!!p||ce;return e.jsx(ie,{...le,label:"Customer",fullWidth:!0,required:!0,onKeyDown:ue,onBlur:()=>{if(!p){const Oe=A.trim();if(Oe){const Xe=Wt(Oe);Xe&&(y(Xe),G(Xe.label))}}},inputRef:Oe=>{ke.current=Oe},sx:gn,InputLabelProps:{...le.InputLabelProps,sx:Br,shrink:we}})}})}),e.jsx(T,{item:!0,xs:12,md:4,children:e.jsx(ie,{label:"Customer PO #",fullWidth:!0,value:v,onChange:le=>g(le.target.value),sx:gn,InputLabelProps:{sx:Br}})}),e.jsx(T,{item:!0,xs:12,md:4,children:e.jsx(ie,{label:"Estimated Price",type:"number",value:U??"",onChange:le=>S(le.target.value===""?null:parseFloat(le.target.value)),fullWidth:!0,required:!0,InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:"$"})},inputProps:{step:"0.01",onWheel:le=>le.currentTarget.blur()},sx:gn,InputLabelProps:{sx:Br}})}),e.jsx(T,{item:!0,xs:12,md:6,children:e.jsx(kr,{disablePortal:!0,open:Pe,onOpen:()=>ge(!0),onClose:()=>ge(!1),autoHighlight:!0,options:i,value:w,onChange:(le,ce)=>{if(ce&&ce.isNew){const we=ce.inputValue?.toString?.()||me.trim();Se(!0),He(we),O(null),be(""),ge(!1)}else O(ce),ge(!1)},filterOptions:(le,ce)=>{const we=le.filter(Oe=>Oe.label.toLowerCase().includes(ce.inputValue.toLowerCase()));return ce.inputValue!==""&&!le.some(Oe=>Oe.label.toLowerCase()===ce.inputValue.toLowerCase())&&we.push({label:`Add "${ce.inputValue}"`,isNew:!0,inputValue:ce.inputValue}),we},inputValue:me,onInputChange:(le,ce,we)=>{if(be(ce),He(ce),je&&window.clearTimeout(je),we==="reset")return;if(ce.trim().length>0){const Xe=window.setTimeout(()=>ge(!0),180);oe(Xe)}else ge(!1)},getOptionLabel:le=>typeof le=="string"?le:le.label,isOptionEqualToValue:(le,ce)=>le.id===ce?.id,renderInput:le=>{const ce=!!le.inputProps?.value,we=!!w||ce;return e.jsx(ie,{...le,label:"Product",fullWidth:!0,required:!0,onKeyDown:Ce,onBlur:()=>{if(!w){const Oe=me.trim();if(Oe){const Xe=i.find(xe=>xe.label.toLowerCase()===Oe.toLowerCase());Xe&&(O(Xe),be(Xe.label))}}},sx:gn,InputLabelProps:{...le.InputLabelProps,sx:Br,shrink:we}})}})}),e.jsx(T,{item:!0,xs:12,md:6,children:e.jsx(ie,{label:"VIN #",fullWidth:!0,value:L,onChange:le=>z(le.target.value),sx:gn,InputLabelProps:{sx:Br},error:L.length>0&&L.length!==17,helperText:L.length>0&&L.length!==17?"VIN must be 17 characters":""})}),e.jsx(T,{item:!0,xs:12,md:6,children:e.jsx(on,{label:"Quote Date",value:_,onChange:le=>E(le),slotProps:{textField:{fullWidth:!0,sx:gn,InputLabelProps:{sx:Br}}}})}),e.jsx(T,{item:!0,xs:12,md:6,children:e.jsx(on,{label:"Valid Until",value:b,onChange:le=>I(le),slotProps:{textField:{fullWidth:!0,sx:gn,InputLabelProps:{sx:Br}}}})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"Product Description",fullWidth:!0,multiline:!0,minRows:6,value:j,onChange:le=>N(le.target.value),sx:{"& .MuiOutlinedInput-root":{borderRadius:1},"& .MuiOutlinedInput-input":{fontSize:15}},InputLabelProps:{sx:Br,shrink:!0}})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"Terms and Conditions",fullWidth:!0,multiline:!0,minRows:4,value:k,onChange:le=>M(le.target.value),sx:{"& .MuiOutlinedInput-root":{borderRadius:1},"& .MuiOutlinedInput-input":{fontSize:15}},InputLabelProps:{sx:Br,shrink:!0}})})]})})}),e.jsx(fd,{open:De,onClose:()=>et(!1),type:"quote",recordId:u?.quote_id,defaultTo:p?.email||"",allowMessageEdit:!0}),e.jsx(vo,{open:D,onClose:()=>F(!1),onSave:async le=>{try{const we=(await $.post("/api/customers",le)).data,Oe={label:we.customer_name,id:we.customer_id,email:we.email||le.email};o(Xe=>[...Xe,Oe]),y(Oe),F(!1),G(Oe.label)}catch{W("Failed to add customer")}},initialCustomer:{customer_name:te},isEditMode:!1}),e.jsx(Hi,{open:Ee,onClose:()=>Se(!1),onSave:async le=>{try{const ce=await $.post("/api/products",le),we={label:le.product_name,id:ce.data.product_id,description:le.product_name};c(Oe=>[...Oe,we]),O(we),be(we.label),Se(!1),He("")}catch{W("Failed to add product.")}},initialProduct:{product_name:$e||me},isEditMode:!1}),e.jsx(zr,{open:!!Z,autoHideDuration:6e3,onClose:()=>J(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Re,{onClose:()=>J(null),severity:"success",sx:{width:"100%"},children:Z})}),e.jsx(zr,{open:!!ee,autoHideDuration:6e3,onClose:()=>W(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Re,{onClose:()=>W(null),severity:"error",sx:{width:"100%"},children:ee})})]})]})},s_=async()=>(await $.get("/api/employees")).data,bc=["Admin","Sales and Purchase","Time Tracking","Mobile Time Tracker"],a_=()=>{const[t,r]=l.useState(""),[s,a]=l.useState(""),[n,o]=l.useState(""),[i,c]=l.useState(""),[u,d]=l.useState("Employee"),[p,y]=l.useState(null),[w,O]=l.useState(null),[_,E]=l.useState([]),[b,I]=l.useState(!0);qt();const[U,S]=l.useState(null),[j,N]=l.useState(""),[k,M]=l.useState(""),[v,g]=l.useState(""),[L,z]=l.useState(!1);l.useEffect(()=>{ne()},[]);const ne=async()=>{I(!0);try{const P=await s_();E(P)}catch{y("Failed to fetch employees.")}finally{I(!1)}},ae=async P=>{if(P.preventDefault(),y(null),O(null),n!==i){y("Passwords do not match");return}try{const m=await $.post("/api/employees",{username:t,email:s,password:n,access_role:u});O(m.data.message),r(""),a(""),o(""),c(""),d("Employee"),ne()}catch(m){m instanceof nr?y(m.response?.data?.message||"Employee registration failed"):y("An unexpected error occurred")}},ee=async P=>{if(window.confirm("Are you sure you want to delete this employee?"))try{await $.delete(`/api/employees/${P}`),O("Employee deleted successfully"),ne()}catch(m){console.error("Error deleting employee:",m),m instanceof nr?y(m.response?.data?.message||"Failed to delete employee"):y("An unexpected error occurred")}},W=P=>{S(P),N(P.username),M(P.access_role),g(""),z(!0)},Z=()=>{z(!1),S(null),y(null),O(null)},J=async()=>{if(U){y(null),O(null);try{const P={username:j,access_role:k};v&&(P.password=v);const m=await $.put(`/api/employees/${U.id}`,P);O(m.data.message||"Employee updated successfully"),ne(),Z()}catch(P){console.error("Error updating employee:",P),P instanceof nr?y(P.response?.data?.message||"Failed to update employee"):y("An unexpected error occurred")}}};return b?e.jsxs(Qe,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(it,{}),e.jsx(f,{children:"Loading employees..."})]}):e.jsxs(Qe,{component:"main",maxWidth:"md",children:[e.jsxs(q,{sx:{marginTop:8,display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs(qe,{elevation:6,sx:{p:4,width:"100%",borderRadius:2,mb:4},children:[e.jsx(f,{component:"h1",variant:"h5",sx:{mb:3,textAlign:"center"},children:"Register New Employee"}),e.jsxs(q,{component:"form",onSubmit:ae,noValidate:!0,sx:{mt:1},children:[e.jsx(ie,{margin:"normal",required:!0,fullWidth:!0,id:"username",label:"Username",name:"username",autoComplete:"new-username",value:t,onChange:P=>r(P.target.value)}),e.jsx(ie,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"new-email",value:s,onChange:P=>a(P.target.value)}),e.jsx(ie,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Initial Password",type:"password",id:"password",autoComplete:"new-password",value:n,onChange:P=>o(P.target.value)}),e.jsx(ie,{margin:"normal",required:!0,fullWidth:!0,name:"confirmPassword",label:"Confirm Initial Password",type:"password",id:"confirmPassword",autoComplete:"new-password",value:i,onChange:P=>c(P.target.value)}),e.jsxs(Dt,{fullWidth:!0,margin:"normal",children:[e.jsx(Tt,{id:"access-role-label",children:"Access Role"}),e.jsx(Ot,{labelId:"access-role-label",id:"access-role",value:u,label:"Access Role",onChange:P=>d(P.target.value),children:bc.map(P=>e.jsx(ze,{value:P,children:P},P))})]}),e.jsx(K,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2},children:"Register Employee"}),p&&e.jsx(Re,{severity:"error",sx:{mt:2},children:p}),w&&e.jsx(Re,{severity:"success",sx:{mt:2},children:w})]})]}),e.jsxs(qe,{elevation:6,sx:{p:4,width:"100%",borderRadius:2},children:[e.jsx(f,{component:"h2",variant:"h5",sx:{mb:3,textAlign:"center"},children:"Existing Employees"}),e.jsx(wr,{children:_.map(P=>e.jsx(Sr,{secondaryAction:e.jsxs(q,{children:[e.jsx(ot,{edge:"end","aria-label":"edit",onClick:()=>W(P),sx:{mr:1},children:e.jsx(Qa,{})}),e.jsx(ot,{edge:"end","aria-label":"delete",onClick:()=>ee(P.id),children:e.jsx(tr,{})})]}),children:e.jsx(Cr,{primary:P.username,secondary:`Email: ${P.email} | Role: ${P.role} | Access: ${P.access_role}`})},P.id))})]})]}),e.jsxs(lt,{open:L,onClose:Z,children:[e.jsx(ct,{children:"Edit Employee Roles"}),e.jsxs(ut,{children:[U&&e.jsxs(q,{component:"form",noValidate:!0,sx:{mt:1},children:[e.jsx(ie,{margin:"normal",fullWidth:!0,id:"edit-username",label:"Username",value:j,onChange:P=>N(P.target.value),variant:"standard"}),e.jsx(ie,{margin:"normal",fullWidth:!0,id:"edit-email",label:"Email",value:U.email,InputProps:{readOnly:!0,disableUnderline:!0},variant:"standard"}),e.jsx(ie,{margin:"normal",fullWidth:!0,id:"edit-password",label:"New Password (leave blank to keep current)",type:"password",value:v,onChange:P=>g(P.target.value),variant:"standard"}),e.jsxs(Dt,{fullWidth:!0,margin:"normal",children:[e.jsx(Tt,{id:"edit-access-role-label",children:"Access Role"}),e.jsx(Ot,{labelId:"edit-access-role-label",id:"edit-access-role",value:k,label:"Access Role",onChange:P=>M(P.target.value),children:bc.map(P=>e.jsx(ze,{value:P,children:P},P))})]})]}),p&&e.jsx(Re,{severity:"error",sx:{mt:2},children:p}),w&&e.jsx(Re,{severity:"success",sx:{mt:2},children:w})]}),e.jsxs(dt,{children:[e.jsx(K,{onClick:Z,children:"Cancel"}),e.jsx(K,{onClick:J,variant:"contained",color:"primary",children:"Save Changes"})]})]})]})},o_=()=>{const[t,r]=l.useState([]),[s,a]=l.useState(""),[n,o]=l.useState([]),[i,c]=l.useState(!1),[u,d]=l.useState(!1),[p,y]=l.useState(null),[w,O]=l.useState(""),[_,E]=l.useState(!1),[b,I]=l.useState(!1),[U,S]=l.useState(null),[j,N]=l.useState([]),[k,M]=l.useState([]),[v,g]=l.useState("admin");l.useEffect(()=>{L()},[]),l.useEffect(()=>{v==="admin"?ne():s?z(s):o([])},[s,v]);const L=async()=>{try{const m=await $.get("/api/profile-documents/profiles");r(m.data)}catch(m){console.error("Error fetching profiles:",m),H.error("Failed to fetch profiles")}},z=async m=>{c(!0);try{const A=await $.get(`/api/profile-documents/profile/${m}`);o(A.data)}catch(A){console.error("Error fetching documents:",A),H.error("Failed to fetch documents")}finally{c(!1)}},ne=async()=>{c(!0);try{const A=(await $.get("/api/profile-documents/all")).data.reduce((X,Y)=>{const fe=Y.id;return X[fe]||(X[fe]={id:Y.id,filename:Y.filename,original_filename:Y.original_filename,file_size:Y.file_size,mime_type:Y.mime_type,uploaded_by:Y.uploaded_by,uploaded_by_name:Y.uploaded_by_name,created_at:Y.created_at,visible_to_profiles:[],profile_read_status:{},profile_details:[]}),X[fe].visible_to_profiles.push(Y.profile_id),X[fe].profile_read_status[Y.profile_id]=Y.has_read,X[fe].profile_details.push({profile_id:Y.profile_id,profile_name:Y.profile_name,has_read:Y.has_read,read_at:Y.read_at}),X},{}),G=Object.values(A);console.log("Grouped documents:",G),o(G)}catch(m){console.error("Error fetching all documents:",m),H.error("Failed to fetch documents")}finally{c(!1)}},ae=m=>{const A=m.target.files?.[0];A&&(y(A),w||O(A.name))},ee=async()=>{if(!p||k.length===0){H.error("Please select a file and at least one profile");return}E(!0);try{const m=new FormData;m.append("document",p),m.append("customName",w),m.append("visibleToProfiles",JSON.stringify(k)),(await $.post("/api/profile-documents/upload",m,{headers:{"Content-Type":"multipart/form-data"}})).data.success&&(H.success("Document uploaded successfully"),d(!1),y(null),O(""),M([]),v==="admin"?ne():s&&z(s))}catch(m){console.error("Error uploading document:",m),H.error(m.response?.data?.error||"Failed to upload document")}finally{E(!1)}},W=async m=>{if(window.confirm("Are you sure you want to delete this document?"))try{await $.delete(`/api/profile-documents/${m}`),H.success("Document deleted successfully"),v==="admin"?ne():s&&z(s)}catch(A){console.error("Error deleting document:",A),H.error("Failed to delete document")}},Z=async m=>{S(m),I(!0);try{const A=await $.get(`/api/profile-documents/${m.id}/stats`);N(A.data)}catch(A){console.error("Error fetching document stats:",A),H.error("Failed to fetch document statistics")}},J=m=>{if(m===0)return"0 Bytes";const A=1024,G=["Bytes","KB","MB","GB"],X=Math.floor(Math.log(m)/Math.log(A));return parseFloat((m/Math.pow(A,X)).toFixed(2))+" "+G[X]},P=m=>new Date(m).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return e.jsxs(q,{p:3,children:[e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsx(f,{variant:"h4",component:"h1",children:"Profile Documents Management"}),e.jsxs(q,{display:"flex",gap:2,alignItems:"center",children:[e.jsxs(Dt,{size:"small",sx:{minWidth:120},children:[e.jsx(Tt,{children:"View Mode"}),e.jsxs(Ot,{value:v,onChange:m=>g(m.target.value),label:"View Mode",children:[e.jsx(ze,{value:"admin",children:"Admin View"}),e.jsx(ze,{value:"profile",children:"Profile View"})]})]}),e.jsx(K,{variant:"contained",startIcon:e.jsx(Di,{}),onClick:()=>d(!0),disabled:v==="profile"&&!s,children:"Upload Document"})]})]}),e.jsxs(T,{container:!0,spacing:3,children:[v==="profile"&&e.jsx(T,{item:!0,xs:12,md:4,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Select Profile"}),e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Profile"}),e.jsx(Ot,{value:s,onChange:m=>a(m.target.value),label:"Profile",children:t.map(m=>e.jsx(ze,{value:m.id,children:m.name},m.id))})]}),s&&e.jsx(q,{mt:2,children:e.jsx(f,{variant:"body2",color:"text.secondary",children:t.find(m=>m.id===s)?.email})})]})})}),e.jsx(T,{item:!0,xs:12,md:v==="profile"?8:12,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsxs(f,{variant:"h6",gutterBottom:!0,children:["Documents",e.jsx(Le,{label:`${n.length} documents`,size:"small",sx:{ml:2}})]}),v==="profile"&&!s?e.jsx(Re,{severity:"info",children:"Please select a profile to view documents."}):i?e.jsx(q,{display:"flex",justifyContent:"center",p:3,children:e.jsx(it,{})}):n.length===0?e.jsx(Re,{severity:"info",children:v==="admin"?"No documents found.":"No documents found for this profile."}):e.jsx(Kt,{children:e.jsxs(Yt,{size:"small",children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{children:"Document Name"}),e.jsx(re,{align:"center",children:"Size"}),e.jsx(re,{align:"center",children:"Type"}),v==="admin"?e.jsxs(e.Fragment,{children:[e.jsx(re,{align:"center",children:"Visible To"}),e.jsx(re,{align:"center",children:"Read Status"})]}):e.jsx(re,{align:"center",children:"Read Status"}),e.jsx(re,{align:"center",children:"Uploaded"}),e.jsx(re,{align:"center",children:"Actions"})]})}),e.jsx(Gt,{children:n.map(m=>e.jsxs(rt,{children:[e.jsxs(re,{children:[e.jsx(f,{variant:"body2",fontWeight:"medium",children:m.original_filename}),e.jsxs(f,{variant:"caption",color:"text.secondary",children:["by ",m.uploaded_by_name]})]}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"body2",children:J(m.file_size)})}),e.jsx(re,{align:"center",children:e.jsx(Le,{label:m.mime_type.split("/")[1]?.toUpperCase()||"FILE",size:"small",variant:"outlined"})}),v==="admin"?e.jsxs(e.Fragment,{children:[e.jsx(re,{align:"center",children:e.jsx(q,{display:"flex",flexWrap:"wrap",gap:.5,justifyContent:"center",children:m.profile_details&&m.profile_details.length>0?m.profile_details.map(A=>e.jsx(Le,{label:A.profile_name,size:"small",variant:"outlined",color:"primary"},A.profile_id)):m.visible_to_profiles?.map(A=>{const G=t.find(X=>X.id===A);return G?e.jsx(Le,{label:G.name,size:"small",variant:"outlined",color:"primary"},A):null})})}),e.jsx(re,{align:"center",children:e.jsx(q,{display:"flex",flexWrap:"wrap",gap:.5,justifyContent:"center",children:m.profile_details&&m.profile_details.length>0?m.profile_details.map(A=>e.jsx(Le,{label:A.has_read?"Read":"Unread",size:"small",color:A.has_read?"success":"default",icon:A.has_read?e.jsx(zs,{}):e.jsx($n,{}),title:`${A.profile_name}: ${A.has_read?"Read":"Unread"}`},A.profile_id)):m.visible_to_profiles?.map(A=>{const G=t.find(Y=>Y.id===A),X=m.profile_read_status?.[A]||!1;return G?e.jsx(Le,{label:X?"Read":"Unread",size:"small",color:X?"success":"default",icon:X?e.jsx(zs,{}):e.jsx($n,{}),title:`${G.name}: ${X?"Read":"Unread"}`},A):null})})})]}):e.jsx(re,{align:"center",children:e.jsx(Le,{label:m.profile_read_status?.[s]?"Read":"Unread",size:"small",color:m.profile_read_status?.[s]?"success":"default",icon:m.profile_read_status?.[s]?e.jsx(zs,{}):e.jsx($n,{})})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"body2",children:P(m.created_at)})}),e.jsxs(re,{align:"center",children:[e.jsx(ot,{size:"small",onClick:()=>Z(m),title:"View Statistics",children:e.jsx(zd,{})}),e.jsx(ot,{size:"small",component:"a",href:`/api/profile-documents/file/${m.id}`,target:"_blank",title:"Download",children:e.jsx(eu,{})}),e.jsx(ot,{size:"small",onClick:()=>W(m.id),title:"Delete",color:"error",children:e.jsx(ao,{})})]})]},m.id))})]})})]})})})]}),e.jsxs(lt,{open:u,onClose:()=>d(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ct,{children:"Upload Document"}),e.jsx(ut,{children:e.jsxs(q,{sx:{pt:2},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Select Profiles"}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Choose which profiles can see this document"}),e.jsx(Hd,{children:t.map(m=>e.jsx(ra,{control:e.jsx(Ba,{checked:k.includes(m.id),onChange:A=>{A.target.checked?M([...k,m.id]):M(k.filter(G=>G!==m.id))}}),label:e.jsxs(q,{children:[e.jsx(f,{variant:"body2",children:m.name}),e.jsx(f,{variant:"caption",color:"text.secondary",children:m.email})]})},m.id))}),e.jsx(ie,{fullWidth:!0,label:"Custom Document Name",value:w,onChange:m=>O(m.target.value),sx:{mb:2,mt:2},helperText:"Leave empty to use original filename"}),e.jsxs(q,{sx:{mb:2},children:[e.jsx("input",{type:"file",id:"file-upload",onChange:ae,style:{display:"none"},accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif"}),e.jsx("label",{htmlFor:"file-upload",children:e.jsx(K,{variant:"outlined",component:"span",startIcon:e.jsx(za,{}),fullWidth:!0,children:p?p.name:"Select File"})})]}),p&&e.jsxs(Re,{severity:"info",children:["Selected: ",p.name," (",J(p.size),")"]})]})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>d(!1),disabled:_,children:"Cancel"}),e.jsx(K,{onClick:ee,variant:"contained",disabled:!p||k.length===0||_,startIcon:_?e.jsx(it,{size:20}):e.jsx(za,{}),children:_?"Uploading...":"Upload"})]})]}),e.jsxs(lt,{open:b,onClose:()=>I(!1),maxWidth:"md",fullWidth:!0,children:[e.jsxs(ct,{children:["Document Statistics: ",U?.original_filename]}),e.jsx(ut,{children:e.jsxs(q,{sx:{pt:2},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Profile Read Status"}),e.jsx(f,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"View which profiles can see this document and their read status:"}),U&&e.jsx(Kt,{sx:{mt:2},children:e.jsxs(Yt,{size:"small",children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{children:"Profile"}),e.jsx(re,{children:"Email"}),e.jsx(re,{align:"center",children:"Read Status"}),e.jsx(re,{align:"center",children:"Read At"})]})}),e.jsx(Gt,{children:U.visible_to_profiles?.map(m=>{const A=t.find(Y=>Y.id===m),G=U.profile_read_status?.[m]||!1,X=j.find(Y=>Y.profile_id===m);return A?e.jsxs(rt,{children:[e.jsx(re,{children:e.jsx(f,{variant:"body2",fontWeight:"medium",children:A.name})}),e.jsx(re,{children:e.jsx(f,{variant:"body2",color:"text.secondary",children:A.email})}),e.jsx(re,{align:"center",children:e.jsx(Le,{label:G?"Read":"Unread",size:"small",color:G?"success":"default",icon:G?e.jsx(zs,{}):e.jsx($n,{})})}),e.jsx(re,{align:"center",children:X?e.jsx(f,{variant:"body2",children:P(X.read_at)}):e.jsx(f,{variant:"body2",color:"text.secondary",children:"-"})})]},m):null})})]})})]})}),e.jsx(dt,{children:e.jsx(K,{onClick:()=>I(!1),children:"Close"})})]})]})},i_=()=>{const[t,r]=l.useState([]),[s,a]=l.useState(!0),[n,o]=l.useState(!1),[i,c]=l.useState(!1),[u,d]=l.useState({margin_id:"",cost_lower_bound:"",cost_upper_bound:"",margin_factor:""}),[p,y]=l.useState(null),[w,O]=l.useState({page:0,pageSize:5}),[_,E]=l.useState(""),[b,I]=l.useState(!1),[U,S]=l.useState(""),[j,N]=l.useState(!1),[k,M]=l.useState(""),[v,g]=l.useState(!1),[L,z]=l.useState(""),[ne,ae]=l.useState(!1),[ee,W]=l.useState(""),[Z,J]=l.useState(!1),P=async()=>{try{const B=await $.get("/api/margin-schedule");r(B.data.map(Ee=>({...Ee,id:Ee.margin_id}))),a(!1),y(null)}catch(B){console.error("Error fetching margin schedules:",B),y("Failed to load margin schedules"),H.error("Failed to load margin schedules"),a(!1)}},m=async()=>{I(!0);try{const B=await $.get("/api/settings/labour-rate");E(B.data.labour_rate??"")}catch{E("")}finally{I(!1)}},A=async()=>{N(!0);try{const B=await $.get("/api/settings/overhead-rate");S(B.data.overhead_rate??"")}catch{S("")}finally{N(!1)}},G=async()=>{g(!0);try{const B=await $.get("/api/settings/supply-rate");M(B.data.supply_rate??"")}catch{M("")}finally{g(!1)}},X=async()=>{ae(!0);try{const B=await $.get("/api/settings/daily-break-start");z(B.data.daily_break_start??"")}catch{z("")}finally{ae(!1)}},Y=async()=>{J(!0);try{const B=await $.get("/api/settings/daily-break-end");W(B.data.daily_break_end??"")}catch{W("")}finally{J(!1)}};l.useEffect(()=>{P(),m(),A(),G(),X(),Y()},[]);const fe=()=>{c(!1),d({margin_id:"",cost_lower_bound:"",cost_upper_bound:"",margin_factor:""}),o(!0)},se=B=>{c(!0),d({margin_id:B.margin_id,cost_lower_bound:String(B.cost_lower_bound),cost_upper_bound:String(B.cost_upper_bound),margin_factor:String(B.margin_factor)}),o(!0)},ke=async B=>{if(window.confirm("Are you sure you want to delete this margin schedule?"))try{await $.delete(`/api/margin-schedule/${B}`),H.success("Margin schedule deleted successfully"),P()}catch(Ee){console.error("Error deleting margin schedule:",Ee),H.error("Failed to delete margin schedule")}},Pe=()=>{o(!1)},ge=B=>{const{name:Ee,value:Se}=B.target;d($e=>({...$e,[Ee]:Se}))},me=async B=>{B.preventDefault();try{i?(await $.put(`/api/margin-schedule/${u.margin_id}`,{cost_lower_bound:parseFloat(u.cost_lower_bound),cost_upper_bound:parseFloat(u.cost_upper_bound),margin_factor:parseFloat(u.margin_factor)}),H.success("Margin schedule updated successfully")):(await $.post("/api/margin-schedule",{schedule:[{cost_lower_bound:parseFloat(u.cost_lower_bound),cost_upper_bound:parseFloat(u.cost_upper_bound),margin_factor:parseFloat(u.margin_factor)}]}),H.success("Margin schedule created successfully")),Pe(),P()}catch(Ee){console.error("Error saving margin schedule:",Ee),H.error("Failed to save margin schedule")}},be=async()=>{I(!0);try{await $.put("/api/settings/labour-rate",{labour_rate:Number(_)}),m()}catch{}finally{I(!1)}},je=async()=>{N(!0);try{await $.put("/api/settings/overhead-rate",{overhead_rate:Number(U)}),A()}catch{}finally{N(!1)}},oe=async()=>{g(!0);try{await $.put("/api/settings/supply-rate",{supply_rate:Number(k)}),G(),H.success("Supply rate updated successfully")}catch{H.error("Failed to update supply rate")}finally{g(!1)}},D=async()=>{ae(!0);try{await $.put("/api/settings/daily-break-start",{daily_break_start:L}),X(),H.success("Daily break start time updated successfully")}catch{H.error("Failed to update daily break start time")}finally{ae(!1)}},F=async()=>{J(!0);try{await $.put("/api/settings/daily-break-end",{daily_break_end:ee}),Y(),H.success("Daily break end time updated successfully")}catch{H.error("Failed to update daily break end time")}finally{J(!1)}},te=[{field:"margin_id",headerName:"ID",flex:.5,minWidth:60,headerAlign:"center",align:"center"},{field:"cost_lower_bound",headerName:"Cost Lower Bound",flex:1,minWidth:120,type:"number",headerAlign:"center",align:"center"},{field:"cost_upper_bound",headerName:"Cost Upper Bound",flex:1,minWidth:120,type:"number",headerAlign:"center",align:"center"},{field:"margin_factor",headerName:"Margin Factor",flex:1,minWidth:120,type:"number",headerAlign:"center",align:"center"},{field:"actions",headerName:"Actions",width:80,sortable:!1,headerAlign:"center",align:"center",renderCell:B=>e.jsx(ot,{size:"small",color:"error",onClick:Ee=>{Ee.stopPropagation(),ke(B.row.margin_id)},children:e.jsx(tr,{})})}];return e.jsxs(Qe,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(f,{variant:"h4",gutterBottom:!0,children:"Global Variables"}),e.jsxs(tt,{direction:"row",spacing:2,children:[e.jsx(K,{variant:"contained",onClick:fe,startIcon:e.jsx(vr,{}),children:"New Entry"}),e.jsx(K,{variant:"contained",onClick:P,children:"Refresh"})]})]}),e.jsx(qe,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsx(q,{sx:{p:2},children:e.jsx(Mr,{rows:t,columns:te,getRowId:B=>B.id,paginationModel:w,onPaginationModelChange:B=>O(B),pageSizeOptions:[5,10,20],loading:s,disableRowSelectionOnClick:!0,onRowClick:B=>se(B.row),sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"},cursor:"pointer"}})})}),e.jsx(qe,{sx:{width:"100%",overflow:"hidden",mb:3,p:2},children:e.jsxs(q,{sx:{display:"flex",gap:4,alignItems:"flex-start"},children:[e.jsxs(q,{sx:{flex:1},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Labour Hourly Rate"}),e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(ie,{label:"Hourly Rate ($)",type:"number",value:_,onChange:B=>E(B.target.value===""?"":Number(B.target.value)),disabled:b,InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:"$"})},sx:{maxWidth:200}}),e.jsx(K,{variant:"contained",onClick:be,disabled:b||_==="",children:"Save"})]})]}),e.jsxs(q,{sx:{flex:1},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Overhead Hourly Rate"}),e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(ie,{label:"Hourly Rate ($)",type:"number",value:U,onChange:B=>S(B.target.value===""?"":Number(B.target.value)),disabled:j,InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:"$"})},sx:{maxWidth:200}}),e.jsx(K,{variant:"contained",onClick:je,disabled:j||U==="",children:"Save"})]})]}),e.jsxs(q,{sx:{flex:1},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Supply Percentage"}),e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(ie,{label:"Percentage (%)",type:"number",value:k,onChange:B=>M(B.target.value===""?"":Number(B.target.value)),disabled:v,InputProps:{endAdornment:e.jsx(Xt,{position:"end",children:"%"})},sx:{maxWidth:200}}),e.jsx(K,{variant:"contained",onClick:oe,disabled:v||k==="",children:"Save"})]})]}),e.jsxs(q,{sx:{flex:1},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Daily Break Times"}),e.jsxs(q,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(ie,{label:"Break Start (HH:MM)",type:"time",value:L,onChange:B=>z(B.target.value),disabled:ne,InputLabelProps:{shrink:!0},sx:{maxWidth:200}}),e.jsx(K,{variant:"contained",onClick:D,disabled:ne||L==="",children:"Save Start"}),e.jsx(ie,{label:"Break End (HH:MM)",type:"time",value:ee,onChange:B=>W(B.target.value),disabled:Z,InputLabelProps:{shrink:!0},sx:{maxWidth:200}}),e.jsx(K,{variant:"contained",onClick:F,disabled:Z||ee==="",children:"Save End"})]})]})]})}),e.jsxs(lt,{open:n,onClose:Pe,children:[e.jsx(ct,{children:i?"Edit Margin Entry":"Add New Margin Entry"}),e.jsx(ut,{children:e.jsxs(tt,{spacing:2,mt:1,children:[e.jsx(ie,{label:"Cost Lower Bound",name:"cost_lower_bound",value:u.cost_lower_bound,onChange:ge,fullWidth:!0,type:"number"}),e.jsx(ie,{label:"Cost Upper Bound",name:"cost_upper_bound",value:u.cost_upper_bound,onChange:ge,fullWidth:!0,type:"number"}),e.jsx(ie,{label:"Margin Factor",name:"margin_factor",value:u.margin_factor,onChange:ge,fullWidth:!0,type:"number"})]})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:Pe,children:"Cancel"}),e.jsx(K,{onClick:me,children:i?"Save Changes":"Add Entry"})]})]})]})};var Ds={},jc;function l_(){if(jc)return Ds;jc=1;var t=At();Object.defineProperty(Ds,"__esModule",{value:!0}),Ds.default=void 0;var r=t(Rt()),s=Mt();return Ds.default=(0,r.default)((0,s.jsx)("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4z"}),"Refresh"),Ds}var c_=l_();const ta=vt(c_);var Ts={},wc;function u_(){if(wc)return Ts;wc=1;var t=At();Object.defineProperty(Ts,"__esModule",{value:!0}),Ts.default=void 0;var r=t(Rt()),s=Mt();return Ts.default=(0,r.default)((0,s.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"}),"CheckCircle"),Ts}var d_=u_();const oa=vt(d_);var Os={},Sc;function p_(){if(Sc)return Os;Sc=1;var t=At();Object.defineProperty(Os,"__esModule",{value:!0}),Os.default=void 0;var r=t(Rt()),s=Mt();return Os.default=(0,r.default)((0,s.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-2h2zm0-4h-2V7h2z"}),"Error"),Os}var h_=p_();const Co=vt(h_);var Is={},Cc;function m_(){if(Cc)return Is;Cc=1;var t=At();Object.defineProperty(Is,"__esModule",{value:!0}),Is.default=void 0;var r=t(Rt()),s=Mt();return Is.default=(0,r.default)((0,s.jsx)("path",{d:"M6 2v6h.01L6 8.01 10 12l-4 4 .01.01H6V22h12v-5.99h-.01L18 16l-4-4 4-3.99-.01-.01H18V2zm10 14.5V20H8v-3.5l4-4zm-4-5-4-4V4h8v3.5z"}),"HourglassEmpty"),Is}var f_=m_();const gd=vt(f_),g_=()=>{const[t,r]=l.useState(""),[s,a]=l.useState([]),[n,o]=l.useState("open"),[i,c]=l.useState(0),u=qt(),d=cn(),{user:p}=Qt(),[y,w]=l.useState(!1),[O,_]=l.useState({page:0,pageSize:10}),E=async(k=n)=>{try{const M=p?.access_role==="Sales and Purchase"?"open":k,g=(await $.get("/api/sales-orders",{params:{status:M,_ts:Date.now()}})).data.sort((z,ne)=>{const ae=Z=>{const J=Z.match(/\d+/);return J?parseInt(J[0],10):0},ee=ae(z.sales_order_number);return ae(ne.sales_order_number)-ee}),L=g.map(z=>({...z,id:z.sales_order_id,subtotal:Number(z.subtotal)||0,total_gst_amount:Number(z.total_gst_amount)||0,total_amount:Number(z.total_amount)||0}));if(a(L),k==="open"||k==="all"){const ne=(k==="open"?g:g.filter(ae=>ae.status==="Open")).reduce((ae,ee)=>{const W=parseFloat(ee.subtotal)||0;return ae+W},0);c(ne)}else c(0)}catch(M){console.error("Error fetching sales orders:",M),a([]),c(0)}};l.useEffect(()=>{E(n)},[n,p?.access_role]),l.useEffect(()=>{setTimeout(()=>{E(n)},500)},[d.key]),l.useEffect(()=>{const k=()=>E(n),M=()=>{document.visibilityState==="visible"&&E(n)};return window.addEventListener("focus",k),document.addEventListener("visibilitychange",M),()=>{window.removeEventListener("focus",k),document.removeEventListener("visibilitychange",M)}},[n]);const b=async k=>{if(window.confirm("Are you sure you want to delete this Sales Order? This action cannot be undone."))try{await $.delete(`/api/sales-orders/${k}`),H.success("Sales Order deleted successfully!"),E()}catch(M){console.error("Error deleting sales order:",M),H.error("Failed to delete sales order.")}},I=s.filter(k=>k.sales_order_number?.toLowerCase().includes(t.toLowerCase())||k.customer_name?.toLowerCase().includes(t.toLowerCase())||k.product_name?.toLowerCase().includes(t.toLowerCase())||k.product_description?.toLowerCase().includes(t.toLowerCase())),U=[{field:"sales_order_number",headerName:"Sales Order #",flex:1,minWidth:120,valueFormatter:k=>k.value?String(k.value).replace("SO-",""):""},{field:"customer_name",headerName:"Customer",flex:1.3,minWidth:150},{field:"product_name",headerName:"Product Name",flex:1,minWidth:120},{field:"product_description",headerName:"Product Description",flex:1.5,minWidth:150},{field:"subtotal",headerName:"Subtotal",flex:.8,minWidth:100,valueFormatter:k=>k.value!=null&&!isNaN(Number(k.value))?`$${Number(k.value).toFixed(2)}`:"$0.00"},{field:"total_gst_amount",headerName:"GST",flex:.7,minWidth:80,valueFormatter:k=>k.value!=null&&!isNaN(Number(k.value))?`$${Number(k.value).toFixed(2)}`:"$0.00"},{field:"total_amount",headerName:"Total",flex:.8,minWidth:100,valueFormatter:k=>k.value!=null&&!isNaN(Number(k.value))?`$${Number(k.value).toFixed(2)}`:"$0.00"},{field:"status",headerName:"Status",flex:.8,minWidth:100,renderCell:k=>e.jsx(Le,{label:k.value,color:k.value==="Open"?"success":"error",size:"small",variant:"outlined"})},{field:"exported_to_qbo",headerName:"QBO Exported",flex:.8,minWidth:120,renderCell:k=>k.row.exported_to_qbo?e.jsx(oa,{color:"success",titleAccess:"Exported to QuickBooks"}):k.row.qbo_export_status?e.jsx(Co,{color:"error",titleAccess:`QBO Export Error: ${k.row.qbo_export_status}`}):k.row.status==="Closed"?e.jsx(gd,{color:"warning",titleAccess:"Not exported to QuickBooks"}):null},{field:"actions",headerName:"Actions",width:100,sortable:!1,renderCell:k=>e.jsx(q,{sx:{display:"flex",gap:.5},children:k.row.status!=="Closed"&&e.jsx(ot,{size:"small",color:"error",onClick:M=>{M.stopPropagation(),b(k.row.sales_order_id)},children:e.jsx(tr,{})})})}],S=()=>{setTimeout(()=>{E()},500)},j=()=>{let k=I;n==="open"?k=I.filter(L=>L.status==="Open"):n==="closed"&&(k=I.filter(L=>L.status==="Closed"));const M=un.unparse(k.map(L=>{const z={};return U.forEach(ne=>{if(ne.field!=="actions"){const ae=L[ne.field];ne.field==="bill_date"||ne.field==="sales_date"?z[ne.headerName]=ae?new Date(ae).toLocaleDateString():"":ne.type==="number"?z[ne.headerName]=ae!=null&&!isNaN(parseFloat(String(ae)))?parseFloat(String(ae)).toFixed(2):"":z[ne.headerName]=ae!==void 0?String(ae):""}}),z})),v=new Blob([M],{type:"text/csv;charset=utf-8;"}),g=document.createElement("a");if(g.download!==void 0){const L=URL.createObjectURL(v);g.setAttribute("href",L),g.setAttribute("download","open_sales_orders.csv"),g.style.visibility="hidden",document.body.appendChild(g),g.click(),document.body.removeChild(g)}},N=k=>{if(console.log("OpenSalesOrdersPage: Row clicked:",k.row),console.log("OpenSalesOrdersPage: User role:",p?.access_role),console.log("OpenSalesOrdersPage: Sales order ID:",k.row.sales_order_id),p?.access_role==="Time Tracking"){const M=`/worker-sales-orders/${k.row.sales_order_id}`;console.log("OpenSalesOrdersPage: Navigating time tracking user to:",M),u(M)}else{const M=`/open-sales-orders/${k.row.sales_order_id}`;console.log("OpenSalesOrdersPage: Navigating regular user to:",M),u(M)}};return p?.access_role==="Time Tracking"?e.jsxs(Qe,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(q,{sx:{mb:4},children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:"Sales Orders"}),e.jsx(q,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:e.jsx(K,{variant:"outlined",startIcon:e.jsx(ta,{}),onClick:S,children:"Refresh"})})]}),e.jsx(qe,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(q,{sx:{p:2},children:[e.jsx(tt,{direction:"row",spacing:3,sx:{mb:2},children:e.jsx(ie,{label:"Search",variant:"outlined",value:t,onChange:k=>r(k.target.value),InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:e.jsx(yr,{sx:{fontSize:22}})})},sx:{minWidth:340,maxWidth:400,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"small"})}),e.jsx(Mr,{rows:I,columns:U.filter(k=>k.field!=="actions"),loading:!1,paginationModel:O,onPaginationModelChange:_,pageSizeOptions:[10,25,50],getRowId:k=>k.id,onRowClick:N,disableRowSelectionOnClick:!0,initialState:{sorting:{sortModel:[{field:"sales_order_number",sort:"desc"}]}},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]}):e.jsxs(Qe,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(q,{sx:{mb:4},children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:p?.access_role==="Sales and Purchase"?"Sales Orders (Open Only)":"Sales Orders"}),(n==="open"||n==="all")&&e.jsxs(q,{sx:{mb:2,p:2,bgcolor:"background.paper",borderRadius:1,border:"1px solid",borderColor:"divider"},children:[e.jsxs(f,{variant:"h6",component:"div",sx:{fontWeight:"bold",color:"primary.main"},children:["Work In Process: $",i.toFixed(2)]}),e.jsx(f,{variant:"body2",color:"text.secondary",children:"Total subtotal value of all open sales orders"})]}),e.jsx(q,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:e.jsxs(tt,{direction:"row",spacing:2,children:[p?.access_role!=="Time Tracking"&&e.jsx(K,{variant:"contained",startIcon:e.jsx(vr,{}),onClick:()=>u("/open-sales-orders/new"),children:"New SO"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(or,{}),onClick:j,children:"Export CSV"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(ta,{}),onClick:S,children:"Refresh"})]})})]}),e.jsx(qe,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(q,{sx:{p:2},children:[e.jsxs(tt,{direction:"row",spacing:3,sx:{mb:2},children:[e.jsx(ie,{label:"Search",variant:"outlined",value:t,onChange:k=>r(k.target.value),InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:e.jsx(yr,{sx:{fontSize:22}})})},sx:{minWidth:340,maxWidth:400,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"small"}),p?.access_role!=="Sales and Purchase"&&e.jsx(Le,{label:"All",onClick:()=>o("all"),color:n==="all"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),e.jsx(Le,{label:"Open",onClick:()=>o("open"),color:n==="open"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),p?.access_role!=="Sales and Purchase"&&e.jsx(Le,{label:"Closed",onClick:()=>o("closed"),color:n==="closed"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}})]}),e.jsx(Mr,{rows:I,columns:U,loading:!1,paginationModel:O,onPaginationModelChange:_,pageSizeOptions:[10,25,50],getRowId:k=>k.id,onRowClick:N,disableRowSelectionOnClick:!0,initialState:{sorting:{sortModel:[{field:"sales_order_number",sort:"desc"}]}},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})})]})},Sa=(t,r)=>{const s=parseFloat(String(t))||0,a=parseFloat(String(r))||0;return Math.round(s*a*100)/100},Or=t=>{const r=parseFloat(String(t));return isNaN(r)?0:r},Ca=["Each","cm","ft","kg","pcs","hr","L"],xn=5,ro=t=>t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim().toUpperCase(),x_=(t,r,s=8)=>{const a=ro(r);if(!a)return t.slice(0,s);const n=t.map(o=>{const i=ro(o.label);let c=-1;return i.startsWith(a)?c=3:i.split(" ").some(u=>u.startsWith(a))?c=2:i.includes(a)&&(c=1),{opt:o,score:c}}).filter(o=>o.score>=0);return n.sort((o,i)=>i.score-o.score||o.opt.label.localeCompare(i.opt.label)),n.slice(0,s).map(o=>o.opt)},y_=()=>{const{id:t}=Dn(),r=t==="new",s=!!t&&/^\d+$/.test(t),a=qt(),{user:n}=Qt(),o=n?.access_role==="Sales and Purchase",[i,c]=l.useState([]),[u,d]=l.useState([]),[p,y]=l.useState([]),[w,O]=l.useState([]),[_,E]=l.useState(null),[b,I]=l.useState(null),[U,S]=l.useState(null),[j,N]=l.useState(null),[k,M]=l.useState(""),[v,g]=l.useState(!1),[L,z]=l.useState(null),[ne,ae]=l.useState(!1),ee=l.useRef(null),[W,Z]=l.useState(null),[J,P]=l.useState(""),[m,A]=l.useState(!1),[G,X]=l.useState(null),[Y,fe]=l.useState(Ze()),[se,ke]=l.useState(""),[Pe,ge]=l.useState(""),[me,be]=l.useState(""),[je,oe]=l.useState(""),[D,F]=l.useState(null),[te,B]=l.useState([]);l.useMemo(()=>te.map(h=>({part_number:h.part_number,part_description:h.part_description,quantity:Or(h.quantity),unit:h.unit,unit_price:h.unit_price})),[te]);const Ee=l.useMemo(()=>{if(!te||te.length===0)return{subtotal:0,total_gst_amount:0,total_amount:0};const h=te.reduce((R,V)=>{const pe=V.line_amount||0;return R+pe},0),x=h*.05,C=h+x;return{subtotal:Math.round(h*100)/100,total_gst_amount:Math.round(x*100)/100,total_amount:Math.round(C*100)/100}},[te]),Se=Ee.subtotal,$e=Ee.total_gst_amount,He=Ee.total_amount,[De,et]=l.useState(null),[Ve,Be]=l.useState(!r),[Ke,We]=l.useState(null),[pt,kt]=l.useState(null),[at,Ct]=l.useState([]),[Et,jt]=l.useState(""),[Pt,Wt]=l.useState(!1),[ir,ye]=l.useState(!1),de=l.useCallback(h=>JSON.stringify((h||[]).map(x=>({part_number:(x.part_number||"").trim(),part_description:(x.part_description||"").trim(),quantity:Or(x.quantity),unit:(x.unit||"").trim(),unit_price:Or(x.unit_price)})).sort((x,C)=>x.part_number!==C.part_number?x.part_number.localeCompare(C.part_number):x.quantity-C.quantity)),[]),_e=l.useCallback(()=>({customer:j?{id:j.id,label:j.label}:null,product:W?{id:W.id,label:W.label}:null,salesDate:Y?Y.toISOString():null,terms:(Pe||"").trim(),customerPoNumber:(me||"").trim(),vinNumber:(je||"").trim(),estimatedCost:D!=null?Number(D):null}),[j,W,Y,Pe,me,je,D]);l.useEffect(()=>{if(Pt&&Et===""){const h=JSON.stringify({header:_e(),lineItems:de(te)});jt(h)}},[Pt,Et,_e,de,te]);const ue=l.useMemo(()=>JSON.stringify({header:_e(),lineItems:de(te)}),[_e,de,te]),Ce=!!Et&&Et!==ue&&!ir,Ie=!!De&&De.status?.toLowerCase()==="closed",[le,ce]=l.useState([]),[we,Oe]=l.useState([]),[Xe,xe]=l.useState(null),[Fe,Ge]=l.useState(null),[It,rr]=l.useState(null),[_r,Lr]=l.useState(null),[dr,Ht]=l.useState(null),[Er,br]=l.useState(null),[pr,fr]=l.useState(!1),[Jt,Zt]=l.useState(null),[Yr,Dr]=l.useState(""),[qr,jr]=l.useState(!1),[dn,gr]=l.useState(null),[On,Vr]=l.useState(""),pn=we.length>0?8+64*we.length:0;l.useMemo(()=>JSON.stringify(te.map(h=>({part_number:h.part_number,part_description:h.part_description,quantity:h.quantity,unit:h.unit,unit_price:h.unit_price,line_amount:h.line_amount}))),[te]);const rs=(h,x)=>{const C=(te[h]?.part_number||"").trim(),R=x.key==="Enter",V=x.key==="Tab",pe=x.key==="Escape",he=x.key==="ArrowDown"||x.key==="ArrowUp";if(pe){Ge(null);return}if(he){x.key==="ArrowDown"&&Fe!==h&&Ge(h);return}if(!(Fe===h&&(R||V))&&(R||V)&&C){if(R&&x.ctrlKey){x.preventDefault(),Lr(h),Dr(C.toUpperCase()),Zt(h),fr(!0),Ge(null);return}!p.find(Ye=>Ye.part_number.toUpperCase()===C.toUpperCase())&&R&&(x.preventDefault(),Lr(h),Dr(C.toUpperCase()),Zt(h),fr(!0),Ge(null))}},ia=(h,x)=>{const C=(at[h]?.part_number||"").trim(),R=x.key==="Enter",V=x.key==="Tab",pe=x.key==="Escape",he=x.key==="ArrowDown"||x.key==="ArrowUp";if(pe){Ht(null);return}if(he){x.key==="ArrowDown"&&dr!==h&&Ht(h);return}if(!(dr===h&&(R||V))&&(R||V)&&C){if(R&&x.ctrlKey){x.preventDefault(),br(h),Vr(C.toUpperCase()),gr(h),jr(!0),Ht(null);return}!p.find(Ye=>Ye.part_number.toUpperCase()===C.toUpperCase())&&R&&(x.preventDefault(),br(h),Vr(C.toUpperCase()),gr(h),jr(!0),Ht(null))}},Gr=h=>i.find(x=>ro(x.label)===ro(h))||null,[la,Qr]=l.useState(!1),[Po,Jr]=l.useState(""),[ns,In]=l.useState(!1),[ss,hn]=l.useState(""),[as,mn]=l.useState(!1),[ca,Eo]=l.useState([]),[An,ua]=l.useState(null),[Ur,Mn]=l.useState(!1),[Wr,Do]=l.useState(!1),[os,fn]=l.useState(null),[To,is]=l.useState(null),[Oo,Fr]=l.useState(null);l.useEffect(()=>{(async()=>{try{const[h,x,C,R]=await Promise.all([$.get("/api/customers"),$.get("/api/products"),$.get("/api/inventory"),$.get("/api/margin-schedule")]);c(h.data.map(V=>({label:V.customer_name,id:V.customer_id}))),d(x.data.map(V=>({label:V.product_name,id:V.product_id,description:V.product_description}))),y(C.data),O(R.data),r&&Wt(!0)}catch(h){console.error("Prefetch failed",h)}})()},[]),l.useEffect(()=>{(async()=>{try{const[h,x,C]=await Promise.all([$.get("/api/settings/labour-rate").catch(()=>({data:{labour_rate:null}})),$.get("/api/settings/overhead-rate").catch(()=>({data:{overhead_rate:null}})),$.get("/api/settings/supply-rate").catch(()=>({data:{supply_rate:null}}))]);E(h.data.labour_rate??null),I(x.data.overhead_rate??null),S(C.data.supply_rate??null)}catch{}})()},[]),l.useEffect(()=>{if(!t||r||!s){r&&(B([{part_number:"",part_description:"",quantity:"",unit:Ca[0],unit_price:0,gst:xn,line_amount:0}]),Wt(!0));return}(async()=>{Be(!0),We(null);try{const x=(await $.get(`/api/sales-orders/${t}`)).data;et(x.salesOrder);const C=(x.lineItems||x.salesOrder?.line_items||[]).map(he=>({part_number:he.part_number,part_description:he.part_description,unit:he.unit,unit_price:he.unit_price,line_amount:Number(he.line_amount||0),quantity:he.part_number==="SUPPLY"?"1":["LABOUR","OVERHEAD"].includes(he.part_number)?String(he.quantity_sold||0):String(he.quantity_sold??he.quantity??0),gst:xn,part_id:he.part_id??void 0}));console.log("[SalesOrderDetail] Raw line items from backend:",x.lineItems),console.log("[SalesOrderDetail] Mapped line items:",C),B(C),ce(C);const R=(x.partsToOrder||[]).map(he=>({sales_order_id:parseInt(t),part_number:he.part_number,part_description:he.part_description,quantity_to_order:String(he.quantity_needed||0),unit:he.unit||"Each",unit_price:Number(he.unit_price||0),line_amount:Number(he.line_amount||0)}));Ct(R),fe(Ze(x.salesOrder?.sales_date)),F(x.salesOrder?.estimated_cost||0),ke(x.salesOrder?.product_description||""),ge(x.salesOrder?.terms||""),be(x.salesOrder?.customer_po_number||""),oe(x.salesOrder?.vin_number||"");const V=i.find(he=>he.id===x.salesOrder?.customer_id)||{label:x.salesOrder?.customer_name||"",id:x.salesOrder?.customer_id};N(V?.id?V:null);const pe=u.find(he=>he.label===x.salesOrder?.product_name)||{label:x.salesOrder?.product_name||""};Z(pe?.label?pe:null)}catch(h){console.error(h),We(h?.response?.status===404?"Sales order not found. It may have been deleted.":"Failed to load sales order data. Please try again.")}finally{Be(!1),Wt(!0)}})()},[t,r,s]),l.useEffect(()=>{Pt&&_!==null&&B(h=>h.map(x=>x.part_number!=="LABOUR"?x:x.unit_price!==_?{...x,unit_price:_}:x))},[_,Pt]),l.useEffect(()=>{Pt&&b!==null&&B(h=>h.map(x=>x.part_number!=="OVERHEAD"?x:x.unit_price!==b?{...x,unit_price:b}:x))},[b,Pt]),l.useEffect(()=>{Pt&&B(h=>{const x=h.some(R=>R.part_number==="LABOUR"),C=h.some(R=>R.part_number==="SUPPLY");if(U&&U>0){if(x&&!C)return[...h,{part_number:"SUPPLY",part_description:"Supply",quantity:r?"":"1",unit:r?"":"Each",unit_price:0,gst:xn,line_amount:0}];if(!x&&C)return h.filter(R=>R.part_number!=="SUPPLY")}else if(C)return h.filter(R=>R.part_number!=="SUPPLY");return h})},[U,te,Pt,r]);const ls=h=>{const x=[...w].sort((C,R)=>C.cost_lower_bound-R.cost_lower_bound);for(const C of x){const R=+C.cost_lower_bound,V=C.cost_upper_bound==null?null:+C.cost_upper_bound,pe=+C.margin_factor;if(h>=R&&(V===null||h<V))return pe}return 1},Qi=h=>p.find(x=>x.part_number===h),Io=(h,x)=>{B(C=>{const R=[...C];if(!x||x.trim()==="")R[h]={...R[h],part_number:"",part_description:"",quantity:"",unit:Ca[0],unit_price:0,line_amount:0};else if(x.toUpperCase()==="LABOUR")R[h]={...R[h],part_number:"LABOUR",part_description:"Labour",unit:"hr",unit_price:_??0,line_amount:0};else if(x.toUpperCase()==="OVERHEAD")R[h]={...R[h],part_number:"OVERHEAD",part_description:"Overhead",unit:"hr",unit_price:b??0,line_amount:0};else if(x.toUpperCase()==="SUPPLY")R[h]={...R[h],part_number:"SUPPLY",part_description:"Supply",unit:r?"":"Each",unit_price:0,line_amount:0};else{const V=Qi(x);if(V){const pe=parseFloat(String(V.last_unit_cost))||0,he=ls(pe);R[h]={...R[h],part_number:x,part_description:V.part_description||"",unit:V.unit,unit_price:pe*he,line_amount:0}}else R[h]={...R[h],part_number:x,part_description:"Part not found",unit_price:0,line_amount:0}}return R})},Ji=(h,x,C)=>{B(R=>{const V=[...R],pe={...V[h],[x]:C};return parseFloat(C)<=0&&pe.part_number!=="SUPPLY"?V.filter((he,Te)=>Te!==h):(["LABOUR","OVERHEAD"].includes(pe.part_number),V[h]=pe,V)})},Ki=()=>{B(h=>[...h,{part_number:"",part_description:"",quantity:"",unit:Ca[0],unit_price:0,gst:xn,line_amount:0}])},Xi=h=>{B(x=>x.filter((C,R)=>R!==h))},da=(h,x)=>{if(["LABOUR","OVERHEAD","SUPPLY"].includes(h.part_number))return null;const C=p.find(Je=>Je.part_number.toLowerCase()===h.part_number.toLowerCase());if(!C||C.part_type==="supply")return null;const R=parseFloat(C.quantity_on_hand)||0;if(r){const Je=te.filter($r=>$r.part_number.toLowerCase()===h.part_number.toLowerCase()).reduce(($r,fa)=>$r+(parseFloat(String(fa.quantity).replace(/[^\d.-]/g,""))||0),0),Nt=R-Je;return{available:Nt<0?Math.floor(Nt):Math.round(Nt),isNegative:Nt<0,currentStock:R,changeInQuantity:Je,totalQuantityForPart:Je,totalOriginalQuantityForPart:0}}const V=te.filter(Je=>Je.part_number.toLowerCase()===h.part_number.toLowerCase()).reduce((Je,Nt)=>Je+(parseFloat(String(Nt.quantity).replace(/[^\d.-]/g,""))||0),0),pe=le.filter(Je=>Je.part_number.toLowerCase()===h.part_number.toLowerCase()).reduce((Je,Nt)=>Je+(parseFloat(String(Nt.quantity).replace(/[^\d.-]/g,""))||0),0),he=V-pe,Te=R-he,Ye=Te<0?Math.floor(Te):Math.round(Te);return{available:Ye,isNegative:Ye<0,currentStock:R,changeInQuantity:he,totalQuantityForPart:V,totalOriginalQuantityForPart:pe}},pa=l.useMemo(()=>te.map((h,x)=>da(h)),[te,p,le,r]);l.useEffect(()=>{if(r)return;const h=[];te.forEach((x,C)=>{const R=da(x);R&&R.available<0&&h.push({lineItemIndex:C,partNumber:x.part_number,partDescription:x.part_description,excessQuantity:Math.abs(R.available),unit:x.unit})}),Oe(h)},[te,p,r]);const Zi=()=>{if(je&&je.trim()!==""&&je.trim().length!==17)return H.error("VIN must be 17 characters"),!1;if(te.filter(R=>!R.part_number||R.part_number.trim()==="").length>0)return H.error("Line items with blank part numbers are not allowed."),!1;const x=te.filter(R=>{if(["LABOUR","OVERHEAD","SUPPLY"].includes(String(R.part_number).toUpperCase()))return!1;const V=R.part_id;if(V){const he=(p||[]).find(Te=>Te.part_id===V);return he?he.part_type==="supply":!1}const pe=(p||[]).find(he=>String(he.part_number).toUpperCase()===String(R.part_number).trim().toUpperCase());return!pe||pe.part_type==="supply"});if(x.length>0){const R=x.map(V=>V.part_number).join(", ");return H.error(`Invalid or supply parts (not allowed): ${R}`),!1}return te.some((R,V)=>{const pe=da(R);return pe&&pe.available<0})?(Fr("Insufficient inventory for one or more parts."),!1):(Fr(null),!0)},ha=h=>{const x=h.reduce((C,R)=>{const V=R.part_number.trim().toLowerCase();if(!C[V]){const pe=["LABOUR","OVERHEAD","SUPPLY"].includes(R.part_number.toUpperCase())?null:(p||[]).find(he=>String(he.part_number).toUpperCase()===R.part_number.trim().toUpperCase());C[V]={part_number:R.part_number.trim(),part_description:R.part_description.trim(),unit:R.unit.trim(),unit_price:R.unit_price!=null?Number(R.unit_price):0,line_amount:0,quantity_sold:0,...R.part_id?{part_id:R.part_id}:pe&&pe.part_id?{part_id:pe.part_id}:{}}}if(R.part_number.toUpperCase()==="SUPPLY")C[V].quantity_sold=1,C[V].unit="Each",C[V].unit_price=0,C[V].line_amount+=Number(R.line_amount||0);else if(["LABOUR","OVERHEAD"].includes(R.part_number.toUpperCase())){const pe=parseFloat(String(R.quantity).replace(/[^\d.-]/g,""))||0;C[V].quantity_sold=pe,C[V].line_amount=Number(R.line_amount||0)}else{const pe=parseFloat(String(R.quantity).replace(/[^\d.-]/g,""))||0;C[V].quantity_sold+=Math.round(pe),C[V].line_amount+=pe*(R.unit_price||0)}return C},{});return Object.values(x)},cs=async()=>{if(!j||!Y||!W){H.error("Please fill in required fields.");return}if(!Zi())return;const h={customer_id:j?.id,sales_date:Y?Y.toISOString():new Date().toISOString(),product_name:W?.label?.trim(),product_description:se.trim(),terms:Pe.trim(),customer_po_number:me.trim(),vin_number:je.trim(),status:r?"Open":De?.status||"Open",estimated_cost:D!=null?Number(D):0,lineItems:ha(te)};ye(!0);try{if(r){if(window.__soCreateInFlight){console.log("[SO] Skipping duplicate create (in flight)");return}window.__soCreateInFlight=!0;const x=await $.post("/api/sales-orders",h);H.success("Sales Order created successfully!"),window.__unsavedGuardAllowNext=!0,a(`/open-sales-orders/${x.data.sales_order_id}`)}else{const x=at.filter(C=>C.part_number&&parseFloat(String(C.quantity_to_order))>0).map(C=>({sales_order_id:Number(t),part_number:C.part_number.trim(),part_description:C.part_description.trim(),quantity_needed:parseFloat(String(C.quantity_to_order))||0,unit:C.unit.trim(),unit_price:C.unit_price,line_amount:C.line_amount}));await $.put(`/api/sales-orders/${t}`,{...h,partsToOrder:x}),kt("Sales Order updated successfully!"),setTimeout(()=>{window.__unsavedGuardAllowNext=!0},100),jt(JSON.stringify({header:{customer:j,product:W,salesDate:Y,terms:Pe,customerPoNumber:me,vinNumber:je,estimatedCost:D},lineItems:te,quantityToOrderItems:at}));try{const[C,R]=await Promise.all([$.get(`/api/sales-orders/${t}`),$.get("/api/inventory")]),V=C.data,pe=(V.lineItems||V.salesOrder?.line_items||[]).map(he=>({part_number:he.part_number,part_description:he.part_description,unit:he.unit,unit_price:he.unit_price,line_amount:Number(he.line_amount||0),quantity:he.part_number==="SUPPLY"?"1":["LABOUR","OVERHEAD"].includes(he.part_number)?String(he.quantity_sold||0):String(he.quantity_sold??he.quantity??0),gst:xn,part_id:he.part_id??void 0}));B(pe),ce(pe),y(R.data)}catch{}}}catch(x){const C=x?.response?.data?.error||x?.response?.data?.details||x?.response?.data?.message||"Failed to save sales order.";Fr(C)}finally{ye(!1),window.__soCreateInFlight=!1}},Kr=async()=>{if(r||!De)return;const h=te.filter(x=>!["LABOUR","OVERHEAD","SUPPLY"].includes(x.part_number)&&(parseFloat(String(x.quantity).replace(/[^\d.-]/g,""))||0)===0);if(h.length>0){H.error(`Cannot close: line items with 0 quantity: ${h.map(x=>x.part_number).join(", ")}`);return}if(at.some(x=>parseFloat(String(x.quantity_to_order))>0)){const x=at.filter(C=>parseFloat(String(C.quantity_to_order))>0).map(C=>`${C.part_number} (${C.quantity_to_order})`).join(", ");H.error(`Cannot close: parts still need to be ordered: ${x}`);return}try{await $.put(`/api/sales-orders/${De.sales_order_id}`,{customer_id:De.customer_id,sales_date:De.sales_date,product_name:W?.label?.trim()||De.product_name,product_description:se.trim(),terms:Pe.trim(),status:"Closed",estimated_cost:D??De.estimated_cost,lineItems:ha(te)}),H.success("Sales Order closed successfully!"),et(x=>x&&{...x,status:"Closed"})}catch(x){const C=x?.response?.data?.error||x?.response?.data?.details||x?.response?.data?.message||"Failed to close sales order.";Fr(C)}},ma=async()=>{if(!(r||!De))try{await $.put(`/api/sales-orders/${De.sales_order_id}`,{customer_id:De.customer_id,sales_date:De.sales_date,product_name:W?.label?.trim()||De.product_name,product_description:se.trim(),terms:Pe.trim(),status:"Open",estimated_cost:D??De.estimated_cost,lineItems:ha(te)}),H.success("Sales Order reopened successfully!"),et(h=>h&&{...h,status:"Open"}),a(`/open-sales-orders/${De.sales_order_id}`)}catch(h){const x=h?.response?.data?.error||h?.response?.data?.details||h?.response?.data?.message||"Failed to reopen sales order.";Fr(x)}},Rn=async()=>{if(r)return await(async()=>(await cs(),!0))(),void 0;if(De)try{De.status?.toLowerCase()!=="closed"&&await cs();const h=await $.get(`/api/sales-orders/${De.sales_order_id}/pdf`,{responseType:"blob"}),x=window.URL.createObjectURL(new Blob([h.data],{type:"application/pdf"})),C=document.createElement("a");C.href=x,C.download=`sales_order_${De.sales_order_number}.pdf`,document.body.appendChild(C),C.click(),C.remove(),window.URL.revokeObjectURL(x),H.success(De.status?.toLowerCase()==="closed"?"PDF downloaded.":"Saved and downloaded PDF.")}catch(h){const x=h?.response?.data?.error||h?.response?.data?.details||h?.response?.data?.message||"Failed to save or download PDF.";Fr(x)}},us=async()=>{if(!(r||!De)){if(at.some(h=>parseFloat(String(h.quantity_to_order))>0)){const h=at.filter(x=>parseFloat(String(x.quantity_to_order))>0).map(x=>`${x.part_number} (${x.quantity_to_order})`).join(", ");H.error(`Cannot export to QuickBooks: parts to order exist: ${h}`);return}Do(!0),fn(null),is(null);try{const h=await $.post(`/api/sales-orders/${De.sales_order_id}/export-to-qbo`);is("Sales Order exported to QuickBooks successfully!"),et(x=>x&&{...x,exported_to_qbo:!0,qbo_invoice_id:h.data.qbo_invoice_id,qbo_export_date:new Date().toISOString(),qbo_export_status:"Success"}),H.success("Exported to QuickBooks.")}catch(h){const x=h?.response?.data;if(x?.error==="CUSTOMER_NOT_FOUND")if(window.confirm(`Customer '${x.customerName}' does not exist in QuickBooks.
Create it and export the Sales Order?`))try{const R=await $.post(`/api/sales-orders/${De.sales_order_id}/export-to-qbo-with-customer`,{customerData:x.customerData});H.success("Customer created and Sales Order exported."),is("Customer created and Sales Order exported."),et(V=>V&&{...V,exported_to_qbo:!0,qbo_invoice_id:R.data.qbo_invoice_id,qbo_export_date:new Date().toISOString(),qbo_export_status:"Success"})}catch(R){const V=R?.response?.data?.error||"Failed to create customer and export to QuickBooks.";fn(V),H.error(V)}else fn("Export cancelled. Customer must exist in QuickBooks.");else{const C=x?.error||x?.message||"Failed to export to QuickBooks.";fn(C),H.error(C)}}finally{Do(!1)}}},Ao=async()=>{Mn(!0);try{const h=await $.get("/api/sales-orders");Eo(h.data)}catch{H.error("Failed to fetch sales orders for import")}finally{Mn(!1)}},Mo=()=>{mn(!0),Ao()},ds=async()=>{if(An){Mn(!0);try{const h=await $.get(`/api/sales-orders/${An.sales_order_id}`),R=(h.data.lineItems||h.data.salesOrder?.line_items||[]).filter(V=>(V.part_number||"").toUpperCase()!=="LABOUR").map(V=>({part_number:V.part_number,part_description:V.part_description,quantity:String(r?V.quantity:V.quantity_sold??V.quantity??0),unit:V.unit,unit_price:V.unit_price,gst:xn,line_amount:V.line_amount,part_id:V.part_id??void 0}));B(R),mn(!1),ua(null),H.success("Line items imported!")}catch{H.error("Failed to import line items")}finally{Mn(!1)}}},Ro=h=>{const x=k.trim(),C=h.key==="Enter",R=h.key==="Tab";if(h.key==="Escape"){g(!1);return}if(C||R){if(C&&h.ctrlKey&&x){h.preventDefault(),ae(!0),Jr(x),Qr(!0);return}if(v||!x)return;h.preventDefault();const pe=Gr(x);pe?(N(pe),M(pe.label)):(ae(!0),Jr(x),Qr(!0))}},No=h=>{if(h.key!=="Enter")return;h.preventDefault();const x=J.trim();if(!x)return;const C=u.find(R=>R.label.toLowerCase()===x.toLowerCase());C?(Z(C),P(C.label)):(hn(x),In(!0))},Q=()=>{if(!De)return null;const h=te||[];let x=h.reduce((V,pe)=>V+(Number(pe.line_amount)||0),0),C=x*.05,R=x+C;return isNaN(x)&&(x=0),isNaN(C)&&(C=0),isNaN(R)&&(R=0),e.jsxs(q,{p:{xs:2,md:4},maxWidth:1e3,mx:"auto",children:[To&&e.jsx(Re,{severity:"success",sx:{mb:2},onClose:()=>is(null),children:To}),os&&e.jsx(Re,{severity:"error",sx:{mb:2},onClose:()=>fn(null),children:os}),e.jsx(f,{variant:"h4",gutterBottom:!0,children:"Sales Order Details"}),e.jsx(mt,{variant:"outlined",sx:{mb:3},children:e.jsx(wt,{children:e.jsxs(T,{container:!0,spacing:{xs:2,md:3},children:[e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Sales Order #:"})," ",De.sales_order_number]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Customer:"})," ",De.customer_name||"N/A"]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Sales Date:"})," ",De.sales_date?new Date(De.sales_date).toLocaleDateString():""]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Status:"})," ",De.status?.toUpperCase()||"N/A"]}),e.jsxs(T,{item:!0,xs:12,children:[e.jsx("b",{children:"Estimated Price:"})," ",lr(De.estimated_cost||0)]}),e.jsxs(T,{item:!0,xs:12,children:[e.jsx("b",{children:"Product Description:"})," ",De.product_description||"N/A"]}),e.jsxs(T,{item:!0,xs:12,children:[e.jsx("b",{children:"Terms:"})," ",De.terms||"N/A"]}),De.exported_to_qbo&&e.jsxs(T,{item:!0,xs:12,children:[e.jsx("b",{children:"QBO Export:"})," Exported",De.qbo_invoice_id&&` (Invoice ID: ${De.qbo_invoice_id})`,De.qbo_export_date&&` on ${new Date(De.qbo_export_date).toLocaleDateString()}`]})]})})}),e.jsx(f,{variant:"h5",gutterBottom:!0,children:"Items"}),e.jsx(mt,{variant:"outlined",children:e.jsx(wt,{children:h.map((V,pe)=>e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:6,sm:3,md:2,children:V.part_number}),e.jsx(T,{item:!0,xs:6,sm:5,md:4,children:V.part_description}),e.jsx(T,{item:!0,xs:4,sm:2,md:1.5,children:V.quantity}),e.jsx(T,{item:!0,xs:4,sm:2,md:1.5,children:V.unit}),e.jsx(T,{item:!0,xs:4,sm:2,md:1.5,children:lr(V.unit_price)}),e.jsx(T,{item:!0,xs:4,sm:2,md:1,children:lr(V.line_amount)})]},pe))})}),e.jsxs(q,{mt:4,display:"flex",flexDirection:"column",alignItems:"flex-end",children:[e.jsxs(f,{variant:"h6",children:["Subtotal: ",lr(x)]}),e.jsxs(f,{variant:"h6",children:["Total GST: ",lr(C)]}),e.jsxs(f,{variant:"h6",children:["Total Amount: ",lr(R)]})]}),e.jsxs(q,{mt:4,display:"flex",justifyContent:{xs:"center",sm:"flex-end"},gap:2,children:[e.jsx(K,{variant:"contained",color:"primary",startIcon:e.jsx(or,{}),onClick:Rn,children:"Download PDF"}),!De.exported_to_qbo&&e.jsx(K,{variant:"contained",color:"success",startIcon:e.jsx(Ga,{}),disabled:Wr,onClick:us,children:Wr?"Exporting...":"Export to QuickBooks"}),n?.access_role!=="Sales and Purchase"&&e.jsx(K,{variant:"contained",color:"primary",onClick:ma,children:"Reopen SO"})]})]})};return!r&&Ve?e.jsxs(Qe,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(it,{}),e.jsx(f,{children:"Loading sales order..."})]}):!r&&Ke?e.jsxs(Qe,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(Re,{severity:"error",sx:{mb:2},children:Ke}),e.jsx(K,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Retry"}),e.jsx(K,{variant:"outlined",onClick:()=>a("/open-sales-orders"),children:"Back to Sales Orders"})]}):!r&&Ie&&n?.access_role==="Sales and Purchase"?e.jsxs(Qe,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(Re,{severity:"error",sx:{mb:2},children:"Access Denied: Sales and Purchase users cannot view closed sales orders."}),e.jsx(K,{variant:"outlined",onClick:()=>a("/open-sales-orders"),children:"Back to Sales Orders"})]}):!r&&Ie?Q():e.jsxs(Hr,{dateAdapter:Tn,children:[e.jsx(So,{when:Ce,onSave:cs}),e.jsxs(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(f,{variant:"h4",component:"h1",children:r?"Create Sales Order":`Edit Sales Order${De?.sales_order_number?`: ${De.sales_order_number}`:""}`}),e.jsxs(tt,{direction:"row",spacing:1,children:[r&&e.jsx(K,{variant:"outlined",onClick:()=>{N(null),M(""),fe(Ze()),Z(null),P(""),ke(""),ge(""),be(""),oe(""),F(null),B([{part_number:"",part_description:"",quantity:"",unit:Ca[0],unit_price:0,gst:xn,line_amount:0}]),Fr(null)},children:"Reset"}),e.jsx(K,{variant:"contained",startIcon:e.jsx(ts,{}),onClick:cs,children:r?"Save Sales Order":"Save Changes"}),!r&&e.jsxs(e.Fragment,{children:[n?.access_role!=="Sales and Purchase"&&e.jsx(K,{variant:"contained",startIcon:e.jsx(to,{}),onClick:Kr,children:"Close SO"}),e.jsx(K,{variant:"contained",startIcon:e.jsx(or,{}),onClick:Rn,children:"Download PDF"})]})]})]}),e.jsx(q,{sx:{mb:2},children:e.jsx(K,{variant:"outlined",color:"secondary",onClick:Mo,children:"Import Line Items"})}),e.jsxs(lt,{open:as,onClose:()=>mn(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ct,{children:"Import Line Items from Sales Order"}),e.jsx(ut,{children:Ur?e.jsx(q,{display:"flex",alignItems:"center",justifyContent:"center",minHeight:120,children:e.jsx(it,{})}):e.jsx(kr,{options:ca,getOptionLabel:h=>{if(!h)return"";const x=h.sales_order_number||"",C=h.customer_name||"",R=h.status||"";return`${x} - ${C}${R?` (${R})`:""}`},value:An,onChange:(h,x)=>ua(x),renderInput:h=>e.jsx(ie,{...h,label:"Select Sales Order",fullWidth:!0}),isOptionEqualToValue:(h,x)=>h.sales_order_id===x?.sales_order_id})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>mn(!1),children:"Cancel"}),e.jsx(K,{onClick:ds,disabled:!An||Ur,variant:"contained",children:"Import"})]})]}),Oo&&e.jsxs(Re,{severity:"warning",sx:{mb:3},onClose:()=>Fr(null),children:[e.jsx(f,{variant:"body1",sx:{fontWeight:"medium"},children:"Inventory Error"}),e.jsx(f,{variant:"body2",children:Oo})]}),e.jsx(qe,{sx:{p:3,mb:3,transform:pn?`translateY(-${pn}px)`:"none",transition:"transform 200ms ease"},elevation:3,children:e.jsxs(T,{container:!0,spacing:3,children:[e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(kr,{open:v,onOpen:()=>g(!0),onClose:()=>g(!1),autoHighlight:!0,value:j,onChange:(h,x)=>{if(ne){ae(!1);return}x&&x.isNew?(Qr(!0),Jr(k),N(null),M(""),g(!1)):(N(x),g(!1))},inputValue:k,onInputChange:(h,x,C)=>{if(M(x),L&&window.clearTimeout(L),C==="reset")return;if((x||"").trim().length>0){const V=window.setTimeout(()=>g(!0),200);z(V)}else g(!1)},options:i,filterOptions:(h,x)=>{const C=x_(h,x.inputValue||""),R=!!Gr(x.inputValue||""),V=[...C];return(x.inputValue||"").trim()!==""&&!R&&V.push({label:`Add "${x.inputValue}" as New Customer`,isNew:!0}),V},getOptionLabel:h=>typeof h=="string"?h:h.label,isOptionEqualToValue:(h,x)=>h.id===x.id,renderOption:(h,x)=>{const C=x.isNew,{key:R,...V}=h;return e.jsxs("li",{...V,style:{display:"flex",alignItems:"center",opacity:C?.9:1},children:[C&&e.jsx(an,{fontSize:"small",style:{marginRight:8,color:"#666"}}),e.jsx("span",{children:x.label})]},R)},renderInput:h=>e.jsx(ie,{...h,label:"Customer",required:!0,onKeyDown:Ro,onBlur:()=>{if(!j){const x=k.trim();if(x){const C=Gr(x);C&&(N(C),M(C.label))}}},inputRef:x=>{ee.current=x}})})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{label:"Customer PO #",value:me,onChange:h=>be(h.target.value),fullWidth:!0,placeholder:"Optional"})}),!o&&e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{label:"Quoted Price",type:"number",value:D??"",onChange:h=>F(h.target.value?parseFloat(h.target.value):null),fullWidth:!0,InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:"$"})},inputProps:{onWheel:h=>h.currentTarget.blur()}})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(kr,{disablePortal:!0,open:m,onOpen:()=>A(!0),onClose:()=>A(!1),autoHighlight:!0,value:W,onChange:(h,x)=>{if(x&&x.isNew){const C=x.inputValue?.toString?.()||J.trim();In(!0),hn(C),Z(null),P(""),A(!1)}else Z(x),A(!1)},inputValue:J,onInputChange:(h,x,C)=>{if(P(x),hn(x),G&&window.clearTimeout(G),C==="reset")return;if((x||"").trim().length>0){const V=window.setTimeout(()=>A(!0),200);X(V)}else A(!1)},options:u,filterOptions:(h,x)=>{const C=h.filter(R=>R.label.toLowerCase().includes((x.inputValue||"").toLowerCase()));return(x.inputValue||"")!==""&&!h.some(R=>R.label.toLowerCase()===(x.inputValue||"").toLowerCase())&&C.push({label:`Add "${x.inputValue}"`,isNew:!0,inputValue:x.inputValue}),C},getOptionLabel:h=>typeof h=="string"?h:h.label,renderInput:h=>e.jsx(ie,{...h,label:"Product Name",required:!0,onKeyDown:No,onBlur:()=>{if(A(!1),!W){const x=J.trim();if(x){const C=u.find(R=>R.label.toLowerCase()===x.toLowerCase());C&&(Z(C),P(C.label))}}}}),disabled:!1})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{label:"VIN #",value:je,onChange:h=>oe(h.target.value),fullWidth:!0,placeholder:"Optional",error:!!(je&&je.trim()!==""&&je.trim().length!==17),helperText:je&&je.trim()!==""&&je.trim().length!==17?"VIN must be 17 characters":""})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(on,{label:"Sales Date",value:Y,onChange:fe,sx:{width:"100%"},slotProps:{textField:{required:!0}}})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"Product Description",value:se,onChange:h=>ke(h.target.value),fullWidth:!0,multiline:!0,minRows:2,maxRows:6,sx:{mt:1}})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"Terms",value:Pe,onChange:h=>ge(h.target.value),fullWidth:!0,multiline:!0,minRows:3,maxRows:8,sx:{mt:1},placeholder:"Enter payment/delivery terms, etc."})})]})}),e.jsxs(q,{sx:{position:"relative",zIndex:1e3,transform:pn?`translateY(-${pn}px)`:"none",transition:"transform 200ms ease"},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"Line Items"}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Each part number can only appear once. Edit existing line items to change quantities."})]}),e.jsxs(q,{sx:{position:"relative",mb:3},children:[!r&&we.length>0&&e.jsx(q,{sx:{position:"absolute",bottom:"calc(100% + 8px)",left:0,right:0,zIndex:500,display:"flex",flexDirection:"column",gap:1,pointerEvents:"none"},children:we.map((h,x)=>e.jsx(Re,{severity:"warning",sx:{width:"100%",boxShadow:2,pointerEvents:"auto","& .MuiAlert-message":{width:"100%",padding:0}},children:e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",sx:{width:"100%"},children:[e.jsxs(q,{children:[e.jsxs(f,{variant:"body2",fontWeight:"medium",children:["Insufficient stock for ",h.partNumber]}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Excess quantity: ",h.excessQuantity," ",h.unit]})]}),e.jsxs(K,{variant:"contained",size:"small",sx:{whiteSpace:"nowrap"},onClick:()=>xe(h),children:["Transfer ",h.excessQuantity," to Parts to Order"]})]})},`${h.lineItemIndex}-${x}`))}),e.jsxs(lt,{open:!!Xe,onClose:()=>xe(null),maxWidth:"xs",fullWidth:!0,children:[e.jsx(ct,{children:"Transfer to Parts to Order"}),e.jsx(ut,{children:Xe&&e.jsxs(f,{variant:"body2",children:["Transfer ",Xe.excessQuantity," ",Xe.unit," of ",Xe.partNumber," to Parts to Order?"]})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>xe(null),children:"Cancel"}),e.jsx(K,{variant:"contained",onClick:()=>{if(!Xe)return;const h=Xe,x=te[h.lineItemIndex],C=h.excessQuantity,R=p.find(he=>he.part_number.toLowerCase()===x.part_number.toLowerCase()),V={sales_order_id:De?.sales_order_id||0,part_number:x.part_number,part_description:x.part_description,quantity_to_order:String(C),unit:x.unit,unit_price:R?.last_unit_cost||0,line_amount:(R?.last_unit_cost||0)*C};Ct(he=>[...he,V]);const pe=Math.max(0,(parseFloat(String(x.quantity).replace(/[^\d.-]/g,""))||0)-C);B(he=>he.map((Te,Ye)=>Ye===h.lineItemIndex?{...Te,quantity:String(pe)}:Te)),Oe(he=>he.filter(Te=>Te.lineItemIndex!==h.lineItemIndex)),xe(null),H.success(`Transferred ${C} ${x.unit} of ${x.part_number} to parts to order`)},children:"Confirm"})]})]}),e.jsxs(qe,{sx:{p:3,mb:3},elevation:3,children:[e.jsx(T,{container:!0,spacing:2,children:te.map((h,x)=>({item:h,originalIndex:x})).sort((h,x)=>{const C=["LABOUR","OVERHEAD","SUPPLY"].includes(h.item.part_number),R=["LABOUR","OVERHEAD","SUPPLY"].includes(x.item.part_number);return C&&!R?1:!C&&R?-1:0}).map(({item:h,originalIndex:x})=>e.jsxs(ft.Fragment,{children:[e.jsx(T,{item:!0,xs:12,sm:6,md:2.5,children:e.jsx(kr,{open:Fe===x,onOpen:()=>Ge(x),onClose:()=>Ge(null),autoHighlight:!0,inputValue:h.part_number,onChange:(C,R)=>{if(typeof R=="string"){const V=te.findIndex((pe,he)=>he!==x&&pe.part_number.trim().toLowerCase()===R.trim().toLowerCase());if(V!==-1){H.error(`Part "${R}" already exists as line item ${V+1}. Edit that line item instead.`),B(pe=>pe.map((he,Te)=>Te===x?{...he,part_number:"",part_description:""}:he)),Ge(null);return}Io(x,R),Ge(null)}else if(R&&typeof R=="object"&&"isNew"in R){const V=R.inputValue||"";Dr(String(V).toUpperCase()),Zt(x),fr(!0),Ge(null)}},onInputChange:(C,R,V)=>{if(V==="reset")return;const pe=(R||"").trim();if(B(he=>he.map((Te,Ye)=>Ye===x?{...Te,part_number:pe}:Te)),It&&window.clearTimeout(It),pe.length>0){const he=window.setTimeout(()=>Ge(x),200);rr(he)}else Ge(null)},options:p.filter(C=>C.part_type!=="supply").map(C=>C.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,handleHomeEndKeys:!0,filterOptions:(C,R)=>{const V=(R.inputValue||"").toUpperCase(),pe=C.filter(Ye=>{const Je=p.find(Nt=>Nt.part_number===Ye);return Je?String(Ye).toUpperCase().includes(V)||String(Je.part_description||"").toUpperCase().includes(V):String(Ye).toUpperCase().includes(V)}),he=pe.some(Ye=>String(Ye).toUpperCase()===V),Te=[...pe];return V&&!he&&Te.push({label:`Add "${R.inputValue}" as New Part`,isNew:!0,inputValue:R.inputValue}),Te},renderOption:(C,R)=>{const V=typeof R=="object"&&R.isNew,pe=typeof R=="string"?R:R.label,{key:he,...Te}=C;return e.jsxs("li",{...Te,children:[V&&e.jsx(an,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof R=="string"?e.jsxs(q,{children:[e.jsx(f,{variant:"body2",children:R}),(()=>{const Ye=p.find(Je=>Je.part_number===R);return Ye?.part_description?e.jsx(f,{variant:"caption",color:"text.secondary",children:Ye.part_description}):null})()]}):pe]},he)},renderInput:C=>e.jsx(ie,{...C,label:"Part Number",required:!0,fullWidth:!0,onKeyDown:R=>rs(x,R),onBlur:()=>Ge(null)}),onBlur:()=>{const C=te[x]?.part_number?.trim().toUpperCase();if(!C)return;p.find(V=>V.part_number===C)?Io(x,C):(Zt(x),Dr(C),fr(!0),Ge(null))}})}),e.jsx(T,{item:!0,xs:12,sm:6,md:2.5,children:e.jsx(ie,{label:"Part Description",value:h.part_description,fullWidth:!0,required:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1,children:e.jsx(ie,{label:"Qty",value:h.quantity,onChange:C=>Ji(x,"quantity",C.target.value),type:"number",fullWidth:!0,required:!0,InputProps:{readOnly:["SUPPLY","LABOUR","OVERHEAD"].includes(h.part_number),disabled:["SUPPLY","LABOUR","OVERHEAD"].includes(h.part_number)},inputProps:{step:1,onWheel:C=>C.target.blur()}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1,children:e.jsx(ie,{label:"Avail",value:(()=>{const C=pa[x];return C?C.available<0?`${C.available} (Insufficient)`:String(C.available):"N/A"})(),fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:(()=>{const C=pa[x];return C?C.available>=0?"#e8f5e8":"#ffeaea":"#f5f5f5"})(),"& .MuiInputBase-input":{color:pa[x]?.isNegative?"#d32f2f":"#2e7d32"}}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1,children:e.jsx(ie,{label:"Unit",value:h.part_number==="SUPPLY"?"":h.unit,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(T,{item:!0,xs:12,sm:2,md:1.5,children:e.jsx(ie,{label:"Unit Cost",value:h.part_number==="LABOUR"?_??0:h.part_number==="OVERHEAD"?b??0:h.part_number==="SUPPLY"?"":h.unit_price,type:"number",fullWidth:!0,InputProps:{readOnly:!0,startAdornment:h.part_number!=="SUPPLY"?e.jsx(Xt,{position:"start",children:"$"}):void 0,disabled:["LABOUR","OVERHEAD","SUPPLY"].includes(h.part_number)}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(ie,{label:"Amount",value:h.line_amount!=null&&!isNaN(Number(h.line_amount))?Number(h.line_amount).toFixed(2):"0.00",InputProps:{readOnly:!0},fullWidth:!0})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1,sx:{display:"flex",alignItems:"center"},children:e.jsx(K,{variant:"outlined",color:"primary",onClick:()=>Xi(x),fullWidth:!0,children:"Remove"})})]},x))}),e.jsx(q,{sx:{mt:2},children:e.jsx(K,{variant:"outlined",color:"primary",onClick:Ki,children:"Add Line Item"})})]})]}),e.jsx(qe,{sx:{p:3,mb:3},elevation:3,children:e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsxs(f,{variant:"subtitle1",children:["Subtotal: ",lr(Se)]})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsxs(f,{variant:"subtitle1",children:["Total GST: ",lr($e)]})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsxs(f,{variant:"h6",children:["Total Amount: ",lr(He)]})})]})}),!r&&e.jsxs(qe,{sx:{p:3,mb:3,elevation:3,border:"2px solid #b8860b","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"#b8860b"},"&:hover fieldset":{borderColor:"#b8860b"}}},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Parts to Order"}),e.jsx(f,{variant:"body2",color:"textSecondary",sx:{mb:2},children:"Add parts that need to be ordered for this sales order. These quantities are aggregated across all sales orders."}),e.jsx(T,{container:!0,spacing:2,children:at.map((h,x)=>e.jsxs(ft.Fragment,{children:[e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kr,{open:dr===x,onOpen:()=>Ht(x),onClose:()=>Ht(null),autoHighlight:!0,value:h.part_number,onChange:(C,R)=>{if(!R){Ct(V=>{const pe=[...V];return pe[x]={...pe[x],part_number:"",part_description:"",unit:"Each",unit_price:0,line_amount:0},pe});return}if(typeof R=="string"){const V=p.find(pe=>pe.part_number===R);if(V){const pe=parseFloat(String(V.last_unit_cost))||0,he=ls(pe),Te=pe*he;Ct(Ye=>{const Je=[...Ye];return Je[x]={...Je[x],part_number:V.part_number,part_description:V.part_description,unit:V.unit||"Each",unit_price:Te,line_amount:0},Je})}else{Ct(he=>{const Te=[...he];return Te[x]={...Te[x],part_number:R,part_description:"",unit:"Each",unit_price:0,line_amount:0},Te});const pe=String(R).toUpperCase();gr(x),Vr(pe),jr(!0)}}else if(R&&typeof R=="object"&&"isNew"in R){const V=String(R.inputValue||"").toUpperCase();gr(x),Vr(V),jr(!0)}},onInputChange:(C,R,V)=>{if(Ct(he=>{const Te=[...he];return Te[x]={...Te[x],part_number:(R||"").toUpperCase()},Te}),It&&window.clearTimeout(It),V==="reset")return;if((R||"").trim().length>0){const he=window.setTimeout(()=>Ht(x),200);rr(he)}else Ht(null)},options:p.filter(C=>C.part_type!=="supply").map(C=>C.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,filterOptions:(C,R)=>{const V=(R.inputValue||"").toUpperCase(),pe=C.filter(Ye=>{const Je=p.find(Nt=>Nt.part_number===Ye);return Je?String(Ye).toUpperCase().includes(V)||String(Je.part_description||"").toUpperCase().includes(V):String(Ye).toUpperCase().includes(V)}),he=pe.some(Ye=>String(Ye).toUpperCase()===V),Te=[...pe];return V&&!he&&Te.push({label:`Add "${R.inputValue}" as New Part`,isNew:!0,inputValue:R.inputValue}),Te},renderOption:(C,R)=>{const V=typeof R=="object"&&R.isNew,pe=typeof R=="string"?R:R.label,{key:he,...Te}=C;return e.jsxs("li",{...Te,children:[V&&e.jsx(an,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof R=="string"?e.jsxs(q,{children:[e.jsx(f,{variant:"body2",children:R}),(()=>{const Ye=p.find(Je=>Je.part_number===R);return Ye?.part_description?e.jsx(f,{variant:"caption",color:"text.secondary",children:Ye.part_description}):null})()]}):pe]},he)},renderInput:C=>e.jsx(ie,{...C,label:"Part Number",fullWidth:!0,required:!0,onKeyDown:R=>ia(x,R),onBlur:()=>Ht(null)}),onBlur:()=>{const C=(at[x]?.part_number||"").trim().toUpperCase();if(!C)return;p.find(V=>V.part_number===C)||(gr(x),Vr(C),jr(!0),Ht(null))}})}),e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(ie,{label:"Description",value:h.part_description,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#f5f5f5"}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1,children:e.jsx(ie,{label:"Qty to Order",value:h.quantity_to_order,onChange:C=>{const R=C.target.value;Ct(V=>{const pe=[...V],he=parseFloat(R)||0,Te=pe[x].unit_price||0;return pe[x]={...pe[x],quantity_to_order:R,line_amount:he*Te},pe})},type:"number",fullWidth:!0,required:!0,inputProps:{step:1,min:0,onWheel:C=>C.target.blur()}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1,children:e.jsx(ie,{label:"Unit",value:h.unit,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(T,{item:!0,xs:12,sm:1.5,children:e.jsx(ie,{label:"Unit Price",value:h.unit_price,type:"number",fullWidth:!0,InputProps:{readOnly:!0,startAdornment:e.jsx(Xt,{position:"start",children:"$"})},sx:{backgroundColor:"#f5f5f5"}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(ie,{label:"Amount",value:h.line_amount,InputProps:{readOnly:!0},fullWidth:!0})}),e.jsx(T,{item:!0,xs:12,sm:1,md:1,sx:{display:"flex",alignItems:"center",gap:2},children:e.jsx(K,{variant:"outlined",onClick:()=>Ct(C=>C.filter((R,V)=>V!==x)),sx:{flexShrink:0,borderColor:"#b8860b",color:"#b8860b","&:hover":{borderColor:"#8b6914",backgroundColor:"#fff8dc"}},children:"Remove"})})]},x))}),e.jsx(q,{sx:{mt:2},children:e.jsx(K,{variant:"outlined",color:"primary",onClick:()=>Ct(h=>[...h,{sales_order_id:Number(t)||0,part_number:"",part_description:"",quantity_to_order:"",unit:"Each",unit_price:0,line_amount:0}]),children:"Add Parts to Order Item"})})]}),e.jsx(vo,{open:la,onClose:()=>Qr(!1),onSave:async h=>{try{const x=await $.post("/api/customers",h),C={label:h.customer_name,id:x.data.customer_id};c(R=>[...R,C]),N(C),Qr(!1),H.success("Customer added successfully!")}catch{H.error("Failed to add customer.")}},initialCustomer:{customer_name:Po},isEditMode:!1}),e.jsx(Hi,{open:ns,onClose:()=>In(!1),onSave:async h=>{try{const x=await $.post("/api/products",h),C={label:h.product_name,id:x.data.product_id,description:h.product_name};d(R=>[...R,C]),Z(C),P(C.label),In(!1),hn(""),H.success("Product added successfully!")}catch{H.error("Failed to add product.")}},initialProduct:{product_name:ss||J},isEditMode:!1}),!r&&e.jsxs(e.Fragment,{children:[os&&e.jsx(Re,{severity:"error",sx:{mb:2},onClose:()=>fn(null),children:os}),e.jsx(zr,{open:!!pt,autoHideDuration:6e3,onClose:()=>kt(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Re,{onClose:()=>kt(null),severity:"success",sx:{width:"100%"},children:pt})}),!De?.exported_to_qbo&&De?.status?.toLowerCase()==="closed"&&e.jsxs(q,{display:"flex",justifyContent:"flex-end",gap:2,mb:2,children:[e.jsx(K,{variant:"contained",color:"success",startIcon:e.jsx(Ga,{}),disabled:Wr,onClick:us,children:Wr?"Exporting...":"Export to QuickBooks"}),n?.access_role!=="Sales and Purchase"&&e.jsx(K,{variant:"outlined",onClick:ma,children:"Reopen SO"})]})]})]}),e.jsx(kn,{open:pr,onClose:()=>{fr(!1),Zt(null),Dr("")},onSave:async h=>{const x=await $.post("/api/inventory",h),C=await $.get("/api/inventory");y(C.data);const R=x.data.item;Jt!==null&&B(V=>{const pe=[...V],he=parseFloat(String(R.last_unit_cost))||0,Te=ls(he),Ye=he*Te;return pe[Jt]={...pe[Jt],part_number:R.part_number,part_description:R.part_description,unit:R.unit||pe[Jt].unit,unit_price:Ye},pe})},title:"Add New Part",initialPart:{part_number:Yr.toUpperCase(),category:"Uncategorized"}}),e.jsx(kn,{open:qr,onClose:()=>{jr(!1),gr(null),Vr("")},onSave:async h=>{const x=await $.post("/api/inventory",h),C=await $.get("/api/inventory");y(C.data);const R=x.data.item;dn!==null&&Ct(V=>{const pe=[...V],he=parseFloat(String(R.last_unit_cost))||0,Te=ls(he),Ye=he*Te;return pe[dn]={...pe[dn],part_number:R.part_number,part_description:R.part_description,unit:R.unit||"Each",unit_price:Ye},pe})},title:"Add New Part",initialPart:{part_number:On.toUpperCase(),category:"Uncategorized"}})]})},kc=()=>{const[t,r]=l.useState([]),[s,a]=l.useState(!0),[n,o]=l.useState(""),[i,c]=l.useState("open"),[u,d]=l.useState({page:0,pageSize:10}),p=qt();cn();const{user:y}=Qt(),w=async()=>{a(!0);try{const U=(await $.get("/api/purchase-history",{params:{status:i,searchTerm:n||void 0}})).data.sort((S,j)=>{const N=v=>{const g=v.match(/\d+/);return g?parseInt(g[0],10):0},k=N(S.purchase_number);return N(j.purchase_number)-k});r(U)}catch(I){console.error("Error fetching purchase orders:",I),r([]),H.error("Failed to fetch purchase orders")}finally{a(!1)}};l.useEffect(()=>{w()},[i,n]);const O=I=>{window.confirm("Are you sure you want to delete this purchase order?")&&_(I)},_=async I=>{try{await $.delete(`/api/purchase-orders/${I}`),H.success("Purchase order deleted successfully"),w()}catch(U){console.error("Error deleting purchase order:",U),H.error("Failed to delete purchase order")}},E=()=>{let I=t;i==="open"?I=t.filter(N=>N.status==="Open"):i==="closed"&&(I=t.filter(N=>N.status==="Closed"));const U=un.unparse(I),S=new Blob([U],{type:"text/csv;charset=utf-8;"}),j=document.createElement("a");j.href=URL.createObjectURL(S),j.download=`purchase_orders_${Ze().format("YYYY-MM-DD")}.csv`,j.click()},b=[{field:"purchase_number",headerName:"Purchase #",flex:1,minWidth:120,valueFormatter:I=>I.value?String(I.value).replace("PO-",""):""},{field:"vendor_name",headerName:"Vendor",flex:1.3,minWidth:150},{field:"bill_number",headerName:"Bill #",flex:.9,minWidth:100},{field:"subtotal",headerName:"Subtotal",flex:.8,minWidth:100,valueFormatter:I=>I.value!=null&&!isNaN(Number(I.value))?`$${Number(I.value).toFixed(2)}`:"$0.00"},{field:"gst_rate",headerName:"GST Rate (%)",flex:.7,minWidth:80,valueFormatter:I=>I.value!=null&&!isNaN(Number(I.value))?`${Number(I.value).toFixed(2)}%`:"5.00%"},{field:"total_gst_amount",headerName:"GST",flex:.7,minWidth:80,valueFormatter:I=>I.value!=null&&!isNaN(Number(I.value))?`$${Number(I.value).toFixed(2)}`:"$0.00"},{field:"total_amount",headerName:"Total",flex:.8,minWidth:100,valueFormatter:I=>I.value!=null&&!isNaN(Number(I.value))?`$${Number(I.value).toFixed(2)}`:"$0.00"},{field:"status",headerName:"Status",flex:.8,minWidth:100,renderCell:I=>e.jsx(Le,{label:I.value,color:I.value==="Open"?"success":"error",size:"small",variant:"outlined"})},{field:"qbo_exported",headerName:"QBO Exported",flex:.8,minWidth:120,renderCell:I=>I.row.exported_to_qbo?e.jsx(oa,{color:"success",titleAccess:"Exported to QuickBooks"}):I.row.qbo_export_status?e.jsx(Co,{color:"error",titleAccess:`QBO Export Error: ${I.row.qbo_export_status}`}):I.row.status==="Closed"?e.jsx(gd,{color:"warning",titleAccess:"Not exported to QuickBooks"}):null},{field:"actions",headerName:"Actions",width:100,sortable:!1,renderCell:I=>e.jsx(q,{sx:{display:"flex",gap:.5},children:I.row.status!=="Closed"&&e.jsx(ot,{size:"small",color:"error",onClick:U=>{U.stopPropagation(),O(I.row.purchase_id)},children:e.jsx(tr,{})})})}];return e.jsx(Qe,{maxWidth:"xl",sx:{mt:4},children:e.jsxs(q,{sx:{mb:4},children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:i==="open"?"Open Purchase Orders":i==="closed"?"Purchase Order History":"All Purchase Orders"}),e.jsxs(tt,{direction:"row",spacing:2,sx:{mb:2,justifyContent:"flex-end"},children:[e.jsx(K,{variant:"contained",startIcon:e.jsx(vr,{}),onClick:()=>p("/open-purchase-orders/new"),children:"New PO"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(or,{}),onClick:E,children:"Export CSV"})]}),e.jsx(qe,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(q,{sx:{p:2},children:[e.jsxs(tt,{direction:"row",spacing:3,sx:{mb:3},children:[e.jsx(ie,{label:"Search",variant:"outlined",value:n,onChange:I=>o(I.target.value),InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:e.jsx(yr,{sx:{fontSize:32}})}),sx:{fontSize:22,height:56}},sx:{minWidth:340,maxWidth:400,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"medium"}),e.jsx(Le,{label:"All",onClick:()=>c("all"),color:i==="all"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),e.jsx(Le,{label:"Open",onClick:()=>c("open"),color:i==="open"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}}),e.jsx(Le,{label:"Closed",onClick:()=>c("closed"),color:i==="closed"?"primary":"default",sx:{fontSize:18,px:3,py:1.5,minWidth:80,height:44}})]}),e.jsx(Mr,{rows:t,columns:b,loading:s,paginationModel:u,onPaginationModelChange:d,pageSizeOptions:[10,25,50],getRowId:I=>I.purchase_id,disableRowSelectionOnClick:!0,initialState:{sorting:{sortModel:[{field:"purchase_number",sort:"desc"}]}},onRowClick:I=>{const U=I.row.status?.toLowerCase();p(U==="closed"?`/purchase-order/${I.row.purchase_id}`:`/open-purchase-orders/${I.row.purchase_id}`)},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"},cursor:"pointer"}})]})})]})})};var As={},Pc;function v_(){if(Pc)return As;Pc=1;var t=At();Object.defineProperty(As,"__esModule",{value:!0}),As.default=void 0;var r=t(Rt()),s=Mt();return As.default=(0,r.default)((0,s.jsx)("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),As}var __=v_();const b_=vt(__);var Ms={},Ec;function j_(){if(Ec)return Ms;Ec=1;var t=At();Object.defineProperty(Ms,"__esModule",{value:!0}),Ms.default=void 0;var r=t(Rt()),s=Mt();return Ms.default=(0,r.default)((0,s.jsx)("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess"),Ms}var w_=j_();const S_=vt(w_),C_=({open:t,onClose:r,purchaseOrderId:s,onSuccess:a,onAllocationSaved:n})=>{const[o,i]=l.useState(!1),[c,u]=l.useState(!1),[d,p]=l.useState(null),[y,w]=l.useState({}),[O,_]=l.useState({}),[E,b]=l.useState({}),[I,U]=l.useState(new Set),[S,j]=l.useState([]);l.useEffect(()=>{t&&s&&(p(null),w({}),_({}),b({}),U(new Set),j([]),N())},[t,s]);const N=async()=>{i(!0);try{const Z=(await $.get(`/api/purchase-history/${s}/allocation-suggestions`)).data;console.log("Allocation suggestions data:",Z),console.log("Number of suggestions:",Z.suggestions?.length),Z.suggestions?.forEach((X,Y)=>{console.log(`Suggestion ${Y}: ${X.part_number} - ${X.allocation_suggestions?.length} sales orders`),X.allocation_suggestions?.forEach((fe,se)=>{console.log(`  Allocation ${se}: SO ${fe.sales_order_number}, current_quantity_needed: ${fe.current_quantity_needed}, is_needed: ${fe.is_needed}`)})});const J=new Set,P=[];for(const X of Z.suggestions||[])try{console.log(`Checking part type for: ${X.part_number}`);const Y=await Ag(X.part_number);console.log(`Part info for ${X.part_number}:`,Y),Y.part_type==="supply"?(J.add(X.part_number),console.log(`Filtering out supply part: ${X.part_number}`)):(console.log(`Including stock part: ${X.part_number} (type: ${Y.part_type})`),P.push(X))}catch(Y){console.warn(`Could not determine part type for ${X.part_number}, including it:`,Y),P.push(X)}U(J),console.log(`Filtering summary: ${J.size} supply parts filtered out, ${P.length} stock parts remaining`),console.log("Supply parts filtered:",Array.from(J)),console.log("Stock parts included:",P.map(X=>X.part_number));const m={...Z,suggestions:P};p(m);let A={},G={};try{const Y=(await $.get(`/api/purchase-history/${s}/allocations`)).data||[],fe={};for(const se of Y){const ke=String(se.part_number).toUpperCase();fe[ke]||(fe[ke]={}),fe[ke][se.sales_order_id]=Number(se.allocate_qty)||0}A={},G={},P.forEach(se=>{const ke=se.part_number,Pe=fe[ke]||{},ge={};se.allocation_suggestions.forEach(be=>{const je=Pe[be.sales_order_id];ge[be.sales_order_id]=typeof je=="number"?je:be.suggested_alloc}),A[ke]=ge;const me=Object.values(ge).reduce((be,je)=>be+(Number(je)||0),0);G[ke]=Math.max(0,se.quantity_ordered-me)})}catch{A={},G={},P.forEach(Y=>{A[Y.part_number]={},Y.allocation_suggestions.forEach(se=>{A[Y.part_number][se.sales_order_id]=se.suggested_alloc});const fe=Object.values(A[Y.part_number]).reduce((se,ke)=>se+(Number(ke)||0),0);G[Y.part_number]=Math.max(0,Y.quantity_ordered-fe)})}w(A),_(G),j([])}catch(W){console.error("Error fetching allocation suggestions:",W),H.error("Failed to load allocation suggestions")}finally{i(!1)}},k=(W,Z,J)=>{if(!d)return{valid:!0};const P=d.suggestions.find(Pe=>Pe.part_number===W);if(!P)return{valid:!0};const m=P.allocation_suggestions.find(Pe=>Pe.sales_order_id===Z);if(!m)return{valid:!0};const A=m.current_quantity_needed,G=P.quantity_ordered,X=P.allocation_suggestions.filter(Pe=>Pe.is_needed).reduce((Pe,ge)=>Pe+ge.current_quantity_needed,0),Y=G>=X,fe=ne(W),se=y[W]?.[Z]||0,ke=G-(fe-se);return J>ke?{valid:!1,message:`Cannot allocate more than ${ke} units (exceeds ordered quantity)`}:Y&&m.is_needed&&J<A?{valid:!1,message:`Cannot allocate less than ${A} units when surplus exists`}:!Y&&m.is_needed&&J<A?{valid:!0,warning:`Allocating ${J} units but ${A} units are needed for quantity to order`}:{valid:!0}},M=(W,Z,J)=>{const P=Math.max(0,J),m=k(W,Z,P);if(!m.valid){H.error(m.message);return}m.warning&&H.warning(m.warning),w(A=>{const G={...A,[W]:{...A[W],[Z]:P}};if(d){const X=d.suggestions.find(Y=>Y.part_number===W);if(X){const Y=G[W]||{},fe=Object.values(Y).reduce((ke,Pe)=>ke+Pe,0),se=Math.max(0,X.quantity_ordered-fe);_(ke=>({...ke,[W]:se}))}}return G})},v=W=>{if(!d)return;const Z=d.suggestions.find(Y=>Y.part_number===W);if(!Z)return;const J=Z.quantity_ordered,P=Z.allocation_suggestions.filter(Y=>Y.is_needed).reduce((Y,fe)=>Y+fe.current_quantity_needed,0),m=J>=P,A=Z.allocation_suggestions.filter(Y=>Y.is_needed).sort((Y,fe)=>Y.sales_order_number.localeCompare(fe.sales_order_number)),G={};let X=J;if(m){for(const Y of A){const fe=Y.current_quantity_needed,se=Math.min(fe,X);se>0&&(G[Y.sales_order_id]=se,X-=se)}if(X>0)for(const Y of Z.allocation_suggestions){if(X<=0)break;const fe=G[Y.sales_order_id]||0,se=Math.min(X,1);G[Y.sales_order_id]=fe+se,X-=se}}else for(const Y of A){if(X<=0)break;const fe=Y.current_quantity_needed,se=Math.min(fe,X);se>0&&(G[Y.sales_order_id]=se,X-=se)}w(Y=>({...Y,[W]:G})),_(Y=>({...Y,[W]:X}))},g=()=>{d&&d.suggestions.forEach(W=>{v(W.part_number)})},L=()=>{const W=[];return d?(d.suggestions.forEach(Z=>{const J=Z.part_number,P=Z.quantity_ordered,m=y[J]||{},A=Object.values(m).reduce((Y,fe)=>Y+fe,0);A>P&&W.push(`Total allocation (${A}) exceeds ordered quantity (${P}) for part ${J}`);const G=Z.allocation_suggestions.filter(Y=>Y.is_needed).reduce((Y,fe)=>Y+fe.current_quantity_needed,0);if(P>=G){for(const Y of Z.allocation_suggestions)if(Y.is_needed){const fe=m[Y.sales_order_id]||0,se=Y.current_quantity_needed;fe<se&&W.push(`Sales order ${Y.sales_order_number} must receive at least ${se} units when surplus exists`)}}}),j(W),W.length===0):!1},z=async()=>{if(L()){u(!0);try{const W=[];for(const[J,P]of Object.entries(y))for(const[m,A]of Object.entries(P))A>0&&W.push({sales_order_id:parseInt(m),part_number:J,allocate_qty:A});const Z=await $.post(`/api/purchase-history/${s}/save-allocations`,{allocations:W,surplusPerPart:O});H.success("Allocations saved successfully"),n&&n(),r()}catch(W){console.error("Error saving allocations:",W);const Z=W.response?.data?.error||"Failed to save allocations";H.error(Z)}finally{u(!1)}}},ne=W=>{const Z=y[W]||{};return Object.values(Z).reduce((J,P)=>J+P,0)},ae=W=>{if(!d)return 0;const Z=d.suggestions.find(P=>P.part_number===W);if(!Z)return 0;const J=ne(W);return Z.quantity_ordered-J},ee=W=>{b(Z=>({...Z,[W]:!Z[W]}))};return o?e.jsxs(lt,{open:t,onClose:r,maxWidth:"lg",fullWidth:!0,children:[e.jsx(ct,{children:"Loading Allocation Suggestions..."}),e.jsx(ut,{children:e.jsx(q,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"200px",children:e.jsx(it,{})})})]}):e.jsxs(lt,{open:t,onClose:r,maxWidth:"lg",fullWidth:!0,children:[e.jsxs(ct,{children:["Allocate Purchase Order: ",d?.purchase_order_number]}),e.jsxs(ut,{children:[d&&d.suggestions.length>0&&e.jsxs(qe,{sx:{mb:3,p:2,backgroundColor:"grey.50"},children:[e.jsxs(f,{variant:"h6",gutterBottom:!0,children:["Purchase Order Summary (",d.suggestions.length," parts)"]}),e.jsx(q,{display:"flex",flexWrap:"wrap",gap:1,children:d.suggestions.map((W,Z)=>e.jsx(Le,{label:`${W.part_number}: ${W.quantity_ordered} ordered`,color:"primary",variant:"outlined",size:"small"},`${W.part_number}-${Z}`))})]}),I.size>0&&e.jsxs(Re,{severity:"info",sx:{mb:2},children:[e.jsxs(f,{variant:"body2",children:[e.jsx("strong",{children:"Note:"})," ",I.size," supply part",I.size>1?"s":""," ",I.size>1?"have":"has"," been filtered out from allocation. Supply parts are not tracked for inventory allocation."]}),e.jsx(q,{mt:1,children:e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Filtered parts: ",Array.from(I).join(", ")]})})]}),S.length>0&&e.jsxs(Re,{severity:"error",sx:{mb:2},children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Please correct the following errors:"}),S.map((W,Z)=>e.jsxs(f,{variant:"body2",children:["• ",W]},Z))]}),d?.suggestions.length===0?e.jsx(Re,{severity:"info",sx:{mb:2},children:e.jsx(f,{variant:"body1",children:"No parts found in this purchase order to allocate."})}):d?.suggestions.map((W,Z)=>e.jsxs(qe,{sx:{mb:2,p:2},children:[e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(q,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(ot,{size:"small",onClick:()=>ee(W.part_number),sx:{p:.5},children:E[W.part_number]?e.jsx(S_,{}):e.jsx(b_,{})}),e.jsxs(f,{variant:"h6",children:[W.part_number," - ",W.part_description]})]}),e.jsxs(q,{display:"flex",gap:1,alignItems:"center",children:[e.jsx(Le,{label:`Ordered: ${W.quantity_ordered}`,color:"primary",variant:"outlined",size:"small"}),e.jsx(Le,{label:`Total Needed: ${W.total_needed}`,color:"secondary",variant:"outlined",size:"small"}),e.jsx(Le,{label:`Remaining: ${ae(W.part_number)}`,color:ae(W.part_number)<0?"error":"default",variant:"outlined",size:"small"}),e.jsx(K,{variant:"outlined",size:"small",onClick:()=>v(W.part_number),children:"Auto Allocate (FIFO)"})]})]}),e.jsx(tu,{in:E[W.part_number],children:e.jsx(q,{mt:2,children:e.jsx(Kt,{children:e.jsxs(Yt,{size:"small",children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{children:"Sales Order"}),e.jsx(re,{children:"Customer"}),e.jsx(re,{children:"Date"}),e.jsx(re,{align:"right",children:"Quantity to Order"}),e.jsx(re,{align:"right",children:"Allocate Qty"}),e.jsx(re,{children:"Status"})]})}),e.jsx(Gt,{children:W.allocation_suggestions.map(J=>(console.log(`Rendering allocation for SO ${J.sales_order_number}: current_quantity_needed = ${J.current_quantity_needed}, is_needed = ${J.is_needed}`),e.jsxs(rt,{sx:{backgroundColor:J.is_needed?"warning.light":"grey.50","&:hover":{backgroundColor:J.is_needed?"warning.main":"grey.100"},borderLeft:J.is_needed?"4px solid #ff9800":"4px solid transparent"},children:[e.jsx(re,{children:e.jsx(f,{variant:"body2",fontWeight:"medium",children:J.sales_order_number})}),e.jsx(re,{children:J.customer_name}),e.jsx(re,{children:new Date(J.sales_date).toLocaleDateString()}),e.jsx(re,{align:"right",children:e.jsx(f,{variant:"body2",color:"black",fontWeight:J.is_needed?"bold":"normal",children:J.current_quantity_needed||0})}),e.jsx(re,{align:"right",children:e.jsx(ie,{type:"number",value:y[W.part_number]?.[J.sales_order_id]||0,onChange:P=>{const m=parseFloat(P.target.value)||0;M(W.part_number,J.sales_order_id,m)},onBlur:P=>{const m=parseFloat(P.target.value)||0,A=ne(W.part_number),G=y[W.part_number]?.[J.sales_order_id]||0,X=W.quantity_ordered-(A-G);m>X&&M(W.part_number,J.sales_order_id,X)},size:"small",sx:{width:80},inputProps:{min:0,step:1,max:W.quantity_ordered}})}),e.jsx(re,{children:e.jsx(Le,{label:J.is_needed?"Needs Part":"No Need",color:J.is_needed?"warning":"default",size:"small",variant:"outlined"})})]},`${W.part_number}-${J.sales_order_id}`)))})]})})})}),e.jsxs(q,{mt:2,display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(f,{variant:"body2",children:["Total Allocated: ",ne(W.part_number)]}),e.jsxs(q,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(f,{variant:"body2",children:"Surplus to Stock:"}),e.jsx(ie,{type:"number",value:O[W.part_number]||0,disabled:!0,size:"small",sx:{width:80},inputProps:{min:0,step:1}})]})]})]},`${W.part_number}-${Z}`))]}),e.jsxs(dt,{children:[e.jsx(K,{onClick:r,disabled:c,children:"Cancel"}),e.jsx(K,{onClick:g,variant:"outlined",disabled:c,sx:{mr:"auto"},children:"Auto Allocate All (FIFO)"}),e.jsx(K,{onClick:z,variant:"contained",disabled:c||S.length>0,children:c?e.jsx(it,{size:20}):"Save Allocations"})]})]})},xd=(t,r)=>{const s=parseFloat(String(t))||0,a=parseFloat(String(r))||0;return Math.round(s*a*100)/100},k_=(t,r=5)=>{const s=t.reduce((o,i)=>{const c=xd(i.quantity,i.unit_cost);return o+c},0),a=s*(r/100),n=s+a;return{subtotal:Math.round(s*100)/100,total_gst_amount:Math.round(a*100)/100,total_amount:Math.round(n*100)/100}},P_=(t,r=!1)=>{const s={};t.part_number?.trim()||(s.part_number="Part Number is required"),t.part_description?.trim()||(s.part_description="Part Description is required");const a=parseFloat(String(t.quantity));if((isNaN(a)||a<=0)&&(s.quantity="Quantity must be greater than 0"),r){const n=parseFloat(String(t.unit_cost));(isNaN(n)||n<=0)&&(s.unit_cost="Unit Cost must be greater than 0")}return s},E_=(t,r,s=!1)=>{const a={};r||(a.vendor="Vendor is required");const n=t.map(i=>P_(i,s));return n.some(i=>Object.keys(i).length>0)&&(a.lineItems=n),a},Un=t=>{const r=parseFloat(String(t));return isNaN(r)?0:r},ka=["Each","cm","ft","kg","pcs","L"],Dc=5,Tc=()=>{const{id:t}=Dn(),r=qt(),{user:s}=Qt(),a=t==="new";console.log("Is creation mode:",a,"ID:",t);const[n,o]=l.useState(null),[i,c]=l.useState(null),[u,d]=l.useState(Ze()),[p,y]=l.useState(""),[w,O]=l.useState([]),_=yo(w,300),[E,b]=l.useState([]),[I,U]=l.useState("Open"),[S,j]=l.useState(Dc),[N,k]=l.useState({}),[M,v]=l.useState(0),[g,L]=l.useState([]),[z,ne]=l.useState(""),ae=l.useRef(null),[ee,W]=l.useState(!1),[Z,J]=l.useState(null),[P,m]=l.useState(null),[A,G]=l.useState(!1),[X,Y]=l.useState([]),[fe,se]=l.useState({}),[ke,Pe]=l.useState(null),[ge,me]=l.useState(!0),[be,je]=l.useState(!1),[oe,D]=l.useState(null),[F,te]=l.useState(""),[B,Ee]=l.useState(null),[Se,$e]=l.useState(null),[He,De]=l.useState(null),[et,Ve]=l.useState({}),[Be,Ke]=l.useState({});l.useMemo(()=>Yd(),[]);const[We,pt]=l.useState(null),[kt,at]=l.useState(!1),[Ct,Et]=l.useState(null),[jt,Pt]=l.useState(""),[Wt,ir]=l.useState(!1),[ye,de]=l.useState(!1),_e=async()=>{try{console.log("Fetching aggregate quantities...");const Q=new AbortController,h=setTimeout(()=>Q.abort(),1e4),x=await $.get("/api/sales-orders/parts-to-order/all",{signal:Q.signal});clearTimeout(h);const{aggregatedParts:C}=x.data;if(console.log("Full API response:",x.data),console.log("Aggregated parts response:",C),C&&C.length>0){const R={};C.forEach(V=>{const pe=typeof V.total_quantity_needed=="string"?parseFloat(V.total_quantity_needed):V.total_quantity_needed;R[V.part_number.toUpperCase()]=pe}),console.log("Calculated quantities:",R),k(R),b(V=>{const pe=V.map(he=>({...he,quantity_to_order:R[he.part_number]||0}));return console.log("Updated line items with quantities:",pe),pe})}else console.log("No aggregated parts found, clearing quantities"),k({}),b(R=>R.map(V=>({...V,quantity_to_order:0})))}catch(Q){console.error("Error fetching aggregate quantities:",Q),Q.name==="AbortError"&&console.error("Request timed out"),k({}),b(h=>h.map(x=>({...x,quantity_to_order:0})))}},ue=async()=>{if(console.log("fetchData called. ID:",t),a)try{console.log("🔄 Fetching vendors and inventory for creation mode...");const Q=new AbortController,h=setTimeout(()=>Q.abort(),15e3),[x,C]=await Promise.all([$.get("/api/vendors",{signal:Q.signal}),$.get("/api/inventory",{signal:Q.signal})]);clearTimeout(h),console.log("✅ Vendors and inventory fetched successfully"),console.log("Raw vendors data:",x.data);const R=x.data.map(V=>({label:V.vendor_name,id:V.vendor_id,email:V.email}));console.log("Mapped vendors:",R),L(R),Y(C.data),b([]);try{await _e()}catch(V){console.error("Error fetching aggregate quantities:",V)}me(!1),ir(!0),console.log("✅ Creation mode initialization complete");return}catch(Q){console.error("❌ Error fetching vendors/inventory:",Q),Q.name==="AbortError"?pt("Request timed out. Please try again."):pt("Failed to fetch vendors and inventory. Please check your connection and try again."),me(!1);return}try{const[Q,h,x]=await Promise.all([$.get(`/api/purchase-orders/${t}`),$.get("/api/vendors"),$.get("/api/inventory")]),C=Q.data;if(console.log("Fetched Order Data:",C),o(C),C.vendor_name&&C.vendor_id){const he=h.data.find(Te=>Te.vendor_id===C.vendor_id);c({label:C.vendor_name,id:C.vendor_id,email:he?.email})}else if(C.vendor_id){const he=h.data.find(Te=>Te.vendor_id===C.vendor_id);he?c({label:he.vendor_name,id:he.vendor_id,email:he.email}):(!i||!i.id)&&c(null)}else(!i||!i.id)&&c(null);d(Ze(C.purchase_date)),y(C.bill_number||""),console.log("Original line items from backend:",C.lineItems);const R=C.lineItems.map(he=>{const Te={...he,quantity:String(he.quantity||""),unit_cost:String(he.unit_cost||""),line_amount:parseFloat(String(he.line_amount??he.line_total??0)),quantity_to_order:0};return console.log("Mapped line item:",Te),Te});console.log("Final mapped line items:",R),b(R),O(R);const V=C.status==="Closed"?"Closed":"Open";console.log("Setting purchase order status:",V,"from fetched status:",C.status),U(V),j(C.global_gst_rate||Dc),console.log("State after setting:",{purchaseOrder:C,billNumber:C.bill_number||"",lineItems:C.lineItems,mappedLineItems:R,subTotal:parseFloat(String(C.subtotal))||0,totalGSTAmount:parseFloat(String(C.total_gst_amount))||0,totalAmount:parseFloat(String(C.total_amount))||0}),console.log("Raw vendors data (edit mode):",h.data);const pe=h.data.map(he=>({label:he.vendor_name,id:he.vendor_id,email:he.email}));console.log("Mapped vendors (edit mode):",pe),L(pe),Y(x.data),await _e(),me(!1),ir(!0)}catch(Q){console.error("Error fetching data:",Q),Q instanceof nr&&Q.response?.data?.message?pt(Q.response.data.message):pt("An unexpected error occurred")}};l.useEffect(()=>{t&&ue()},[t]),l.useEffect(()=>{console.log("lineItems state changed:",E)},[E]),l.useEffect(()=>{O(E)},[E]),l.useEffect(()=>{W(!1),Ee(null)},[t]);const Ce=Q=>xd(Un(Q.quantity),Un(Q.unit_cost)),Ie=l.useMemo(()=>_.map(Q=>({part_number:Q.part_number,part_description:Q.part_description,quantity:Un(Q.quantity),unit:Q.unit,unit_cost:Un(Q.unit_cost)})),[_]),le=l.useMemo(()=>k_(Ie,S),[Ie,S]),ce=le.subtotal,we=le.total_gst_amount,Oe=le.total_amount,Xe=l.useCallback(Q=>JSON.stringify(Q.map(h=>({part_number:h.part_number.trim(),part_description:h.part_description.trim(),quantity:parseFloat(String(h.quantity)),unit:h.unit.trim(),unit_cost:parseFloat(String(h.unit_cost))})).sort((h,x)=>h.part_number!==x.part_number?h.part_number.localeCompare(x.part_number):h.quantity-x.quantity)),[]);l.useEffect(()=>{if(!a&&!ge&&n&&jt===""&&Wt){console.log("[PO Detail] Setting initial signature for dirty tracking");const Q=JSON.stringify({vendor:i?{id:i.id,label:i.label}:null,billNumber:p.trim(),date:u?.toISOString(),lineItems:Xe(E),pickup_time:n.pickup_time||null,pickup_location:n.pickup_location||null,pickup_contact_person:n.pickup_contact_person||null,pickup_phone:n.pickup_phone||null,pickup_instructions:n.pickup_instructions||null,pickup_notes:n.pickup_notes||null,order_placed:n.order_placed||!1,order_placed_at:n.order_placed_at||null,order_placed_by:n.order_placed_by||null,order_placed_method:n.order_placed_method||null,vendor_confirmation_status:n.vendor_confirmation_status||"pending",vendor_confirmation_notes:n.vendor_confirmation_notes||null,vendor_confirmation_date:n.vendor_confirmation_date||null,pricing_updated:n.pricing_updated||!1,pricing_updated_at:n.pricing_updated_at||null,pricing_updated_by:n.pricing_updated_by||null,pricing_updated_method:n.pricing_updated_method||null,quantity_adjusted:n.quantity_adjusted||!1,quantity_adjusted_at:n.quantity_adjusted_at||null,quantity_adjusted_by:n.quantity_adjusted_by||null,quantity_adjusted_method:n.quantity_adjusted_method||null,original_quantities:n.original_quantities||null,adjusted_quantities:n.adjusted_quantities||null,vendor_pricing_notes:n.vendor_pricing_notes||null});Pt(Q)}},[a,ge,n,Wt,jt]);const xe=l.useMemo(()=>JSON.stringify({vendor:i?{id:i.id,label:i.label}:null,billNumber:p.trim(),date:u?.toISOString(),lineItems:Xe(E),pickup_time:n?.pickup_time||null,pickup_location:n?.pickup_location||null,pickup_contact_person:n?.pickup_contact_person||null,pickup_phone:n?.pickup_phone||null,pickup_instructions:n?.pickup_instructions||null,pickup_notes:n?.pickup_notes||null,order_placed:n?.order_placed||!1,order_placed_at:n?.order_placed_at||null,order_placed_by:n?.order_placed_by||null,order_placed_method:n?.order_placed_method||null,vendor_confirmation_status:n?.vendor_confirmation_status||"pending",vendor_confirmation_notes:n?.vendor_confirmation_notes||null,vendor_confirmation_date:n?.vendor_confirmation_date||null,pricing_updated:n?.pricing_updated||!1,pricing_updated_at:n?.pricing_updated_at||null,pricing_updated_by:n?.pricing_updated_by||null,pricing_updated_method:n?.pricing_updated_method||null,quantity_adjusted:n?.quantity_adjusted||!1,quantity_adjusted_at:n?.quantity_adjusted_at||null,quantity_adjusted_by:n?.quantity_adjusted_by||null,quantity_adjusted_method:n?.quantity_adjusted_method||null,original_quantities:n?.original_quantities||null,adjusted_quantities:n?.adjusted_quantities||null,vendor_pricing_notes:n?.vendor_pricing_notes||null}),[i,p,u,E,n]),Fe=!!jt&&jt!==xe&&!ye;l.useEffect(()=>{console.log("[PO Detail] isDirty changed:",{isDirty:Fe,hasInitialSignature:!!jt,signaturesMatch:jt===xe,initialSignature:jt.slice(0,100)+"...",currentSignature:xe.slice(0,100)+"..."}),console.log("[PO Detail] About to render UnsavedChangesGuard with when=",Fe)},[Fe,jt,xe]),l.useEffect(()=>{console.log("Aggregate quantities changed:",N),Object.keys(N).length>0&&b(Q=>{const h=Q.map(x=>{const C=N[x.part_number]||N[x.part_number.toUpperCase()]||N[x.part_number.toLowerCase()]||0,R=typeof C=="string"?parseFloat(C):C;return{...x,quantity_to_order:R}});return console.log("Updated line items from aggregate quantities effect:",h),h})},[N]);const Ge=(Q,h,x)=>{b(C=>{const R=[...C];if(!R[Q])return console.log("Item at index",Q,"not found in handleLineItemChange"),C;const V={...R[Q],[h]:x};return h==="quantity"&&parseFloat(x)<=0?R.filter((pe,he)=>he!==Q):((h==="quantity"||h==="unit_cost")&&(V.line_amount=Ce(V)),R[Q]=V,R)})},It=()=>{b(Q=>[...Q,{part_number:"",part_description:"",quantity:"",unit:ka[0],unit_cost:"",line_amount:0,quantity_to_order:0}])},rr=async Q=>{const h=Q.toUpperCase();if(!fe[h])try{const x=await qa(h);se(C=>({...C,[h]:x}))}catch{}},_r=(Q,h)=>{const x=fe[Q.toUpperCase()]||[];if(x.length===0)return Q;if(h){const V=x.filter(pe=>pe.vendor_id===h);if(V.length>0){const pe=V.find(Te=>Te.preferred);if(pe)return pe.vendor_part_number;const he=[...V].sort((Te,Ye)=>(Ye.usage_count||0)-(Te.usage_count||0))[0];if(he)return he.vendor_part_number}}const C=x.find(V=>V.preferred);if(C)return C.vendor_part_number;const R=[...x].sort((V,pe)=>(pe.usage_count||0)-(V.usage_count||0))[0];return R?R.vendor_part_number:Q};l.useEffect(()=>{i&&b(Q=>Q.map(h=>{const x=(h.part_number||"").toUpperCase(),C=fe[x];if(!C||C.length===0)return h;const R=_r(x,i?.id||null);return{...h,part_number:R}}))},[i,fe]);const Lr=Q=>{b(h=>h.filter((x,C)=>C!==Q))},dr=Q=>X.find(h=>h.part_number===Q),Ht=(Q,h)=>{console.log("handlePartNumberChange called:",{idx:Q,newValue:h,inventoryItemsLength:X.length}),O(x=>{const C=[...x],R=C[Q];if(console.log("Current item before change:",R),!R)return console.log("Current item not found, creating default item"),C[Q]={part_number:"",part_description:"",quantity:"",unit:ka[0],unit_cost:"",line_amount:0,quantity_to_order:0},C;if(h===null||typeof h=="string"&&h.trim()==="")console.log("Resetting line item to empty values"),!R.part_number&&!R.part_description&&!R.quantity&&!R.unit_cost?C[Q]={...R,part_number:"",part_description:"",quantity:"",unit:ka[0],unit_cost:"",line_amount:0,quantity_to_order:0}:console.log("Preserving existing data despite empty input value");else if(typeof h!="string"&&h.isNew)console.log("Opening part dialog for new part"),D(Q),je(!0);else if(typeof h=="string"){const V=dr(h);console.log("Found inventory item:",V);const pe=N[h]||N[h.toUpperCase()]||N[h.toLowerCase()]||0,he=typeof pe=="string"?parseFloat(pe):pe;if(console.log(`Quantity to order for ${h}:`,pe,"as number:",he),console.log("Available aggregate quantities keys:",Object.keys(N)),console.log("Looking for part:",h,"in aggregate quantities:",N),V){const Te=R.unit_cost,Ye=!Te||Te===""||Te==="0";C[Q]={...R,part_number:h,part_description:V.part_description,unit:V.unit,unit_cost:Ye?String(V.last_unit_cost):Te,quantity_to_order:he}}else console.log("Inventory item not found, preserving existing data"),C[Q]={...R,part_number:h,quantity_to_order:he}}return C[Q].line_amount=Ce(C[Q]),console.log("Updated item after change:",C[Q]),C}),typeof h=="string"&&h.trim()!==""&&_e()},Er=async(Q,h)=>{if(!Q||Q.trim()==="")return!1;try{return(await $.get("/api/purchase-history/check-bill-number",{params:{bill_number:Q.trim(),exclude_purchase_id:h}})).data.exists}catch(x){return console.error("Error checking duplicate bill number:",x),!1}},br=(Q=!1,h=!1)=>{let x={};i||(x.vendor="Vendor is required."),u||(x.date="Date is required."),Q&&!p.trim()&&(x.billNumber="Bill Number is required.");const C=E.map(V=>({part_number:V.part_number,part_description:V.part_description,quantity:Un(V.quantity),unit:V.unit,unit_cost:Un(V.unit_cost)})),R=E_(C,i,h);return R.lineItems&&E.length>0&&(x.lineItems=R.lineItems),Ke(x),x},pr=async()=>{const Q=br(!1,!1);if(Object.keys(Q).length>0){H.error("Please correct the errors before saving.");return}if(!(p&&p.trim()&&await Er(p,n?.purchase_id)&&!window.confirm(`Warning: Bill number "${p}" already exists in another purchase order. Do you want to proceed anyway?`))){de(!0);try{if(a){const h={vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:E.map(R=>({part_number:R.part_number.trim(),part_description:R.part_description.trim(),unit:R.unit.trim(),quantity:parseFloat(String(R.quantity)),unit_cost:parseFloat(String(R.unit_cost)),line_amount:parseFloat(String(R.line_amount))})),status:"Open",subtotal:ce,total_gst_amount:we,total_amount:Oe,global_gst_rate:S,company_id:s?.company_id,created_by:s?.id,pickup_time:n?.pickup_time||null,pickup_location:n?.pickup_location||null,pickup_contact_person:n?.pickup_contact_person||null,pickup_phone:n?.pickup_phone||null,pickup_instructions:n?.pickup_instructions||null,pickup_notes:n?.pickup_notes||null,order_placed:n?.order_placed||!1,order_placed_at:n?.order_placed_at||null,order_placed_by:n?.order_placed_by||null,order_placed_method:n?.order_placed_method||null,vendor_confirmation_status:n?.vendor_confirmation_status||"pending",vendor_confirmation_notes:n?.vendor_confirmation_notes||null,vendor_confirmation_date:n?.vendor_confirmation_date||null,pricing_updated:n?.pricing_updated||!1,pricing_updated_at:n?.pricing_updated_at||null,pricing_updated_by:n?.pricing_updated_by||null,pricing_updated_method:n?.pricing_updated_method||null,quantity_adjusted:n?.quantity_adjusted||!1,quantity_adjusted_at:n?.quantity_adjusted_at||null,quantity_adjusted_by:n?.quantity_adjusted_by||null,quantity_adjusted_method:n?.quantity_adjusted_method||null,original_quantities:n?.original_quantities||null,adjusted_quantities:n?.adjusted_quantities||null,vendor_pricing_notes:n?.vendor_pricing_notes||null};if(console.log("Creating new purchase order:",h),window.__poCreateInFlight){console.log("[PO] Skipping duplicate create (in flight)");return}window.__poCreateInFlight=!0;const x=await $.post("/api/purchase-orders",h);H.success("Purchase Order created successfully!");const C=x.data.purchase_id;window.__unsavedGuardAllowNext=!0,r(`/open-purchase-orders/${C}`)}else{const h={...n,vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:E.map(C=>({...C,part_number:C.part_number.trim(),part_description:C.part_description.trim(),unit:C.unit.trim(),quantity:parseFloat(String(C.quantity)),unit_cost:parseFloat(String(C.unit_cost)),line_amount:parseFloat(String(C.line_amount))})),status:I,subtotal:ce,total_gst_amount:we,total_amount:Oe,global_gst_rate:S,gst_rate:S,pickup_time:n?.pickup_time||null,pickup_location:n?.pickup_location||null,pickup_contact_person:n?.pickup_contact_person||null,pickup_phone:n?.pickup_phone||null,pickup_instructions:n?.pickup_instructions||null,pickup_notes:n?.pickup_notes||null,order_placed:n?.order_placed||!1,order_placed_at:n?.order_placed_at||null,order_placed_by:n?.order_placed_by||null,order_placed_method:n?.order_placed_method||null,vendor_confirmation_status:n?.vendor_confirmation_status||"pending",vendor_confirmation_notes:n?.vendor_confirmation_notes||null,vendor_confirmation_date:n?.vendor_confirmation_date||null,pricing_updated:n?.pricing_updated||!1,pricing_updated_at:n?.pricing_updated_at||null,pricing_updated_by:n?.pricing_updated_by||null,pricing_updated_method:n?.pricing_updated_method||null,quantity_adjusted:n?.quantity_adjusted||!1,quantity_adjusted_at:n?.quantity_adjusted_at||null,quantity_adjusted_by:n?.quantity_adjusted_by||null,quantity_adjusted_method:n?.quantity_adjusted_method||null,original_quantities:n?.original_quantities||null,adjusted_quantities:n?.adjusted_quantities||null,vendor_pricing_notes:n?.vendor_pricing_notes||null};console.log("Sending to backend (handleSave):",h);const x=await $.put(`/api/purchase-orders/${t}`,h);Et("Purchase Order updated successfully!"),setTimeout(()=>{window.__unsavedGuardAllowNext=!0},100),Pt(JSON.stringify({vendor:i,billNumber:p,date:u,lineItems:E,pickup_time:n?.pickup_time,pickup_location:n?.pickup_location,pickup_contact_person:n?.pickup_contact_person,pickup_phone:n?.pickup_phone,pickup_instructions:n?.pickup_instructions,pickup_notes:n?.pickup_notes,order_placed:n?.order_placed,order_placed_at:n?.order_placed_at,order_placed_by:n?.order_placed_by,order_placed_method:n?.order_placed_method,vendor_confirmation_status:n?.vendor_confirmation_status,vendor_confirmation_notes:n?.vendor_confirmation_notes,vendor_confirmation_date:n?.vendor_confirmation_date,pricing_updated:n?.pricing_updated,pricing_updated_at:n?.pricing_updated_at,pricing_updated_by:n?.pricing_updated_by,pricing_updated_method:n?.pricing_updated_method,quantity_adjusted:n?.quantity_adjusted,quantity_adjusted_at:n?.quantity_adjusted_at,quantity_adjusted_by:n?.quantity_adjusted_by,quantity_adjusted_method:n?.quantity_adjusted_method,original_quantities:n?.original_quantities,adjusted_quantities:n?.adjusted_quantities,vendor_pricing_notes:n?.vendor_pricing_notes}))}}catch(h){console.error("Error saving Purchase Order:",h),h instanceof nr&&h.response?.data?.error?H.error(`Error saving Purchase Order: ${h.response.data.error}`):H.error("Error saving Purchase Order. Please try again.")}finally{de(!1),window.__poCreateInFlight=!1}}},fr=async()=>{if(!n?.purchase_id){H.error("Purchase order not loaded. Cannot export.");return}if(n.status!=="Closed"){H.error("Only closed purchase orders can be exported to QuickBooks.");return}if(n.exported_to_qbo){H.error("Purchase order has already been exported to QuickBooks.");return}Qr(!0);try{const Q=await $.post(`/api/purchase-orders/${n.purchase_id}/export-to-qbo`);H.success("Exported to QuickBooks successfully!"),o(h=>h&&{...h,exported_to_qbo:!0})}catch(Q){const h=Q?.response?.data?.error||"Failed to export to QuickBooks.";H.error(h)}finally{Qr(!1)}},Jt=async()=>{if(!n?.purchase_id){H.error("Purchase order not loaded. Cannot reopen.");return}if(window.confirm("Are you sure you want to reopen this purchase order?"))try{const Q={...n,vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:E.map(h=>({...h,part_number:h.part_number.trim(),part_description:h.part_description.trim(),unit:h.unit.trim(),quantity:parseFloat(String(h.quantity)),unit_cost:parseFloat(String(h.unit_cost)),line_amount:parseFloat(String(h.line_amount))})),status:"Open",subtotal:ce,total_gst_amount:we,total_amount:Oe,global_gst_rate:S,gst_rate:S,pickup_time:n?.pickup_time||null,pickup_location:n?.pickup_location||null,pickup_contact_person:n?.pickup_contact_person||null,pickup_phone:n?.pickup_phone||null,pickup_instructions:n?.pickup_instructions||null,pickup_notes:n?.pickup_notes||null,order_placed:n?.order_placed||!1,order_placed_at:n?.order_placed_at||null,order_placed_by:n?.order_placed_by||null,order_placed_method:n?.order_placed_method||null,vendor_confirmation_status:n?.vendor_confirmation_status||"pending",vendor_confirmation_notes:n?.vendor_confirmation_notes||null,vendor_confirmation_date:n?.vendor_confirmation_date||null,pricing_updated:n?.pricing_updated||!1,pricing_updated_at:n?.pricing_updated_at||null,pricing_updated_by:n?.pricing_updated_by||null,pricing_updated_method:n?.pricing_updated_method||null,quantity_adjusted:n?.quantity_adjusted||!1,quantity_adjusted_at:n?.quantity_adjusted_at||null,quantity_adjusted_by:n?.quantity_adjusted_by||null,quantity_adjusted_method:n?.quantity_adjusted_method||null,original_quantities:n?.original_quantities||null,adjusted_quantities:n?.adjusted_quantities||null,vendor_pricing_notes:n?.vendor_pricing_notes||null};await $.put(`/api/purchase-orders/${n.purchase_id}`,Q),H.success("Purchase Order reopened successfully!"),o(h=>h&&{...h,status:"Open"}),U("Open"),r(`/open-purchase-orders/${n.purchase_id}`)}catch(Q){if(console.error("Error reopening purchase order:",Q),Q instanceof nr&&Q.response?.data?.error){const h=Q.response.data.error;h.toLowerCase().includes("negative quantity")||h.toLowerCase().includes("insufficient inventory")||h.toLowerCase().includes("inventory constraint")?H.error(`Cannot reopen: ${h}`):H.error(`Error reopening PO: ${h}`)}else H.error("Failed to reopen purchase order. Please try again.")}},Zt=async()=>{n?.purchase_id&&await Yr()},Yr=async()=>{if(!n?.purchase_id)return;const Q=br(!0,!0);if(Object.keys(Q).length>0){Q.lineItems?.some(C=>C.unit_cost)?H.error("Unit cost is required for all line items before closing a purchase order."):(at(!0),H.error("A bill number is required to close the purchase order."));return}if(!(await Er(p,n.purchase_id)&&!window.confirm(`Warning: Bill number "${p}" already exists in another purchase order. Do you want to proceed with closing this purchase order anyway?`)))try{const x={...n,vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:E.map(R=>({...R,part_number:R.part_number.trim(),part_description:R.part_description.trim(),unit:R.unit.trim(),quantity:parseFloat(String(R.quantity)),unit_cost:parseFloat(String(R.unit_cost)),line_amount:parseFloat(String(R.line_amount))})),status:"Closed",subtotal:ce,total_gst_amount:we,total_amount:Oe,global_gst_rate:S,gst_rate:S,pickup_time:n?.pickup_time||null,pickup_location:n?.pickup_location||null,pickup_contact_person:n?.pickup_contact_person||null,pickup_phone:n?.pickup_phone||null,pickup_instructions:n?.pickup_instructions||null,pickup_notes:n?.pickup_notes||null,order_placed:n?.order_placed||!1,order_placed_at:n?.order_placed_at||null,order_placed_by:n?.order_placed_by||null,order_placed_method:n?.order_placed_method||null,vendor_confirmation_status:n?.vendor_confirmation_status||"pending",vendor_confirmation_notes:n?.vendor_confirmation_notes||null,vendor_confirmation_date:n?.vendor_confirmation_date||null,pricing_updated:n?.pricing_updated||!1,pricing_updated_at:n?.pricing_updated_at||null,pricing_updated_by:n?.pricing_updated_by||null,pricing_updated_method:n?.pricing_updated_method||null,quantity_adjusted:n?.quantity_adjusted||!1,quantity_adjusted_at:n?.quantity_adjusted_at||null,quantity_adjusted_by:n?.quantity_adjusted_by||null,quantity_adjusted_method:n?.quantity_adjusted_method||null,original_quantities:n?.original_quantities||null,adjusted_quantities:n?.adjusted_quantities||null,vendor_pricing_notes:n?.vendor_pricing_notes||null},C=await $.put(`/api/purchase-orders/${n.purchase_id}`,x);C.status===200?(console.log("Purchase Order closed:",C.data),H.success("Purchase Order closed successfully!"),o(R=>R&&{...R,status:"Closed"}),U("Closed"),r(`/open-purchase-orders/${n.purchase_id}`)):H.error("Failed to close purchase order")}catch(x){if(console.error("Error closing purchase order:",x),x instanceof nr&&x.response?.data?.error){const C=x.response.data.error;C.toLowerCase().includes("negative quantity")||C.toLowerCase().includes("insufficient inventory")||C.toLowerCase().includes("inventory constraint")?H.error(`Cannot close: ${C}`):H.error(`Error closing PO: ${C}`)}else H.error("Failed to close purchase order. Please try again.")}},Dr=()=>{r(`/open-purchase-orders/${n?.purchase_id}`)},qr=()=>{ue(),H.success("Allocation changes saved successfully. Purchase order remains open.")},jr=async()=>{if(!br(!1)){H.error("Please correct the errors before proceeding with allocation.");return}try{const Q={...n,vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:E.map(h=>({...h,part_number:h.part_number.trim(),part_description:h.part_description.trim(),unit:h.unit.trim(),quantity:parseFloat(String(h.quantity)),unit_cost:parseFloat(String(h.unit_cost)),line_amount:parseFloat(String(h.line_amount))})),subtotal:ce,total_gst_amount:we,total_amount:Oe,global_gst_rate:S,gst_rate:S,pickup_time:n?.pickup_time||null,pickup_location:n?.pickup_location||null,pickup_contact_person:n?.pickup_contact_person||null,pickup_phone:n?.pickup_phone||null,pickup_instructions:n?.pickup_instructions||null,pickup_notes:n?.pickup_notes||null,order_placed:n?.order_placed||!1,order_placed_at:n?.order_placed_at||null,order_placed_by:n?.order_placed_by||null,order_placed_method:n?.order_placed_method||null,vendor_confirmation_status:n?.vendor_confirmation_status||"pending",vendor_confirmation_notes:n?.vendor_confirmation_notes||null,vendor_confirmation_date:n?.vendor_confirmation_date||null,pricing_updated:n?.pricing_updated||!1,pricing_updated_at:n?.pricing_updated_at||null,pricing_updated_by:n?.pricing_updated_by||null,pricing_updated_method:n?.pricing_updated_method||null,quantity_adjusted:n?.quantity_adjusted||!1,quantity_adjusted_at:n?.quantity_adjusted_at||null,quantity_adjusted_by:n?.quantity_adjusted_by||null,quantity_adjusted_method:n?.quantity_adjusted_method||null,original_quantities:n?.original_quantities||null,adjusted_quantities:n?.adjusted_quantities||null,vendor_pricing_notes:n?.vendor_pricing_notes||null};await $.put(`/api/purchase-orders/${n.purchase_id}`,Q),o(Q),ko(!0),H.success("Changes saved successfully. Opening allocation modal...")}catch(Q){console.error("Error saving changes before allocation:",Q),Q instanceof nr&&Q.response?.data?.error?H.error(`Error saving changes: ${Q.response.data.error}`):H.error("Failed to save changes before allocation. Please try again.")}},dn=async()=>{if(!n?.purchase_id){H.error("Purchase order not loaded. Cannot download PDF.");return}try{const Q=await $.get(`/api/purchase-orders/${n.purchase_id}/pdf`,{responseType:"blob"}),h=window.URL.createObjectURL(new Blob([Q.data])),x=document.createElement("a");x.href=h,x.download=`purchase_order_${n.purchase_number}.pdf`,document.body.appendChild(x),x.click(),x.remove(),window.URL.revokeObjectURL(h)}catch(Q){console.error("Error downloading PDF:",Q),H.error("Failed to download PDF. Please try again.")}},gr=async()=>{await pr(),!(Object.keys(Be).length>0)&&await dn()},On=()=>{if(!n)return;const Q=E.map(x=>x.quantity),h=prompt(`Enter adjusted quantities (comma-separated, e.g., 50,100,25):
Current quantities: `+Q.join(", ")+`
Note: Adjust based on vendor minimum orders (e.g., sold by 10ft packs)`);if(h)try{const x=h.split(",").map(C=>parseFloat(C.trim()));if(x.length!==E.length){H.error("Number of quantities must match number of line items");return}b(C=>C.map((R,V)=>({...R,quantity:x[V]}))),o(C=>C&&{...C,quantity_adjusted:!0,quantity_adjusted_at:new Date().toISOString(),quantity_adjusted_by:Number(s?.id),quantity_adjusted_method:"manual",original_quantities:Q,adjusted_quantities:x}),H.success("Quantities adjusted based on vendor confirmation")}catch{H.error("Invalid quantity format. Please use numbers separated by commas.")}},[Vr,ko]=l.useState(!1),[pn,rs]=l.useState(!1),[ia,Gr]=l.useState(""),[la,Qr]=l.useState(!1),[Po,Jr]=l.useState(!1),[ns,In]=l.useState([]),[ss,hn]=l.useState(!1),[as,mn]=l.useState(null),[ca,Eo]=l.useState({}),An=async()=>{if(n?.purchase_id){hn(!0),mn(null);try{const Q=await $.get(`/api/purchase-history/${n.purchase_id}/allocations`);In(Q.data||[]);const h=Array.from(new Set((Q.data||[]).map(x=>x.sales_order_id).filter(Boolean)));if(h.length>0)try{const x=await Promise.all(h.map(R=>$.get(`/api/sales-orders/${R}`))),C={};x.forEach((R,V)=>{const pe=h[V],he=R.data?.salesOrder?.sales_order_number||R.data?.salesOrder?.sales_number||"";he&&(C[pe]=he)}),Eo(C)}catch(x){console.warn("Unable to fetch one or more sales order numbers:",x)}Jr(!0)}catch(Q){console.error("Error fetching allocations:",Q),mn("Failed to load allocations."),Jr(!0)}finally{hn(!1)}}},[ua,Ur]=l.useState(!1),[Mn,Wr]=l.useState(""),[Do,os]=l.useState(""),[fn,To]=l.useState(""),[is,Oo]=l.useState(""),[Fr,ls]=l.useState(""),[Qi,Io]=l.useState(""),[Ji,Ki]=l.useState(""),[Xi,da]=l.useState(""),[pa,Zi]=l.useState(""),[ha,cs]=l.useState(""),Kr=Q=>Q.normalize("NFD").replace(/[̀-ͯ]/g,"").replace(/[^a-zA-Z0-9\s]/g," ").replace(/\s+/g," ").trim().toUpperCase(),ma=(Q,h)=>{const x=Kr(h);if(!x)return Q.slice(0,8);const C=Q.map(R=>{const V=Kr(R.label);let pe=-1;return V.startsWith(x)?pe=3:V.split(" ").some(he=>he.startsWith(x))?pe=2:V.includes(x)&&(pe=1),{opt:R,score:pe}}).filter(R=>R.score>=0);return C.sort((R,V)=>V.score-R.score||R.opt.label.localeCompare(V.opt.label)),C.slice(0,8).map(R=>R.opt)},Rn=Q=>{const h=Kr(Q);return g.find(x=>Kr(x.label)===h)||null},us=Q=>{const h=Kr(Q),x=X.find(C=>Kr(C.part_number)===h);return x?x.part_number:null},Ao=Q=>{const h=z.trim(),x=Q.key==="Enter",C=Q.key==="Tab",R=Q.key==="Escape",V=Q.key==="ArrowDown"||Q.key==="ArrowUp";if(R){W(!1);return}if(V){Q.key==="ArrowDown"&&!ee&&W(!0);return}if(x||C){if(x&&Q.ctrlKey&&h){Q.preventDefault(),G(!0),Wr(h),Ur(!0),W(!1);return}if(ee){if(x){const he=P;he&&he.isNew&&(Q.preventDefault(),G(!0),Wr(h),Ur(!0),W(!1))}return}const pe=Rn(h);if(!h)return;Q.preventDefault(),pe?(c(pe),ne(pe.label)):(G(!0),Wr(h),Ur(!0),W(!1))}},Mo=(Q,h)=>{const x=(E[Q]?.part_number||"").trim(),C=h.key==="Enter",R=h.key==="Tab",V=h.key==="Escape",pe=h.key==="ArrowDown"||h.key==="ArrowUp";if(V){Ee(null);return}if(pe){h.key==="ArrowDown"&&B!==Q&&Ee(Q);return}if(!(B===Q&&(C||R))&&(C||R)){if(C&&h.ctrlKey&&x){h.preventDefault(),De(Q),te(x),D(Q),je(!0),Ee(null);return}const he=us(x);if(!x)return;h.preventDefault(),he?Ht(Q,he):(De(Q),te(x),D(Q),je(!0),Ee(null))}},ds=Q=>{const h=g.find(x=>x.id===Q);return console.log("Getting vendor email for vendor ID:",Q),console.log("Selected vendor:",h),console.log("Vendor email:",h?.email),h?.email||""},Ro=async()=>{if(!i?.id){H.error("Please select a vendor first");return}if(a){if(!br(!1)){H.error("Please correct the errors before sending email.");return}try{const Q={vendor_id:i?.id,purchase_date:u?.toISOString(),bill_number:p.trim(),lineItems:E.map(V=>({part_number:V.part_number.trim(),part_description:V.part_description.trim(),unit:V.unit.trim(),quantity:parseFloat(String(V.quantity)),unit_cost:parseFloat(String(V.unit_cost)),line_amount:parseFloat(String(V.line_amount))})),status:"Open",subtotal:ce,total_gst_amount:we,total_amount:Oe,global_gst_rate:S,company_id:s?.company_id,created_by:s?.id,pickup_time:n?.pickup_time||null,pickup_location:n?.pickup_location||null,pickup_contact_person:n?.pickup_contact_person||null,pickup_phone:n?.pickup_phone||null,pickup_instructions:n?.pickup_instructions||null,pickup_notes:n?.pickup_notes||null,order_placed:n?.order_placed||!1,order_placed_at:n?.order_placed_at||null,order_placed_by:n?.order_placed_by||null,order_placed_method:n?.order_placed_method||null,vendor_confirmation_status:n?.vendor_confirmation_status||"pending",vendor_confirmation_notes:n?.vendor_confirmation_notes||null,vendor_confirmation_date:n?.vendor_confirmation_date||null,pricing_updated:n?.pricing_updated||!1,pricing_updated_at:n?.pricing_updated_at||null,pricing_updated_by:n?.pricing_updated_by||null,pricing_updated_method:n?.pricing_updated_method||null,quantity_adjusted:n?.quantity_adjusted||!1,quantity_adjusted_at:n?.quantity_adjusted_at||null,quantity_adjusted_by:n?.quantity_adjusted_by||null,quantity_adjusted_method:n?.quantity_adjusted_method||null,original_quantities:n?.original_quantities||null,adjusted_quantities:n?.adjusted_quantities||null,vendor_pricing_notes:n?.vendor_pricing_notes||null};console.log("Creating new purchase order for email:",Q);const x=(await $.post("/api/purchase-orders",Q)).data;o(x);const C=x.purchase_id;r(`/open-purchase-orders/${C}`);const R=ds(i.id);Gr(R),rs(!0),H.success("Purchase Order created and email modal opened!")}catch(Q){console.error("Error creating Purchase Order for email:",Q),Q instanceof nr&&Q.response?.data?.error?H.error(`Error creating Purchase Order: ${Q.response.data.error}`):H.error("Error creating Purchase Order. Please try again.")}}else{const Q=ds(i.id);console.log("Email button clicked - vendor ID:",i.id),console.log("Retrieved email:",Q),Gr(Q),rs(!0)}};l.useEffect(()=>{console.log("Part modal state changed - openPartDialog:",be,"partNumberForModal:",F,"partToAddIndex:",oe)},[be,F,oe]),l.useEffect(()=>{be&&Ee(null)},[be]),l.useEffect(()=>{if(i?.id){const Q=ds(i.id);console.log("Vendor changed - updating email:",Q),Gr(Q)}else Gr("")},[i,g]);const No=()=>{if(!n)return null;const Q=E||[];let h=Q.reduce((R,V)=>R+(Number(V.line_amount)||0),0),x=h*(n.global_gst_rate||5)/100,C=h+x;return isNaN(h)&&(h=0),isNaN(x)&&(x=0),isNaN(C)&&(C=0),e.jsxs(q,{p:{xs:2,md:4},maxWidth:1e3,mx:"auto",children:[e.jsx(f,{variant:"h4",gutterBottom:!0,children:"Purchase Order Details"}),e.jsx(mt,{variant:"outlined",sx:{mb:3},children:e.jsx(wt,{children:e.jsxs(T,{container:!0,spacing:{xs:2,md:3},children:[e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Purchase Order #:"})," ",n.purchase_number]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Vendor:"})," ",n.vendor_name||"N/A"]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Purchase Date:"})," ",n.purchase_date?new Date(n.purchase_date).toLocaleDateString():""]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Status:"})," ",n.status?.toUpperCase()||"N/A"]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"Bill Number:"})," ",n.bill_number||"N/A"]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"GST Rate:"})," ",(n.global_gst_rate||5).toFixed(2),"%"]}),e.jsxs(T,{item:!0,xs:12,sm:6,children:[e.jsx("b",{children:"QuickBooks Export:"})," ",n.exported_to_qbo?"Exported":n.qbo_export_status?`Error: ${n.qbo_export_status}`:"Not Exported"]})]})})}),e.jsx(f,{variant:"h5",gutterBottom:!0,children:"Items"}),e.jsx(mt,{variant:"outlined",children:e.jsx(wt,{children:Q.map((R,V)=>e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:6,sm:3,md:2,children:R.part_number}),e.jsx(T,{item:!0,xs:6,sm:5,md:4,children:R.part_description}),e.jsx(T,{item:!0,xs:4,sm:2,md:1.5,children:R.quantity}),e.jsx(T,{item:!0,xs:4,sm:2,md:1.5,children:R.unit}),e.jsx(T,{item:!0,xs:4,sm:2,md:1.5,children:lr(Number(R.unit_cost)||0)}),e.jsx(T,{item:!0,xs:4,sm:2,md:1,children:lr(Number(R.line_amount)||0)})]},V))})}),e.jsxs(q,{mt:4,display:"flex",flexDirection:"column",alignItems:"flex-end",children:[e.jsxs(f,{variant:"h6",children:["Subtotal: ",lr(h)]}),e.jsxs(f,{variant:"h6",children:["Total GST: ",lr(x)]}),e.jsxs(f,{variant:"h6",children:["Total Amount: ",lr(C)]})]}),e.jsxs(q,{mt:4,display:"flex",justifyContent:{xs:"center",sm:"flex-end"},gap:2,children:[e.jsx(K,{variant:"contained",color:"primary",startIcon:e.jsx(or,{}),onClick:gr,children:"Download PDF"}),!n?.exported_to_qbo&&s?.access_role==="Admin"&&e.jsx(K,{variant:"contained",color:"success",startIcon:e.jsx(Ga,{}),onClick:fr,disabled:la,children:la?"Exporting...":"Export to QuickBooks"}),(s?.access_role==="Admin"||s?.access_role==="Sales and Purchase")&&e.jsx(K,{variant:"contained",color:"primary",onClick:Jt,children:"Reopen PO"}),e.jsx(K,{variant:"outlined",color:"primary",onClick:An,children:"View Allocations"})]}),e.jsxs(lt,{open:Po,onClose:()=>Jr(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ct,{children:"Allocations"}),e.jsxs(ut,{dividers:!0,children:[ss&&e.jsx(q,{display:"flex",justifyContent:"center",alignItems:"center",py:4,children:e.jsx(it,{})}),!ss&&as&&e.jsx(Re,{severity:"error",children:as}),!ss&&!as&&(()=>{if(!ns||ns.length===0)return e.jsx(f,{variant:"body2",children:"No allocations were saved for this purchase order."});const R=ns.reduce((pe,he)=>{const Te=(he.part_number||"").toString();return pe[Te]||(pe[Te]=[]),pe[Te].push(he),pe},{}),V=Object.keys(R).sort();return e.jsx(tt,{spacing:3,children:V.map(pe=>{const he=R[pe],Te=he.find(Je=>Je.part_description)?.part_description||"",Ye=he.reduce((Je,Nt)=>Je+(Number(Nt.allocate_qty)||0),0);return e.jsxs(q,{children:[e.jsxs(f,{variant:"subtitle1",sx:{fontWeight:"bold"},children:[pe," ",Te?`- ${Te}`:""]}),e.jsx(Kt,{component:qe,sx:{mt:1},children:e.jsxs(Yt,{size:"small",children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{children:"Sales Order"}),e.jsx(re,{children:"Sales Order Number"}),e.jsx(re,{align:"right",children:"Allocated Qty"})]})}),e.jsxs(Gt,{children:[he.map(Je=>e.jsxs(rt,{children:[e.jsxs(re,{children:["#",Je.sales_order_id]}),e.jsx(re,{children:ca[Je.sales_order_id]?`SO-${ca[Je.sales_order_id]}`:"-"}),e.jsx(re,{align:"right",children:Number(Je.allocate_qty||0).toFixed(2)})]},Je.allocation_id)),e.jsxs(rt,{children:[e.jsx(re,{sx:{fontWeight:600},children:"Total"}),e.jsx(re,{align:"right",sx:{fontWeight:600},children:Ye.toFixed(2)})]})]})]})})]},pe)})})})()]}),e.jsx(dt,{children:e.jsx(K,{onClick:()=>Jr(!1),children:"Close"})})]})]})};return!a&&!n?e.jsx(q,{p:4,children:e.jsx(f,{variant:"h5",children:"Loading Purchase Order..."})}):ge?e.jsx(q,{p:4,children:e.jsx(f,{variant:"h5",children:"Loading..."})}):!a&&I==="Closed"?No():e.jsxs(e.Fragment,{children:[e.jsxs(Hr,{dateAdapter:Tn,children:[e.jsx(So,{when:Fe,onSave:pr}),e.jsxs(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(q,{children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:a?"Create New Purchase Order":`Edit Purchase Order: ${n?.purchase_number}`}),!a&&n&&e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:2,mt:1},children:[e.jsx(Le,{label:n.order_placed?"Order Placed":"Order Not Placed",color:n.order_placed?"success":"warning",variant:"outlined",size:"small"}),e.jsx(Le,{label:`Vendor: ${n.vendor_confirmation_status||"pending"}`,color:n.vendor_confirmation_status==="confirmed"?"success":n.vendor_confirmation_status==="partial"?"warning":n.vendor_confirmation_status==="unavailable"?"error":"default",variant:"outlined",size:"small"}),n.pricing_updated&&e.jsx(Le,{label:"Pricing Updated",color:"info",variant:"outlined",size:"small"}),n.quantity_adjusted&&e.jsx(Le,{label:"Quantities Adjusted",color:"secondary",variant:"outlined",size:"small"})]})]}),e.jsxs(tt,{direction:"row",spacing:1,children:[e.jsx(K,{variant:"contained",color:"primary",onClick:pr,startIcon:e.jsx(ts,{}),children:a?"Create Purchase Order":"Save Changes"}),!a&&e.jsxs(e.Fragment,{children:[e.jsx(K,{variant:"contained",color:"primary",onClick:Zt,startIcon:e.jsx(to,{}),children:"Close PO"}),e.jsx(K,{variant:"contained",color:"primary",onClick:gr,startIcon:e.jsx(or,{}),children:"Download PDF"}),e.jsx(K,{variant:"contained",onClick:Ro,startIcon:e.jsx(zi,{}),sx:{backgroundColor:"#ff9800","&:hover":{backgroundColor:"#f57c00"}},children:"Email Vendor"})]})]})]}),kt&&e.jsxs(Re,{severity:"warning",sx:{mb:3},onClose:()=>at(!1),children:[e.jsx(f,{variant:"body1",sx:{fontWeight:"medium"},children:"Bill Number Required"}),e.jsx(f,{variant:"body2",children:"A bill number is required to close this purchase order. Please enter a bill number before closing."})]}),e.jsx(qe,{sx:{p:3},children:e.jsxs(T,{container:!0,spacing:3,children:[e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(kr,{disablePortal:!1,open:ee,onOpen:()=>W(!0),onClose:()=>W(!1),autoHighlight:!0,value:i,onChange:(Q,h)=>{if(A){G(!1);return}h&&h.isNew?(Ur(!0),Wr(z),c(null),ne(""),W(!1)):(c(h),W(!1))},filterOptions:(Q,h)=>{const x=ma(Q,h.inputValue||""),C=!!Rn(h.inputValue||""),R=[...x];return(h.inputValue||"").trim()!==""&&!C&&R.push({label:`Add "${h.inputValue}" as New Vendor`,isNew:!0}),x.length===0&&(h.inputValue||"").trim()!==""&&!C,R},inputValue:z,onInputChange:(Q,h,x)=>{if(ne(h),x==="reset")return;(h||"").trim()||W(!1)},options:g,getOptionLabel:Q=>typeof Q=="string"?Q:Q.label,isOptionEqualToValue:(Q,h)=>Q.id===h.id,onHighlightChange:(Q,h)=>m(h),ListboxProps:{role:"listbox",style:{maxHeight:320,overflowY:"auto"}},renderOption:(Q,h)=>{const x=h.isNew,{key:C,...R}=Q;return e.jsxs("li",{...R,style:{display:"flex",alignItems:"center",opacity:x?.9:1},children:[x&&e.jsx(an,{fontSize:"small",style:{marginRight:8,color:"#666"}}),e.jsx("span",{children:h.label})]},C)},renderInput:Q=>e.jsx(ie,{...Q,label:"Vendor",error:!!Be.vendor,helperText:Be.vendor,onKeyDown:Ao,onBlur:()=>{if(W(!1),!i){const h=z.trim();if(h){const x=Rn(h);x&&(c(x),ne(x.label))}}},inputRef:h=>{ae.current=h}})})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{label:"Bill Number",value:p,onChange:Q=>{y(Q.target.value),Q.target.value.trim()!==""&&at(!1)},fullWidth:!0,error:!!Be.billNumber,helperText:Be.billNumber})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{label:"GST Rate (%)",type:"number",value:S,onChange:Q=>j(Number(Q.target.value)),fullWidth:!0,inputProps:{min:0,max:100,step:"0.01",readOnly:I==="Closed",onWheel:Q=>Q.currentTarget.blur()},helperText:"Change GST rate if needed (default 5%). This will affect GST and total calculations.",disabled:I==="Closed"})})]})}),e.jsxs(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:3,mb:2},children:[e.jsx(f,{variant:"h6",children:"Line Items"}),e.jsx(K,{variant:"contained",onClick:jr,startIcon:e.jsx(to,{}),sx:{backgroundColor:a?"#e0e0e0":"#ff9800",color:"#fff","&:hover":{backgroundColor:a?"#e0e0e0":"#f57c00"},"&.Mui-disabled":{color:"#fff"}},disabled:a,children:"  Allocate Parts"})]}),e.jsxs(qe,{sx:{p:3,mb:3,mt:0},elevation:3,children:[e.jsx(T,{container:!0,spacing:2,children:E.map((Q,h)=>e.jsxs(ft.Fragment,{children:[e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(kr,{disablePortal:!1,open:B===h,onOpen:()=>Ee(h),onClose:()=>Ee(null),autoHighlight:!0,value:Q.part_number,inputValue:et[h]??Q.part_number,onInputChange:(x,C,R)=>{if(Ve(pe=>({...pe,[h]:C})),R==="reset")return;(C||"").trim()||Ee(null)},onChange:(x,C)=>{if(typeof C=="string"){const R=C,V=X.find(Te=>Te.part_number===R),pe=N[R]||N[R?.toUpperCase?.()||""]||N[R?.toLowerCase?.()||""]||0,he=typeof pe=="string"?parseFloat(pe):pe;b(Te=>{const Ye=[...Te],Je=Ye[h];if(V){const Nt=Je.unit_cost,fa=String(!Nt||Nt===""||Nt==="0"?V.last_unit_cost:Nt),ps={...Je,part_number:R,part_description:V.part_description,unit:V.unit,unit_cost:fa,quantity_to_order:he};if(ps.line_amount=Ce(ps),Ye[h]=ps,rr(V.part_number),i?.id){const Nn=(()=>{const ga=fe[V.part_number.toUpperCase()]||[];if(ga.length===0)return null;const Lo=ga.filter(Xr=>Xr.vendor_id===i.id);if(Lo.length>0){const Xr=Lo.find(qo=>qo.preferred);if(Xr)return Xr.vendor_part_number;const xa=[...Lo].sort((qo,Sd)=>(Sd.usage_count||0)-(qo.usage_count||0))[0];if(xa)return xa.vendor_part_number}const el=ga.find(Xr=>Xr.preferred);if(el)return el.vendor_part_number;const tl=[...ga].sort((Xr,xa)=>(xa.usage_count||0)-(Xr.usage_count||0))[0];return tl?tl.vendor_part_number:null})();Nn&&(Ye[h].part_number=Nn)}}else Ye[h]={...Je,part_number:R};return Ye}),Ht(h,R),Ee(null),Ve(Te=>({...Te,[h]:""}))}else if(C&&typeof C=="object"&&"isNew"in C){const R=C.inputValue||"";te(R),D(h),je(!0),Ee(null),Ve(V=>({...V,[h]:""}))}},options:X.map(x=>x.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,handleHomeEndKeys:!0,getOptionLabel:x=>typeof x=="string"?x:x.label,renderOption:(x,C)=>{const R=typeof C=="object"&&C.isNew,V=typeof C=="string"?C:C.label,{key:pe,...he}=x;return e.jsxs("li",{...he,children:[R&&e.jsx(an,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof C=="string"?e.jsxs(q,{children:[e.jsx(f,{variant:"body2",children:C}),(()=>{const Te=X.find(Ye=>Ye.part_number===C);return Te?.part_description?e.jsx(f,{variant:"caption",color:"text.secondary",children:Te.part_description}):null})()]}):V]},pe)},filterOptions:(x,C)=>{const R=(C.inputValue||"").toUpperCase(),V=x.filter(Te=>{const Ye=X.find(Je=>Je.part_number===Te);return Ye?String(Te).toUpperCase().includes(R)||String(Ye.part_description||"").toUpperCase().includes(R):String(Te).toUpperCase().includes(R)}),pe=V.some(Te=>String(Te).toUpperCase()===R),he=[...V];return R&&!pe&&he.push({inputValue:C.inputValue,label:`Add "${C.inputValue}" as New Part`,isNew:!0}),he},ListboxProps:{role:"listbox",style:{maxHeight:320,overflowY:"auto"}},renderInput:x=>e.jsx(ie,{...x,label:"Part Number",fullWidth:!0,required:!0,error:!!Be.lineItems?.[h]?.part_number,helperText:Be.lineItems?.[h]?.part_number,onKeyDown:C=>Mo(h,C),onBlur:()=>{Ee(null);const R=(E[h]?.part_number||"").trim();if(!R)return;const V=us(R);if(V){const pe=X.find(Ye=>Ye.part_number===V),he=N[V]||N[V?.toUpperCase?.()||""]||N[V?.toLowerCase?.()||""]||0,Te=typeof he=="string"?parseFloat(he):he;b(Ye=>{const Je=[...Ye],Nt=Je[h];if(pe){const $r=Nt.unit_cost,ps=String(!$r||$r===""||$r==="0"?pe.last_unit_cost:$r),Nn={...Nt,part_number:V,part_description:pe.part_description,unit:pe.unit,unit_cost:ps,quantity_to_order:Te};Nn.line_amount=Ce(Nn),Je[h]=Nn}else Je[h]={...Nt,part_number:V};return Je}),Ht(h,V)}}})})}),e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(ie,{label:"Part Description",value:Q.part_description,InputProps:{readOnly:!0},fullWidth:!0,error:!!Be.lineItems?.[h]?.part_description,helperText:Be.lineItems?.[h]?.part_description})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1,children:e.jsx(ie,{label:"Qty",value:Q.quantity,onChange:x=>Ge(h,"quantity",x.target.value),type:"number",fullWidth:!0,required:!0,error:!!Be.lineItems?.[h]?.quantity,helperText:Be.lineItems?.[h]?.quantity,inputProps:{step:"1",onWheel:x=>x.currentTarget.blur()}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1,children:e.jsx(ie,{label:"Unit",value:Q.unit,select:!0,fullWidth:!0,disabled:!0,InputProps:{readOnly:!0},children:ka.map(x=>e.jsx(ze,{value:x,children:x},x))})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(ie,{label:"Unit Cost",value:Q.unit_cost,onChange:x=>Ge(h,"unit_cost",x.target.value),type:"number",fullWidth:!0,error:!!Be.lineItems?.[h]?.unit_cost,helperText:Be.lineItems?.[h]?.unit_cost,inputProps:{step:"0.01",onWheel:x=>x.currentTarget.blur()}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(ie,{label:"Amount",value:Q.line_amount!=null&&!isNaN(Number(Q.line_amount))?Number(Q.line_amount).toFixed(2):"0.00",InputProps:{readOnly:!0},fullWidth:!0})}),e.jsxs(T,{item:!0,xs:12,sm:1,md:1,sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(K,{variant:"outlined",color:"primary",onClick:()=>Lr(h),sx:{flexShrink:0},children:"Remove"}),(()=>{const x=a?"Open":I,C=x==="Open"&&typeof Q.quantity_to_order=="number"&&Q.quantity_to_order>0;return console.log(`Rendering Qty to Order for ${Q.part_number}:`,{status:I,isCreationMode:a,effectiveStatus:x,quantity_to_order:Q.quantity_to_order,type:typeof Q.quantity_to_order,shouldShow:C}),C?e.jsx(ie,{label:"Qty to Order",value:Q.quantity_to_order,size:"small",InputProps:{readOnly:!0},sx:{backgroundColor:"#fff3cd",minWidth:"120px","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"#ffc107"},"&:hover fieldset":{borderColor:"#ffc107"}}}}):null})()]})]},h))}),e.jsx(q,{sx:{mt:2},children:e.jsx(K,{variant:"outlined",color:"primary",onClick:It,children:"Add Line Item"})})]}),e.jsx(qe,{sx:{p:3,mb:3},elevation:3,children:e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsxs(f,{variant:"subtitle1",children:["Subtotal: $",ce!=null&&!isNaN(Number(ce))?Number(ce).toFixed(2):"0.00"]})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsxs(f,{variant:"subtitle1",children:["Total GST: $",we!=null&&!isNaN(Number(we))?Number(we).toFixed(2):"0.00"]})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsxs(f,{variant:"h6",children:["Total Amount: $",Oe!=null&&!isNaN(Number(Oe))?Number(Oe).toFixed(2):"0.00"]})})]})}),e.jsx(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:3,mb:2},children:e.jsx(f,{variant:"h6",children:"Pickup Details for Drivers"})}),e.jsx(qe,{sx:{p:3,mb:3},elevation:3,children:e.jsxs(T,{container:!0,spacing:3,children:[e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"Pickup Time",placeholder:"e.g., tomorrow at 2 PM, Friday morning",value:n?.pickup_time||"",onChange:Q=>{n&&o({...n,pickup_time:Q.target.value})},fullWidth:!0,helperText:"When to pick up the order"})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"Pickup Location",placeholder:"e.g., 123 Main St, Building A, Loading Dock",value:n?.pickup_location||"",onChange:Q=>{n&&o({...n,pickup_location:Q.target.value})},fullWidth:!0,helperText:"Where to pick up the order"})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"Contact Person",placeholder:"e.g., John Smith, Warehouse Manager",value:n?.pickup_contact_person||"",onChange:Q=>{n&&o({...n,pickup_contact_person:Q.target.value})},fullWidth:!0,helperText:"Name of person to contact at pickup location"})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsx(ie,{label:"Contact Phone",placeholder:"e.g., (555) 123-4567",value:n?.pickup_phone||"",onChange:Q=>{n&&o({...n,pickup_phone:Q.target.value})},fullWidth:!0,helperText:"Phone number for pickup contact person"})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"Pickup Instructions",placeholder:"e.g., Use loading dock on east side, call 15 minutes before arrival, parking available in lot B",value:n?.pickup_instructions||"",onChange:Q=>{n&&o({...n,pickup_instructions:Q.target.value})},fullWidth:!0,multiline:!0,rows:3,helperText:"Special instructions for pickup (parking, loading dock, etc.)"})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"Pickup Notes",placeholder:"e.g., After-hours pickup available, bring ID, parts are in warehouse section C",value:n?.pickup_notes||"",onChange:Q=>{n&&o({...n,pickup_notes:Q.target.value})},fullWidth:!0,multiline:!0,rows:2,helperText:"General notes about pickup for drivers"})})]})}),e.jsx(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:3,mb:2},children:e.jsx(f,{variant:"h6",children:"Order Placement Tracking"})}),e.jsx(qe,{sx:{p:3,mb:3},elevation:3,children:e.jsxs(T,{container:!0,spacing:3,children:[e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx("input",{type:"checkbox",checked:n?.order_placed||!1,onChange:Q=>{n&&o({...n,order_placed:Q.target.checked,order_placed_at:Q.target.checked?new Date().toISOString():void 0,order_placed_by:Q.target.checked?Number(s?.id):void 0,order_placed_method:Q.target.checked?"manual":void 0})},style:{transform:"scale(1.5)"}}),e.jsxs(q,{children:[e.jsx(f,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"Order Placed with Vendor"}),e.jsx(f,{variant:"body2",color:"text.secondary",children:n?.order_placed?`Placed on ${new Date(n.order_placed_at||"").toLocaleDateString()}`:"Order not yet placed"})]})]})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsxs(ie,{select:!0,label:"Vendor Confirmation Status",value:n?.vendor_confirmation_status||"pending",onChange:Q=>{n&&o({...n,vendor_confirmation_status:Q.target.value,vendor_confirmation_date:Q.target.value!=="pending"?new Date().toISOString():void 0})},fullWidth:!0,helperText:"Current vendor confirmation status",children:[e.jsx(ze,{value:"pending",children:"Pending"}),e.jsx(ze,{value:"confirmed",children:"Confirmed"}),e.jsx(ze,{value:"partial",children:"Partially Available"}),e.jsx(ze,{value:"unavailable",children:"Unavailable"})]})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"Vendor Confirmation Notes",placeholder:"e.g., Parts available, pricing confirmed, minimum order 10ft packs",value:n?.vendor_confirmation_notes||"",onChange:Q=>{n&&o({...n,vendor_confirmation_notes:Q.target.value})},fullWidth:!0,multiline:!0,rows:2,helperText:"Notes from vendor about order confirmation, availability, and pricing"})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx("input",{type:"checkbox",checked:n?.pricing_updated||!1,onChange:Q=>{n&&o({...n,pricing_updated:Q.target.checked,pricing_updated_at:Q.target.checked?new Date().toISOString():void 0,pricing_updated_by:Q.target.checked?Number(s?.id):void 0,pricing_updated_method:Q.target.checked?"manual":void 0})},style:{transform:"scale(1.5)"}}),e.jsxs(q,{children:[e.jsx(f,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"Pricing Updated"}),e.jsx(f,{variant:"body2",color:"text.secondary",children:n?.pricing_updated?`Updated on ${new Date(n.pricing_updated_at||"").toLocaleDateString()}`:"Pricing not yet updated"})]})]})}),e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx("input",{type:"checkbox",checked:n?.quantity_adjusted||!1,onChange:Q=>{n&&o({...n,quantity_adjusted:Q.target.checked,quantity_adjusted_at:Q.target.checked?new Date().toISOString():void 0,quantity_adjusted_by:Q.target.checked?Number(s?.id):void 0,quantity_adjusted_method:Q.target.checked?"manual":void 0})},style:{transform:"scale(1.5)"}}),e.jsxs(q,{children:[e.jsx(f,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"Quantities Adjusted"}),e.jsx(f,{variant:"body2",color:"text.secondary",children:n?.quantity_adjusted?`Adjusted on ${new Date(n.quantity_adjusted_at||"").toLocaleDateString()}`:"Quantities not yet adjusted"})]})]})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"Vendor Pricing Structure Notes",placeholder:"e.g., Sold by 10ft packs, minimum order 50ft, bulk pricing available over 100ft",value:n?.vendor_pricing_notes||"",onChange:Q=>{n&&o({...n,vendor_pricing_notes:Q.target.value})},fullWidth:!0,multiline:!0,rows:2,helperText:"Notes about vendor pricing structure, minimum orders, and packaging units"})}),e.jsxs(T,{item:!0,xs:12,children:[e.jsx(q,{sx:{display:"flex",justifyContent:"center",mt:2},children:e.jsx(K,{variant:"outlined",color:"primary",onClick:On,disabled:!n||E.length===0,sx:{minWidth:"200px"},children:"Adjust Quantities (Vendor Confirmation)"})}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{textAlign:"center",mt:1},children:"Use this when vendor confirms different quantities (e.g., sold by 10ft packs)"})]}),(n?.original_quantities||n?.adjusted_quantities)&&e.jsxs(T,{item:!0,xs:12,children:[e.jsx(f,{variant:"subtitle1",sx:{fontWeight:"bold",mb:2},children:"Quantity Adjustments"}),e.jsx(T,{container:!0,spacing:2,children:E.map((Q,h)=>{const x=n?.original_quantities?.[h]||Q.quantity,C=n?.adjusted_quantities?.[h]||Q.quantity;return x!==C?e.jsx(T,{item:!0,xs:12,sm:6,children:e.jsxs(qe,{sx:{p:2,backgroundColor:"#f5f5f5"},elevation:1,children:[e.jsx(f,{variant:"body2",sx:{fontWeight:"bold"},children:Q.part_number}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Original: ",x," → Adjusted: ",C]})]})},h):null})})]})]})}),e.jsx(kn,{open:be,onClose:()=>{je(!1),D(null),te("")},onSave:async Q=>{try{const h=await $.post("/api/inventory",Q);console.log("New part added successfully:",h.data);const x=await $.get("/api/inventory");Y(x.data);const C=h.data.item;oe!==null&&b(R=>{const V=[...R];return V[oe]={...V[oe],part_number:C.part_number,part_description:C.part_description,unit:C.unit,unit_cost:String(C.last_unit_cost),quantity:V[oe].quantity},V[oe].line_amount=Ce(V[oe]),V}),D(null),te("")}catch(h){throw h}},title:"Add New Part",initialPart:{part_number:F.toUpperCase(),category:"Uncategorized"}}),e.jsx(Gu,{open:ua,onClose:()=>Ur(!1),onSave:async Q=>{try{const x=(await $.post("/api/vendors",Q)).data.vendor;L(C=>[...C,{label:x.vendor_name,id:x.vendor_id}]),c({label:x.vendor_name,id:x.vendor_id}),!a&&n&&o(C=>C&&{...C,vendor_id:x.vendor_id,vendor_name:x.vendor_name}),Ur(!1),H.success("Vendor added successfully!")}catch{H.error("Failed to add vendor.")}},initialVendor:{vendor_name:Mn},isEditMode:!1}),e.jsx(C_,{open:Vr,onClose:()=>ko(!1),purchaseOrderId:n?.purchase_id||0,onSuccess:Dr,onAllocationSaved:qr}),e.jsx(fd,{open:pn,onClose:()=>rs(!1),type:"purchase-order",recordId:n?.purchase_id,defaultTo:ia,allowMessageEdit:!0}),pn&&e.jsxs("div",{style:{display:"none"},children:["Debug: vendorEmail = ",ia,", vendor = ",JSON.stringify(i)]})]})]}),e.jsx(zr,{open:!!Ct,autoHideDuration:6e3,onClose:()=>Et(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Re,{onClose:()=>Et(null),severity:"success",sx:{width:"100%"},children:Ct})})]})};var Rs={},Oc;function D_(){if(Oc)return Rs;Oc=1;var t=At();Object.defineProperty(Rs,"__esModule",{value:!0}),Rs.default=void 0;var r=t(Rt()),s=Mt();return Rs.default=(0,r.default)((0,s.jsx)("path",{d:"m22 9.24-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28z"}),"StarBorder"),Rs}var T_=D_();const O_=vt(T_);var Ns={},Ic;function I_(){if(Ic)return Ns;Ic=1;var t=At();Object.defineProperty(Ns,"__esModule",{value:!0}),Ns.default=void 0;var r=t(Rt()),s=Mt();return Ns.default=(0,r.default)((0,s.jsx)("path",{d:"M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"}),"Star"),Ns}var A_=I_();const M_=vt(A_);var Ls={},Ac;function R_(){if(Ac)return Ls;Ac=1;var t=At();Object.defineProperty(Ls,"__esModule",{value:!0}),Ls.default=void 0;var r=t(Rt()),s=Mt();return Ls.default=(0,r.default)((0,s.jsx)("path",{d:"M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3m5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72z"}),"Mic"),Ls}var N_=R_();const L_=vt(N_);var qs={},Mc;function q_(){if(Mc)return qs;Mc=1;var t=At();Object.defineProperty(qs,"__esModule",{value:!0}),qs.default=void 0;var r=t(Rt()),s=Mt();return qs.default=(0,r.default)((0,s.jsx)("path",{d:"M6 6h12v12H6z"}),"Stop"),qs}var U_=q_();const W_=vt(U_);class F_{mediaRecorder=null;audioChunks=[];isRecording=!1;stream=null;async startRecording(){try{this.stream=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});const r={mimeType:"audio/webm;codecs=opus",audioBitsPerSecond:16e3};MediaRecorder.isTypeSupported(r.mimeType)||delete r.mimeType,this.mediaRecorder=new MediaRecorder(this.stream,r),this.audioChunks=[],this.isRecording=!0,this.mediaRecorder.ondataavailable=s=>{s.data.size>0&&this.audioChunks.push(s.data)},this.mediaRecorder.start(1e3)}catch(r){throw console.error("Error starting voice recording:",r),new Error("Failed to start voice recording. Please check microphone permissions.")}}async stopRecording(){return new Promise((r,s)=>{if(!this.mediaRecorder||!this.isRecording){s(new Error("No active recording"));return}this.mediaRecorder.onstop=async()=>{try{this.isRecording=!1;const a=new Blob(this.audioChunks,{type:"audio/wav"}),n=await this.processAudioQuery(a);r(n)}catch(a){s(a)}finally{this.cleanup()}},this.mediaRecorder.stop()})}cleanup(){this.stream&&(this.stream.getTracks().forEach(r=>r.stop()),this.stream=null),this.mediaRecorder=null,this.audioChunks=[],this.isRecording=!1}async processAudioQuery(r){try{if(r.size>1048576)throw new Error(`Audio file too large (${(r.size/1024/1024).toFixed(2)}MB). Please record a shorter message.`);const a=await this.blobToBase64(r);return(await $.post("/api/voice-search/search-parts",{audioData:a,audioFormat:r.type||"audio/webm"})).data}catch(s){throw console.error("Error processing voice query:",s),s instanceof Error?new Error(s.message):new Error("Failed to process voice query. Please try again.")}}blobToBase64(r){return new Promise((s,a)=>{const n=new FileReader;n.onload=()=>{const i=n.result.split(",")[1];s(i)},n.onerror=a,n.readAsDataURL(r)})}async interpretTextQuery(r){try{return(await $.post("/api/voice-search/interpret-query",{query:r})).data}catch(s){return console.error("Error interpreting text query:",s),{query:r,searchInPartNumbers:!0,searchInDescriptions:!0,extractedTerms:[r]}}}isRecordingActive(){return this.isRecording}cancelRecording(){this.isRecording&&(this.mediaRecorder?.stop(),this.cleanup())}}const $_=new F_,B_=({onSearchTerms:t,disabled:r=!1})=>{const[s,a]=l.useState(!1),[n,o]=l.useState(!1),[i,c]=l.useState(""),u=l.useRef(null),d=l.useRef(null),p=()=>{const E=typeof window<"u"&&window.process&&window.process.type;if(typeof window<"u"&&"webkitSpeechRecognition"in window&&!u.current){const b=window.webkitSpeechRecognition||window.SpeechRecognition;u.current=new b,u.current.continuous=!1,u.current.interimResults=!0,u.current.lang="en-US",E&&console.log("Running in Electron environment"),u.current.onresult=I=>{let U="",S="";for(let j=I.resultIndex;j<I.results.length;j++){const N=I.results[j][0].transcript;I.results[j].isFinal?U+=N:S+=N}c(U+S),U.trim()&&O(U.trim())},u.current.onerror=I=>{console.error("Speech recognition error:",I.error),I.error==="network"?(typeof window<"u"&&window.process&&window.process.type?H.error("Voice recognition network error in Electron. Please try again or use text search."):H.error("Voice recognition requires internet connection. Please try again."),a(!1)):I.error==="not-allowed"?(H.error("Microphone access denied. Please allow microphone access."),a(!1)):I.error==="no-speech"?(H.info("No speech detected. Please try again."),a(!1)):I.error==="audio-capture"?(H.error("Audio capture error. Please check your microphone."),a(!1)):I.error==="service-not-allowed"?(H.error("Voice recognition service not allowed. This is common in Electron apps."),a(!1)):(console.error("Speech recognition error:",I.error),H.error(`Voice recognition error: ${I.error}. Please try again.`),a(!1))},u.current.onend=()=>{a(!1),c("")}}},y=()=>{try{if(!(typeof window<"u"&&("webkitSpeechRecognition"in window||"SpeechRecognition"in window))){H.error("Voice recognition not available in this browser.");return}typeof window<"u"&&window.process&&window.process.type&&H.info("Voice recognition in Electron may have limitations. If it doesn't work, please use text search."),p(),u.current&&(a(!0),c(""),u.current.start(),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{s&&w()},8e3))}catch(E){console.error("Error starting voice recognition:",E),H.error("Failed to start voice recognition."),a(!1)}},w=()=>{u.current&&u.current.stop(),a(!1),d.current&&clearTimeout(d.current)},O=async E=>{try{o(!0),c("");const b=await $_.interpretTextQuery(E);t(b.extractedTerms,{searchInPartNumbers:b.searchInPartNumbers,searchInDescriptions:b.searchInDescriptions}),H.success(`Voice search: "${E}" → ${b.extractedTerms.join(", ")}`)}catch(b){console.error("Error processing voice input:",b),H.error("Failed to process voice input. Please try again.")}finally{o(!1)}},_=()=>{s?w():y()};return e.jsxs(q,{children:[e.jsx(K,{variant:"contained",size:"large",onClick:_,disabled:r||n,startIcon:n?e.jsx(it,{size:20,color:"inherit"}):s?e.jsx(W_,{}):e.jsx(L_,{}),sx:{backgroundColor:s?"error.main":"primary.main",color:"white","&:hover":{backgroundColor:s?"error.dark":"primary.dark"},minWidth:120,height:48},children:n?"Processing...":s?"Stop":"Voice Search"}),s&&e.jsxs(q,{display:"flex",alignItems:"center",gap:1,mt:1,children:[e.jsx(q,{sx:{width:8,height:8,borderRadius:"50%",backgroundColor:"error.main",animation:"pulse 1s infinite","@keyframes pulse":{"0%":{opacity:1},"50%":{opacity:.3},"100%":{opacity:1}}}}),e.jsxs(f,{variant:"caption",color:"text.secondary",children:["Listening... ",i&&`"${i}"`]})]})]})},z_="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),H_="0123456789".split("");function yd(t,r,s){return`so:${r}:${t}:${s}`}function Rc(t,r,s){try{const a=localStorage.getItem(yd(t,r,s));if(!a)return[];const n=JSON.parse(a);return Array.isArray(n)?n:[]}catch{return[]}}function Nc(t,r,s,a){try{localStorage.setItem(yd(t,r,s),JSON.stringify(a.slice(0,50)))}catch{}}function vd(){return"partFinder:usage:global"}function _d(t,r){return`partFinder:usage:so:${t}:${r}`}function Y_(){try{const t=localStorage.getItem(vd());return t?JSON.parse(t):{}}catch{return{}}}function V_(t){try{localStorage.setItem(vd(),JSON.stringify(t))}catch{}}function G_(t,r){try{const s=localStorage.getItem(_d(t,r));return s?JSON.parse(s):{}}catch{return{}}}function Q_(t,r,s){try{localStorage.setItem(_d(t,r),JSON.stringify(s))}catch{}}function J_(t){const{open:r,onClose:s,onSelect:a,salesOrderId:n,context:o,inventoryItems:i}=t,[c,u]=l.useState(""),[d,p]=l.useState(""),[y,w]=l.useState([]),[O,_]=l.useState([]),[E,b]=l.useState([]),[I,U]=l.useState({}),[S,j]=l.useState({}),[N,k]=l.useState([]),[M,v]=l.useState(null);l.useEffect(()=>{r&&(_(Rc("favorites",n,o)),b(Rc("recents",n,o)),U(G_(n,o)),j(Y_()))},[r,n,o]);const g=l.useMemo(()=>{const P=c.toUpperCase(),m=new Set(y.map(X=>X.toUpperCase())),A=new Set(N.map(X=>X.toUpperCase())),G=d.trim().toUpperCase();return i.filter(X=>{const Y=(X.part_number||"").toUpperCase(),fe=(X.part_description||"").toUpperCase();if(P&&!Y.startsWith(P)||G&&!(Y.includes(G)||fe.includes(G)))return!1;for(const se of m)if(!(Y.includes(se)||fe.includes(se)))return!1;if(N.length>0&&M){let se=!1;for(const ke of A){if(M.searchInPartNumbers&&Y.includes(ke)){se=!0;break}if(M.searchInDescriptions&&fe.includes(ke)){se=!0;break}}if(!se)return!1}return!0})},[i,c,y,d,N,M]),L=l.useMemo(()=>{const P={},m=new Set(y.map(ge=>ge.toUpperCase())),A=new Set(O),G=new Set(E),X={SS:"STAINLESS",STAIN:"STAINLESS",STAINLESS:"STAINLESS",AL:"ALUMINUM",ALUM:"ALUMINUM",GALV:"GALVANIZED",GALVANIZED:"GALVANIZED",SQ:"SQUARE",RECT:"RECTANGULAR",TUBE:"TUBING"},Y=new Set(["TUBING","PIPE","ANGLE","BAR","FLAT","BEAM","CHANNEL","SHEET","PLATE","ROUND","SQUARE","RECTANGULAR"]),fe=ge=>X[ge]||ge,se=(ge,me)=>{const be=ge.trim();!be||m.has(be)||(P[be]=(P[be]||0)+me)},ke=ge=>{const[me,be]=ge.split("/").map(Number);return!me||!be?null:(me/be).toFixed(4).replace(/0+$/,"").replace(/\.$/,"")},Pe=ge=>{const me=[];if(!ge)return me;let be=ge.toUpperCase().replace(/[\s-]+/g,"").replace(/×/g,"X").replace(/[()]/g,"");const je=be.match(/\d+\/\d+/g)||[];if(be.includes("X")){const oe=be.split("X");oe.length>=2&&oe.length<=4&&(me.push(oe.slice(0,2).join("X")),me.push(oe.join("X")))}return je.forEach(oe=>{me.push(oe);const D=ke(oe);D&&me.push(D)}),(be.match(/(\d+)GA/g)||[]).forEach(oe=>me.push(oe)),(be.match(/SCH\s*\d+/g)||[]).forEach(oe=>me.push(oe.replace(/\s+/g,""))),(be.match(/OD\d+(?:\.\d+)?/g)||[]).forEach(oe=>me.push(oe)),(be.match(/ID\d+(?:\.\d+)?/g)||[]).forEach(oe=>me.push(oe)),(be.match(/\d+(?:\.\d+)?/g)||[]).slice(0,3).forEach(oe=>me.push(oe)),Array.from(new Set(me))};for(const ge of g){const be=String(ge.part_description||"").toUpperCase().split(/[^A-Z0-9]+/).filter(Ke=>Ke.length>=2&&!m.has(Ke)).map(fe),je=I[ge.part_number]?.count||0,oe=S[ge.part_number]?.count||0,D=I[ge.part_number]?.last||0,F=Date.now(),te=D?(F-D)/(1e3*60*60*24):365,B=te<=7?1:te<=30?.5:0;let Ee=1+je*.5+oe*.25+B;A.has(ge.part_number)&&(Ee+=3),G.has(ge.part_number)&&(Ee+=1);const Se=d.trim().toUpperCase(),$e=(ge.part_number||"").toUpperCase(),He=(ge.part_description||"").toUpperCase(),De=Se&&($e.startsWith(Se)||He.includes(Se))?.5:0,et=[];be.forEach(Ke=>{Y.has(Ke)&&et.push(Ke),se(Ke,Ee*(1+De+(Se&&Ke.includes(Se)?.5:0)))});const Ve=Array.from(new Set(be));Ve.forEach(Ke=>Ve.forEach(We=>{Ke!==We&&(Y.has(Ke)||Y.has(We))&&se(`${Ke} ${We}`,Ee*1.2)}));const Be=Pe($e);Be.forEach(Ke=>se(Ke,Ee*1.3)),Be[0]&&et.slice(0,2).forEach(Ke=>se(`${Ke} ${Be[0]}`,Ee*1.5))}return Object.entries(P).sort((ge,me)=>me[1]-ge[1]).slice(0,24).map(([ge])=>ge)},[g,y,O,E,I,S,d]),z=g,ne=l.useMemo(()=>z.slice(0,200),[z]),ae=P=>{w(m=>m.includes(P)?m.filter(A=>A!==P):[...m,P])},ee=()=>{u(""),w([]),k([]),v(null)},W=P=>O.includes(P),Z=P=>{_(m=>{const A=m.includes(P)?m.filter(G=>G!==P):[P,...m];Nc("favorites",n,o,A);try{fetch(`/api/part-finder/${n}/favorite`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_number:P,context:o,value:!m.includes(P)})}).catch(()=>{})}catch{}return A})},J=P=>{b(m=>{const A=[P.part_number,...m.filter(G=>G!==P.part_number)].slice(0,20);return Nc("recents",n,o,A),A}),U(m=>{const A={...m},G=A[P.part_number]||{count:0,last:0};return G.count+=1,G.last=Date.now(),A[P.part_number]=G,Q_(n,o,A),A}),j(m=>{const A={...m},G=A[P.part_number]||{count:0,last:0};return G.count+=1,G.last=Date.now(),A[P.part_number]=G,V_(A),A}),a(P);try{fetch(`/api/part-finder/${n}/use`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({part_number:P.part_number,context:o})}).catch(()=>{})}catch{}};return e.jsxs(lt,{open:r,onClose:s,maxWidth:"lg",fullWidth:!0,fullScreen:!1,"aria-labelledby":"part-finder-title",children:[e.jsx(ct,{id:"part-finder-title",children:"Find Part"}),e.jsxs(ut,{dividers:!0,children:[e.jsx(q,{mb:2,children:e.jsxs(q,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[e.jsx(ie,{fullWidth:!0,placeholder:"Search by part # or description",value:d,onChange:P=>p(P.target.value),InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:e.jsx(yr,{})})}}),e.jsx(B_,{onSearchTerms:(P,m)=>{k(P),v(m)},disabled:!1})]})}),null,e.jsxs(q,{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mb:2,children:[!!c&&e.jsx(Le,{label:`Prefix: ${c}`,color:"primary",onDelete:()=>u(""),sx:{height:40,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:16,fontWeight:600}}}),y.map(P=>e.jsx(Le,{label:P,color:"secondary",onDelete:()=>ae(P),sx:{height:38,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:15,fontWeight:600}}},P)),N.length>0&&e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(f,{variant:"caption",color:"text.secondary",children:"Voice:"}),N.map(P=>e.jsx(Le,{label:P,color:"success",variant:"outlined",size:"small",sx:{height:32,"& .MuiChip-label":{px:1.5,py:.5,fontSize:12}}},P)),M&&e.jsxs(f,{variant:"caption",color:"text.secondary",sx:{ml:1},children:["(",M.searchInPartNumbers?"Part#":"",M.searchInPartNumbers&&M.searchInDescriptions?" + ":"",M.searchInDescriptions?"Desc":"",")"]})]}),(!!c||y.length>0||N.length>0)&&e.jsx(K,{onClick:ee,children:"Clear All"})]}),e.jsxs(q,{display:"flex",gap:2,mb:2,flexWrap:"wrap",children:[e.jsxs(q,{children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Part # Starts With"}),e.jsxs(q,{display:"flex",flexWrap:"wrap",gap:1.5,children:[z_.map(P=>e.jsx(Le,{label:P,variant:c.startsWith(P)?"filled":"outlined",onClick:()=>u(P),sx:{height:44,borderRadius:2,"& .MuiChip-label":{px:2.25,py:1.25,fontSize:18,fontWeight:700}}},P)),H_.map(P=>e.jsx(Le,{label:P,variant:c.startsWith(P)?"filled":"outlined",onClick:()=>u(P),sx:{height:44,borderRadius:2,"& .MuiChip-label":{px:2.25,py:1.25,fontSize:18,fontWeight:700}}},P))]})]}),e.jsxs(q,{children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Description Tokens"}),e.jsx(q,{display:"flex",flexWrap:"wrap",gap:1.5,children:L.map(P=>e.jsx(Le,{label:P,clickable:!0,color:y.includes(P)?"secondary":"default",onClick:()=>ae(P),sx:{height:40,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:16,fontWeight:600}}},P))})]})]}),e.jsx(Sn,{sx:{my:2}}),e.jsxs(q,{mb:2,children:[O.length>0&&e.jsxs(q,{mb:1,children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Favorites for this Sales Order"}),e.jsx(q,{display:"flex",flexWrap:"wrap",gap:1.25,children:O.map(P=>{const m=i.find(A=>A.part_number===P);return m?e.jsx(Le,{label:`${m.part_number}`,onClick:()=>J(m),title:m.part_description,sx:{height:38,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:15,fontWeight:600}}},P):null})})]}),E.length>0&&e.jsxs(q,{children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Recents for this Sales Order"}),e.jsx(q,{display:"flex",flexWrap:"wrap",gap:1.25,children:E.map(P=>{const m=i.find(A=>A.part_number===P);return m?e.jsx(Le,{variant:"outlined",label:`${m.part_number}`,onClick:()=>J(m),title:m.part_description,sx:{height:38,borderRadius:2,"& .MuiChip-label":{px:2,py:1,fontSize:15,fontWeight:600}}},P):null})})]})]}),e.jsxs(T,{container:!0,spacing:2,children:[ne.map(P=>e.jsx(T,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsxs(q,{sx:{border:"1px solid #ddd",borderRadius:1,p:1.5,display:"flex",flexDirection:"column",gap:1,height:"100%"},children:[e.jsxs(q,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(f,{variant:"subtitle1",sx:{fontWeight:700},children:P.part_number}),e.jsx(ar,{title:W(P.part_number)?"Remove favorite":"Add favorite",children:e.jsx(ot,{size:"small",onClick:()=>Z(P.part_number),children:W(P.part_number)?e.jsx(M_,{color:"warning",fontSize:"small"}):e.jsx(O_,{fontSize:"small"})})})]}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{minHeight:40},children:P.part_description||"—"}),e.jsxs(q,{mt:"auto",display:"flex",gap:1,children:[e.jsx(K,{variant:"contained",size:"small",onClick:()=>J(P),children:"Add"}),e.jsx(K,{variant:"outlined",size:"small",onClick:()=>{J(P)},children:"Add & Keep Open"})]})]})},P.part_number)),ne.length===0&&e.jsx(T,{item:!0,xs:12,children:e.jsx(f,{variant:"body2",color:"text.secondary",children:"No parts match the current filters."})})]})]}),e.jsx(dt,{children:e.jsx(K,{onClick:s,children:"Close"})})]})}const Lc=["Each","cm","ft","kg","pcs","hr","L"],ri=5,qc=()=>{const{id:t}=Dn(),r=qt(),s=!!t&&/^\d+$/.test(t);console.log("WokerSalesOrderPage: Component rendered with id:",t,"isNumericId:",s),l.useEffect(()=>(console.log("WokerSalesOrderPage: Component mounted"),()=>{console.log("WokerSalesOrderPage: Component unmounted")}),[]);const[a,n]=l.useState(null),[o,i]=l.useState(!0),[c,u]=l.useState(null),[d,p]=l.useState(null),[y,w]=l.useState([]),[O,_]=l.useState([]),[E,b]=l.useState(null),[I,U]=l.useState(null),[S,j]=l.useState([]),[N,k]=l.useState([]),[M,v]=l.useState([]),[g,L]=l.useState([]),z=l.useRef(null),ne=l.useRef(0);l.useLayoutEffect(()=>{const ye=z.current,de=ye?ye.getBoundingClientRect().height:0,_e=de-ne.current;_e!==0&&(window.scrollBy({top:_e,left:0,behavior:"auto"}),ne.current=de)},[M.length]);const[ae,ee]=l.useState(null),[W,Z]=l.useState(null),[J,P]=l.useState(null),[m,A]=l.useState(!1),[G,X]=l.useState(null),[Y,fe]=l.useState(""),[se,ke]=l.useState(!1),[Pe,ge]=l.useState(null),[me,be]=l.useState(""),[je,oe]=l.useState(!1),[D,F]=l.useState("line"),[te,B]=l.useState(0),Ee=ye=>{const de=[...O].sort((_e,ue)=>_e.cost_lower_bound-ue.cost_lower_bound);for(const _e of de){const ue=+_e.cost_lower_bound,Ce=_e.cost_upper_bound==null?null:+_e.cost_upper_bound,Ie=+_e.margin_factor;if(ye>=ue&&(Ce===null||ye<Ce))return Ie}return 1},Se=ye=>y.find(de=>de.part_number===ye),$e=(ye,de)=>{const _e=y.find(Oe=>Oe.part_number.toLowerCase()===ye.part_number.toLowerCase());if(!_e||_e.part_type==="supply")return null;const ue=parseFloat(_e.quantity_on_hand)||0,Ce=S.filter(Oe=>Oe.part_number.toLowerCase()===ye.part_number.toLowerCase()).reduce((Oe,Xe)=>Oe+(parseFloat(String(Xe.quantity).replace(/[^\d.-]/g,""))||0),0),Ie=N.filter(Oe=>Oe.part_number.toLowerCase()===ye.part_number.toLowerCase()).reduce((Oe,Xe)=>Oe+(parseFloat(String(Xe.quantity).replace(/[^\d.-]/g,""))||0),0),le=Ce-Ie,ce=ue-le,we=ce<0?Math.floor(ce):Math.round(ce);return{available:we,isNegative:we<0,currentStock:ue,changeInQuantity:le,totalQuantityForPart:Ce,totalOriginalQuantityForPart:Ie}},He=(ye,de)=>{const _e=S.filter(Ce=>Ce.part_number.toLowerCase()===ye.part_number.toLowerCase());if(_e.length<=1)return!0;const ue=Math.max(..._e.map((Ce,Ie)=>S.findIndex(le=>le.part_number.toLowerCase()===ye.part_number.toLowerCase()&&S.indexOf(le)===Ie)));return de===ue},De=l.useMemo(()=>S.map(ye=>({part_number:ye.part_number,part_description:ye.part_description,quantity:Or(ye.quantity),unit:ye.unit,unit_price:Or(ye.unit_price)})),[S]),et=l.useMemo(()=>De.reduce((ye,de)=>ye+Sa(de.quantity,de.unit_price),0),[De]),Ve=l.useMemo(()=>et*(ri/100),[et]);l.useMemo(()=>et+Ve,[et,Ve]);const[Be,Ke]=l.useState("");l.useEffect(()=>{a&&Ke(JSON.stringify({lineItems:S,partsToOrder:g}))},[a]);const We=!!Be&&Be!==JSON.stringify({lineItems:S,partsToOrder:g});l.useEffect(()=>{(async()=>{try{const[ye,de,_e,ue]=await Promise.all([$.get("/api/inventory"),$.get("/api/margin-schedule"),$.get("/api/settings/labour-rate").catch(()=>({data:{labour_rate:null}})),$.get("/api/settings/overhead-rate").catch(()=>({data:{overhead_rate:null}}))]);w(ye.data),_(de.data),b(_e.data.labour_rate??null),U(ue.data.overhead_rate??null)}catch(ye){console.error("Prefetch failed",ye)}})()},[]),l.useEffect(()=>{if(console.log("WokerSalesOrderPage: useEffect triggered with id:",t,"isNumericId:",s),!t||!s){console.log("WokerSalesOrderPage: Invalid ID, setting error"),u("Invalid sales order ID."),i(!1);return}(async()=>{console.log("WokerSalesOrderPage: Fetching sales order data for ID:",t),i(!0),u(null);try{console.log("WokerSalesOrderPage: Making API call to /api/sales-orders/${id}");const ye=await $.get(`/api/sales-orders/${t}`);if(console.log("WokerSalesOrderPage: API response received:",ye),console.log("WokerSalesOrderPage: API response data:",ye.data),!ye.data||!ye.data.salesOrder){console.error("WokerSalesOrderPage: No sales order data in response"),u("Invalid response format from server"),i(!1);return}const de=ye.data.salesOrder;console.log("WokerSalesOrderPage: Parsed sales order:",de),n({sales_order_id:de.sales_order_id,sales_order_number:de.sales_order_number,status:de.status});const _e=(ye.data.lineItems||de?.line_items||[]).filter(Ce=>!["LABOUR","OVERHEAD","SUPPLY"].includes(Ce.part_number?.toUpperCase())).map(Ce=>({line_item_id:Ce.line_item_id,part_number:Ce.part_number,part_description:Ce.part_description,unit:Ce.unit,unit_price:Ce.unit_price,line_amount:Ce.line_amount,quantity:String(Ce.quantity_sold??Ce.quantity??0),gst:ri,part_id:Ce.part_id??void 0}));console.log("WokerSalesOrderPage: Loaded line items (filtered):",_e),j(_e),k(_e);const ue=(ye.data.partsToOrder||[]).map(Ce=>({sales_order_id:de.sales_order_id,part_number:Ce.part_number,part_description:Ce.part_description,quantity_to_order:String(Ce.quantity_needed??Ce.quantity_to_order??""),unit:Ce.unit||"Each",unit_price:Number(Ce.unit_price||0),line_amount:Number(Ce.line_amount||0)}));console.log("WokerSalesOrderPage: Loaded parts to order:",ue),L(ue),console.log("WokerSalesOrderPage: Successfully loaded sales order data")}catch(ye){console.error("WokerSalesOrderPage: Error loading sales order:",ye),console.error("WokerSalesOrderPage: Error details:",{message:ye?.message,status:ye?.response?.status,statusText:ye?.response?.statusText,data:ye?.response?.data,url:ye?.config?.url}),u(ye?.response?.status===404?"Sales order not found. It may have been deleted.":"Failed to load sales order data. Please try again.")}finally{i(!1)}})()},[t,s]),l.useEffect(()=>{E!==null&&j(ye=>ye.map(de=>de.part_number==="LABOUR"?{...de,unit_price:E}:de))},[E]),l.useEffect(()=>{I!==null&&j(ye=>ye.map(de=>de.part_number==="OVERHEAD"?{...de,unit_price:I}:de))},[I]),l.useEffect(()=>{const ye=[];S.forEach((de,_e)=>{if(He(de,_e)){const ue=$e(de);ue&&ue.available<0&&ye.push({lineItemIndex:_e,partNumber:de.part_number,partDescription:de.part_description,excessQuantity:Math.abs(ue.available),unit:de.unit})}}),v(ye)},[S,y]);const pt=(ye,de)=>{j(_e=>{const ue=[..._e];if(!de||de.trim()==="")ue[ye]={...ue[ye],part_number:"",part_description:"",quantity:"",unit:Lc[0],unit_price:0,line_amount:0};else{const le=Se(de);if(le){const ce=parseFloat(String(le.last_unit_cost))||0,we=Ee(ce);ue[ye]={...ue[ye],part_number:de,part_description:le.part_description||"",unit:le.unit||"Each",unit_price:ce*we}}else ue[ye]={...ue[ye],part_number:de,part_description:"Part not found",unit_price:0}}const Ce=Or(ue[ye].quantity),Ie=Or(ue[ye].unit_price);return ue[ye].line_amount=Sa(Ce,Ie),ue})},kt=(ye,de,_e)=>{j(ue=>{const Ce=[...ue],Ie={...Ce[ye],[de]:_e};if(parseFloat(_e)<=0)return Ce.filter((we,Oe)=>Oe!==ye);const le=Or(Ie.quantity),ce=Or(Ie.unit_price);return Ie.line_amount=Sa(le,ce),Ce[ye]=Ie,Ce})},at=()=>{j(ye=>[...ye,{part_number:"",part_description:"",quantity:"",unit:Lc[0],unit_price:0,gst:ri,line_amount:0}])},Ct=ye=>{j(de=>de.filter((_e,ue)=>ue!==ye))},Et=()=>{if(S.filter(ue=>!ue.part_number||ue.part_number.trim()==="").length>0)return H.error("Line items with blank part numbers are not allowed."),!1;const de=S.filter(ue=>{if(["LABOUR","OVERHEAD","SUPPLY"].includes(String(ue.part_number).toUpperCase()))return!1;const Ce=ue.part_id;if(Ce){const le=(y||[]).find(ce=>ce.part_id===Ce);return le?le.part_type==="supply":!1}const Ie=(y||[]).find(le=>String(le.part_number).toUpperCase()===String(ue.part_number).trim().toUpperCase());return!Ie||Ie.part_type==="supply"});if(de.length>0){const ue=de.map(Ce=>Ce.part_number).join(", ");return H.error(`Invalid or supply parts (not allowed): ${ue}`),!1}return S.some((ue,Ce)=>{if(!He(ue,Ce))return!1;const Ie=$e(ue);return Ie&&Ie.available<0})?(H.error("Insufficient inventory for one or more parts."),!1):!0},jt=ye=>{const de=ye.reduce((_e,ue)=>{const Ce=ue.part_number.trim().toLowerCase();if(!_e[Ce]){const le=["LABOUR","OVERHEAD","SUPPLY"].includes(ue.part_number.toUpperCase())?null:(y||[]).find(ce=>String(ce.part_number).toUpperCase()===ue.part_number.trim().toUpperCase());_e[Ce]={part_number:ue.part_number.trim(),part_description:ue.part_description.trim(),unit:ue.unit.trim(),unit_price:ue.unit_price!=null?Number(ue.unit_price):0,line_amount:0,quantity_sold:0,...ue.part_id?{part_id:ue.part_id}:le&&le.part_id?{part_id:le.part_id}:{}}}const Ie=parseFloat(String(ue.quantity).replace(/[^\d.-]/g,""))||0;return _e[Ce].quantity_sold+=Math.round(Ie),_e[Ce].line_amount+=Ie*(ue.unit_price||0),_e},{});return Object.values(de)},Pt=async()=>{if(a&&Et())try{const ye={lineItems:jt(S),partsToOrder:g.filter(de=>de.part_number&&parseFloat(String(de.quantity_to_order))>0).map(de=>({sales_order_id:a.sales_order_id,part_number:de.part_number.trim(),part_description:de.part_description.trim(),quantity_needed:parseFloat(String(de.quantity_to_order))||0,unit:de.unit.trim(),unit_price:de.unit_price,line_amount:de.line_amount}))};await $.put(`/api/sales-orders/${a.sales_order_id}`,ye),p("Sales Order updated successfully!"),Ke(JSON.stringify({lineItems:S,partsToOrder:g}));try{const de=await $.get("/api/inventory");w(de.data)}catch{}}catch(ye){const de=ye?.response?.data?.error||ye?.response?.data?.details||ye?.response?.data?.message||"Failed to save sales order.";H.error(de)}},Wt=(ye,de)=>{const _e=(S[ye]?.part_number||"").trim(),ue=de.key==="Enter",Ce=de.key==="Tab",Ie=de.key==="Escape",le=de.key==="ArrowDown"||de.key==="ArrowUp";if(Ie){ee(null);return}if(le){de.key==="ArrowDown"&&ae!==ye&&ee(ye);return}if(!(ae===ye&&(ue||Ce))&&(ue||Ce)&&_e){if(ue&&de.ctrlKey){de.preventDefault(),fe(_e.toUpperCase()),X(ye),A(!0),ee(null);return}!y.find(we=>we.part_number.toUpperCase()===_e.toUpperCase())&&ue&&(de.preventDefault(),fe(_e.toUpperCase()),X(ye),A(!0),ee(null))}},ir=(ye,de)=>{const _e=(g[ye]?.part_number||"").trim(),ue=de.key==="Enter",Ce=de.key==="Tab",Ie=de.key==="Escape",le=de.key==="ArrowDown"||de.key==="ArrowUp";if(Ie){Z(null);return}if(le){de.key==="ArrowDown"&&W!==ye&&Z(ye);return}if(!(W===ye&&(ue||Ce))&&(ue||Ce)&&_e){if(ue&&de.ctrlKey){de.preventDefault(),be(_e.toUpperCase()),ge(ye),ke(!0),Z(null);return}!y.find(we=>we.part_number.toUpperCase()===_e.toUpperCase())&&ue&&(de.preventDefault(),be(_e.toUpperCase()),ge(ye),ke(!0),Z(null))}};return o?e.jsxs(Qe,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(it,{}),e.jsx(f,{children:"Loading sales order..."})]}):c?e.jsxs(Qe,{component:"main",maxWidth:"md",sx:{mt:8,textAlign:"center"},children:[e.jsx(Re,{severity:"error",sx:{mb:2},children:c}),e.jsx(K,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Retry"}),e.jsx(K,{variant:"outlined",onClick:()=>r("/open-sales-orders"),children:"Back to Sales Orders"})]}):a?e.jsxs(Hr,{dateAdapter:Tn,children:[e.jsx(So,{when:We,onSave:Pt}),e.jsxs(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(q,{sx:{position:"relative",zIndex:1},children:[e.jsxs(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(f,{variant:"h5",sx:{fontWeight:700},children:["Edit Lines & Parts to Order — SO ",a.sales_order_number||a.sales_order_id]}),e.jsx(K,{variant:"contained",onClick:Pt,children:"Save Changes"})]}),e.jsx(f,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"Line Items"}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"You can add multiple line items with the same part number. They will be automatically merged on save."})]}),e.jsx(q,{ref:z,sx:{mb:M.length?2:0,display:M.length?"flex":"none",flexDirection:"column",gap:1},children:M.map((ye,de)=>{const _e=S[ye.lineItemIndex];return!_e||!He(_e,ye.lineItemIndex)?null:e.jsx(Re,{severity:"warning",sx:{width:"100%",boxShadow:2,"& .MuiAlert-message":{width:"100%",padding:0}},children:e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",sx:{width:"100%"},children:[e.jsxs(q,{sx:{flex:1},children:[e.jsxs(f,{variant:"body2",fontWeight:"medium",children:["Insufficient stock for ",ye.partNumber]}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Excess quantity: ",ye.excessQuantity," ",ye.unit]})]}),e.jsxs(K,{variant:"contained",size:"small",sx:{whiteSpace:"nowrap"},onClick:()=>{const ue=ye.excessQuantity,Ce=y.find(ce=>ce.part_number.toLowerCase()===_e.part_number.toLowerCase()),Ie={sales_order_id:a.sales_order_id,part_number:_e.part_number,part_description:_e.part_description,quantity_to_order:String(ue),unit:_e.unit,unit_price:Ce?.last_unit_cost||0,line_amount:(Ce?.last_unit_cost||0)*ue};L(ce=>[...ce,Ie]);const le=Math.max(0,(parseFloat(String(_e.quantity).replace(/[^\d.-]/g,""))||0)-ue);j(ce=>ce.map((we,Oe)=>Oe===ye.lineItemIndex?{...we,quantity:String(le)}:we)),v(ce=>ce.filter(we=>we.lineItemIndex!==ye.lineItemIndex)),H.success(`Transferred ${ue} ${_e.unit} of ${_e.part_number} to parts to order`)},children:["Transfer ",ye.excessQuantity," to Parts to Order"]})]})},`${ye.lineItemIndex}-${de}`)})}),e.jsxs(qe,{sx:{p:3,mb:3},elevation:3,children:[e.jsx(T,{container:!0,spacing:2,children:S.map((ye,de)=>e.jsxs(ft.Fragment,{children:[e.jsxs(T,{item:!0,xs:12,sm:6,md:3.5,children:[e.jsx(kr,{open:ae===de,onOpen:()=>ee(de),onClose:()=>ee(null),autoHighlight:!0,inputValue:ye.part_number,onChange:(_e,ue)=>{if(typeof ue=="string")pt(de,ue),ee(null);else if(ue&&typeof ue=="object"&&"isNew"in ue){const Ce=ue.inputValue||"";fe(String(Ce).toUpperCase()),X(de),A(!0),ee(null)}},onInputChange:(_e,ue,Ce)=>{if(j(le=>{const ce=[...le];return ce[de]={...ce[de],part_number:(ue||"").toUpperCase()},ce}),J&&window.clearTimeout(J),Ce==="reset")return;if((ue||"").trim().length>0){const le=window.setTimeout(()=>ee(de),200);P(le)}else ee(null)},options:y.filter(_e=>_e.part_type!=="supply").map(_e=>_e.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,handleHomeEndKeys:!0,filterOptions:(_e,ue)=>{const Ce=(ue.inputValue||"").toUpperCase(),Ie=_e.filter(we=>{const Oe=y.find(Xe=>Xe.part_number===we);return Oe?String(we).toUpperCase().includes(Ce)||String(Oe.part_description||"").toUpperCase().includes(Ce):String(we).toUpperCase().includes(Ce)}),le=Ie.some(we=>String(we).toUpperCase()===Ce),ce=[...Ie];return Ce&&!le&&ce.push({label:`Add "${ue.inputValue}" as New Part`,isNew:!0,inputValue:ue.inputValue}),ce},renderOption:(_e,ue)=>{const Ce=typeof ue=="object"&&ue.isNew,Ie=typeof ue=="string"?ue:ue.label,{key:le,...ce}=_e;return e.jsxs("li",{...ce,children:[Ce&&e.jsx(an,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof ue=="string"?e.jsxs(q,{children:[e.jsx(f,{variant:"body2",children:ue}),(()=>{const we=y.find(Oe=>Oe.part_number===ue);return we?.part_description?e.jsx(f,{variant:"caption",color:"text.secondary",children:we.part_description}):null})()]}):Ie]},le)},renderInput:_e=>e.jsx(ie,{..._e,label:"Part Number",required:!0,fullWidth:!0,onKeyDown:ue=>Wt(de,ue),onBlur:()=>ee(null)}),onBlur:()=>{const _e=S[de]?.part_number?.trim().toUpperCase();if(!_e)return;y.find(Ce=>Ce.part_number===_e)?pt(de,_e):(X(de),fe(_e),A(!0),ee(null))}}),e.jsx(q,{mt:1,children:e.jsx(K,{size:"small",variant:"outlined",onClick:()=>{F("line"),B(de),oe(!0)},children:"Find Part"})})]}),e.jsx(T,{item:!0,xs:12,sm:6,md:3.5,children:e.jsx(ie,{label:"Part Description",value:ye.part_description,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1,children:e.jsx(ie,{label:"Qty",value:ye.quantity,onChange:_e=>kt(de,"quantity",_e.target.value),type:"number",fullWidth:!0,required:!0,inputProps:{step:1,onWheel:_e=>_e.target.blur()}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(ie,{label:"Avail",value:(()=>{if(!He(ye,de))return"N/A";const _e=$e(ye);return _e?_e.available<0?`${_e.available} (Insufficient)`:String(_e.available):"N/A"})(),fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:(()=>{if(!He(ye,de))return"#f5f5f5";const _e=$e(ye);return _e?_e.available>=0?"#e8f5e8":"#ffeaea":"#f5f5f5"})(),"& .MuiInputBase-input":{color:He(ye,de)?$e(ye)?.isNegative?"#d32f2f":"#2e7d32":"#666"}}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(ie,{label:"Unit",value:ye.unit,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1,sx:{display:"flex",alignItems:"stretch"},children:e.jsx(K,{variant:"outlined",color:"primary",onClick:()=>Ct(de),fullWidth:!0,sx:{height:"56px"},children:"Remove"})})]},de))}),e.jsx(q,{sx:{mt:2},children:e.jsx(K,{variant:"outlined",color:"primary",onClick:at,children:"Add Line Item"})})]}),e.jsxs(qe,{sx:{p:3,mb:3,border:"2px solid #b8860b","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"#b8860b"},"&:hover fieldset":{borderColor:"#b8860b"}}},elevation:0,children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Parts to Order"}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Add parts that need to be ordered for this sales order. These quantities are aggregated across all sales orders."}),e.jsx(T,{container:!0,spacing:2,children:g.map((ye,de)=>e.jsxs(ft.Fragment,{children:[e.jsxs(T,{item:!0,xs:12,sm:6,md:3.5,children:[e.jsx(kr,{open:W===de,onOpen:()=>Z(de),onClose:()=>Z(null),autoHighlight:!0,value:ye.part_number,onChange:(_e,ue)=>{if(!ue){L(Ce=>{const Ie=[...Ce];return Ie[de]={...Ie[de],part_number:"",part_description:"",unit:"Each",unit_price:0,line_amount:0},Ie});return}if(typeof ue=="string"){const Ce=y.find(Ie=>Ie.part_number===ue);if(Ce){const Ie=parseFloat(String(Ce.last_unit_cost))||0,le=Ee(Ie),ce=Ie*le;L(we=>{const Oe=[...we];return Oe[de]={...Oe[de],part_number:Ce.part_number,part_description:Ce.part_description,unit:Ce.unit||"Each",unit_price:ce,line_amount:0},Oe})}else{L(le=>{const ce=[...le];return ce[de]={...ce[de],part_number:ue,part_description:"",unit:"Each",unit_price:0,line_amount:0},ce});const Ie=String(ue).toUpperCase();ge(de),be(Ie),ke(!0)}}else if(ue&&typeof ue=="object"&&"isNew"in ue){const Ce=String(ue.inputValue||"").toUpperCase();ge(de),be(Ce),ke(!0)}},onInputChange:(_e,ue,Ce)=>{if(L(le=>{const ce=[...le];return ce[de]={...ce[de],part_number:(ue||"").toUpperCase()},ce}),J&&window.clearTimeout(J),Ce==="reset")return;if((ue||"").trim().length>0){const le=window.setTimeout(()=>Z(de),200);P(le)}else Z(null)},options:y.filter(_e=>_e.part_type!=="supply").map(_e=>_e.part_number),freeSolo:!0,selectOnFocus:!0,clearOnBlur:!0,filterOptions:(_e,ue)=>{const Ce=(ue.inputValue||"").toUpperCase(),Ie=_e.filter(we=>{const Oe=y.find(Xe=>Xe.part_number===we);return Oe?String(we).toUpperCase().includes(Ce)||String(Oe.part_description||"").toUpperCase().includes(Ce):String(we).toUpperCase().includes(Ce)}),le=Ie.some(we=>String(we).toUpperCase()===Ce),ce=[...Ie];return Ce&&!le&&ce.push({label:`Add "${ue.inputValue}" as New Part`,isNew:!0,inputValue:ue.inputValue}),ce},renderOption:(_e,ue)=>{const Ce=typeof ue=="object"&&ue.isNew,Ie=typeof ue=="string"?ue:ue.label,{key:le,...ce}=_e;return e.jsxs("li",{...ce,children:[Ce&&e.jsx(an,{fontSize:"small",style:{marginRight:8,color:"#666"}}),typeof ue=="string"?e.jsxs(q,{children:[e.jsx(f,{variant:"body2",children:ue}),(()=>{const we=y.find(Oe=>Oe.part_number===ue);return we?.part_description?e.jsx(f,{variant:"caption",color:"text.secondary",children:we.part_description}):null})()]}):Ie]},le)},renderInput:_e=>e.jsx(ie,{..._e,label:"Part Number",fullWidth:!0,required:!0,onKeyDown:ue=>ir(de,ue),onBlur:()=>Z(null)}),onBlur:()=>{const _e=(g[de]?.part_number||"").trim().toUpperCase();if(!_e)return;y.find(Ce=>Ce.part_number===_e)||(ge(de),be(_e),ke(!0),Z(null))}}),e.jsx(q,{mt:1,children:e.jsx(K,{size:"small",variant:"outlined",onClick:()=>{F("pto"),B(de),oe(!0)},children:"Find Part"})})]}),e.jsx(T,{item:!0,xs:12,sm:6,md:3.5,children:e.jsx(ie,{label:"Description",value:ye.part_description,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#f5f5f5"}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(ie,{label:"Qty to Order",value:ye.quantity_to_order,onChange:_e=>{const ue=_e.target.value;L(Ce=>{const Ie=[...Ce],le=parseFloat(ue)||0,ce=Ie[de].unit_price||0;return Ie[de]={...Ie[de],quantity_to_order:ue,line_amount:le*ce},Ie})},type:"number",fullWidth:!0,required:!0,inputProps:{step:1,min:0,onWheel:_e=>_e.target.blur()}})}),e.jsx(T,{item:!0,xs:6,sm:3,md:1.5,children:e.jsx(ie,{label:"Unit",value:ye.unit,fullWidth:!0,InputProps:{readOnly:!0},sx:{backgroundColor:"#ffffff"}})}),e.jsx(T,{item:!0,xs:12,sm:1,md:1,sx:{display:"flex",alignItems:"stretch",gap:2},children:e.jsx(K,{variant:"outlined",onClick:()=>L(_e=>_e.filter((ue,Ce)=>Ce!==de)),sx:{height:"56px",flexShrink:0,borderColor:"#b8860b",color:"#b8860b","&:hover":{borderColor:"#8b6914",backgroundColor:"#fff8dc"}},children:"Remove"})})]},de))}),e.jsx(q,{sx:{mt:2},children:e.jsx(K,{variant:"outlined",color:"primary",onClick:()=>L(ye=>[...ye,{sales_order_id:a.sales_order_id,part_number:"",part_description:"",quantity_to_order:"",unit:"Each",unit_price:0,line_amount:0}]),children:"Add Parts to Order Item"})})]}),e.jsxs(q,{display:"flex",justifyContent:"flex-end",gap:2,children:[e.jsx(K,{variant:"outlined",onClick:()=>r(`/open-sales-orders/${a.sales_order_id}`),children:"Back to SO"}),e.jsx(K,{variant:"contained",onClick:Pt,children:"Save Changes"})]}),e.jsx(zr,{open:!!d,autoHideDuration:6e3,onClose:()=>p(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Re,{onClose:()=>p(null),severity:"success",sx:{width:"100%"},children:d})})]}),e.jsx(kn,{open:m,onClose:()=>{A(!1),X(null),fe("")},onSave:async ye=>{const de=await $.post("/api/inventory",ye),_e=await $.get("/api/inventory");w(_e.data);const ue=de.data.item;G!==null&&j(Ce=>{const Ie=[...Ce],le=parseFloat(String(ue.last_unit_cost))||0,ce=Ee(le),we=le*ce;Ie[G]={...Ie[G],part_number:ue.part_number,part_description:ue.part_description,unit:ue.unit||Ie[G].unit,unit_price:we};const Oe=Or(Ie[G].quantity);return Ie[G].line_amount=Sa(Oe,we),Ie})},title:"Add New Part",initialPart:{part_number:Y.toUpperCase(),category:"Uncategorized"}}),e.jsx(J_,{open:je,onClose:()=>oe(!1),onSelect:ye=>{if(a)if(D==="line"){const de=te;j(_e=>{const ue=[..._e];return ue[de]?(ue[de]={...ue[de],part_number:ye.part_number,part_description:ye.part_description},ue):_e})}else{const de=te;L(_e=>{const ue=[..._e];return ue[de]?(ue[de]={...ue[de],part_number:ye.part_number,part_description:ye.part_description},ue):_e})}},salesOrderId:a?.sales_order_id||0,context:D,inventoryItems:y.map(ye=>({part_number:ye.part_number,part_description:ye.part_description}))}),e.jsx(kn,{open:se,onClose:()=>{ke(!1),ge(null),be("")},onSave:async ye=>{const de=await $.post("/api/inventory",ye),_e=await $.get("/api/inventory");w(_e.data);const ue=de.data.item;Pe!==null&&L(Ce=>{const Ie=[...Ce],le=parseFloat(String(ue.last_unit_cost))||0,ce=Ee(le),we=le*ce;Ie[Pe]={...Ie[Pe],part_number:ue.part_number,part_description:ue.part_description,unit:ue.unit||"Each",unit_price:we};const Oe=parseFloat(String(Ie[Pe].quantity_to_order))||0;return Ie[Pe].line_amount=Oe*we,Ie})},title:"Add New Part",initialPart:{part_number:me.toUpperCase(),category:"Uncategorized"}})]}):null},no=t=>new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString(),bd=()=>crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,Yi=async()=>{try{const t=await $.get("/api/time-tracking/profiles");return localStorage.setItem("tt_profiles_cache",JSON.stringify(t.data)),t.data}catch{const r=localStorage.getItem("tt_profiles_cache");return r?JSON.parse(r):[]}},K_=async(t,r)=>(await $.post("/api/time-tracking/profiles",{name:t,email:r})).data,jd=async()=>{try{const t=await $.get("/api/time-tracking/sales-orders");return localStorage.setItem("tt_sales_orders_cache",JSON.stringify(t.data)),t.data}catch{const r=localStorage.getItem("tt_sales_orders_cache");return r?JSON.parse(r):[]}},X_=async(t,r)=>{const s={date:t};return r&&(s.profile_id=r),(await $.get("/api/time-tracking/time-entries",{params:s})).data},Z_=async(t,r)=>{try{return(await $.post("/api/time-tracking/time-entries/clock-in",{profile_id:t,so_id:r})).data}catch{const a={event_id:bd(),user_id:t,device_id:localStorage.getItem("deviceId")||"unknown-device",type:"time_clock_in",timestamp_utc:no(new Date),payload_json:JSON.stringify({profile_id:t,so_id:r}),created_at:no(new Date)};return await window?.api?.timeEvents?.insert?.(a),{id:-Math.floor(Math.random()*1e9),profile_id:t,profile_name:"",sales_order_id:r,sales_order_number:"",clock_in:new Date().toISOString(),clock_out:null,duration:null,unit_price:0,__pending:!0,__pending_event_id:a.event_id}}},eb=async t=>{try{return(await $.post(`/api/time-tracking/time-entries/${t}/clock-out`)).data}catch{const s={event_id:bd(),device_id:localStorage.getItem("deviceId")||"unknown-device",type:"time_clock_out",timestamp_utc:no(new Date),payload_json:JSON.stringify({id:t}),created_at:no(new Date)};return await window?.api?.timeEvents?.insert?.(s),{id:t,clock_out:new Date().toISOString(),__pending:!0,__pending_event_id:s.event_id}}},tb=async(t,r,s)=>(await $.put(`/api/time-tracking/time-entries/${t}`,{clock_in:r,clock_out:s})).data,rb=async(t,r,s,a)=>(await $.post("/api/time-tracking/time-entries/manual",{profile_id:t,sales_order_id:r,clock_in:s,clock_out:a})).data,nb=async(t,r,s,a)=>(await $.get("/api/time-tracking/reports/time-entries",{params:{from:t,to:r,profile:s,so:a}})).data,sb=async(t,r,s,a,n="csv")=>(await $.get("/api/time-tracking/reports/time-entries/export",{params:{from:t,to:r,profile:s,so:a,format:n},responseType:"blob"})).data,ab=async t=>(await $.get("/api/time-tracking/time-entries/open",{params:{profile_id:t}})).data,ob=()=>{const{user:t}=Qt(),[r,s]=l.useState([]),[a,n]=l.useState([]),[o,i]=l.useState([]),[c,u]=l.useState(""),[d,p]=l.useState(""),[y,w]=l.useState(!0),[O,_]=l.useState(null);l.useEffect(()=>{E()},[]),l.useEffect(()=>{c?b():i([])},[c]),l.useEffect(()=>{const j=setInterval(()=>{i(N=>N.map(k=>{if(!k.clock_out){const M=new Date,v=new Date(k.clock_in),g=(M.getTime()-v.getTime())/(1e3*60*60);return{...k,duration:g}}return k}))},1e3);return()=>clearInterval(j)},[]);const E=async()=>{try{w(!0);const[j,N]=await Promise.all([Yi(),jd()]);console.log("Sales orders data received:",N),s(j),n(N),_(null)}catch(j){_("Failed to fetch data. Please try again."),console.error("Error fetching data:",j)}finally{w(!1)}},b=async()=>{if(c)try{const[j,N]=await Promise.all([X_(new Date().toISOString().split("T")[0],c),ab(c)]),k=new Map;[...j,...N].forEach(M=>{k.set(M.id,M)}),i(Array.from(k.values()))}catch(j){_("Failed to fetch time entries. Please try again."),console.error("Error fetching time entries:",j)}},I=async()=>{if(!c||!d){_("Please select both a profile and a sales order");return}if(o.find(N=>N.sales_order_id===d&&!N.clock_out)){_("You are already clocked in for this sales order");return}try{const N=await Z_(c,d);i([N,...o]),u(""),p(""),i([]),_(null)}catch(N){N.response&&N.response.data&&N.response.data.error.includes("attendance")?_("You must clock in for attendance before you can clock in for a sales order."):_("Failed to clock in. Please try again."),console.error("Error clocking in:",N)}},U=async j=>{try{const N=await eb(j);i(o.map(k=>k.id===j?N:k)),u(""),p(""),i([]),_(null)}catch(N){_("Failed to clock out. Please try again."),console.error("Error clocking out:",N)}},S=c&&o.some(j=>j.profile_id===c&&!j.clock_out);return y?e.jsx(q,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(it,{})}):e.jsxs(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsx(f,{variant:"h4",gutterBottom:!0,children:"Time Tracking"}),O&&e.jsx(Re,{severity:"error",sx:{mb:2},children:O}),e.jsxs(T,{container:!0,spacing:3,children:[e.jsx(T,{item:!0,xs:12,md:6,children:e.jsxs(qe,{sx:{p:2},children:[e.jsx(q,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:e.jsx(f,{variant:"h6",children:"Profile"})}),e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Select Profile"}),e.jsx(Ot,{value:c,label:"Select Profile",onChange:j=>u(j.target.value),sx:{"& .MuiSelect-select":{fontSize:"1.1rem"}},children:r.map(j=>e.jsx(ze,{value:j.id,sx:{fontSize:"1.1rem"},children:j.name},j.id))})]})]})}),c&&e.jsx(T,{item:!0,xs:12,md:6,children:e.jsxs(qe,{sx:{p:2},children:[e.jsx(q,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:e.jsx(f,{variant:"h6",children:"Sales Order"})}),e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Select Sales Order"}),e.jsx(Ot,{value:d,label:"Select Sales Order",onChange:j=>p(j.target.value),sx:{"& .MuiSelect-select":{fontSize:"1.1rem"}},children:a.map(j=>{const N=o.some(k=>k.sales_order_id===j.id&&!k.clock_out);return e.jsxs(ze,{value:j.id,disabled:N,sx:{fontSize:"1.1rem"},children:[j.number," - ",j.product_name||"No Product Name",N?" - Already Clocked In":""]},j.id)})})]})]})}),c&&d&&e.jsx(T,{item:!0,xs:12,children:e.jsx(qe,{sx:{p:2},children:e.jsx(q,{display:"flex",justifyContent:"center",gap:2,children:e.jsx(K,{variant:"contained",sx:{backgroundColor:"green","&:hover":{backgroundColor:"darkgreen"}},onClick:I,disabled:S,children:"Clock In"})})})}),c&&e.jsx(T,{item:!0,xs:12,children:e.jsxs(qe,{sx:{p:2},children:[e.jsxs(f,{variant:"h6",gutterBottom:!0,children:["Today's Time Entries for ",r.find(j=>j.id===c)?.name]}),e.jsx(Kt,{children:e.jsxs(Yt,{children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Sales Order"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Clock In"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Clock Out"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Duration"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Actions"})]})}),e.jsx(Gt,{children:o.map(j=>e.jsxs(rt,{children:[e.jsx(re,{sx:{fontSize:"1.1rem"},children:j.sales_order_number}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:new Date(j.clock_in).toLocaleTimeString()}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:j.clock_out?new Date(j.clock_out).toLocaleTimeString():"-"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:j.duration!==null&&j.duration!==void 0&&!isNaN(Number(j.duration))?`${Number(j.duration).toFixed(3)} hrs`:"-"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:!j.clock_out&&e.jsx(K,{variant:"contained",sx:{backgroundColor:"red","&:hover":{backgroundColor:"darkred"}},onClick:()=>U(j.id),children:"Clock Out"})})]},j.id))})]})})]})})]})]})};var Pa={exports:{}},Uc;function ib(){return Uc||(Uc=1,function(t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=void 0;var s=function(u,d){switch(u){case"P":return d.date({width:"short"});case"PP":return d.date({width:"medium"});case"PPP":return d.date({width:"long"});case"PPPP":default:return d.date({width:"full"})}},a=function(u,d){switch(u){case"p":return d.time({width:"short"});case"pp":return d.time({width:"medium"});case"ppp":return d.time({width:"long"});case"pppp":default:return d.time({width:"full"})}},n=function(u,d){var p=u.match(/(P+)(p+)?/)||[],y=p[1],w=p[2];if(!w)return s(u,d);var O;switch(y){case"P":O=d.dateTime({width:"short"});break;case"PP":O=d.dateTime({width:"medium"});break;case"PPP":O=d.dateTime({width:"long"});break;case"PPPP":default:O=d.dateTime({width:"full"});break}return O.replace("{{date}}",s(y,d)).replace("{{time}}",a(w,d))},o={p:a,P:n},i=o;r.default=i,t.exports=r.default}(Pa,Pa.exports)),Pa.exports}var lb=ib();const cb=vt(lb),ub={y:{sectionType:"year",contentType:"digit",maxLength:4},yy:"year",yyy:{sectionType:"year",contentType:"digit",maxLength:4},yyyy:"year",M:{sectionType:"month",contentType:"digit",maxLength:2},MM:"month",MMMM:{sectionType:"month",contentType:"letter"},MMM:{sectionType:"month",contentType:"letter"},L:{sectionType:"month",contentType:"digit",maxLength:2},LL:"month",LLL:{sectionType:"month",contentType:"letter"},LLLL:{sectionType:"month",contentType:"letter"},d:{sectionType:"day",contentType:"digit",maxLength:2},dd:"day",do:{sectionType:"day",contentType:"digit-with-letter"},E:{sectionType:"weekDay",contentType:"letter"},EE:{sectionType:"weekDay",contentType:"letter"},EEE:{sectionType:"weekDay",contentType:"letter"},EEEE:{sectionType:"weekDay",contentType:"letter"},EEEEE:{sectionType:"weekDay",contentType:"letter"},i:{sectionType:"weekDay",contentType:"digit",maxLength:1},ii:"weekDay",iii:{sectionType:"weekDay",contentType:"letter"},iiii:{sectionType:"weekDay",contentType:"letter"},e:{sectionType:"weekDay",contentType:"digit",maxLength:1},ee:"weekDay",eee:{sectionType:"weekDay",contentType:"letter"},eeee:{sectionType:"weekDay",contentType:"letter"},eeeee:{sectionType:"weekDay",contentType:"letter"},eeeeee:{sectionType:"weekDay",contentType:"letter"},c:{sectionType:"weekDay",contentType:"digit",maxLength:1},cc:"weekDay",ccc:{sectionType:"weekDay",contentType:"letter"},cccc:{sectionType:"weekDay",contentType:"letter"},ccccc:{sectionType:"weekDay",contentType:"letter"},cccccc:{sectionType:"weekDay",contentType:"letter"},a:"meridiem",aa:"meridiem",aaa:"meridiem",H:{sectionType:"hours",contentType:"digit",maxLength:2},HH:"hours",h:{sectionType:"hours",contentType:"digit",maxLength:2},hh:"hours",m:{sectionType:"minutes",contentType:"digit",maxLength:2},mm:"minutes",s:{sectionType:"seconds",contentType:"digit",maxLength:2},ss:"seconds"},db={year:"yyyy",month:"LLLL",monthShort:"MMM",dayOfMonth:"d",weekday:"EEEE",weekdayShort:"EEEEEE",hours24h:"HH",hours12h:"hh",meridiem:"aa",minutes:"mm",seconds:"ss",fullDate:"PP",fullDateWithWeekday:"PPPP",keyboardDate:"P",shortDate:"MMM d",normalDate:"d MMMM",normalDateWithWeekday:"EEE, MMM d",monthAndYear:"LLLL yyyy",monthAndDate:"MMMM d",fullTime:"p",fullTime12h:"hh:mm aa",fullTime24h:"HH:mm",fullDateTime:"PP p",fullDateTime12h:"PP hh:mm aa",fullDateTime24h:"PP HH:mm",keyboardDateTime:"P p",keyboardDateTime12h:"P hh:mm aa",keyboardDateTime24h:"P HH:mm"};class pb{constructor(r){this.isMUIAdapter=!0,this.isTimezoneCompatible=!1,this.lib="date-fns",this.locale=void 0,this.formats=void 0,this.formatTokenMap=ub,this.escapedCharacters={start:"'",end:"'"},this.longFormatters=void 0,this.date=o=>typeof o>"u"?new Date:o===null?null:new Date(o),this.dateWithTimezone=o=>this.date(o),this.getTimezone=()=>"default",this.setTimezone=o=>o,this.toJsDate=o=>o,this.getCurrentLocaleCode=()=>{var o;return((o=this.locale)==null?void 0:o.code)||"en-US"},this.is12HourCycleInCurrentLocale=()=>this.locale?/a/.test(this.locale.formatLong.time({width:"short"})):!0,this.expandFormat=o=>{const i=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g;return o.match(i).map(c=>{const u=c[0];if(u==="p"||u==="P"){const d=this.longFormatters[u];return d(c,this.locale.formatLong)}return c}).join("")},this.getFormatHelperText=o=>this.expandFormat(o).replace(/(aaa|aa|a)/g,"(a|p)m").toLocaleLowerCase(),this.isNull=o=>o===null,this.formatNumber=o=>o,this.getMeridiemText=o=>o==="am"?"AM":"PM";const{locale:s,formats:a,longFormatters:n}=r;this.locale=s,this.formats=Yc({},db,a),this.longFormatters=n}}class Wc extends pb{constructor({locale:r,formats:s}={}){if(typeof Ua!="function")throw new Error(["MUI: The `date-fns` package v3.x is not compatible with this adapter.","Please, install v2.x of the package or use the `AdapterDateFnsV3` instead."].join(`
`));super({locale:r??Fi,formats:s,longFormatters:cb}),this.parseISO=a=>Cv(a),this.toISO=a=>dy(a,{format:"extended"}),this.parse=(a,n)=>a===""?null:vv(a,n,new Date,{locale:this.locale}),this.isValid=a=>Xu(this.date(a)),this.format=(a,n)=>this.formatByString(a,this.formats[n]),this.formatByString=(a,n)=>Ys(a,n,{locale:this.locale}),this.getDiff=(a,n,o)=>{switch(o){case"years":return mx(a,this.date(n));case"quarters":return dx(a,this.date(n));case"months":return ed(a,this.date(n));case"weeks":return hx(a,this.date(n));case"days":return Zu(a,this.date(n));case"hours":return lx(a,this.date(n));case"minutes":return cx(a,this.date(n));case"seconds":return px(a,this.date(n));default:return wo(a,this.date(n))}},this.isEqual=(a,n)=>a===null&&n===null?!0:wy(a,n),this.isSameYear=(a,n)=>wv(a,n),this.isSameMonth=(a,n)=>jv(a,n),this.isSameDay=(a,n)=>nx(a,n),this.isSameHour=(a,n)=>bv(a,n),this.isAfter=(a,n)=>ei(a,n),this.isAfterYear=(a,n)=>ei(a,Ko(n)),this.isAfterDay=(a,n)=>ei(a,bi(n)),this.isBefore=(a,n)=>ws(a,n),this.isBeforeYear=(a,n)=>ws(a,ja(n)),this.isBeforeDay=(a,n)=>ws(a,Qn(n)),this.isWithinRange=(a,[n,o])=>Sv(a,{start:n,end:o}),this.startOfYear=a=>ja(a),this.startOfMonth=a=>ic(a),this.startOfWeek=a=>wn(a,{locale:this.locale}),this.startOfDay=a=>Qn(a),this.endOfYear=a=>Ko(a),this.endOfMonth=a=>ji(a),this.endOfWeek=a=>Xo(a,{locale:this.locale}),this.endOfDay=a=>bi(a),this.addYears=(a,n)=>sc(a,n),this.addMonths=(a,n)=>Wa(a,n),this.addWeeks=(a,n)=>tx(a,n),this.addDays=(a,n)=>Ua(a,n),this.addHours=(a,n)=>Gg(a,n),this.addMinutes=(a,n)=>Zg(a,n),this.addSeconds=(a,n)=>ex(a,n),this.getYear=a=>jy(a),this.getMonth=a=>gy(a),this.getDate=a=>py(a),this.getHours=a=>hy(a),this.getMinutes=a=>fy(a),this.getSeconds=a=>xy(a),this.getMilliseconds=a=>my(a),this.setYear=(a,n)=>Vv(a,n),this.setMonth=(a,n)=>Fv(a,n),this.setDate=(a,n)=>$v(a,n),this.setHours=(a,n)=>Bv(a,n),this.setMinutes=(a,n)=>Hv(a,n),this.setSeconds=(a,n)=>Yv(a,n),this.setMilliseconds=(a,n)=>zv(a,n),this.getDaysInMonth=a=>ld(a),this.getNextMonth=a=>Wa(a,1),this.getPreviousMonth=a=>Wa(a,-1),this.getMonthArray=a=>{const o=[ja(a)];for(;o.length<12;){const i=o[o.length-1];o.push(this.getNextMonth(i))}return o},this.mergeDateAndTime=(a,n)=>this.setSeconds(this.setMinutes(this.setHours(a,this.getHours(n)),this.getMinutes(n)),this.getSeconds(n)),this.getWeekdays=()=>{const a=new Date;return fx({start:wn(a,{locale:this.locale}),end:Xo(a,{locale:this.locale})}).map(n=>this.formatByString(n,"EEEEEE"))},this.getWeekArray=a=>{const n=wn(ic(a),{locale:this.locale}),o=Xo(ji(a),{locale:this.locale});let i=0,c=n;const u=[];for(;ws(c,o);){const d=Math.floor(i/7);u[d]=u[d]||[],u[d].push(c),c=Ua(c,1),i+=1}return u},this.getWeekNumber=a=>by(a,{locale:this.locale}),this.getYearRange=(a,n)=>{const o=ja(a),i=Ko(n),c=[];let u=o;for(;ws(u,i);)c.push(u),u=sc(u,1);return c}}}const Kn=t=>new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString(),Vi=()=>crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,hb=async t=>(await $.get("/api/attendance",{params:{profile_id:t}})).data,mb=async t=>{try{return(await $.post("/api/attendance/clock-in",{profile_id:t})).data}catch{const s={event_id:Vi(),user_id:t,device_id:localStorage.getItem("deviceId")||"unknown-device",type:"attendance_clock_in",timestamp_utc:Kn(new Date),payload_json:JSON.stringify({profile_id:t}),created_at:Kn(new Date)};return await window?.api?.timeEvents?.insert?.(s),{id:-Math.floor(Math.random()*1e9),profile_id:t,clock_in:new Date().toISOString(),clock_out:null,duration:null,__pending:!0,__pending_event_id:s.event_id}}},fb=async t=>{try{return(await $.post("/api/attendance/clock-out",{shift_id:t})).data}catch{const s={event_id:Vi(),user_id:void 0,device_id:localStorage.getItem("deviceId")||"unknown-device",type:"attendance_clock_out",timestamp_utc:Kn(new Date),payload_json:JSON.stringify({shift_id:t}),created_at:Kn(new Date)};return await window?.api?.timeEvents?.insert?.(s),{id:t,clock_out:new Date().toISOString(),__pending:!0,__pending_event_id:s.event_id}}},gb=async(t,r,s)=>{try{return(await $.post("/api/attendance/manual",{profile_id:t,clock_in:r,clock_out:s})).data}catch(a){throw a}},xb=async(t,r,s)=>{try{return(await $.put(`/api/attendance/${t}`,{clock_in:r,clock_out:s})).data}catch(a){if(a?.response)throw a;const n={event_id:Vi(),device_id:localStorage.getItem("deviceId")||"unknown-device",type:"attendance_update",timestamp_utc:Kn(new Date),payload_json:JSON.stringify({shift_id:t,clock_in:r,clock_out:s}),created_at:Kn(new Date)};return await window?.api?.timeEvents?.insert?.(n),{id:t,clock_in:r,clock_out:s,__pending:!0,__pending_event_id:n.event_id}}},yb=async(t,r,s)=>(await $.get("/api/attendance",{params:{profile_id:t,from:r,to:s}})).data;function en(t){if(!t)return"";const r=new Date(t),s=r.getTimezoneOffset()*6e4;return new Date(r.getTime()-s).toISOString().slice(0,16)}function Wn(t){return t?new Date(t).toISOString():null}function Si(t){return new Date(t.getFullYear(),t.getMonth(),t.getDate())}function Us(t){const r=Si(t),s=r.getFullYear(),a=String(r.getMonth()+1).padStart(2,"0"),n=String(r.getDate()).padStart(2,"0");return`${s}-${a}-${n}`}const vb=()=>{const[t,r]=l.useState([]),[s,a]=l.useState([]),[n,o]=l.useState([]),[i,c]=l.useState(""),[u,d]=l.useState(""),p=new Date,y=new Date;y.setDate(p.getDate()-1);const w=new Date;w.setDate(y.getDate()-13);const[O,_]=l.useState(w),[E,b]=l.useState(y),[I,U]=l.useState(!0),[S,j]=l.useState(null),[N,k]=l.useState(null),[M,v]=l.useState(""),[g,L]=l.useState(""),[z,ne]=l.useState(null),[ae,ee]=l.useState([]),[W,Z]=l.useState({}),[J,P]=l.useState([]),[m,A]=l.useState(null),[G,X]=l.useState(null),[Y,fe]=l.useState(""),[se,ke]=l.useState(""),[Pe,ge]=l.useState(!1),[me,be]=l.useState(!0),[je,oe]=l.useState(!1),[D,F]=l.useState(null),[te,B]=l.useState(""),[Ee,Se]=l.useState(""),[$e,He]=l.useState(""),[De,et]=l.useState(!1),[Ve,Be]=l.useState(!1),[Ke,We]=l.useState(""),[pt,kt]=l.useState(""),[at,Ct]=l.useState(""),[Et,jt]=l.useState(!1);l.useEffect(()=>{Pt()},[]);const Pt=async()=>{try{U(!0);const[xe,Fe]=await Promise.all([Yi(),jd()]);r(xe),a(Fe),j(null)}catch(xe){j("Failed to fetch data. Please try again."),console.error("Error fetching data:",xe)}finally{U(!1)}},Wt=async()=>{if(!O||!E){j("Please select a date range");return}try{U(!0);const xe=Si(O),Fe=new Date(E.getFullYear(),E.getMonth(),E.getDate()+1),Ge=Us(xe),It=Us(Fe);console.log("Requesting shifts for:",Ge,It);const rr={from_date:Ge,to_date:It};i&&(rr.profile_id=i),u&&(rr.sales_order_id=u);const _r=await nb(Ge,It,i||void 0,u||void 0);if(o(_r),u)ee([]),Z({}),P([]);else{const dr=(await yb(i||void 0,Ge,It)).map(Jt=>({...Jt,id:Number(Jt.id),profile_id:Number(Jt.profile_id)}));console.log("Fetched shifts:",dr),ee(dr);const Ht=[];let Er=new Date(xe);const br=new Date(Fe);for(;Er<br;){const Zt={date:Us(Er)};i&&(Zt.profile_id=i);const Yr=await $.get("/api/time-tracking/time-entries",{params:Zt});Ht.push(...Yr.data),Er.setDate(Er.getDate()+1)}const pr={},fr=[];dr.forEach(Jt=>{const Zt=Number(Jt.id);Number.isNaN(Zt)||(pr[Zt]=[])}),Ht.forEach(Jt=>{const Zt=new Date(Jt.clock_in).getTime(),Yr=Number(Jt.profile_id);let Dr=!1;for(const qr of dr){const jr=Number(qr.id);if(Number.isNaN(jr))continue;const dn=new Date(qr.clock_in).getTime(),gr=qr.clock_out?new Date(qr.clock_out).getTime():null,On=Number(qr.profile_id);if(gr&&!Number.isNaN(Yr)&&!Number.isNaN(On)&&Yr===On&&Zt>=dn&&Zt<gr){pr[jr].push(Jt),Dr=!0;break}}Dr||fr.push(Jt)}),Z(pr),P(fr)}j(null)}catch(xe){j("Failed to generate report. Please try again."),console.error("Error generating report:",xe)}finally{U(!1)}},ir=async xe=>{if(!O||!E){j("Please select both from and to dates");return}try{const Fe=Si(O),Ge=new Date(E.getFullYear(),E.getMonth(),E.getDate()+1),It=Us(Fe),rr=Us(Ge),_r=await sb(It,rr,i||void 0,u||void 0,xe),Lr=u?`time-entries-report-so-${u}.${xe}`:`time-entries-report.${xe}`;_b(_r,Lr)}catch(Fe){j("Failed to export report. Please try again."),console.error("Error exporting report:",Fe)}},ye=async()=>{if(N){ne(null),j(null);try{const xe=Wn(M),Fe=Wn(g),Ge=await tb(N.id,xe,Fe);o(n.map(It=>It.id===N.id?{...It,clock_in:Ge.clock_in,clock_out:Ge.clock_out,duration:Ge.duration}:It)),ne(null),k(null),j(null)}catch(xe){const Ge=(xe?.response?.data?.message??xe?.response?.data?.error)||"Failed to update time entry. Please try again.";ne(Ge),j(Ge),console.error("Error updating time entry:",xe)}}},de=xe=>{F(xe),oe(!0),B(u!==""?u:""),Se(xe.clock_in?en(xe.clock_in):""),He(xe.clock_out?en(xe.clock_out):""),j(null)},_e=()=>{oe(!1),F(null),Se(""),He(""),B(u!==""?u:""),et(!1)},ue=async()=>{if(!D||te===""||!Ee||!$e)return;const xe=Wn(Ee),Fe=Wn($e);if(!(!xe||!Fe)){et(!0),j(null);try{await rb(D.profile_id,Number(te),xe,Fe),_e(),await Wt()}catch(Ge){const It=Ge?.response?.data?.message||Ge?.response?.data?.error||"Failed to create time entry. Please try again.";j(It),console.error("Error creating manual time entry:",Ge)}finally{et(!1)}}};if(l.useEffect(()=>{G&&(fe(G.clock_in?en(G.clock_in):""),ke(G.clock_out?en(G.clock_out):""))},[G]),I)return e.jsx(q,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(it,{})});const Ce=Ee?new Date(Ee):null,Ie=$e?new Date($e):null,le=!!(D&&te!==""&&Ce&&Ie&&Ie.getTime()>Ce.getTime()),ce=D?D.profile_name||t.find(xe=>xe.id===D.profile_id)?.name||`Profile ${D.profile_id}`:"",we={};ae.forEach(xe=>{if(xe.clock_in&&xe.clock_out){const Fe=Number(xe.id);if(Number.isNaN(Fe))return;const Ge=Number(xe.profile_id);if(Number.isNaN(Ge))return;const It=new Date(xe.clock_in).getTime(),rr=new Date(xe.clock_out).getTime(),_r=Math.max(0,(rr-It)/(1e3*60*60)),Lr=W[Fe]||[];let dr=0;Lr.forEach(pr=>{const fr=typeof pr.duration=="number"?pr.duration:Number(pr.duration)||0;dr+=fr});const Ht=Math.max(0,_r-dr),Er=Math.min(_r,8),br=Math.max(0,_r-8);we[Ge]||(we[Ge]={hours:0,idle:0,regular:0,overtime:0}),we[Ge].hours+=_r,we[Ge].idle+=Ht,we[Ge].regular+=Er,we[Ge].overtime+=br}});let Oe={},Xe={};return u&&n.forEach(xe=>{const Fe=xe.profile_name||"Unknown",Ge=typeof xe.duration=="number"?xe.duration:Number(xe.duration)||0;Oe[Fe]=(Oe[Fe]||0)+Ge,Xe[Fe]||(Xe[Fe]=[]),Xe[Fe].push({date:xe.date,duration:Ge})}),e.jsxs(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsx(f,{variant:"h4",gutterBottom:!0,sx:{fontSize:"2.5rem"},children:"Time Tracking Reports"}),S&&e.jsx(Re,{severity:"error",sx:{mb:2},children:S}),e.jsxs(T,{container:!0,spacing:3,children:[e.jsx(T,{item:!0,xs:12,children:e.jsxs(qe,{sx:{p:2},children:[e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:12,md:2,children:e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{shrink:!0,children:"Profile"}),e.jsxs(Ot,{value:i,label:"Profile",onChange:xe=>c(xe.target.value),displayEmpty:!0,sx:{"& .MuiSelect-select":{fontSize:"1.2rem"}},children:[e.jsx(ze,{value:"",sx:{fontSize:"1.2rem"},children:"All Profiles"}),t.map(xe=>e.jsx(ze,{value:xe.id,sx:{fontSize:"1.1rem"},children:xe.name},xe.id))]})]})}),e.jsx(T,{item:!0,xs:12,md:2,children:e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{shrink:!0,children:"Sales Order"}),e.jsxs(Ot,{value:u,label:"Sales Order",onChange:xe=>d(xe.target.value),displayEmpty:!0,sx:{"& .MuiSelect-select":{fontSize:"1.2rem"}},children:[e.jsx(ze,{value:"",sx:{fontSize:"1.2rem"},children:"All Sales Orders"}),s.map(xe=>e.jsx(ze,{value:xe.id,sx:{fontSize:"1.1rem"},children:xe.number},xe.id))]})]})}),e.jsx(T,{item:!0,xs:12,md:2,children:e.jsx(Hr,{dateAdapter:Wc,children:e.jsx(on,{label:"From Date",value:O,onChange:xe=>_(xe),slotProps:{textField:{fullWidth:!0}}})})}),e.jsx(T,{item:!0,xs:12,md:2,children:e.jsx(Hr,{dateAdapter:Wc,children:e.jsx(on,{label:"To Date",value:E,onChange:xe=>b(xe),slotProps:{textField:{fullWidth:!0}}})})})]}),e.jsxs(q,{display:"flex",justifyContent:"center",gap:2,mt:2,children:[e.jsx(K,{variant:"contained",color:"secondary",onClick:()=>{We(i===""?"":i),kt(""),Ct(""),j(null),Be(!0)},children:"Add Shift"}),e.jsx(K,{variant:"contained",color:"primary",onClick:Wt,children:"Generate Report"}),e.jsx(K,{variant:"outlined",onClick:()=>ir("csv"),children:"Export CSV"}),e.jsx(K,{variant:"outlined",onClick:()=>ir("pdf"),children:"Download PDF"})]})]})}),e.jsx(T,{item:!0,xs:12,children:u?e.jsxs(qe,{sx:{p:2},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,sx:{fontSize:"1.5rem"},children:"Time Entries Report for Sales Order"}),e.jsx(q,{mb:2,children:e.jsxs(qe,{elevation:2,sx:{p:2,background:"#ede9fe",borderLeft:"6px solid #7c3aed"},children:[e.jsx(f,{variant:"h6",color:"#7c3aed",fontWeight:700,sx:{fontSize:"1.5rem"},children:"Total Hours by Profile on Sales Order"}),Object.entries(Oe).map(([xe,Fe])=>e.jsxs(f,{variant:"body1",sx:{ml:2,fontSize:"1.2rem"},children:["• ",xe,": ",Fe.toFixed(2)," hrs"]},xe))]})}),e.jsxs(qe,{elevation:3,sx:{p:2,mb:2},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Time Entries for Sales Order"}),e.jsx(Kt,{children:e.jsxs(Yt,{children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Profile"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Date"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Clock In"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Clock Out"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Duration"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Actions"})]})}),e.jsx(Gt,{children:n.map(xe=>e.jsxs(rt,{children:[e.jsx(re,{sx:{fontSize:"1.1rem"},children:xe.profile_name}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:new Date(xe.date).toLocaleDateString()}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:new Date(xe.clock_in).toLocaleTimeString()}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:xe.clock_out?new Date(xe.clock_out).toLocaleTimeString():"-"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:xe.duration!==null&&xe.duration!==void 0&&!isNaN(Number(xe.duration))?`${Number(xe.duration).toFixed(3)} hrs`:"-"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:xe.clock_out&&e.jsx(K,{variant:"text",startIcon:e.jsx(oo,{}),onClick:()=>{ne(null),j(null),k(xe),v(en(xe.clock_in)),L(en(xe.clock_out))},sx:{ml:1},children:"Edit"})})]},xe.id))})]})})]})]}):e.jsxs(qe,{sx:{p:2},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,sx:{fontSize:"1.5rem"},children:"Time Entries Report"}),e.jsx(q,{display:"flex",alignItems:"center",mb:2,children:e.jsx(ra,{control:e.jsx(Ti,{checked:me,onChange:xe=>be(xe.target.checked),color:"primary"}),label:e.jsx(f,{sx:{fontSize:"1.1rem"},children:"Show time entry breakdown"})})}),ae.length>0&&e.jsx(q,{mb:2,children:e.jsxs(qe,{elevation:2,sx:{p:2,background:"#ede9fe",borderLeft:"6px solid #7c3aed"},children:[e.jsx(f,{variant:"h6",color:"#7c3aed",fontWeight:700,children:"Summary of Shift Hours by Profile"}),e.jsx(Kt,{component:qe,sx:{mt:2},children:e.jsxs(Yt,{size:"small",children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Profile Name"}),e.jsx(re,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Total hr"}),e.jsx(re,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Idle hr"}),e.jsx(re,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Regular hr"}),e.jsx(re,{sx:{fontWeight:"bold",fontSize:"1.2rem"},children:"Overtime hr"})]})}),e.jsx(Gt,{children:Object.entries(we).map(([xe,Fe])=>{const It=ae.find(rr=>rr.profile_id===Number(xe))?.profile_name||t.find(rr=>rr.id===Number(xe))?.name||`Profile ${xe}`;return e.jsxs(rt,{children:[e.jsx(re,{sx:{fontSize:"1.2rem"},children:It}),e.jsx(re,{sx:{fontSize:"1.2rem"},children:Fe.hours.toFixed(2)}),e.jsx(re,{sx:{fontSize:"1.2rem"},children:Fe.idle.toFixed(2)}),e.jsx(re,{sx:{fontSize:"1.2rem"},children:Fe.regular.toFixed(2)}),e.jsx(re,{sx:{fontSize:"1.2rem"},children:Fe.overtime.toFixed(2)})]},xe)})})]})})]})}),ae.length===0&&!I&&e.jsx(Re,{severity:"info",sx:{mb:2},children:"No shifts found"}),ae.map(xe=>{const Fe=Number(xe.id);return Number.isNaN(Fe)?null:e.jsx(bb,{shift:xe,entries:W[Fe]||[],expanded:m===Fe,onExpand:()=>A(m===Fe?null:Fe),onAddEntry:de,setEditEntry:k,setEditClockIn:v,setEditClockOut:L,profiles:t,setEditShift:X,showBreakdown:me,setEditEntryError:ne,setError:j},Fe)}),J.length>0&&e.jsx(qe,{elevation:3,sx:{mb:2,borderLeft:"6px solid #a21caf",background:"#f3e8ff"},children:e.jsxs(q,{p:2,children:[e.jsx(f,{variant:"subtitle1",fontWeight:700,color:"#a21caf",sx:{fontSize:"1.2rem"},children:"Unscheduled Entries"}),e.jsx(wd,{entries:J,setEditEntry:k,setEditClockIn:v,setEditClockOut:L,setEditEntryError:ne,setError:j})]})})]})})]}),e.jsxs(lt,{open:je,onClose:_e,children:[e.jsx(ct,{children:"Add Time Entry"}),e.jsxs(ut,{children:[D&&e.jsx(f,{variant:"body2",sx:{mb:2},children:`Profile: ${ce} | Shift Date: ${new Date(D.clock_in).toLocaleDateString()}`}),e.jsxs(Dt,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Tt,{id:"add-entry-sales-order-label",children:"Sales Order"}),e.jsxs(Ot,{labelId:"add-entry-sales-order-label",value:te,label:"Sales Order",displayEmpty:!0,onChange:xe=>{const Fe=xe.target.value;B(Fe===""?"":Number(Fe))},children:[e.jsx(ze,{value:"",disabled:!0,children:e.jsx("em",{children:"Select a Sales Order"})}),s.map(xe=>e.jsx(ze,{value:xe.id,children:xe.number},xe.id))]})]}),e.jsx(ie,{label:"Clock In",type:"datetime-local",value:Ee,onChange:xe=>Se(xe.target.value),fullWidth:!0,sx:{mb:2}}),e.jsx(ie,{label:"Clock Out",type:"datetime-local",value:$e,onChange:xe=>He(xe.target.value),fullWidth:!0})]}),e.jsxs(dt,{children:[e.jsx(K,{onClick:_e,disabled:De,children:"Cancel"}),e.jsx(K,{onClick:ue,variant:"contained",disabled:!le||De,children:"Save"})]})]}),e.jsxs(lt,{open:!!N,onClose:()=>{k(null),ne(null)},children:[e.jsx(ct,{children:"Edit Time Entry"}),e.jsxs(ut,{children:[z&&e.jsx(Re,{severity:"error",sx:{mb:2},children:z}),e.jsx(ie,{label:"Clock In",type:"datetime-local",value:M,onChange:xe=>v(xe.target.value),fullWidth:!0,sx:{mb:2}}),e.jsx(ie,{label:"Clock Out",type:"datetime-local",value:g,onChange:xe=>L(xe.target.value),fullWidth:!0})]}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>{k(null),ne(null)},children:"Cancel"}),e.jsx(K,{onClick:ye,variant:"contained",startIcon:e.jsx(ru,{}),children:"Save"})]})]}),e.jsxs(lt,{open:Ve,onClose:()=>{Et||Be(!1)},children:[e.jsx(ct,{children:"Add Shift"}),e.jsxs(ut,{children:[e.jsxs(Dt,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Tt,{id:"add-shift-profile-label",children:"Profile"}),e.jsxs(Ot,{labelId:"add-shift-profile-label",value:Ke,label:"Profile",onChange:xe=>We(xe.target.value),displayEmpty:!0,renderValue:xe=>{if(xe==null)return e.jsx("em",{children:"Select Profile"});if(typeof xe=="string"&&xe==="")return e.jsx("em",{children:"Select Profile"});const Fe=t.find(Ge=>Ge.id===Number(xe));return Fe?Fe.name:String(xe)},children:[e.jsx(ze,{value:"",children:e.jsx("em",{children:"Select Profile"})}),t.map(xe=>e.jsx(ze,{value:xe.id,children:xe.name},xe.id))]})]}),e.jsx(ie,{label:"Clock In",type:"datetime-local",value:pt,onChange:xe=>kt(xe.target.value),fullWidth:!0,sx:{mb:2},InputLabelProps:{shrink:!0}}),e.jsx(ie,{label:"Clock Out",type:"datetime-local",value:at,onChange:xe=>Ct(xe.target.value),fullWidth:!0,InputLabelProps:{shrink:!0}})]}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>{Et||Be(!1)},children:"Cancel"}),e.jsx(K,{onClick:async()=>{if(Ke===""||!pt||!at)return;const xe=Wn(pt),Fe=Wn(at);if(!xe||!Fe){j("Please provide valid shift times.");return}jt(!0);try{await gb(Ke,xe,Fe),Be(!1),kt(""),Ct(""),j(null),await Wt()}catch(Ge){const It=Ge?.response?.data?.message||Ge?.response?.data?.error||"Failed to create shift.";j(It)}finally{jt(!1)}},variant:"contained",color:"primary",disabled:Et||Ke===""||!pt||!at,children:"Save"})]})]}),e.jsxs(lt,{open:!!G,onClose:()=>X(null),children:[e.jsx(ct,{children:"Edit Shift"}),e.jsxs(ut,{children:[e.jsx(ie,{label:"Clock In",type:"datetime-local",value:Y,onChange:xe=>fe(xe.target.value),fullWidth:!0,sx:{mb:2}}),e.jsx(ie,{label:"Clock Out",type:"datetime-local",value:se,onChange:xe=>ke(xe.target.value),fullWidth:!0})]}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>X(null),children:"Cancel"}),e.jsx(K,{onClick:async()=>{if(G){ge(!0);try{await xb(G.id,new Date(Y).toISOString(),new Date(se).toISOString()),X(null),ge(!1),await Wt()}catch(xe){ge(!1);const Fe=xe?.response?.data?.message||xe?.response?.data?.error||"Failed to update shift.";j(Fe)}}},variant:"contained",color:"primary",disabled:Pe,children:"Save"})]})]})]})};function _b(t,r){const s=window.URL.createObjectURL(t),a=document.createElement("a");a.href=s,a.download=r,document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(s),document.body.removeChild(a)}function bb({shift:t,entries:r,expanded:s,onExpand:a,onAddEntry:n,setEditEntry:o,setEditClockIn:i,setEditClockOut:c,profiles:u,setEditShift:d,showBreakdown:p,setEditEntryError:y,setError:w}){const O=new Date(t.clock_in),_=t.clock_out?new Date(t.clock_out):null,E=t.duration!==null&&t.duration!==void 0?Number(t.duration):0,b=t.profile_name||u.find(S=>S.id===t.profile_id)?.name||`Profile ${t.profile_id}`;let I=0;r.forEach(S=>{const j=typeof S.duration=="number"?S.duration:Number(S.duration)||0;I+=j});const U=Math.max(0,E-I);return e.jsx(qe,{elevation:3,sx:{mb:2,borderLeft:"6px solid #7c3aed",background:s?"#f3e8ff":"white"},children:e.jsxs(q,{p:2,children:[e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(f,{variant:"subtitle1",fontWeight:700,color:"#7c3aed",sx:{fontSize:"1.2rem"},children:["Profile: ",b,"   Date: ",O.toLocaleDateString()]}),e.jsxs(q,{display:"flex",gap:1,children:[p&&e.jsx(K,{variant:"contained",color:"primary",size:"small",onClick:a,children:s?"Hide Entries":"Show Entries"}),e.jsx(K,{variant:"outlined",color:"primary",size:"small",onClick:()=>n(t),children:"Add Entry"}),e.jsx(K,{variant:"contained",color:"primary",size:"small",onClick:()=>d(t),children:"Edit Shift"})]})]}),e.jsxs(f,{variant:"body1",sx:{mt:1,fontSize:"1.1rem"},children:["Shift: ",O.toLocaleTimeString()," → ",_?_.toLocaleTimeString():"-"," (",E.toFixed(2)," hrs)"]}),p&&e.jsxs(q,{sx:{mt:1,ml:2},children:[r.map((S,j)=>{const N=typeof S.duration=="number"?S.duration:Number(S.duration)||0,k=new Date(S.clock_in),M=S.clock_out?new Date(S.clock_out):null;return e.jsxs(f,{variant:"body2",sx:{fontSize:"1.1rem"},children:["• ",S.sales_order_number,": ",k.toLocaleTimeString()," → ",M?M.toLocaleTimeString():"-"," (",N.toFixed(3)," hrs)"]},S.id||j)}),U>0&&e.jsxs(f,{variant:"body2",sx:{fontSize:"1.1rem"},children:["• Idle: ",U.toFixed(3)," hrs"]})]}),p&&s&&e.jsx(wd,{entries:r,setEditEntry:o,setEditClockIn:i,setEditClockOut:c,setEditEntryError:y,setError:w})]})})}function wd({entries:t,setEditEntry:r,setEditClockIn:s,setEditClockOut:a,setEditEntryError:n,setError:o}){return e.jsx(Kt,{sx:{mt:1,mb:1},children:e.jsxs(Yt,{size:"small",children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{children:"Sales Order"}),e.jsx(re,{children:"Clock In"}),e.jsx(re,{children:"Clock Out"}),e.jsx(re,{children:"Duration"}),e.jsx(re,{children:"Actions"})]})}),e.jsx(Gt,{children:t.map(i=>e.jsxs(rt,{children:[e.jsx(re,{children:i.sales_order_number}),e.jsx(re,{children:new Date(i.clock_in).toLocaleTimeString()}),e.jsx(re,{children:i.clock_out?new Date(i.clock_out).toLocaleTimeString():"-"}),e.jsx(re,{children:i.duration!==null&&i.duration!==void 0&&!isNaN(Number(i.duration))?`${Number(i.duration).toFixed(3)} hrs`:"-"}),e.jsx(re,{children:i.clock_out&&e.jsx(K,{variant:"text",startIcon:e.jsx(oo,{}),onClick:()=>{n(null),o(null),r(i),s(en(i.clock_in)),a(en(i.clock_out))},sx:{ml:1},children:"Edit"})})]},i.id))})]})})}const xr={submitRequest:async t=>(await $.post("/api/leave-management/request",t)).data,getMyRequests:async()=>(await $.get("/api/leave-management/my-requests")).data,getAllRequests:async()=>(await $.get("/api/leave-management/all-requests")).data,getCalendar:async(t,r)=>{const s={};return t&&(s.start_date=t),r&&(s.end_date=r),(await $.get("/api/leave-management/calendar",{params:s})).data},approveRequest:async(t,r,s,a)=>(await $.post(`/api/leave-management/approve/${t}`,{admin_notes:r,proposed_start_date:s,proposed_end_date:a})).data,denyRequest:async(t,r)=>(await $.post(`/api/leave-management/deny/${t}`,{admin_notes:r})).data,proposeVacationDates:async(t,r,s,a)=>(await $.post(`/api/leave-management/propose/${t}`,{proposed_start_date:r,proposed_end_date:s,admin_notes:a})).data,getProfiles:async()=>(await $.get("/api/leave-management/profiles")).data,getLeaveHistory:async()=>(await $.get("/api/leave-management/history")).data,getVacationSettings:async()=>(await $.get("/api/leave-management/vacation-settings")).data,updateVacationSettings:async t=>(await $.put("/api/leave-management/vacation-settings",{reset_date:t})).data,updateEmployeeVacationDays:async(t,r)=>(await $.put(`/api/leave-management/profiles/${t}/vacation-days`,{total_vacation_days:r})).data,resetAllVacationDays:async()=>(await $.post("/api/leave-management/reset-vacation-days")).data,getLeaveStatistics:async()=>(await $.get("/api/leave-management/statistics")).data},jb=()=>{const{user:t}=Qt(),r=qt(),[s,a]=l.useState([]),[n,o]=l.useState([]),[i,c]=l.useState(!0),[u,d]=l.useState(null),[p,y]=l.useState(()=>{const m=Ze(),A=m.day();return m.subtract(A,"day").startOf("day")}),[w,O]=l.useState({open:!1,requestId:0,action:"approve"}),[_,E]=l.useState(""),[b,I]=l.useState(null),[U,S]=l.useState(null),[j,N]=l.useState(!1),[k,M]=l.useState(!0);l.useEffect(()=>{console.log("LeaveManagementPage - User data:",t),(t?.access_role==="Admin"||t?.access_role==="Time Tracking")&&v()},[t]);const v=async()=>{try{console.log("LeaveManagementPage - Fetching data..."),c(!0);const[m,A]=await Promise.all([xr.getAllRequests(),xr.getProfiles()]);console.log("LeaveManagementPage - Data received:",{requestsData:m,profilesData:A}),a(m||[]),o(A||[]),d(null)}catch(m){console.error("LeaveManagementPage - Error fetching data:",m),d(m.response?.data?.message||"Failed to load data. Please try again.")}finally{c(!1)}},g=()=>{const m=[],A=Ze();for(let G=0;G<7;G++){const X=p.add(G,"day"),Y=X.isSame(A,"day"),fe=s.filter(se=>{if(se.status!=="approved")return!1;const ke=Ze(se.start_date),Pe=Ze(se.end_date);return(ke.isSame(X,"day")||ke.isBefore(X))&&(Pe.isSame(X,"day")||Pe.isAfter(X))}).map(se=>se.profile_name);m.push({date:X,isToday:Y,hasTimeOff:fe.length>0,timeOffProfiles:fe})}return m},L=m=>{y(m==="prev"?A=>A.subtract(7,"day"):A=>A.add(7,"day"))},z=()=>{const m=Ze(),A=m.day();y(m.subtract(A,"day").startOf("day"))},ne=()=>{const m=p.add(6,"day");return s.filter(A=>{if(A.status!=="approved")return!1;const G=Ze(A.start_date),X=Ze(A.end_date);return(G.isSame(m,"day")||G.isBefore(m))&&(X.isSame(p,"day")||X.isAfter(p))}).map(A=>({profileName:A.profile_name,startDate:Ze(A.start_date),endDate:Ze(A.end_date),requestType:A.request_type,reason:A.reason})).sort((A,G)=>A.startDate.valueOf()-G.startDate.valueOf())},ae=()=>{const m=Ze(),A=m.startOf("month"),G=m.endOf("month");return s.filter(Y=>{if(Y.status!=="approved")return!1;const fe=Ze(Y.start_date),se=Ze(Y.end_date);return(fe.isSame(G,"day")||fe.isBefore(G))&&(se.isSame(A,"day")||se.isAfter(A))}).map(Y=>({profileName:Y.profile_name,startDate:Ze(Y.start_date),endDate:Ze(Y.end_date),requestType:Y.request_type})).sort((Y,fe)=>Y.startDate.valueOf()-fe.startDate.valueOf())},ee=()=>{const m=ae();if(m.length===0)return"No employees on leave this month";const A=new Map;return m.forEach(X=>{A.has(X.profileName)||A.set(X.profileName,[]),A.get(X.profileName).push(X)}),Array.from(A.entries()).map(([X,Y])=>{const fe=Y.map(se=>{const ke=se.startDate.format("MMM D"),Pe=se.endDate.format("MMM D");return`${ke}-${Pe}`}).join(", ");return`${X}: ${fe}`}).slice(0,3).join(" • ")},W=(m,A)=>{O({open:!0,requestId:m,action:A}),E(""),I(null),S(null)},Z=async()=>{N(!0);try{const{requestId:m,action:A}=w;if(A==="approve")await xr.approveRequest(m,_,b?.format("YYYY-MM-DD"),U?.format("YYYY-MM-DD"));else if(A==="deny")await xr.denyRequest(m,_);else if(A==="propose"){if(!b||!U){d("Please enter both start and end dates"),N(!1);return}if(U.isBefore(b)){d("End date cannot be before start date"),N(!1);return}await xr.proposeVacationDates(m,b.format("YYYY-MM-DD"),U.format("YYYY-MM-DD"),_)}O({open:!1,requestId:0,action:"approve"}),await v()}catch(m){d(m.response?.data?.message||"Action failed. Please try again.")}finally{N(!1)}},J=m=>{const G={pending:{color:"warning",label:"Pending"},approved:{color:"success",label:"Approved"},denied:{color:"error",label:"Denied"},modified:{color:"info",label:"Modified"}}[m]||{color:"default",label:m};return e.jsx(Le,{label:G.label,color:G.color,size:"small"})},P=m=>({vacation:"Vacation",sick:"Sick Day",personal:"Personal",bereavement:"Bereavement"})[m]||m;return t?t.access_role!=="Admin"&&t.access_role!=="Time Tracking"?e.jsx(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(Re,{severity:"error",children:"Access denied. Admin or Time Tracking privileges required to view this page."})}):i?e.jsx(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(q,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(it,{})})}):e.jsx(Hr,{dateAdapter:Tn,children:e.jsxs(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(f,{variant:"h4",component:"h1",children:["Leave Management",t.access_role==="Admin"?" (Admin)":" (View Only)"]}),e.jsxs(q,{display:"flex",gap:2,children:[e.jsx(K,{variant:"outlined",startIcon:e.jsx(li,{}),onClick:()=>r("/leave-history"),children:"View History"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(Yn,{}),onClick:()=>r("/vacation-days-management"),children:"Manage Vacation Days"})]})]}),e.jsx(f,{variant:"body1",color:"text.secondary",paragraph:!0,children:ee()}),u&&e.jsx(Re,{severity:"error",sx:{mb:2},children:u}),e.jsxs(T,{container:!0,spacing:3,children:[e.jsx(T,{item:!0,xs:12,children:e.jsxs(qe,{sx:{p:3},children:[e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(f,{variant:"h6",children:[e.jsx(Vn,{sx:{mr:1,verticalAlign:"middle"}}),"Weekly Leave Schedule"]}),e.jsxs(q,{display:"flex",gap:1,children:[e.jsx(K,{variant:"outlined",size:"small",onClick:()=>L("prev"),startIcon:e.jsx(Vd,{}),children:"Previous Week"}),e.jsx(K,{variant:"outlined",size:"small",onClick:z,startIcon:e.jsx(Gd,{}),children:"Today"}),e.jsx(K,{variant:"outlined",size:"small",onClick:()=>L("next"),endIcon:e.jsx(Qd,{}),children:"Next Week"})]})]}),e.jsxs(f,{variant:"body2",color:"text.secondary",mb:3,children:["Week of ",p.format("MMMM D, YYYY")]}),e.jsx(q,{sx:{overflowX:"auto"},children:e.jsx(Kt,{component:qe,variant:"outlined",children:e.jsxs(Yt,{size:"small",children:[e.jsx(Vt,{children:e.jsxs(rt,{sx:{backgroundColor:"grey.50"},children:[e.jsx(re,{sx:{fontWeight:"bold",minWidth:140},children:"Employee Name"}),g().map((m,A)=>e.jsx(re,{align:"center",sx:{fontWeight:"bold",minWidth:70},children:e.jsxs(q,{children:[e.jsx(f,{variant:"caption",display:"block",sx:{fontWeight:"bold"},children:m.date.format("ddd")}),e.jsx(f,{variant:"body2",children:m.date.format("MMM D")}),m.isToday&&e.jsx(f,{variant:"caption",display:"block",sx:{color:"primary.main",fontWeight:"bold"},children:"Today"})]})},A))]})}),e.jsxs(Gt,{children:[ne().map((m,A)=>e.jsxs(rt,{hover:!0,children:[e.jsx(re,{sx:{fontWeight:"medium"},children:m.profileName}),g().map((G,X)=>{const Y=(m.startDate.isSame(G.date,"day")||m.startDate.isBefore(G.date))&&(m.endDate.isSame(G.date,"day")||m.endDate.isAfter(G.date));return e.jsx(re,{align:"center",sx:{backgroundColor:Y?"error.light":"inherit",color:Y?"error.dark":"text.primary",fontWeight:Y?"medium":"normal"},children:Y?e.jsxs(q,{children:[e.jsx(f,{variant:"caption",display:"block",sx:{fontWeight:"bold",textTransform:"capitalize"},children:P(m.requestType)}),m.reason&&e.jsx(ar,{title:m.reason,children:e.jsx(f,{variant:"caption",sx:{opacity:.75},children:m.reason.length>8?m.reason.substring(0,8)+"...":m.reason})})]}):e.jsx(f,{variant:"body2",color:"text.secondary",children:"-"})},X)})]},A)),ne().length===0&&e.jsx(rt,{children:e.jsx(re,{colSpan:8,align:"center",sx:{py:4},children:e.jsxs(q,{sx:{textAlign:"center"},children:[e.jsx(Vn,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(f,{color:"text.secondary",children:"No employees on leave this week"})]})})})]})]})})})]})}),e.jsx(T,{item:!0,xs:12,children:e.jsxs(qe,{sx:{p:3},children:[e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(f,{variant:"h6",children:[e.jsx(Jd,{sx:{mr:1,verticalAlign:"middle"}}),"Leave Requests",t.access_role!=="Admin"&&e.jsx(f,{variant:"caption",display:"block",color:"text.secondary",sx:{mt:1},children:"View-only mode. Admin actions are restricted to administrators."})]}),e.jsxs(q,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(f,{variant:"body2",color:"text.secondary",children:"Show:"}),e.jsx(K,{variant:k?"contained":"outlined",size:"small",onClick:()=>M(!0),sx:{minWidth:100},children:"Pending"}),e.jsx(K,{variant:k?"outlined":"contained",size:"small",onClick:()=>M(!1),sx:{minWidth:100},children:"All"})]})]}),e.jsx(Kt,{children:e.jsxs(Yt,{children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{sx:{fontWeight:"bold"},children:"Employee"}),e.jsx(re,{sx:{fontWeight:"bold"},children:"Type"}),e.jsx(re,{sx:{fontWeight:"bold"},children:"Dates"}),e.jsx(re,{sx:{fontWeight:"bold"},children:"Days"}),e.jsx(re,{sx:{fontWeight:"bold"},children:"Status"}),e.jsx(re,{sx:{fontWeight:"bold"},children:"Reason"}),e.jsx(re,{sx:{fontWeight:"bold"},children:"Admin Notes"}),e.jsx(re,{sx:{fontWeight:"bold"},children:"Actions"})]})}),e.jsx(Gt,{children:(()=>{const m=k?s.filter(A=>A.status==="pending"):s;return m.length===0?e.jsx(rt,{children:e.jsx(re,{colSpan:8,align:"center",sx:{py:4},children:e.jsx(f,{color:"text.secondary",children:k?"No pending leave requests found":"No leave requests found"})})}):m.map(A=>e.jsxs(rt,{hover:!0,children:[e.jsx(re,{children:e.jsxs(q,{children:[e.jsx(f,{variant:"body2",sx:{fontWeight:"medium"},children:A.profile_name}),e.jsx(f,{variant:"caption",color:"text.secondary",children:A.user_email})]})}),e.jsx(re,{children:e.jsx(Le,{label:P(A.request_type),size:"small",variant:"outlined"})}),e.jsxs(re,{children:[e.jsx(f,{variant:"body2",children:Ze(A.start_date).format("MMM D, YYYY")}),e.jsxs(f,{variant:"body2",children:["to ",Ze(A.end_date).format("MMM D, YYYY")]})]}),e.jsx(re,{children:e.jsxs(f,{variant:"body2",children:[A.total_days," day",A.total_days!==1?"s":""]})}),e.jsx(re,{children:J(A.status)}),e.jsx(re,{children:e.jsx(f,{variant:"body2",sx:{maxWidth:200},children:A.reason||"-"})}),e.jsx(re,{children:e.jsx(f,{variant:"body2",sx:{maxWidth:200},children:A.admin_notes||"-"})}),e.jsx(re,{children:A.status==="pending"&&t.access_role==="Admin"&&e.jsxs(q,{display:"flex",gap:1,children:[e.jsx(ar,{title:"Approve Request",children:e.jsx(ot,{color:"success",size:"small",onClick:()=>W(A.request_id,"approve"),children:e.jsx(zs,{})})}),e.jsx(ar,{title:"Deny Request",children:e.jsx(ot,{color:"error",size:"small",onClick:()=>W(A.request_id,"deny"),children:e.jsx($n,{})})}),(A.request_type==="vacation"||A.request_type==="personal"||A.request_type==="bereavement")&&e.jsx(ar,{title:"Propose Dates",children:e.jsx(ot,{color:"info",size:"small",onClick:()=>W(A.request_id,"propose"),children:e.jsx(Vn,{})})})]})})]},A.request_id))})()})]})})]})})]}),e.jsxs(lt,{open:w.open,onClose:()=>O({open:!1,requestId:0,action:"approve"}),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ct,{children:w.action==="approve"?"Approve Request":w.action==="deny"?"Deny Request":"Propose Dates"}),e.jsx(ut,{children:e.jsxs(q,{sx:{pt:2},children:[(w.action==="propose"||w.action==="approve")&&e.jsx(q,{sx:{mb:3},children:e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:6,children:e.jsx(on,{label:w.action==="propose"?"Proposed Start Date":"Proposed Start Date (Optional)",value:b,onChange:m=>I(m),slotProps:{textField:{fullWidth:!0,size:"small"}}})}),e.jsx(T,{item:!0,xs:6,children:e.jsx(on,{label:w.action==="propose"?"Proposed End Date":"Proposed End Date (Optional)",value:U,onChange:m=>S(m),minDate:b,disabled:!b,slotProps:{textField:{fullWidth:!0,size:"small"}}})})]})}),e.jsx(ie,{fullWidth:!0,multiline:!0,rows:3,label:"Admin Notes",value:_,onChange:m=>E(m.target.value),placeholder:"Add notes about this decision...",variant:"outlined",size:"small"})]})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>O({open:!1,requestId:0,action:"approve"}),disabled:j,children:"Cancel"}),e.jsx(K,{onClick:Z,disabled:j,variant:"contained",color:w.action==="deny"?"error":"primary",children:j?"Processing...":w.action==="approve"?"Approve":w.action==="deny"?"Deny":"Propose"})]})]})]})}):e.jsx(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(q,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:[e.jsx(it,{}),e.jsx(f,{variant:"body2",sx:{ml:2},children:"Loading user data..."})]})})},wb=()=>{const{user:t}=Qt(),[r,s]=l.useState([]),[a,n]=l.useState(null),[o,i]=l.useState(!0),[c,u]=l.useState(null);l.useEffect(()=>{(t?.access_role==="Admin"||t?.access_role==="Time Tracking")&&d()},[t]);const d=async()=>{try{i(!0);const[_,E]=await Promise.all([xr.getLeaveHistory(),xr.getLeaveStatistics()]);s(_||[]),n(E),u(null)}catch(_){console.error("Error fetching leave history:",_),u(_.response?.data?.message||"Failed to load leave history. Please try again.")}finally{i(!1)}},p=_=>Ze(_+"-01").format("MMMM YYYY"),y=_=>{let E=0;return Object.values(_.months).forEach(b=>{E+=b.total_days}),E},w=()=>{const _=new Set;return r.forEach(E=>{Object.keys(E.months).forEach(b=>_.add(b))}),Array.from(_).sort().reverse()};if(!t)return e.jsx(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(q,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:[e.jsx(it,{}),e.jsx(f,{variant:"body2",sx:{ml:2},children:"Loading user data..."})]})});if(t.access_role!=="Admin"&&t.access_role!=="Time Tracking")return e.jsx(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(Re,{severity:"error",children:"Access denied. Admin or Time Tracking privileges required to view this page."})});if(o)return e.jsx(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(q,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(it,{})})});const O=w();return e.jsxs(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(f,{variant:"h4",component:"h1",gutterBottom:!0,children:[e.jsx(li,{sx:{mr:1,verticalAlign:"middle"}}),"Leave History (Past 12 Months)"]}),e.jsx(f,{variant:"body1",color:"text.secondary",paragraph:!0,children:"View leave history for all employees over the past 12 months"}),c&&e.jsx(Re,{severity:"error",sx:{mb:2},children:c}),r.length===0?e.jsxs(qe,{sx:{p:4,textAlign:"center"},children:[e.jsx(li,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(f,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"No Leave History Found"}),e.jsx(f,{color:"text.secondary",children:"No approved leave requests found in the past 12 months."})]}):e.jsxs(q,{children:[e.jsxs(T,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(T,{item:!0,xs:12,md:4,children:e.jsx(mt,{children:e.jsx(wt,{children:e.jsxs(q,{display:"flex",alignItems:"center",children:[e.jsx(ki,{sx:{fontSize:40,color:"primary.main",mr:2}}),e.jsxs(q,{children:[e.jsx(f,{variant:"h4",component:"div",children:a?.employees_with_leave_this_month||0}),e.jsx(f,{color:"text.secondary",children:"Employees with Leave This Month"})]})]})})})}),e.jsx(T,{item:!0,xs:12,md:4,children:e.jsx(mt,{children:e.jsx(wt,{children:e.jsxs(q,{display:"flex",alignItems:"center",children:[e.jsx(Vn,{sx:{fontSize:40,color:"success.main",mr:2}}),e.jsxs(q,{children:[e.jsx(f,{variant:"h4",component:"div",children:a?.total_days_this_month||0}),e.jsx(f,{color:"text.secondary",children:"Total Days of Leave This Month"})]})]})})})}),e.jsx(T,{item:!0,xs:12,md:4,children:e.jsx(mt,{children:e.jsx(wt,{children:e.jsxs(q,{display:"flex",alignItems:"center",children:[e.jsx(nu,{sx:{fontSize:40,color:"info.main",mr:2}}),e.jsxs(q,{children:[e.jsx(f,{variant:"h4",component:"div",children:a?.total_days_past_12_months||0}),e.jsx(f,{color:"text.secondary",children:"Total Days of Leave (Past 12 Months)"})]})]})})})})]}),r.map(_=>e.jsxs(Kd,{sx:{mb:2},children:[e.jsx(Xd,{expandIcon:e.jsx(su,{}),children:e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%",children:[e.jsxs(q,{children:[e.jsx(f,{variant:"h6",children:_.profile_name}),e.jsx(f,{variant:"body2",color:"text.secondary",children:_.profile_email})]}),e.jsxs(q,{display:"flex",alignItems:"center",gap:2,children:[e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Total: ",y(_).toFixed(1)," days"]}),e.jsx(Le,{label:`${Object.keys(_.months).length} months`,size:"small",variant:"outlined"})]})]})}),e.jsx(Zd,{children:e.jsx(Kt,{component:qe,variant:"outlined",children:e.jsxs(Yt,{size:"small",children:[e.jsx(Vt,{children:e.jsxs(rt,{sx:{backgroundColor:"grey.50"},children:[e.jsx(re,{sx:{fontWeight:"bold"},children:"Month"}),e.jsx(re,{align:"center",sx:{fontWeight:"bold"},children:"Vacation"}),e.jsx(re,{align:"center",sx:{fontWeight:"bold"},children:"Sick"}),e.jsx(re,{align:"center",sx:{fontWeight:"bold"},children:"Personal"}),e.jsx(re,{align:"center",sx:{fontWeight:"bold"},children:"Bereavement"}),e.jsx(re,{align:"center",sx:{fontWeight:"bold"},children:"Total"})]})}),e.jsx(Gt,{children:O.map(E=>{const b=_.months[E];return!b||b.total_days===0?null:e.jsxs(rt,{hover:!0,children:[e.jsx(re,{sx:{fontWeight:"medium"},children:p(E)}),e.jsx(re,{align:"center",children:b.vacation_days>0?e.jsx(Le,{label:b.vacation_days,size:"small",color:"success",variant:"outlined"}):"-"}),e.jsx(re,{align:"center",children:b.sick_days>0?e.jsx(Le,{label:b.sick_days,size:"small",color:"error",variant:"outlined"}):"-"}),e.jsx(re,{align:"center",children:b.personal_days>0?e.jsx(Le,{label:b.personal_days,size:"small",color:"info",variant:"outlined"}):"-"}),e.jsx(re,{align:"center",children:b.bereavement_days>0?e.jsx(Le,{label:b.bereavement_days,size:"small",color:"warning",variant:"outlined"}):"-"}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"body2",sx:{fontWeight:"bold"},children:b.total_days})})]},E)})})]})})})]},_.profile_id))]})]})},Sb=()=>{const{user:t}=Qt(),[r,s]=l.useState([]),[a,n]=l.useState(null),[o,i]=l.useState(!0),[c,u]=l.useState(null),[d,p]=l.useState(null),[y,w]=l.useState(0),[O,_]=l.useState(!1),[E,b]=l.useState(null),[I,U]=l.useState(!1);l.useEffect(()=>{t?.access_role==="Admin"&&S()},[t]);const S=async()=>{try{i(!0);const[ae,ee]=await Promise.all([xr.getProfiles(),xr.getVacationSettings()]);s(ae||[]),n(ee),u(null)}catch(ae){console.error("Error fetching data:",ae),u(ae.response?.data?.message||"Failed to load data. Please try again.")}finally{i(!1)}},j=ae=>{p(ae.id),w(ae.total_vacation_days||ae.vacation_days_available||20)},N=async()=>{if(!d)return;const ae=Math.round(y);try{U(!0),await xr.updateEmployeeVacationDays(d,ae),await S(),p(null),w(0)}catch(ee){u(ee.response?.data?.message||"Failed to update vacation days.")}finally{U(!1)}},k=()=>{p(null),w(0)},M=()=>{b(a?.reset_date?Ze(a.reset_date):null),_(!0)},v=async()=>{if(!E){u("Please select a reset date.");return}try{U(!0),await xr.updateVacationSettings(E.format("YYYY-MM-DD")),await S(),_(!1)}catch(ae){u(ae.response?.data?.message||"Failed to update settings.")}finally{U(!1)}},g=async()=>{if(window.confirm("This will reset vacation days for ALL employees. Are you sure?"))try{U(!0),await xr.resetAllVacationDays(),await S()}catch(ae){u(ae.response?.data?.message||"Failed to reset vacation days.")}finally{U(!1)}};if(!t)return e.jsx(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(q,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:[e.jsx(it,{}),e.jsx(f,{variant:"body2",sx:{ml:2},children:"Loading user data..."})]})});if(t.access_role!=="Admin")return e.jsx(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(Re,{severity:"error",children:"Access denied. Admin privileges required to view this page."})});if(o)return e.jsx(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(q,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(it,{})})});const L=r.length,z=r.reduce((ae,ee)=>ae+(ee.total_vacation_days||ee.vacation_days_available||20),0),ne=r.reduce((ae,ee)=>ae+Math.round(ee.days_used||0),0);return e.jsx(Hr,{dateAdapter:Tn,children:e.jsxs(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(f,{variant:"h4",component:"h1",children:[e.jsx(Yn,{sx:{mr:1,verticalAlign:"middle"}}),"Vacation Days Management"]}),e.jsxs(q,{display:"flex",gap:2,children:[e.jsx(K,{variant:"outlined",startIcon:e.jsx(Vn,{}),onClick:M,children:"Reset Settings"}),e.jsx(K,{variant:"contained",color:"warning",startIcon:e.jsx(Oi,{}),onClick:g,disabled:I,children:"Reset All Days"})]})]}),e.jsx(f,{variant:"body1",color:"text.secondary",paragraph:!0,children:"Manage vacation days allocation for each employee and set the global reset date."}),c&&e.jsx(Re,{severity:"error",sx:{mb:2},children:c}),e.jsxs(T,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(T,{item:!0,xs:12,md:3,children:e.jsx(mt,{children:e.jsx(wt,{children:e.jsxs(q,{display:"flex",alignItems:"center",children:[e.jsx(ki,{sx:{fontSize:40,color:"primary.main",mr:2}}),e.jsxs(q,{children:[e.jsx(f,{variant:"h4",component:"div",children:L}),e.jsx(f,{color:"text.secondary",children:"Total Employees"})]})]})})})}),e.jsx(T,{item:!0,xs:12,md:3,children:e.jsx(mt,{children:e.jsx(wt,{children:e.jsxs(q,{display:"flex",alignItems:"center",children:[e.jsx(Vn,{sx:{fontSize:40,color:"success.main",mr:2}}),e.jsxs(q,{children:[e.jsx(f,{variant:"h4",component:"div",children:z}),e.jsx(f,{color:"text.secondary",children:"Total Days Allocated"})]})]})})})}),e.jsx(T,{item:!0,xs:12,md:3,children:e.jsx(mt,{children:e.jsx(wt,{children:e.jsxs(q,{display:"flex",alignItems:"center",children:[e.jsx(nu,{sx:{fontSize:40,color:"info.main",mr:2}}),e.jsxs(q,{children:[e.jsx(f,{variant:"h4",component:"div",children:ne}),e.jsx(f,{color:"text.secondary",children:"Days Used"})]})]})})})}),e.jsx(T,{item:!0,xs:12,md:3,children:e.jsx(mt,{children:e.jsx(wt,{children:e.jsxs(q,{display:"flex",alignItems:"center",children:[e.jsx(Yn,{sx:{fontSize:40,color:"warning.main",mr:2}}),e.jsxs(q,{children:[e.jsx(f,{variant:"h6",component:"div",children:a?.reset_date?Ze(a.reset_date).format("MMM D, YYYY"):"Not Set"}),e.jsx(f,{color:"text.secondary",children:"Reset Date"})]})]})})})})]}),e.jsxs(qe,{sx:{p:3},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Employee Vacation Days"}),e.jsx(Kt,{children:e.jsxs(Yt,{children:[e.jsx(Vt,{children:e.jsxs(rt,{sx:{backgroundColor:"grey.50"},children:[e.jsx(re,{sx:{fontWeight:"bold"},children:"Employee"}),e.jsx(re,{align:"center",sx:{fontWeight:"bold"},children:"Total Days"}),e.jsx(re,{align:"center",sx:{fontWeight:"bold"},children:"Days Used"}),e.jsx(re,{align:"center",sx:{fontWeight:"bold"},children:"Days Remaining"}),e.jsx(re,{align:"center",sx:{fontWeight:"bold"},children:"Reset Date"}),e.jsx(re,{align:"center",sx:{fontWeight:"bold"},children:"Actions"})]})}),e.jsx(Gt,{children:r.map(ae=>e.jsxs(rt,{hover:!0,children:[e.jsx(re,{children:e.jsxs(q,{children:[e.jsx(f,{variant:"body2",sx:{fontWeight:"medium"},children:ae.name}),e.jsx(f,{variant:"caption",color:"text.secondary",children:ae.email})]})}),e.jsx(re,{align:"center",children:d===ae.id?e.jsx(ie,{type:"number",value:y,onChange:ee=>w(Math.max(0,parseInt(ee.target.value)||0)),size:"small",sx:{width:80},inputProps:{min:0,step:1}}):e.jsx(f,{variant:"body2",sx:{fontWeight:"bold"},children:ae.total_vacation_days||ae.vacation_days_available||20})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"body2",color:"text.secondary",children:Math.round(ae.days_used||0)})}),e.jsx(re,{align:"center",children:e.jsx(Le,{label:Math.round(ae.days_remaining||ae.vacation_days_available||20),size:"small",color:ae.days_remaining&&ae.days_remaining<5?"warning":"success",variant:"outlined"})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"body2",color:"text.secondary",children:ae.reset_date?Ze(ae.reset_date).format("MMM D, YYYY"):"-"})}),e.jsx(re,{align:"center",children:d===ae.id?e.jsxs(q,{display:"flex",gap:1,children:[e.jsx(ar,{title:"Save",children:e.jsx(ot,{color:"success",size:"small",onClick:N,disabled:I,children:e.jsx(ru,{})})}),e.jsx(ar,{title:"Cancel",children:e.jsx(ot,{color:"error",size:"small",onClick:k,disabled:I,children:e.jsx($n,{})})})]}):e.jsx(ar,{title:"Edit Vacation Days",children:e.jsx(ot,{color:"primary",size:"small",onClick:()=>j(ae),children:e.jsx(oo,{})})})})]},ae.id))})]})})]}),e.jsxs(lt,{open:O,onClose:()=>_(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ct,{children:e.jsxs(q,{display:"flex",alignItems:"center",children:[e.jsx(Yn,{sx:{mr:1}}),"Vacation Reset Settings"]})}),e.jsx(ut,{children:e.jsxs(q,{sx:{pt:2},children:[e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Set the date when vacation days will reset for all employees. This date will be the same for everyone and will repeat on the same month and day every year (e.g., January 1st, July 1st, etc.)."}),e.jsx(on,{label:"Reset Date",value:E,onChange:ae=>b(ae),slotProps:{textField:{fullWidth:!0,size:"small"}}}),E&&e.jsxs(Re,{severity:"info",sx:{mt:2},children:["Vacation days will reset on ",E.format("MMMM D")," every year for all employees."]})]})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>_(!1),disabled:I,children:"Cancel"}),e.jsx(K,{onClick:v,disabled:I||!E,variant:"contained",children:I?"Saving...":"Save Settings"})]})]})]})})},Cb=async()=>(await $.get("/api/products")).data,kb=()=>{const[t,r]=l.useState([]),[s,a]=l.useState(!1),[n,o]=l.useState(null),[i,c]=l.useState({page:0,pageSize:10}),[u,d]=l.useState(""),[p,y]=l.useState(!1),[w,O]=l.useState(null),[_,E]=l.useState(null);l.useEffect(()=>{b()},[]);const b=async()=>{a(!0),o(null);try{const v=[...await Cb()].sort((g,L)=>Number(L.product_id)-Number(g.product_id));r(v)}catch{o("Failed to fetch products"),H.error("Failed to fetch products")}finally{a(!1)}},I=t.filter(M=>{const v=u.toLowerCase();return M.product_name?.toLowerCase().includes(v)||M.product_description?.toLowerCase?.().includes(v)||String(M.product_id??"").toLowerCase().includes(v)}),U=async M=>{if(window.confirm("Are you sure you want to delete this product?"))try{await $.delete(`/api/products/${M}`),r(v=>v.filter(g=>g.product_id!==M)),H.success("Product deleted successfully")}catch{H.error("Failed to delete product")}},S=()=>{const M=I.map(ne=>({"Product ID":ne.product_id,"Product Name":ne.product_name,"Product Description":ne.product_description??""})),v=un.unparse(M),g=new Blob([v],{type:"text/csv;charset=utf-8;"}),L=document.createElement("a"),z=URL.createObjectURL(g);L.href=z,L.setAttribute("download","products.csv"),L.style.visibility="hidden",document.body.appendChild(L),L.click(),document.body.removeChild(L),E("Products exported to CSV.")},j=()=>y(!0),N=()=>y(!1),k=[{field:"product_id",headerName:"Product ID",flex:.8,minWidth:110},{field:"product_name",headerName:"Product Name",flex:1.4,minWidth:200},{field:"product_description",headerName:"Product Description",flex:2,minWidth:250,valueGetter:M=>M.row.product_description??""},{field:"actions",headerName:"Actions",width:90,sortable:!1,filterable:!1,disableColumnMenu:!0,renderCell:M=>e.jsx(ot,{size:"small",color:"error",onClick:v=>{v.stopPropagation(),U(M.row.product_id)},children:e.jsx(tr,{})})}];return e.jsxs(Qe,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(q,{sx:{mb:4},children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:"Product List"}),e.jsx(q,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:e.jsxs(tt,{direction:"row",spacing:2,children:[e.jsx(K,{variant:"contained",startIcon:e.jsx(vr,{}),onClick:j,children:"New Product"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(or,{}),onClick:S,children:"Export CSV"})]})})]}),e.jsx(qe,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(q,{sx:{p:2},children:[e.jsx(ie,{fullWidth:!0,label:"Search",variant:"outlined",value:u,onChange:M=>d(M.target.value),InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:e.jsx(yr,{sx:{fontSize:22}})})},sx:{mb:2,"& .MuiInputBase-input":{fontSize:22,py:2},"& .MuiInputLabel-root":{fontSize:20}},size:"small"}),e.jsx(Mr,{rows:I.map(M=>({...M,id:M.product_id})),columns:k,loading:s,paginationModel:i,onPaginationModelChange:c,pageSizeOptions:[10,25,50],getRowId:M=>M.id,disableRowSelectionOnClick:!0,initialState:{sorting:{sortModel:[{field:"product_id",sort:"desc"}]}},sx:{"& .MuiDataGrid-cell, & .MuiDataGrid-columnHeader, & .MuiDataGrid-columnHeaderTitle":{fontSize:"1.1rem"},"& .MuiDataGrid-cell":{borderBottom:"1px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-columnHeaders":{backgroundColor:"background.paper",borderBottom:"2px solid rgba(224, 224, 224, 1)"},"& .MuiDataGrid-row":{minHeight:"52px !important",maxHeight:"52px !important"},"& .MuiDataGrid-columnHeadersInner":{minHeight:"60px !important",maxHeight:"60px !important"},"& .MuiDataGrid-row:hover":{backgroundColor:"action.hover"}}})]})}),w&&e.jsx(Re,{severity:"error",sx:{mt:2},onClose:()=>O(null),children:w}),_&&e.jsx(Re,{severity:"success",sx:{mt:2},onClose:()=>E(null),children:_}),n&&e.jsx(f,{color:"error",children:n}),e.jsx(Hi,{open:p,onClose:N,onSave:async M=>{try{await $.post("/api/products",M),H.success("Product added successfully!"),y(!1),b()}catch{H.error("Failed to add product")}},isEditMode:!1})]})},Pb=({open:t,onClose:r,onSettingsSaved:s})=>{const[a,n]=l.useState({customBackupDir:"",customRestoreDir:""}),[o,i]=l.useState(!1),[c,u]=l.useState(!1),[d,p]=l.useState(null),[y,w]=l.useState(!1);l.useEffect(()=>{t&&O()},[t]);const O=async()=>{i(!0);try{const S=await $.get("/api/backup/settings");n(S.data)}catch(S){console.error("Error fetching backup settings:",S),H.error("Failed to load backup settings")}finally{i(!1)}},_=async()=>{u(!0);try{await $.post("/api/backup/settings",a),H.success("Backup settings saved successfully!"),s(),r()}catch(S){console.error("Error saving backup settings:",S),H.error("Failed to save backup settings")}finally{u(!1)}},E=S=>{const j=S.target.files?.[0];j&&p(j)},b=async()=>{if(!d){H.error("Please select a backup file to upload");return}w(!0);try{const S=new FormData;S.append("backup",d);const j=await $.post("/api/backup/upload",S,{headers:{"Content-Type":"multipart/form-data"}});H.success("Backup uploaded successfully!"),p(null),s(),r()}catch(S){console.error("Error uploading backup:",S),H.error("Failed to upload backup file")}finally{w(!1)}},I=async()=>{try{if(window.api?.browseDirectory){const S=await window.api.browseDirectory({title:"Select Restore Directory"});S.success&&S.directory&&n(j=>({...j,customRestoreDir:S.directory}))}else H.info("Please enter the restore directory path manually")}catch(S){console.error("Error browsing restore directory:",S),H.error("Failed to browse directory")}},U=async()=>{try{if(window.api?.browseDirectory){const S=await window.api.browseDirectory({title:"Select Backup Directory"});S.success&&S.directory&&n(j=>({...j,customBackupDir:S.directory}))}else H.info("In web version, please enter the backup directory path manually. Example: C:\\MyBackups or /home/user/backups")}catch(S){console.error("Error browsing backup directory:",S),H.error("Failed to browse directory")}};return e.jsxs(lt,{open:t,onClose:r,maxWidth:"md",fullWidth:!0,children:[e.jsx(ct,{children:e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Yn,{}),"Backup Settings"]})}),e.jsx(ut,{children:o?e.jsx(q,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(it,{})}):e.jsxs(q,{sx:{mt:2},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Custom Backup Directory"}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Set a custom directory where backups will be stored on the server device. Note: Backups are created on the server, not your local device. The directory must be accessible from the server where the application is running."}),e.jsxs(T,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(T,{item:!0,xs:!0,children:e.jsx(ie,{fullWidth:!0,label:"Backup Directory Path",value:a.customBackupDir,onChange:S=>n(j=>({...j,customBackupDir:S.target.value})),placeholder:"e.g., C:\\MyBackups or /home/user/backups",helperText:a.customBackupDir?`Backups will be stored in: ${a.customBackupDir}`:"Leave empty to use default backup location (backups folder in server directory)"})}),e.jsx(T,{item:!0,children:e.jsx(ar,{title:"Browse for backup directory (Desktop app only)",children:e.jsx(ot,{onClick:U,children:e.jsx(sl,{})})})})]}),!a.customBackupDir&&e.jsxs(Re,{severity:"info",sx:{mt:1},children:[e.jsx(Wo,{children:"Default Backup Location"}),"Backups will be stored in the default location: ",e.jsx("strong",{children:"backups/"})," folder in the server directory. To use a custom location, enter a valid directory path above."]}),a.customBackupDir&&!a.customDirExists&&e.jsxs(Re,{severity:"warning",sx:{mt:1},children:[e.jsx(Wo,{children:"Directory Not Found"}),"The specified backup directory does not exist: ",e.jsx("strong",{children:a.customBackupDir}),"Backups will fall back to the default location until this directory is created."]}),a.currentBackupDir&&e.jsxs(Re,{severity:"success",sx:{mt:1},children:[e.jsx(Wo,{children:"Current Backup Location"}),"Backups are currently being stored in: ",e.jsx("strong",{children:a.currentBackupDir})]}),e.jsx(Sn,{sx:{my:3}}),e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Custom Restore Directory"}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Set a custom directory on the server to look for backup files when restoring. Note: This directory must be accessible from the server."}),e.jsxs(T,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(T,{item:!0,xs:!0,children:e.jsx(ie,{fullWidth:!0,label:"Restore Directory Path",value:a.customRestoreDir,onChange:S=>n(j=>({...j,customRestoreDir:S.target.value})),placeholder:"e.g., C:\\ExternalBackups or /home/user/external-backups",helperText:"Leave empty to use default restore location"})}),e.jsx(T,{item:!0,children:e.jsx(ar,{title:"Browse for restore directory",children:e.jsx(ot,{onClick:I,children:e.jsx(sl,{})})})})]}),e.jsx(Sn,{sx:{my:3}}),e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Upload External Backup"}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Upload a backup file from your device to restore from"}),e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsxs(K,{variant:"outlined",component:"label",startIcon:e.jsx(za,{}),disabled:y,children:["Select Backup File",e.jsx("input",{type:"file",hidden:!0,accept:".zip,.sql,.json",onChange:E})]}),d&&e.jsxs(f,{variant:"body2",children:["Selected: ",d.name]}),d&&e.jsx(K,{variant:"contained",onClick:b,disabled:y,startIcon:y?e.jsx(it,{size:20}):e.jsx(za,{}),children:y?"Uploading...":"Upload & Restore"})]}),e.jsx(Re,{severity:"info",sx:{mt:2},children:e.jsxs(f,{variant:"body2",children:[e.jsx("strong",{children:"Note:"})," Custom directories must be accessible by the application. Make sure the directories exist and have proper read/write permissions."]})})]})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:r,children:"Cancel"}),e.jsx(K,{onClick:_,variant:"contained",disabled:c||o,startIcon:c?e.jsx(it,{size:20}):void 0,children:c?"Saving...":"Save Settings"})]})]})},Eb=()=>{const[t,r]=l.useState([]),[s,a]=l.useState(null),[n,o]=l.useState(!1),[i,c]=l.useState(!1),[u,d]=l.useState(null),[p,y]=l.useState(null),[w,O]=l.useState(null),[_,E]=l.useState(!1),b=async()=>{o(!0);try{const[g,L]=await Promise.all([$.get("/api/backup/list"),$.get("/api/backup/stats")]);r(g.data.backups),a(L.data)}catch(g){console.error("Error fetching backups:",g),H.error("Failed to fetch backups")}finally{o(!1)}};l.useEffect(()=>{b()},[]);const I=async()=>{c(!0);try{const g=await $.post("/api/backup/create");H.success("Backup created successfully!"),b()}catch(g){console.error("Error creating backup:",g),H.error("Failed to create backup")}finally{c(!1)}},U=async g=>{try{const L=await $.get(`/api/backup/download/${g}`,{responseType:"blob"}),z=window.URL.createObjectURL(new Blob([L.data])),ne=document.createElement("a");ne.href=z,ne.setAttribute("download",g),document.body.appendChild(ne),ne.click(),ne.remove(),window.URL.revokeObjectURL(z),H.success("Backup downloaded successfully!")}catch(L){console.error("Error downloading backup:",L),H.error("Failed to download backup")}},S=async g=>{try{await $.delete(`/api/backup/delete/${g}`),H.success("Backup deleted successfully!"),y(null),b()}catch(L){console.error("Error deleting backup:",L),H.error("Failed to delete backup")}},j=async g=>{d(g.manifest);try{const z=(await $.post(`/api/backup/restore/${g.manifest}`)).data.results,ne=Object.values(z).filter(ee=>ee==="success").length,ae=Object.keys(z).length;ne===ae?H.success("Backup restored successfully! Please refresh the page."):H.warning(`Restore completed with ${ne}/${ae} components successful`),O(null),d(null)}catch(L){console.error("Error restoring backup:",L),H.error("Failed to restore backup"),d(null)}},N=g=>{if(g===0)return"0 Bytes";const L=1024,z=["Bytes","KB","MB","GB"],ne=Math.floor(Math.log(g)/Math.log(L));return parseFloat((g/Math.pow(L,ne)).toFixed(2))+" "+z[ne]},k=g=>g.replace(/(\d{4}-\d{2}-\d{2})T(\d{2})-(\d{2})-(\d{2})-(\d{3})Z/,"$1T$2:$3:$4.$5Z"),M=g=>new Date(k(g)).toLocaleString(),v=g=>{const L=g.components,z=Object.keys(L).length;return`${Object.values(L).filter(ae=>ae!==null).length}/${z}`};return e.jsxs(Qe,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(q,{sx:{mb:4},children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:"Backup Management"}),e.jsx(f,{variant:"body1",color:"text.secondary",gutterBottom:!0,children:"Create, manage, and restore backups of your application data"})]}),s&&e.jsxs(T,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsx(f,{color:"text.secondary",gutterBottom:!0,children:"Total Backups"}),e.jsx(f,{variant:"h4",component:"div",children:s.total_backups})]})})}),e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsx(f,{color:"text.secondary",gutterBottom:!0,children:"Total Size"}),e.jsx(f,{variant:"h4",component:"div",children:N(s.total_size)})]})})})]}),e.jsxs(q,{sx:{mb:3,display:"flex",gap:2,flexWrap:"wrap"},children:[e.jsx(K,{variant:"contained",startIcon:i?e.jsx(it,{size:20}):e.jsx(Ei,{}),onClick:I,disabled:i,children:i?"Creating Backup...":"Create Backup"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(Oi,{}),onClick:b,disabled:n,children:"Refresh"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(Yn,{}),onClick:()=>E(!0),children:"Backup Settings"})]}),e.jsx(Re,{severity:"warning",sx:{mb:3},children:e.jsxs(f,{variant:"body2",children:[e.jsx("strong",{children:"Important:"})," Restoring a backup will overwrite your current data. Make sure you have a backup of your current data before proceeding."]})}),e.jsx(qe,{sx:{width:"100%",overflow:"hidden"},children:e.jsx(Kt,{children:e.jsxs(Yt,{children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{children:"Date & Time"}),e.jsx(re,{children:"Components"}),e.jsx(re,{children:"Size"}),e.jsx(re,{children:"System Info"}),e.jsx(re,{align:"center",children:"Actions"})]})}),e.jsx(Gt,{children:n?e.jsx(rt,{children:e.jsx(re,{colSpan:5,align:"center",children:e.jsx(it,{})})}):t.length===0?e.jsx(rt,{children:e.jsx(re,{colSpan:5,align:"center",children:e.jsx(f,{variant:"body2",color:"text.secondary",children:"No backups found. Create your first backup to get started."})})}):t.map(g=>e.jsxs(rt,{hover:!0,children:[e.jsx(re,{children:e.jsx(f,{variant:"body2",children:M(g.timestamp)})}),e.jsxs(re,{children:[e.jsxs(q,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[g.components.database&&e.jsx(Le,{label:"Database",size:"small",color:"primary"}),g.components.uploads&&e.jsx(Le,{label:"Uploads",size:"small",color:"secondary"}),g.components.config&&e.jsx(Le,{label:"Config",size:"small",color:"default"})]}),e.jsxs(f,{variant:"caption",color:"text.secondary",children:[v(g)," components available"]})]}),e.jsx(re,{children:e.jsx(f,{variant:"body2",children:N(g.size)})}),e.jsx(re,{children:e.jsxs(f,{variant:"caption",color:"text.secondary",children:[g.system_info.platform," • ",g.system_info.arch]})}),e.jsx(re,{align:"center",children:e.jsxs(q,{sx:{display:"flex",gap:1,justifyContent:"center"},children:[e.jsx(ar,{title:"Download Backup",children:e.jsx(ot,{size:"small",onClick:()=>U(g.manifest),children:e.jsx(eu,{})})}),e.jsx(ar,{title:"Restore Backup",children:e.jsx(ot,{size:"small",color:"primary",onClick:()=>O(g),children:e.jsx(al,{})})}),e.jsx(ar,{title:"Delete Backup",children:e.jsx(ot,{size:"small",color:"error",onClick:()=>y(g.manifest),children:e.jsx(ao,{})})})]})})]},g.manifest))})]})})}),e.jsxs(lt,{open:!!p,onClose:()=>y(null),children:[e.jsx(ct,{children:"Delete Backup"}),e.jsx(ut,{children:e.jsx(f,{children:"Are you sure you want to delete this backup? This action cannot be undone."})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>y(null),children:"Cancel"}),e.jsx(K,{onClick:()=>p&&S(p),color:"error",variant:"contained",children:"Delete"})]})]}),e.jsxs(lt,{open:!!w,onClose:()=>O(null),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ct,{children:e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ep,{color:"warning"}),"Restore Backup"]})}),e.jsxs(ut,{children:[e.jsx(Re,{severity:"warning",sx:{mb:2},children:e.jsxs(f,{variant:"body2",children:[e.jsx("strong",{children:"Warning:"})," This will overwrite your current data with the backup from"," ",w?M(w.timestamp):"","."]})}),e.jsx(f,{variant:"body2",gutterBottom:!0,children:"Backup components:"}),e.jsxs(q,{sx:{display:"flex",gap:1,mb:2},children:[w?.components.database&&e.jsx(Le,{label:"Database",size:"small",color:"primary"}),w?.components.uploads&&e.jsx(Le,{label:"Uploads",size:"small",color:"secondary"}),w?.components.config&&e.jsx(Le,{label:"Config",size:"small",color:"default"})]}),e.jsx(f,{variant:"body2",color:"text.secondary",children:"Make sure you have a backup of your current data before proceeding."})]}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>O(null),children:"Cancel"}),e.jsx(K,{onClick:()=>w&&j(w),color:"warning",variant:"contained",disabled:u===w?.manifest,startIcon:u===w?.manifest?e.jsx(it,{size:20}):e.jsx(al,{}),children:u===w?.manifest?"Restoring...":"Restore"})]})]}),e.jsx(Pb,{open:_,onClose:()=>E(!1),onSettingsSaved:b})]})},Db=()=>{const{user:t}=Qt(),[r,s]=l.useState([]),[a,n]=l.useState([]),[o,i]=l.useState(""),[c,u]=l.useState(!0),[d,p]=l.useState(null),[y,w]=l.useState(!1),[O,_]=l.useState({name:"",email:""}),[E,b]=l.useState(!1);l.useEffect(()=>{I()},[]),l.useEffect(()=>{o?U():n([])},[o]);const I=async()=>{try{u(!0);const M=await Yi();s(M),p(null)}catch(M){p("Failed to fetch data. Please try again."),console.error("Error fetching data:",M)}finally{u(!1)}},U=async()=>{if(o)try{const M=await hb(o);n(M);const v=new Date;v.setDate(v.getDate()-1);const g=M.find(L=>!L.clock_out&&new Date(L.clock_in).toDateString()!==new Date().toDateString());b(!!g)}catch(M){p("Failed to fetch shifts. Please try again."),console.error("Error fetching shifts:",M)}},S=async()=>{if(!o){p("Please select a profile");return}if(a.some(M=>!M.clock_out)){p("You are already clocked in. Please clock out first.");return}try{const M=await mb(o);n([M,...a]),p(null),i(""),n([])}catch(M){p("Failed to clock in. Please try again."),console.error("Error clocking in:",M)}},j=async M=>{try{const v=await fb(M);n(a.map(g=>g.id===M?v:g)),p(null),i(""),n([])}catch(v){p("Failed to clock out. Please try again."),console.error("Error clocking out:",v)}},N=async()=>{try{const M=await K_(O.name,O.email);s([...r,M]),w(!1),_({name:"",email:""}),p(null)}catch(M){p("Failed to create profile. Please try again."),console.error("Error creating profile:",M)}},k=o&&a.some(M=>M.profile_id===o&&!M.clock_out);return c?e.jsx(q,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(it,{})}):e.jsxs(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsx(f,{variant:"h4",gutterBottom:!0,children:"Attendance (Shift Tracking)"}),d&&e.jsx(Re,{severity:"error",sx:{mb:2},children:d}),E&&e.jsx(Re,{severity:"warning",sx:{mb:2},children:"You have an unclosed shift from a previous day. Please clock out before starting a new shift."}),e.jsxs(T,{container:!0,spacing:3,children:[e.jsx(T,{item:!0,xs:12,md:6,children:e.jsxs(qe,{sx:{p:2},children:[e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsx(f,{variant:"h6",children:"Profile"}),t?.access_role!=="Time Tracking"&&e.jsx(K,{startIcon:e.jsx(Di,{}),onClick:()=>w(!0),children:"Add Profile"})]}),e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Select Profile"}),e.jsx(Ot,{value:o,label:"Select Profile",onChange:M=>i(M.target.value),sx:{"& .MuiSelect-select":{fontSize:"1.1rem"}},renderValue:M=>{const v=r.find(g=>g.id===M);return v?v.name:""},children:r.map(M=>e.jsxs(ze,{value:M.id,sx:{fontSize:"1.1rem",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:M.name}),t?.access_role==="Admin"&&e.jsx(ot,{"aria-label":`Delete ${M.name}`,size:"small",edge:"end",onClick:async v=>{if(v.preventDefault(),v.stopPropagation(),!!window.confirm(`Delete profile "${M.name}"? This cannot be undone.`))try{await $.delete(`/api/time-tracking/profiles/${M.id}`),s(L=>L.filter(z=>z.id!==M.id)),o===M.id&&i(""),H.success("Profile deleted")}catch(L){const z=L?.response?.data?.error||"Failed to delete profile";H.error(z)}},sx:{ml:2,color:"error.main"},children:e.jsx(ao,{fontSize:"small"})})]},M.id))})]})]})}),o&&!k&&e.jsx(T,{item:!0,xs:12,children:e.jsx(qe,{sx:{p:2},children:e.jsx(q,{display:"flex",justifyContent:"center",gap:2,children:e.jsx(K,{variant:"contained",sx:{backgroundColor:"green","&:hover":{backgroundColor:"darkgreen"}},onClick:S,children:"Clock In"})})})}),o&&e.jsx(T,{item:!0,xs:12,children:e.jsxs(qe,{sx:{p:2},children:[e.jsx(q,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:e.jsxs(f,{variant:"h6",gutterBottom:!0,children:["Shift History for ",r.find(M=>M.id===o)?.name]})}),e.jsx(Kt,{children:e.jsxs(Yt,{children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Clock In"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Clock Out"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Duration"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:"Actions"})]})}),e.jsx(Gt,{children:a.map(M=>{const v=new Date(M.clock_in),g=M.clock_out?new Date(M.clock_out):null,L=M.duration!==null&&M.duration!==void 0?Number(M.duration):null;return e.jsxs(rt,{children:[e.jsx(re,{sx:{fontSize:"1.1rem"},children:v.toLocaleString()}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:g?g.toLocaleString():"-"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:L!==null?`${L.toFixed(2)} hrs`:"-"}),e.jsx(re,{sx:{fontSize:"1.1rem"},children:!M.clock_out&&e.jsx(K,{variant:"contained",sx:{backgroundColor:"red","&:hover":{backgroundColor:"darkred"}},onClick:()=>j(M.id),children:"Clock Out"})})]},M.id)})})]})})]})})]}),e.jsxs(lt,{open:y,onClose:()=>w(!1),children:[e.jsx(ct,{children:"Add Profile"}),e.jsxs(ut,{children:[e.jsx(ie,{label:"Name",value:O.name,onChange:M=>_({...O,name:M.target.value}),fullWidth:!0,sx:{mb:2}}),e.jsx(ie,{label:"Email",value:O.email,onChange:M=>_({...O,email:M.target.value}),fullWidth:!0})]}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>w(!1),children:"Cancel"}),e.jsx(K,{onClick:N,variant:"contained",children:"Save"})]})]})]})};var Ws={},Fc;function Tb(){if(Fc)return Ws;Fc=1;var t=At();Object.defineProperty(Ws,"__esModule",{value:!0}),Ws.default=void 0;var r=t(Rt()),s=Mt();return Ws.default=(0,r.default)((0,s.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"}),"ArrowBack"),Ws}var Ob=Tb();const Gi=vt(Ob);var Fs={},$c;function Ib(){if($c)return Fs;$c=1;var t=At();Object.defineProperty(Fs,"__esModule",{value:!0}),Fs.default=void 0;var r=t(Rt()),s=Mt();return Fs.default=(0,r.default)((0,s.jsx)("path",{d:"M4 10h3v7H4zm6.5 0h3v7h-3zM2 19h20v3H2zm15-9h3v7h-3zm-5-9L2 6v2h20V6z"}),"AccountBalance"),Fs}var Ab=Ib();const Ci=vt(Ab),Mb=()=>{const t=qt(),[r,s]=l.useState(!0),[a,n]=l.useState(!1),[o,i]=l.useState([]),[c,u]=l.useState({}),[d,p]=l.useState(null),[y,w]=l.useState(null),[O,_]=l.useState(""),[E,b]=l.useState(""),[I,U]=l.useState(""),[S,j]=l.useState(""),[N,k]=l.useState(""),[M,v]=l.useState(""),[g,L]=l.useState(""),[z,ne]=l.useState(""),[ae,ee]=l.useState(""),[W,Z]=l.useState(""),[J,P]=l.useState(""),[m,A]=l.useState(""),[G,X]=l.useState(!1),[Y,fe]=l.useState(""),[se,ke]=l.useState("");l.useEffect(()=>{ge()},[]);const Pe=()=>{const F=`${Gn().baseURL}/api/qbo/auth`;window.location.href=F},ge=async()=>{s(!0);try{const D=await $.get("/api/qbo-accounts/test-connection");if(w(D.data),D.data.connected){const F=await $.get("/api/qbo-accounts/accounts");i(F.data.accounts),u(F.data.accountTypes);const te=await $.get("/api/qbo-accounts/mapping");te.data.mapping&&(p(te.data.mapping),_(te.data.mapping.qbo_inventory_account_id),b(te.data.mapping.qbo_gst_account_id),U(te.data.mapping.qbo_ap_account_id),j(te.data.mapping.qbo_supply_expense_account_id||""),k(te.data.mapping.qbo_sales_account_id||""),v(te.data.mapping.qbo_labour_sales_account_id||""),L(te.data.mapping.qbo_ar_account_id||""),ne(te.data.mapping.qbo_cogs_account_id||""),ee(te.data.mapping.qbo_cost_of_labour_account_id||""),Z(te.data.mapping.qbo_cost_of_materials_account_id||""),P(te.data.mapping.qbo_labour_expense_reduction_account_id||""),A(te.data.mapping.qbo_overhead_cogs_account_id||""))}}catch(D){console.error("Error loading QBO data:",D),H.error("Failed to load QuickBooks data")}finally{s(!1)}},me=async()=>{if(!O||!E||!I){H.error("Please select all required accounts");return}n(!0);try{const D=await $.post("/api/qbo-accounts/mapping",{qbo_inventory_account_id:O,qbo_gst_account_id:E,qbo_ap_account_id:I,qbo_supply_expense_account_id:S,qbo_sales_account_id:N,qbo_labour_sales_account_id:M,qbo_ar_account_id:g,qbo_cogs_account_id:z,qbo_cost_of_labour_account_id:ae,qbo_cost_of_materials_account_id:W,qbo_labour_expense_reduction_account_id:J,qbo_overhead_cogs_account_id:m});p(D.data.mapping),H.success("Account mapping saved successfully")}catch(D){console.error("Error saving mapping:",D),H.error("Failed to save account mapping")}finally{n(!1)}},be=D=>{const F=D.AccountNumber?`#${D.AccountNumber}`:"";return`${D.Name} ${F} (${D.AccountType})`},je=D=>{let F=o.filter(te=>te.Classification===D);if(se){const te=se.toLowerCase();F=F.filter(B=>B.Name.toLowerCase().includes(te)||B.AccountNumber&&B.AccountNumber.includes(te)||B.Description&&B.Description.toLowerCase().includes(te))}return F},oe=()=>e.jsxs(lt,{open:G,onClose:()=>X(!1),maxWidth:"md",fullWidth:!0,children:[e.jsxs(ct,{children:["QuickBooks Accounts - ",Y]}),e.jsx(ut,{children:e.jsx(q,{sx:{mt:2},children:c[Y]?.map(D=>e.jsx(mt,{sx:{mb:1,p:2},children:e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"flex-start",children:[e.jsxs(q,{children:[e.jsx(f,{variant:"h6",children:D.Name}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Type: ",D.AccountType," | Subtype: ",D.AccountSubType]}),D.AccountNumber&&e.jsxs(f,{variant:"body2",color:"primary",fontWeight:500,children:["Account #: ",D.AccountNumber]}),D.Description&&e.jsx(f,{variant:"body2",color:"text.secondary",children:D.Description})]}),e.jsx(Le,{label:D.AccountNumber||"No Number",size:"small",color:D.AccountNumber?"primary":"default",variant:"outlined"})]})},D.Id))})}),e.jsx(dt,{children:e.jsx(K,{onClick:()=>X(!1),children:"Close"})})]});return r?e.jsx(q,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:e.jsx(it,{})}):e.jsxs(Qe,{maxWidth:"lg",sx:{py:4},children:[e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(q,{display:"flex",alignItems:"center",children:[e.jsx(K,{startIcon:e.jsx(Gi,{}),onClick:()=>t("/business-profile"),sx:{mr:2},children:"Back"}),e.jsx(f,{variant:"h4",component:"h1",children:"QuickBooks Account Mapping"})]}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(Ci,{}),onClick:Pe,sx:{borderRadius:2,fontWeight:600},children:"Connect to QuickBooks"})]}),y&&e.jsx(mt,{sx:{mb:3},children:e.jsxs(wt,{children:[e.jsxs(q,{display:"flex",alignItems:"center",gap:2,children:[y.connected?e.jsx(oa,{color:"success"}):e.jsx(Co,{color:"error"}),e.jsx(f,{variant:"h6",children:y.connected?"Connected to QuickBooks":"Not Connected"})]}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mt:1},children:y.message}),y.connected&&y.realmId&&e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Realm ID: ",y.realmId]})]})}),y?.connected?e.jsxs(e.Fragment,{children:[e.jsx(T,{container:!0,spacing:3,sx:{mb:3},children:Object.entries(c).map(([D,F])=>e.jsx(T,{item:!0,xs:12,sm:6,md:4,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:D}),e.jsx(f,{variant:"h4",color:"primary",children:F.length}),e.jsx(K,{size:"small",onClick:()=>{fe(D),X(!0)},sx:{mt:1},children:"View Accounts"})]})})},D))}),e.jsxs(qe,{sx:{p:3},children:[e.jsx(f,{variant:"h5",gutterBottom:!0,children:"Map QuickBooks Accounts"}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Select the QuickBooks accounts that correspond to your business accounts. Different companies use different account names, so choose the accounts that make sense for your business."}),e.jsxs(Re,{severity:"info",sx:{mb:3},children:[e.jsxs(f,{variant:"body2",children:[e.jsx("strong",{children:"How this works:"})," Configure your QuickBooks accounts to map to your business transactions. Accounts used by both purchase orders and sales orders are shown at the top."]}),e.jsxs(f,{variant:"body2",sx:{mt:1},children:[e.jsx("strong",{children:"Purchase Orders:"})," Stock items → Inventory Account, Supply items → Supply Expense Account, GST → GST Account, Total → Accounts Payable."]}),e.jsxs(f,{variant:"body2",sx:{mt:1},children:[e.jsx("strong",{children:"Sales Orders:"})," Materials → Sales Account, Labour → Labour Sales Account, GST → GST Account, Total → Accounts Receivable, Costs → COGS Account."]})]}),e.jsx(q,{sx:{mb:3},children:e.jsx(ie,{fullWidth:!0,label:"Search accounts by name, number, or description",value:se,onChange:D=>ke(D.target.value),placeholder:"e.g., 1200, Inventory, GST...",size:"small",InputProps:{startAdornment:e.jsx(yr,{sx:{mr:1,color:"text.secondary"}})}})}),e.jsx(f,{variant:"h6",sx:{mt:4,mb:2,color:"primary.main"},children:"Shared Accounts (Purchase Orders & Sales Orders)"}),e.jsxs(T,{container:!0,spacing:3,children:[e.jsxs(T,{item:!0,xs:12,md:6,children:[e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"GST/Tax Account"}),e.jsx(Ot,{value:E,onChange:D=>b(D.target.value),label:"GST/Tax Account",children:je("Liability").map(D=>e.jsx(ze,{value:D.Id,children:be(D)},D.Id))})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:"Account for GST/HST/tax tracking (used by both purchase orders and sales orders)"})]}),e.jsxs(T,{item:!0,xs:12,md:6,children:[e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Inventory Account"}),e.jsx(Ot,{value:O,onChange:D=>_(D.target.value),label:"Inventory Account",children:je("Asset").map(D=>e.jsx(ze,{value:D.Id,children:be(D)},D.Id))})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:"Account for tracking inventory (stock purchases and sales cost reduction)"})]})]}),e.jsx(f,{variant:"h6",sx:{mt:4,mb:2},children:"Purchase Order Account Mapping"}),e.jsxs(T,{container:!0,spacing:3,children:[e.jsxs(T,{item:!0,xs:12,md:6,children:[e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Supply Expense Account"}),e.jsxs(Ot,{value:S,onChange:D=>j(D.target.value),label:"Supply Expense Account",children:[e.jsx(ze,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),je("Expense").map(D=>e.jsx(ze,{value:D.Id,children:be(D)},D.Id))]})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:"Account for supply items (e.g., Office Supplies, Tools, etc.) - Optional"})]}),e.jsxs(T,{item:!0,xs:12,md:6,children:[e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Accounts Payable"}),e.jsx(Ot,{value:I,onChange:D=>U(D.target.value),label:"Accounts Payable",children:je("Liability").map(D=>e.jsx(ze,{value:D.Id,children:be(D)},D.Id))})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:'Account for tracking vendor payables (usually "Accounts Payable")'})]})]}),e.jsx(f,{variant:"h6",sx:{mt:4,mb:2},children:"Sales Order Account Mapping"}),e.jsxs(T,{container:!0,spacing:3,children:[e.jsxs(T,{item:!0,xs:12,md:6,children:[e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Sales Account"}),e.jsx(Ot,{value:N,onChange:D=>k(D.target.value),label:"Sales Account",children:je("Revenue").map(D=>e.jsx(ze,{value:D.Id,children:be(D)},D.Id))})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:"Revenue account for sales (e.g., Sales, Revenue, etc.) - Used for invoice creation"})]}),e.jsxs(T,{item:!0,xs:12,md:6,children:[e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Accounts Receivable"}),e.jsx(Ot,{value:g,onChange:D=>L(D.target.value),label:"Accounts Receivable",children:je("Asset").map(D=>e.jsx(ze,{value:D.Id,children:be(D)},D.Id))})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:'Account for tracking customer receivables (usually "Accounts Receivable") - Used for invoice total amount'})]})]}),e.jsx(f,{variant:"h6",sx:{mt:4,mb:2},children:"Cost Accounts (Journal Entries)"}),e.jsxs(T,{container:!0,spacing:3,children:[e.jsxs(T,{item:!0,xs:12,md:6,children:[e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Cost of Materials"}),e.jsxs(Ot,{value:W,onChange:D=>Z(D.target.value),label:"Cost of Materials",children:[e.jsx(ze,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),je("Expense").map(D=>e.jsx(ze,{value:D.Id,children:be(D)},D.Id))]})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:"Expense account for tracking cost of materials sold - Used for COGS journal entries - Optional"})]}),e.jsxs(T,{item:!0,xs:12,md:6,children:[e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Cost of Labour"}),e.jsxs(Ot,{value:ae,onChange:D=>ee(D.target.value),label:"Cost of Labour",children:[e.jsx(ze,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),je("Expense").map(D=>e.jsx(ze,{value:D.Id,children:be(D)},D.Id))]})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:"Expense account for tracking cost of labour sold - Used for COGS journal entries - Optional"})]}),e.jsxs(T,{item:!0,xs:12,md:6,children:[e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Labour Expense Reduction Account"}),e.jsxs(Ot,{value:J,onChange:D=>P(D.target.value),label:"Labour Expense Reduction Account",children:[e.jsx(ze,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),je("Expense").map(D=>e.jsx(ze,{value:D.Id,children:be(D)},D.Id))]})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:"Expense account for reducing labour costs when sold (e.g., Labour Expense, Wages Expense) - Used for COGS journal entries - Optional"})]}),e.jsxs(T,{item:!0,xs:12,md:6,children:[e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Overhead COGS Account"}),e.jsxs(Ot,{value:m,onChange:D=>A(D.target.value),label:"Overhead COGS Account",children:[e.jsx(ze,{value:"",children:e.jsx("em",{children:"Optional - Select an expense account"})}),je("Expense").map(D=>e.jsx(ze,{value:D.Id,children:be(D)},D.Id))]})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:"Expense account for tracking overhead costs when sold - Used for COGS journal entries - Optional"})]})]}),e.jsx(q,{sx:{mt:3,display:"flex",justifyContent:"center"},children:e.jsx(K,{variant:"outlined",onClick:()=>t("/overhead-management"),sx:{width:"100%",maxWidth:"600px",borderRadius:2,fontWeight:600,py:1.5,fontSize:"1.1rem"},children:"Manage Overhead Settings"})}),e.jsxs(q,{sx:{mt:3,display:"flex",gap:2},children:[e.jsx(K,{variant:"contained",startIcon:e.jsx(ts,{}),onClick:me,disabled:a||!O||!E||!I,children:a?"Saving...":"Save Mapping"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(ta,{}),onClick:ge,disabled:r,children:"Refresh"})]}),d&&e.jsxs(q,{sx:{mt:3,p:2,bgcolor:"grey.50",borderRadius:1},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Current Mapping"}),e.jsx(f,{variant:"subtitle2",color:"primary",sx:{mt:2,mb:1},children:"Shared Accounts (Purchase Orders & Sales Orders)"}),e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:12,md:6,children:e.jsxs(f,{variant:"body2",color:"text.secondary",children:["GST/Tax: ",(()=>{const D=o.find(F=>F.Id===d.qbo_gst_account_id);return D?`${D.Name}${D.AccountNumber?` (#${D.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(T,{item:!0,xs:12,md:6,children:e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Inventory: ",(()=>{const D=o.find(F=>F.Id===d.qbo_inventory_account_id);return D?`${D.Name}${D.AccountNumber?` (#${D.AccountNumber})`:""}`:"Not configured"})()]})})]}),e.jsx(f,{variant:"subtitle2",color:"primary",sx:{mt:2,mb:1},children:"Purchase Order Accounts"}),e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:12,md:6,children:e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Supply Expense: ",(()=>{const D=o.find(F=>F.Id===d.qbo_supply_expense_account_id);return D?`${D.Name}${D.AccountNumber?` (#${D.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(T,{item:!0,xs:12,md:6,children:e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Accounts Payable: ",(()=>{const D=o.find(F=>F.Id===d.qbo_ap_account_id);return D?`${D.Name}${D.AccountNumber?` (#${D.AccountNumber})`:""}`:"Not configured"})()]})})]}),e.jsx(f,{variant:"subtitle2",color:"primary",sx:{mt:2,mb:1},children:"Sales Order Accounts"}),e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:12,md:6,children:e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Sales: ",(()=>{const D=o.find(F=>F.Id===d.qbo_sales_account_id);return D?`${D.Name}${D.AccountNumber?` (#${D.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(T,{item:!0,xs:12,md:6,children:e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Accounts Receivable: ",(()=>{const D=o.find(F=>F.Id===d.qbo_ar_account_id);return D?`${D.Name}${D.AccountNumber?` (#${D.AccountNumber})`:""}`:"Not configured"})()]})})]}),e.jsx(f,{variant:"subtitle2",color:"primary",sx:{mt:2,mb:1},children:"Cost Accounts"}),e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:12,md:6,children:e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Cost of Materials: ",(()=>{const D=o.find(F=>F.Id===d.qbo_cost_of_materials_account_id);return D?`${D.Name}${D.AccountNumber?` (#${D.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(T,{item:!0,xs:12,md:6,children:e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Cost of Labour: ",(()=>{const D=o.find(F=>F.Id===d.qbo_cost_of_labour_account_id);return D?`${D.Name}${D.AccountNumber?` (#${D.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(T,{item:!0,xs:12,md:6,children:e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Labour Expense Reduction: ",(()=>{const D=o.find(F=>F.Id===d.qbo_labour_expense_reduction_account_id);return D?`${D.Name}${D.AccountNumber?` (#${D.AccountNumber})`:""}`:"Not configured"})()]})}),e.jsx(T,{item:!0,xs:12,md:6,children:e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Overhead COGS: ",(()=>{const D=o.find(F=>F.Id===d.qbo_overhead_cogs_account_id);return D?`${D.Name}${D.AccountNumber?` (#${D.AccountNumber})`:""}`:"Not configured"})()]})})]})]})]})]}):e.jsx(Re,{severity:"warning",sx:{mb:3},children:"Please connect your QuickBooks account first in the Business Profile page."}),oe()]})},Rb=()=>{const t=qt(),[r,s]=l.useState(!0),[a,n]=l.useState(!1),[o,i]=l.useState([]),[c,u]=l.useState({}),[d,p]=l.useState([]),[y,w]=l.useState(null),[O,_]=l.useState(!1),[E,b]=l.useState(""),[I,U]=l.useState(""),[S,j]=l.useState(!1),[N,k]=l.useState(null),[M,v]=l.useState({expense_account_id:"",percentage:"",description:""});l.useEffect(()=>{g()},[]);const g=async()=>{s(!0);try{const[P,m]=await Promise.all([$.get("/api/qbo-accounts/accounts"),$.get("/api/overhead/distribution")]);i(P.data.accounts||[]),u(P.data.accountTypes||{}),p(m.data||[]),w({connected:!0,message:"Connected to QuickBooks"})}catch(P){console.error("Error loading data:",P),w({connected:!1,message:P.response?.data?.error||"Failed to connect to QuickBooks"}),H.error("Failed to load overhead management data")}finally{s(!1)}},L=async()=>{if(!M.expense_account_id||!M.percentage){H.error("Please fill in all required fields");return}const P=parseFloat(M.percentage);if(isNaN(P)||P<=0||P>100){H.error("Percentage must be between 0 and 100");return}const m=d.filter(A=>A.id!==N?.id).reduce((A,G)=>A+G.percentage,0);if(m+P>100){H.error(`Total percentage would exceed 100%. Current total: ${m}%, adding: ${P}%`);return}n(!0);try{N?(await $.put(`/api/overhead/distribution/${N.id}`,{expense_account_id:M.expense_account_id,percentage:P,description:M.description}),H.success("Distribution updated successfully")):(await $.post("/api/overhead/distribution",{expense_account_id:M.expense_account_id,percentage:P,description:M.description}),H.success("Distribution added successfully")),j(!1),k(null),v({expense_account_id:"",percentage:"",description:""}),g()}catch(A){console.error("Error saving distribution:",A),H.error(A.response?.data?.error||"Failed to save distribution")}finally{n(!1)}},z=P=>{k(P),v({expense_account_id:P.expense_account_id,percentage:P.percentage.toString(),description:P.description}),j(!0)},ne=async P=>{if(window.confirm("Are you sure you want to delete this distribution?"))try{await $.delete(`/api/overhead/distribution/${P}`),H.success("Distribution deleted successfully"),g()}catch(m){console.error("Error deleting distribution:",m),H.error(m.response?.data?.error||"Failed to delete distribution")}},ae=()=>{k(null),v({expense_account_id:"",percentage:"",description:""}),j(!0)},ee=P=>`${P.Name} (${P.AccountType})`,W=P=>(c[P]||[]).filter(m=>m.Classification===P).map(m=>({label:ee(m),value:m.Id,account:m})),Z=()=>e.jsxs(lt,{open:O,onClose:()=>_(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ct,{children:e.jsxs(q,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(Ci,{}),"QuickBooks Accounts"]})}),e.jsxs(ut,{children:[e.jsx(q,{mb:2,children:e.jsx(ie,{fullWidth:!0,label:"Search accounts",value:I,onChange:P=>U(P.target.value),InputProps:{startAdornment:e.jsx(yr,{})}})}),e.jsxs(Dt,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Tt,{children:"Account Type"}),e.jsxs(Ot,{value:E,onChange:P=>b(P.target.value),label:"Account Type",children:[e.jsx(ze,{value:"",children:"All Types"}),e.jsx(ze,{value:"Asset",children:"Asset"}),e.jsx(ze,{value:"Liability",children:"Liability"}),e.jsx(ze,{value:"Equity",children:"Equity"}),e.jsx(ze,{value:"Revenue",children:"Revenue"}),e.jsx(ze,{value:"Expense",children:"Expense"})]})]}),e.jsx(q,{maxHeight:400,overflow:"auto",children:Object.entries(c).map(([P,m])=>{if(E&&P!==E)return null;const A=m.filter(G=>G.Name.toLowerCase().includes(I.toLowerCase())||G.AccountType.toLowerCase().includes(I.toLowerCase()));return A.length===0?null:e.jsxs(q,{mb:3,children:[e.jsxs(f,{variant:"h6",gutterBottom:!0,children:[P," Accounts (",A.length,")"]}),e.jsx(T,{container:!0,spacing:1,children:A.map(G=>e.jsx(T,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(mt,{variant:"outlined",sx:{p:1},children:[e.jsx(f,{variant:"body2",fontWeight:"bold",children:G.Name}),e.jsx(f,{variant:"caption",color:"textSecondary",children:G.AccountType}),G.AccountNumber&&e.jsxs(f,{variant:"caption",display:"block",color:"textSecondary",children:["#",G.AccountNumber]})]})},G.Id))})]},P)})})]}),e.jsx(dt,{children:e.jsx(K,{onClick:()=>_(!1),children:"Close"})})]}),J=d.reduce((P,m)=>P+m.percentage,0);return e.jsxs(Qe,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(ot,{onClick:()=>t(-1),children:e.jsx(Gi,{})}),e.jsx(f,{variant:"h4",gutterBottom:!0,children:"Overhead Management"})]}),e.jsxs(tt,{direction:"row",spacing:2,children:[e.jsx(K,{variant:"outlined",onClick:()=>_(!0),startIcon:e.jsx(Ci,{}),children:"View QBO Accounts"}),e.jsx(K,{variant:"contained",onClick:ae,startIcon:e.jsx(vr,{}),children:"Add Distribution"}),e.jsx(K,{variant:"outlined",onClick:g,startIcon:e.jsx(ta,{}),children:"Refresh"})]})]}),y&&e.jsx(Re,{severity:y.connected?"success":"error",icon:y.connected?e.jsx(oa,{}):e.jsx(Co,{}),sx:{mb:3},children:y.message}),e.jsxs(qe,{sx:{p:3,mb:3},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Distribution Summary"}),e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsx(f,{color:"textSecondary",gutterBottom:!0,children:"Total Distributions"}),e.jsx(f,{variant:"h4",children:d.length})]})})}),e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsx(f,{color:"textSecondary",gutterBottom:!0,children:"Total Percentage"}),e.jsxs(f,{variant:"h4",color:J===100?"success.main":"warning.main",children:[J.toFixed(1),"%"]})]})})}),e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsx(f,{color:"textSecondary",gutterBottom:!0,children:"Remaining"}),e.jsxs(f,{variant:"h4",color:J>100?"error.main":"text.primary",children:[(100-J).toFixed(1),"%"]})]})})}),e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsx(f,{color:"textSecondary",gutterBottom:!0,children:"Status"}),e.jsx(Le,{label:J===100?"Complete":J>100?"Over 100%":"Incomplete",color:J===100?"success":J>100?"error":"warning"})]})})})]})]}),e.jsx(qe,{sx:{width:"100%",overflow:"hidden"},children:e.jsxs(q,{sx:{p:2},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Expense Distributions"}),r?e.jsx(q,{display:"flex",justifyContent:"center",p:3,children:e.jsx(it,{})}):d.length===0?e.jsx(Re,{severity:"info",children:'No expense distributions configured. Click "Add Distribution" to get started.'}):e.jsx(T,{container:!0,spacing:2,children:d.map(P=>{const m=o.find(A=>A.Id===P.expense_account_id);return e.jsx(T,{item:!0,xs:12,sm:6,md:4,children:e.jsx(mt,{children:e.jsx(wt,{children:e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"flex-start",children:[e.jsxs(q,{flex:1,children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:P.description||m?.Name||"Unknown Account"}),e.jsxs(f,{variant:"body2",color:"textSecondary",gutterBottom:!0,children:[m?.Name," (",m?.AccountType,")"]}),e.jsx(Le,{label:`${P.percentage}%`,color:"primary",size:"small"})]}),e.jsxs(q,{children:[e.jsx(ot,{size:"small",onClick:()=>z(P),children:e.jsx(Qa,{})}),e.jsx(ot,{size:"small",color:"error",onClick:()=>ne(P.id),children:e.jsx(tr,{})})]})]})})})},P.id)})})]})}),e.jsxs(lt,{open:S,onClose:()=>j(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ct,{children:N?"Edit Distribution":"Add Distribution"}),e.jsx(ut,{children:e.jsxs(tt,{spacing:3,sx:{mt:1},children:[e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Expense Account"}),e.jsx(Ot,{value:M.expense_account_id,onChange:P=>v(m=>({...m,expense_account_id:P.target.value})),label:"Expense Account",children:W("Expense").map(P=>e.jsx(ze,{value:P.value,children:P.label},P.value))})]}),e.jsx(ie,{label:"Percentage",type:"number",value:M.percentage,onChange:P=>v(m=>({...m,percentage:P.target.value})),inputProps:{min:0,max:100,step:.01},helperText:`Current total: ${J}%${N?` (excluding this item: ${(J-N.percentage).toFixed(1)}%)`:""}`}),e.jsx(ie,{label:"Description (Optional)",value:M.description,onChange:P=>v(m=>({...m,description:P.target.value})),helperText:"A description to help identify this distribution"})]})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>j(!1),children:"Cancel"}),e.jsx(K,{onClick:L,variant:"contained",disabled:a||!M.expense_account_id||!M.percentage,startIcon:a?e.jsx(it,{size:20}):e.jsx(ts,{}),children:a?"Saving...":"Save"})]})]}),Z()]})},Nb=()=>{const[t,r]=l.useState(!1),[s,a]=l.useState(!1),[n,o]=l.useState([]),[i,c]=l.useState(new Set),[u,d]=l.useState(new Set),[p,y]=l.useState(!1),[w,O]=l.useState([]),_=qt();l.useEffect(()=>{E();const g=()=>{console.log("🔄 Parts to order update event received, refreshing data..."),E()};return window.addEventListener("parts-to-order-updated",g),()=>{window.removeEventListener("parts-to-order-updated",g)}},[]);const E=async()=>{r(!0);try{const g=await $.get("/api/sales-orders/parts-to-order/all"),{individualParts:L,aggregatedParts:z}=g.data;if(z&&z.length>0)o(z);else{const ne=b(L);o(ne)}}catch(g){console.error("Error fetching parts to order:",g),H.error("Failed to load parts to order data")}finally{r(!1)}},b=g=>{const L={};return g.forEach(z=>{L[z.part_number]||(L[z.part_number]={part_number:z.part_number,part_description:z.part_description,total_quantity_needed:0,unit:z.unit,unit_price:z.unit_price,total_line_amount:0,sales_orders:[]}),L[z.part_number].total_quantity_needed+=z.quantity_needed,L[z.part_number].total_line_amount+=z.line_amount,L[z.part_number].sales_orders.push(z)}),Object.values(L)},I=g=>{const L=new Set(i);L.has(g)?L.delete(g):L.add(g),c(L)},U=()=>{E()},S=g=>{d(L=>{const z=new Set(L);return z.has(g)?z.delete(g):z.add(g),z})},j=()=>{u.size===n.length?d(new Set):d(new Set(n.map(g=>g.part_number)))},N=()=>{if(u.size===0){H.warning("Please select at least one part to create a purchase order");return}const g=n.filter(L=>u.has(L.part_number));O(g),y(!0)},k=()=>{y(!1),O([])},M=async()=>{if(w.length===0){H.warning("No parts selected for purchase order");return}a(!0);try{const g=await $.post("/api/purchase-orders/auto-create-from-parts-to-order",{parts:w});if(g.data.success)if(H.success(`Purchase order created successfully! PO Number: ${g.data.purchase_order_number}`),g.data.purchase_orders&&g.data.purchase_orders.length===1){const L=g.data.purchase_orders[0].purchase_id;k(),d(new Set),_(`/open-purchase-orders/${L}`)}else k(),d(new Set),E();else H.error(g.data.message||"Failed to create purchase order")}catch(g){console.error("Error creating purchase order:",g),H.error(g.response?.data?.error||"Failed to create purchase order")}finally{a(!1)}},v=async g=>{let L=n;if(g){const z=n.find(ne=>ne.part_number===g);if(!z){H.warning(`Part ${g} not found for purchase order creation.`);return}L=[z]}if(L.length===0){H.warning("No parts to order");return}a(!0);try{const z=await $.post("/api/purchase-orders/auto-create-from-parts-to-order",{parts:L});if(z.data.success)if(H.success(`Purchase order created successfully! PO Number: ${z.data.purchase_order_number}`),z.data.purchase_orders&&z.data.purchase_orders.length===1){const ne=z.data.purchase_orders[0].purchase_id;_(`/open-purchase-orders/${ne}`)}else E();else H.error(z.data.message||"Failed to create purchase order")}catch(z){console.error("Error creating purchase order:",z),H.error(z.response?.data?.error||"Failed to create purchase order")}finally{a(!1)}};return t?e.jsx(q,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(it,{})}):e.jsxs(q,{p:3,children:[e.jsxs(q,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsx(f,{variant:"h3",component:"h1",children:"Parts to Order"}),e.jsxs(q,{display:"flex",gap:2,children:[u.size>0&&e.jsxs(K,{variant:"contained",color:"primary",startIcon:e.jsx(tp,{}),onClick:N,disabled:s,children:["Create PO (",u.size,")"]}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(Oi,{}),onClick:U,children:"Refresh"})]})]}),n.length===0?e.jsx(Re,{severity:"info",children:"No parts currently need to be ordered."}):e.jsx(Kt,{component:qe,children:e.jsxs(Yt,{size:"medium",children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{padding:"checkbox",children:e.jsx(Ba,{indeterminate:u.size>0&&u.size<n.length,checked:n.length>0&&u.size===n.length,onChange:j})}),e.jsx(re,{children:e.jsx(f,{variant:"h6",fontWeight:"bold"})}),e.jsx(re,{children:e.jsx(f,{variant:"h6",fontWeight:"bold",children:"Part Number"})}),e.jsx(re,{children:e.jsx(f,{variant:"h6",fontWeight:"bold",children:"Description"})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"h6",fontWeight:"bold",children:"Quantity to Order"})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"h6",fontWeight:"bold",children:"Unit"})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"h6",fontWeight:"bold",children:"Unit Price"})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"h6",fontWeight:"bold",children:"Total Amount"})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"h6",fontWeight:"bold",children:"Actions"})})]})}),e.jsx(Gt,{children:n.map(g=>e.jsxs(ft.Fragment,{children:[e.jsxs(rt,{children:[e.jsx(re,{padding:"checkbox",children:e.jsx(Ba,{checked:u.has(g.part_number),onChange:()=>S(g.part_number)})}),e.jsx(re,{children:e.jsx(ot,{size:"small",onClick:()=>I(g.part_number),children:i.has(g.part_number)?e.jsx(rp,{}):e.jsx(su,{})})}),e.jsx(re,{children:e.jsx(f,{variant:"body1",fontWeight:"medium",fontSize:"1.1rem",children:g.part_number})}),e.jsx(re,{children:e.jsx(f,{variant:"body1",fontSize:"1.1rem",children:g.part_description})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"body1",fontWeight:"medium",fontSize:"1.1rem",children:Number(g.total_quantity_needed)||0})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"body1",fontSize:"1.1rem",children:g.unit})}),e.jsx(re,{align:"center",children:e.jsxs(f,{variant:"body1",fontSize:"1.1rem",children:["$",(Number(g.unit_price)||0).toFixed(2)]})}),e.jsx(re,{align:"center",children:e.jsxs(f,{variant:"body1",fontSize:"1.1rem",children:["$",(Number(g.total_line_amount)||0).toFixed(2)]})}),e.jsx(re,{align:"center",children:e.jsx(K,{variant:"contained",color:"primary",size:"medium",startIcon:e.jsx(ol,{}),onClick:()=>v(g.part_number),disabled:s,children:"Create PO"})})]}),e.jsx(rt,{children:e.jsx(re,{style:{paddingBottom:0,paddingTop:0},colSpan:9,children:e.jsx(tu,{in:i.has(g.part_number),timeout:"auto",unmountOnExit:!0,children:e.jsxs(q,{sx:{margin:1},children:[e.jsx(f,{variant:"h5",gutterBottom:!0,component:"div",children:"Sales Orders Requiring This Part"}),e.jsxs(Yt,{size:"medium",children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{children:e.jsx(f,{variant:"subtitle1",fontWeight:"bold",children:"Sales Order"})}),e.jsx(re,{children:e.jsx(f,{variant:"subtitle1",fontWeight:"bold",children:"Customer"})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"subtitle1",fontWeight:"bold",children:"Quantity to Order"})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"subtitle1",fontWeight:"bold",children:"Unit Price"})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"subtitle1",fontWeight:"bold",children:"Line Amount"})})]})}),e.jsx(Gt,{children:g.sales_orders.map(L=>e.jsxs(rt,{children:[e.jsx(re,{children:e.jsx(f,{variant:"body1",fontSize:"1rem",children:L.sales_order_number})}),e.jsx(re,{children:e.jsx(f,{variant:"body1",fontSize:"1rem",children:L.customer_name})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"body1",fontSize:"1rem",children:Number(L.quantity_needed)||0})}),e.jsx(re,{align:"center",children:e.jsxs(f,{variant:"body1",fontSize:"1rem",children:["$",(Number(L.unit_price)||0).toFixed(2)]})}),e.jsx(re,{align:"center",children:e.jsxs(f,{variant:"body1",fontSize:"1rem",children:["$",(Number(L.line_amount)||0).toFixed(2)]})})]},`${L.sales_order_id}-${L.part_number}`))})]})]})})})})]},g.part_number))})]})}),e.jsxs(lt,{open:p,onClose:k,maxWidth:"md",fullWidth:!0,children:[e.jsx(ct,{children:"Create Purchase Order"}),e.jsxs(ut,{children:[e.jsx(f,{variant:"body1",sx:{mb:2},children:"Selected parts for purchase order:"}),e.jsx(Kt,{component:qe,variant:"outlined",children:e.jsxs(Yt,{size:"small",children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{children:"Part Number"}),e.jsx(re,{children:"Description"}),e.jsx(re,{align:"center",children:"Quantity"}),e.jsx(re,{align:"center",children:"Unit"}),e.jsx(re,{align:"center",children:"Unit Price"}),e.jsx(re,{align:"center",children:"Total"})]})}),e.jsx(Gt,{children:w.map(g=>e.jsxs(rt,{children:[e.jsx(re,{children:e.jsx(f,{variant:"body2",fontWeight:"medium",children:g.part_number})}),e.jsx(re,{children:e.jsx(f,{variant:"body2",children:g.part_description})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"body2",children:Number(g.total_quantity_needed)||0})}),e.jsx(re,{align:"center",children:e.jsx(f,{variant:"body2",children:g.unit})}),e.jsx(re,{align:"center",children:e.jsxs(f,{variant:"body2",children:["$",(Number(g.unit_price)||0).toFixed(2)]})}),e.jsx(re,{align:"center",children:e.jsxs(f,{variant:"body2",fontWeight:"medium",children:["$",(Number(g.total_line_amount)||0).toFixed(2)]})})]},g.part_number))})]})}),e.jsx(q,{sx:{mt:2,p:2,backgroundColor:"grey.50",borderRadius:1},children:e.jsxs(f,{variant:"h6",align:"right",children:["Total Amount: $",w.reduce((g,L)=>g+(Number(L.total_line_amount)||0),0).toFixed(2)]})})]}),e.jsxs(dt,{children:[e.jsx(K,{onClick:k,disabled:s,children:"Cancel"}),e.jsx(K,{onClick:M,variant:"contained",color:"primary",disabled:s,startIcon:s?e.jsx(it,{size:20}):e.jsx(ol,{}),children:s?"Creating...":"Create Purchase Order"})]})]})]})},Lb=()=>{const t=qt(),[r,s]=l.useState(!0),[a,n]=l.useState(!1),[o,i]=l.useState([]),[c,u]=l.useState([]),[d,p]=l.useState([]),[y,w]=l.useState(!1),[O,_]=l.useState(""),[E,b]=l.useState("");l.useEffect(()=>{I()},[]);const I=async()=>{s(!0);try{const[k,M,v]=await Promise.all([$.get("/api/time-tracking/admin/available-users"),$.get("/api/time-tracking/profiles"),$.get("/api/time-tracking/admin/user-profile-access")]);i(k.data||[]),u(M.data||[]),p(v.data||[])}catch(k){console.error("Error loading data:",k),H.error("Failed to load mobile user access data")}finally{s(!1)}},U=async()=>{if(!O||!E){H.error("Please select both a user and a profile");return}n(!0);try{await $.post("/api/time-tracking/admin/user-profile-access",{user_id:O,profile_id:E}),H.success("Profile access granted successfully"),w(!1),_(""),b(""),I()}catch(k){console.error("Error granting access:",k),H.error(k.response?.data?.error||"Failed to grant access")}finally{n(!1)}},S=async k=>{if(window.confirm("Are you sure you want to revoke this profile access?"))try{await $.delete(`/api/time-tracking/admin/user-profile-access/${k}`),H.success("Profile access revoked successfully"),I()}catch(M){console.error("Error revoking access:",M),H.error(M.response?.data?.error||"Failed to revoke access")}},j=d.filter(k=>k.is_active),N=d.filter(k=>!k.is_active);return e.jsxs(Qe,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(q,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(ot,{onClick:()=>t(-1),children:e.jsx(Gi,{})}),e.jsx(f,{variant:"h4",gutterBottom:!0,children:"Mobile User Access Management"})]}),e.jsxs(tt,{direction:"row",spacing:2,children:[e.jsx(K,{variant:"contained",onClick:()=>w(!0),startIcon:e.jsx(vr,{}),children:"Grant Access"}),e.jsx(K,{variant:"outlined",onClick:I,startIcon:e.jsx(ta,{}),children:"Refresh"})]})]}),e.jsxs(T,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsx(f,{color:"textSecondary",gutterBottom:!0,children:"Mobile Users"}),e.jsx(f,{variant:"h4",children:o.length})]})})}),e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsx(f,{color:"textSecondary",gutterBottom:!0,children:"Available Profiles"}),e.jsx(f,{variant:"h4",children:c.length})]})})}),e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsx(f,{color:"textSecondary",gutterBottom:!0,children:"Active Access"}),e.jsx(f,{variant:"h4",color:"success.main",children:j.length})]})})}),e.jsx(T,{item:!0,xs:12,sm:6,md:3,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsx(f,{color:"textSecondary",gutterBottom:!0,children:"Revoked Access"}),e.jsx(f,{variant:"h4",color:"text.secondary",children:N.length})]})})})]}),r?e.jsx(q,{display:"flex",justifyContent:"center",p:3,children:e.jsx(it,{})}):e.jsxs(e.Fragment,{children:[e.jsx(qe,{sx:{width:"100%",overflow:"hidden",mb:3},children:e.jsxs(q,{sx:{p:2},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Active Profile Access"}),j.length===0?e.jsx(Re,{severity:"info",children:'No active profile access assignments. Click "Grant Access" to get started.'}):e.jsx(Kt,{children:e.jsxs(Yt,{children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{children:"Mobile User"}),e.jsx(re,{children:"Profile"}),e.jsx(re,{children:"Granted By"}),e.jsx(re,{children:"Granted At"}),e.jsx(re,{children:"Actions"})]})}),e.jsx(Gt,{children:j.map(k=>e.jsxs(rt,{children:[e.jsx(re,{children:e.jsxs(q,{children:[e.jsx(f,{variant:"body2",fontWeight:"bold",children:k.user_email}),e.jsx(Le,{label:k.user_role,size:"small",color:"primary",variant:"outlined"})]})}),e.jsx(re,{children:e.jsxs(q,{children:[e.jsx(f,{variant:"body2",fontWeight:"bold",children:k.profile_name}),e.jsx(f,{variant:"caption",color:"textSecondary",children:k.profile_email})]})}),e.jsx(re,{children:e.jsx(f,{variant:"body2",children:k.granted_by_email||"System"})}),e.jsx(re,{children:e.jsx(f,{variant:"body2",children:new Date(k.granted_at).toLocaleDateString()})}),e.jsx(re,{children:e.jsx(ot,{color:"error",onClick:()=>S(k.id),title:"Revoke Access",children:e.jsx(tr,{})})})]},k.id))})]})})]})}),N.length>0&&e.jsx(qe,{sx:{width:"100%",overflow:"hidden"},children:e.jsxs(q,{sx:{p:2},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Revoked Profile Access"}),e.jsx(Kt,{children:e.jsxs(Yt,{children:[e.jsx(Vt,{children:e.jsxs(rt,{children:[e.jsx(re,{children:"Mobile User"}),e.jsx(re,{children:"Profile"}),e.jsx(re,{children:"Revoked At"})]})}),e.jsx(Gt,{children:N.map(k=>e.jsxs(rt,{children:[e.jsx(re,{children:e.jsxs(q,{children:[e.jsx(f,{variant:"body2",fontWeight:"bold",children:k.user_email}),e.jsx(Le,{label:k.user_role,size:"small",color:"default",variant:"outlined"})]})}),e.jsx(re,{children:e.jsxs(q,{children:[e.jsx(f,{variant:"body2",fontWeight:"bold",children:k.profile_name}),e.jsx(f,{variant:"caption",color:"textSecondary",children:k.profile_email})]})}),e.jsx(re,{children:e.jsx(f,{variant:"body2",children:new Date(k.updated_at).toLocaleDateString()})})]},k.id))})]})})]})})]}),e.jsxs(lt,{open:y,onClose:()=>w(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ct,{children:e.jsxs(q,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(vr,{}),"Grant Profile Access"]})}),e.jsx(ut,{children:e.jsxs(tt,{spacing:3,sx:{mt:1},children:[e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Mobile User"}),e.jsx(Ot,{value:O,onChange:k=>_(Number(k.target.value)),label:"Mobile User",children:o.map(k=>e.jsx(ze,{value:k.id,children:e.jsxs(q,{children:[e.jsx(f,{variant:"body2",fontWeight:"bold",children:k.email}),e.jsx(f,{variant:"caption",color:"textSecondary",children:k.access_role})]})},k.id))})]}),e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Profile"}),e.jsx(Ot,{value:E,onChange:k=>b(Number(k.target.value)),label:"Profile",children:c.map(k=>e.jsx(ze,{value:k.id,children:e.jsxs(q,{children:[e.jsx(f,{variant:"body2",fontWeight:"bold",children:k.name}),e.jsx(f,{variant:"caption",color:"textSecondary",children:k.email})]})},k.id))})]})]})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:()=>w(!1),children:"Cancel"}),e.jsx(K,{onClick:U,variant:"contained",disabled:a||!O||!E,startIcon:a?e.jsx(it,{size:20}):e.jsx(oa,{}),children:a?"Granting...":"Grant Access"})]})]})]})};var $s={},Bc;function qb(){if(Bc)return $s;Bc=1;var t=At();Object.defineProperty($s,"__esModule",{value:!0}),$s.default=void 0;var r=t(Rt()),s=Mt();return $s.default=(0,r.default)((0,s.jsx)("path",{d:"M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5c-.49 0-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20zm-6 8h-4v-2h4zm0-4h-4v-2h4z"}),"BugReport"),$s}var Ub=qb();const Wb=vt(Ub);var Bs={},zc;function Fb(){if(zc)return Bs;zc=1;var t=At();Object.defineProperty(Bs,"__esModule",{value:!0}),Bs.default=void 0;var r=t(Rt()),s=Mt();return Bs.default=(0,r.default)((0,s.jsx)("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8zm2 16H8v-2h8zm0-4H8v-2h8zm-3-5V3.5L18.5 9z"}),"Description"),Bs}var $b=Fb();const Bb=vt($b),Hc=[{value:"gmail",label:"Gmail",host:"smtp.gmail.com",port:587,secure:!1},{value:"outlook",label:"Outlook/Hotmail",host:"smtp-mail.outlook.com",port:587,secure:!1},{value:"yahoo",label:"Yahoo",host:"smtp.mail.yahoo.com",port:587,secure:!1},{value:"icloud",label:"iCloud",host:"smtp.mail.me.com",port:587,secure:!1},{value:"titan",label:"Titan Email",host:"smtp.titan.email",port:465,secure:!0},{value:"custom",label:"Custom SMTP",host:"",port:587,secure:!1}],zb=()=>{const t=qt(),[r,s]=l.useState({email_provider:"gmail",email_host:"smtp.gmail.com",email_port:587,email_secure:!1,email_user:"",email_from:""}),[a,n]=l.useState(""),[o,i]=l.useState(!1),[c,u]=l.useState(!1),[d,p]=l.useState(!1),[y,w]=l.useState("unknown");l.useEffect(()=>{O()},[]);const O=async()=>{try{const j=await $.get("/api/email/user-settings");if(j.data.success&&j.data.settings){const N=j.data.settings;s({email_provider:N.email_provider,email_host:N.email_host,email_port:N.email_port,email_secure:N.email_secure,email_user:N.email_user,email_from:N.email_from||N.email_user}),p(!0)}}catch(j){console.error("Error loading user email settings:",j)}},_=async()=>{if(!r.email_host||!r.email_port||!r.email_user){H.error("Please fill in all required fields");return}d&&!a&&H.info("Password field is empty - keeping existing password"),i(!0);try{const j={...r,...a&&{email_pass:a}},N=await $.post("/api/email/user-settings",j);N.data.success?(H.success("Email settings saved successfully!"),p(!0),n(""),w("unknown")):H.error(N.data.message||"Failed to save email settings")}catch(j){console.error("Error saving email settings:",j),H.error(j.response?.data?.message||"Failed to save email settings")}finally{i(!1)}},E=async()=>{if(!d){H.error("Please save your email settings first");return}u(!0);try{const j=await $.post("/api/email/test-user-connection");j.data.success?(w("connected"),H.success("Email connection test successful!")):(w("failed"),H.error(j.data.message||"Email connection test failed"))}catch(j){console.error("Error testing email connection:",j),w("failed"),H.error(j.response?.data?.message||"Email connection test failed")}finally{u(!1)}},b=j=>{const N=Hc.find(k=>k.value===j);N&&s(k=>({...k,email_provider:j,email_host:N.host,email_port:N.port,email_secure:N.secure}))},I=(j,N)=>{s(k=>({...k,[j]:N}))},U=()=>{switch(y){case"connected":return"success";case"failed":return"error";default:return"info"}},S=()=>{switch(y){case"connected":return"Connected";case"failed":return"Connection Failed";default:return"Not Tested"}};return e.jsxs(Qe,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(q,{sx:{display:"flex",alignItems:"center",mb:3},children:[e.jsx(zi,{sx:{mr:2,fontSize:32}}),e.jsx(f,{variant:"h4",component:"h1",children:"My Email Settings"})]}),e.jsx(Re,{severity:"info",sx:{mb:3},children:"Configure your personal email settings to send emails from your own email account. These settings are private to your account and will be used when you send emails from the system."}),e.jsxs(Re,{severity:"warning",sx:{mb:3},children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:e.jsx("strong",{children:"Important for Gmail users:"})}),e.jsxs(f,{variant:"body2",children:[`If you're using Gmail with 2-Factor Authentication, you need to use an "App Password" instead of your regular password.`,e.jsx("br",{}),"• Go to ",e.jsx("a",{href:"https://myaccount.google.com/apppasswords",target:"_blank",rel:"noopener noreferrer",children:"Google App Passwords"}),e.jsx("br",{}),'• Generate an app password for "Mail"',e.jsx("br",{}),'• Use that 16-character password in the "App Password" field below']})]}),e.jsxs(T,{container:!0,spacing:3,children:[e.jsx(T,{item:!0,xs:12,md:8,children:e.jsxs(mt,{children:[e.jsxs(wt,{children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Email Configuration"}),e.jsxs(T,{container:!0,spacing:2,children:[e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{select:!0,label:"Email Provider",value:r.email_provider,onChange:j=>b(j.target.value),fullWidth:!0,helperText:"Select your email provider or choose Custom for other SMTP servers",children:Hc.map(j=>e.jsx(ze,{value:j.value,children:j.label},j.value))})}),e.jsx(T,{item:!0,xs:12,sm:8,children:e.jsx(ie,{label:"SMTP Host",value:r.email_host,onChange:j=>I("email_host",j.target.value),fullWidth:!0,required:!0,disabled:r.email_provider!=="custom"})}),e.jsx(T,{item:!0,xs:12,sm:4,children:e.jsx(ie,{label:"SMTP Port",type:"number",value:r.email_port,onChange:j=>I("email_port",parseInt(j.target.value)),fullWidth:!0,required:!0,disabled:r.email_provider!=="custom"})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ra,{control:e.jsx(Ti,{checked:r.email_secure,onChange:j=>I("email_secure",j.target.checked),disabled:r.email_provider!=="custom"}),label:"Use SSL/TLS (usually for port 465)"})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"Email Address",type:"email",value:r.email_user,onChange:j=>I("email_user",j.target.value),fullWidth:!0,required:!0,helperText:"Your email address for authentication"})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:d?"Update App Password":"App Password",type:"password",value:a,onChange:j=>n(j.target.value),fullWidth:!0,required:!d,helperText:d?"Leave blank to keep current password, or enter new password to update":"Your email password or app password (for Gmail with 2FA)"})}),e.jsx(T,{item:!0,xs:12,children:e.jsx(ie,{label:"From Name (Optional)",value:r.email_from,onChange:j=>I("email_from",j.target.value),fullWidth:!0,helperText:"Display name for outgoing emails (defaults to email address)"})})]})]}),e.jsx(il,{children:e.jsx(K,{variant:"contained",startIcon:o?e.jsx(it,{size:20}):e.jsx(ts,{}),onClick:_,disabled:o,children:o?"Saving...":"Save Settings"})})]})}),e.jsxs(T,{item:!0,xs:12,md:4,children:[e.jsxs(mt,{children:[e.jsxs(wt,{children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Connection Status"}),e.jsx(Re,{severity:U(),sx:{mb:2},children:S()}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Test your email configuration to ensure it works correctly."})]}),e.jsx(il,{children:e.jsx(K,{variant:"outlined",startIcon:c?e.jsx(it,{size:20}):e.jsx(Wb,{}),onClick:E,disabled:c||!d,fullWidth:!0,children:c?"Testing...":"Test Connection"})})]}),e.jsx(mt,{sx:{mt:2},children:e.jsxs(wt,{children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Setup Instructions"}),e.jsxs(f,{variant:"body2",sx:{mb:1},children:[e.jsx("strong",{children:"Gmail:"})," Use an App Password instead of your regular password."]}),e.jsxs(f,{variant:"body2",sx:{mb:1},children:[e.jsx("strong",{children:"Outlook:"})," Use an App Password for enhanced security."]}),e.jsxs(f,{variant:"body2",children:[e.jsx("strong",{children:"Other providers:"})," Check your email provider's SMTP settings."]})]})}),e.jsx(mt,{sx:{mt:2,border:"2px solid red"},children:e.jsxs(wt,{children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Quick Actions"}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Manage your email templates and customize email content for different types of communications."}),e.jsx(K,{fullWidth:!0,variant:"outlined",onClick:()=>t("/email-templates"),startIcon:e.jsx(Bb,{}),sx:{mb:1},color:"primary",children:"Manage Email Templates"})]})})]})]})]})},Hb=()=>{const{user:t}=Qt(),[r,s]=l.useState([]),[a,n]=l.useState(!0),[o,i]=l.useState(!1),[c,u]=l.useState(null),[d,p]=l.useState({name:"",type:"purchase_order",subject:"",html_content:"",text_content:"",is_default:!1}),[y,w]=l.useState(""),[O,_]=l.useState("");l.useEffect(()=>{E()},[]);const E=async()=>{try{n(!0);const k=await $.get("/api/email/templates");k.data.success&&s(k.data.templates)}catch(k){console.error("Error loading templates:",k),w("Failed to load email templates")}finally{n(!1)}},b=k=>{k?(u(k),p({name:k.name,type:k.type,subject:k.subject,html_content:k.html_content,text_content:k.text_content||"",is_default:k.is_default})):(u(null),p({name:"",type:"purchase_order",subject:"",html_content:"",text_content:"",is_default:!1})),i(!0)},I=()=>{i(!1),u(null),p({name:"",type:"purchase_order",subject:"",html_content:"",text_content:"",is_default:!1})},U=async()=>{try{c?(await $.put(`/api/email/templates/${c.id}`,d),_("Email template updated successfully")):(await $.post("/api/email/templates",d),_("Email template created successfully")),I(),E()}catch(k){console.error("Error saving template:",k),w(k.response?.data?.message||"Failed to save template")}},S=async k=>{if(window.confirm("Are you sure you want to delete this template?"))try{await $.delete(`/api/email/templates/${k}`),_("Email template deleted successfully"),E()}catch(M){console.error("Error deleting template:",M),w(M.response?.data?.message||"Failed to delete template")}},j=k=>{switch(k){case"purchase_order":return"primary";case"sales_order":return"success";case"quote":return"warning";case"custom":return"info";default:return"default"}},N=k=>{switch(k){case"purchase_order":return"Purchase Order";case"sales_order":return"Sales Order";case"quote":return"Quote";case"custom":return"Custom";default:return k}};return a?e.jsx(Qe,{maxWidth:"lg",children:e.jsx(f,{variant:"h4",gutterBottom:!0,children:"Loading..."})}):e.jsxs(Qe,{maxWidth:"lg",children:[e.jsxs(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(f,{variant:"h4",gutterBottom:!0,children:"Email Templates"}),e.jsx(K,{variant:"contained",startIcon:e.jsx(Di,{}),onClick:()=>b(),children:"Create Template"})]}),e.jsx(T,{container:!0,spacing:3,children:r.map(k=>e.jsx(T,{item:!0,xs:12,md:6,lg:4,children:e.jsx(mt,{children:e.jsxs(wt,{children:[e.jsxs(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:[e.jsx(f,{variant:"h6",component:"div",children:k.name}),e.jsxs(q,{children:[e.jsx(ot,{size:"small",onClick:()=>b(k),color:"primary",children:e.jsx(oo,{})}),e.jsx(ot,{size:"small",onClick:()=>S(k.id),color:"error",children:e.jsx(ao,{})})]})]}),e.jsx(Le,{label:N(k.type),color:j(k.type),size:"small",sx:{mb:1}}),k.is_default&&e.jsx(Le,{label:"Default",color:"secondary",size:"small",sx:{ml:1}}),e.jsxs(f,{variant:"body2",color:"text.secondary",sx:{mt:1},children:[e.jsx("strong",{children:"Subject:"})," ",k.subject]}),e.jsxs(f,{variant:"body2",color:"text.secondary",sx:{mt:1},children:[e.jsx("strong",{children:"Created:"})," ",new Date(k.created_at).toLocaleDateString()]}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:"Updated:"})," ",new Date(k.updated_at).toLocaleDateString()]})]})})},k.id))}),r.length===0&&e.jsxs(q,{sx:{textAlign:"center",mt:4},children:[e.jsx(f,{variant:"h6",color:"text.secondary",children:"No email templates found"}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Create your first email template to get started"})]}),e.jsxs(lt,{open:o,onClose:I,maxWidth:"md",fullWidth:!0,children:[e.jsx(ct,{children:c?"Edit Email Template":"Create Email Template"}),e.jsx(ut,{children:e.jsxs(q,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsx(ie,{label:"Template Name",value:d.name,onChange:k=>p({...d,name:k.target.value}),fullWidth:!0,required:!0}),e.jsxs(Dt,{fullWidth:!0,children:[e.jsx(Tt,{children:"Template Type"}),e.jsxs(Ot,{value:d.type,onChange:k=>p({...d,type:k.target.value}),label:"Template Type",children:[e.jsx(ze,{value:"purchase_order",children:"Purchase Order"}),e.jsx(ze,{value:"sales_order",children:"Sales Order"}),e.jsx(ze,{value:"quote",children:"Quote"}),e.jsx(ze,{value:"custom",children:"Custom"})]})]}),e.jsx(ie,{label:"Subject",value:d.subject,onChange:k=>p({...d,subject:k.target.value}),fullWidth:!0,required:!0}),e.jsx(ie,{label:"HTML Content",value:d.html_content,onChange:k=>p({...d,html_content:k.target.value}),fullWidth:!0,multiline:!0,rows:8,required:!0,helperText:"Use HTML formatting for rich email content"}),e.jsx(ie,{label:"Text Content (Optional)",value:d.text_content,onChange:k=>p({...d,text_content:k.target.value}),fullWidth:!0,multiline:!0,rows:4,helperText:"Plain text version for email clients that don't support HTML"}),e.jsx(ra,{control:e.jsx(Ti,{checked:d.is_default,onChange:k=>p({...d,is_default:k.target.checked})}),label:"Set as default template for this type"})]})}),e.jsxs(dt,{children:[e.jsx(K,{onClick:I,children:"Cancel"}),e.jsx(K,{onClick:U,variant:"contained",children:c?"Update":"Create"})]})]}),e.jsx(zr,{open:!!y,autoHideDuration:6e3,onClose:()=>w(""),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Re,{onClose:()=>w(""),severity:"error",sx:{width:"100%"},children:y})}),e.jsx(zr,{open:!!O,autoHideDuration:6e3,onClose:()=>_(""),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Re,{onClose:()=>_(""),severity:"success",sx:{width:"100%"},children:O})})]})},Yb=({children:t})=>{const{isAuthenticated:r,user:s}=Qt(),n=cn().pathname;if(!r)return e.jsx(Fn,{to:"/login",replace:!0});if(s?.access_role==="Time Tracking"){if(n==="/"||n==="/dashboard")return e.jsx(Fn,{to:"/attendance",replace:!0});if(n!=="/time-tracking"&&n!=="/attendance"&&!n.startsWith("/open-sales-orders")&&!n.startsWith("/woker-sales-orders"))return e.jsx(Fn,{to:"/attendance",replace:!0})}return s?.access_role==="Sales and Purchase"&&!["/","/open-sales-orders","/open-purchase-orders","/parts-to-order","/inventory","/supply","/email-settings"].includes(n)&&!n.startsWith("/open-sales-orders/")&&!n.startsWith("/open-purchase-orders/")?e.jsx(Fn,{to:"/",replace:!0}):s?.access_role==="Quotes"&&n!=="/quotes"&&!n.startsWith("/quotes/")?e.jsx(Fn,{to:"/quotes",replace:!0}):e.jsx(e.Fragment,{children:t})},Vb=()=>e.jsxs(nh,{children:[e.jsx(nt,{path:"/login",element:e.jsx(Sf,{})}),e.jsx(nt,{path:"/register",element:e.jsx(Cf,{})}),e.jsxs(nt,{path:"/",element:e.jsx(Yb,{children:e.jsx(wf,{})}),children:[e.jsx(nt,{index:!0,element:e.jsx(Wl,{})}),e.jsx(nt,{path:"dashboard",element:e.jsx(Wl,{})}),e.jsx(nt,{path:"business-profile",element:e.jsx(Yf,{})}),e.jsx(nt,{path:"qbo-account-mapping",element:e.jsx(Mb,{})}),e.jsx(nt,{path:"customers",element:e.jsx(mg,{})}),e.jsx(nt,{path:"customers/:id",element:e.jsx(fg,{})}),e.jsx(nt,{path:"products",element:e.jsx(kb,{})}),e.jsx(nt,{path:"products/:id",element:e.jsx(Eg,{})}),e.jsx(nt,{path:"purchase-order",element:e.jsx(kc,{})}),e.jsx(nt,{path:"purchase-order/:id",element:e.jsx(Tc,{})}),e.jsx(nt,{path:"open-purchase-orders",element:e.jsx(kc,{})}),e.jsx(nt,{path:"open-purchase-orders/:id",element:e.jsx(Tc,{})}),e.jsx(nt,{path:"vendors",element:e.jsx(kg,{})}),e.jsx(nt,{path:"vendors/:id",element:e.jsx(Pg,{})}),e.jsx(nt,{path:"inventory",element:e.jsx(Hg,{})}),e.jsx(nt,{path:"supply",element:e.jsx(Yg,{})}),e.jsx(nt,{path:"employees",element:e.jsx(a_,{})}),e.jsx(nt,{path:"profile-documents",element:e.jsx(o_,{})}),e.jsx(nt,{path:"time-tracking",element:e.jsx(ob,{})}),e.jsx(nt,{path:"attendance",element:e.jsx(Db,{})}),e.jsx(nt,{path:"time-tracking/reports",element:e.jsx(vb,{})}),e.jsx(nt,{path:"leave-management",element:e.jsx(jb,{})}),e.jsx(nt,{path:"leave-history",element:e.jsx(wb,{})}),e.jsx(nt,{path:"vacation-days-management",element:e.jsx(Sb,{})}),e.jsx(nt,{path:"open-sales-orders",element:e.jsx(g_,{})}),e.jsx(nt,{path:"open-sales-orders/:id",element:e.jsx(y_,{})}),e.jsx(nt,{path:"woker-sales-orders",element:e.jsx(qc,{})}),e.jsx(nt,{path:"woker-sales-orders/:id",element:e.jsx(qc,{})}),e.jsx(nt,{path:"quotes",element:e.jsx(Gv,{})}),e.jsx(nt,{path:"quotes/new",element:e.jsx(_c,{})}),e.jsx(nt,{path:"quotes/:id",element:e.jsx(_c,{})}),e.jsx(nt,{path:"margin-schedule",element:e.jsx(i_,{})}),e.jsx(nt,{path:"overhead-management",element:e.jsx(Rb,{})}),e.jsx(nt,{path:"parts-to-order",element:e.jsx(Nb,{})}),e.jsx(nt,{path:"backup-management",element:e.jsx(Eb,{})}),e.jsx(nt,{path:"mobile-user-access",element:e.jsx(Lb,{})}),e.jsx(nt,{path:"email-settings",element:e.jsx(zb,{})}),e.jsx(nt,{path:"email-templates",element:e.jsx(Hb,{})})]}),e.jsx(nt,{path:"*",element:e.jsx(Fn,{to:"/",replace:!0})})]}),Gb=()=>{const[t,r]=l.useState(0);return l.useEffect(()=>{window.__triggerSync=async()=>{try{await Hs()>0&&!window.__backendUnavailableSince&&(await Ul(),r(await Hs()))}catch{}};let s=!0;const a=async()=>{try{const o=await Hs();if(s&&r(o),!window.__backendUnavailableSince&&o>0){await Ul();const i=await Hs();s&&r(i)}}catch{}},n=setInterval(a,15e3);return a(),()=>{s=!1,clearInterval(n)}},[]),e.jsxs(np,{theme:Vm,children:[e.jsx(sp,{}),e.jsx(Ym,{children:e.jsxs(Hr,{dateAdapter:Tn,children:[e.jsx(uh,{children:e.jsx(Vb,{})}),e.jsx(Hf,{position:"top-right",autoClose:3e3,newestOnTop:!1,closeOnClick:!0,pauseOnFocusLoss:!0,draggable:!0,pauseOnHover:!0,theme:"colored"})]})})]})};cp.createRoot(document.getElementById("root")).render(e.jsx(Gb,{}));
